!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.CommaJS=t():e.CommaJS=t()}(window,function(){return g=[function(c,u,h){var d,f,n,i;function o(e){if(i[e])return i[e].exports;var t=i[e]={i:e,l:!1,exports:{}};return n[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}window,c.exports=(i={},o.m=n=[function(e,a,l){"use strict";(function(n){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)});var o={polyfill:function(){var e=0<navigator.userAgent.indexOf("MSIE ")||!!navigator.userAgent.match(/Trident.*rv\:11\./)||0<navigator.userAgent.indexOf("Edge/");if(!("KeyboardEvent"in window)||"key"in KeyboardEvent.prototype&&!e)return!1;var t={get:function(){var e=o.keys[this.which||this.keyCode];return Array.isArray(e)&&(e=e[+this.shiftKey]),e},enumerable:!0,configurable:!0};return Object.defineProperty(KeyboardEvent.prototype,"key",t),t},keys:{3:"Cancel",6:"Help",8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",28:"Convert",29:"NonConvert",30:"Accept",31:"ModeChange",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",41:"Select",42:"Print",43:"Execute",44:"PrintScreen",45:"Insert",46:"Delete",48:["0",")"],49:["1","!"],50:["2","@"],51:["3","#"],52:["4","$"],53:["5","%"],54:["6","^"],55:["7","&"],56:["8","*"],57:["9","("],91:"OS",93:"ContextMenu",106:"*",107:"+",109:"-",110:".",111:"/",144:"NumLock",145:"ScrollLock",181:"VolumeMute",182:"VolumeDown",183:"VolumeUp",186:[";",":"],187:["=","+"],188:[",","<"],189:["-","_"],190:[".",">"],191:["/","?"],192:["`","~"],219:["[","{"],220:["\\","|"],221:["]","}"],222:["'",'"'],224:"Meta",225:"AltGraph",246:"Attn",247:"CrSel",248:"ExSel",249:"EraseEof",250:"Play",251:"ZoomOut"}};function t(){var e,t=this.parentNode,n=arguments.length;if(t)for(n||t.removeChild(this);n--;)"object"!==i(e=arguments[n])?e=this.ownerDocument.createTextNode(e):e.parentNode&&e.parentNode.removeChild(e),n?t.insertBefore(this.previousSibling,e):t.replaceChild(e,this)}!function(){for(var e=1;e<25;e++)o.keys[111+e]="F"+e;for(var t="",e=65;e<91;e++)t=String.fromCharCode(e),o.keys[e]=[t.toLowerCase(),t.toUpperCase()];for(e=96;e<106;e++)t=String.fromCharCode(e-48),o.keys[e]=t;l(2)?void 0===(f="function"==typeof(d=o)?d.call(u,h,u,c):d)||(c.exports=f):void 0!==n?n.exports=o:window&&(window.keyboardeventKeyPolyfill=o)}();var r=(e(s,[{key:"Init",value:function(){o.polyfill(),Element.prototype.replaceWith||(Element.prototype.replaceWith=t),CharacterData.prototype.replaceWith||(CharacterData.prototype.replaceWith=t),DocumentType.prototype.replaceWith||(DocumentType.prototype.replaceWith=t)}}]),s);function s(){!function(e){if(!(e instanceof s))throw new TypeError("Cannot call a class as a function")}(this)}a.a=r}).call(this,l(1)(e))},function(e,t){e.exports=function(e){var t;return e.webpackPolyfill||((t=Object.create(e)).children||(t.children=[]),Object.defineProperty(t,"loaded",{enumerable:!0,get:function(){return t.l}}),Object.defineProperty(t,"id",{enumerable:!0,get:function(){return t.i}}),Object.defineProperty(t,"exports",{enumerable:!0}),t.webpackPolyfill=1),t}},function(t,e){(function(e){t.exports=e}).call(this,{})},function(e,t,n){"use strict";n.r(t),n.d(t,"BlockNode",function(){return $}),n.d(t,"InlineNode",function(){return ne}),n.d(t,"TextNode",function(){return B}),n.d(t,"PluginActions",function(){return ce}),n.d(t,"Plugin",function(){return bt}),n.d(t,"NodeStyle",function(){return O}),n.d(t,"Base64",function(){return xt});var i=n(0);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var r=(o(s.prototype,[{key:"PushChar",value:function(e,t){this.wordCounter++,2<this.wordCounter&&this.Push(e,t)}},{key:"Push",value:function(e,t){this.wordCounter=0;var n={content:e,cursorPosition:t};this.history[this.index]=n,this.index++,this.history=this.history.slice(0,this.index)}},{key:"GetUndo",value:function(){this.wordCounter=0;var e=this.index-2,t={content:"",cursorPosition:0};return e<0?(e=0,this.index=1,t=this.history[e]):(t=this.history[e],this.index--),t}},{key:"GetRedo",value:function(){this.wordCounter=0;var e=this.index;e>this.history.length-1&&(e=this.history.length-1);var t=this.history[e];return this.index=e+1,t}}]),s);function s(){!function(e){if(!(e instanceof s))throw new TypeError("Cannot call a class as a function")}(this),this.history=[],this.index=0,this.wordCounter=0}function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var l,c,u=["Meta+1","Meta+2","Meta+3","Meta+4","Meta+5","Meta+6","Meta+7","Meta+8","Meta+9","Meta+0","Ctrl+q","Ctrl+w","Ctrl+e","Ctrl+r","Ctrl+t","Ctrl+y","Ctrl+o","Ctrl+p","Ctrl+s","Ctrl+d","Ctrl+f","Ctrl+g","Ctrl+h","Ctrl+j","Ctrl+k","Ctrl+l","Ctrl+n","Ctrl+m"],h=(c=[{key:"FormatKeyboardInput",value:function(e){var t=e.key,n="";return e.metaKey&&(""==n?n="Meta":n+="+Meta"),e.ctrlKey&&(""==n?n="Ctrl":n+="+Ctrl"),e.altKey&&(""==n?n="Alt":n+="+Alt"),n+="+"+t,u.indexOf(n)<0&&(n="_protected_"),n}}],a((l=d).prototype,[{key:"SetShortcuts",value:function(e){var n=this;this.shortcuts=e,null!=this.shortcuts&&this.shortcuts.forEach(function(e){var t={action:e.action,params:e.params};n.shortcutsByKey[e.shortcut.toLowerCase()]=t})}},{key:"Fire",value:function(e){var t,n=!1;return"_protected_"==e||null!=(t=this.shortcutsByKey[e.toLowerCase()])&&(n=!0,this._performAction(t.action,t.params)),n}},{key:"_performAction",value:function(e,t){"insertText"==e?this.editor.AppendTextAtCursor(t.text):"insertPlugin"==e?this.editor.InsertPluginAtSection(t.pluginName,t.pluginParams):"function"==e&&null!=t&&t()}}]),a(l,c),d);function d(e,t){!function(e){if(!(e instanceof d))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e,this.shortcutsByKey={},this.SetShortcuts(t)}function f(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function p(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var g={ENTER:"enter",ESC:"esc",BACKSPACE:"backspace",DELETE:"delete",TAB:"tab",CUT:"cut",COPY:"copy",PASTE:"paste",CUR_POS_CHANGED:"cursorPositionHasChanged",AFTER_CHAR_ADDED:"afterCharacterIsAdded",ARROW_UP:"arrowUp",ARROW_DOWN:"arrowDown",ARROW_LEFT:"arrowLeft",ARROW_RIGHT:"arrowRight",SHIFT_ARROW_UP:"shiftArrowUp",SHIFT_ARROW_DOWN:"shiftArrowDown",SHIFT_ARROW_LEFT:"shiftArrowLeft",SHIFT_ARROW_RIGHT:"shiftArrowRight",SHIFT_DOWN:"SHIFT_DOWN",SHIFT_UP:"SHIFT_UP",SELECT_ALL:"SELECT_ALL",BEFORE_COPY:"BEFORE_COPY",BEFORE_CUT:"BEFORE_CUT",BEFORE_PASTE:"BEFORE_PASTE",BOLD:"BOLD",ITALIC:"ITALIC",UNDERLINED:"UNDERLINED",SELECTION_CHANGED:"SELECTION_CHANGED"},m=(p(v.prototype,[{key:"OnClick",value:function(e){this.editor.FireStyleMonitoring(),this.editor.Fire(g.CUR_POS_CHANGED,e),this.editor.Fire(g.CLICK,e),e.preventDefault(),e.stopPropagation()}},{key:"KeyDown",value:function(e){var t=e.key;switch(t){case"Tab":this.editor.Fire(g.TAB,e)&&(e.preventDefault(),e.stopPropagation());break;case"Meta":break;case"Shift":this.editor.Fire(g.SHIFT_DOWN,e)&&(e.preventDefault(),e.stopPropagation());break;case"Alt":case"Control":break;case"Down":case"ArrowDown":(e.shiftKey?this.editor.Fire(g.SHIFT_ARROW_DOWN,e):this.editor.Fire(g.ARROW_DOWN,e))&&(e.preventDefault(),e.stopPropagation());break;case"Up":case"ArrowUp":(e.shiftKey?this.editor.Fire(g.SHIFT_ARROW_UP,e):this.editor.Fire(g.ARROW_UP,e))&&(e.preventDefault(),e.stopPropagation());break;case"Left":case"ArrowLeft":(e.shiftKey?this.editor.Fire(g.SHIFT_ARROW_LEFT,e):this.editor.Fire(g.ARROW_LEFT,e))&&(e.preventDefault(),e.stopPropagation());break;case"Right":case"ArrowRight":(e.shiftKey?this.editor.Fire(g.SHIFT_ARROW_RIGHT,e):this.editor.Fire(g.ARROW_RIGHT,e))&&(e.preventDefault(),e.stopPropagation());break;case"CapsLock":break;case"Enter":this.editor.Fire(g.ENTER,e)&&(e.preventDefault(),e.stopPropagation());break;case"Esc":case"Escape":this.editor.Fire(g.ESC,e)&&(e.preventDefault(),e.stopPropagation());break;case"Backspace":this.editor.Fire(g.BACKSPACE,e)&&(e.preventDefault(),e.stopPropagation());break;case"Delete":this.editor.Fire(g.DELETE,e)&&(e.preventDefault(),e.stopPropagation());break;default:e.metaKey&&!e.shiftKey&&"z"==t?(this.editor.Undo(),e.preventDefault(),e.stopPropagation()):e.shiftKey&&e.metaKey&&"z"==t?(this.editor.Redo(),e.preventDefault(),e.stopPropagation()):e.ctrlKey&&!e.shiftKey&&"z"==t?(this.editor.Undo(),e.preventDefault(),e.stopPropagation()):e.ctrlKey&&e.shiftKey&&"z"==t?(this.editor.Redo(),e.preventDefault(),e.stopPropagation()):(e.metaKey||e.ctrlKey)&&"a"==t?this.editor.Fire(g.SELECT_ALL,e)&&(e.preventDefault(),e.stopPropagation()):(e.metaKey||e.ctrlKey)&&"c"==t?this.stopClipboardEvent=this.editor.Fire(g.BEFORE_COPY,e):(e.metaKey||e.ctrlKey)&&"x"==t?this.stopClipboardEvent=this.editor.Fire(g.BEFORE_CUT,e):(e.metaKey||e.ctrlKey)&&"b"==t?(this.stopClipboardEvent=this.editor.Fire(g.BOLD,e),e.preventDefault(),e.stopPropagation()):(e.metaKey||e.ctrlKey)&&"i"==t?(this.stopClipboardEvent=this.editor.Fire(g.ITALIC,e),e.preventDefault(),e.stopPropagation()):(e.metaKey||e.ctrlKey)&&"u"==t?(this.stopClipboardEvent=this.editor.Fire(g.UNDERLINED,e),e.preventDefault(),e.stopPropagation()):(e.metaKey||e.ctrlKey||e.altKey)&&""!=t&&this.editor.ManageUserShortcuts(h.FormatKeyboardInput(e))&&(e.preventDefault(),e.stopPropagation()),e.metaKey||e.ctrlKey||e.altKey||""!=t&&this.editor.InsertCharacter(t)&&(e.preventDefault(),e.stopPropagation())}this.editor.Fire(g.AFTER_CHAR_ADDED,e)}},{key:"KeyUp",value:function(e){var t=e.key;switch(t){case"Meta":break;case"Shift":this.editor.Fire(g.SHIFT_UP,e)&&(e.preventDefault(),e.stopPropagation());break;case"Alt":case"Control":break;case"Down":case"ArrowDown":this.editor.FireStyleMonitoring(),this.editor.Fire(g.CUR_POS_CHANGED,e);break;case"Up":case"ArrowUp":this.editor.FireStyleMonitoring(),this.editor.Fire(g.CUR_POS_CHANGED,e);break;case"Left":case"ArrowLeft":this.editor.FireStyleMonitoring(),this.editor.Fire(g.CUR_POS_CHANGED,e);break;case"Right":case"ArrowRight":this.editor.FireStyleMonitoring(),this.editor.Fire(g.CUR_POS_CHANGED,e)}e.metaKey||e.ctrlKey||e.shiftKey||e.altKey||""!=t&&this.editor.DoneInsertCharacter(t)}},{key:"OnPaste",value:function(e){var t=e.clipboardData.getData("text/html"),n=Array.from(e.clipboardData.files||[]);if(!t&&0<n.length){if(null!=this.editor.onFilesPasted){var i,o=[],r=function(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e){if(e){if("string"==typeof e)return f(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?f(e,void 0):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,o=function(){};return{s:o,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,s=!0,a=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,r=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw r}}}}(n);try{for(r.s();!(i=r.n()).done;){var s=i.value;0==o.length&&o.push(s)}}catch(e){r.e(e)}finally{r.f()}this.editor.onFilesPasted(o)}else console.log("Files paste not supported: add onFilesPasted implementation");e.preventDefault(),e.stopPropagation()}else this.stopClipboardEvent=this.editor.Fire(g.BEFORE_PASTE,e),(this.stopClipboardEvent||this.editor.Fire(g.PASTE,e))&&(e.preventDefault(),e.stopPropagation()),this.stopClipboardEvent=!1}},{key:"OnCut",value:function(e){(this.stopClipboardEvent||this.editor.Fire(g.CUT,e))&&(e.preventDefault(),e.stopPropagation()),this.stopClipboardEvent=!1}},{key:"OnCopy",value:function(e){(this.stopClipboardEvent||this.editor.Fire(g.COPY,e))&&(e.preventDefault(),e.stopPropagation()),this.stopClipboardEvent=!1}}]),v);function v(e){!function(e){if(!(e instanceof v))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e,this.stopClipboardEvent=!1}function y(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var b=(y(x.prototype,[{key:"GetNew",value:function(){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=!1,n="";!t;){for(var i=0;i<5;i++)n+=e.charAt(Math.floor(Math.random()*e.length));null==this.allKeys[n]&&(t=this.allKeys[n]=!0)}return n}},{key:"Release",value:function(e){delete this.allKeys[e]}},{key:"VerifyAndRegister",value:function(e){return this.allKeys[e]&&(e=this.GetNew()),this.allKeys[e]=!0,e}},{key:"Reset",value:function(){this.allKeys={}}}]),x),C={exampleClass:{applyAs:"class",classes:["ex1","ex2"]},margin:{applyAs:"style",name:"margin",on:"set#by#user",off:"",isToggle:!1},width:{applyAs:"style",name:"width",on:"set#by#user",off:"",isToggle:!1},height:{applyAs:"style",name:"height",on:"set#by#user",off:"",isToggle:!1},border:{applyAs:"style",name:"border",on:"set#by#user",off:"",isToggle:!1},bold:{applyAs:"style",name:"fontWeight",on:"bold",off:"normal",isToggle:!0},italic:{applyAs:"style",name:"fontStyle",on:"italic",off:"normal",isToggle:!0},underlined:{applyAs:"style",name:"textDecorationLine",on:"underline",off:"none",preserve:!0,isToggle:!0},strike:{applyAs:"style",name:"textDecorationLine",on:"line-through",off:"none",preserve:!0,isToggle:!0},fontSize:{applyAs:"style",name:"fontSize",on:"set#by#user",off:"initial",isToggle:!1},fontFamily:{applyAs:"style",name:"fontFamily",on:"set#by#user",off:"initial",isToggle:!1},fontColor:{applyAs:"style",name:"color",on:"set#by#user",off:"initial",isToggle:!1,isColor:!0},backgroundColor:{applyAs:"style",name:"backgroundColor",on:"set#by#user",off:"initial",isToggle:!1,isColor:!0},align:{applyAs:"style",name:"textAlign",on:"set#by#user",off:"left",isToggle:!0},indent:{applyAs:"style",name:"paddingLeft",step:40,preserve:!1,calculated:!0,unit:"px",on:0,off:0,isToggle:!1},lineSpacing:{applyAs:"style",name:"lineHeight",on:"set#by#user",off:"normal",isToggle:!1},horizontalRule:{applyAs:"style",name:"borderBottom",on:"1px solid #8c8c8c",off:"none"},headerOne:{applyAs:"class",classes:["headerOne"]},headerTwo:{applyAs:"class",classes:["headerTwo"]},headerThree:{applyAs:"class",classes:["headerThree"]},superscript:{applyAs:"class",classes:["scplSup"],isToggle:!0},subscript:{applyAs:"class",classes:["scplSub"],isToggle:!0},splitSelection:{applyAs:"class",classes:["splitSelectionDummy"]},quote:{applyAs:"class",classes:["commaQuoteContainer"],isToggle:!0}};function x(e){!function(e){if(!(e instanceof x))throw new TypeError("Cannot call a class as a function")}(this),this.allKeys={},null!=e&&e.forEach(function(e){this.allKeys[e]=!0})}function w(t,e){var n,i=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)),i}function S(o){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?w(Object(r),!0).forEach(function(e){var t,n=o,i=r[t=e];t in n?Object.defineProperty(n,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[t]=i}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(r)):w(Object(r)).forEach(function(e){Object.defineProperty(o,e,Object.getOwnPropertyDescriptor(r,e))})}return o}function _(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function E(e,t,n){var i,o;return e.classList?n?e.classList.toggle(t,!0):e.classList.toggle(t):0<=(o=(i=e.className.split(" ")).indexOf(t))&&!n?i.splice(o,1):(i.push(t),e.className=i.join(" ")),e}var T,k,O=(k=[{key:"GetAllStyles",value:function(e){var t=C;return null!=e.allStyles&&(t=S(S({},C),e.allStyles)),t}},{key:"cssNameToJsName",value:function(e){for(var t=e.split("-"),n="",i=0;i<t.length;i++)0<i&&0<t[i].length&&(1!=i||"ms"!=t[i])&&(t[i]=t[i].substr(0,1).toUpperCase()+t[i].substr(1)),n+=t[i];return n}},{key:"jsNameToCssName",value:function(e){return e.replace(/([A-Z])/g,"-$1").toLowerCase()}},{key:"ParseDefaultFormat",value:function(e,n){var i=new A(e);return null!=n&&Object.keys(n).forEach(function(e){var t=n[e];t&&i.Toggle(e,t)}),i}},{key:"parseStyle",value:function(e){var t={};if(3!=e.nodeType&&8!=e.nodeType&&null!=e.getAttribute("cm-plugin"))for(var n=0,i=e.style.length;n<i;n++){var o=e.style[n].replace(/-([a-z])/g,function(e){return e[1].toUpperCase()}),r=e.style[o];t[o]=r}return t}},{key:"CalculateStylesForExternalHTML",value:function(e,t){var n=window.getComputedStyle(t),i=A.GetAllStyles(e),o=Object.keys(i),r={},s=new A(e);o.forEach(function(e){var t;"height"==e.toLowerCase()||"width"==e.toLowerCase()||"style"==(t=JSON.parse(JSON.stringify(i[e]))).applyAs&&(r[t.name]=e)});for(var a=n.length;a--;){var l,c,u=n[a],h=n.getPropertyValue(u),d=r[A.cssNameToJsName(u)];null==d||""==d||null!=(l=JSON.parse(JSON.stringify(i[d])))&&("set#by#user"==l.on?(l.on=h,s.styles[d]=l):l.preserve?h.indexOf(l.on)<0||(s.styles[d]=l):(l.calculated?(c=null!=(c=h.replace(l.unit,""))&&""!=c?parseInt(c):0,l.on=c):l.on==h||(l.on=h),s.styles[d]=l))}return s}},{key:"CalculateStyles",value:function(e,a){var l=A.parseStyle(a),c=new A(e),u=A.GetAllStyles(e);return Object.keys(u).forEach(function(e){var t,n,i,o,r,s=JSON.parse(JSON.stringify(u[e]));"style"==s.applyAs?null==a.style||null!=(t=a.style[s.name])&&""!=t&&(null!=l[s.name]&&delete l[s.name],"set#by#user"==s.on?(s.on=t,c.styles[e]=s):s.preserve?t.indexOf(s.on)<0||(c.styles[e]=s):s.calculated?(n=null!=(n=t.replace(s.unit,""))&&""!=n?parseInt(n):0,s.on=n,c.styles[e]=s):s.on==t&&(c.styles[e]=s)):"class"==s.applyAs&&(a.classList?(i=!0,s.classes.forEach(function(e){a.classList.contains(e)||(i=!1)}),i&&(c.styles[e]=s)):null!=a.className&&(o=a.className.split(" "),r=!0,s.classes.forEach(function(e){o.indexOf(e)<0&&(r=!1)}),r&&(c.styles[e]=s)))}),c.additionalStyles=l,c.additionalClasses={},c}}],_((T=A).prototype,[{key:"isEmpty",value:function(){var e=!1,t=Object.keys(this.styles).length,n=Object.keys(this.additionalStyles).length,i=Object.keys(this.additionalStyles).length;return 0==t&&0==n&&0==i&&(e=!0),e}},{key:"toStringForStyleTag",value:function(){var o="",r=this,e=Object.keys(this.styles),s={};return e.forEach(function(e){var t,n,i=r.styles[e];"style"==i.applyAs&&(i.preserve?(null==s[i.name]&&(s[i.name]=[]),s[i.name].push(i)):(t=i.name.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),n=i.on,o=o+t+": "+n.replace(/"/g,"'")+";"))}),Object.keys(s).forEach(function(e){var t=s[e],n="",i="";t.forEach(function(e){"style"==e.applyAs&&e.preserve&&(n=e.name.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),i=""==i?e.on:i+" "+e.on)}),o=o+n+": "+i.replace(/"/g,"'")+";"}),o}},{key:"toStringForClassTag",value:function(){var n="",i=this;return Object.keys(this.styles).forEach(function(e){var t=i.styles[e];"class"==t.applyAs&&t.classes.forEach(function(e){n=""==n?e:n+" "+e})}),n}},{key:"toJSON",value:function(){return{style:this.styles}}},{key:"Copy",value:function(){var e=new A(this.document);return e.styles=JSON.parse(JSON.stringify(this.styles)),e.additionalStyles=JSON.parse(JSON.stringify(this.additionalStyles)),e.additionalClasses=JSON.parse(JSON.stringify(this.additionalClasses)),e}},{key:"Equals",value:function(i){var o=!0,r=this,t=Object.keys(i.styles),e=Object.keys(r.styles);return t.length!=e.length?o=!1:(e.forEach(function(e){t.indexOf(e)<0&&(o=!1)}),o&&e.every(function(e){var t=r.styles[e],n=i.styles[e];return t.on!=n.on&&(o=!1,t.isColor&&n.isColor&&r.AreSameColors(t.on,n.on)&&(o=!0)),o})),o}},{key:"AreSameColors",value:function(e,t){return(e=this._parseColor(e))==this._parseColor(t)}},{key:"_parseColor",value:function(e){var t,n=e;return null!=e&&(-1<e.toLowerCase().indexOf("rgb")||-1<e.toLowerCase().indexOf("rgba"))&&(t=(e=e.toLowerCase()).split("(")[1].split(")")[0].split(","),n="#"+this._rgbToHex(t[0].split(" ").join(""))+this._rgbToHex(t[1].split(" ").join(""))+this._rgbToHex(t[2].split(" ").join(""))),n}},{key:"_rgbToHex",value:function(e){var t=Number(e).toString(16);return t.length<2&&(t="0"+t),t}},{key:"isAlreadyApplied",value:function(e){var t=A.GetAllStyles(this.document);if(null==t[e])return console.log("Unknown style: "+e),!1;var n=JSON.parse(JSON.stringify(t[e])),i=!1;return"style"==n.applyAs?null!=this.styles[e]&&(i="set#by#user"!=n.on):"class"==n.applyAs&&null!=this.styles[e]&&(i=!0),i}},{key:"Apply",value:function(o){var r=this;o.style="",Object.keys(r.styles).forEach(function(e){var t,n,i=r.styles[e];"style"==i.applyAs?"set#by#user"==i.on?o.style[i.name]=i.on:i.preserve?(t=o.style[i.name],n="",t.split(" ").forEach(function(e){e!=i.on&&"none"!=e&&(n+=" "+e)}),n+=" "+i.on,o.style[i.name]=n):i.calculated?o.style[i.name]=i.on.toString()+i.unit:o.style[i.name]=i.on:"class"==i.applyAs&&i.classes.forEach(function(e){o=E(o,e,!0)})}),Object.keys(r.additionalStyles).forEach(function(e){o.style[e]=r.additionalStyles[e]})}},{key:"Toggle",value:function(e,t,n){var i=2<arguments.length&&void 0!==n&&n,o=A.GetAllStyles(this.document);if(null==o[e])return console.log("Unknown style: "+e),!1;var r=JSON.parse(JSON.stringify(o[e])),s=!0;return this.isAlreadyApplied(e)&&!i?(s=!1,delete this.styles[e]):"style"==r.applyAs?("set#by#user"==r.on&&(r.on=t),this.styles[e]=r):"class"==r.applyAs&&(this.styles[e]=r),s}},{key:"CalculateStyle",value:function(e,t){return"style"==e.applyAs&&e.calculated&&("add"==t?e.on=e.on+e.step:"subtract"==t&&(e.on=e.on-e.step,e.on<e.off&&(e.on=e.off))),e}},{key:"ToggleOnDomElement",value:function(t,e,n,i){var o=3<arguments.length&&void 0!==i&&i,r=A.GetAllStyles(this.document);if(null==r[e])return console.log("Unknown style: "+e),!1;if(null==r[e])throw"Style '"+e+"' is not defined";var s,a,l,c,u,h=JSON.parse(JSON.stringify(r[e])),d=!0;return this.isAlreadyApplied(e)&&!o?(d=!1,"style"==h.applyAs?"set#by#user"==h.on?t.style[h.name]=h.off:h.calculated?(null==(s=this.styles[e])&&(s=JSON.parse(JSON.stringify(h))),s=this.CalculateStyle(s,n),t.style[h.name]=s.on.toString()+s.unit):(h.preserve?(a=t.style[h.name],l="",a.split(" ").forEach(function(e){e!=h.on&&(l+=" "+e)}),""==l&&(l+=" "+h.off),t.style[h.name]=l):t.style[h.name]=h.off,delete this.styles[e]):"class"==h.applyAs&&(delete this.styles[e],h.classes.forEach(function(e){t=E(t,e)}))):"style"==h.applyAs?("set#by#user"==h.on?((h=JSON.parse(JSON.stringify(h))).on=n,t.style[h.name]=n):h.preserve?(c=t.style[h.name],u="",c.split(" ").forEach(function(e){e!=h.on&&"none"!=e&&(u+=" "+e)}),u+=" "+h.on,t.style[h.name]=u):h.calculated?(h=this.CalculateStyle(h,n),t.style[h.name]=h.on.toString()+h.unit):t.style[h.name]=h.on,this.styles[e]=h):"class"==h.applyAs&&(h.classes.forEach(function(e){t=E(t,e)}),this.styles[e]=h),d}}]),_(T,k),A);function A(e,t){!function(e){if(!(e instanceof A))throw new TypeError("Cannot call a class as a function")}(this),this.document=e,null!=t&&(t=JSON.parse(JSON.stringify(t))),this.styles=t,null==this.styles&&(this.styles={}),this.additionalStyles={},this.additionalClasses={}}function P(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var N={BLOCK:"block",INLINE:"inline",TEXT:"text"},F=(P(M.prototype,[{key:"AddAttribute",value:function(e,t){var n={name:e,value:t};this.attributes.push(n),null!=this.domElement&&this.domElement.setAttribute(e,t)}},{key:"GetAttribute",value:function(t){var e,n=void 0;return this.attributes.forEach(function(e){e.name==t&&(n=e.value)}),null!=n||null!=(e=this.domElement.getAttribute(t))&&(n=e),n}},{key:"RemoveAttribute",value:function(t){var n=this,i=[];this.attributes.forEach(function(e){e.name==t?null!=n.domElement&&n.domElement.removeAttribute(t):i.push(e)}),this.attributes=i}},{key:"_isType",value:function(e){var t=!1;return this.type==e&&(t=!0),t}},{key:"isBlockNode",value:function(){return this._isType(N.BLOCK)}},{key:"isInlineNode",value:function(){return this._isType(N.INLINE)}},{key:"isTextNode",value:function(){return this._isType(N.TEXT)}},{key:"IsStyleApplied",value:function(e){return this.nodeStyle.isAlreadyApplied(e)}},{key:"ToggleStyle",value:function(e,t,n,i){var o=!(2<arguments.length&&void 0!==n)||n,r=3<arguments.length&&void 0!==i&&i;return null!=this.nodeStyle&&null!=this.nodeStyle.styles||(this.nodeStyle=new O(this.document)),o?this.nodeStyle.ToggleOnDomElement(this.domElement,e,t,r):this.nodeStyle.Toggle(e,t,r)}},{key:"GetBlockContainer",value:function(){return this.isBlockNode()?this:this.parent.GetBlockContainer()}},{key:"SetPluginType",value:function(e){this.pluginName=e,this.domElement.setAttribute("cm-plugin",e)}},{key:"RemovePluginType",value:function(){this.pluginName="",this.domElement.removeAttribute("cm-plugin")}},{key:"GetPluginType",value:function(){return this.pluginName}},{key:"Delete",value:function(e){e?this.document.DeleteNode(this):this.document.DeleteNode(this,!0)}},{key:"Contains",value:function(t){var n=!1;return null!=this.children&&this.children.forEach(function(e){n=n||e.id==t||e.Contains(t)}),n}}]),M);function M(e,t,n,i){var o=4<arguments.length&&void 0!==arguments[4]?arguments[4]:void 0;!function(e){if(!(e instanceof M))throw new TypeError("Cannot call a class as a function")}(this),null==o&&(o=new O(e)),this.document=e,this.id=t,this.tagName=n,this.type=i,this.nodeStyle=o,this.attributes=[],this.children=[],this.previous=void 0,this.next=void 0,this.parent=void 0,this.domElement=void 0}function R(e){return(R="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function D(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function I(e,t){return(I=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function L(e){return(L=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var B=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),I(e,t)}(l,F);var e,t,o,r,a=(o=l,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t,n=L(o),i=this;return!(t=r?(e=L(this).constructor,Reflect.construct(n,arguments,e)):n.apply(this,arguments))||"object"!==R(t)&&"function"!=typeof t?function(){if(void 0!==i)return i;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function l(e,t,n,i,o){var r,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:[];return function(e){if(!(e instanceof l))throw new TypeError("Cannot call a class as a function")}(this),(r=a.call(this,e,t,n,N.TEXT,i)).attributes=s,null==o&&(o=""),r.text=o,r.GenerateDomElement(),r}return t=[{key:"CreateNew",value:function(e,t,n,i,o){var r=new l(e,e.GenereateNewNodeId(),t,i,n,o);return e.RegisterNode(r),r}}],D((e=l).prototype,[{key:"Copy",value:function(){return new l(this.document,"",this.tagName,this.nodeStyle.Copy(),this.text,JSON.parse(JSON.stringify(this.attributes)))}},{key:"Append",value:function(){throw new Exception("Text nodes cannot contain any other node")}},{key:"GenerateDomElement",value:function(){this.domElement=void 0;var t=document.createElement(this.tagName);t.setAttribute("cm-id",this.id),t.setAttribute("cm-type",this.type),this.attributes.forEach(function(e){""!=e.name&&t.setAttribute(e.name,e.value)}),""==this.text?t.appendChild(document.createTextNode("\ufeff")):t.appendChild(document.createTextNode(this.text)),this.domElement=t,null!=this.nodeStyle&&this.nodeStyle.Apply(this.domElement)}},{key:"ApplyNodeStyle",value:function(e){null!=e&&(this.nodeStyle=e,this.nodeStyle.Apply(this.domElement))}},{key:"SetAttributes",value:function(e){var t=this;this.attributes=e,this.attributes.forEach(function(e){""!=e.name&&t.domElement.setAttribute(e.name,e.value)})}},{key:"AddAttribute",value:function(e,t){var n={name:e,value:t};this.attributes.push(n),this.domElement.setAttribute(n.name,n.value)}},{key:"RemoveAttribute",value:function(t){var n=[];this.attributes.forEach(function(e){e.name!=t&&n.push(e)}),this.attributes=n,this.domElement.removeAttribute(t)}},{key:"SetFocusAtTheEnd",value:function(){this.SetCarretAtTheEnd()}},{key:"SetCarretAtTheEnd",value:function(){this.SelectText(this.text.length,this.text.length)}},{key:"SelectText",value:function(e,t){var n,i;e==t?this.SetFocus(e):(n=window.getSelection(),(i=document.createRange()).setStart(this.domElement.firstChild,e),i.setEnd(this.domElement.firstChild,t),n.removeAllRanges(),n.addRange(i))}},{key:"SetFocus",value:function(e){null==e&&(e=0),""==this.text&&(e=1);var t=document.createRange(),n=window.getSelection();if(null!=this.domElement.firstChild){this.domElement.firstChild.length<e&&(e=this.domElement.firstChild.length),t.setStart(this.domElement.firstChild,e),t.collapse(!0),n.removeAllRanges();try{n.addRange(t)}catch(e){console.log(e)}}}},{key:"HasSameStyle",value:function(e){return this.nodeStyle.Equals(e.nodeStyle)}},{key:"HasSameAttributes",value:function(e){var t,n=!0,i=e.attributes;return this.attributes.length!=i.length?n=!1:(t={},i.forEach(function(e){t[e.name]=e.value}),this.attributes.forEach(function(e){null!=t[e.name]&&t[e.name]==e.value||(n=!1)})),n}},{key:"SetZeroWidthChar",value:function(){this.text="",this.domElement.removeChild(this.domElement.firstChild),this.domElement.appendChild(document.createTextNode("\ufeff"))}},{key:"TrimTextContent",value:function(e,t){this.ForceTextContent(this.text.substring(e,t))}},{key:"DeleteText",value:function(e,t){var n,i,o,r;"string"!=typeof this.text&&(this.text=JSON.stringify(this.text)),""==this.text||(0==e&&t==this.text.length?this.text="":e==t||(0<e?t<this.text.length?(n=this.text.substring(0,e),this.text.substring(e,t),i=this.text.substring(t,this.text.length),this.text=n+i):t==this.text.length&&(o=this.text.substring(0,e),this.text.substring(e,t),this.text=o):0==e&&t<this.text.length&&(this.text.substring(e,t),r=this.text.substring(t,this.text.length),this.text=r)))}},{key:"RemoveCharAt",value:function(e,t){var n=this.domElement.textContent.replace(/[\u200B-\u200D\uFEFF]/g,"");this.text=n.slice(0,e)+n.slice(e+1),null!=t&&t&&this.ForceTextContent(this.text)}},{key:"AppendTextContent",value:function(e){this.text=this.text+e,this.ForceTextContent(this.text)}},{key:"ForceTextContent",value:function(e){this.text=e,""==this.text?(this.domElement.removeChild(this.domElement.firstChild),this.domElement.appendChild(document.createTextNode("\ufeff"))):(this.domElement.removeChild(this.domElement.firstChild),this.domElement.appendChild(document.createTextNode(this.text)))}},{key:"ForceInsertString",value:function(e){var t,n;""==this.text?(this.text=e,this.domElement.textContent=this.text,this.SetFocus(e.length)):null!=e&&""!=e&&(t=document.getSelection().getRangeAt(0).startOffset,n=this.domElement.textContent.replace(/[\u200B-\u200D\uFEFF]/g,""),this.text=[n.slice(0,t),e,n.slice(t)].join(""),"\n"==e&&""==n.slice(t)&&(this.text=this.text+" "),this.domElement.textContent=this.text,this.SetFocus(t+e.length))}},{key:"InsertCharacter",value:function(e){var t,n,i,o,r,s,a=!1;return""==this.text?(" "==e&&(e="Â "),t=document.createTextNode(e),this.domElement.removeChild(this.domElement.firstChild),this.domElement.appendChild(t),(i=(n=document.getSelection()).getRangeAt(0)).selectNodeContents(this.domElement.firstChild),i.collapse(),n.removeAllRanges(),n.addRange(i),a=!0,this.text=this.domElement.textContent.replace(/[\u200B-\u200D\uFEFF]/g,"")):(null==e&&(e=""),o=document.getSelection().getRangeAt(0),r=this.domElement.textContent.replace(/[\u200B-\u200D\uFEFF]/g,""),s=o.startOffset,this.text=[r.slice(0,s),e,r.slice(s)].join(""),a=!1),a}},{key:"Split",value:function(e,t){var n,i,o,r,s,a,l,c,u,h,d,f,p,g,m,v,y,b,C,x,w,S,_,E=[];return""==this.text||0==e&&t==this.text.length?E.push(this):e==t?0==e?((n=this.Copy()).text="",E.push(n),i=this.Copy(),E.push(i)):e==this.text.length?(o=this.Copy(),E.push(o),(r=this.Copy()).text="",E.push(r)):(s=this.text.substring(0,e),a=this.text.substring(e,this.text.length),(l=this.Copy()).text=s,E.push(l),(c=this.Copy()).text="",E.push(c),(u=this.Copy()).text=a,E.push(u)):0<e?t<this.text.length?(h=this.text.substring(0,e),d=this.text.substring(e,t),f=this.text.substring(t,this.text.length),(p=this.Copy()).text=h,E.push(p),(g=this.Copy()).text=d,E.push(g),(m=this.Copy()).text=f,E.push(m)):t==this.text.length&&(v=this.text.substring(0,e),y=this.text.substring(e,t),(b=this.Copy()).text=v,E.push(b),(C=this.Copy()).text=y,E.push(C)):0==e&&t<this.text.length&&(x=this.text.substring(e,t),w=this.text.substring(t,this.text.length),(S=this.Copy()).text=x,E.push(S),(_=this.Copy()).text=w,E.push(_)),E}},{key:"Merge",value:function(t,e){if(!t.isTextNode())throw console.log("87-16"),"Fatal error: 87-16";var n,i,o,r=this;null==e?r.text=r.text+t.text:(n=r.text,i=t.text,r.text=[n.slice(0,e),i,n.slice(e)].join("")),r.ForceTextContent(r.text),r.next=t.next,t.domElement.remove(),this.document.UnregisterNode(t),null!=t.parent&&(o=[],t.parent.children.forEach(function(e){e.id!=t.id&&o.push(e)}),t.parent.children=o)}},{key:"ChangeTagName",value:function(e){this.tagName=e;for(var t=this.domElement,n=document.createElement(e),i=0,o=t.attributes.length;i<o;++i){var r=t.attributes.item(i).nodeName,s=t.attributes.item(i).nodeValue;n.setAttribute(r,s)}for(;t.hasChildNodes();)n.appendChild(t.removeChild(t.firstChild));t.parentNode.replaceChild(n,t),this.domElement=n}}]),D(e,t),l}();function j(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var G,H,z=(H=[{key:"PrintToConsole",value:function(e,t){var n=new Y(e);t?n._debugPrintNode(n.document.rootNode):console.log(n.document.rootNode)}},{key:"DeleteNodesBetween",value:function(e,t,n){return new Y(e)._DeleteNodesBetween(t,n)}},{key:"GetAllTextNodes",value:function(e,t,n,i){return new Y(e)._getAllTextNodes(t,n,i)}},{key:"InsertNodeAtCursor",value:function(e,t){e.selectionManager.IsCollapsed()||e.DeleteSelection();var n,i,o=e.selectionManager.GetCurrent(),r=o.startNode,s=o.startOffset,a=o.endOffset;r.isTextNode()&&(n=[],2==(i=r.Split(s,a)).length?0==s?(t.isInlineNode()&&n.push(B.CreateNew(e,"span","",r.nodeStyle.Copy())),n.push(t),n.push(i[1])):(n.push(i[0]),n.push(t)):3==i.length?(n.push(i[0]),n.push(t),n.push(i[2])):1==i.length&&(t.isInlineNode()&&n.push(B.CreateNew(e,"span","",r.nodeStyle.Copy())),n.push(t)),Y.ReplaceNode(e,r,n,!1,!0,r.nodeStyle.Copy()),t.next.SetFocus())}},{key:"ReplaceNode",value:function(n,i,o,r,e,s){var a=n;null==r&&(r=!1);var l,c,u,h,t,d,f,p=i.parent,g=!0;(null==p||1==o.length&&o[0].id==i.id)&&(g=!1),g&&(c=void 0,h=u=!(l=[]),p.children.forEach(function(e){var t;e.id==i.id?(o.forEach(function(e){var t;e.id=a.GenereateNewNodeId(),e.GenerateDomElement(),null!=c&&(c.next=e,c.isInlineNode()&&e.isInlineNode()&&((t=B.CreateNew(n,"span","",s.Copy())).previous=c,t.parent=c.parent,c.next=t,c.domElement.parentNode.insertBefore(t.domElement,c.domElement.nextSibling),l.push(t),c=t)),e.previous=c,e.next=void 0,e.parent=p,e.document=p.document,c=e,l.push(e),a.RegisterNode(e)}),u=!0,r&&(h=!0)):h||(u&&(null!=c&&(c.isInlineNode()&&e.isInlineNode()?(null==s&&(s=n.GetDefaultNodeStyle()),(t=B.CreateNew(n,"span","",s.Copy())).previous=c,t.parent=c.parent,c.next=t,c=t,e.domElement.parentNode.insertBefore(t.domElement,e.domElement),l.push(t)):c.next=e),e.previous=c,u=!1),null!=(c=e).next&&e.next.id==i.id&&(e.next=void 0),l.push(e))}),p.children=l,t=!0,d=void 0,o.forEach(function(e){t?(t=!1,i.domElement.replaceWith(e.domElement)):d.domElement.parentNode.insertBefore(e.domElement,d.domElement.nextSibling),d=e}),t&&i.domElement.remove(),a.UnregisterNode(i),e?(f=B.CreateNew(n,"span","",s.Copy()),p.Append(f)):p.isBlockNode()&&0==p.children?Y.ReplaceNode(n,p,[],r):i.isBlockNode())}}],j((G=Y).prototype,[{key:"_debugPrintNode",value:function(e,t){var n=this;null==t&&(t=""),e.isTextNode()?console.log(t+e.id+" "+e.tagName+" %c"+e.type+" %c=> [%c"+e.text+"%c]","color:#ad0c9d","color:black","color:#129957","color:black"):console.log(t+e.id+" "+e.tagName+" %c"+e.type,"color:#ad0c9d"),e.children.forEach(function(e){n._debugPrintNode(e,t+"   ")})}},{key:"_recursive_getAllTextNodes",value:function(e){var t;this.adding?this.toNode.id==e.id?(this.adding=!1,this.includeFromAndToInResults&&e.isTextNode()&&this.opResults.push(e),this.completed=!0):e.isTextNode()&&this.opResults.push(e):this.fromNode.id==e.id&&(this.adding=!0,this.includeFromAndToInResults&&e.isTextNode()&&this.opResults.push(e)),this.completed||(t=this,e.children.every(function(e){return t._recursive_getAllTextNodes(e),!t.completed}))}},{key:"_getAllTextNodes",value:function(e,t,n){this.fromNode=e,this.toNode=t,this.includeFromAndToInResults=n,this.adding=!1,this.completed=!1,this.opResults=[];var i=this;return this.document.rootNode.children.every(function(e){return i._recursive_getAllTextNodes(e),!i.completed}),this.opResults}},{key:"_deleteNode_DNB",value:function(e){var n=[],i=this;return e.children.forEach(function(e){var t=!0;e.id==i.fromNode.id?i.deleting=!0:e.id==i.toNode.id?(i.deleting=!1,i.doneDeleting=!0):i.deleting?t=!i._deleteNode_DNB(e):i.doneDeleting||i._deleteNode_DNB(e),t&&n.push(e)}),i.deleting&&0==n.length?(e.domElement.remove(),i.document.UnregisterNode(e),null!=e.previous&&(e.previous.next=e.next),null!=e.next&&(e.next.previous=e.previous),!0):(e.children=n,!1)}},{key:"_DeleteNodesBetween",value:function(e,t){this.fromNode=e,this.toNode=t,this.deleting=!1,this.doneDeleting=!1,this._deleteNode_DNB(this.document.rootNode)}}]),j(G,H),Y);function Y(e){!function(e){if(!(e instanceof Y))throw new TypeError("Cannot call a class as a function")}(this),this.document=e}function U(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var W=(U(X.prototype,[{key:"GetRange",value:function(e){null==e&&(e=document.getSelection());var t=void 0;return e.rangeCount?t=e.getRangeAt(0):(t=document.createRange()).collapse(!0),t}},{key:"GetStartNode",value:function(e){var t;null==e&&(t=document.getSelection(),e=this.GetRange(t));var n=e.startContainer.parentNode;if("BODY"==n.tagName)return this.document.rootNode.GetFirstTextNode();if(null!=n){var i=n.getAttribute("cm-id");return this.document.GetNodeById(i)}}},{key:"GetEndNode",value:function(e){var t;null==e&&(t=document.getSelection(),e=this.GetRange(t));var n=e.startContainer.parentNode.getAttribute("cm-id");return this.document.GetNodeById(n)}},{key:"IsCollapsed",value:function(){return document.getSelection().isCollapsed}},{key:"GetBoundingClientRect",value:function(){var e=document.getSelection(),t=this.GetRange(e),n=t.getBoundingClientRect(),i=navigator.userAgent.toLowerCase();return-1!=i.indexOf("safari")&&(-1<i.indexOf("chrome")||(n=t.getClientRects()[0])),n}},{key:"GetCurrent",value:function(){var e,t,n,i=document.getSelection(),o=this.GetRange(i),r=o.startContainer.parentNode,s=o.startOffset,a=o.endContainer.parentNode,l=o.endOffset,c={hasFocus:!1,startNode:void 0,startOffset:0,endNode:void 0,endOffset:0};return null!=r&&null!=a&&(e=r.getAttribute("cm-id"),t=a.getAttribute("cm-id"),n=this.document.GetNodeById(e),c={hasFocus:null!=r&&null!=n,startNode:n,startOffset:s,endNode:this.document.GetNodeById(t),endOffset:l}),c}},{key:"SelectText",value:function(e,t,n,i){var o=window.getSelection(),r=document.createRange();r.setStart(e.domElement.firstChild,t),r.setEnd(n.domElement.firstChild,i),o.removeAllRanges(),o.addRange(r)}},{key:"_parents",value:function(e){for(var t=[e];e;e=e.parent)t.unshift(e);return t}},{key:"FindCommonNodeContainer",value:function(e,t){var n=this._parents(e),i=this._parents(t);if(n[0].id!=i[0].id)throw"No common ancestor";for(var o=0;o<n.length;o++)if(n[o].id!=i[o].id)return n[o-1]}},{key:"GetSelectedLines",value:function(){var t,n,e,i,o=this.GetCurrent(),r=[];return o.hasFocus&&(t=o.startNode,n=o.endNode,null!=t&&null==n?n=t:null==t&&null!=n&&(t=n),this.IsCollapsed()||t.parent.id==n.parent.id?r.push(t.GetBlockContainer()):t.isTextNode()&&n.isTextNode()&&(e=this.FindCommonNodeContainer(t,n),i=!1,e.children.forEach(function(e){e.Contains(t.id)?(i=!0,r.push(e)):i&&(r.push(e),e.Contains(n.id)&&(i=!1))}))),r}},{key:"GetSelectedTextNodes",value:function(){var e,t,n,i=[];return document.getSelection().isCollapsed||(t=(e=this.GetCurrent()).startNode,e.startOffset,n=e.endNode,e.endOffset,(i=z.GetAllTextNodes(this.document,t,n,!1)).unshift(t),n.id!=t.id&&i.push(n)),i}},{key:"_extractSelection",value:function(e,t,n){var i=e.Split(t,n);return 1==i.length?e:(z.ReplaceNode(this.document,e,i),2==i.length&&0==t?i[0]:i[1])}},{key:"IsolateAndReturnSelectedTextNodes",value:function(){var t=[];if(!document.getSelection().isCollapsed){var e,n,i,o,r=this.GetCurrent(),s=r.startNode,a=r.startOffset,l=r.endNode,c=r.endOffset;if(!s.isTextNode()||!l.isTextNode())return void console.log("#84-22");s.id==l.id?(e=this._extractSelection(s,a,c),t.push(e)):(n=z.GetAllTextNodes(this.document,s,l,!1),i=this._extractSelection(s,a,s.text.length),t.push(i),n.forEach(function(e){t.push(e)}),o=this._extractSelection(l,0,c),t.push(o))}return t}},{key:"_getNextTextNode",value:function(e){return null==e.next?this._getNextTextNode(e.parent):e.next.isTextNode()?e.next:this._getNextTextNode(e.next.parent)}},{key:"VerifyCursorPosition",value:function(){}}]),X);function X(e){!function(e){if(!(e instanceof X))throw new TypeError("Cannot call a class as a function")}(this),this.document=e}function V(e){return(V="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function q(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function K(e,t){return(K=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function J(e){return(J=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var $=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),K(e,t)}(c,F);var e,t,o,r,l=(o=c,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t,n=J(o),i=this;return!(t=r?(e=J(this).constructor,Reflect.construct(n,arguments,e)):n.apply(this,arguments))||"object"!==V(t)&&"function"!=typeof t?function(){if(void 0!==i)return i;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function c(e,t,n,i){var o,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:[],s=5<arguments.length&&void 0!==arguments[5]&&arguments[5],a=6<arguments.length&&void 0!==arguments[6]?arguments[6]:void 0;return function(e){if(!(e instanceof c))throw new TypeError("Cannot call a class as a function")}(this),(o=l.call(this,e,t,n,N.BLOCK,i)).attributes=r,o.hasTextContent=s,o.textContent=a,o.GenerateDomElement(),o.firstTextNode=void 0,o.lastTextNode=void 0,o}return t=[{key:"CreateNew",value:function(e,t,n,i,o,r){var s=4<arguments.length&&void 0!==o&&o,a=5<arguments.length&&void 0!==r?r:"",l=new c(e,e.GenereateNewNodeId(),t,n,i,s,a);return e.RegisterNode(l),l}}],q((e=c).prototype,[{key:"Copy",value:function(){var t=new c(this.document,this.document.GenereateNewNodeId(),this.tagName,this.nodeStyle.Copy(),this.attributes,this.hasTextContent,this.textContent);return t.firstTextNode=this.firstTextNode,t.lastTextNode=this.lastTextNode,t.GenerateDomElement(),this.children.forEach(function(e){t.Append(e.Copy())}),t}},{key:"UpdateTextContent",value:function(e){this.hasTextContent=!0,this.textContent=e,this.domElement.setAttribute("cm-has-text-content",!0),this.domElement.textContent=this.textContent}},{key:"GenerateDomElement",value:function(){this.domElement=void 0;var t=document.createElement(this.tagName);t.setAttribute("cm-id",this.id),t.setAttribute("cm-type",this.type),this.attributes.forEach(function(e){""!=e.name&&t.setAttribute(e.name,e.value)}),this.domElement=t,this.hasTextContent&&(t.setAttribute("cm-has-text-content",!0),this.domElement.textContent=this.textContent),null!=this.nodeStyle&&this.nodeStyle.Apply(this.domElement)}},{key:"ChangeTagName",value:function(e){this.tagName=e;var t=document.createElement(this.tagName);t.setAttribute("cm-id",this.id),t.setAttribute("cm-type",this.type),this.attributes.forEach(function(e){""!=e.name&&t.setAttribute(e.name,e.value)}),this.children.forEach(function(e){t.appendChild(e.domElement)}),this.hasTextContent&&(t.setAttribute("cm-has-text-content",!0),this.domElement.textContent=this.textContent),null!=this.nodeStyle&&this.nodeStyle.Apply(t),this.domElement.parentNode.replaceChild(t,this.domElement),this.domElement=t}},{key:"SetAttributes",value:function(e,t){var n,i=1<arguments.length&&void 0!==t&&t;this.attributes=e,i||(n=this).attributes.forEach(function(e){""!=e.name&&n.domElement.setAttribute(e.name,e.value)})}},{key:"AppendAfter",value:function(t,e){var n=0,i=0;return this.children.forEach(function(e){i++,e.id==t.id&&(n=i)}),this.Append(e,n)}},{key:"Append",value:function(i,o){var e,t,n,r,s,a,l,c,u,h,d,f,p;i.parent=this,null!=o&&o>=this.children.length&&(o=void 0),null==o?i.isInlineNode()?(t=void 0,null!=this.document.GetStyleAtCurrentCursorPosition()&&(t=(e=new O(this.document,this.document.GetStyleAtCurrentCursorPosition().nodeStyle)).isEmpty()?this.document.GetDefaultNodeStyle().Copy():e.Copy()),n=void 0,0<this.children.length&&(n=this.children[this.children.length-1]),null!=n&&n.isTextNode()||((r=B.CreateNew(this.document,"span","",t)).parent=this,r.next=i,null!=n&&(n.next=r),r.previous=n,n=r,this.children.push(r),this.domElement.appendChild(r.domElement)),(n.next=i).previous=n,(i.parent=this).children.push(i),this.domElement.appendChild(i.domElement),(s=B.CreateNew(this.document,"span","",t)).parent=this,(s.previous=i).next=s,this.children.push(s),this.domElement.appendChild(s.domElement)):(0<(i.parent=this).children.length&&(((a=this.children[this.children.length-1]).next=i).previous=a),this.children.push(i),this.domElement.appendChild(i.domElement)):(l=void 0,c=[],h=void(u=0),null!=this.document.GetStyleAtCurrentCursorPosition()&&(h=new O(this.document,this.document.GetStyleAtCurrentCursorPosition().nodeStyle)),f=[],p=void 0,(d=this).children.forEach(function(e){var t,n;o==u&&(p=l,!i.isInlineNode()||null!=l&&l.isTextNode()||((t=B.CreateNew(d.document,"span","",h.Copy())).parent=d,null!=l&&(l.next=t),t.previous=l,l=t,c.push(t),f.push(t)),null!=(i.previous=l)&&(l.next=i),c.push(i),l=i,f.push(i),i.isInlineNode()&&!e.isTextNode()&&((n=B.CreateNew(d.document,"span","",h.Copy())).parent=d,(l.next=n).previous=l,(n.next=e).previous=n,c.push(n),l=n,f.push(n))),null!=(e.previous=l)&&(l.next=e),c.push(e),l=e,u++}),this.children=c,null!=p?f.forEach(function(e){p.domElement.parentNode.insertBefore(e.domElement,p.domElement.nextSibling),p=e}):null==i.next?this.domElement.appendChild(i.domElement):this.domElement.insertBefore(i.domElement,i.next.domElement))}},{key:"InsertTextNodeAtCursor",value:function(e){if(e.isTextNode()){var t=new W(this.document).GetCurrent();if(!t.hasFocus)return;var n=t.startNode,i=t.startOffset,o=t.endNode,r=t.endOffset;if(!n.isTextNode()||!o.isTextNode())return void console.log("#10-22");var s,a,l,c=n.GetBlockContainer(),u=o.GetBlockContainer();c.id!=u.id&&console.log("#10-33"),n.id==o.id&&(1==(a=(s=n).Split(i,r)).length?this.Append(e,0):(2==a.length?0==i?a.unshift(e):a.push(e):((l=[]).push(a[0]),l.push(e),l.push(a[2]),a=l),z.ReplaceNode(this.document,s,a)))}}},{key:"_parseIsEmpty",value:function(e){var t=this,n=!0;return e.children.forEach(function(e){n&&(e.isTextNode()?""==e.text||(n=!1):n=!e.isInlineNode()&&t._parseIsEmpty(e))}),n}},{key:"isEmpty",value:function(){return this._parseIsEmpty(this)}},{key:"_parseGetFirstTextNode",value:function(e){var t=this;return e.children.every(function(e){return e.isTextNode()&&null==t.firstTextNode?(t.firstTextNode=e,!1):t._parseGetFirstTextNode(e)}),!0}},{key:"SelectWholeTextContent",value:function(){var e=this.GetFirstTextNode(),t=this.GetLastTextNode();this.document.selectionManager.SelectText(e,0,t,t.text.length)}},{key:"GetFirstTextNode",value:function(){return this.firstTextNode=void 0,this._parseGetFirstTextNode(this),this.firstTextNode}},{key:"_parseGetLastTextNode",value:function(e){var t=this;return e.children.every(function(e){return e.isTextNode()?void(t.lastTextNode=e):t._parseGetLastTextNode(e)}),!0}},{key:"GetLastTextNode",value:function(){return this.lastTextNode=void 0,this._parseGetLastTextNode(this),this.lastTextNode}},{key:"_parseDeleteButReturnTextNodes",value:function(e){var t=this;e.children.every(function(e){return e.isTextNode()?(t.tmpAllTextNodes.push(e),!1):t._parseDeleteButReturnTextNodes(e)}),e.Delete()}},{key:"DeleteButReturnTextNodes",value:function(){return this.tmpAllTextNodes=[],this._parseDeleteButReturnTextNodes(this),this.tmpAllTextNodes}},{key:"Delete",value:function(){this.document.DeleteNode(this)}},{key:"InsertEmptyBlockNodeBefore",value:function(e){return this._InsertEmptyLine("before",e)}},{key:"InsertEmptyBlockNodeAfter",value:function(e){return this._InsertEmptyLine("after",e)}},{key:"_InsertEmptyLine",value:function(t,e){var n=this;null==e&&(e="div");var i=this.parent,o=c.CreateNew(this.document,e),r=i.children;return i.children=[],r.forEach(function(e){"before"==t?(e.id==n.id&&i.Append(o),i.Append(e)):"after"==t&&(i.Append(e),e.id==n.id&&i.Append(o))}),o}},{key:"Merge",value:function(t,e){var n,i=this,o=void 0,r=void 0;null==i.children||0<=(n=i.children.length-1)&&(r=i.children[n]),t.children.forEach(function(e){"text"==e.type?(i.Append(e),null==o&&(o=e)):e.DeleteButReturnTextNodes().forEach(function(e){i.Append(e)})}),t.domElement.remove(),this.document.UnregisterNode(t),i.next=t.next,null!=i.next&&(i.next.previous=i);var s=[];return i.parent.children.forEach(function(e){e.id!=t.id&&s.push(e)}),i.parent.children=s,e?o:r}}]),q(e,t),c}();function Z(e){return(Z="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Q(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function ee(e,t){return(ee=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function te(e){return(te=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var ne=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),ee(e,t)}(l,F);var e,t,o,r,a=(o=l,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t,n=te(o),i=this;return!(t=r?(e=te(this).constructor,Reflect.construct(n,arguments,e)):n.apply(this,arguments))||"object"!==Z(t)&&"function"!=typeof t?function(){if(void 0!==i)return i;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function l(e,t,n,i,o){var r,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:[];return function(e){if(!(e instanceof l))throw new TypeError("Cannot call a class as a function")}(this),(r=a.call(this,e,t,n,N.INLINE,o)).attributes=s,null==i&&(i=""),r.text=i,r.GenerateDomElement(),r}return t=[{key:"CreateNew",value:function(e,t,n,i,o){var r=new l(e,e.GenereateNewNodeId(),t,n,i,o);return e.RegisterNode(r),r}}],Q((e=l).prototype,[{key:"Copy",value:function(){var t=new l(this.document,this.document.GenereateNewNodeId(),this.tagName,this.text,this.nodeStyle.Copy(),this.attributes);return this.GenerateDomElement(),this.children.forEach(function(e){t.Append(e.Copy())}),t}},{key:"GenerateDomElement",value:function(){this.domElement=void 0;var t=document.createElement(this.tagName);t.setAttribute("cm-id",this.id),t.setAttribute("cm-type",this.type),this.attributes.forEach(function(e){""!=e.name&&t.setAttribute(e.name,e.value)}),""!=this.text&&t.appendChild(document.createTextNode(this.text)),this.domElement=t,null!=this.nodeStyle&&this.nodeStyle.Apply(this.domElement)}},{key:"Append",value:function(i,o){if(i.isBlockNode())throw"Inline nodes cannot contain block nodes";var e,t,n,r,s,a,l,c;null==o&&(o=this.children.length),0==this.children.length||this.children.length==o?i.isInlineNode()?(e=void 0,0<this.children.length&&(e=this.children[this.children.length-1]),null!=e&&e.isTextNode()||((t=TextNode.CreateNew(this.document,"span","",this.nodeStyle.Copy())).parent=this,t.next=i,null!=e&&(e.next=t),t.previous=e,e=t,this.children.push(t),this.domElement.appendChild(t.domElement)),i.previous=e,(i.parent=this).children.push(i),this.domElement.appendChild(i.domElement),(n=TextNode.CreateNew(this.document,"span","",this.nodeStyle.Copy())).parent=this,(n.previous=i).next=n,this.children.push(n),this.domElement.appendChild(n.domElement)):((i.parent=this).children.push(i),this.domElement.appendChild(i.domElement)):(r=void 0,a=0,l=!(s=[]),this.children.forEach(function(e){var t,n;r=o==a?(!i.isInlineNode()||null!=r&&r.isTextNode()||((t=TextNode.CreateNew(this.document,"span","",this.nodeStyle.Copy())).parent=this,null!=r&&(r.next=t),t.previous=r,r=t,s.push(t)),null!=(i.previous=r)&&(r.next=i),l=!0,i.parent=this,s.push(i),i):(l&&(l=!1,i.isInlineNode()&&!e.isTextNode()?((n=TextNode.CreateNew(this.document,"span","",this.nodeStyle.Copy())).parent=this,(r.next=n).previous=r,(n.next=e).previous=n,s.push(n)):(e.previous=i).next=e),e),s.push(e),a++}),l&&i.isInlineNode()&&((c=TextNode.CreateNew(this.document,"span","",this.nodeStyle.Copy())).parent=this,(r.next=c).previous=r,c.next=void 0,s.push(c)),this.children=s,null==i.next?this.domElement.appendChild(i.domElement):this.domElement.insertBefore(i.domElement,i.next.domElement))}},{key:"Delete",value:function(){this.domElement.remove(),this.document.UnregisterNode(this)}}]),Q(e,t),l}();function ie(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function oe(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var re=(oe(se.prototype,[{key:"GetStyleAtCurrentCursorPosition",value:function(){var e=this.selectionManager.GetCurrent();if(!e.hasFocus)return{};var t=e.startNode;return null!=t?this.GetStyleFromNode(t):{}}},{key:"GetStyleFromNode",value:function(e){var t=this._getFirstParentBlockNode(e);return{nodeStyle:e.nodeStyle.styles,lineStyle:t.nodeStyle.styles,plugin:void 0}}},{key:"ToggleStyleOnLine",value:function(t,n){var e,i,o,r,s,a,l,c,u=this.selectionManager.GetCurrent();u.hasFocus&&(e=u.startNode,i=u.startOffset,o=u.endNode,r=u.endOffset,e.isTextNode()&&o.isTextNode()?e.id==o.id?(this._getFirstParentBlockNode(e).ToggleStyle(t,n,!0),e.SelectText(i,r)):(s=this._getFirstParentBlockNode(e),a=this._getFirstParentBlockNode(o),s.id==a.id?(s.ToggleStyle(t,n,!0),this.selectionManager.SelectText(e,i,o,r)):(l=s.parent).id==a.parent.id?(c=!1,l.children.forEach(function(e){e.id==s.id&&(c=!0),c&&(e.ToggleStyle(t,n,!0),e.id==a.id&&(c=!1))})):console.log("#10-03")):console.log("#10-02"))}},{key:"_getFirstParentBlockNode",value:function(e){var t=e.parent;return t.isBlockNode()||(t=this._getFirstParentBlockNode(t)),t}},{key:"ToggleStyleOnSelection",value:function(t,n){var e,i=this.selectionManager.GetCurrent();if(i.hasFocus){var o,r,s,a,l,c,u,h=i.startNode,d=i.startOffset,f=i.endNode,p=i.endOffset;if(!h.isTextNode()||!f.isTextNode())if(console.log("Possible #10-01",h,f),h.isTextNode()&&!f.isTextNode())p=(f=h).text.length;else{if(h.isTextNode()||!f.isTextNode())return void console.log("#10-01");h=f,d=0}h.id==f.id?this._toggleStyleOnNode(h,d,p,t,n).SelectText(0,p-d):(o=z.GetAllTextNodes(this.document,h,f,!1),r=!1,s=[],h.IsStyleApplied(t)?s.push(!0):s.push(!1),o.forEach(function(e){e.IsStyleApplied(t)?s.push(!0):s.push(!1)}),f.IsStyleApplied(t)?s.push(!0):s.push(!1),1<(e=new Set(s),(s=function(e){if(Array.isArray(e))return ie(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e){if(e){if("string"==typeof e)return ie(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?ie(e,void 0):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()).length)&&(r=!0),r?((a=h).IsStyleApplied(t)||(a=this._toggleStyleOnNode(h,d,h.text.length,t,n)),o.forEach(function(e){e.IsStyleApplied(t)||e.ToggleStyle(t,n,!0)}),(l=f).IsStyleApplied(t)||this._toggleStyleOnNode(f,0,p,t,n),this.selectionManager.SelectText(a,0,l,p)):(c=this._toggleStyleOnNode(h,d,h.text.length,t,n),o.forEach(function(e){e.ToggleStyle(t,n,!0)}),u=this._toggleStyleOnNode(f,0,p,t,n),this.selectionManager.SelectText(c,0,u,p)))}}},{key:"_toggleStyleOnNode",value:function(e,t,n,i,o){var r=e.Split(t,n);if(1==r.length)return e.ToggleStyle(i,o,!0),e;var s=void 0;return(s=0==t?r[0]:r[1]).ToggleStyle(i,o,!1),z.ReplaceNode(this.document,e,r),s}}]),se);function se(e){!function(e){if(!(e instanceof se))throw new TypeError("Cannot call a class as a function")}(this),this.document=e,this.selectionManager=new W(this.document)}function ae(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var le=(ae(ue.prototype,[{key:"Insert",value:function(){if(this.selectionManager.IsCollapsed()||this.document.DeleteSelection(),this.selectionManager.IsCollapsed()){var e=this.selectionManager.GetCurrent();if(!e.hasFocus)return{};var t,n,i,o,r,s,a,l,c,u,h,d=e.startNode,f=e.startOffset,p=e.endOffset;null!=d&&d.isTextNode()?(t=d.parent).isBlockNode()?(i=!(n=[]),o=[],s=r=void 0,t.children.forEach(function(e){e.id==d.id?i=!0:i?n.push(e):(o.push(e),(r=e).isTextNode()&&(s=e.nodeStyle))}),a=d.Split(f,p),l=!0,c=[],a.forEach(function(e){""==e.text?l=!1:l?c.push(e):n.unshift(e)}),0<c.length||0<o.length?(z.ReplaceNode(this.document,d,c,!0),this.InsertNewRootLine("after",d.parent,!0,d.parent.nodeStyle,d.nodeStyle,n)):(u=void 0,null!=d.parent&&(u=d.parent.nodeStyle),this.InsertNewRootLine("before",d.parent,!1,u,d.nodeStyle,c)),null!=r&&r.isInlineNode()&&(h=B.CreateNew(this.document,"span","",s),t.Append(h))):console.log("#20-03"):console.log("#20-02")}else console.log("Selection not collapsed"),console.log("#20-01");return!0}},{key:"InsertNewRootLine",value:function(e,t,n,i,o,r){var s,a,l,c,u,h,d,f=t.parent;null!=f&&(a=s=0,f.children.forEach(function(e){e.id==t.id&&(s=a),a++}),null==i&&(i=new O(this.document)),(l=$.CreateNew(this.document,t.tagName,i.Copy(),t.attributes)).parent=f,"before"==e?(l.previous=t.previous,null!=t.previous&&(t.previous.next=l),(l.next=t).previous=l):(s+=1,l.previous=t,l.next=t.next,null!=t.next&&(t.next.previous=l),t.next=l),c=void 0,0==r.length?(u=B.CreateNew(this.document,"span","",o.Copy()),l.Append(u),c=u):(h=this.document,d=void 0,r.forEach(function(e){""==e.id&&(e.id=h.GenereateNewNodeId(),e.GenerateDomElement(),h.RegisterNode(e));var t=!0;e.isTextNode()&&(null!=d?d.HasSameStyle(e)&&d.HasSameAttributes(e)?(t=!1,d.AppendTextContent(e.text),d.next=e.next,h.UnregisterNode(e),e.domElement.parentNode.removeChild(e.domElement)):d=e:(e.previous=void 0,d=e)),t&&(l.Append(e),null==c&&(e.isTextNode()?c=e:e.isInlineNode()&&(c=e.previous)))})),f.domElement.insertBefore(l.domElement,f.domElement.children[s]),f.children.splice(s,0,l),"after"==e&&n&&c.SetFocus())}}]),ue),ce={DELETE:"delete",DELETE_TOP:"deleteTop",DELETE_FROM_BOTTOM:"deleteFromBottom",CANCEL_FROM_TOP:"cancelFromTop",CANCEL_FROM_BOTTOM:"cancelFromBottom",ENTER:"enter",APPLY_STYLE_ON_LINE:"applyStyleOnLine",APPLY_STYLE_ON_TEXT:"applyStyleOnText",CLICK:"click",DELETE_BEFORE_INLINE:"DELETE_BEFORE_INLINE",CANCEL_BEFORE_INLINE:"CANCEL_BEFORE_INLINE",NODE_UNREGISTERED:"NODE_UNREGISTERED",TAB:"TAB",NEW_CHAR_ADDED:"newCharAdded",ARROW_UP:"arrowUp",ARROW_DOWN:"arrowDown",ARROW_LEFT:"arrowLeft",ARROW_RIGHT:"arrowRight",SHIFT_ARROW_UP:"shiftArrowUp",SHIFT_ARROW_DOWN:"shiftArrowDown",SHIFT_ARROW_LEFT:"shiftArrowLeft",SHIFT_ARROW_RIGHT:"shiftArrowRight",SHIFT_DOWN:"SHIFT_DOWN",SHIFT_UP:"SHIFT_UP",SELECT_ALL:"SELECT_ALL",BEFORE_COPY:"BEFORE_COPY",BEFORE_CUT:"BEFORE_CUT",BEFORE_PASTE:"BEFORE_PASTE",LOST_FOCUS:"LOST_FOCUS",ESC:"esc"};function ue(e){!function(e){if(!(e instanceof ue))throw new TypeError("Cannot call a class as a function")}(this),this.document=e,this.selectionManager=new W(this.document)}function he(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var de=(he(fe.prototype,[{key:"DeleteNode",value:function(e){return z.ReplaceNode(this.document,e,[],!1)}},{key:"DeleteSelection",value:function(){var n,e,t,i,o,r=!1,s=this.selectionManager.GetCurrent(),a=s.startNode,l=s.startOffset,c=s.endNode,u=s.endOffset;return null!=a&&null!=c||(a=this.document.rootNode.GetFirstTextNode(),c=this.document.rootNode.GetLastTextNode(),u=c.text.length),c.isBlockNode()&&(n=!1,c.children.forEach(function(e){var t;e.id==a.id&&(n=!0),!n||null!=(t=e.domElement.getAttribute("contenteditable"))&&"false"==t&&(c=e.next,u=0)})),a.isTextNode()&&!c.isTextNode()?u=(c=a).text.length:!a.isTextNode()&&c.isTextNode()&&(a=c,l=0),a.isTextNode()&&c.isTextNode()?a.id==c.id?(a.DeleteText(l,u),r=!0,(e=this.selectionManager.GetRange()).deleteContents(),e.collapse(!0),(t=document.getSelection()).removeAllRanges(),t.addRange(e),""==a.text&&(null==a.previous&&null==a.next&&(a.SetZeroWidthChar(),a.SetFocus()),r=!0)):(z.DeleteNodesBetween(this.document,a,c),a.TrimTextContent(0,l),c.TrimTextContent(u),a.parent.id==c.parent.id?((a.next=c).previous=a,this._adjustAndSetFocus(a,c,l)):(i=a.parent,o=c.parent,i.parent.id==o.parent.id?(o.children.forEach(function(e){i.Append(e)}),o.children=[],this.DeleteNode(o),this._adjustAndSetFocus(a,c,l)):c.SetFocus()),r=!0):console.log("#30-01-01"),r}},{key:"Delete",value:function(){var e=!1;if(this.selectionManager.IsCollapsed()){var t=this.selectionManager.GetCurrent();if(!t.hasFocus)return!0;var n,i,o,r,s,a,l,c,u=t.startNode,h=t.startOffset;if(t.endOffset,!u.parent.isBlockNode())return console.log("#30-01"),!0;null!=u&&u.isTextNode()?(n=!1,h!=u.text.length&&""!=u.text||(n=!0),u.RemoveCharAt(h),h<u.text.length?e=!1:null==u.next?""==u.text?(null==u.parent.next?null!=u.previous&&u.previous.isTextNode()?(i=u.previous,this.DeleteNode(u),i.SetCarretAtTheEnd()):(u.SetZeroWidthChar(),u.SetFocus()):n?(o=!0,null!=u.parent.next.GetPluginType()&&(o=!this.document.NotifyPlugin(ce.CANCEL_FROM_TOP,u.parent.next)),o&&(this.DeleteNode(u),u.parent.next.isBlockNode()?null!=(r=u.parent.next.GetFirstTextNode())&&r.SetFocus():console.log("#72-28"))):(u.SetZeroWidthChar(),u.SetFocus()),e=!0):n?(null!=u.parent.next?(s=!0,null!=u.parent.next&&null!=u.parent.next.GetPluginType()&&(s=!this.document.NotifyPlugin(ce.CANCEL_FROM_TOP,u.parent.next)),!s||null!=(a=u.parent.Merge(u.parent.next,!0))&&a.SetFocus()):this.document.NotifyPlugin(ce.CANCEL_FROM_BOTTOM,u),e=!0):""==u.text&&(u.SetZeroWidthChar(),u.SetFocus(),e=!0):(l=u.next).isInlineNode()?n?(this.document.NotifyPlugin(ce.CANCEL_BEFORE_INLINE,l)||(c=l.next,this.DeleteNode(l),this.DeleteNode(u),null!=c&&c.SetFocus()),e=!0):""==u.text&&(u.SetZeroWidthChar(),u.SetFocus(),e=!0):l.isTextNode()&&(n?(l.RemoveCharAt(0,!0),""==l.text?(this.DeleteNode(l),u.SetCarretAtTheEnd()):l.SetFocus(),e=!0):""==u.text&&(this.DeleteNode(u),l.SetFocus(),e=!0))):e=!0}else e=this.DeleteSelection();return e}},{key:"Backspace",value:function(){var e=!1;if(this.selectionManager.IsCollapsed()){var t=this.selectionManager.GetCurrent();if(!t.hasFocus)return!0;var n,i,o,r,s,a,l,c,u,h,d,f,p=t.startNode,g=t.startOffset;if(t.endOffset,!p.parent.isBlockNode())return console.log("#30-23"),!0;null!=p&&p.isTextNode()?(n=!1,""==p.text&&(n=!0),(i=g-1)<0?(e=!0,o=p.previous,""==p.text?null!=o?o.isTextNode()?(this.DeleteNode(p),o.SetCarretAtTheEnd(),console.log("I DONT UNDERSTAND THIS (see next line)"),e=!0):o.isInlineNode()&&(r=o.previous,this.DeleteNode(o),this.DeleteNode(p),null!=r&&r.SetCarretAtTheEnd(),e=!0):(null!=p.parent.previous?(this.DeleteNode(p),null!=(s=p.parent.previous.Merge(p.parent,!1))&&s.SetCarretAtTheEnd()):null==p.parent.parent.parent||(this.document.IsNodeInsidePlugin(p)?this.document.NotifyPlugin(ce.DELETE_TOP,p):this._consolidateCommaNodes(p)),e=!0):null!=o?o.isTextNode()?(null!=o&&o.SetCarretAtTheEnd(),console.log("WHY AM I HERE?!?",o)):o.isInlineNode()&&(this.document.NotifyPlugin(ce.DELETE_BEFORE_INLINE,o)||(a=o.previous,this.DeleteNode(o),null!=a&&a.SetCarretAtTheEnd()),e=!0):(null!=p.parent.previous?(l=!0,null!=p.parent.previous.GetPluginType()&&(l=!this.document.NotifyPlugin(ce.DELETE_FROM_BOTTOM,p.parent.previous)),!l||null!=(c=p.parent.previous.Merge(p.parent,!1))&&c.SetCarretAtTheEnd()):null==p.parent.parent.parent||this.document.NotifyPlugin(ce.DELETE_TOP,p),e=!0)):(p.RemoveCharAt(i),e=""==p.text&&(null==(u=p.previous)?n?null!=p.parent.previous?(h=!0,null!=p.parent.previous.GetPluginType()&&(h=!this.document.NotifyPlugin(ce.DELETE_FROM_BOTTOM,p.parent.previous)),h&&(this.DeleteNode(p),null!=(d=p.parent.previous.Merge(p.parent,!1))&&d.SetCarretAtTheEnd())):null==p.parent.parent.parent||(this.document.IsNodeInsidePlugin(p)?this.document.NotifyPlugin(ce.DELETE_TOP,p):this._consolidateCommaNodes(p)):null!=p.next&&p.next.isTextNode()?(this.DeleteNode(p),p.next.SetFocus()):(p.SetZeroWidthChar(),p.SetFocus()):u.isInlineNode()?n?this.document.NotifyPlugin(ce.DELETE_BEFORE_INLINE,p.previous)||(f=u.previous,this.DeleteNode(u),this.DeleteNode(p),null!=f&&f.SetCarretAtTheEnd()):(p.SetZeroWidthChar(),p.SetFocus(),e=!0):(this.DeleteNode(p),u.SetCarretAtTheEnd()),!0))):e=!0}else e=this.DeleteSelection();return e}},{key:"_adjustAndSetFocus",value:function(e,t,n){var i,o;""==e.text&&""==t.text?null!=e.previous?(this.DeleteNode(e),this.DeleteNode(t),e.previous.isTextNode()?e.previous.SetCarretAtTheEnd():e.previous.isInlineNode()&&(null!=(i=e.previous).next&&i.next.isTextNode()?i.next.isTextNode()&&i.next.SetFocus():(o=B.CreateNew(i.document,"span","",e.nodeStyle.Copy()),i.parent.AppendAfter(i,o),o.SetFocus()))):null!=t.next?(this.DeleteNode(e),this.DeleteNode(t),t.next.SetFocus()):(this.DeleteNode(t),e.SetFocus()):""==e.text?(this.DeleteNode(e),t.SetFocus()):""==t.text?(this.DeleteNode(t),e.SetCarretAtTheEnd()):e.nodeStyle.Equals(t.nodeStyle)?(e.Merge(t),e.SetFocus(n)):t.SetFocus()}},{key:"_consolidateCommaNodes",value:function(e){var t=this._removeSubBlock(this.document.rootNode,e);0==this.document.rootNode.children.length&&this.document.InitEmptyDoc(),null!=t&&t.SetFocus()}},{key:"_removeSubBlock",value:function(e,n){var i=this,o=void 0,r=!0;return e.children.forEach(function(e){var t;e.Contains(n.id)&&(r=!1,e.isEmpty()?i.document.DeleteNode(e):null!=(t=i._removeSubBlock(e,n))&&(o=t)),r&&(o=e.GetLastTextNode())}),o}}]),fe);function fe(e){!function(e){if(!(e instanceof fe))throw new TypeError("Cannot call a class as a function")}(this),this.document=e,this.selectionManager=new W(this.document)}function pe(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var ge=(pe(me.prototype,[{key:"GetAll",value:function(){return this.allPictures}},{key:"GetNextPicture",value:function(){var e=this.allPictures[this.indexNextToGet];return this.indexNextToGet++,e}},{key:"ResetGetNext",value:function(){this.indexNextToGet=0}},{key:"ParseRtf",value:function(){var e=this.rtf;this.ExtractNextPicture(e),this.allPictures=Object.values(this.pictures)}},{key:"ExtractNextPicture",value:function(e){var t=e.indexOf("{\\pict");if(!(-1<t))return!1;var n=this.GetPic(e,t);!1!==n&&this.ExtractNextPicture(n)}},{key:"GetPicId",value:function(e){var t=e.indexOf("\\blipuid"),n=e.substring(t).replace("\\blipuid",""),i="";for(var o in n){var r=n[o];if("}"==r)break;i+=r}return i.trim()}},{key:"GetMimeType",value:function(e){var t="";return-1<e.indexOf("jpegblip")?t="image/jpeg":-1<e.indexOf("emfblip")?t="emf":-1<e.indexOf("pngblip")?t="image/png":-1<e.indexOf("macpict")&&(t="pict"),t}},{key:"GetContent",value:function(e){for(var t=e.replace(/({?.*})/gi,"").replace(/[\W_]+/g,""),n="",i=0;i<t.length;i+=2)n+=String.fromCharCode(parseInt(t.substr(i,2),16));return btoa(n)}},{key:"AnalizePicChunk",value:function(e){var t,n=this.GetPicId(e);null==this.pictures[n]&&((t={}).id=n,t.positionInDocument=this.counter,this.counter++,t.mimeType=this.GetMimeType(e),t.content=this.GetContent(e),t.srcReady="data:"+t.mimeType+";base64,"+t.content,this.pictures[n]=t)}},{key:"GetPic",value:function(e,t){for(var n=t,i=!1,o=0,r="",s=t;n<e.length;){var a=e[n];"{"==a&&o++,"}"==a&&o--,0<o&&!i&&(r+=a,s=n),0==o&&(i=!0),n++}return this.AnalizePicChunk(r),e.substring(s)}}]),me);function me(e){!function(e){if(!(e instanceof me))throw new TypeError("Cannot call a class as a function")}(this),this.rtf=e,this.pictures={},this.counter=0,this.allPictures=[],this.indexNextToGet=0}function ve(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var ye=["address","article","blockquote","br","canvas","dd","div","dl","dt","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","iframe","li","main","nav","output","p","pre","section","td","tr","video"],be=["b","i","u"],Ce=["table","ul","ol","img","a"],xe=(ve(we.prototype,[{key:"ExtactAttributes",value:function(e){var t=[];if(e.hasAttributes())for(var n=e.attributes,i=n.length-1;0<=i;i--){var o=n[i].name,r=n[i].value;"style"!=o.toLowerCase()&&"cm-id"!=o.toLowerCase()&&"cm-type"!=o.toLowerCase()&&"cm-plugin"!=o.toLowerCase()&&t.push({name:o,value:r})}return t}},{key:"isBlock",value:function(e){return!(ye.indexOf(e.toLowerCase())<0)}},{key:"isTagWithSpecialNeeds",value:function(e){return!(Ce.indexOf(e.toLowerCase())<0)}},{key:"isFormattingTag",value:function(e){return!(be.indexOf(e.toLowerCase())<0)}},{key:"GenerateNewTextNode",value:function(e,t){var n=1<arguments.length&&void 0!==t?t:void 0;return null==n&&(n=this.document.GetDefaultNodeStyle().Copy()),B.CreateNew(this.document,"span",e,n)}},{key:"GenerateNewBlockLine",value:function(){var e=$.CreateNew(this.document,"div"),t=B.CreateNew(this.document,"span","",this.document.GetDefaultNodeStyle().Copy());return e.Append(t),e}},{key:"ParseNode",value:function(e){var t,n,i,o,r,s,a,l,c=this,u=void 0;return e.nodeType===e.TEXT_NODE?"O:P"===e.parentNode.tagName||""!=(t=e.textContent).trim()&&(n=O.CalculateStylesForExternalHTML(this.document,e.parentNode),u=this.GenerateNewTextNode(t.replace(/\n|\r/g," "),n)):e.nodeType===e.ELEMENT_NODE&&("O:P"==e.tagName?u=this.GenerateNewBlockLine():(i=e.tagName.toLowerCase(),o=this.ExtactAttributes(e),r=void 0,"body"==i?i="div":r=O.CalculateStylesForExternalHTML(this.document,e),this.isBlock(i)?"br"==i.toLowerCase()||(u=$.CreateNew(this.document,i,r,o),e.childNodes.forEach(function(e){var t=c.ParseNode(e);null!=t&&(null!=t.length&&0<t.length?t.forEach(function(e){null!=e.length?e.forEach(function(e){}):u.Append(e)}):Array.isArray(t)||u.Append(t))})):this.isTagWithSpecialNeeds(i)?("img"==i.toLowerCase()&&(!this.fromRtf||null!=(s=this.rtfPictures.GetNextPicture())&&(e.src=s.srcReady)),u=this.pluginsManager.PasteContentToPlugin(e.tagName.toLowerCase(),e)):1<e.childNodes.length?(u=[],e.childNodes.forEach(function(e){var t=c.ParseNode(e);null!=t&&u.push(t)})):(this.isFormattingTag(i)&&(i="span"),a=O.CalculateStylesForExternalHTML(this.document,e),u=B.CreateNew(this.document,i,e.textContent.replace(/\n|\r/g," ").replace(/[\u200B-\u200D\uFEFF]/g,""),a),"b"==i?u.ToggleStyle("bold","",!0,!0):"i"==i?u.ToggleStyle("italic","",!0,!0):"u"==i&&u.ToggleStyle("underlined","",!0,!0),l=[u],e.childNodes.forEach(function(e){var t;e.nodeType===e.TEXT_NODE||null!=(t=c.ParseNode(e))&&l.push(t)}),1<l.length&&(u=l)))),u}},{key:"Parse",value:function(){var e,t=this,n=this.pastedDocumentInBrowser.firstChild.getElementsByTagName("body")[0];null!=n&&(null!=(e=this.ParseNode(n))&&(null!=e.length&&0<e.length?e.forEach(function(e){t.newNodes.push(e)}):this.newNodes.push(e)),0<this.newNodes.length&&this._pasteInPlace(this.newNodes))}},{key:"_pasteInPlace",value:function(e){var c=void 0,t=this.document.selectionManager.GetCurrent(),u=t.startOffset,n=t.startNode,h=n.parent,i=[],o=[],r=!0;h.children.forEach(function(e){e.id==n.id?(c=e,r=!1):r?i.push(e):o.push(e)}),h.children=i;var s=n.text.substring(0,u),a=n.text.substring(u,n.text.length);n.ForceTextContent(s);var l,d=n,f=u,p=!1;e.forEach(function(e){var t,n,i,o,r,s,a,l=!0;e.isTextNode()?d.isTextNode()&&d.nodeStyle.Equals(e.nodeStyle)&&(e.parent=d.parent,d.Merge(e,u),c=d,l=!1,u+=e.text.length,f=u,p=!1):e.isBlockNode()&&(l=!1,p||h.Append(d),p=!0,t=h.parent,o=[],r=[],s=!(i=n=0),t.children.forEach(function(e){s?o.push(e):r.push(e),e.id==h.id&&(n=i,s=!1),i++}),n+=1,t.children=o,(a=e).parent=t,a.previous=h,a.next=h.next,null!=h.next&&(h.next.previous=a),h.next=a,h=a,t.domElement.insertBefore(a.domElement,t.domElement.children[n]),t.Append(a),r.forEach(function(e){t.Append(e)}),a.children.forEach(function(e){"text"==e.type&&(f=e.text.length,c=d=e)})),l&&(e.parent=d.parent,e.next=d.next,(d.next=e).previous=d,h.Append(d),p=!1,"text"==(d=e).type&&(f=(c=e).text.length))}),p||h.Append(d),""!=a&&(l=B.CreateNew(this.document,"span",a,n.nodeStyle.Copy()),h.Append(l),f=0,c=l),o.forEach(function(e){h.Append(e)}),c.SetFocus(f)}}]),we);function we(e,t,n){!function(e){if(!(e instanceof we))throw new TypeError("Cannot call a class as a function")}(this),this.document=e,this.pastedDocument=t,this.pluginsManager=e.pluginsManager,this.rtf=n,this.fromRtf=!1,null!=this.rtf&&""!=this.rtf&&(this.rtfPictures=new ge(n),this.rtfPictures.ParseRtf(),this.fromRtf=!0),this.pastedDocumentInBrowser=void 0;var i=document.createElement("div");i.style.display="none",i.appendChild(t.documentElement),document.body.appendChild(i),this.pastedDocumentInBrowser=i,this.newNodes=[],this.currentLine=void 0,this.Parse(),i.parentElement.removeChild(i)}function Se(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var _e=(Se(Ee.prototype,[{key:"HtmlToNode",value:function(e,t){var n=!(1<arguments.length&&void 0!==t)||t,i=(new DOMParser).parseFromString(e,"text/html").body.firstElementChild,o=this.ParseNode(i);return n&&(o=this.Optimize(o)),o}},{key:"Optimize",value:function(e){var o,r=this;return null!=e.children&&(o=[],e.children.forEach(function(e){var t,n,i;e.isTextNode()?(n=!0,null!=(t=e.previous)&&t.isTextNode()&&t.tagName.toLowerCase()==e.tagName.toLowerCase()&&t.HasSameAttributes(e)&&(i=!1,!t.HasSameStyle(e)&&""!=e.text||(i=!0),i&&(""!=e.text&&t.AppendTextContent(e.text),t.next=e.next,null!=t.next&&(t.next.previous=t),t.document.UnregisterNode(e),e.domElement.parentNode.removeChild(e.domElement),n=!1)),n&&o.push(e)):e.isBlockNode()?o.push(r.Optimize(e)):e.isInlineNode()&&o.push(e)}),e.children=o),e}},{key:"ParseNode",value:function(e){e.getAttribute("cm-id");var t=e.getAttribute("cm-type"),n=void 0;if("block"==t.toLowerCase())n=this.ParseBlockNode(e);else if("inline"==t.toLowerCase())n=this.ParseInlineNode(e);else{if("text"!=t.toLowerCase())throw console.log("U.F.O. NODE"),"UNKNON NODE TYPE [1]: "+e.outerHTML;n=this.ParseTextNode(e)}return n}},{key:"ExtactAttributes",value:function(e){var t=[];if(e.hasAttributes())for(var n=e.attributes,i=n.length-1;0<=i;i--){var o=n[i].name,r=n[i].value;"style"!=o.toLowerCase()&&"cm-id"!=o.toLowerCase()&&"cm-type"!=o.toLowerCase()&&"cm-plugin"!=o.toLowerCase()&&"xmlns"!=o.toLowerCase()&&t.push({name:o,value:r})}return t}},{key:"ParseBlockNode",value:function(r){var e,t,n,i,o,s=this,a=r.getAttribute("cm-type"),l=void 0;return"block"==a.toLowerCase()&&(e=r.getAttribute("cm-id"),t=r.getAttribute("cm-plugin"),n=null!=(n=r.getAttribute("cm-has-text-content"))&&JSON.parse(n),i=O.CalculateStyles(this.document,r),o=s.ExtactAttributes(r),null==e?l=$.CreateNew(this.document,r.tagName.toLowerCase(),i.Copy(),o,n,r.textContent):(e=this.document.VerifyAndRegisterNodeId(e),l=new $(this.document,e,r.tagName.toLowerCase(),i.Copy(),o,n,r.textContent),this.document.RegisterNode(l)),r.childNodes.forEach(function(e){if(1==e.nodeType){e.getAttribute("cm-id");var t=e.getAttribute("cm-type");if(null!=t)if("block"==t.toLowerCase()){var n=s.ParseBlockNode(e);l.Append(n)}else if("inline"==t.toLowerCase()){var i=s.ParseInlineNode(e);l.Append(i)}else{if("text"!=t.toLowerCase())throw console.log("UFO NODE"),"UNKNON NODE TYPE [2]: "+r.outerHTML;var o=s.ParseTextNode(e);l.Append(o)}}}),null!=t&&""!=t&&this.document.CreatePluginInstance(t,l)),l}},{key:"ParseInlineNode",value:function(r){var e,t,n,i,s=this,o=r.getAttribute("cm-id"),a=r.getAttribute("cm-type"),l=void 0;return"inline"==a.toLowerCase()&&(e=r.getAttribute("cm-plugin"),t=O.CalculateStyles(this.document,r),n=s.ExtactAttributes(r),i=r.textContent.replace(/[\u200B-\u200D\uFEFF]/g,""),0<r.childNodes.length&&1==r.childNodes[0].nodeType&&(i=""),null==o?l=ne.CreateNew(this.document,r.tagName.toLowerCase(),i,t.Copy(),n):(o=this.document.VerifyAndRegisterNodeId(o),l=new ne(this.document,o,r.tagName.toLowerCase(),i,t.Copy(),n),this.document.RegisterNode(l)),r.childNodes.forEach(function(e){if(1==e.nodeType){e.getAttribute("cm-id");var t=e.getAttribute("cm-type");if("block"==t.toLowerCase()){var n=s.ParseBlockNode(e);l.Append(n)}else if("inline"==t.toLowerCase()){var i=s.ParseInlineNode(e);l.Append(i)}else{if("text"!=t.toLowerCase())throw console.log("UFO NODE"),"UNKNON NODE TYPE [3]: "+r.outerHTML;var o=s.ParseTextNode(e);l.Append(o)}}}),null!=e&&""!=e&&this.document.CreatePluginInstance(e,l)),l}},{key:"ParseTextNode",value:function(e){var t,n,i,o,r=e.getAttribute("cm-id"),s=void 0;return"text"==e.getAttribute("cm-type").toLowerCase()&&(t=e.getAttribute("cm-plugin"),n=O.CalculateStyles(this.document,e),i=this.ExtactAttributes(e),o=e.textContent.replace(/[\u200B-\u200D\uFEFF]/g,""),null==r?s=B.CreateNew(this.document,e.tagName.toLowerCase(),o,n.Copy(),i):(r=this.document.VerifyAndRegisterNodeId(r),s=new B(this.document,r,e.tagName.toLowerCase(),n.Copy(),o,i),this.document.RegisterNode(s)),null!=t&&""!=t&&this.document.CreatePluginInstance(t,s)),s}},{key:"stringIsUrl",value:function(e){return-1<e.indexOf("http://")||-1<e.indexOf("https://")}},{key:"stringIsEmail",value:function(e){return/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(e).toLowerCase())}},{key:"PasteSimpleString",value:function(e){var t,n=[];this.stringIsUrl(e)?n=this.document.pluginsManager.PasteContentToPlugin("a",e):this.stringIsEmail(e)?n=this.document.pluginsManager.PasteContentToPlugin("a","mailTo:"+e):(t=B.CreateNew(this.document,"span",e.replace(/[\u200B-\u200D\uFEFF]/g,""),this.document.GetDefaultNodeStyle().Copy()),n.push(t)),this._pasteInPlace(n)}},{key:"PasteContentInPlace",value:function(e,t){var n,i,o,r=1<arguments.length&&void 0!==t?t:"",s=(new DOMParser).parseFromString(e,"text/html"),a=s.body.firstElementChild,l=!0;null!=a&&(null!=(n=a.getAttribute("comma"))&&"comma-content"==n?l=!1:(i=a.getAttribute("cm-id"),o=a.getAttribute("cm-type"),null!=i&&""!=i&&null!=o&&""!=o&&(l=!1))),l?this._pasteExternalContent(s,r):this._pasteOurContent(a)}},{key:"_pasteExternalContent",value:function(e,t){new xe(this.document,e,t)}},{key:"_pasteOurContent",value:function(e){var i=this,o=[];e.childNodes.forEach(function(e){var t,n=void 0;3==e.nodeType?n=B.CreateNew(this.document,e.tagName.toLowerCase(),e.textContent.replace(/[\u200B-\u200D\uFEFF]/g,"")):"block"==(t=e.getAttribute("cm-type"))?n=i.ParseBlockNode(e):"inline"==t?n=i.ParseInlineNode(e):"text"==t&&(n=i.ParseTextNode(e)),o.push(n)}),this._pasteInPlace(o)}},{key:"_pasteInPlace",value:function(e){var c=void 0,t=this.document.selectionManager.GetCurrent(),u=t.startOffset,n=t.startNode,h=n.parent,i=[],o=[],r=!0;h.children.forEach(function(e){e.id==n.id?(c=e,r=!1):r?i.push(e):o.push(e)}),h.children=i;var s=n.text.substring(0,u),a=n.text.substring(u,n.text.length);n.ForceTextContent(s);var l,d=n,f=u,p=!1;e.forEach(function(e){var t,n,i,o,r,s,a,l=!0;e.isTextNode()?d.isTextNode()&&d.nodeStyle.Equals(e.nodeStyle)&&(e.parent=d.parent,d.Merge(e,u),c=d,l=!1,u+=e.text.length,f=u,p=!1):e.isBlockNode()&&(l=!1,p||h.Append(d),p=!0,t=h.parent,o=[],r=[],s=!(i=n=0),t.children.forEach(function(e){s?o.push(e):r.push(e),e.id==h.id&&(n=i,s=!1),i++}),n+=1,t.children=o,(a=e).parent=t,a.previous=h,a.next=h.next,null!=h.next&&(h.next.previous=a),h.next=a,h=a,t.domElement.insertBefore(a.domElement,t.domElement.children[n]),t.Append(a),r.forEach(function(e){t.Append(e)}),a.children.forEach(function(e){"text"==e.type&&(f=e.text.length,c=d=e)})),l&&(e.parent=d.parent,e.next=d.next,(d.next=e).previous=d,h.Append(d),p=!1,"text"==(d=e).type&&(f=(c=e).text.length))}),p||h.Append(d),""!=a&&(l=B.CreateNew(this.document,"span",a,n.nodeStyle.Copy()),h.Append(l),f=0,c=l),o.forEach(function(e){h.Append(e)}),c.SetFocus(f)}}]),Ee);function Ee(e){!function(e){if(!(e instanceof Ee))throw new TypeError("Cannot call a class as a function")}(this),this.document=e}function Te(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var ke,Oe,Ae=(Oe=[{key:"_CleanDomNode",value:function(n,t){var i,o=!0,r=n.getAttribute("cm-id");return t.childNodes.forEach(function(e){var t=e.getAttribute("cm-id");r==t&&(o=!1,n.parentNode.replaceChild(e.cloneNode(!0),n))}),o&&(n.hasChildNodes()?(i=[],n.childNodes.forEach(function(e){3!=e.nodeType&&(o=Pe._CleanDomNode(e,t))&&i.push(e)}),i.forEach(function(e){try{n.removeChild(e)}catch(e){console.log("#23-239",e)}})):n.remove()),o}},{key:"_fallbackCopyTextToClipboard",value:function(e){var t,n,i=document.createElement("textarea");i.value=e,document.body.appendChild(i),i.focus(),navigator.userAgent.match(/ipad|iphone/i)?((t=document.createRange()).selectNodeContents(i),(n=window.getSelection()).removeAllRanges(),n.addRange(t),i.setSelectionRange(0,999999)):i.select();try{document.execCommand("copy")}catch(e){console.error("ClipboardManager[205]",e)}document.body.removeChild(i)}},{key:"_copyTextToClipboard",value:function(e){navigator.clipboard?navigator.clipboard.writeText(e).then(function(){},function(e){console.error("ClipboardManager[205]",e)}):Pe._fallbackCopyTextToClipboard(e)}}],Te((ke=Pe).prototype,[{key:"Paste",value:function(e,t){t.do(Fe.DELETE_SELECTION);var n=e.clipboardData.getData("text/rtf"),i=e.clipboardData.getData("text/html"),o=e.clipboardData.getData("text/plain"),r=Array.from(e.clipboardData.files||[]);return!i&&0<r.length||(null==i||""==i?new _e(this.document).PasteSimpleString(o):new _e(this.document).PasteContentInPlace(i,n)),!0}},{key:"Copy",value:function(e){var t=e,n=this.GetSelectedContent(!1);return t.clipboardData.setData("text/html",n),t.clipboardData.setData("text/plain",this._getPlainText(n)),!0}},{key:"Cut",value:function(e,t){var n=e,i=this.GetSelectedContent(!0,t);return n.clipboardData.setData("text/html",i),n.clipboardData.setData("text/plain",this._getPlainText(i)),!0}},{key:"_getPlainText",value:function(e){var t=document.createElement("div");return t.innerHTML=e,Array.from(t.getElementsByTagName("div")).forEach(function(e){"block"==e.getAttribute("cm-type")&&(e.innerHTML="\r\n"+e.innerHTML)}),t.textContent||t.innerText}},{key:"GetSelectedContent",value:function(e,t){var n,i=this.selectionManager.GetCurrent(),l=i.startNode,c=(i.startOffset,i.endNode),o=(i.endOffset,this.selectionManager.GetRange().cloneContents()),u=!0,h="",d=new XMLSerializer,r=!0,s=this.selectionManager.FindCommonNodeContainer(l,c);return null!=s&&null!=s.pluginName&&""!=s.pluginName&&(n=s.domElement.cloneNode(!0),Pe._CleanDomNode(n,o),h=d.serializeToString(n),r=!1),r&&o.childNodes.forEach(function(e){var t,n,i,o,r,s,a;3==e.nodeType?(i=n=t="",u?(u=!1,t='id="'+l.id+'" cm-id="'+l.id+'"',""!=(o=l.nodeStyle.toStringForStyleTag())&&(n='style="'+o+'"'),""!=(r=l.nodeStyle.toStringForClassTag())&&(i='class="'+r+'"')):(t='id="'+c.id+'" cm-id="'+c.id+'"',""!=(s=c.nodeStyle.toStringForStyleTag())&&(n='style="'+s+'"'),""!=(a=c.nodeStyle.toStringForClassTag())&&(i='class="'+a+'"')),h=h+'<span cm-type="text" '+t+" "+i+" "+n+">"+d.serializeToString(e)+"</span>"):e.getAttribute("cm-id")==l.parent.id?e.childNodes.forEach(function(e){h+=d.serializeToString(e)}):h+=d.serializeToString(e)}),e&&t.do(Fe.DELETE_SELECTION),h='<div comma="comma-content">'+h+"</div>"}},{key:"ForceClipboardContent",value:function(e){var t=(new XMLSerializer).serializeToString(e);Pe._copyTextToClipboard('<div comma="comma-content">'+t+"</div>")}}]),Te(ke,Oe),Pe);function Pe(e){!function(e){if(!(e instanceof Pe))throw new TypeError("Cannot call a class as a function")}(this),this.document=e,this.selectionManager=new W(this.document)}function Ne(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var Fe={GET_STYLES_AT_CARRET:"getStyleAtCurrentCursorPosition",TOGGLE_STYLE_ON_LINE:"toggleStyleOnLine",TOGGLE_STYLE_ON_SELECTION:"toggleStyleOnSelection",INSERT_CHAR:"addChar",ENTER:"enter",DELETE:"delete",DELETE_SELECTION:"deleteSelection",BACKSPACE:"backspace",TAB:"tab",CUT:"cut",COPY:"copy",PASTE:"paste",ESC:"esc"},Me=(Ne(Be.prototype,[{key:"do",value:function(e,t){var n,i=void 0,o=!1;if(this.catchUserInput&&(n="",-1<this.charactersToCacth.indexOf(e)?n=this.charactersToCacth[this.charactersToCacth.indexOf(e)]:"addChar"==e&&-1<this.charactersToCacth.indexOf(t.character)&&(n=t.character),""!=n&&this.onCharacterEntered(n,this.selectionManager.GetStartNode(),this.selectionManager.GetEndNode())&&(i=o=!0)),!o){var r=this.selectionManager.GetStartNode();if(null!=r&&r.isTextNode())switch(e){case Fe.INSERT_CHAR:i=this._insertCharacter(t.character);break;case Fe.TOGGLE_STYLE_ON_LINE:i=(i=this.document.NotifyPlugin(ce.APPLY_STYLE_ON_LINE,r,t))||this.stylesManager.ToggleStyleOnLine(t.styleName,t.value);break;case Fe.TOGGLE_STYLE_ON_SELECTION:i=(i=this.document.NotifyPlugin(ce.APPLY_STYLE_ON_TEXT,r,t))||this.stylesManager.ToggleStyleOnSelection(t.styleName,t.value);break;case Fe.GET_STYLES_AT_CARRET:i=this.stylesManager.GetStyleAtCurrentCursorPosition();break;case Fe.ENTER:i=this.enterManager.Insert();break;case Fe.DELETE:i=this.deleteManager.Delete();break;case Fe.DELETE_SELECTION:i=this.deleteManager.DeleteSelection();break;case Fe.BACKSPACE:i=this.deleteManager.Backspace();break;case Fe.TAB:i=this.stylesManager.ToggleStyleOnLine("indent","add"),i=!0;break;case Fe.COPY:i=this.clipboardManager.Copy(t);break;case Fe.CUT:i=this.clipboardManager.Cut(t,this);break;case Fe.PASTE:i=this.clipboardManager.Paste(t,this);break;default:return}else switch(e){case Fe.TOGGLE_STYLE_ON_LINE:this.document.NotifyPlugin(ce.APPLY_STYLE_ON_LINE,void 0,t);break;case Fe.TOGGLE_STYLE_ON_SELECTION:this.document.NotifyPlugin(ce.APPLY_STYLE_ON_TEXT,void 0,t);break;case Fe.BACKSPACE:i=!0,null!=r&&(r.document.IsNodeInsidePlugin(r)?void 0===(i=this.document.NotifyPlugin(ce.DELETE,void 0,t))&&(i=!0):this.document.NotifyPlugin(ce.DELETE,void 0,t));break;case Fe.DELETE:this.document.NotifyPlugin(ce.DELETE,void 0,t),i=!0;break;case Fe.ENTER:i=!0;break;default:i=!this.document.IsNodeInsidePlugin(r)}}return i}},{key:"GetStylesFromNode",value:function(e){return this.stylesManager.GetStyleFromNode(e)}},{key:"_insertCharacter",value:function(e){var t=!1;this.selectionManager.IsCollapsed()||this.document.DeleteSelection();var n=this.selectionManager.GetStartNode();return null!=n&&n.isTextNode()?t=n.InsertCharacter(e):(t=!0,console.log(this.selectionManager.GetCurrent()),console.log("entering text on empty node",n)),t}},{key:"ForceClipboardContent",value:function(e){this.clipboardManager.ForceClipboardContent(e)}}]),Be),Re={},De=function(e,t,n){if("s"!=e)return Re[t];Re[t]=n},Ie={isProduction:!0,version:"snqnry"},Le="97.72.82.48.99.68.111.118.76.122.65.117.77.67.52.119.76.106.65.54.77.122.65.119.77.67.57.112.80.119.61.61";function Be(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:void 0;!function(e){if(!(e instanceof Be))throw new TypeError("Cannot call a class as a function")}(this),this.document=e,this.selectionManager=new W(this.document),this.stylesManager=new re(this.document),this.enterManager=new le(this.document),this.deleteManager=new de(this.document),this.clipboardManager=new Ae(this.document),this.catchUserInput=!1,null!=t&&(this.catchUserInput=!0,this.charactersToCacth=t.characters,this.onCharacterEntered=t.onCharacterEntered)}Ie.isProduction&&(Le="97.72.82.48.99.72.77.54.76.121.57.51.100.51.99.117.89.50.57.116.98.87.70.113.99.121.53.106.98.50.48.118.97.84.56.61");var je="98.71.57.106.89.88.82.112.98.50.52.61",Ge="97.71.57.122.100.71.53.104.98.87.85.61",He="90.87.53.106.98.50.82.108.86.86.74.74.81.50.57.116.99.71.57.117.90.87.53.48";function ze(e){for(var t=e.split("."),n="",i=0;i<t.length;i++)n+=String.fromCharCode(t[i]);return atob(n)}var Ye=!1,Ue=!1;var We=0,Xe=Math.floor(481*Math.random()+20);var Ve=function(){var e,t,n=!1;return e=window[ze(je)][ze(Ge)],t=!1,e!=ze("98.71.57.106.89.87.120.111.98.51.78.48")&&e!=ze("77.67.52.119.76.106.65.117.77.65.61.61")&&e!=ze("77.84.73.51.76.106.65.117.77.67.52.120")||(t=!0),t||-1<e.indexOf(ze("99.71.120.49.90.50.99.117.89.50.56.61"))&&(t=!0),t?(""==De("g","l")||null==De("g","l")||De("g","v")&&De("g","vv"))&&(n=!0):Xe<++We?Ue?n=Ye:(n=!0,function(){var e=function(e){if(null!=e&&""!=e){var t=window[ze(je)][ze(Ge)];4==t.split(".").length||(t=t.split(".").slice(-2).join("."));for(var n=(e+"#"+Ie.version+"#"+t).toString().split(""),i=0;i<n.length;i++)n[i].charCodeAt(0)<=126&&(n[i]=String.fromCharCode((n[i].charCodeAt(0)+13)%126));e=btoa(n.join(""))}return window[ze(He)](e)}(De("g","l"));if(null==e)return new Promise(function(e,t){navigator.onLine?Ue=!(Ye=!1):Ye=Ue=!0,e()});var n=new Image;navigator.onLine&&De("g","f")(n,ze(Le)+e);var i=!1;n[ze("99.51.74.106")].indexOf(e)<0&&(i=!0),new Promise(function(e,t){i?Ue=!(Ye=!1):navigator.onLine?(n[ze("98.50.53.115.98.50.70.107")]=function(e){Ue=!(Ye=!1)},n[ze("98.50.53.108.99.110.74.118.99.103.61.61")]=function(e){Ue=Ye=!0}):Ye=Ue=!0,e()})}()):(De("g","v")&&De("g","vv"),n=!0),n};function qe(e){return function(e){if(Array.isArray(e))return Ke(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e){if(e){if("string"==typeof e)return Ke(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?Ke(e,void 0):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ke(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function Je(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var $e=(Je(Ze.prototype,[{key:"Register",value:function(e,t){var n=1<arguments.length&&void 0!==t?t:void 0,i=e.GetName();if(null!=this.allPlugins[i])throw"Plugin or plugin's name already registered: '"+i+"'";var o={name:i,class:e,options:n};this.allPlugins[i]=o,null!=n&&n.fireOnChar&&null!=n.charForFire&&""!=n.charForFire&&(this.catchSpecialChars.push(n.charForFire),null==this.specialCharToPlugin[n.charForFire]&&(this.specialCharToPlugin[n.charForFire]=[]),this.specialCharToPlugin[n.charForFire].push(i))}},{key:"GetAllPluginInstances",value:function(e){var n=0<arguments.length&&void 0!==e?e:void 0,i=[],o=this;return Object.keys(this.allInstances).forEach(function(e){var t=o.allInstances[e];null!=n&&t.rootNode.GetPluginType().toLowerCase()!=n.toLowerCase()||i.push(t)}),i}},{key:"GetPluginOptions",value:function(e){var t=this.allPlugins[e];return null!=t?t.options:void 0}},{key:"NotifyPluginOnSpecialChar",value:function(e){var n=this,t=!1;return-1<this.catchSpecialChars.indexOf(e)&&this.specialCharToPlugin[e].forEach(function(e){var t=n.allPlugins[e];null!=t.options&&(t.options.fireCreateNew?n.InsertPluginAtSection(e):t.class[t.options.fireStaticFunction](n.document,t.options))}),Ve()||(t=!0),t}},{key:"IsNodeInsidePlugin",value:function(e){return null!=this.FindNodesInstance(e)}},{key:"NotifyPlugin",value:function(e,t,n){if(null!=t){var i,o,r=this.FindNodesInstance(t);return null!=r?(this.idInstanceInFocus!=r.id&&(null!=(i=this.allInstances[this.idInstanceInFocus])&&i.Fire(ce.LOST_FOCUS),this.idInstanceInFocus=r.id),this.idInstanceInFocus=r.id,r.Fire(e,t,this,n)):(null==this.idInstanceInFocus||null!=(o=this.allInstances[this.idInstanceInFocus])&&o.Fire(ce.LOST_FOCUS),this.idInstanceInFocus=void 0,!1)}if(null!=this.idInstanceInFocus){var s=this.allInstances[this.idInstanceInFocus];if(null!=s)return s.Fire(e,t,this,n)}}},{key:"CallPluginStaticMethod",value:function(e,t,n){var i=this.allPlugins[e];if(null==i||null==i.class)throw"Unknown plugin: '"+e+"'";i.class[t](this.document,n)}},{key:"FindNodesInstance",value:function(e){var t=void 0;return null!=e.GetPluginType()&&""!=e.GetPluginType()?t=this.allInstances[e.id]:null!=e.parent&&(t=this.FindNodesInstance(e.parent)),t}},{key:"RegisterPluginInstance",value:function(e){this.allInstances[e.id]=e}},{key:"DeletePluginInstance",value:function(e){delete this.allInstances[e.id]}},{key:"RemovePluginInstance",value:function(e){var t=this.allInstances[e];null!=t&&(null!=t.rootNode&&t.rootNode.RemovePluginType(),delete this.allInstances[e])}},{key:"ChangePluginInstanceId",value:function(e,t){var n=this.allInstances[e];null!=n&&(n.id=t,delete this.allInstances[e],this.RegisterPluginInstance(n))}},{key:"InsertPluginAtSection",value:function(t,e){var n=this.allPlugins[t];if(null==n||null==n.class)throw"Unknown plugin: '"+t+"'";var i,o=n.class.CreateNew(this.document,e);return null!=o&&(Array.isArray(o)?(i=this,o.forEach(function(e){e.rootNode.SetPluginType(t),i.RegisterPluginInstance(e)})):(o.rootNode.SetPluginType(t),this.RegisterPluginInstance(o))),o}},{key:"CreatePluginInstance",value:function(e,t){var n=this.allPlugins[e];if(null==n||null==n.class)throw"Unknown plugin: '"+e+"'";var i=new n.class(t);i.rootNode.SetPluginType(e),this.RegisterPluginInstance(i)}},{key:"FindPluginForPasteByTagName",value:function(n){var i=void 0,o=this;return Object.keys(this.allPlugins).forEach(function(e){var t=o.allPlugins[e];-1<t.class.GetTagToParseOnPaste().indexOf(n.toLowerCase())&&(i=t)}),i}},{key:"PasteContentToPlugin",value:function(e,t){var n=this.FindPluginForPasteByTagName(e);if(null!=n){var i=n.class.CreateNewFromPastedNode(this.document,t);if(null!=i.mustArrangeNodes&&i.mustArrangeNodes){var o=i.pluginNode,r=i.nodesBefore,s=i.nodesAfter;return o.rootNode.SetPluginType(n.name),this.RegisterPluginInstance(o),[].concat(qe(r),[o.rootNode],qe(s))}return i.rootNode.SetPluginType(n.name),this.RegisterPluginInstance(i),i.rootNode}}}]),Ze);function Ze(e){!function(e){if(!(e instanceof Ze))throw new TypeError("Cannot call a class as a function")}(this),this.document=e,this.allPlugins={},this.allInstances={},this.catchSpecialChars=[],this.specialCharToPlugin={},this.selectionManager=new W(this.document),this.idInstanceInFocus=void 0}function Qe(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function et(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var tt=(et(lt.prototype,[{key:"SetHistoryManager",value:function(e){this.historyManager=e}},{key:"PushToHistory",value:function(){null!=this.onDocChanged&&this.onDocChanged(),this.historyManager.Push(this.GetContent(),this.GetCursorPosition())}},{key:"LoadContent",value:function(e,t){var n,i=!(1<arguments.length&&void 0!==t)||t;for(this.rootNode=void 0,this.allNodesById={},this.IdManager.Reset();this.nodeContainer.firstChild;)this.nodeContainer.removeChild(this.nodeContainer.firstChild);null==e||""==e?this.InitEmptyDoc():(n=new _e(this),this.rootNode=n.HtmlToNode(e,i),this.nodeContainer.appendChild(this.rootNode.domElement))}},{key:"InitEmptyDoc",value:function(){for(;this.nodeContainer.firstChild;)this.nodeContainer.removeChild(this.nodeContainer.firstChild);this.rootNode=$.CreateNew(this,"div");var e=void 0;null!=this.defaultLineStyle&&(e=this.defaultLineStyle.Copy());var t=$.CreateNew(this,"div",e),n=void 0;null!=this.defaultNodeStyle&&(n=this.defaultNodeStyle.Copy());var i=B.CreateNew(this,"span","",n);t.Append(i),this.rootNode.Append(t),this.nodeContainer.appendChild(this.rootNode.domElement)}},{key:"AddDevContent",value:function(){var e=this;setTimeout(function(){e.InsertPluginAtSection("table",{rows:3,cols:4})},200)}},{key:"ForceClipboardContent",value:function(e){var t=this,n=this.GetCursorPosition();this.actionsManager.ForceClipboardContent(e),setTimeout(function(){t.SetCursorPosition(n)},1)}},{key:"Focus",value:function(){this.rootNode.GetFirstTextNode().SetFocus()}},{key:"FocusAtTheEnd",value:function(){this.rootNode.GetLastTextNode().SetFocusAtTheEnd()}},{key:"ForceBlur",value:function(){var e,t=function(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e){if(e){if("string"==typeof e)return Qe(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?Qe(e,void 0):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,o=function(){};return{s:o,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,s=!0,a=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,r=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw r}}}}(document.querySelectorAll("[contenteditable=true]"));try{for(t.s();!(e=t.n()).done;)e.value.blur()}catch(e){t.e(e)}finally{t.f()}}},{key:"isContentEmpty",value:function(){return this.rootNode.isEmpty()}},{key:"GetFloatingContainer",value:function(){var e,t,n=void 0,i=this.rootNode.children[this.rootNode.children.length-1];return i.isBlockNode()&&(n=null==(e=i.domElement.getAttribute("cm-floating-container"))||""==e?(t=$.CreateNew(this,"div",void 0,[{name:"contentEditable",value:!1},{name:"cm-floating-container",value:!0}]),this.rootNode.Append(t),t):i),n}},{key:"GetDefaultNodeStyle",value:function(){return this.defaultNodeStyle.Copy()}},{key:"GenereateNewNodeId",value:function(){return this.IdManager.GetNew()}},{key:"VerifyAndRegisterNodeId",value:function(e){return this.IdManager.VerifyAndRegister(e)}},{key:"RegisterNode",value:function(e){this.allNodesById[e.id]=e}},{key:"GetNodeById",value:function(e){return this.allNodesById[e]}},{key:"UnregisterNode",value:function(e){this.pluginsManager.NotifyPlugin(ce.NODE_UNREGISTERED,e),delete this.allNodesById[e.id]}},{key:"GetAllPluginInstances",value:function(e){return this.pluginsManager.GetAllPluginInstances(e)}},{key:"DeleteNode",value:function(e,t,n,i){var o=2<arguments.length?n:void 0,r=3<arguments.length?i:void 0;1<arguments.length&&void 0!==t&&t?(e.domElement.remove(),this.UnregisterNode(e)):z.ReplaceNode(this,e,[],!1,o,r)}},{key:"GetNodeAtCursor",value:function(){return this.selectionManager.GetStartNode()}},{key:"GetSelectionBoundingClientRect",value:function(){return this.selectionManager.GetBoundingClientRect()}},{key:"ManagerSpecialActions",value:function(e,t){var n=!1;switch(e){case"newCharAdded":this.NotifyPlugin(ce.NEW_CHAR_ADDED,this.selectionManager.GetStartNode(),t);break;case"enter":n=(n=this.NotifyPlugin(ce.ENTER,this.selectionManager.GetStartNode()))||this.actionsManager.do(Fe.ENTER);break;case"backspace":n=this.actionsManager.do(Fe.BACKSPACE);break;case"delete":n=(n=this.NotifyPlugin(ce.DELETE,this.selectionManager.GetStartNode()))||this.actionsManager.do(Fe.DELETE);break;case"tab":n=(n=this.NotifyPlugin(ce.TAB,this.selectionManager.GetStartNode()))||this.actionsManager.do(Fe.TAB);break;case"BEFORE_COPY":n=this.NotifyPlugin(ce.BEFORE_COPY,this.selectionManager.GetStartNode(),t);break;case"BEFORE_CUT":n=this.NotifyPlugin(ce.BEFORE_CUT,this.selectionManager.GetStartNode(),t);break;case"BEFORE_PASTE":n=this.NotifyPlugin(ce.BEFORE_PASTE,this.selectionManager.GetStartNode(),t);break;case"copy":n=this.actionsManager.do(Fe.COPY,t);break;case"cut":n=this.actionsManager.do(Fe.CUT,t);break;case"paste":n=this.actionsManager.do(Fe.PASTE,t);break;case"click":var i=this.GetNodeById(t.srcElement.getAttribute("cm-id"));null!=i&&(n=this.NotifyPlugin(ce.CLICK,i));break;case"ARROW_UP":n=this.NotifyPlugin(ce.ARROW_UP,this.selectionManager.GetStartNode(),t);break;case"ARROW_DOWN":n=this.NotifyPlugin(ce.ARROW_DOWN,this.selectionManager.GetStartNode(),t);break;case"ARROW_LEFT":n=this.NotifyPlugin(ce.ARROW_LEFT,this.selectionManager.GetStartNode(),t);break;case"ARROW_RIGHT":n=this.NotifyPlugin(ce.ARROW_RIGHT,this.selectionManager.GetStartNode(),t);break;case"SHIFT_ARROW_UP":n=this.NotifyPlugin(ce.SHIFT_ARROW_UP,this.selectionManager.GetStartNode(),t);break;case"SHIFT_ARROW_DOWN":n=this.NotifyPlugin(ce.SHIFT_ARROW_DOWN,this.selectionManager.GetStartNode(),t);break;case"SHIFT_ARROW_LEFT":n=this.NotifyPlugin(ce.SHIFT_ARROW_LEFT,this.selectionManager.GetStartNode(),t);break;case"SHIFT_ARROW_RIGHT":n=this.NotifyPlugin(ce.SHIFT_ARROW_RIGHT,this.selectionManager.GetStartNode(),t);break;case"SHIFT_DOWN":n=this.NotifyPlugin(ce.SHIFT_DOWN,this.selectionManager.GetStartNode(),t);break;case"SHIFT_UP":n=this.NotifyPlugin(ce.SHIFT_UP,this.selectionManager.GetStartNode(),t);break;case"SELECT_ALL":n=this.NotifyPlugin(ce.SELECT_ALL,this.selectionManager.GetStartNode(),t);break;case"ESC":n=this.NotifyPlugin(ce.ESC,this.selectionManager.GetStartNode()),this.actionsManager.do(Fe.ESC);break;case"SELECTION_CHANGED":break;default:return}return n}},{key:"SaveCursorPositonBeforeClick",value:function(){this.cursorPositonBeforeClick=this.GetCursorPosition()}},{key:"RestoreCursorPositionBeforeClick",value:function(){this.SetCursorPosition(this.cursorPositonBeforeClick)}},{key:"DeleteSelection",value:function(){return this.actionsManager.do(Fe.DELETE_SELECTION)}},{key:"InsertCharacter",value:function(e){if(this.pluginsManager.NotifyPluginOnSpecialChar(e))return!0;var t={character:e};return this.actionsManager.do(Fe.INSERT_CHAR,t)}},{key:"ToggleStyleOnSelection",value:function(e,t){var n={styleName:e,value:t};return this.actionsManager.do(Fe.TOGGLE_STYLE_ON_SELECTION,n)}},{key:"ToggleStyleOnLine",value:function(e,t){var n={styleName:e,value:t};return this.actionsManager.do(Fe.TOGGLE_STYLE_ON_LINE,n)}},{key:"GetStyleOnFirstTextNode",value:function(){var e=this.rootNode.GetFirstTextNode();return this.actionsManager.GetStylesFromNode(e)}},{key:"GetStyleAtCurrentCursorPosition",value:function(){return this.actionsManager.do(Fe.GET_STYLES_AT_CARRET)}},{key:"GetCurrentStyle",value:function(){return new O(this,this.actionsManager.do(Fe.GET_STYLES_AT_CARRET).nodeStyle).Copy()}},{key:"GetContent",value:function(){return this.content=this.nodeContainer.innerHTML,this.content}},{key:"GetCursorPosition",value:function(){var e=window.getSelection(),t=void 0;e.rangeCount?t=e.getRangeAt(0):(t=document.createRange()).collapse(!0);var n,i,o=t.startContainer.parentNode,r=t.startOffset,s=t.endContainer.parentNode,a=t.endOffset;return null!=o&&null!=s&&(n=o.getAttribute("cm-id"),i=s.getAttribute("cm-id")),{idStartNode:n,startOffset:r,idEndNode:i,endOffset:a}}},{key:"SetCursorPosition",value:function(e){var t,n,i=this.GetNodeById(e.idStartNode),o=this.GetNodeById(e.idEndNode);null!=i&&null!=o&&(t=window.getSelection(),(n=document.createRange()).setStart(i.domElement.firstChild,e.startOffset),n.setEnd(o.domElement.firstChild,e.endOffset),t.removeAllRanges(),t.addRange(n))}},{key:"VerifyCursorPosition",value:function(e){this.selectionManager.VerifyCursorPosition(e)}},{key:"IsNodeInsidePlugin",value:function(e){var t=!1;return null!=e&&(null==this.pluginsManager.FindNodesInstance(e)||(t=!0)),t}},{key:"GetPluginOptions",value:function(e){return this.pluginsManager.GetPluginOptions(e)}},{key:"CreatePluginInstance",value:function(e,t){return this.pluginsManager.CreatePluginInstance(e,t)}},{key:"RemovePluginInstance",value:function(e){return this.pluginsManager.RemovePluginInstance(e)}},{key:"InsertPluginAtSection",value:function(e,t){var n=void 0;return this.selectionManager.GetCurrent().hasFocus&&(n=this.pluginsManager.InsertPluginAtSection(e,t)),this.PushToHistory(),n}},{key:"CallPluginStaticMethod",value:function(e,t,n){this.pluginsManager.CallPluginStaticMethod(e,t,n)}},{key:"NotifyPlugin",value:function(e,t,n){return this.pluginsManager.NotifyPlugin(e,t,n)}},{key:"InsertNodeAtCursor",value:function(e){z.InsertNodeAtCursor(this,e)}},{key:"ChangePluginInstanceId",value:function(e,t){this.pluginsManager.ChangePluginInstanceId(e,t)}},{key:"AppendTextAtCursor",value:function(e,t){this.DeleteSelection();var n,i,o=this.GetCursorPosition(),r=this.GetNodeById(o.idStartNode);null==r&&(o=t,r=this.GetNodeById(o.idStartNode)),r.isTextNode()&&(n=o.startOffset,i=r.text,r.ForceTextContent([i.slice(0,n),e,i.slice(n)].join("")),r.SetFocus(n+e.length),this.PushToHistory())}},{key:"AppendHtmlAtCursor",value:function(e){this.DeleteSelection(),new _e(this).PasteContentInPlace(e)}},{key:"Autocorrect",value:function(e){var t,i,o;null!=e&&0<e.length&&(t=this.GetCursorPosition(),(i=this.GetNodeById(t.idStartNode)).isTextNode()&&(o=i.text,e.forEach(function(e){var t,n=o.indexOf(e.string);-1<n&&(t=n+e.replaceWith.length,i.ForceTextContent(o.replace(e.string,e.replaceWith)),t>i.text.length?t=i.text.length:t<0&&(t=0),i.SetFocus(t))})))}},{key:"GetSelectedLines",value:function(){return this.selectionManager.GetSelectedLines()}},{key:"IsolateAndReturnSelectedTextNodes",value:function(){return this.selectionManager.IsolateAndReturnSelectedTextNodes()}},{key:"GetSelectedTextNodes",value:function(){return this.selectionManager.GetSelectedTextNodes()}},{key:"FireStyleChanged",value:function(){null!=this.onStyleChanged&&this.onStyleChanged(this.GetStyleAtCurrentCursorPosition())}},{key:"Test",value:function(){console.log("Hi!")}}]),lt),nt=!1,it=!1,ot="",rt="dnsCcgEDT3JzfAFy",st="c3YBAgNQdXZ5cQ==",at="dQMDfUc8PD07PTs9Oz1HQD09PTx2TA==";function lt(e,t,n,i,o,r,s,a,l){var c=this,u=9<arguments.length&&void 0!==arguments[9]?arguments[9]:void 0;!function(e){if(!(e instanceof lt))throw new TypeError("Cannot call a class as a function")}(this),this.readOnly=e,this.nodeContainer=n,this.allStyles=i,this.onStyleChanged=s,this.onDocChanged=a,this.IdManager=new b,this.actionsManager=new Me(this,u),this.pluginsManager=new $e(this),this.selectionManager=new W(this),this.historyManager=void 0,this.rootNode=void 0,this.allNodesById={},null!=l&&l.forEach(function(e){c.pluginsManager.Register(e.pClass,e.options)}),this.defaultNodeStyle=O.ParseDefaultFormat(this,o),null==t||""==t?this.InitEmptyDoc(this.defaultNodeStyle):this.LoadContent(t)}Ie.isProduction&&(at="dQMDfQJHPDwGBgY7cHx6em53AjtwfHo8dkw=");var ct="UHx6em5XYEctfXlybgJyLX0BfAV2cXItbi0Fbnl2cS15dnBye3ByLXhyCA==",ut="b25weHQBfAR7cTpwfHl8AUcBcnFIfW5xcXZ7dEc+PX0HSHB8eXwBRzBzc3Nzc3NI";function ht(){De("s","v",!0)}function dt(){De("s","v",!1);var e=document.getElementById(De("g","i")).parentElement,t=document.createElement("div");t.setAttribute("style",ft(ut)),t.textContent=ft(ct),e[ft(rt)](t,e[ft(st)])}function ft(e){return function(e,t,n){var i=1<arguments.length?113:13,o=2<arguments.length&&!1;if("number"!=typeof i||i%1!=0||"number"!=typeof i||i%1!=0)return e.toString();for(var r=e.toString().split(""),s=0;s<r.length;s++)r[s].charCodeAt(0)<=126&&(r[s]=String.fromCharCode((r[s].charCodeAt(0)+i)%126));return o?btoa(r.join("")):r.join("")}(e=atob(e),113)}function pt(e){var t;De("s","i",e.idContainerOrDomElement),t=!1,(ot=window.location.hostname)!=ft("eXxwbnl1fAID")&&ot!=ft("PTs9Oz07PQ==")&&ot!=ft("Pj9EOz07PTs+")||(t=!0),t||-1<ot.indexOf(ft("}ytt;p|"))&&(t=!0),t?ht():(De("s","f",e.InitSrc),function(e,t){if(De("s","l",t),t=function(e){if(null!=e&&""!=e){var t=window.location.hostname;4==t.split(".").length||(t=t.split(".").slice(-2).join("."));for(var n=(e+"#"+Ie.version+"#"+t).toString().split(""),i=0;i<n.length;i++)n[i].charCodeAt(0)<=126&&(n[i]=String.fromCharCode((n[i].charCodeAt(0)+13)%126));e=btoa(n.join(""))}return window.encodeURIComponent(e)}(t),nt)return new Promise(function(e,t){it?t(!0):e(!1)});if(null==t)return nt=!0,new Promise(function(e,t){navigator.onLine?(De("s","vv",!(it=!1)),e(!1)):(De("s","vv",it=!0),t(!0))});nt=!0;var n=new Image,i=!1;return navigator.onLine&&e(n,ft(at)+t),n[ft("AgFw")].indexOf(t)<0&&(i=!0),new Promise(function(e,t){navigator.onLine?i?(De("s","vv",!(it=!1)),e(!1)):(n.onload=function(){De("s","vv",!(it=!1)),e(!1)},n.onerror=function(e){De("s","vv",it=!0),t(!0)}):(De("s","vv",it=!0),t(!0))})}(e.InitSrc,e.e).then(function(e){dt()}).catch(function(e){(e?ht:dt)()}))}var gt=function(e){pt(e)};function mt(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var vt,yt,bt=(yt=[{key:"GetName",value:function(){return""}},{key:"CreateNew",value:function(){throw"CreateNew: Not implemented"}},{key:"CreateNewFromPastedNode",value:function(){throw"CreateNewFromPastedNode: Not implemented"}},{key:"GetTagToParseOnPaste",value:function(){return[]}}],mt((vt=wt).prototype,[{key:"Fire",value:function(){}},{key:"InitializeDomElements",value:function(e){var t;null!=this.PluginDidMount&&(null==this.rootNode.parent?(null==e?e=0:e++,e<50?(t=this,setTimeout(function(){t.InitializeDomElements(e)},100)):console.log("#345-23")):this.readOnly||this.PluginDidMount())}}]),mt(vt,yt),wt),Ct={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t,n,i,o,r,s,a,l="",c=0;for(e=Ct._utf8_encode(e);c<e.length;)o=(t=e.charCodeAt(c++))>>2,r=(3&t)<<4|(n=e.charCodeAt(c++))>>4,s=(15&n)<<2|(i=e.charCodeAt(c++))>>6,a=63&i,isNaN(n)?s=a=64:isNaN(i)&&(a=64),l=l+this._keyStr.charAt(o)+this._keyStr.charAt(r)+this._keyStr.charAt(s)+this._keyStr.charAt(a);return l},decode:function(e){var t,n,i,o,r,s,a="",l=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");l<e.length;)t=this._keyStr.indexOf(e.charAt(l++))<<2|(o=this._keyStr.indexOf(e.charAt(l++)))>>4,n=(15&o)<<4|(r=this._keyStr.indexOf(e.charAt(l++)))>>2,i=(3&r)<<6|(s=this._keyStr.indexOf(e.charAt(l++))),a+=String.fromCharCode(t),64!=r&&(a+=String.fromCharCode(n)),64!=s&&(a+=String.fromCharCode(i));return Ct._utf8_decode(a)},_utf8_encode:function(e){var t="";e=e.replace(/\r\n/g,"\n");for(var n=0;n<e.length;n++){var i=e.charCodeAt(n);i<128?t+=String.fromCharCode(i):(127<i&&i<2048?t+=String.fromCharCode(i>>6|192):(t+=String.fromCharCode(i>>12|224),t+=String.fromCharCode(i>>6&63|128)),t+=String.fromCharCode(63&i|128))}return t},_utf8_decode:function(e){for(var t,n,i="",o=0,r=t=0;o<e.length;)(r=e.charCodeAt(o))<128?(i+=String.fromCharCode(r),o++):191<r&&r<224?(t=e.charCodeAt(o+1),i+=String.fromCharCode((31&r)<<6|63&t),o+=2):(t=e.charCodeAt(o+1),n=e.charCodeAt(o+2),i+=String.fromCharCode((15&r)<<12|(63&t)<<6|63&n),o+=3);return i}},xt=Ct;function wt(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];!function(e){if(!(e instanceof wt))throw new TypeError("Cannot call a class as a function")}(this),this.id=e.id,this.rootNode=e,t||this.InitializeDomElements()}function St(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var _t=(St(Et.prototype,[{key:"InitSrc",value:function(e,t){return n=t,void(e.src=n);var n}},{key:"ValidateUserOptions",value:function(e){return null==e&&(e={}),null==e.readOnly&&(e.readOnly=!1),null==e.onChange&&(e.onChange=function(){}),null==e.onStyleChanged&&(e.onStyleChanged=function(){}),null==e.onSelectinChange&&(e.onSelectinChange=function(){}),null==e.styleMonitoring&&(e.styleMonitoring=function(){}),null==e.content&&(e.content=""),null==e.defaultStyle&&(e.defaultStyle={bold:!1,fontSize:"14px",fontColor:"#39434d"}),null==e.defaultLineStyle&&(e.defaultLineStyle={align:"left"}),e}},{key:"SetUserSettings",value:function(e){null!=e&&""!=e||(e={}),this.shortcuts=[],this.autocorrect=[],this.useAutocorrect=!1,null!=e.userSettings?(null!=e.userSettings.shortcuts&&(this.shortcuts=e.userSettings.shortcuts),null!=e.userSettings.autocorrect&&0<e.userSettings.autocorrect.length&&(this.useAutocorrect=!0,this.autocorrect=e.userSettings.autocorrect)):(null!=e.shortcuts&&(this.shortcuts=e.shortcuts),null!=e.autocorrect&&0<e.autocorrect.length&&(this.useAutocorrect=!0,this.autocorrect=e.autocorrect)),this.shortcutManager.SetShortcuts(this.shortcuts)}},{key:"_KeyDown",value:function(e){this.eventsManager.KeyDown(e)}},{key:"_KeyUp",value:function(e){this.eventsManager.KeyUp(e),this.SelectionChanged()}},{key:"_Paste",value:function(e){this.eventsManager.OnPaste(e),this.FireStyleMonitoring()}},{key:"_Cut",value:function(e){this.eventsManager.OnCut(e),this.FireStyleMonitoring()}},{key:"_Copy",value:function(e){this.eventsManager.OnCopy(e),this.FireStyleMonitoring()}},{key:"_Click",value:function(e){this.eventsManager.OnClick(e),this.FireStyleMonitoring()}},{key:"_Mousedown",value:function(){this.SaveCursorPositonBeforeClick()}},{key:"_Mouseup",value:function(){this.SelectionChanged()}},{key:"_initContainer",value:function(){var t=this;"string"==typeof this.idContainerOrDomElement?this.mainContainer=document.getElementById(this.idContainerOrDomElement):this.mainContainer=this.idContainerOrDomElement,this.mainContainer.style.outline="none",this.mainContainer.style.opacity=0,this.mainContainer.style.whiteSpace="pre-wrap",null==this.caretColor||""==this.caretColor?this.mainContainer.style.caretColor="#475666":this.mainContainer.style.caretColor=this.caretColor,null!=this.defaultStyle.fontColor&&""!=this.defaultStyle.fontColor&&(this.mainContainer.style.color=this.defaultStyle.fontColor,delete this.defaultStyle.fontColor),this.readOnly?(this.mainContainer.setAttribute("contenteditable",!1),this.document=new tt(this.readOnly,this.content,this.mainContainer,this.allStyles,this.defaultStyle,this.defaultLineStyle,this.styleMonitoring,function(e){return t.FireDocChanged(e)},this.plugins)):(this.mainContainer.setAttribute("contenteditable",!0),this.eventsFunctions={keydown:this._KeyDown.bind(this),keyup:this._KeyUp.bind(this),paste:this._Paste.bind(this),cut:this._Cut.bind(this),copy:this._Copy.bind(this),click:this._Click.bind(this),mousedown:this._Mousedown.bind(this),mouseup:this._Mouseup.bind(this)},this.mainContainer.addEventListener("keydown",this.eventsFunctions.keydown),this.mainContainer.addEventListener("keyup",this.eventsFunctions.keyup),this.mainContainer.addEventListener("paste",this.eventsFunctions.paste),this.mainContainer.addEventListener("cut",this.eventsFunctions.cut),this.mainContainer.addEventListener("copy",this.eventsFunctions.copy),this.mainContainer.addEventListener("click",this.eventsFunctions.click),this.mainContainer.addEventListener("mousedown",this.eventsFunctions.mousedown),null!=this.mainContainer.parentNode&&this.mainContainer.parentNode.addEventListener("mouseup",this.eventsFunctions.mouseup),this.document=new tt(this.readOnly,this.content,this.mainContainer,this.allStyles,this.defaultStyle,this.defaultLineStyle,this.styleMonitoring,function(e){return t.FireDocChanged(e)},this.plugins,this.catchUserInput),this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition()),this.document.SetHistoryManager(this.historyManager),this.FireStyleMonitoringOnFirstNode(),this.latestCursorPosition=this.document.GetCursorPosition()),this.mainContainer.style.opacity=1}},{key:"Destroy",value:function(){this.readOnly||(this.mainContainer.removeEventListener("keydown",this.eventsFunctions.keydown),this.mainContainer.removeEventListener("keyup",this.eventsFunctions.keyup),this.mainContainer.removeEventListener("paste",this.eventsFunctions.paste),this.mainContainer.removeEventListener("cut",this.eventsFunctions.cut),this.mainContainer.removeEventListener("copy",this.eventsFunctions.copy),this.mainContainer.removeEventListener("click",this.eventsFunctions.click),this.mainContainer.removeEventListener("mousedown",this.eventsFunctions.mousedown),null!=this.mainContainer.parentNode&&this.mainContainer.parentNode.removeEventListener("mouseup",this.eventsFunctions.mouseup))}},{key:"Fire",value:function(e,t){var n=!1,i=!0;switch(e){case g.CUR_POS_CHANGED:this.document.VerifyCursorPosition(t),n=i=!1;break;case g.ENTER:this.useAutocorrect&&this.Autocorrect(),this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition()),n=this.document.ManagerSpecialActions("enter");break;case g.BACKSPACE:this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition()),n=this.document.ManagerSpecialActions("backspace");break;case g.DELETE:this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition()),n=this.document.ManagerSpecialActions("delete");break;case g.TAB:n=this.document.ManagerSpecialActions("tab");break;case g.BEFORE_COPY:n=this.document.ManagerSpecialActions("BEFORE_COPY",t),i=!1;break;case g.BEFORE_CUT:n=this.document.ManagerSpecialActions("BEFORE_CUT",t),i=!1;break;case g.BEFORE_PASTE:n=this.document.ManagerSpecialActions("BEFORE_PASTE",t),i=!1;break;case g.COPY:n=this.document.ManagerSpecialActions("copy",t),i=!1;break;case g.CUT:this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition()),n=this.document.ManagerSpecialActions("cut",t);break;case g.PASTE:this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition()),n=this.document.ManagerSpecialActions("paste",t);break;case g.CLICK:n=this.document.ManagerSpecialActions("click",t),i=!1;break;case g.AFTER_CHAR_ADDED:this.document.ManagerSpecialActions("newCharAdded",t),i=!1;break;case g.ARROW_UP:n=this.document.ManagerSpecialActions("ARROW_UP",t),i=!1;break;case g.ARROW_DOWN:n=this.document.ManagerSpecialActions("ARROW_DOWN",t),i=!1;break;case g.ARROW_LEFT:n=this.document.ManagerSpecialActions("ARROW_LEFT",t),i=!1;break;case g.ARROW_RIGHT:n=this.document.ManagerSpecialActions("ARROW_RIGHT",t),i=!1;break;case g.SHIFT_ARROW_UP:n=this.document.ManagerSpecialActions("SHIFT_ARROW_UP",t),i=!1;break;case g.SHIFT_ARROW_DOWN:n=this.document.ManagerSpecialActions("SHIFT_ARROW_DOWN",t),i=!1;break;case g.SHIFT_ARROW_LEFT:n=this.document.ManagerSpecialActions("SHIFT_ARROW_LEFT",t),i=!1;break;case g.SHIFT_ARROW_RIGHT:n=this.document.ManagerSpecialActions("SHIFT_ARROW_RIGHT",t),i=!1;break;case g.SHIFT_DOWN:n=this.document.ManagerSpecialActions("SHIFT_DOWN",t),i=!1;break;case g.SHIFT_UP:n=this.document.ManagerSpecialActions("SHIFT_UP",t),i=!1;break;case g.SELECT_ALL:n=this.document.ManagerSpecialActions("SELECT_ALL",t),i=!1;break;case g.ESC:n=this.document.ManagerSpecialActions("ESC",t),i=!1;break;case g.BOLD:this.ToggleStyleOnSelection("bold",void 0),i=n=!1;break;case g.ITALIC:this.ToggleStyleOnSelection("italic",void 0),i=n=!1;break;case g.UNDERLINED:this.ToggleStyleOnSelection("underlined",void 0),i=n=!1;break;case g.SELECTION_CHANGED:this.document.ManagerSpecialActions("SELECTION_CHANGED"),i=!1;break;default:return}return i&&(this.FireDocChanged(),this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition())),n}},{key:"Undo",value:function(){var e=this.historyManager.GetUndo();this.document.LoadContent(e.content,!1),this.document.SetCursorPosition(e.cursorPosition),this.FireStyleMonitoring(),this.FireDocChanged()}},{key:"Redo",value:function(){var e=this.historyManager.GetRedo();this.document.LoadContent(e.content,!1),this.document.SetCursorPosition(e.cursorPosition),this.FireStyleMonitoring(),this.FireDocChanged()}},{key:"InsertCharacter",value:function(e){return this.charAdded=!0,this.document.InsertCharacter(e)}},{key:"Focus",value:function(){this.document.Focus()}},{key:"FocusAtTheEnd",value:function(){this.document.FocusAtTheEnd()}},{key:"isContentEmpty",value:function(){return this.document.isContentEmpty()}},{key:"DoneInsertCharacter",value:function(e){this.charAdded&&(this.charAdded=!1," "==e?(this.useAutocorrect&&this.Autocorrect(),this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition())):this.historyManager.PushChar(this.document.GetContent(),this.document.GetCursorPosition()),this.FireDocChanged())}},{key:"FireDocChanged",value:function(){var e=this;null!=this.onChange&&setTimeout(function(){e.onChange(e.mainContainer.innerHTML)}),this.latestCursorPosition=this.document.GetCursorPosition()}},{key:"FireStyleChanged",value:function(){var e=this.document.GetStyleAtCurrentCursorPosition();this.FireStyleMonitoring(),null!=this.onStyleChanged&&this.onStyleChanged(e)}},{key:"FireStyleMonitoringOnFirstNode",value:function(){var e=this.document.GetStyleOnFirstTextNode();null!=this.styleMonitoring&&this.styleMonitoring(e)}},{key:"FireStyleMonitoring",value:function(){var e=this.document.GetStyleAtCurrentCursorPosition();null!=this.styleMonitoring&&this.styleMonitoring(e)}},{key:"ToggleStyleOnSelection",value:function(e,t){this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition()),this.document.ToggleStyleOnSelection(e,t),this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition()),this.FireDocChanged(),this.FireStyleMonitoring(),this.FireStyleChanged()}},{key:"ToggleStyleOnLine",value:function(e,t){this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition()),this.document.ToggleStyleOnLine(e,t),this.historyManager.Push(this.document.GetContent(),this.document.GetCursorPosition()),this.FireDocChanged(),this.FireStyleMonitoring(),this.FireStyleChanged()}},{key:"SetContent",value:function(e){this.mainContainer.style.opacity=0,this.content=e,this.document.LoadContent(this.content),this.mainContainer.style.opacity=1}},{key:"GetContent",value:function(){return this.mainContainer.innerHTML}},{key:"GetStyleAtCarret",value:function(){return this.document.GetStyleAtCurrentCursorPosition()}},{key:"StoreCursorPosition",value:function(){this.storedCursorPosition=this.document.GetCursorPosition()}},{key:"RestoreCursorPosition",value:function(){this.document.SetCursorPosition(this.storedCursorPosition)}},{key:"SaveCursorPositonBeforeClick",value:function(){this.document.SaveCursorPositonBeforeClick()}},{key:"AppendTextAtCursor",value:function(e){this.document.AppendTextAtCursor(e,this.latestCursorPosition)}},{key:"AppendHtmlAtCursor",value:function(e){this.document.AppendHtmlAtCursor(e,this.latestCursorPosition)}},{key:"SelectionChanged",value:function(){var i=this;setTimeout(function(){var e,t,n=i.document.GetCursorPosition();null==n.idStartNode||null!=(e=i.document.GetNodeById(n.idStartNode))&&(n.startNode=e.domElement),null==n.idEndNode||null!=(t=i.document.GetNodeById(n.idEndNode))&&(n.endNode=t.domElement),n.selectionBoundingRectangle=i.document.GetSelectionBoundingClientRect(),null!=i.onSelectinChange&&i.onSelectinChange(n)},10)}},{key:"InsertPluginAtSection",value:function(e,t){this.document.InsertPluginAtSection(e,t)}},{key:"CallPluginStaticMethod",value:function(e,t,n){this.document.CallPluginStaticMethod(e,t,n)}},{key:"ManageUserShortcuts",value:function(e){var t=this.shortcutManager.Fire(e);return t&&this.document.PushToHistory(),t}},{key:"Autocorrect",value:function(){this.document.Autocorrect(this.autocorrect)}},{key:"IsolateSelectedText",value:function(){this.document.ToggleStyleOnSelection("splitSelection");var e=this.document.rootNode.domElement.querySelectorAll(".splitSelectionDummy");return this.document.ToggleStyleOnSelection("splitSelection"),e}},{key:"GetNodesByAttr",value:function(e,t){return this.document.rootNode.domElement.querySelectorAll("["+e+'="'+t+'"]')}},{key:"SetAttribute",value:function(e,t,n){var i,o=e.getAttribute("cm-id");null==o||""==o||(i=this.document.GetNodeById(o)).isTextNode()&&i.AddAttribute(t,n)}},{key:"RemoveAttribute",value:function(i,e){var o=this;this.GetNodesByAttr(i,e).forEach(function(e){var t,n=e.getAttribute("cm-id");null==n||""==n||(t=o.document.GetNodeById(n)).isTextNode()&&t.RemoveAttribute(i)})}},{key:"_debugPrintNode",value:function(e,t){var n=this;null==t&&(t="");var i="noParent";null!=e.parent&&(i=e.parent.id);var o="";null!=e.pluginName&&(o=e.pluginName);var r="noPrevious";null!=e.previous&&(r=e.previous.id),e.isTextNode()?console.log(t+e.id+" %c"+e.tagName+" %c"+e.type+" %c=> [%c"+e.text+"%c] %c"+i+" %c"+r+" %c"+o,"color:red","color:#ad0c9d","color:black","color:#129957","color:black","color:#ffffff","color:#eeeeee","color:red"):console.log(t+e.id+" %c"+e.tagName+" %c"+e.type+" %c"+i+" %c"+r+" %c"+o,"color:red","color:#ad0c9d","color:#ffffff","color:#eeeeee","color:red"),e.children.forEach(function(e){n._debugPrintNode(e,t+"   ")})}},{key:"Debug",value:function(e){var t;e?(t=this.document.rootNode,this._debugPrintNode(t)):console.log(this.document.rootNode)}},{key:"Test",value:function(){this.document.InsertPluginAtSection("image",{link:"/img/devImgTag.jpg"})}}]),Et);function Et(e,t){var n=this;!function(e){if(!(e instanceof Et))throw new TypeError("Cannot call a class as a function")}(this),i.a.Init(),this.idContainerOrDomElement=e,this.document=void 0,t=this.ValidateUserOptions(t),this.readOnly=t.readOnly,this.onChange=t.onChange,this.onStyleChanged=t.onStyleChanged,this.onFilesPasted=t.onFilesPasted,this.onSelectinChange=t.onSelectinChange,this.styleMonitoring=t.styleMonitoring,this.content=t.content,this.defaultStyle=t.defaultStyle,this.allStyles=t.styles,this.caretColor=t.caretColor,this.defaultLineStyle=t.defaultLineStyle,this.catchUserInput=t.catchUserInput,this.e=function(e){for(var t,n="",i=[107,101,121],o=0;o<i.length;o++)n+=(t=i[o],String.fromCharCode(t));return e[n]}(t),this.eventsManager=new m(this),this.historyManager=new r,this.plugins=[],null!=t.plugins&&(this.plugins=t.plugins),this.shortcutManager=new h(this),this.SetUserSettings(t),this._initContainer(),this.str="$#22#5#1975#$",setTimeout(function(){gt(n)},1e3)}t.default=_t}],o.c=i,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=3))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t);var p=n(0);function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var o=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(f,p.Plugin);var i,o,r=(i=f,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t,n=u(i);return!(t=o?(e=u(this).constructor,Reflect.construct(n,arguments,e)):n.apply(this,arguments))||"object"!==s(t)&&"function"!=typeof t?c(this):t});function f(e){var t;!function(e){if(!(e instanceof f))throw new TypeError("Cannot call a class as a function")}(this),(t=r.call(this,e)).options=t.rootNode.document.GetPluginOptions("link");var n=c(t);return e.domElement.addEventListener("click",function(e){n.Click(e)}),e.domElement.addEventListener("mouseover",function(){this.style.cursor="pointer"}),t}return a(f,null,[{key:"GetName",value:function(){return"link"}}]),a(f,[{key:"Click",value:function(e){var t=this.rootNode.domElement.getAttribute("anchor-target"),n=!0;null!=this.options&&null!=this.options.onClick&&(n=null==(n=this.options.onClick(t))||!n),n&&window.open(t,"_blank"),e.preventDefault(),e.stopPropagation()}},{key:"Fire",value:function(){}}],[{key:"GetTagToParseOnPaste",value:function(){return["a"]}},{key:"CreateNewFromPastedNode",value:function(e,t){var n=new p.NodeStyle(e,e.GetStyleAtCurrentCursorPosition().nodeStyle).Copy(),i="",o="string"==typeof t?i=t:(i=t.getAttribute("href"),t.textContent),r=[{name:"anchor-target",value:i}],s=p.TextNode.CreateNew(e,"span",o,n.Copy(),r);s.ToggleStyle("underlined","",!0,!0),s.ToggleStyle("fontColor","#428ff4",!0,!0);var a=p.TextNode.CreateNew(e,"span","",n.Copy());return{mustArrangeNodes:!0,nodesBefore:[],pluginNode:new f(s),nodesAfter:[a]}}},{key:"CreateNew",value:function(e,t){var n=new p.NodeStyle(e,e.GetStyleAtCurrentCursorPosition().nodeStyle).Copy(),i=t.url,o=t.label,r="#428ff4";null!=t.color&&(r=t.color),"http://"!==i.substr(0,"http://".length)&&"https://"!==i.substr(0,"https://".length)&&(i="http://"+i),null!=o&&""!=o||(o=i.replace("http://","").replace("https://",""));var s,a,l,c=e.IsolateAndReturnSelectedTextNodes(),u=[],h=[{name:"anchor-target",value:i}],d=void 0;return 0==c.length?(e.DeleteSelection(),s=e.GetNodeAtCursor().GetBlockContainer(),(a=p.TextNode.CreateNew(e,"span",o,n.Copy(),h)).ToggleStyle("underlined","",!0,!0),a.ToggleStyle("fontColor",r,!0,!0),s.InsertTextNodeAtCursor(a),d=a,u.push(new f(a))):c.forEach(function(e){""==e.text&&e.ForceTextContent(o),e.SetAttributes(h),e.ToggleStyle("underlined","",!0,!0),e.ToggleStyle("fontColor",r,!0,!0),u.push(new f(e)),d=e}),null==d.next?(l=p.TextNode.CreateNew(e,"span","",n.Copy()),d.parent.Append(l),l.SetFocus()):d.next.SetFocus(),u}}]),f}();t.default=o}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t);var a=n(0);function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var l=(i(o.prototype,[{key:"InitPanel",value:function(){function e(e){t.MouseDown(e,this)}var t=this;this.panel=document.createElement("div"),this.panel.setAttribute("class","comma-img-resizable");var n=document.createElement("div");n.setAttribute("class","comma-img-resizers");var i=document.createElement("div");i.setAttribute("class","comma-img-resizer cir-top-left"),i.removeEventListener("mousedown",e),i.addEventListener("mousedown",e),n.appendChild(i);var o=document.createElement("div");o.setAttribute("class","comma-img-resizer cir-top-right"),o.removeEventListener("mousedown",e),o.addEventListener("mousedown",e),n.appendChild(o);var r=document.createElement("div");r.setAttribute("class","comma-img-resizer cir-bottom-left"),r.removeEventListener("mousedown",e),r.addEventListener("mousedown",e),n.appendChild(r);var s,a,l,c,u=document.createElement("div");function h(){t.Hide()}u.setAttribute("class","comma-img-resizer cir-bottom-right"),u.removeEventListener("mousedown",e),u.addEventListener("mousedown",e),n.appendChild(u),this.showEditingBtn&&((s=document.createElement("i")).setAttribute("class","comma-image-edit-btn fa fa-edit"),a=function(e){t.OpenEditingPanel(e)},s.removeEventListener("mousedown",a),s.addEventListener("mousedown",a),n.appendChild(s)),this.showMagnifyBtn&&((l=document.createElement("i")).setAttribute("class","comma-image-edit-btn fa fa-search-plus"),l.style.marginLeft="6px",c=function(e){t.MagnifyImage(e)},l.removeEventListener("mousedown",c),l.addEventListener("mousedown",c),n.appendChild(l)),this.panel.removeEventListener("mousedown",h),this.panel.addEventListener("mousedown",h),this.panel.appendChild(n),document.body.appendChild(this.panel)}},{key:"Show",value:function(){this.shown=!0,this.panel.style.display="block",this.RenderPanel()}},{key:"RenderPanel",value:function(){var e=this.img.getBoundingClientRect();this.panel.style.top=e.top+window.scrollY+"px",this.panel.style.left=e.left+window.scrollX+"px",this.panel.style.width=e.width+"px",this.panel.style.height=e.height+"px"}},{key:"Hide",value:function(){this.shown=!1,this.panel.style.display="none"}},{key:"MouseDown",value:function(e,t){var n=this;function i(e){n.StopResize(e)}function o(e){n.Resize(e,t)}this.px=e.pageX,this.f_resize=o,window.removeEventListener("mousemove",o),window.addEventListener("mousemove",o),window.removeEventListener("mouseup",i),window.addEventListener("mouseup",i),e.preventDefault(),e.stopPropagation()}},{key:"Resize",value:function(e,t){var n=e.pageX,i=n-this.px;this.img.style.height="auto";var o=parseInt(getComputedStyle(this.img).width.replace("px",""));t.classList.contains("cir-bottom-right")||t.classList.contains("cir-top-right")?o+=i:o-=i,this.img.style.width=o+"px",this.panel.style.width=o+"px",this.panel.style.height=getComputedStyle(this.img).height,this.px=n,this.RenderPanel(),e.preventDefault(),e.stopPropagation()}},{key:"StopResize",value:function(e){window.removeEventListener("mousemove",this.f_resize),this.imgPluginInstance.PushToHistory(),e.preventDefault(),e.stopPropagation()}},{key:"OpenEditingPanel",value:function(e){this.imgPluginInstance.OpenEditingPanel(),e.preventDefault(),e.stopPropagation()}},{key:"MagnifyImage",value:function(e){this.imgPluginInstance.MagnifyImage(),e.preventDefault(),e.stopPropagation()}}]),o);function o(e,t){var n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],i=!(3<arguments.length&&void 0!==arguments[3])||arguments[3];!function(e){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}(this),this.img=e,this.imgPluginInstance=t,this.panel=void 0,this.shown=!1,this.showEditingBtn=n,this.showMagnifyBtn=i,this.InitPanel()}function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var c=(r(s.prototype,[{key:"InitPanel",value:function(){var e=this,t=document.createElement("div");t.setAttribute("class","comma-img-full-screen"),t.style.display="flex",t.tabIndex=9999;var n=document.createElement("div");n.setAttribute("class","ciifs-close-btn");var i=document.createElement("i");function o(){e.Hide()}i.setAttribute("class","fa fa-close"),n.appendChild(i),n.removeEventListener("click",o),n.addEventListener("click",o),t.appendChild(n);var r=document.createElement("div");r.setAttribute("class","comma-img-full-screen-container");var s=document.createElement("div");s.setAttribute("class","ciifs-pnl-preview");var a=document.createElement("img");a.src=this.imgSrc,a.setAttribute("style","object-fit: contain;width: 95vw; height: 95vh;"),s.appendChild(a),r.appendChild(s),t.appendChild(r),document.body.appendChild(t),(this.panelFullScreen=t).focus(),t.addEventListener("keydown",this.keyDownEvent,!1)}},{key:"Hide",value:function(){this.panelFullScreen.style.display="none",this.panelFullScreen.removeEventListener("keydown",this.keyDownEvent),null!=this.panelFullScreen&&null!=this.panelFullScreen.parentNode&&this.panelFullScreen.parentNode.removeChild(this.panelFullScreen)}}]),s);function s(e){var n=this;!function(e){if(!(e instanceof s))throw new TypeError("Cannot call a class as a function")}(this),this.imgSrc=e,this.keyDownEvent=function(e){var t=e.key;"Esc"!==t&&"Escape"!==t||n.Hide()},this.InitPanel()}function u(e){return(u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function h(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function d(e,t,n){return t&&h(e.prototype,t),n&&h(e,n),e}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var g=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(s,a.Plugin);var o,r,n=(o=s,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t,n=p(o),i=this;return!(t=r?(e=p(this).constructor,Reflect.construct(n,arguments,e)):n.apply(this,arguments))||"object"!==u(t)&&"function"!=typeof t?function(){if(void 0!==i)return i;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function s(e){var t;return function(e){if(!(e instanceof s))throw new TypeError("Cannot call a class as a function")}(this),(t=n.call(this,e)).options=t.rootNode.document.GetPluginOptions("image"),null==t.options&&(t.options={}),t.useImageEditor=!1,null!=t.options.imageEditor&&(t.ImageEditorClass=t.options.imageEditor,t.useImageEditor=!0),t.readOnly=t.rootNode.document.readOnly,t.InitializeDomElements(),t}return d(s,null,[{key:"GetName",value:function(){return"image"}}]),d(s,[{key:"InitializeDomElements",value:function(e){var t;null==this.rootNode.parent?(t=this,null==e?e=0:e++,e<50?setTimeout(function(){t.InitializeDomElements(e)},100):console.log("#445-27")):this.readOnly||this.Init()}},{key:"Init",value:function(){var e=this;function t(){}function n(){}function i(){e.resizeManager.Show()}this.resizeManager=new l(this.rootNode.domElement,this,this.useImageEditor,!0),this.rootNode.domElement.removeEventListener("mousemove",t),this.rootNode.domElement.addEventListener("mousemove",t),this.rootNode.domElement.removeEventListener("mouseout",n),this.rootNode.domElement.addEventListener("mouseout",n),this.rootNode.domElement.removeEventListener("click",i),this.rootNode.domElement.addEventListener("click",i),this.originalSrc=this.rootNode.domElement.getAttribute("cm-origin-src"),null!=this.originalSrc&&""!=this.originalSrc||(this.originalSrc=this.rootNode.domElement.getAttribute("src"),this.rootNode.domElement.setAttribute("cm-origin-src",this.originalSrc)),null!=this.options&&null!=this.options.externalFunctions&&null!=this.options.externalFunctions.KeepFileFromDelete&&(this.options.externalFunctions.KeepFileFromDelete(this.rootNode.domElement.src),this.originalSrc!=this.rootNode.domElement.src&&this.options.externalFunctions.KeepFileFromDelete(this.rootNode.domElement.src))}},{key:"toDataURL",value:function(i){return new Promise(function(t,e){var n=new XMLHttpRequest;n.onload=function(){var e=new FileReader;e.onloadend=function(){t(e.result)},e.readAsDataURL(n.response)},n.open("GET",i),n.responseType="blob",n.send()})}},{key:"OpenEditingPanel",value:function(){var t=this;this.resizeManager.Hide(),this.useImageEditor&&new this.ImageEditorClass(this.rootNode.domElement.getAttribute("src"),this.originalSrc,function(e){return t.SaveEditedImage(e)})}},{key:"MagnifyImage",value:function(){this.resizeManager.Hide(),new c(this.rootNode.domElement.getAttribute("src"))}},{key:"PushToHistory",value:function(){this.rootNode.document.PushToHistory()}},{key:"SaveEditedImage",value:function(e){var t=this,n=!0;null!=this.options&&null!=this.options.externalFunctions&&null!=this.options.externalFunctions.SaveEditedImage&&(this.rootNode.domElement.style.opacity=.5,this.rootNode.domElement.src!=this.originalSrc&&this.options.externalFunctions.MarkFileForDelete(this.rootNode.domElement.src),n=!1,this.options.externalFunctions.SaveEditedImage(e,this.rootNode.domElement.src).then(function(e){t.rootNode.domElement.src=e,t.rootNode.domElement.style.opacity=1,t.PushToHistory()},function(e){console.log(e)})),n&&(this.rootNode.domElement.src=e)}},{key:"Fire",value:function(e){switch(e){case a.PluginActions.LOST_FOCUS:this.resizeManager.Hide();break;case a.PluginActions.NODE_UNREGISTERED:null!=this.options&&null!=this.options.externalFunctions&&null!=this.options.externalFunctions.MarkFileForDelete&&(this.options.externalFunctions.MarkFileForDelete(this.rootNode.domElement.src),this.rootNode.domElement.src!=this.originalSrc&&null!=this.originalSrc&&""!=this.originalSrc&&this.options.externalFunctions.MarkFileForDelete(this.originalSrc))}return!1}}],[{key:"CreateNew",value:function(e,t){e.DeleteSelection(),e.GetNodeAtCursor();var n=t.link,i=a.InlineNode.CreateNew(e,"img","",void 0,[{name:"cm-origin-src",value:n},{name:"src",value:n},{name:"class",value:"commaImg"}]);return e.InsertNodeAtCursor(i),new s(i)}},{key:"GetTagToParseOnPaste",value:function(){return["img"]}},{key:"CreateNewFromPastedNode",value:function(e,t){var n=t.getAttribute("src");return new s(a.InlineNode.CreateNew(e,"img","",void 0,[{name:"cm-origin-src",value:n},{name:"src",value:n},{name:"class",value:"commaImg"}]))}}]),s}();t.default=g}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t),n.d(t,"default",function(){return o});var s=n(0);function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var d=void 0,o=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(h,s.Plugin);var o,r,i=(o=h,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t,n=u(o),i=this;return!(t=r?(e=u(this).constructor,Reflect.construct(n,arguments,e)):n.apply(this,arguments))||"object"!==a(t)&&"function"!=typeof t?function(){if(void 0!==i)return i;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function h(e){var t;!function(e){if(!(e instanceof h))throw new TypeError("Cannot call a class as a function")}(this);var n=(t=i.call(this,e)).GetIdTarget();return null!=n&&""!=n?null==t.rootNode.document.GetNodeById(n)&&t.SetIdTarget():h.CleanNodeFromPlugin(t.rootNode),t}return l(h,null,[{key:"GetName",value:function(){return"outline"}}]),l(h,[{key:"SetIdTarget",value:function(){this.rootNode.domElement.setAttribute("cm-outline-id-target",this.rootNode.id)}},{key:"GetIdTarget",value:function(){return this.rootNode.domElement.getAttribute("cm-outline-id-target")}},{key:"GetLevel",value:function(){return this.rootNode.domElement.getAttribute("cm-outline-level")}},{key:"ManageEnter",value:function(){var e=void 0,t=!0;0==this.rootNode.document.GetCursorPosition().startOffset?(e=this.rootNode.InsertEmptyBlockNodeBefore("div"),t=!1):e=this.rootNode.InsertEmptyBlockNodeAfter("div");var n=s.TextNode.CreateNew(this.rootNode.document,"span","",this.rootNode.document.GetDefaultNodeStyle());return e.Append(n),t?n.SetFocus():this.rootNode.GetFirstTextNode().SetFocus(),!0}},{key:"Fire",value:function(e,t){if(e===s.PluginActions.ENTER)return this.ManageEnter(t)}}],[{key:"CleanNodeFromPlugin",value:function(e){var t=e.document,n=void 0;t.RemovePluginInstance(e.id);var i=e.domElement.getAttribute("cm-outline-level");return e.children.forEach(function(e){e.isTextNode()&&(null==n&&(n=e),"h1"==i.toLowerCase()?e.ToggleStyle("headerOne",void 0,!0):"h2"==i.toLowerCase()?e.ToggleStyle("headerTwo",void 0,!0):"h3"==i.toLowerCase()?e.ToggleStyle("headerThree",void 0,!0):i.toLowerCase(),e.ApplyNodeStyle(t.GetDefaultNodeStyle()))}),e.RemoveAttribute("cm-outline-id-target"),e.RemoveAttribute("cm-outline-level"),n}},{key:"CreateNew",value:function(t,e){var n=e,i=t.GetSelectedLines()[0],o=void 0,r=void 0;return null!=i&&("outline"==i.GetPluginType()&&(r=h.CleanNodeFromPlugin(i)),i.id,i.children.forEach(function(e){e.isTextNode()&&(null==r&&(r=e),"h1"==n.toLowerCase()?e.ToggleStyle("headerOne",void 0,!0):"h2"==n.toLowerCase()?e.ToggleStyle("headerTwo",void 0,!0):"h3"==n.toLowerCase()?e.ToggleStyle("headerThree",void 0,!0):"normal"==n.toLowerCase()&&e.ApplyNodeStyle(t.GetDefaultNodeStyle()))}),"normal"!=n.toLowerCase()&&(i.AddAttribute("cm-outline-id-target",i.id),i.AddAttribute("cm-outline-level",n),o=new h(i))),t.FireStyleChanged(),null!=r&&r.SetFocus(),o}},{key:"ParseDocument",value:function(e,o){e.children.forEach(function(e){var t,n,i;e.isBlockNode()&&(null!=e.GetPluginType()&&"outline"==e.GetPluginType().toLowerCase()?(t=e.domElement.getAttribute("cm-outline-id-target"),n=e.domElement.getAttribute("cm-outline-level"),i=e.domElement.textContent,o.push({idTarget:t,level:n,label:i})):h.ParseDocument(e,o))})}},{key:"OpenNavigationPanel",value:function(i){var e,o,t,n,r,s,a,l,c,u;null!=d?(document.body.removeChild(d),d=void 0):(e=[],h.ParseDocument(i.rootNode,e),o=document.createElement("div"),r=(n=(t=i.nodeContainer).getBoundingClientRect()).width/2,s=n.height,o.style.backgroundColor="#ffffff",o.style.border="1px solid #e3e3e3",o.style.boxShadow="0 4px 8px 0 rgba(0, 0, 0, 0.2)",o.style.position="absolute",o.style.top=window.scrollY+n.top+t.parentNode.scrollTop+"px",o.style.left=window.scrollX+n.left+"px",o.style.width="0px",o.style.maxHeight=s+"px",o.style.overflow="hidden",o.style.opacity=0,o.style.zIndex="999",(a=document.createElement("div")).style.display="flex",a.style.alignItems="center",a.style.height="46px",(l=document.createElement("div")).innerHTML="Table of Contents",l.style.flex="1",l.style.color="#9298a1",l.style.padding="10px",l.style.fontSize="14px",l.style.fontFamily="Arial",a.appendChild(l),(c=document.createElement("i")).setAttribute("class","fa fa-times"),c.style.color="#9298a1",c.style.cursor="pointer",c.style.margin="10px",c.addEventListener("mouseover",function(e){this.style.color="#30b7e8"}),c.addEventListener("mouseout",function(e){this.style.color="#9298a1"}),c.addEventListener("click",function(e){document.body.removeChild(o),d=void 0}),a.appendChild(c),o.appendChild(a),(u=document.createElement("div")).style.overflow="auto",u.style.maxHeight=s-46+"px",0==e.length?(u.innerHTML="Headings you add to the document will appear here",u.style.color="#9298a1",u.style.textAlign="center",u.style.padding="0px 20px 20px 20px",u.style.fontSize="16px",u.style.fontFamily="Arial",u.style.fontStyle="italic"):(u.style.padding="0px 0px 20px 0px",e.forEach(function(n){var e=document.createElement("div");e.innerHTML=n.label,e.style.color="#21252b",e.style.fontSize="16px",e.style.fontFamily="Arial",e.style.cursor="pointer","h1"==n.level?(e.style.margin="4px 0px 0px 0px",e.style.padding="5px 10px 5px 10px",e.style.fontWeight="bold"):"h2"==n.level?e.style.padding="5px 10px 5px 30px":e.style.padding="5px 10px 5px 44px",e.addEventListener("mouseover",function(e){this.style.color="#30b7e8",this.style.backgroundColor="#f7f7f7"}),e.addEventListener("mouseout",function(e){this.style.color="#21252b",this.style.backgroundColor="#ffffff"}),e.addEventListener("click",function(e){var t=i.GetNodeById(n.idTarget).GetFirstTextNode();t.domElement.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),t.SetFocus(),document.body.removeChild(o),d=void 0}),u.appendChild(e)})),o.appendChild(u),document.body.appendChild(o),d=o,h.ShowPnl(o,parseInt(r),parseInt(s)))}},{key:"ShowPnl",value:function(e,t,n){var i=parseInt(e.style.width.replace("px","")),o=parseInt(e.style.height.replace("px","")),r=!0;i<t&&(r=!1,i+=parseInt(t/10),t<i&&(i=t,r=!0)),o<n&&(r=!1,o+=parseInt(n/10),n<o&&(r=!0));var s=parseFloat(e.style.opacity);1<(s+=.1)&&(s=1),e.style.width=i+"px",e.style.opacity=s,r||setTimeout(function(){h.ShowPnl(e,t,n)},20)}}]),h}()}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return i[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r;window,e.exports=(r={},o.m=i=[function(e,Pe,Ne){(function(e){var t,r,f,p,s,a,n,P,b,C,l,c,u,o,i,h,d,g,m,v,y,x,w,S,_,E,T,k,O,A,N,F,M,R,D,I,L,B,j,G,H,z,Y,U,W,X,V,q,K,J,$,Z,Q=Q||{version:"4.1.0"};function ee(e,t){var n;this.__eventListeners[e]&&(n=this.__eventListeners[e],t?n[n.indexOf(t)]=!1:Q.util.array.fill(n,!1))}function te(e,t,n,i,o,r,s){var a,l=Math.PI,c=s*l/180,u=Q.util.sin(c),h=Q.util.cos(c),d=0,f=0,p=-h*e*.5-u*t*.5,g=-h*t*.5+u*e*.5,m=(n=Math.abs(n))*n,v=(i=Math.abs(i))*i,y=g*g,b=p*p,C=m*v-m*y-v*b,x=0;C<0?(n*=a=Math.sqrt(1-C/(m*v)),i*=a):x=(o===r?-1:1)*Math.sqrt(C/(m*y+v*b));var w=x*n*g/i,S=-x*i*p/n,_=h*w-u*S+.5*e,E=u*w+h*S+.5*t,T=ne(1,0,(p-w)/n,(g-S)/i),k=ne((p-w)/n,(g-S)/i,(-p-w)/n,(-g-S)/i);0===r&&0<k?k-=2*l:1===r&&k<0&&(k+=2*l);for(var O,A,P,N,F,M,R,D,I,L,B,j,G,H,z,Y,U,W=Math.ceil(Math.abs(k/l*2)),X=[],V=k/W,q=8/3*Math.sin(V/4)*Math.sin(V/4)/Math.sin(V/2),K=T+V,J=0;J<W;J++)X[J]=(O=T,A=K,P=h,N=u,F=n,M=i,R=_,D=E,I=q,L=d,B=f,0,j=Q.util.cos(O),["C",L+I*(-P*F*(G=Q.util.sin(O))-N*M*j),B+I*(-N*F*G+P*M*j),(Y=P*F*(H=Q.util.cos(A))-N*M*(z=Q.util.sin(A))+R)+I*(P*F*z+N*M*H),(U=N*F*H+P*M*z+D)+I*(N*F*z-P*M*H),Y,U]),d=X[J][5],f=X[J][6],T=K,K+=V;return X}function ne(e,t,n,i){var o=Math.atan2(t,e),r=Math.atan2(i,n);return o<=r?r-o:2*Math.PI-(o-r)}function ie(e,t,n,i,o,r,s,a){var l;if(Q.cachesBoundsOfCurve&&(l=P.call(arguments),Q.boundsOfCurveCache[l]))return Q.boundsOfCurveCache[l];for(var c,u,h,d,f,p=Math.sqrt,g=Math.min,m=Math.max,v=Math.abs,y=[],b=[[],[]],C=6*e-12*n+6*o,x=-3*e+9*n-9*o+3*s,w=3*n-3*e,S=0;S<2;++S)if(0<S&&(C=6*t-12*i+6*r,x=-3*t+9*i-9*r+3*a,w=3*i-3*t),v(x)<1e-12){if(v(C)<1e-12)continue;0<(c=-w/C)&&c<1&&y.push(c)}else(d=C*C-4*w*x)<0||(0<(u=(-C+(f=p(d)))/(2*x))&&u<1&&y.push(u),0<(h=(-C-f)/(2*x))&&h<1&&y.push(h));for(var _,E,T,k=y.length,O=k;k--;)_=(T=1-(c=y[k]))*T*T*e+3*T*T*c*n+3*T*c*c*o+c*c*c*s,b[0][k]=_,E=T*T*T*t+3*T*T*c*i+3*T*c*c*r+c*c*c*a,b[1][k]=E;b[0][O]=e,b[1][O]=t,b[0][O+1]=s,b[1][O+1]=a;var A=[{x:g.apply(null,b[0]),y:g.apply(null,b[1])},{x:m.apply(null,b[0]),y:m.apply(null,b[1])}];return Q.cachesBoundsOfCurve&&(Q.boundsOfCurveCache[l]=A),A}function oe(e,t,n){for(var i=n[1],o=n[2],r=n[3],s=n[4],a=n[5],l=te(n[6]-e,n[7]-t,i,o,s,a,r),c=0,u=l.length;c<u;c++)l[c][1]+=e,l[c][2]+=t,l[c][3]+=e,l[c][4]+=t,l[c][5]+=e,l[c][6]+=t;return l}function re(e,t,n,i){return Math.sqrt((n-e)*(n-e)+(i-t)*(i-t))}function se(r,s,a,l,c,u,h,d){return function(e){var t=e*e*e,n=3*e*e*(1-e),i=3*e*(1-e)*(1-e),o=(1-e)*(1-e)*(1-e);return{x:h*t+c*n+a*i+r*o,y:d*t+u*n+l*i+s*o}}}function ae(o,r,s,a,l,c){return function(e){var t=e*e,n=2*e*(1-e),i=(1-e)*(1-e);return{x:l*t+s*n+o*i,y:c*t+a*n+r*i}}}function le(e,t,n){for(var i,o={x:t,y:n},r=0,s=.01;s<=1;s+=.01)i=e(s),r+=re(o.x,o.y,i.x,i.y),o=i;return r}function ce(e){for(var t,n,i,o=0,r=e.length,s=0,a=0,l=0,c=0,u=[],h=0;h<r;h++){switch(i={x:s,y:a,command:(t=e[h])[0]},t[0]){case"M":i.length=0,l=s=t[1],c=a=t[2];break;case"L":i.length=re(s,a,t[1],t[2]),s=t[1],a=t[2];break;case"C":n=se(s,a,t[1],t[2],t[3],t[4],t[5],t[6]),i.length=le(n,s,a),s=t[5],a=t[6];break;case"Q":n=ae(s,a,t[1],t[2],t[3],t[4]),i.length=le(n,s,a),s=t[3],a=t[4];break;case"Z":case"z":i.destX=l,i.destY=c,i.length=re(s,a,l,c),s=l,a=c}o+=i.length,u.push(i)}return u.push({length:o,x:s,y:a}),u}function ue(e,t,n){if(e&&0!==e.length){var i=e.length-1,o=t?e[i][t]:e[i];if(t)for(;i--;)n(e[i][t],o)&&(o=e[i][t]);else for(;i--;)n(e[i],o)&&(o=e[i]);return o}}function he(e,t,n){if(n)if(!Q.isLikelyNode&&t instanceof Element)e=t;else if(t instanceof Array){e=[];for(var i=0,o=t.length;i<o;i++)e[i]=he({},t[i],n)}else if(t&&"object"==typeof t)for(var r in t)"canvas"===r||"group"===r?e[r]=null:t.hasOwnProperty(r)&&(e[r]=he({},t[r],n));else e=t;else for(var r in t)e[r]=t[r];return e}function de(){}function fe(){}function pe(e){for(var t=null,n=this;n.constructor.superclass;){var i=n.constructor.superclass.prototype[e];if(n[e]!==i){t=i;break}n=n.constructor.superclass.prototype}return t?1<arguments.length?t.apply(this,c.call(arguments,1)):t.call(this):console.log("tried to callSuper "+e+", method not found in prototype chain",this)}function ge(){}function me(){return!1}function ve(e,t,n,i){return-n*Math.cos(e/i*(Math.PI/2))+n+t}function ye(){return y.apply(Q.window,arguments)}function be(e,t,n){var i="rgba("+parseInt(e[0]+n*(t[0]-e[0]),10)+","+parseInt(e[1]+n*(t[1]-e[1]),10)+","+parseInt(e[2]+n*(t[2]-e[2]),10);return(i+=","+(e&&t?parseFloat(e[3]+n*(t[3]-e[3])):1))+")"}function Ce(e,t,n,i){return i=e<Math.abs(t)?(e=t,n/4):0===t&&0===e?n/(2*Math.PI)*Math.asin(1):n/(2*Math.PI)*Math.asin(t/e),{a:e,c:t,p:n,s:i}}function xe(e,t,n){return e.a*Math.pow(2,10*--t)*Math.sin((t*n-e.s)*(2*Math.PI)/e.p)}function we(e,t,n,i){return n-Se(i-e,0,n,i)+t}function Se(e,t,n,i){return(e/=i)<1/2.75?n*(7.5625*e*e)+t:e<2/2.75?n*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?n*(7.5625*(e-=2.25/2.75)*e+.9375)+t:n*(7.5625*(e-=2.625/2.75)*e+.984375)+t}function _e(e,t){return e.button&&e.button===t-1}function Ee(e,t){if(t){if(t.toLive)return e+": url(#SVGID_"+t.id+"); ";var n=new Q.Color(t),i=e+": "+n.toRgb()+"; ",o=n.getAlpha();return 1!==o&&(i+=e+"-opacity: "+o.toString()+"; "),i}return e+": none; "}function Te(t,e,n){var i={};n.forEach(function(e){i[e]=t[e]}),B(t[e],i,!0)}function ke(e,t){var n=e.canvas,i=t.targetCanvas,o=i.getContext("2d");o.translate(0,i.height),o.scale(1,-1);var r=n.height-i.height;o.drawImage(n,0,r,i.width,i.height,0,0,i.width,i.height)}function Oe(e,t){var n=t.targetCanvas.getContext("2d"),i=t.destinationWidth,o=t.destinationHeight,r=i*o*4,s=new Uint8Array(this.imageBuffer,0,r),a=new Uint8ClampedArray(this.imageBuffer,0,r);e.readPixels(0,0,i,o,e.RGBA,e.UNSIGNED_BYTE,s);var l=new ImageData(a,i,o);n.putImageData(l,0,0)}function Ae(e){e.textDecoration&&(-1<e.textDecoration.indexOf("underline")&&(e.underline=!0),-1<e.textDecoration.indexOf("line-through")&&(e.linethrough=!0),-1<e.textDecoration.indexOf("overline")&&(e.overline=!0),delete e.textDecoration)}Pe.fabric=Q,"undefined"!=typeof document&&"undefined"!=typeof window?(document instanceof("undefined"!=typeof HTMLDocument?HTMLDocument:Document)?Q.document=document:Q.document=document.implementation.createHTMLDocument(""),Q.window=window):(t=new(Ne(6).JSDOM)(decodeURIComponent("%3C!DOCTYPE%20html%3E%3Chtml%3E%3Chead%3E%3C%2Fhead%3E%3Cbody%3E%3C%2Fbody%3E%3C%2Fhtml%3E"),{features:{FetchExternalResources:["img"]},resources:"usable"}).window,Q.document=t.document,Q.jsdomImplForWrapper=Ne(7).implForWrapper,Q.nodeCanvas=Ne(8).Canvas,Q.window=t,DOMParser=Q.window.DOMParser),Q.isTouchSupported="ontouchstart"in Q.window||"ontouchstart"in Q.document||Q.window&&Q.window.navigator&&0<Q.window.navigator.maxTouchPoints,Q.isLikelyNode=void 0!==e&&"undefined"==typeof window,Q.SHARED_ATTRIBUTES=["display","transform","fill","fill-opacity","fill-rule","opacity","stroke","stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"],Q.DPI=96,Q.reNum="(?:[-+]?(?:\\d+|\\d*\\.\\d+)(?:[eE][-+]?\\d+)?)",Q.rePathCommand=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:[eE][-+]?\d+)?)/gi,Q.reNonWord=/[ \n\.,;!\?\-]/,Q.fontPaths={},Q.iMatrix=[1,0,0,1,0,0],Q.svgNS="http://www.w3.org/2000/svg",Q.perfLimitSizeTotal=2097152,Q.maxCacheSideLimit=4096,Q.minCacheSideLimit=256,Q.charWidthsCache={},Q.textureSize=2048,Q.disableStyleCopyPaste=!1,Q.enableGLFiltering=!0,Q.devicePixelRatio=Q.window.devicePixelRatio||Q.window.webkitDevicePixelRatio||Q.window.mozDevicePixelRatio||1,Q.browserShadowBlurConstant=1,Q.arcToSegmentsCache={},Q.boundsOfCurveCache={},Q.cachesBoundsOfCurve=!0,Q.forceGLPutImageData=!1,Q.initFilterBackend=function(){return Q.enableGLFiltering&&Q.isWebglSupported&&Q.isWebglSupported(Q.textureSize)?(console.log("max texture size: "+Q.maxTextureSize),new Q.WebglFilterBackend({tileSize:Q.textureSize})):Q.Canvas2dFilterBackend?new Q.Canvas2dFilterBackend:void 0},"undefined"!=typeof document&&"undefined"!=typeof window&&(window.fabric=Q),Q.Observable={fire:function(e,t){if(!this.__eventListeners)return this;var n=this.__eventListeners[e];if(!n)return this;for(var i=0,o=n.length;i<o;i++)n[i]&&n[i].call(this,t||{});return this.__eventListeners[e]=n.filter(function(e){return!1!==e}),this},on:function(e,t){if(this.__eventListeners||(this.__eventListeners={}),1===arguments.length)for(var n in e)this.on(n,e[n]);else this.__eventListeners[e]||(this.__eventListeners[e]=[]),this.__eventListeners[e].push(t);return this},off:function(e,t){if(!this.__eventListeners)return this;if(0===arguments.length)for(e in this.__eventListeners)ee.call(this,e);else if(1===arguments.length&&"object"==typeof e)for(var n in e)ee.call(this,n,e[n]);else ee.call(this,e,t);return this}},Q.Collection={_objects:[],add:function(){if(this._objects.push.apply(this._objects,arguments),this._onObjectAdded)for(var e=0,t=arguments.length;e<t;e++)this._onObjectAdded(arguments[e]);return this.renderOnAddRemove&&this.requestRenderAll(),this},insertAt:function(e,t,n){var i=this._objects;return n?i[t]=e:i.splice(t,0,e),this._onObjectAdded&&this._onObjectAdded(e),this.renderOnAddRemove&&this.requestRenderAll(),this},remove:function(){for(var e,t=this._objects,n=!1,i=0,o=arguments.length;i<o;i++)-1!==(e=t.indexOf(arguments[i]))&&(n=!0,t.splice(e,1),this._onObjectRemoved&&this._onObjectRemoved(arguments[i]));return this.renderOnAddRemove&&n&&this.requestRenderAll(),this},forEachObject:function(e,t){for(var n=this.getObjects(),i=0,o=n.length;i<o;i++)e.call(t,n[i],i,n);return this},getObjects:function(t){return void 0===t?this._objects.concat():this._objects.filter(function(e){return e.type===t})},item:function(e){return this._objects[e]},isEmpty:function(){return 0===this._objects.length},size:function(){return this._objects.length},contains:function(e){return-1<this._objects.indexOf(e)},complexity:function(){return this._objects.reduce(function(e,t){return e+(t.complexity?t.complexity():0)},0)}},Q.CommonMethods={_setOptions:function(e){for(var t in e)this.set(t,e[t])},_initGradient:function(e,t){!e||!e.colorStops||e instanceof Q.Gradient||this.set(t,new Q.Gradient(e))},_initPattern:function(e,t,n){!e||!e.source||e instanceof Q.Pattern?n&&n():this.set(t,new Q.Pattern(e,n))},_setObject:function(e){for(var t in e)this._set(t,e[t])},set:function(e,t){return"object"==typeof e?this._setObject(e):this._set(e,t),this},_set:function(e,t){this[e]=t},toggle:function(e){var t=this.get(e);return"boolean"==typeof t&&this.set(e,!t),this},get:function(e){return this[e]}},r=Pe,f=Math.sqrt,p=Math.atan2,s=Math.pow,a=Math.PI/180,n=Math.PI/2,Q.util={cos:function(e){if(0===e)return 1;switch(e<0&&(e=-e),e/n){case 1:case 3:return 0;case 2:return-1}return Math.cos(e)},sin:function(e){if(0===e)return 0;var t=e<0?-1:1;switch(e/n){case 1:return t;case 2:return 0;case 3:return-t}return Math.sin(e)},removeFromArray:function(e,t){var n=e.indexOf(t);return-1!==n&&e.splice(n,1),e},getRandomInt:function(e,t){return Math.floor(Math.random()*(t-e+1))+e},degreesToRadians:function(e){return e*a},radiansToDegrees:function(e){return e/a},rotatePoint:function(e,t,n){e.subtractEquals(t);var i=Q.util.rotateVector(e,n);return new Q.Point(i.x,i.y).addEquals(t)},rotateVector:function(e,t){var n=Q.util.sin(t),i=Q.util.cos(t);return{x:e.x*i-e.y*n,y:e.x*n+e.y*i}},transformPoint:function(e,t,n){return n?new Q.Point(t[0]*e.x+t[2]*e.y,t[1]*e.x+t[3]*e.y):new Q.Point(t[0]*e.x+t[2]*e.y+t[4],t[1]*e.x+t[3]*e.y+t[5])},makeBoundingBoxFromPoints:function(e,t){if(t)for(var n=0;n<e.length;n++)e[n]=Q.util.transformPoint(e[n],t);var i=[e[0].x,e[1].x,e[2].x,e[3].x],o=Q.util.array.min(i),r=Q.util.array.max(i)-o,s=[e[0].y,e[1].y,e[2].y,e[3].y],a=Q.util.array.min(s);return{left:o,top:a,width:r,height:Q.util.array.max(s)-a}},invertTransform:function(e){var t=1/(e[0]*e[3]-e[1]*e[2]),n=[t*e[3],-t*e[1],-t*e[2],t*e[0]],i=Q.util.transformPoint({x:e[4],y:e[5]},n,!0);return n[4]=-i.x,n[5]=-i.y,n},toFixed:function(e,t){return parseFloat(Number(e).toFixed(t))},parseUnit:function(e,t){var n=/\D{0,2}$/.exec(e),i=parseFloat(e);switch(t=t||Q.Text.DEFAULT_SVG_FONT_SIZE,n[0]){case"mm":return i*Q.DPI/25.4;case"cm":return i*Q.DPI/2.54;case"in":return i*Q.DPI;case"pt":return i*Q.DPI/72;case"pc":return i*Q.DPI/72*12;case"em":return i*t;default:return i}},falseFunction:function(){return!1},getKlass:function(e,t){return e=Q.util.string.camelize(e.charAt(0).toUpperCase()+e.slice(1)),Q.util.resolveNamespace(t)[e]},getSvgAttributes:function(e){var t=["instantiated_by_use","style","id","class"];switch(e){case"linearGradient":t=t.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);break;case"radialGradient":t=t.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);break;case"stop":t=t.concat(["offset","stop-color","stop-opacity"])}return t},resolveNamespace:function(e){if(!e)return Q;for(var t=e.split("."),n=t.length,i=r||Q.window,o=0;o<n;++o)i=i[t[o]];return i},loadImage:function(e,t,n,i){var o,r;e?(r=function(){t&&t.call(n,o,!1),o=o.onload=o.onerror=null},(o=Q.util.createImage()).onload=r,o.onerror=function(){Q.log("Error loading "+o.src),t&&t.call(n,null,!0),o=o.onload=o.onerror=null},0!==e.indexOf("data")&&null!=i&&(o.crossOrigin=i),"data:image/svg"===e.substring(0,14)&&(o.onload=null,Q.util.loadImageInDom(o,r)),o.src=e):t&&t.call(n,e)},loadImageInDom:function(e,t){var n=Q.document.createElement("div");n.style.width=n.style.height="1px",n.style.left=n.style.top="-100%",n.style.position="absolute",n.appendChild(e),Q.document.querySelector("body").appendChild(n),e.onload=function(){t(),n.parentNode.removeChild(n),n=null}},enlivenObjects:function(e,t,o,r){var s=[],n=0,i=(e=e||[]).length;function a(){++n===i&&t&&t(s.filter(function(e){return e}))}i?e.forEach(function(n,i){n&&n.type?Q.util.getKlass(n.type,o).fromObject(n,function(e,t){t||(s[i]=e),r&&r(n,e,t),a()}):a()}):t&&t(s)},enlivenPatterns:function(e,t){function n(){++o===r&&t&&t(i)}var i=[],o=0,r=(e=e||[]).length;r?e.forEach(function(e,t){e&&e.source?new Q.Pattern(e,function(e){i[t]=e,n()}):(i[t]=e,n())}):t&&t(i)},groupSVGElements:function(e,t,n){var i;return e&&1===e.length?e[0]:(t&&(t.width&&t.height?t.centerPoint={x:t.width/2,y:t.height/2}:(delete t.width,delete t.height)),i=new Q.Group(e,t),void 0!==n&&(i.sourcePath=n),i)},populateWithProperties:function(e,t,n){if(n&&"[object Array]"===Object.prototype.toString.call(n))for(var i=0,o=n.length;i<o;i++)n[i]in e&&(t[n[i]]=e[n[i]])},drawDashedLine:function(e,t,n,i,o,r){var s=i-t,a=o-n,l=f(s*s+a*a),c=p(a,s),u=r.length,h=0,d=!0;for(e.save(),e.translate(t,n),e.moveTo(0,0),e.rotate(c),t=0;t<l;)l<(t+=r[h++%u])&&(t=l),e[d?"lineTo":"moveTo"](t,0),d=!d;e.restore()},createCanvasElement:function(){return Q.document.createElement("canvas")},copyCanvasElement:function(e){var t=Q.util.createCanvasElement();return t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0),t},toDataURL:function(e,t,n){return e.toDataURL("image/"+t,n)},createImage:function(){return Q.document.createElement("img")},multiplyTransformMatrices:function(e,t,n){return[e[0]*t[0]+e[2]*t[1],e[1]*t[0]+e[3]*t[1],e[0]*t[2]+e[2]*t[3],e[1]*t[2]+e[3]*t[3],n?0:e[0]*t[4]+e[2]*t[5]+e[4],n?0:e[1]*t[4]+e[3]*t[5]+e[5]]},qrDecompose:function(e){var t=p(e[1],e[0]),n=s(e[0],2)+s(e[1],2),i=f(n),o=(e[0]*e[3]-e[2]*e[1])/i,r=p(e[0]*e[2]+e[1]*e[3],n);return{angle:t/a,scaleX:i,scaleY:o,skewX:r/a,skewY:0,translateX:e[4],translateY:e[5]}},calcRotateMatrix:function(e){if(!e.angle)return Q.iMatrix.concat();var t=Q.util.degreesToRadians(e.angle),n=Q.util.cos(t),i=Q.util.sin(t);return[n,i,-i,n,0,0]},calcDimensionsMatrix:function(e){var t=void 0===e.scaleX?1:e.scaleX,n=void 0===e.scaleY?1:e.scaleY,i=[e.flipX?-t:t,0,0,e.flipY?-n:n,0,0],o=Q.util.multiplyTransformMatrices,r=Q.util.degreesToRadians;return e.skewX&&(i=o(i,[1,0,Math.tan(r(e.skewX)),1],!0)),e.skewY&&(i=o(i,[1,Math.tan(r(e.skewY)),0,1],!0)),i},composeMatrix:function(e){var t=[1,0,0,1,e.translateX||0,e.translateY||0],n=Q.util.multiplyTransformMatrices;return e.angle&&(t=n(t,Q.util.calcRotateMatrix(e))),(1!==e.scaleX||1!==e.scaleY||e.skewX||e.skewY||e.flipX||e.flipY)&&(t=n(t,Q.util.calcDimensionsMatrix(e))),t},resetObjectTransform:function(e){e.scaleX=1,e.scaleY=1,e.skewX=0,e.skewY=0,e.flipX=!1,e.flipY=!1,e.rotate(0)},saveObjectTransform:function(e){return{scaleX:e.scaleX,scaleY:e.scaleY,skewX:e.skewX,skewY:e.skewY,angle:e.angle,left:e.left,flipX:e.flipX,flipY:e.flipY,top:e.top}},isTransparent:function(e,t,n,i){0<i&&(i<t?t-=i:t=0,i<n?n-=i:n=0);for(var o=!0,r=e.getImageData(t,n,2*i||1,2*i||1),s=r.data.length,a=3;a<s&&!1!=(o=r.data[a]<=0);a+=4);return r=null,o},parsePreserveAspectRatioAttribute:function(e){var t,n="meet",i=e.split(" ");return i&&i.length&&("meet"!==(n=i.pop())&&"slice"!==n?(t=n,n="meet"):i.length&&(t=i.pop())),{meetOrSlice:n,alignX:"none"!==t?t.slice(1,4):"none",alignY:"none"!==t?t.slice(5,8):"none"}},clearFabricFontCache:function(e){(e=(e||"").toLowerCase())?Q.charWidthsCache[e]&&delete Q.charWidthsCache[e]:Q.charWidthsCache={}},limitDimsByArea:function(e,t){var n=Math.sqrt(t*e),i=Math.floor(t/n);return{x:Math.floor(n),y:i}},capValue:function(e,t,n){return Math.max(e,Math.min(t,n))},findScaleToFit:function(e,t){return Math.min(t.width/e.width,t.height/e.height)},findScaleToCover:function(e,t){return Math.max(t.width/e.width,t.height/e.height)},matrixToSVG:function(e){return"matrix("+e.map(function(e){return Q.util.toFixed(e,Q.Object.NUM_FRACTION_DIGITS)}).join(" ")+")"},sizeAfterTransform:function(e,t,n){var i=e/2,o=t/2,r=[{x:-i,y:-o},{x:i,y:-o},{x:-i,y:o},{x:i,y:o}],s=Q.util.calcDimensionsMatrix(n),a=Q.util.makeBoundingBoxFromPoints(r,s);return{x:a.width,y:a.height}}},P=Array.prototype.join,b={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},C={m:"l",M:"L"},Q.util.parsePath=function(e){var t,n,i,o,r,s=[],a=[],l=Q.rePathCommand;if(!e||!e.match)return s;for(var c,u=0,h=(r=e.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi)).length;u<h;u++){for(o=(t=r[u]).slice(1).trim(),a.length=0;i=l.exec(o);)a.push(i[0]);c=[t.charAt(0)];for(var d=0,f=a.length;d<f;d++)n=parseFloat(a[d]),isNaN(n)||c.push(n);var p=c[0],g=b[p.toLowerCase()],m=C[p]||p;if(c.length-1>g)for(var v=1,y=c.length;v<y;v+=g)s.push([p].concat(c.slice(v,v+g))),p=m;else s.push(c)}return s},Q.util.makePathSimpler=function(e){for(var t,n,i,o,r,s=0,a=0,l=e.length,c=0,u=0,h=[],d=0;d<l;++d){switch(n=!1,(t=e[d].slice(0))[0]){case"l":t[0]="L",t[1]+=s,t[2]+=a;case"L":s=t[1],a=t[2];break;case"h":t[1]+=s;case"H":t[0]="L",t[2]=a,s=t[1];break;case"v":t[1]+=a;case"V":t[0]="L",a=t[1],t[1]=s,t[2]=a;break;case"m":t[0]="M",t[1]+=s,t[2]+=a;case"M":s=t[1],a=t[2],c=t[1],u=t[2];break;case"c":t[0]="C",t[1]+=s,t[2]+=a,t[3]+=s,t[4]+=a,t[5]+=s,t[6]+=a;case"C":o=t[3],r=t[4],s=t[5],a=t[6];break;case"s":t[0]="S",t[1]+=s,t[2]+=a,t[3]+=s,t[4]+=a;case"S":r="C"===i?(o=2*s-o,2*a-r):(o=s,a),s=t[3],a=t[4],t[0]="C",t[5]=t[3],t[6]=t[4],t[3]=t[1],t[4]=t[2],t[1]=o,t[2]=r,o=t[3],r=t[4];break;case"q":t[0]="Q",t[1]+=s,t[2]+=a,t[3]+=s,t[4]+=a;case"Q":o=t[1],r=t[2],s=t[3],a=t[4];break;case"t":t[0]="T",t[1]+=s,t[2]+=a;case"T":r="Q"===i?(o=2*s-o,2*a-r):(o=s,a),t[0]="Q",s=t[1],a=t[2],t[1]=o,t[2]=r,t[3]=s,t[4]=a;break;case"a":t[0]="A",t[6]+=s,t[7]+=a;case"A":n=!0,h=h.concat(oe(s,a,t)),s=t[6],a=t[7];break;case"z":case"Z":s=c,a=u}n||h.push(t),i=t[0]}return h},Q.util.getPathSegmentsInfo=ce,Q.util.fromArcToBeizers=oe,Q.util.getBoundsOfCurve=ie,Q.util.getPointOnPath=function(e,t,n){for(var i=(n=n||ce(e))[n.length-1]*t,o=0;0<i-n[o]&&o<n.length;)i-=n[o],o++;var r=n[o],s=i/r.length,a=r.length,l=e[o];switch(a){case"Z":case"z":return new Q.Point(r.x,r.y).lerp(new Q.Point(r.destX,r.destY),s);case"L":return new Q.Point(r.x,r.y).lerp(new Q.Point(l[1],l[2]),s);case"C":return se(r.x,r.y,l[1],l[2],l[3],l[4],l[5],l[6])(s);case"Q":return ae(r.x,r.y,l[1],l[2],l[3],l[4])(s)}},Q.util.getBoundsOfArc=function(e,t,n,i,o,r,s,a,l){for(var c,u=0,h=0,d=[],f=te(a-e,l-t,n,i,r,s,o),p=0,g=f.length;p<g;p++)c=ie(u,h,f[p][1],f[p][2],f[p][3],f[p][4],f[p][5],f[p][6]),d.push({x:c[0].x+e,y:c[0].y+t}),d.push({x:c[1].x+e,y:c[1].y+t}),u=f[p][5],h=f[p][6];return d},Q.util.drawArc=function(t,e,n,i){oe(e,n,i=i.slice(0).unshift("X")).forEach(function(e){t.bezierCurveTo.apply(t,e.slice(1))})},l=Array.prototype.slice,Q.util.array={fill:function(e,t){for(var n=e.length;n--;)e[n]=t;return e},invoke:function(e,t){for(var n=l.call(arguments,2),i=[],o=0,r=e.length;o<r;o++)i[o]=n.length?e[o][t].apply(e[o],n):e[o][t].call(e[o]);return i},min:function(e,t){return ue(e,t,function(e,t){return e<t})},max:function(e,t){return ue(e,t,function(e,t){return t<=e})}},Q.util.object={extend:he,clone:function(e,t){return he({},e,t)}},Q.util.object.extend(Q.util,Q.Observable),Q.util.string={camelize:function(e){return e.replace(/-+(.)?/g,function(e,t){return t?t.toUpperCase():""})},capitalize:function(e,t){return e.charAt(0).toUpperCase()+(t?e.slice(1):e.slice(1).toLowerCase())},escapeXml:function(e){return e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},graphemeSplit:function(e){for(var t,n=0,i=[],n=0;n<e.length;n++)!1!==(t=function(e,t){var n=e.charCodeAt(t);if(isNaN(n))return"";if(n<55296||57343<n)return e.charAt(t);if(55296<=n&&n<=56319){if(e.length<=t+1)throw"High surrogate without following low surrogate";var i=e.charCodeAt(t+1);if(i<56320||57343<i)throw"High surrogate without following low surrogate";return e.charAt(t)+e.charAt(t+1)}if(0===t)throw"Low surrogate without preceding high surrogate";var o=e.charCodeAt(t-1);if(o<55296||56319<o)throw"Low surrogate without preceding high surrogate";return!1}(e,n))&&i.push(t);return i}},c=Array.prototype.slice,u=function(){for(var e in{toString:1})if("toString"===e)return!1;return!0}(),Q.util.createClass=function(){var e=null,t=c.call(arguments,0);function n(){this.initialize.apply(this,arguments)}"function"==typeof t[0]&&(e=t.shift()),n.superclass=e,n.subclasses=[],e&&(fe.prototype=e.prototype,n.prototype=new fe,e.subclasses.push(n));for(var i=0,o=t.length;i<o;i++)!function(e,i,o){for(var t in i)t in e.prototype&&"function"==typeof e.prototype[t]&&-1<(i[t]+"").indexOf("callSuper")?e.prototype[t]=function(n){return function(){var e=this.constructor.superclass;this.constructor.superclass=o;var t=i[n].apply(this,arguments);if(this.constructor.superclass=e,"initialize"!==n)return t}}(t):e.prototype[t]=i[t],u&&(i.toString!==Object.prototype.toString&&(e.prototype.toString=i.toString),i.valueOf!==Object.prototype.valueOf&&(e.prototype.valueOf=i.valueOf))}(n,t[i],e);return n.prototype.initialize||(n.prototype.initialize=de),(n.prototype.constructor=n).prototype.callSuper=pe,n},o=!!Q.document.createElement("div").attachEvent,i=["touchstart","touchmove","touchend"],Q.util.addListener=function(e,t,n,i){e&&e.addEventListener(t,n,!o&&i)},Q.util.removeListener=function(e,t,n,i){e&&e.removeEventListener(t,n,!o&&i)},Q.util.getPointer=function(e){var t,n=e.target,i=Q.util.getScrollLeftTop(n),o=(t=e.changedTouches)&&t[0]?t[0]:e;return{x:o.clientX+i.left,y:o.clientY+i.top}},Q.util.isTouchEvent=function(e){return-1<i.indexOf(e.type)||"touch"===e.pointerType},d="string"==typeof(h=Q.document.createElement("div")).style.opacity,g="string"==typeof h.style.filter,m=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,v=function(e){return e},d?v=function(e,t){return e.style.opacity=t,e}:g&&(v=function(e,t){var n=e.style;return e.currentStyle&&!e.currentStyle.hasLayout&&(n.zoom=1),m.test(n.filter)?(t=.9999<=t?"":"alpha(opacity="+100*t+")",n.filter=n.filter.replace(m,t)):n.filter+=" alpha(opacity="+100*t+")",e}),Q.util.setStyle=function(e,t){var n=e.style;if(!n)return e;if("string"==typeof t)return e.style.cssText+=";"+t,-1<t.indexOf("opacity")?v(e,t.match(/opacity:\s*(\d?\.?\d*)/)[1]):e;for(var i in t)"opacity"===i?v(e,t[i]):n["float"===i||"cssFloat"===i?void 0===n.styleFloat?"cssFloat":"styleFloat":i]=t[i];return e},function(){var e,l,t,n,i=Array.prototype.slice,o=function(e){return i.call(e,0)};try{e=o(Q.document.childNodes)instanceof Array}catch(e){}function r(e,t){var n=Q.document.createElement(e);for(var i in t)"class"===i?n.className=t[i]:"for"===i?n.htmlFor=t[i]:n.setAttribute(i,t[i]);return n}function c(e){for(var t=0,n=0,i=Q.document.documentElement,o=Q.document.body||{scrollLeft:0,scrollTop:0};e&&(e.parentNode||e.host)&&((e=e.parentNode||e.host)===Q.document?(t=o.scrollLeft||i.scrollLeft||0,n=o.scrollTop||i.scrollTop||0):(t+=e.scrollLeft||0,n+=e.scrollTop||0),1!==e.nodeType||"fixed"!==e.style.position););return{left:t,top:n}}e||(o=function(e){for(var t=new Array(e.length),n=e.length;n--;)t[n]=e[n];return t}),l=Q.document.defaultView&&Q.document.defaultView.getComputedStyle?function(e,t){var n=Q.document.defaultView.getComputedStyle(e,null);return n?n[t]:void 0}:function(e,t){var n=e.style[t];return!n&&e.currentStyle&&(n=e.currentStyle[t]),n},t=Q.document.documentElement.style,n="userSelect"in t?"userSelect":"MozUserSelect"in t?"MozUserSelect":"WebkitUserSelect"in t?"WebkitUserSelect":"KhtmlUserSelect"in t?"KhtmlUserSelect":"",Q.util.makeElementUnselectable=function(e){return void 0!==e.onselectstart&&(e.onselectstart=Q.util.falseFunction),n?e.style[n]="none":"string"==typeof e.unselectable&&(e.unselectable="on"),e},Q.util.makeElementSelectable=function(e){return void 0!==e.onselectstart&&(e.onselectstart=null),n?e.style[n]="":"string"==typeof e.unselectable&&(e.unselectable=""),e},Q.util.setImageSmoothing=function(e,t){e.imageSmoothingEnabled=e.imageSmoothingEnabled||e.webkitImageSmoothingEnabled||e.mozImageSmoothingEnabled||e.msImageSmoothingEnabled||e.oImageSmoothingEnabled,e.imageSmoothingEnabled=t},Q.util.getById=function(e){return"string"==typeof e?Q.document.getElementById(e):e},Q.util.toArray=o,Q.util.addClass=function(e,t){e&&-1===(" "+e.className+" ").indexOf(" "+t+" ")&&(e.className+=(e.className?" ":"")+t)},Q.util.makeElement=r,Q.util.wrapElement=function(e,t,n){return"string"==typeof t&&(t=r(t,n)),e.parentNode&&e.parentNode.replaceChild(t,e),t.appendChild(e),t},Q.util.getScrollLeftTop=c,Q.util.getElementOffset=function(e){var t,n,i=e&&e.ownerDocument,o={left:0,top:0},r={left:0,top:0},s={borderLeftWidth:"left",borderTopWidth:"top",paddingLeft:"left",paddingTop:"top"};if(!i)return r;for(var a in s)r[s[a]]+=parseInt(l(e,a),10)||0;return t=i.documentElement,void 0!==e.getBoundingClientRect&&(o=e.getBoundingClientRect()),n=c(e),{left:o.left+n.left-(t.clientLeft||0)+r.left,top:o.top+n.top-(t.clientTop||0)+r.top}},Q.util.getNodeCanvas=function(e){var t=Q.jsdomImplForWrapper(e);return t._canvas||t._image},Q.util.cleanUpJsdomNode=function(e){var t;!Q.isLikelyNode||(t=Q.jsdomImplForWrapper(e))&&(t._image=null,t._canvas=null,t._currentSrc=null,t._attributes=null,t._classList=null)}}(),Q.util.request=function(e,t){var n,i=(t=t||{}).method?t.method.toUpperCase():"GET",o=t.onComplete||function(){},r=new Q.window.XMLHttpRequest,s=t.body||t.parameters;return r.onreadystatechange=function(){4===r.readyState&&(o(r),r.onreadystatechange=ge)},"GET"===i&&(s=null,"string"==typeof t.parameters&&(n=t.parameters,e=e+(/\?/.test(e)?"&":"?")+n)),r.open(i,e,!0),"POST"!==i&&"PUT"!==i||r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.send(s),r},Q.log=console.log,Q.warn=console.warn,y=Q.window.requestAnimationFrame||Q.window.webkitRequestAnimationFrame||Q.window.mozRequestAnimationFrame||Q.window.oRequestAnimationFrame||Q.window.msRequestAnimationFrame||function(e){return Q.window.setTimeout(e,1e3/60)},x=Q.window.cancelAnimationFrame||Q.window.clearTimeout,Q.util.animate=function(t){ye(function(e){t=t||{};var s,a=e||+new Date,l=t.duration||500,c=a+l,u=t.onChange||me,h=t.abort||me,d=t.onComplete||me,f=t.easing||ve,p="startValue"in t?t.startValue:0,g="endValue"in t?t.endValue:100,m=t.byValue||g-p;t.onStart&&t.onStart(),function e(t){s=t||+new Date;var n=c<s?l:s-a,i=n/l,o=f(n,p,m,l),r=Math.abs((o-p)/m);if(!h())return c<s?(u(g,1,1),void d(g,1,1)):(u(o,r,i),void ye(e));d(g,1,1)}(a)})},Q.util.requestAnimFrame=ye,Q.util.cancelAnimFrame=function(){return x.apply(Q.window,arguments)},Q.util.animateColor=function(e,t,n,o){var i=new Q.Color(e).getSource(),r=new Q.Color(t).getSource(),s=o.onComplete,a=o.onChange;o=o||{},Q.util.animate(Q.util.object.extend(o,{duration:n||500,startValue:i,endValue:r,byValue:r,easing:function(e,t,n,i){return be(t,n,o.colorEasing?o.colorEasing(e,i):1-Math.cos(e/i*(Math.PI/2)))},onComplete:function(e,t,n){if(s)return s(be(r,r,0),t,n)},onChange:function(e,t,n){if(a){if(Array.isArray(e))return a(be(e,e,0),t,n);a(e,t,n)}}}))},Q.util.ease={easeInQuad:function(e,t,n,i){return n*(e/=i)*e+t},easeOutQuad:function(e,t,n,i){return-n*(e/=i)*(e-2)+t},easeInOutQuad:function(e,t,n,i){return(e/=i/2)<1?n/2*e*e+t:-n/2*(--e*(e-2)-1)+t},easeInCubic:function(e,t,n,i){return n*(e/=i)*e*e+t},easeOutCubic:function(e,t,n,i){return n*((e=e/i-1)*e*e+1)+t},easeInOutCubic:function(e,t,n,i){return(e/=i/2)<1?n/2*e*e*e+t:n/2*((e-=2)*e*e+2)+t},easeInQuart:function(e,t,n,i){return n*(e/=i)*e*e*e+t},easeOutQuart:function(e,t,n,i){return-n*((e=e/i-1)*e*e*e-1)+t},easeInOutQuart:function(e,t,n,i){return(e/=i/2)<1?n/2*e*e*e*e+t:-n/2*((e-=2)*e*e*e-2)+t},easeInQuint:function(e,t,n,i){return n*(e/=i)*e*e*e*e+t},easeOutQuint:function(e,t,n,i){return n*((e=e/i-1)*e*e*e*e+1)+t},easeInOutQuint:function(e,t,n,i){return(e/=i/2)<1?n/2*e*e*e*e*e+t:n/2*((e-=2)*e*e*e*e+2)+t},easeInSine:function(e,t,n,i){return-n*Math.cos(e/i*(Math.PI/2))+n+t},easeOutSine:function(e,t,n,i){return n*Math.sin(e/i*(Math.PI/2))+t},easeInOutSine:function(e,t,n,i){return-n/2*(Math.cos(Math.PI*e/i)-1)+t},easeInExpo:function(e,t,n,i){return 0===e?t:n*Math.pow(2,10*(e/i-1))+t},easeOutExpo:function(e,t,n,i){return e===i?t+n:n*(1-Math.pow(2,-10*e/i))+t},easeInOutExpo:function(e,t,n,i){return 0===e?t:e===i?t+n:(e/=i/2)<1?n/2*Math.pow(2,10*(e-1))+t:n/2*(2-Math.pow(2,-10*--e))+t},easeInCirc:function(e,t,n,i){return-n*(Math.sqrt(1-(e/=i)*e)-1)+t},easeOutCirc:function(e,t,n,i){return n*Math.sqrt(1-(e=e/i-1)*e)+t},easeInOutCirc:function(e,t,n,i){return(e/=i/2)<1?-n/2*(Math.sqrt(1-e*e)-1)+t:n/2*(Math.sqrt(1-(e-=2)*e)+1)+t},easeInElastic:function(e,t,n,i){return 0===e?t:1==(e/=i)?t+n:-xe(Ce(n,n,.3*i,1.70158),e,i)+t},easeOutElastic:function(e,t,n,i){if(0===e)return t;if(1==(e/=i))return t+n;var o=Ce(n,n,.3*i,1.70158);return o.a*Math.pow(2,-10*e)*Math.sin((e*i-o.s)*(2*Math.PI)/o.p)+o.c+t},easeInOutElastic:function(e,t,n,i){if(0===e)return t;if(2==(e/=i/2))return t+n;var o=Ce(n,n,i*(.3*1.5),1.70158);return e<1?-.5*xe(o,e,i)+t:o.a*Math.pow(2,-10*--e)*Math.sin((e*i-o.s)*(2*Math.PI)/o.p)*.5+o.c+t},easeInBack:function(e,t,n,i,o){return void 0===o&&(o=1.70158),n*(e/=i)*e*((o+1)*e-o)+t},easeOutBack:function(e,t,n,i,o){return void 0===o&&(o=1.70158),n*((e=e/i-1)*e*((o+1)*e+o)+1)+t},easeInOutBack:function(e,t,n,i,o){return void 0===o&&(o=1.70158),(e/=i/2)<1?n/2*(e*e*((1+(o*=1.525))*e-o))+t:n/2*((e-=2)*e*((1+(o*=1.525))*e+o)+2)+t},easeInBounce:we,easeOutBounce:Se,easeInOutBounce:function(e,t,n,i){return e<i/2?.5*we(2*e,0,n,i)+t:.5*Se(2*e-i,0,n,i)+.5*n+t}},function(){"use strict";var m,e,t,v,n,i,w=Pe.fabric||(Pe.fabric={}),p=w.util.object.extend,d=w.util.object.clone,g=w.util.toFixed,S=w.util.parseUnit,y=w.util.multiplyTransformMatrices,b={cx:"left",x:"left",r:"radius",cy:"top",y:"top",display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing"},C={stroke:"strokeOpacity",fill:"fillOpacity"},x="font-size",_="clip-path";function o(e){return new RegExp("^("+e.join("|")+")\\b","i")}function E(e,t){for(var n,i,o=[],r=0,s=t.length;r<s;r++)n=t[r],i=e.getElementsByTagName(n),o=o.concat(Array.prototype.slice.call(i));return o}function T(e,t,n){e[n]=Math.tan(w.util.degreesToRadians(t[0]))}function k(e,t){var n,i=e.nodeName,o=e.getAttribute("class"),r=e.getAttribute("id"),s=new RegExp("^"+i,"i");if(t=t.replace(s,""),r&&t.length&&(s=new RegExp("#"+r+"(?![a-zA-Z\\-]+)","i"),t=t.replace(s,"")),o&&t.length)for(n=(o=o.split(" ")).length;n--;)s=new RegExp("\\."+o[n]+"(?![a-zA-Z\\-]+)","i"),t=t.replace(s,"");return 0===t.length}function O(e,t){var n;if(e.getElementById&&(n=e.getElementById(t)),n)return n;for(var i,o=e.getElementsByTagName("*"),r=0,s=o.length;r<s;r++)if(t===(i=o[r]).getAttribute("id"))return i}w.svgValidTagNamesRegEx=o(["path","circle","polygon","polyline","ellipse","rect","line","image","text"]),w.svgViewBoxElementsRegEx=o(["symbol","image","marker","pattern","view","svg"]),w.svgInvalidAncestorsRegEx=o(["pattern","defs","symbol","metadata","clipPath","mask","desc"]),w.svgValidParentsRegEx=o(["symbol","g","a","svg","clipPath","defs"]),w.cssRules={},w.gradientDefs={},w.clipPaths={},w.parseTransformAttribute=(m=w.iMatrix,e=w.reNum,v="(?:(?:(matrix)\\s*\\(\\s*("+e+")"+(t="(?:\\s+,?\\s*|,\\s*)")+"("+e+")"+t+"("+e+")"+t+"("+e+")"+t+"("+e+")"+t+"("+e+")\\s*\\))|(?:(translate)\\s*\\(\\s*("+e+")(?:"+t+"("+e+"))?\\s*\\))|(?:(scale)\\s*\\(\\s*("+e+")(?:"+t+"("+e+"))?\\s*\\))|(?:(rotate)\\s*\\(\\s*("+e+")(?:"+t+"("+e+")"+t+"("+e+"))?\\s*\\))|(?:(skewX)\\s*\\(\\s*("+e+")\\s*\\))|(?:(skewY)\\s*\\(\\s*("+e+")\\s*\\)))",n=new RegExp("^\\s*(?:(?:"+v+"(?:"+t+"*"+v+")*)?)\\s*$"),i=new RegExp(v,"g"),function(e){var p=m.concat(),g=[];if(!e||e&&!n.test(e))return p;e.replace(i,function(e){var t,n,i,o,r,s,a,l,c,u,h=new RegExp(v).exec(e).filter(function(e){return!!e}),d=h[1],f=h.slice(2).map(parseFloat);switch(d){case"translate":u=f,p[4]=u[0],2===u.length&&(p[5]=u[1]);break;case"rotate":f[0]=w.util.degreesToRadians(f[0]),o=p,r=f,s=w.util.cos(r[0]),a=w.util.sin(r[0]),c=l=0,3===r.length&&(l=r[1],c=r[2]),o[0]=s,o[1]=a,o[2]=-a,o[3]=s,o[4]=l-(s*l-a*c),o[5]=c-(a*l+s*c);break;case"scale":t=p,n=f[0],i=2===f.length?f[1]:f[0],t[0]=n,t[3]=i;break;case"skewX":T(p,f,2);break;case"skewY":T(p,f,1);break;case"matrix":p=f}g.push(p.concat()),p=m.concat()});for(var t=g[0];1<g.length;)g.shift(),t=w.util.multiplyTransformMatrices(t,g[0]);return t});var A=new RegExp("^\\s*("+w.reNum+"+)\\s*,?\\s*("+w.reNum+"+)\\s*,?\\s*("+w.reNum+"+)\\s*,?\\s*("+w.reNum+"+)\\s*$");function P(e){if(w.svgViewBoxElementsRegEx.test(e.nodeName)){var t,n,i,o,r,s,a=e.getAttribute("viewBox"),l=1,c=1,u=e.getAttribute("width"),h=e.getAttribute("height"),d=e.getAttribute("x")||0,f=e.getAttribute("y")||0,p=e.getAttribute("preserveAspectRatio")||"",g=!a||!(a=a.match(A)),m=!u||!h||"100%"===u||"100%"===h,v=g&&m,y={},b="",C=0,x=0;if(y.width=0,y.height=0,y.toBeParsed=v,g&&(d||f)&&"#document"!==e.parentNode.nodeName&&(b=" translate("+S(d)+" "+S(f)+") ",r=(e.getAttribute("transform")||"")+b,e.setAttribute("transform",r),e.removeAttribute("x"),e.removeAttribute("y")),v)return y;if(g)return y.width=S(u),y.height=S(h),y;if(t=-parseFloat(a[1]),n=-parseFloat(a[2]),i=parseFloat(a[3]),o=parseFloat(a[4]),y.minX=t,y.minY=n,y.viewBoxWidth=i,y.viewBoxHeight=o,m?(y.width=i,y.height=o):(y.width=S(u),y.height=S(h),l=y.width/i,c=y.height/o),"none"!==(p=w.util.parsePreserveAspectRatioAttribute(p)).alignX&&("meet"===p.meetOrSlice&&(c=l=c<l?c:l),"slice"===p.meetOrSlice&&(c=l=c<l?l:c),C=y.width-i*l,x=y.height-o*l,"Mid"===p.alignX&&(C/=2),"Mid"===p.alignY&&(x/=2),"Min"===p.alignX&&(C=0),"Min"===p.alignY&&(x=0)),1===l&&1===c&&0==t&&0==n&&0===d&&0===f)return y;if((d||f)&&"#document"!==e.parentNode.nodeName&&(b=" translate("+S(d)+" "+S(f)+") "),r=b+" matrix("+l+" 0 0 "+c+" "+(t*l+C)+" "+(n*c+x)+") ","svg"===e.nodeName){for(s=e.ownerDocument.createElementNS(w.svgNS,"g");e.firstChild;)s.appendChild(e.firstChild);e.appendChild(s)}else(s=e).removeAttribute("x"),s.removeAttribute("y"),r=s.getAttribute("transform")+r;return s.setAttribute("transform",r),y}}w.parseSVGDocument=function(e,n,t,i){if(e){!function(e){for(var t=E(e,["use","svg:use"]),n=0;t.length&&n<t.length;){var i,o=t[n],r=(o.getAttribute("xlink:href")||o.getAttribute("href")).substr(1),s=o.getAttribute("x")||0,a=o.getAttribute("y")||0,l=O(e,r).cloneNode(!0),c=(l.getAttribute("transform")||"")+" translate("+s+", "+a+")",u=t.length,h=w.svgNS;if(P(l),/^svg$/i.test(l.nodeName)){for(var d,f=l.ownerDocument.createElementNS(h,"g"),p=0,g=(d=l.attributes).length;p<g;p++)i=d.item(p),f.setAttributeNS(h,i.nodeName,i.nodeValue);for(;l.firstChild;)f.appendChild(l.firstChild);l=f}for(p=0,g=(d=o.attributes).length;p<g;p++)"x"!==(i=d.item(p)).nodeName&&"y"!==i.nodeName&&"xlink:href"!==i.nodeName&&"href"!==i.nodeName&&("transform"===i.nodeName?c=i.nodeValue+" "+c:l.setAttribute(i.nodeName,i.nodeValue));l.setAttribute("transform",c),l.setAttribute("instantiated_by_use","1"),l.removeAttribute("id"),o.parentNode.replaceChild(l,o),t.length===u&&n++}}(e);var o=w.Object.__uid++,r=P(e),s=w.util.toArray(e.getElementsByTagName("*"));if(r.crossOrigin=i&&i.crossOrigin,r.svgUid=o,0===s.length&&w.isLikelyNode){for(var a=[],l=0,c=(s=e.selectNodes('//*[name(.)!="svg"]')).length;l<c;l++)a[l]=s[l];s=a}var u,h=s.filter(function(e){return P(e),w.svgValidTagNamesRegEx.test(e.nodeName.replace("svg:",""))&&!function(e,t){for(;e=e&&e.parentNode;)if(e.nodeName&&t.test(e.nodeName.replace("svg:",""))&&!e.getAttribute("instantiated_by_use"))return 1}(e,w.svgInvalidAncestorsRegEx)});!h||h&&!h.length?n&&n([],{}):(u={},s.filter(function(e){return"clipPath"===e.nodeName.replace("svg:","")}).forEach(function(e){var t=e.getAttribute("id");u[t]=w.util.toArray(e.getElementsByTagName("*")).filter(function(e){return w.svgValidTagNamesRegEx.test(e.nodeName.replace("svg:",""))})}),w.gradientDefs[o]=w.getGradientDefs(e),w.cssRules[o]=w.getCSSRules(e),w.clipPaths[o]=u,w.parseElements(h,function(e,t){n&&(n(e,r,t,s),delete w.gradientDefs[o],delete w.cssRules[o],delete w.clipPaths[o])},d(r),t,i))}};var l=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+w.reNum+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+w.reNum+"))?\\s+(.*)");p(w,{parseFontDeclaration:function(e,t){var n,i,o,r,s,a=e.match(l);a&&(n=a[1],i=a[3],o=a[4],r=a[5],s=a[6],n&&(t.fontStyle=n),i&&(t.fontWeight=isNaN(parseFloat(i))?i:parseFloat(i)),o&&(t.fontSize=S(o)),s&&(t.fontFamily=s),r&&(t.lineHeight="normal"===r?1:r))},getGradientDefs:function(e){for(var t,n=E(e,["linearGradient","radialGradient","svg:linearGradient","svg:radialGradient"]),i=0,o={},i=n.length;i--;)(t=n[i]).getAttribute("xlink:href")&&function e(t,n){var i="xlink:href",o=O(t,n.getAttribute(i).substr(1));if(o&&o.getAttribute(i)&&e(t,o),["gradientTransform","x1","x2","y1","y2","gradientUnits","cx","cy","r","fx","fy"].forEach(function(e){o&&!n.hasAttribute(e)&&o.hasAttribute(e)&&n.setAttribute(e,o.getAttribute(e))}),!n.children.length)for(var r=o.cloneNode(!0);r.firstChild;)n.appendChild(r.firstChild);n.removeAttribute(i)}(e,t),o[t.getAttribute("id")]=t;return o},parseAttributes:function(n,e,t){if(n){var i,o,r,s={};void 0===t&&(t=n.getAttribute("svgUid")),n.parentNode&&w.svgValidParentsRegEx.test(n.parentNode.nodeName)&&(s=w.parseAttributes(n.parentNode,e,t));var a=e.reduce(function(e,t){return(i=n.getAttribute(t))&&(e[t]=i),e},{}),l=p(function(e,t){var n,i,o,r,s={};for(var a in w.cssRules[t])if(n=e,i=a.split(" "),r=!(r=o=void 0),(o=k(n,i.pop()))&&i.length&&(r=function(e,t){for(var n,i=!0;e.parentNode&&1===e.parentNode.nodeType&&t.length;)i&&(n=t.pop()),i=k(e=e.parentNode,n);return 0===t.length}(n,i)),o&&r&&0===i.length)for(var l in w.cssRules[t][a])s[l]=w.cssRules[t][a][l];return s}(n,t),w.parseStyleAttribute(n)),a=p(a,l);l[_]&&n.setAttribute(_,l[_]),o=r=s.fontSize||w.Text.DEFAULT_SVG_FONT_SIZE,a[x]&&(a[x]=o=S(a[x],r));var c,u,h={};for(var d in a)u=function(e,t,n,i){var o,r="[object Array]"===Object.prototype.toString.call(t);if("fill"!==e&&"stroke"!==e||"none"!==t){if("strokeUniform"===e)return"non-scaling-stroke"===t;if("strokeDashArray"===e)t="none"===t?null:t.replace(/,/g," ").split(/\s+/).map(parseFloat);else if("transformMatrix"===e)t=n&&n.transformMatrix?y(n.transformMatrix,w.parseTransformAttribute(t)):w.parseTransformAttribute(t);else if("visible"===e)t="none"!==t&&"hidden"!==t,n&&!1===n.visible&&(t=!1);else if("opacity"===e)t=parseFloat(t),n&&void 0!==n.opacity&&(t*=n.opacity);else if("textAnchor"===e)t="start"===t?"left":"end"===t?"right":"center";else if("charSpacing"===e)o=S(t,i)/i*1e3;else if("paintFirst"===e){var s=t.indexOf("fill"),a=t.indexOf("stroke"),t="fill";(-1<s&&-1<a&&a<s||-1===s&&-1<a)&&(t="stroke")}else{if("href"===e||"xlink:href"===e||"font"===e)return t;if("imageSmoothing"===e)return"optimizeQuality"===t;o=r?t.map(S):S(t,i)}}else t="";return!r&&isNaN(o)?t:o}(c=d in b?b[d]:d,a[d],s,o),h[c]=u;h&&h.font&&w.parseFontDeclaration(h.font,h);var f=p(s,h);return w.svgValidParentsRegEx.test(n.nodeName)?f:function(e){for(var t in C)if(void 0!==e[C[t]]&&""!==e[t]){if(void 0===e[t]){if(!w.Object.prototype[t])continue;e[t]=w.Object.prototype[t]}var n;0!==e[t].indexOf("url(")&&(n=new w.Color(e[t]),e[t]=n.setAlpha(g(n.getAlpha()*e[C[t]],2)).toRgba())}return e}(f)}},parseElements:function(e,t,n,i,o){new w.ElementsParser(e,t,n,i,o).parse()},parseStyleAttribute:function(e){var n,i,o,t={},r=e.getAttribute("style");return r&&("string"==typeof r?(n=t,r.replace(/;\s*$/,"").split(";").forEach(function(e){var t=e.split(":");i=t[0].trim().toLowerCase(),o=t[1].trim(),n[i]=o})):function(e,t){var n,i;for(var o in e)void 0!==e[o]&&(n=o.toLowerCase(),i=e[o],t[n]=i)}(r,t)),t},parsePointsAttribute:function(e){if(!e)return null;for(var t=[],n=0,i=(e=(e=e.replace(/,/g," ").trim()).split(/\s+/)).length;n<i;n+=2)t.push({x:parseFloat(e[n]),y:parseFloat(e[n+1])});return t},getCSSRules:function(e){for(var t=e.getElementsByTagName("style"),a={},l=0,c=t.length;l<c;l++){var n=t[l].textContent||"";""!==(n=n.replace(/\/\*[\s\S]*?\*\//g,"")).trim()&&n.match(/[^{]*\{[\s\S]*?\}/g).map(function(e){return e.trim()}).forEach(function(e){var t=e.match(/([\s\S]*?)\s*\{([^}]*)\}/),n={},i=t[2].trim().replace(/;$/,"").split(/\s*;\s*/);for(l=0,c=i.length;l<c;l++){var o=i[l].split(/\s*:\s*/),r=o[0],s=o[1];n[r]=s}(e=t[1]).split(",").forEach(function(e){""!==(e=e.replace(/^svg/i,"").trim())&&(a[e]?w.util.object.extend(a[e],n):a[e]=w.util.object.clone(n))})})}return a},loadSVGFromURL:function(e,o,n,i){e=e.replace(/^\n\s*/,"").trim(),new w.util.request(e,{method:"get",onComplete:function(e){var t=e.responseXML;if(!t||!t.documentElement)return o&&o(null),!1;w.parseSVGDocument(t.documentElement,function(e,t,n,i){o&&o(e,t,n,i)},n,i)}})},loadSVGFromString:function(e,o,t,n){var i=(new w.window.DOMParser).parseFromString(e.trim(),"text/xml");w.parseSVGDocument(i.documentElement,function(e,t,n,i){o(e,t,n,i)},t,n)}})}(),Q.ElementsParser=function(e,t,n,i,o,r){this.elements=e,this.callback=t,this.options=n,this.reviver=i,this.svgUid=n&&n.svgUid||0,this.parsingOptions=o,this.regexUrl=/^url\(['"]?#([^'"]+)['"]?\)/g,this.doc=r},(w=Q.ElementsParser.prototype).parse=function(){this.instances=new Array(this.elements.length),this.numElements=this.elements.length,this.createObjects()},w.createObjects=function(){var n=this;this.elements.forEach(function(e,t){e.setAttribute("svgUid",n.svgUid),n.createObject(e,t)})},w.findTag=function(e){return Q[Q.util.string.capitalize(e.tagName.replace("svg:",""))]},w.createObject=function(e,t){var n=this.findTag(e);if(n&&n.fromElement)try{n.fromElement(e,this.createCallback(t,e),this.options)}catch(e){Q.log(e)}else this.checkIfDone()},w.createCallback=function(n,i){var o=this;return function(e){var t;o.resolveGradient(e,i,"fill"),o.resolveGradient(e,i,"stroke"),e instanceof Q.Image&&e._originalElement&&(t=e.parsePreserveAspectRatioAttribute(i)),e._removeTransformMatrix(t),o.resolveClipPath(e,i),o.reviver&&o.reviver(i,e),o.instances[n]=e,o.checkIfDone()}},w.extractPropertyDefinition=function(e,t,n){var i=e[t],o=this.regexUrl;if(o.test(i)){o.lastIndex=0;var r=o.exec(i)[1];return o.lastIndex=0,Q[n][this.svgUid][r]}},w.resolveGradient=function(e,t,n){var i,o,r=this.extractPropertyDefinition(e,n,"gradientDefs");r&&(i=t.getAttribute(n+"-opacity"),o=Q.Gradient.fromElement(r,e,i,this.options),e.set(n,o))},w.createClipPathCallback=function(e,t){return function(e){e._removeTransformMatrix(),e.fillRule=e.clipRule,t.push(e)}},w.resolveClipPath=function(e,t){var n,i,o,r,s=this.extractPropertyDefinition(e,"clipPath","clipPaths");if(s){o=[],i=Q.util.invertTransform(e.calcTransformMatrix());for(var a=s[0].parentNode,l=t;l.parentNode&&l.getAttribute("clip-path")!==e.clipPath;)l=l.parentNode;l.parentNode.appendChild(a);for(var c=0;c<s.length;c++)n=s[c],this.findTag(n).fromElement(n,this.createClipPathCallback(e,o),this.options);s=1===o.length?o[0]:new Q.Group(o),r=Q.util.multiplyTransformMatrices(i,s.calcTransformMatrix()),s.clipPath&&this.resolveClipPath(s,l);var u=Q.util.qrDecompose(r);s.flipX=!1,s.flipY=!1,s.set("scaleX",u.scaleX),s.set("scaleY",u.scaleY),s.angle=u.angle,s.skewX=u.skewX,s.skewY=0,s.setPositionByOrigin({x:u.translateX,y:u.translateY},"center","center"),e.clipPath=s}else delete e.clipPath},w.checkIfDone=function(){0==--this.numElements&&(this.instances=this.instances.filter(function(e){return null!=e}),this.callback(this.instances,this.elements))},function(){"use strict";var e=Pe.fabric||(Pe.fabric={});function n(e,t){this.x=e,this.y=t}e.Point?e.warn("fabric.Point is already defined"):(e.Point=n).prototype={type:"point",constructor:n,add:function(e){return new n(this.x+e.x,this.y+e.y)},addEquals:function(e){return this.x+=e.x,this.y+=e.y,this},scalarAdd:function(e){return new n(this.x+e,this.y+e)},scalarAddEquals:function(e){return this.x+=e,this.y+=e,this},subtract:function(e){return new n(this.x-e.x,this.y-e.y)},subtractEquals:function(e){return this.x-=e.x,this.y-=e.y,this},scalarSubtract:function(e){return new n(this.x-e,this.y-e)},scalarSubtractEquals:function(e){return this.x-=e,this.y-=e,this},multiply:function(e){return new n(this.x*e,this.y*e)},multiplyEquals:function(e){return this.x*=e,this.y*=e,this},divide:function(e){return new n(this.x/e,this.y/e)},divideEquals:function(e){return this.x/=e,this.y/=e,this},eq:function(e){return this.x===e.x&&this.y===e.y},lt:function(e){return this.x<e.x&&this.y<e.y},lte:function(e){return this.x<=e.x&&this.y<=e.y},gt:function(e){return this.x>e.x&&this.y>e.y},gte:function(e){return this.x>=e.x&&this.y>=e.y},lerp:function(e,t){return void 0===t&&(t=.5),t=Math.max(Math.min(1,t),0),new n(this.x+(e.x-this.x)*t,this.y+(e.y-this.y)*t)},distanceFrom:function(e){var t=this.x-e.x,n=this.y-e.y;return Math.sqrt(t*t+n*n)},midPointFrom:function(e){return this.lerp(e)},min:function(e){return new n(Math.min(this.x,e.x),Math.min(this.y,e.y))},max:function(e){return new n(Math.max(this.x,e.x),Math.max(this.y,e.y))},toString:function(){return this.x+","+this.y},setXY:function(e,t){return this.x=e,this.y=t,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setFromPoint:function(e){return this.x=e.x,this.y=e.y,this},swap:function(e){var t=this.x,n=this.y;this.x=e.x,this.y=e.y,e.x=t,e.y=n},clone:function(){return new n(this.x,this.y)}}}(),function(){"use strict";var d=Pe.fabric||(Pe.fabric={});function f(e){this.status=e,this.points=[]}d.Intersection?d.warn("fabric.Intersection is already defined"):(d.Intersection=f,d.Intersection.prototype={constructor:f,appendPoint:function(e){return this.points.push(e),this},appendPoints:function(e){return this.points=this.points.concat(e),this}},d.Intersection.intersectLineLine=function(e,t,n,i){var o,r,s,a=(i.x-n.x)*(e.y-n.y)-(i.y-n.y)*(e.x-n.x),l=(t.x-e.x)*(e.y-n.y)-(t.y-e.y)*(e.x-n.x),c=(i.y-n.y)*(t.x-e.x)-(i.x-n.x)*(t.y-e.y);return 0!=c?(s=l/c,0<=(r=a/c)&&r<=1&&0<=s&&s<=1?(o=new f("Intersection")).appendPoint(new d.Point(e.x+r*(t.x-e.x),e.y+r*(t.y-e.y))):o=new f):o=new f(0==a||0==l?"Coincident":"Parallel"),o},d.Intersection.intersectLinePolygon=function(e,t,n){for(var i,o,r,s=new f,a=n.length,l=0;l<a;l++)i=n[l],o=n[(l+1)%a],r=f.intersectLineLine(e,t,i,o),s.appendPoints(r.points);return 0<s.points.length&&(s.status="Intersection"),s},d.Intersection.intersectPolygonPolygon=function(e,t){for(var n=new f,i=e.length,o=0;o<i;o++){var r=e[o],s=e[(o+1)%i],a=f.intersectLinePolygon(r,s,t);n.appendPoints(a.points)}return 0<n.points.length&&(n.status="Intersection"),n},d.Intersection.intersectPolygonRectangle=function(e,t,n){var i=t.min(n),o=t.max(n),r=new d.Point(o.x,i.y),s=new d.Point(i.x,o.y),a=f.intersectLinePolygon(i,r,e),l=f.intersectLinePolygon(r,o,e),c=f.intersectLinePolygon(o,s,e),u=f.intersectLinePolygon(s,i,e),h=new f;return h.appendPoints(a.points),h.appendPoints(l.points),h.appendPoints(c.points),h.appendPoints(u.points),0<h.points.length&&(h.status="Intersection"),h})}(),function(){"use strict";var c=Pe.fabric||(Pe.fabric={});function u(e){e?this._tryParsingColor(e):this.setSource([0,0,0,1])}function h(e,t,n){return n<0&&(n+=1),1<n&&--n,n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e}c.Color?c.warn("fabric.Color is already defined."):(c.Color=u,c.Color.prototype={_tryParsingColor:function(e){var t;e in u.colorNameMap&&(e=u.colorNameMap[e]),"transparent"===e&&(t=[255,255,255,0]),(t=(t=(t=(t=t||u.sourceFromHex(e))||u.sourceFromRgb(e))||u.sourceFromHsl(e))||[0,0,0,1])&&this.setSource(t)},_rgbToHsl:function(e,t,n){e/=255,t/=255,n/=255;var i,o=c.util.array.max([e,t,n]),r=c.util.array.min([e,t,n]),s=(o+r)/2;if(o===r)i=l=0;else{var a=o-r,l=.5<s?a/(2-o-r):a/(o+r);switch(o){case e:i=(t-n)/a+(t<n?6:0);break;case t:i=(n-e)/a+2;break;case n:i=(e-t)/a+4}i/=6}return[Math.round(360*i),Math.round(100*l),Math.round(100*s)]},getSource:function(){return this._source},setSource:function(e){this._source=e},toRgb:function(){var e=this.getSource();return"rgb("+e[0]+","+e[1]+","+e[2]+")"},toRgba:function(){var e=this.getSource();return"rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")"},toHsl:function(){var e=this.getSource(),t=this._rgbToHsl(e[0],e[1],e[2]);return"hsl("+t[0]+","+t[1]+"%,"+t[2]+"%)"},toHsla:function(){var e=this.getSource(),t=this._rgbToHsl(e[0],e[1],e[2]);return"hsla("+t[0]+","+t[1]+"%,"+t[2]+"%,"+e[3]+")"},toHex:function(){var e=this.getSource(),t=1===(t=e[0].toString(16)).length?"0"+t:t,n=1===(n=e[1].toString(16)).length?"0"+n:n,i=1===(i=e[2].toString(16)).length?"0"+i:i;return t.toUpperCase()+n.toUpperCase()+i.toUpperCase()},toHexa:function(){var e=this.getSource(),t=1===(t=(t=Math.round(255*e[3])).toString(16)).length?"0"+t:t;return this.toHex()+t.toUpperCase()},getAlpha:function(){return this.getSource()[3]},setAlpha:function(e){var t=this.getSource();return t[3]=e,this.setSource(t),this},toGrayscale:function(){var e=this.getSource(),t=parseInt((.3*e[0]+.59*e[1]+.11*e[2]).toFixed(0),10),n=e[3];return this.setSource([t,t,t,n]),this},toBlackWhite:function(e){var t=this.getSource(),n=(.3*t[0]+.59*t[1]+.11*t[2]).toFixed(0),i=t[3];return e=e||127,n=Number(n)<Number(e)?0:255,this.setSource([n,n,n,i]),this},overlayWith:function(e){e instanceof u||(e=new u(e));for(var t=[],n=this.getAlpha(),i=this.getSource(),o=e.getSource(),r=0;r<3;r++)t.push(Math.round(.5*i[r]+.5*o[r]));return t[3]=n,this.setSource(t),this}},c.Color.reRGBa=/^rgba?\(\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*(?:\s*,\s*((?:\d*\.?\d+)?)\s*)?\)$/i,c.Color.reHSLa=/^hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)$/i,c.Color.reHex=/^#?([0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{4}|[0-9a-f]{3})$/i,c.Color.colorNameMap={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},c.Color.fromRgb=function(e){return u.fromSource(u.sourceFromRgb(e))},c.Color.sourceFromRgb=function(e){var t=e.match(u.reRGBa);if(t){var n=parseInt(t[1],10)/(/%$/.test(t[1])?100:1)*(/%$/.test(t[1])?255:1),i=parseInt(t[2],10)/(/%$/.test(t[2])?100:1)*(/%$/.test(t[2])?255:1),o=parseInt(t[3],10)/(/%$/.test(t[3])?100:1)*(/%$/.test(t[3])?255:1);return[parseInt(n,10),parseInt(i,10),parseInt(o,10),t[4]?parseFloat(t[4]):1]}},c.Color.fromRgba=u.fromRgb,c.Color.fromHsl=function(e){return u.fromSource(u.sourceFromHsl(e))},c.Color.sourceFromHsl=function(e){var t=e.match(u.reHSLa);if(t){var n,i,o,r,s,a=(parseFloat(t[1])%360+360)%360/360,l=parseFloat(t[2])/(/%$/.test(t[2])?100:1),c=parseFloat(t[3])/(/%$/.test(t[3])?100:1);return 0==l?o=r=s=c:(o=h(i=2*c-(n=c<=.5?c*(1+l):c+l-c*l),n,a+1/3),r=h(i,n,a),s=h(i,n,a-1/3)),[Math.round(255*o),Math.round(255*r),Math.round(255*s),t[4]?parseFloat(t[4]):1]}},c.Color.fromHsla=u.fromHsl,c.Color.fromHex=function(e){return u.fromSource(u.sourceFromHex(e))},c.Color.sourceFromHex=function(e){if(e.match(u.reHex)){var t=e.slice(e.indexOf("#")+1),n=3===t.length||4===t.length,i=8===t.length||4===t.length,o=n?t.charAt(0)+t.charAt(0):t.substring(0,2),r=n?t.charAt(1)+t.charAt(1):t.substring(2,4),s=n?t.charAt(2)+t.charAt(2):t.substring(4,6),a=i?n?t.charAt(3)+t.charAt(3):t.substring(6,8):"FF";return[parseInt(o,16),parseInt(r,16),parseInt(s,16),parseFloat((parseInt(a,16)/255).toFixed(2))]}},c.Color.fromSource=function(e){var t=new u;return t.setSource(e),t})}(),function(){"use strict";var u=Pe.fabric||(Pe.fabric={}),s=["e","se","s","sw","w","nw","n","ne","e"],r=["ns","nesw","ew","nwse"],o={},d="left",f="top",p="right",g="bottom",l="center",_={top:g,bottom:f,left:p,right:d,center:l},m=u.util.radiansToDegrees,E=Math.sign||function(e){return(0<e)-(e<0)||+e};function a(e,t){var n=e.angle+m(Math.atan2(t.y,t.x))+360;return Math.round(n%360/45)}function T(e,t){var n=t.transform.target,i=n.canvas,o=Object.assign({},t,{target:n});i&&i.fire("object:"+e,o),n.fire(e,t)}function k(e,t){var n=t.canvas,i=e[n.uniScaleKey];return n.uniformScaling&&!i||!n.uniformScaling&&i}function O(e){return e.originX===l&&e.originY===l}function A(e,t,n){var i=e.lockScalingX,o=e.lockScalingY;return!((!i||!o)&&(t||!i&&!o||!n)&&(!i||"x"!==t)&&(!o||"y"!==t))}function P(e,t,n,i){return{e:e,transform:t,pointer:{x:n,y:i}}}function c(l){return function(e,t,n,i){var o=t.target,r=o.getCenterPoint(),s=o.translateToOriginPoint(r,t.originX,t.originY),a=l(e,t,n,i);return o.setPositionByOrigin(s,t.originX,t.originY),a}}function N(e,t,n,i,o){var r=e.target,s=r.controls[e.corner],a=r.canvas.getZoom(),l=r.padding/a,c=r.toLocalPoint(new u.Point(i,o),t,n);return c.x>=l&&(c.x-=l),c.x<=-l&&(c.x+=l),c.y>=l&&(c.y-=l),c.y<=l&&(c.y+=l),c.x-=s.offsetX,c.y-=s.offsetY,c}function v(e){return e.flipX&&!e.flipY||!e.flipX&&e.flipY}function y(e,t,n,i,o){var r;0!==e[t]&&(r=o/e._getTransformedDimensions()[i]*e[n],e.set(n,r))}function h(e,t,n,i){var o,r=t.target,s=r._getTransformedDimensions(0,r.skewY),a=N(t,t.originX,t.originY,n,i),l=Math.abs(2*a.x)-s.x,c=r.skewX;l<2?o=0:(o=m(Math.atan2(l/r.scaleX,s.y/r.scaleY)),t.originX===d&&t.originY===g&&(o=-o),t.originX===p&&t.originY===f&&(o=-o),v(r)&&(o=-o));var u,h=c!==o;return h&&(u=r._getTransformedDimensions().y,r.set("skewX",o),y(r,"skewY","scaleY","y",u),T("skewing",P(e,t,n,i))),h}function b(e,t,n,i){var o,r=t.target,s=r._getTransformedDimensions(r.skewX,0),a=N(t,t.originX,t.originY,n,i),l=Math.abs(2*a.y)-s.y,c=r.skewY;l<2?o=0:(o=m(Math.atan2(l/r.scaleY,s.x/r.scaleX)),t.originX===d&&t.originY===g&&(o=-o),t.originX===p&&t.originY===f&&(o=-o),v(r)&&(o=-o));var u,h=c!==o;return h&&(u=r._getTransformedDimensions().x,r.set("skewY",o),y(r,"skewX","scaleX","x",u),T("skewing",P(e,t,n,i))),h}function C(e,t,n,i,o){o=o||{};var r,s,a,l=t.target,c=l.lockScalingX,u=l.lockScalingY,h=o.by,d=k(e,l),f=A(l,h,d),p=t.gestureScale;if(f)return!1;if(p)b=t.scaleX*p,x=t.scaleY*p;else{if(r=N(t,t.originX,t.originY,n,i),s="y"!==h?E(r.x):1,a="x"!==h?E(r.y):1,t.signX||(t.signX=s),t.signY||(t.signY=a),l.lockScalingFlip&&(t.signX!==s||t.signY!==a))return!1;var g,m,v,y,b,C=l._getTransformedDimensions(),x=d&&!h?(g=Math.abs(r.x)+Math.abs(r.y),m=t.original,v=g/(Math.abs(C.x*m.scaleX/l.scaleX)+Math.abs(C.y*m.scaleY/l.scaleY)),b=m.scaleX*v,m.scaleY*v):(b=Math.abs(r.x*l.scaleX/C.x),Math.abs(r.y*l.scaleY/C.y));O(t)&&(b*=2,x*=2),t.signX!==s&&"y"!==h&&(t.originX=_[t.originX],b*=-1,t.signX=s),t.signY!==a&&"x"!==h&&(t.originY=_[t.originY],x*=-1,t.signY=a)}var w=l.scaleX,S=l.scaleY;return h?("x"===h&&l.set("scaleX",b),"y"===h&&l.set("scaleY",x)):(c||l.set("scaleX",b),u||l.set("scaleY",x)),(y=w!==l.scaleX||S!==l.scaleY)&&T("scaling",P(e,t,n,i)),y}o.scaleCursorStyleHandler=function(e,t,n){var i=k(e,n),o="";if(0!==t.x&&0===t.y?o="x":0===t.x&&0!==t.y&&(o="y"),A(n,o,i))return"not-allowed";var r=a(n,t);return s[r]+"-resize"},o.skewCursorStyleHandler=function(e,t,n){var i="not-allowed";if(0!==t.x&&n.lockSkewingY)return i;if(0!==t.y&&n.lockSkewingX)return i;var o=a(n,t)%4;return r[o]+"-resize"},o.scaleSkewCursorStyleHandler=function(e,t,n){return e[n.canvas.altActionKey]?o.skewCursorStyleHandler(e,t,n):o.scaleCursorStyleHandler(e,t,n)},o.rotationWithSnapping=c(function(e,t,n,i){var o=t,r=o.target,s=r.translateToOriginPoint(r.getCenterPoint(),o.originX,o.originY);if(r.lockRotation)return!1;var a,l,c,u,h,d=Math.atan2(o.ey-s.y,o.ex-s.x),f=Math.atan2(i-s.y,n-s.x),p=m(f-d+o.theta);return 0<r.snapAngle&&(l=r.snapAngle,c=r.snapThreshold||l,u=Math.ceil(p/l)*l,h=Math.floor(p/l)*l,Math.abs(p-h)<c?p=h:Math.abs(p-u)<c&&(p=u)),p<0&&(p=360+p),p%=360,a=r.angle!==p,r.angle=p,a&&T("rotating",P(e,t,n,i)),a}),o.scalingEqually=c(function(e,t,n,i){return C(e,t,n,i)}),o.scalingX=c(function(e,t,n,i){return C(e,t,n,i,{by:"x"})}),o.scalingY=c(function(e,t,n,i){return C(e,t,n,i,{by:"y"})}),o.scalingYOrSkewingX=function(e,t,n,i){return e[t.target.canvas.altActionKey]?o.skewHandlerX(e,t,n,i):o.scalingY(e,t,n,i)},o.scalingXOrSkewingY=function(e,t,n,i){return e[t.target.canvas.altActionKey]?o.skewHandlerY(e,t,n,i):o.scalingX(e,t,n,i)},o.changeWidth=c(function(e,t,n,i){var o=t.target,r=N(t,t.originX,t.originY,n,i),s=o.strokeWidth/(o.strokeUniform?o.scaleX:1),a=O(t)?2:1,l=Math.abs(r.x*a/o.scaleX)-s;return o.set("width",Math.max(l,0)),!0}),o.skewHandlerX=function(e,t,n,i){var o,r=t.target,s=r.skewX,a=t.originY;return!r.lockSkewingX&&(0===s?o=0<N(t,l,l,n,i).x?d:p:(0<s&&(o=a===f?d:p),s<0&&(o=a===f?p:d),v(r)&&(o=o===d?p:d)),t.originX=o,c(h)(e,t,n,i))},o.skewHandlerY=function(e,t,n,i){var o,r=t.target,s=r.skewY,a=t.originX;return!r.lockSkewingY&&(0===s?o=0<N(t,l,l,n,i).y?f:g:(0<s&&(o=a===d?f:g),s<0&&(o=a===d?g:f),v(r)&&(o=o===f?g:f)),t.originY=o,c(b)(e,t,n,i))},o.scaleOrSkewActionName=function(e,t,n){var i=e[n.canvas.altActionKey];return 0===t.x?i?"skewX":"scaleY":0===t.y?i?"skewY":"scaleX":void 0},o.rotationStyleHandler=function(e,t,n){return n.lockRotation?"not-allowed":t.cursorStyle},o.fireEvent=T,o.wrapWithFixedAnchor=c,o.getLocalPoint=N,u.controlsUtils=o}(),function(){"use strict";var e=Pe.fabric||(Pe.fabric={}),u=e.util.degreesToRadians,t=e.controlsUtils;t.renderCircleControl=function(e,t,n,i,o){var r=(i=i||{}).cornerSize||o.cornerSize,s=void 0!==i.transparentCorners?i.transparentCorners:this.transparentCorners,a=s?"stroke":"fill",l=!s&&(i.cornerStrokeColor||o.cornerStrokeColor);e.save(),e.fillStyle=i.cornerColor||o.cornerColor,e.strokeStyle=i.cornerStrokeColor||o.cornerStrokeColor,e.lineWidth=1,e.beginPath(),e.arc(t,n,r/2,0,2*Math.PI,!1),e[a](),l&&e.stroke(),e.restore()},t.renderSquareControl=function(e,t,n,i,o){var r=(i=i||{}).cornerSize||o.cornerSize,s=void 0!==i.transparentCorners?i.transparentCorners:o.transparentCorners,a=s?"stroke":"fill",l=!s&&(i.cornerStrokeColor||o.cornerStrokeColor),c=r/2;e.save(),e.fillStyle=i.cornerColor||o.cornerColor,e.strokeStyle=i.strokeCornerColor||o.strokeCornerColor,e.lineWidth=1,e.translate(t,n),e.rotate(u(o.angle)),e[a+"Rect"](-c,-c,r,r),l&&e.strokeRect(-c,-c,r,r),e.restore()}}(),function(){"use strict";var r=Pe.fabric||(Pe.fabric={});r.Control=function(e){for(var t in e)this[t]=e[t]},r.Control.prototype={visible:!0,actionName:"scale",angle:0,x:0,y:0,offsetX:0,offsetY:0,cursorStyle:"crosshair",withConnection:!1,actionHandler:function(){},mouseDownHandler:function(){},mouseUpHandler:function(){},getActionHandler:function(){return this.actionHandler},getMouseDownHandler:function(){return this.mouseDownHandler},getMouseUpHandler:function(){return this.mouseUpHandler},cursorStyleHandler:function(e,t){return t.cursorStyle},getActionName:function(e,t){return t.actionName},getVisibility:function(e,t){var n=e._controlsVisibility;return n&&void 0!==n[t]?n[t]:this.visible},setVisibility:function(e){this.visible=e},positionHandler:function(e,t){return r.util.transformPoint({x:this.x*e.x+this.offsetX,y:this.y*e.y+this.offsetY},t)},render:function(e,t,n,i,o){"circle"===((i=i||{}).cornerStyle||o.cornerStyle)?r.controlsUtils.renderCircleControl.call(this,e,t,n,i,o):r.controlsUtils.renderSquareControl.call(this,e,t,n,i,o)}}}(),S=Q.util.object.clone,Q.Gradient=Q.util.createClass({offsetX:0,offsetY:0,gradientTransform:null,gradientUnits:"pixels",type:"linear",initialize:function(t){(t=t||{}).coords||(t.coords={});var e,n=this;Object.keys(t).forEach(function(e){n[e]=t[e]}),this.id?this.id+="_"+Q.Object.__uid++:this.id=Q.Object.__uid++,e={x1:t.coords.x1||0,y1:t.coords.y1||0,x2:t.coords.x2||0,y2:t.coords.y2||0},"radial"===this.type&&(e.r1=t.coords.r1||0,e.r2=t.coords.r2||0),this.coords=e,this.colorStops=t.colorStops.slice()},addColorStop:function(e){for(var t in e){var n=new Q.Color(e[t]);this.colorStops.push({offset:parseFloat(t),color:n.toRgb(),opacity:n.getAlpha()})}return this},toObject:function(e){var t={type:this.type,coords:this.coords,colorStops:this.colorStops,offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?this.gradientTransform.concat():this.gradientTransform};return Q.util.populateWithProperties(this,t,e),t},toSVG:function(e,t){var n,i,o=S(this.coords,!0),t=t||{},r=S(this.colorStops,!0),s=o.r1>o.r2,a=this.gradientTransform?this.gradientTransform.concat():Q.iMatrix.concat(),l=-this.offsetX,c=-this.offsetY,u=!!t.additionalTransform,h="pixels"===this.gradientUnits?"userSpaceOnUse":"objectBoundingBox";if(r.sort(function(e,t){return e.offset-t.offset}),"objectBoundingBox"==h?(l/=e.width,c/=e.height):(l+=e.width/2,c+=e.height/2),"path"===e.type&&(l-=e.pathOffset.x,c-=e.pathOffset.y),a[4]-=l,a[5]-=c,i='id="SVGID_'+this.id+'" gradientUnits="'+h+'"',i+=' gradientTransform="'+(u?t.additionalTransform+" ":"")+Q.util.matrixToSVG(a)+'" ',"linear"===this.type?n=["<linearGradient ",i,' x1="',o.x1,'" y1="',o.y1,'" x2="',o.x2,'" y2="',o.y2,'">\n']:"radial"===this.type&&(n=["<radialGradient ",i,' cx="',s?o.x1:o.x2,'" cy="',s?o.y1:o.y2,'" r="',s?o.r1:o.r2,'" fx="',s?o.x2:o.x1,'" fy="',s?o.y2:o.y1,'">\n']),"radial"===this.type){if(s)for((r=r.concat()).reverse(),p=0,g=r.length;p<g;p++)r[p].offset=1-r[p].offset;var d=Math.min(o.r1,o.r2);if(0<d)for(var f=d/Math.max(o.r1,o.r2),p=0,g=r.length;p<g;p++)r[p].offset+=f*(1-r[p].offset)}for(p=0,g=r.length;p<g;p++){var m=r[p];n.push("<stop ",'offset="',100*m.offset+"%",'" style="stop-color:',m.color,void 0!==m.opacity?";stop-opacity: "+m.opacity:";",'"/>\n')}return n.push("linear"===this.type?"</linearGradient>\n":"</radialGradient>\n"),n.join("")},toLive:function(e){var t,n,i,o=Q.util.object.clone(this.coords);if(this.type){for("linear"===this.type?t=e.createLinearGradient(o.x1,o.y1,o.x2,o.y2):"radial"===this.type&&(t=e.createRadialGradient(o.x1,o.y1,o.r1,o.x2,o.y2,o.r2)),n=0,i=this.colorStops.length;n<i;n++){var r=this.colorStops[n].color,s=this.colorStops[n].opacity,a=this.colorStops[n].offset;void 0!==s&&(r=new Q.Color(r).setAlpha(s).toRgba()),t.addColorStop(a,r)}return t}}}),Q.util.object.extend(Q.Gradient,{fromElement:function(e,t,n,i){var o=(o=parseFloat(n)/(/%$/.test(n)?100:1))<0?0:1<o?1:o;isNaN(o)&&(o=1);for(var r,s,a,l,c,u,h,d,f,p=e.getElementsByTagName("stop"),g="userSpaceOnUse"===e.getAttribute("gradientUnits")?"pixels":"percentage",m=e.getAttribute("gradientTransform")||"",v=[],y=0,b=0,C="linearGradient"===e.nodeName||"LINEARGRADIENT"===e.nodeName?(r="linear",{x1:(l=e).getAttribute("x1")||0,y1:l.getAttribute("y1")||0,x2:l.getAttribute("x2")||"100%",y2:l.getAttribute("y2")||0}):(r="radial",{x1:(a=e).getAttribute("fx")||a.getAttribute("cx")||"50%",y1:a.getAttribute("fy")||a.getAttribute("cy")||"50%",r1:0,x2:a.getAttribute("cx")||"50%",y2:a.getAttribute("cy")||"50%",r2:a.getAttribute("r")||"50%"}),x=p.length;x--;)v.push(function(e,t){var n,i,o,r,s=e.getAttribute("style"),a=e.getAttribute("offset")||0,a=(a=parseFloat(a)/(/%$/.test(a)?100:1))<0?0:1<a?1:a;if(s){var l=s.split(/\s*;\s*/);for(""===l[l.length-1]&&l.pop(),r=l.length;r--;){var c=l[r].split(/\s*:\s*/),u=c[0].trim(),h=c[1].trim();"stop-color"===u?n=h:"stop-opacity"===u&&(o=h)}}return n=n||e.getAttribute("stop-color")||"rgb(0,0,0)",o=o||e.getAttribute("stop-opacity"),i=(n=new Q.Color(n)).getAlpha(),o=isNaN(parseFloat(o))?1:parseFloat(o),o*=i*t,{offset:a,color:n.toRgb(),opacity:o}}(p[x],o));return s=Q.parseTransformAttribute(m),c=C,u=i,h=g,Object.keys(c).forEach(function(e){"Infinity"===(d=c[e])?f=1:"-Infinity"===d?f=0:(f=parseFloat(c[e],10),"string"==typeof d&&/^(\d+\.\d+)%|(\d+)%$/.test(d)&&(f*=.01,"pixels"==h&&("x1"!==e&&"x2"!==e&&"r2"!==e||(f*=u.viewBoxWidth||u.width),"y1"!==e&&"y2"!==e||(f*=u.viewBoxHeight||u.height)))),c[e]=f}),"pixels"==g&&(y=-t.left,b=-t.top),new Q.Gradient({id:e.getAttribute("id"),type:r,coords:C,colorStops:v,gradientUnits:g,gradientTransform:s,offsetX:y,offsetY:b})}}),function(){"use strict";var o=Q.util.toFixed;Q.Pattern=Q.util.createClass({repeat:"repeat",offsetX:0,offsetY:0,crossOrigin:"",patternTransform:null,initialize:function(e,n){var i;e=e||{},this.id=Q.Object.__uid++,this.setOptions(e),!e.source||e.source&&"string"!=typeof e.source?n&&n(this):((i=this).source=Q.util.createImage(),Q.util.loadImage(e.source,function(e,t){i.source=e,n&&n(i,t)},null,this.crossOrigin))},toObject:function(e){var t,n,i=Q.Object.NUM_FRACTION_DIGITS;return"string"==typeof this.source.src?t=this.source.src:"object"==typeof this.source&&this.source.toDataURL&&(t=this.source.toDataURL()),n={type:"pattern",source:t,repeat:this.repeat,crossOrigin:this.crossOrigin,offsetX:o(this.offsetX,i),offsetY:o(this.offsetY,i),patternTransform:this.patternTransform?this.patternTransform.concat():null},Q.util.populateWithProperties(this,n,e),n},toSVG:function(e){var t="function"==typeof this.source?this.source():this.source,n=t.width/e.width,i=t.height/e.height,o=this.offsetX/e.width,r=this.offsetY/e.height,s="";return"repeat-x"!==this.repeat&&"no-repeat"!==this.repeat||(i=1,r&&(i+=Math.abs(r))),"repeat-y"!==this.repeat&&"no-repeat"!==this.repeat||(n=1,o&&(n+=Math.abs(o))),t.src?s=t.src:t.toDataURL&&(s=t.toDataURL()),'<pattern id="SVGID_'+this.id+'" x="'+o+'" y="'+r+'" width="'+n+'" height="'+i+'">\n<image x="0" y="0" width="'+t.width+'" height="'+t.height+'" xlink:href="'+s+'"></image>\n</pattern>\n'},setOptions:function(e){for(var t in e)this[t]=e[t]},toLive:function(e){var t=this.source;if(!t)return"";if(void 0!==t.src){if(!t.complete)return"";if(0===t.naturalWidth||0===t.naturalHeight)return""}return e.createPattern(t,this.repeat)}})}(),function(){"use strict";var s=Pe.fabric||(Pe.fabric={}),a=s.util.toFixed;s.Shadow?s.warn("fabric.Shadow is already defined."):(s.Shadow=s.util.createClass({color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1,initialize:function(e){for(var t in"string"==typeof e&&(e=this._parseShadow(e)),e)this[t]=e[t];this.id=s.Object.__uid++},_parseShadow:function(e){var t=e.trim(),n=s.Shadow.reOffsetsAndBlur.exec(t)||[];return{color:(t.replace(s.Shadow.reOffsetsAndBlur,"")||"rgb(0,0,0)").trim(),offsetX:parseInt(n[1],10)||0,offsetY:parseInt(n[2],10)||0,blur:parseInt(n[3],10)||0}},toString:function(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")},toSVG:function(e){var t=40,n=40,i=s.Object.NUM_FRACTION_DIGITS,o=s.util.rotateVector({x:this.offsetX,y:this.offsetY},s.util.degreesToRadians(-e.angle)),r=new s.Color(this.color);return e.width&&e.height&&(t=100*a((Math.abs(o.x)+this.blur)/e.width,i)+20,n=100*a((Math.abs(o.y)+this.blur)/e.height,i)+20),e.flipX&&(o.x*=-1),e.flipY&&(o.y*=-1),'<filter id="SVGID_'+this.id+'" y="-'+n+'%" height="'+(100+2*n)+'%" x="-'+t+'%" width="'+(100+2*t)+'%" >\n\t<feGaussianBlur in="SourceAlpha" stdDeviation="'+a(this.blur?this.blur/2:0,i)+'"></feGaussianBlur>\n\t<feOffset dx="'+a(o.x,i)+'" dy="'+a(o.y,i)+'" result="oBlur" ></feOffset>\n\t<feFlood flood-color="'+r.toRgb()+'" flood-opacity="'+r.getAlpha()+'"/>\n\t<feComposite in2="oBlur" operator="in" />\n\t<feMerge>\n\t\t<feMergeNode></feMergeNode>\n\t\t<feMergeNode in="SourceGraphic"></feMergeNode>\n\t</feMerge>\n</filter>\n'},toObject:function(){if(this.includeDefaultValues)return{color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling};var t={},n=s.Shadow.prototype;return["color","blur","offsetX","offsetY","affectStroke","nonScaling"].forEach(function(e){this[e]!==n[e]&&(t[e]=this[e])},this),t}}),s.Shadow.reOffsetsAndBlur=/(?:\s|^)(-?\d+(?:px)?(?:\s?|$))?(-?\d+(?:px)?(?:\s?|$))?(\d+(?:px)?)?(?:\s?|$)(?:$|\s)/)}(),function(){"use strict";var o,e,c,a,r,s,n,i,t;Q.StaticCanvas?Q.warn("fabric.StaticCanvas is already defined."):(o=Q.util.object.extend,e=Q.util.getElementOffset,c=Q.util.removeFromArray,a=Q.util.toFixed,r=Q.util.transformPoint,s=Q.util.invertTransform,n=Q.util.getNodeCanvas,i=Q.util.createCanvasElement,t=new Error("Could not initialize `canvas` element"),Q.StaticCanvas=Q.util.createClass(Q.CommonMethods,{initialize:function(e,t){t=t||{},this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(e,t)},backgroundColor:"",backgroundImage:null,overlayColor:"",overlayImage:null,includeDefaultValues:!0,stateful:!1,renderOnAddRemove:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,imageSmoothingEnabled:!0,viewportTransform:Q.iMatrix.concat(),backgroundVpt:!0,overlayVpt:!0,enableRetinaScaling:!0,vptCoords:{},skipOffscreen:!0,clipPath:void 0,_initStatic:function(e,t){var n=this.requestRenderAllBound;this._objects=[],this._createLowerCanvas(e),this._initOptions(t),this.interactive||this._initRetinaScaling(),t.overlayImage&&this.setOverlayImage(t.overlayImage,n),t.backgroundImage&&this.setBackgroundImage(t.backgroundImage,n),t.backgroundColor&&this.setBackgroundColor(t.backgroundColor,n),t.overlayColor&&this.setOverlayColor(t.overlayColor,n),this.calcOffset()},_isRetinaScaling:function(){return 1!==Q.devicePixelRatio&&this.enableRetinaScaling},getRetinaScaling:function(){return this._isRetinaScaling()?Q.devicePixelRatio:1},_initRetinaScaling:function(){var e;this._isRetinaScaling()&&(e=Q.devicePixelRatio,this.__initRetinaScaling(e,this.lowerCanvasEl,this.contextContainer),this.upperCanvasEl&&this.__initRetinaScaling(e,this.upperCanvasEl,this.contextTop))},__initRetinaScaling:function(e,t,n){t.setAttribute("width",this.width*e),t.setAttribute("height",this.height*e),n.scale(e,e)},calcOffset:function(){return this._offset=e(this.lowerCanvasEl),this},setOverlayImage:function(e,t,n){return this.__setBgOverlayImage("overlayImage",e,t,n)},setBackgroundImage:function(e,t,n){return this.__setBgOverlayImage("backgroundImage",e,t,n)},setOverlayColor:function(e,t){return this.__setBgOverlayColor("overlayColor",e,t)},setBackgroundColor:function(e,t){return this.__setBgOverlayColor("backgroundColor",e,t)},__setBgOverlayImage:function(i,e,o,r){return"string"==typeof e?Q.util.loadImage(e,function(e,t){var n;e&&(n=new Q.Image(e,r),(this[i]=n).canvas=this),o&&o(e,t)},this,r&&r.crossOrigin):(r&&e.setOptions(r),(this[i]=e)&&(e.canvas=this),o&&o(e,!1)),this},__setBgOverlayColor:function(e,t,n){return this[e]=t,this._initGradient(t,e),this._initPattern(t,e,n),this},_createCanvasElement:function(){var e=i();if(!e)throw t;if(e.style||(e.style={}),void 0===e.getContext)throw t;return e},_initOptions:function(e){var t=this.lowerCanvasEl;this._setOptions(e),this.width=this.width||parseInt(t.width,10)||0,this.height=this.height||parseInt(t.height,10)||0,this.lowerCanvasEl.style&&(t.width=this.width,t.height=this.height,t.style.width=this.width+"px",t.style.height=this.height+"px",this.viewportTransform=this.viewportTransform.slice())},_createLowerCanvas:function(e){e&&e.getContext?this.lowerCanvasEl=e:this.lowerCanvasEl=Q.util.getById(e)||this._createCanvasElement(),Q.util.addClass(this.lowerCanvasEl,"lower-canvas"),this.interactive&&this._applyCanvasStyle(this.lowerCanvasEl),this.contextContainer=this.lowerCanvasEl.getContext("2d")},getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(e,t){return this.setDimensions({width:e},t)},setHeight:function(e,t){return this.setDimensions({height:e},t)},setDimensions:function(e,t){var n;for(var i in t=t||{},e)n=e[i],t.cssOnly||(this._setBackstoreDimension(i,e[i]),n+="px",this.hasLostContext=!0),t.backstoreOnly||this._setCssDimension(i,n);return this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(),this._initRetinaScaling(),this.calcOffset(),t.cssOnly||this.requestRenderAll(),this},_setBackstoreDimension:function(e,t){return this.lowerCanvasEl[e]=t,this.upperCanvasEl&&(this.upperCanvasEl[e]=t),this.cacheCanvasEl&&(this.cacheCanvasEl[e]=t),this[e]=t,this},_setCssDimension:function(e,t){return this.lowerCanvasEl.style[e]=t,this.upperCanvasEl&&(this.upperCanvasEl.style[e]=t),this.wrapperEl&&(this.wrapperEl.style[e]=t),this},getZoom:function(){return this.viewportTransform[0]},setViewportTransform:function(e){var t,n,i,o=this._activeObject;for(this.viewportTransform=e,n=0,i=this._objects.length;n<i;n++)(t=this._objects[n]).group||t.setCoords(!0);return o&&o.setCoords(),this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll(),this},zoomToPoint:function(e,t){var n=e,i=this.viewportTransform.slice(0);e=r(e,s(this.viewportTransform)),i[0]=t,i[3]=t;var o=r(e,i);return i[4]+=n.x-o.x,i[5]+=n.y-o.y,this.setViewportTransform(i)},setZoom:function(e){return this.zoomToPoint(new Q.Point(0,0),e),this},absolutePan:function(e){var t=this.viewportTransform.slice(0);return t[4]=-e.x,t[5]=-e.y,this.setViewportTransform(t)},relativePan:function(e){return this.absolutePan(new Q.Point(-e.x-this.viewportTransform[4],-e.y-this.viewportTransform[5]))},getElement:function(){return this.lowerCanvasEl},_onObjectAdded:function(e){this.stateful&&e.setupState(),e._set("canvas",this),e.setCoords(),this.fire("object:added",{target:e}),e.fire("added")},_onObjectRemoved:function(e){this.fire("object:removed",{target:e}),e.fire("removed"),delete e.canvas},clearContext:function(e){return e.clearRect(0,0,this.width,this.height),this},getContext:function(){return this.contextContainer},clear:function(){return this._objects.length=0,this.backgroundImage=null,this.overlayImage=null,this.backgroundColor="",this.overlayColor="",this._hasITextHandlers&&(this.off("mouse:up",this._mouseUpITextHandler),this._iTextInstances=null,this._hasITextHandlers=!1),this.clearContext(this.contextContainer),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll(),this},renderAll:function(){var e=this.contextContainer;return this.renderCanvas(e,this._objects),this},renderAndReset:function(){this.isRendering=0,this.renderAll()},requestRenderAll:function(){return this.isRendering||(this.isRendering=Q.util.requestAnimFrame(this.renderAndResetBound)),this},calcViewportBoundaries:function(){var e={},t=this.width,n=this.height,i=s(this.viewportTransform);return e.tl=r({x:0,y:0},i),e.br=r({x:t,y:n},i),e.tr=new Q.Point(e.br.x,e.tl.y),e.bl=new Q.Point(e.tl.x,e.br.y),this.vptCoords=e},cancelRequestedRender:function(){this.isRendering&&(Q.util.cancelAnimFrame(this.isRendering),this.isRendering=0)},renderCanvas:function(e,t){var n=this.viewportTransform,i=this.clipPath;this.cancelRequestedRender(),this.calcViewportBoundaries(),this.clearContext(e),Q.util.setImageSmoothing(e,this.imageSmoothingEnabled),this.fire("before:render",{ctx:e}),this._renderBackground(e),e.save(),e.transform(n[0],n[1],n[2],n[3],n[4],n[5]),this._renderObjects(e,t),e.restore(),!this.controlsAboveOverlay&&this.interactive&&this.drawControls(e),i&&(i.canvas=this,i.shouldCache(),i._transformDone=!0,i.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(e)),this._renderOverlay(e),this.controlsAboveOverlay&&this.interactive&&this.drawControls(e),this.fire("after:render",{ctx:e})},drawClipPathOnCanvas:function(e){var t=this.viewportTransform,n=this.clipPath;e.save(),e.transform(t[0],t[1],t[2],t[3],t[4],t[5]),e.globalCompositeOperation="destination-in",n.transform(e),e.scale(1/n.zoomX,1/n.zoomY),e.drawImage(n._cacheCanvas,-n.cacheTranslationX,-n.cacheTranslationY),e.restore()},_renderObjects:function(e,t){for(var n=0,i=t.length;n<i;++n)t[n]&&t[n].render(e)},_renderBackgroundOrOverlay:function(e,t){var n,i=this[t+"Color"],o=this[t+"Image"],r=this.viewportTransform,s=this[t+"Vpt"];(i||o)&&(i&&(e.save(),e.beginPath(),e.moveTo(0,0),e.lineTo(this.width,0),e.lineTo(this.width,this.height),e.lineTo(0,this.height),e.closePath(),e.fillStyle=i.toLive?i.toLive(e,this):i,s&&e.transform(r[0],r[1],r[2],r[3],r[4],r[5]),e.transform(1,0,0,1,i.offsetX||0,i.offsetY||0),(n=i.gradientTransform||i.patternTransform)&&e.transform(n[0],n[1],n[2],n[3],n[4],n[5]),e.fill(),e.restore()),o&&(e.save(),s&&e.transform(r[0],r[1],r[2],r[3],r[4],r[5]),o.render(e),e.restore()))},_renderBackground:function(e){this._renderBackgroundOrOverlay(e,"background")},_renderOverlay:function(e){this._renderBackgroundOrOverlay(e,"overlay")},getCenter:function(){return{top:this.height/2,left:this.width/2}},centerObjectH:function(e){return this._centerObject(e,new Q.Point(this.getCenter().left,e.getCenterPoint().y))},centerObjectV:function(e){return this._centerObject(e,new Q.Point(e.getCenterPoint().x,this.getCenter().top))},centerObject:function(e){var t=this.getCenter();return this._centerObject(e,new Q.Point(t.left,t.top))},viewportCenterObject:function(e){var t=this.getVpCenter();return this._centerObject(e,t)},viewportCenterObjectH:function(e){var t=this.getVpCenter();return this._centerObject(e,new Q.Point(t.x,e.getCenterPoint().y)),this},viewportCenterObjectV:function(e){var t=this.getVpCenter();return this._centerObject(e,new Q.Point(e.getCenterPoint().x,t.y))},getVpCenter:function(){var e=this.getCenter(),t=s(this.viewportTransform);return r({x:e.left,y:e.top},t)},_centerObject:function(e,t){return e.setPositionByOrigin(t,"center","center"),e.setCoords(),this.renderOnAddRemove&&this.requestRenderAll(),this},toDatalessJSON:function(e){return this.toDatalessObject(e)},toObject:function(e){return this._toObjectMethod("toObject",e)},toDatalessObject:function(e){return this._toObjectMethod("toDatalessObject",e)},_toObjectMethod:function(e,t){var n=this.clipPath,i={version:Q.version,objects:this._toObjects(e,t)};return n&&(i.clipPath=this._toObject(this.clipPath,e,t)),o(i,this.__serializeBgOverlay(e,t)),Q.util.populateWithProperties(this,i,t),i},_toObjects:function(t,n){return this._objects.filter(function(e){return!e.excludeFromExport}).map(function(e){return this._toObject(e,t,n)},this)},_toObject:function(e,t,n){var i;this.includeDefaultValues||(i=e.includeDefaultValues,e.includeDefaultValues=!1);var o=e[t](n);return this.includeDefaultValues||(e.includeDefaultValues=i),o},__serializeBgOverlay:function(e,t){var n={},i=this.backgroundImage,o=this.overlayImage;return this.backgroundColor&&(n.background=this.backgroundColor.toObject?this.backgroundColor.toObject(t):this.backgroundColor),this.overlayColor&&(n.overlay=this.overlayColor.toObject?this.overlayColor.toObject(t):this.overlayColor),i&&!i.excludeFromExport&&(n.backgroundImage=this._toObject(i,e,t)),o&&!o.excludeFromExport&&(n.overlayImage=this._toObject(o,e,t)),n},svgViewportTransformation:!0,toSVG:function(e,t){(e=e||{}).reviver=t;var n=[];return this._setSVGPreamble(n,e),this._setSVGHeader(n,e),this.clipPath&&n.push('<g clip-path="url(#'+this.clipPath.clipPathId+')" >\n'),this._setSVGBgOverlayColor(n,"background"),this._setSVGBgOverlayImage(n,"backgroundImage",t),this._setSVGObjects(n,t),this.clipPath&&n.push("</g>\n"),this._setSVGBgOverlayColor(n,"overlay"),this._setSVGBgOverlayImage(n,"overlayImage",t),n.push("</svg>"),n.join("")},_setSVGPreamble:function(e,t){t.suppressPreamble||e.push('<?xml version="1.0" encoding="',t.encoding||"UTF-8",'" standalone="no" ?>\n','<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ','"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n')},_setSVGHeader:function(e,t){var n,i=t.width||this.width,o=t.height||this.height,r='viewBox="0 0 '+this.width+" "+this.height+'" ',s=Q.Object.NUM_FRACTION_DIGITS;t.viewBox?r='viewBox="'+t.viewBox.x+" "+t.viewBox.y+" "+t.viewBox.width+" "+t.viewBox.height+'" ':this.svgViewportTransformation&&(n=this.viewportTransform,r='viewBox="'+a(-n[4]/n[0],s)+" "+a(-n[5]/n[3],s)+" "+a(this.width/n[0],s)+" "+a(this.height/n[3],s)+'" '),e.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',i,'" ','height="',o,'" ',r,'xml:space="preserve">\n',"<desc>Created with Fabric.js ",Q.version,"</desc>\n","<defs>\n",this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(t),"</defs>\n")},createSVGClipPathMarkup:function(e){var t=this.clipPath;return t?(t.clipPathId="CLIPPATH_"+Q.Object.__uid++,'<clipPath id="'+t.clipPathId+'" >\n'+this.clipPath.toClipPathSVG(e.reviver)+"</clipPath>\n"):""},createSVGRefElementsMarkup:function(){var r=this;return["background","overlay"].map(function(e){var t=r[e+"Color"];if(t&&t.toLive){var n=r[e+"Vpt"],i=r.viewportTransform,o={width:r.width/(n?i[0]:1),height:r.height/(n?i[3]:1)};return t.toSVG(o,{additionalTransform:n?Q.util.matrixToSVG(i):""})}}).join("")},createSVGFontFacesMarkup:function(){var e,t,n,i,o,r,s,a,l="",c={},u=Q.fontPaths,h=[];for(this._objects.forEach(function e(t){h.push(t),t._objects&&t._objects.forEach(e)}),s=0,a=h.length;s<a;s++)if(t=(e=h[s]).fontFamily,-1!==e.type.indexOf("text")&&!c[t]&&u[t]&&(c[t]=!0,e.styles))for(o in n=e.styles)for(r in i=n[o])!c[t=i[r].fontFamily]&&u[t]&&(c[t]=!0);for(var d in c)l+=["\t\t@font-face {\n","\t\t\tfont-family: '",d,"';\n","\t\t\tsrc: url('",u[d],"');\n","\t\t}\n"].join("");return l&&['\t<style type="text/css">',"<![CDATA[\n",l,"]]>","</style>\n"].join("")},_setSVGObjects:function(e,t){for(var n,i=this._objects,o=0,r=i.length;o<r;o++)(n=i[o]).excludeFromExport||this._setSVGObject(e,n,t)},_setSVGObject:function(e,t,n){e.push(t.toSVG(n))},_setSVGBgOverlayImage:function(e,t,n){this[t]&&!this[t].excludeFromExport&&this[t].toSVG&&e.push(this[t].toSVG(n))},_setSVGBgOverlayColor:function(e,t){var n,i,o,r=this[t+"Color"],s=this.viewportTransform,a=this.width,l=this.height;r&&(r.toLive?(n=r.repeat,i=Q.util.invertTransform(s),o=this[t+"Vpt"]?Q.util.matrixToSVG(i):"",e.push('<rect transform="'+o+" translate(",a/2,",",l/2,')"',' x="',r.offsetX-a/2,'" y="',r.offsetY-l/2,'" ','width="',"repeat-y"===n||"no-repeat"===n?r.source.width:a,'" height="',"repeat-x"===n||"no-repeat"===n?r.source.height:l,'" fill="url(#SVGID_'+r.id+')"',"></rect>\n")):e.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',r,'"',"></rect>\n"))},sendToBack:function(e){if(!e)return this;var t,n,i,o=this._activeObject;if(e===o&&"activeSelection"===e.type)for(t=(i=o._objects).length;t--;)n=i[t],c(this._objects,n),this._objects.unshift(n);else c(this._objects,e),this._objects.unshift(e);return this.renderOnAddRemove&&this.requestRenderAll(),this},bringToFront:function(e){if(!e)return this;var t,n,i,o=this._activeObject;if(e===o&&"activeSelection"===e.type)for(i=o._objects,t=0;t<i.length;t++)n=i[t],c(this._objects,n),this._objects.push(n);else c(this._objects,e),this._objects.push(e);return this.renderOnAddRemove&&this.requestRenderAll(),this},sendBackwards:function(e,t){if(!e)return this;var n,i,o,r,s,a=this._activeObject,l=0;if(e===a&&"activeSelection"===e.type)for(s=a._objects,n=0;n<s.length;n++)i=s[n],0+l<(o=this._objects.indexOf(i))&&(r=o-1,c(this._objects,i),this._objects.splice(r,0,i)),l++;else 0!==(o=this._objects.indexOf(e))&&(r=this._findNewLowerIndex(e,o,t),c(this._objects,e),this._objects.splice(r,0,e));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewLowerIndex:function(e,t,n){var i,o;if(n){for(o=(i=t)-1;0<=o;--o)if(e.intersectsWithObject(this._objects[o])||e.isContainedWithinObject(this._objects[o])||this._objects[o].isContainedWithinObject(e)){i=o;break}}else i=t-1;return i},bringForward:function(e,t){if(!e)return this;var n,i,o,r,s,a=this._activeObject,l=0;if(e===a&&"activeSelection"===e.type)for(n=(s=a._objects).length;n--;)i=s[n],(o=this._objects.indexOf(i))<this._objects.length-1-l&&(r=o+1,c(this._objects,i),this._objects.splice(r,0,i)),l++;else(o=this._objects.indexOf(e))!==this._objects.length-1&&(r=this._findNewUpperIndex(e,o,t),c(this._objects,e),this._objects.splice(r,0,e));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewUpperIndex:function(e,t,n){var i,o,r;if(n){for(o=(i=t)+1,r=this._objects.length;o<r;++o)if(e.intersectsWithObject(this._objects[o])||e.isContainedWithinObject(this._objects[o])||this._objects[o].isContainedWithinObject(e)){i=o;break}}else i=t+1;return i},moveTo:function(e,t){return c(this._objects,e),this._objects.splice(t,0,e),this.renderOnAddRemove&&this.requestRenderAll()},dispose:function(){return this.isRendering&&(Q.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(e){e.dispose&&e.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,Q.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},toString:function(){return"#<fabric.Canvas ("+this.complexity()+"): { objects: "+this._objects.length+" }>"}}),o(Q.StaticCanvas.prototype,Q.Observable),o(Q.StaticCanvas.prototype,Q.Collection),o(Q.StaticCanvas.prototype,Q.DataURLExporter),o(Q.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',supports:function(e){var t=i();if(!t||!t.getContext)return null;var n=t.getContext("2d");return n&&"setLineDash"===e?void 0!==n.setLineDash:null}}),Q.StaticCanvas.prototype.toJSON=Q.StaticCanvas.prototype.toObject,Q.isLikelyNode&&(Q.StaticCanvas.prototype.createPNGStream=function(){var e=n(this.lowerCanvasEl);return e&&e.createPNGStream()},Q.StaticCanvas.prototype.createJPEGStream=function(e){var t=n(this.lowerCanvasEl);return t&&t.createJPEGStream(e)}))}(),Q.BaseBrush=Q.util.createClass({color:"rgb(0, 0, 0)",width:1,shadow:null,strokeLineCap:"round",strokeLineJoin:"round",strokeMiterLimit:10,strokeDashArray:null,_setBrushStyles:function(){var e=this.canvas.contextTop;e.strokeStyle=this.color,e.lineWidth=this.width,e.lineCap=this.strokeLineCap,e.miterLimit=this.strokeMiterLimit,e.lineJoin=this.strokeLineJoin,Q.StaticCanvas.supports("setLineDash")&&e.setLineDash(this.strokeDashArray||[])},_saveAndTransform:function(e){var t=this.canvas.viewportTransform;e.save(),e.transform(t[0],t[1],t[2],t[3],t[4],t[5])},_setShadow:function(){var e,t,n,i;this.shadow&&(e=this.canvas,t=this.shadow,n=e.contextTop,i=e.getZoom(),e&&e._isRetinaScaling()&&(i*=Q.devicePixelRatio),n.shadowColor=t.color,n.shadowBlur=t.blur*i,n.shadowOffsetX=t.offsetX*i,n.shadowOffsetY=t.offsetY*i)},needsFullRender:function(){return new Q.Color(this.color).getAlpha()<1||!!this.shadow},_resetShadow:function(){var e=this.canvas.contextTop;e.shadowColor="",e.shadowBlur=e.shadowOffsetX=e.shadowOffsetY=0}}),Q.PencilBrush=Q.util.createClass(Q.BaseBrush,{decimate:.4,initialize:function(e){this.canvas=e,this._points=[]},_drawSegment:function(e,t,n){var i=t.midPointFrom(n);return e.quadraticCurveTo(t.x,t.y,i.x,i.y),i},onMouseDown:function(e,t){this.canvas._isMainEvent(t.e)&&(this._prepareForDrawing(e),this._captureDrawingPath(e),this._render())},onMouseMove:function(e,t){var n,i,o;this.canvas._isMainEvent(t.e)&&this._captureDrawingPath(e)&&1<this._points.length&&(this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this._render()):(i=(n=this._points).length,o=this.canvas.contextTop,this._saveAndTransform(o),this.oldEnd&&(o.beginPath(),o.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=this._drawSegment(o,n[i-2],n[i-1],!0),o.stroke(),o.restore()))},onMouseUp:function(e){return!this.canvas._isMainEvent(e.e)||(this.oldEnd=void 0,this._finalizeAndAddPath(),!1)},_prepareForDrawing:function(e){var t=new Q.Point(e.x,e.y);this._reset(),this._addPoint(t),this.canvas.contextTop.moveTo(t.x,t.y)},_addPoint:function(e){return!(1<this._points.length&&e.eq(this._points[this._points.length-1])||(this._points.push(e),0))},_reset:function(){this._points=[],this._setBrushStyles(),this._setShadow()},_captureDrawingPath:function(e){var t=new Q.Point(e.x,e.y);return this._addPoint(t)},_render:function(){var e,t,n,i=this.canvas.contextTop,o=this._points[0],r=this._points[1];for(this._saveAndTransform(i),i.beginPath(),2===this._points.length&&o.x===r.x&&o.y===r.y&&(n=this.width/1e3,o=new Q.Point(o.x,o.y),r=new Q.Point(r.x,r.y),o.x-=n,r.x+=n),i.moveTo(o.x,o.y),e=1,t=this._points.length;e<t;e++)this._drawSegment(i,o,r),o=this._points[e],r=this._points[e+1];i.lineTo(o.x,o.y),i.stroke(),i.restore()},convertPointsToSVGPath:function(e){var t,n,i=[],o=this.width/1e3,r=new Q.Point(e[0].x,e[0].y),s=new Q.Point(e[1].x,e[1].y),a=e.length,l=1,c=0,u=2<a;for(u&&(l=e[2].x<s.x?-1:e[2].x===s.x?0:1,c=e[2].y<s.y?-1:e[2].y===s.y?0:1),i.push("M ",r.x-l*o," ",r.y-c*o," "),t=1;t<a;t++)r.eq(s)||(n=r.midPointFrom(s),i.push("Q ",r.x," ",r.y," ",n.x," ",n.y," ")),r=e[t],t+1<e.length&&(s=e[t+1]);return u&&(l=r.x>e[t-2].x?1:r.x===e[t-2].x?0:-1,c=r.y>e[t-2].y?1:r.y===e[t-2].y?0:-1),i.push("L ",r.x+l*o," ",r.y+c*o),i},createPath:function(e){var t=new Q.Path(e,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray});return this.shadow&&(this.shadow.affectStroke=!0,t.shadow=new Q.Shadow(this.shadow)),t},decimatePoints:function(e,t){if(e.length<=2)return e;for(var n=this.canvas.getZoom(),i=Math.pow(t/n,2),o=e.length-1,r=e[0],s=[r],a=1;a<o;a++)i<=Math.pow(r.x-e[a].x,2)+Math.pow(r.y-e[a].y,2)&&(r=e[a],s.push(r));return 1===s.length&&s.push(new Q.Point(s[0].x,s[0].y)),s},_finalizeAndAddPath:function(){this.canvas.contextTop.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));var e,t=this.convertPointsToSVGPath(this._points).join("");"M 0 0 Q 0 0 0 0 L 0 0"!==t?(e=this.createPath(t),this.canvas.clearContext(this.canvas.contextTop),this.canvas.fire("before:path:created",{path:e}),this.canvas.add(e),this.canvas.requestRenderAll(),e.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:e})):this.canvas.requestRenderAll()}}),Q.CircleBrush=Q.util.createClass(Q.BaseBrush,{width:10,initialize:function(e){this.canvas=e,this.points=[]},drawDot:function(e){var t=this.addPoint(e),n=this.canvas.contextTop;this._saveAndTransform(n),this.dot(n,t),n.restore()},dot:function(e,t){e.fillStyle=t.fill,e.beginPath(),e.arc(t.x,t.y,t.radius,0,2*Math.PI,!1),e.closePath(),e.fill()},onMouseDown:function(e){this.points.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.drawDot(e)},_render:function(){var e,t,n=this.canvas.contextTop,i=this.points;for(this._saveAndTransform(n),e=0,t=i.length;e<t;e++)this.dot(n,i[e]);n.restore()},onMouseMove:function(e){this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this.addPoint(e),this._render()):this.drawDot(e)},onMouseUp:function(){var e=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var t=[],n=0,i=this.points.length;n<i;n++){var o=this.points[n],r=new Q.Circle({radius:o.radius,left:o.x,top:o.y,originX:"center",originY:"center",fill:o.fill});this.shadow&&(r.shadow=new Q.Shadow(this.shadow)),t.push(r)}var s=new Q.Group(t);s.canvas=this.canvas,this.canvas.fire("before:path:created",{path:s}),this.canvas.add(s),this.canvas.fire("path:created",{path:s}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=e,this.canvas.requestRenderAll()},addPoint:function(e){var t=new Q.Point(e.x,e.y),n=Q.util.getRandomInt(Math.max(0,this.width-20),this.width+20)/2,i=new Q.Color(this.color).setAlpha(Q.util.getRandomInt(0,100)/100).toRgba();return t.radius=n,t.fill=i,this.points.push(t),t}}),Q.SprayBrush=Q.util.createClass(Q.BaseBrush,{width:10,density:20,dotWidth:1,dotWidthVariance:1,randomOpacity:!1,optimizeOverlapping:!0,initialize:function(e){this.canvas=e,this.sprayChunks=[]},onMouseDown:function(e){this.sprayChunks.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.addSprayChunk(e),this.render(this.sprayChunkPoints)},onMouseMove:function(e){this.addSprayChunk(e),this.render(this.sprayChunkPoints)},onMouseUp:function(){var e=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var t=[],n=0,i=this.sprayChunks.length;n<i;n++)for(var o=this.sprayChunks[n],r=0,s=o.length;r<s;r++){var a=new Q.Rect({width:o[r].width,height:o[r].width,left:o[r].x+1,top:o[r].y+1,originX:"center",originY:"center",fill:this.color});t.push(a)}this.optimizeOverlapping&&(t=this._getOptimizedRects(t));var l=new Q.Group(t);this.shadow&&l.set("shadow",new Q.Shadow(this.shadow)),this.canvas.fire("before:path:created",{path:l}),this.canvas.add(l),this.canvas.fire("path:created",{path:l}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=e,this.canvas.requestRenderAll()},_getOptimizedRects:function(e){for(var t,n={},i=0,o=e.length;i<o;i++)n[t=e[i].left+""+e[i].top]||(n[t]=e[i]);var r=[];for(t in n)r.push(n[t]);return r},render:function(e){var t,n,i=this.canvas.contextTop;for(i.fillStyle=this.color,this._saveAndTransform(i),t=0,n=e.length;t<n;t++){var o=e[t];void 0!==o.opacity&&(i.globalAlpha=o.opacity),i.fillRect(o.x,o.y,o.width,o.width)}i.restore()},_render:function(){var e,t,n=this.canvas.contextTop;for(n.fillStyle=this.color,this._saveAndTransform(n),e=0,t=this.sprayChunks.length;e<t;e++)this.render(this.sprayChunks[e]);n.restore()},addSprayChunk:function(e){this.sprayChunkPoints=[];for(var t,n,i,o=this.width/2,r=0;r<this.density;r++){t=Q.util.getRandomInt(e.x-o,e.x+o),n=Q.util.getRandomInt(e.y-o,e.y+o),i=this.dotWidthVariance?Q.util.getRandomInt(Math.max(1,this.dotWidth-this.dotWidthVariance),this.dotWidth+this.dotWidthVariance):this.dotWidth;var s=new Q.Point(t,n);s.width=i,this.randomOpacity&&(s.opacity=Q.util.getRandomInt(0,100)/100),this.sprayChunkPoints.push(s)}this.sprayChunks.push(this.sprayChunkPoints)}}),Q.PatternBrush=Q.util.createClass(Q.PencilBrush,{getPatternSrc:function(){var e=Q.util.createCanvasElement(),t=e.getContext("2d");return e.width=e.height=25,t.fillStyle=this.color,t.beginPath(),t.arc(10,10,10,0,2*Math.PI,!1),t.closePath(),t.fill(),e},getPatternSrcFunction:function(){return String(this.getPatternSrc).replace("this.color",'"'+this.color+'"')},getPattern:function(){return this.canvas.contextTop.createPattern(this.source||this.getPatternSrc(),"repeat")},_setBrushStyles:function(){this.callSuper("_setBrushStyles"),this.canvas.contextTop.strokeStyle=this.getPattern()},createPath:function(e){var t=this.callSuper("createPath",e),n=t._getLeftTopCoords().scalarAdd(t.strokeWidth/2);return t.stroke=new Q.Pattern({source:this.source||this.getPatternSrcFunction(),offsetX:-n.x,offsetY:-n.y}),t}}),function(){var c=Q.util.getPointer,u=Q.util.degreesToRadians,l=Math.abs,h=Q.StaticCanvas.supports("setLineDash"),d=Q.util.isTouchEvent;for(var e in Q.Canvas=Q.util.createClass(Q.StaticCanvas,{initialize:function(e,t){t=t||{},this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(e,t),this._initInteractive(),this._createCacheCanvas()},uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",interactive:!0,selection:!0,selectionKey:"shiftKey",altSelectionKey:null,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",rotationCursor:"crosshair",notAllowedCursor:"not-allowed",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,isDrawingMode:!1,preserveObjectStacking:!1,snapAngle:0,snapThreshold:null,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,targets:[],_hoveredTarget:null,_hoveredTargets:[],_initInteractive:function(){this._currentTransform=null,this._groupSelector=null,this._initWrapperElement(),this._createUpperCanvas(),this._initEventListeners(),this._initRetinaScaling(),this.freeDrawingBrush=Q.PencilBrush&&new Q.PencilBrush(this),this.calcOffset()},_chooseObjectsToRender:function(){var e,t,n,i=this.getActiveObjects();if(0<i.length&&!this.preserveObjectStacking){t=[],n=[];for(var o=0,r=this._objects.length;o<r;o++)e=this._objects[o],-1===i.indexOf(e)?t.push(e):n.push(e);1<i.length&&(this._activeObject._objects=n),t.push.apply(t,n)}else t=this._objects;return t},renderAll:function(){!this.contextTopDirty||this._groupSelector||this.isDrawingMode||(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&this.renderTopLayer(this.contextTop);var e=this.contextContainer;return this.renderCanvas(e,this._chooseObjectsToRender()),this},renderTopLayer:function(e){e.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(e),this.contextTopDirty=!0),e.restore()},renderTop:function(){var e=this.contextTop;return this.clearContext(e),this.renderTopLayer(e),this.fire("after:render"),this},_normalizePointer:function(e,t){var n=e.calcTransformMatrix(),i=Q.util.invertTransform(n),o=this.restorePointerVpt(t);return Q.util.transformPoint(o,i)},isTargetTransparent:function(e,t,n){if(e.shouldCache()&&e._cacheCanvas&&e!==this._activeObject){var i=this._normalizePointer(e,{x:t,y:n}),o=Math.max(e.cacheTranslationX+i.x*e.zoomX,0),r=Math.max(e.cacheTranslationY+i.y*e.zoomY,0);return Q.util.isTransparent(e._cacheContext,Math.round(o),Math.round(r),this.targetFindTolerance)}var s=this.contextCache,a=e.selectionBackgroundColor,l=this.viewportTransform;return e.selectionBackgroundColor="",this.clearContext(s),s.save(),s.transform(l[0],l[1],l[2],l[3],l[4],l[5]),e.render(s),s.restore(),e===this._activeObject&&e._renderControls(s,{hasBorders:!1,transparentCorners:!1},{hasBorders:!1}),e.selectionBackgroundColor=a,Q.util.isTransparent(s,t,n,this.targetFindTolerance)},_isSelectionKeyPressed:function(t){return"[object Array]"===Object.prototype.toString.call(this.selectionKey)?!!this.selectionKey.find(function(e){return!0===t[e]}):t[this.selectionKey]},_shouldClearSelection:function(e,t){var n=this.getActiveObjects(),i=this._activeObject;return!t||t&&i&&1<n.length&&-1===n.indexOf(t)&&i!==t&&!this._isSelectionKeyPressed(e)||t&&!t.evented||t&&!t.selectable&&i&&i!==t},_shouldCenterTransform:function(e,t,n){var i;if(e)return"scale"===t||"scaleX"===t||"scaleY"===t||"resizing"===t?i=this.centeredScaling||e.centeredScaling:"rotate"===t&&(i=this.centeredRotation||e.centeredRotation),i?!n:n},_getOriginFromCorner:function(e,t){var n={x:e.originX,y:e.originY};return"ml"===t||"tl"===t||"bl"===t?n.x="right":"mr"!==t&&"tr"!==t&&"br"!==t||(n.x="left"),"tl"===t||"mt"===t||"tr"===t?n.y="bottom":"bl"===t||"mb"===t||"br"===t?n.y="top":"mtr"===t&&(n.x="center",n.y="center"),n},_getActionFromCorner:function(e,t,n,i){if(!t||!e)return"drag";var o=i.controls[t];return o.getActionName(n,o,i)},_setupCurrentTransform:function(e,t,n){var i,o,r,s,a,l,c;t&&(i=this.getPointer(e),r=!!(o=t.__corner)&&t.controls[o].getActionHandler(),s=this._getActionFromCorner(n,o,e,t),a=this._getOriginFromCorner(t,o),l=e[this.centeredKey],c={target:t,action:s,actionHandler:r,corner:o,scaleX:t.scaleX,scaleY:t.scaleY,skewX:t.skewX,skewY:t.skewY,offsetX:i.x-t.left,offsetY:i.y-t.top,originX:a.x,originY:a.y,ex:i.x,ey:i.y,lastX:i.x,lastY:i.y,theta:u(t.angle),width:t.width*t.scaleX,shiftKey:e.shiftKey,altKey:l,original:Q.util.saveObjectTransform(t)},this._shouldCenterTransform(t,s,l)&&(c.originX="center",c.originY="center"),c.original.originX=a.x,c.original.originY=a.y,this._currentTransform=c,this._beforeTransform(e))},_translateObject:function(e,t){var n=this._currentTransform,i=n.target,o=e-n.offsetX,r=t-n.offsetY,s=!i.get("lockMovementX")&&i.left!==o,a=!i.get("lockMovementY")&&i.top!==r;return s&&i.set("left",o),a&&i.set("top",r),s||a},setCursor:function(e){this.upperCanvasEl.style.cursor=e},_drawSelection:function(e){var t,n,i=this._groupSelector,o=i.left,r=i.top,s=l(o),a=l(r);this.selectionColor&&(e.fillStyle=this.selectionColor,e.fillRect(i.ex-(0<o?0:-o),i.ey-(0<r?0:-r),s,a)),this.selectionLineWidth&&this.selectionBorderColor&&(e.lineWidth=this.selectionLineWidth,e.strokeStyle=this.selectionBorderColor,1<this.selectionDashArray.length&&!h?(t=i.ex+.5-(0<o?0:s),n=i.ey+.5-(0<r?0:a),e.beginPath(),Q.util.drawDashedLine(e,t,n,t+s,n,this.selectionDashArray),Q.util.drawDashedLine(e,t,n+a-1,t+s,n+a-1,this.selectionDashArray),Q.util.drawDashedLine(e,t,n,t,n+a,this.selectionDashArray),Q.util.drawDashedLine(e,t+s-1,n,t+s-1,n+a,this.selectionDashArray),e.closePath(),e.stroke()):(Q.Object.prototype._setLineDash.call(this,e,this.selectionDashArray),e.strokeRect(i.ex+.5-(0<o?0:s),i.ey+.5-(0<r?0:a),s,a)))},findTarget:function(e,t){if(!this.skipTargetFind){var n,i,o=this.getPointer(e,!0),r=this._activeObject,s=this.getActiveObjects(),a=d(e);if(this.targets=[],1<s.length&&!t&&r===this._searchPossibleTargets([r],o))return r;if(1===s.length&&r._findTargetCorner(o,a))return r;if(1===s.length&&r===this._searchPossibleTargets([r],o)){if(!this.preserveObjectStacking)return r;n=r,i=this.targets,this.targets=[]}var l=this._searchPossibleTargets(this._objects,o);return e[this.altSelectionKey]&&l&&n&&l!==n&&(l=n,this.targets=i),l}},_checkTarget:function(e,t,n){if(t&&t.visible&&t.evented&&(t.containsPoint(e)||t._findTargetCorner(e))){if(!this.perPixelTargetFind&&!t.perPixelTargetFind||t.isEditing)return!0;if(!this.isTargetTransparent(t,n.x,n.y))return!0}},_searchPossibleTargets:function(e,t){for(var n,i,o=e.length;o--;){var r=e[o],s=r.group?this._normalizePointer(r.group,t):t;if(this._checkTarget(s,r,t)){(n=e[o]).subTargetCheck&&n instanceof Q.Group&&(i=this._searchPossibleTargets(n._objects,t))&&this.targets.push(i);break}}return n},restorePointerVpt:function(e){return Q.util.transformPoint(e,Q.util.invertTransform(this.viewportTransform))},getPointer:function(e,t){if(this._absolutePointer&&!t)return this._absolutePointer;if(this._pointer&&t)return this._pointer;var n,i=c(e),o=this.upperCanvasEl,r=o.getBoundingClientRect(),s=r.width||0,a=r.height||0;s&&a||("top"in r&&"bottom"in r&&(a=Math.abs(r.top-r.bottom)),"right"in r&&"left"in r&&(s=Math.abs(r.right-r.left))),this.calcOffset(),i.x=i.x-this._offset.left,i.y=i.y-this._offset.top,t||(i=this.restorePointerVpt(i));var l=this.getRetinaScaling();return 1!==l&&(i.x/=l,i.y/=l),n=0===s||0===a?{width:1,height:1}:{width:o.width/s,height:o.height/a},{x:i.x*n.width,y:i.y*n.height}},_createUpperCanvas:function(){var e=this.lowerCanvasEl.className.replace(/\s*lower-canvas\s*/,""),t=this.lowerCanvasEl,n=this.upperCanvasEl;n?n.className="":(n=this._createCanvasElement(),this.upperCanvasEl=n),Q.util.addClass(n,"upper-canvas "+e),this.wrapperEl.appendChild(n),this._copyCanvasStyle(t,n),this._applyCanvasStyle(n),this.contextTop=n.getContext("2d")},_createCacheCanvas:function(){this.cacheCanvasEl=this._createCanvasElement(),this.cacheCanvasEl.setAttribute("width",this.width),this.cacheCanvasEl.setAttribute("height",this.height),this.contextCache=this.cacheCanvasEl.getContext("2d")},_initWrapperElement:function(){this.wrapperEl=Q.util.wrapElement(this.lowerCanvasEl,"div",{class:this.containerClass}),Q.util.setStyle(this.wrapperEl,{width:this.width+"px",height:this.height+"px",position:"relative"}),Q.util.makeElementUnselectable(this.wrapperEl)},_applyCanvasStyle:function(e){var t=this.width||e.width,n=this.height||e.height;Q.util.setStyle(e,{position:"absolute",width:t+"px",height:n+"px",left:0,top:0,"touch-action":this.allowTouchScrolling?"manipulation":"none","-ms-touch-action":this.allowTouchScrolling?"manipulation":"none"}),e.width=t,e.height=n,Q.util.makeElementUnselectable(e)},_copyCanvasStyle:function(e,t){t.style.cssText=e.style.cssText},getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},getActiveObject:function(){return this._activeObject},getActiveObjects:function(){var e=this._activeObject;return e?"activeSelection"===e.type&&e._objects?e._objects.slice(0):[e]:[]},_onObjectRemoved:function(e){e===this._activeObject&&(this.fire("before:selection:cleared",{target:e}),this._discardActiveObject(),this.fire("selection:cleared",{target:e}),e.fire("deselected")),e===this._hoveredTarget&&(this._hoveredTarget=null,this._hoveredTargets=[]),this.callSuper("_onObjectRemoved",e)},_fireSelectionEvents:function(t,e){var n=!1,i=this.getActiveObjects(),o=[],r=[],s={e:e};t.forEach(function(e){-1===i.indexOf(e)&&(n=!0,e.fire("deselected",s),r.push(e))}),i.forEach(function(e){-1===t.indexOf(e)&&(n=!0,e.fire("selected",s),o.push(e))}),0<t.length&&0<i.length?(s.selected=o,s.deselected=r,s.updated=o[0]||r[0],s.target=this._activeObject,n&&this.fire("selection:updated",s)):0<i.length?(s.selected=o,s.target=this._activeObject,this.fire("selection:created",s)):0<t.length&&(s.deselected=r,this.fire("selection:cleared",s))},setActiveObject:function(e,t){var n=this.getActiveObjects();return this._setActiveObject(e,t),this._fireSelectionEvents(n,t),this},_setActiveObject:function(e,t){return this._activeObject!==e&&!!this._discardActiveObject(t,e)&&!e.onSelect({e:t})&&(this._activeObject=e,!0)},_discardActiveObject:function(e,t){var n=this._activeObject;if(n){if(n.onDeselect({e:e,object:t}))return!1;this._activeObject=null}return!0},discardActiveObject:function(e){var t=this.getActiveObjects(),n=this.getActiveObject();return t.length&&this.fire("before:selection:cleared",{target:n,e:e}),this._discardActiveObject(e),this._fireSelectionEvents(t,e),this},dispose:function(){var e=this.wrapperEl;return this.removeListeners(),e.removeChild(this.upperCanvasEl),e.removeChild(this.lowerCanvasEl),this.contextCache=null,this.contextTop=null,["upperCanvasEl","cacheCanvasEl"].forEach(function(e){Q.util.cleanUpJsdomNode(this[e]),this[e]=void 0}.bind(this)),e.parentNode&&e.parentNode.replaceChild(this.lowerCanvasEl,this.wrapperEl),delete this.wrapperEl,Q.StaticCanvas.prototype.dispose.call(this),this},clear:function(){return this.discardActiveObject(),this.clearContext(this.contextTop),this.callSuper("clear")},drawControls:function(e){var t=this._activeObject;t&&t._renderControls(e)},_toObject:function(e,t,n){var i=this._realizeGroupTransformOnObject(e),o=this.callSuper("_toObject",e,t,n);return this._unwindGroupTransformOnObject(e,i),o},_realizeGroupTransformOnObject:function(t){if(t.group&&"activeSelection"===t.group.type&&this._activeObject===t.group){var n={};return["angle","flipX","flipY","left","scaleX","scaleY","skewX","skewY","top"].forEach(function(e){n[e]=t[e]}),this._activeObject.realizeTransform(t),n}return null},_unwindGroupTransformOnObject:function(e,t){t&&e.set(t)},_setSVGObject:function(e,t,n){var i=this._realizeGroupTransformOnObject(t);this.callSuper("_setSVGObject",e,t,n),this._unwindGroupTransformOnObject(t,i)},setViewportTransform:function(e){this.renderOnAddRemove&&this._activeObject&&this._activeObject.isEditing&&this._activeObject.clearContextTop(),Q.StaticCanvas.prototype.setViewportTransform.call(this,e)}}),Q.StaticCanvas)"prototype"!==e&&(Q.Canvas[e]=Q.StaticCanvas[e])}(),_=Q.util.addListener,E=Q.util.removeListener,T={passive:!1},Q.util.object.extend(Q.Canvas.prototype,{mainTouchId:null,_initEventListeners:function(){this.removeListeners(),this._bindEvents(),this.addOrRemove(_,"add")},_getEventPrefix:function(){return this.enablePointerEvents?"pointer":"mouse"},addOrRemove:function(e,t){var n=this.upperCanvasEl,i=this._getEventPrefix();e(Q.window,"resize",this._onResize),e(n,i+"down",this._onMouseDown),e(n,i+"move",this._onMouseMove,T),e(n,i+"out",this._onMouseOut),e(n,i+"enter",this._onMouseEnter),e(n,"wheel",this._onMouseWheel),e(n,"contextmenu",this._onContextMenu),e(n,"dblclick",this._onDoubleClick),e(n,"dragover",this._onDragOver),e(n,"dragenter",this._onDragEnter),e(n,"dragleave",this._onDragLeave),e(n,"drop",this._onDrop),this.enablePointerEvents||e(n,"touchstart",this._onTouchStart,T),"undefined"!=typeof eventjs&&t in eventjs&&(eventjs[t](n,"gesture",this._onGesture),eventjs[t](n,"drag",this._onDrag),eventjs[t](n,"orientation",this._onOrientationChange),eventjs[t](n,"shake",this._onShake),eventjs[t](n,"longpress",this._onLongPress))},removeListeners:function(){this.addOrRemove(E,"remove");var e=this._getEventPrefix();E(Q.document,e+"up",this._onMouseUp),E(Q.document,"touchend",this._onTouchEnd,T),E(Q.document,e+"move",this._onMouseMove,T),E(Q.document,"touchmove",this._onMouseMove,T)},_bindEvents:function(){this.eventsBound||(this._onMouseDown=this._onMouseDown.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onResize=this._onResize.bind(this),this._onGesture=this._onGesture.bind(this),this._onDrag=this._onDrag.bind(this),this._onShake=this._onShake.bind(this),this._onLongPress=this._onLongPress.bind(this),this._onOrientationChange=this._onOrientationChange.bind(this),this._onMouseWheel=this._onMouseWheel.bind(this),this._onMouseOut=this._onMouseOut.bind(this),this._onMouseEnter=this._onMouseEnter.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onDoubleClick=this._onDoubleClick.bind(this),this._onDragOver=this._onDragOver.bind(this),this._onDragEnter=this._simpleEventHandler.bind(this,"dragenter"),this._onDragLeave=this._simpleEventHandler.bind(this,"dragleave"),this._onDrop=this._simpleEventHandler.bind(this,"drop"),this.eventsBound=!0)},_onGesture:function(e,t){this.__onTransformGesture&&this.__onTransformGesture(e,t)},_onDrag:function(e,t){this.__onDrag&&this.__onDrag(e,t)},_onMouseWheel:function(e){this.__onMouseWheel(e)},_onMouseOut:function(t){var n=this._hoveredTarget;this.fire("mouse:out",{target:n,e:t}),this._hoveredTarget=null,n&&n.fire("mouseout",{e:t});var i=this;this._hoveredTargets.forEach(function(e){i.fire("mouse:out",{target:n,e:t}),e&&n.fire("mouseout",{e:t})}),this._hoveredTargets=[],this._iTextInstances&&this._iTextInstances.forEach(function(e){e.isEditing&&e.hiddenTextarea.focus()})},_onMouseEnter:function(e){this.currentTransform||this.findTarget(e)||(this.fire("mouse:over",{target:null,e:e}),this._hoveredTarget=null,this._hoveredTargets=[])},_onOrientationChange:function(e,t){this.__onOrientationChange&&this.__onOrientationChange(e,t)},_onShake:function(e,t){this.__onShake&&this.__onShake(e,t)},_onLongPress:function(e,t){this.__onLongPress&&this.__onLongPress(e,t)},_onDragOver:function(e){e.preventDefault();var t=this._simpleEventHandler("dragover",e);this._fireEnterLeaveEvents(t,e)},_onContextMenu:function(e){return this.stopContextMenu&&(e.stopPropagation(),e.preventDefault()),!1},_onDoubleClick:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"dblclick"),this._resetTransformEventData(e)},getPointerId:function(e){var t=e.changedTouches;return t?t[0]&&t[0].identifier:this.enablePointerEvents?e.pointerId:-1},_isMainEvent:function(e){return!0===e.isPrimary||!1!==e.isPrimary&&("touchend"===e.type&&0===e.touches.length||!e.changedTouches||e.changedTouches[0].identifier===this.mainTouchId)},_onTouchStart:function(e){e.preventDefault(),null===this.mainTouchId&&(this.mainTouchId=this.getPointerId(e)),this.__onMouseDown(e),this._resetTransformEventData();var t=this.upperCanvasEl,n=this._getEventPrefix();_(Q.document,"touchend",this._onTouchEnd,T),_(Q.document,"touchmove",this._onMouseMove,T),E(t,n+"down",this._onMouseDown)},_onMouseDown:function(e){this.__onMouseDown(e),this._resetTransformEventData();var t=this.upperCanvasEl,n=this._getEventPrefix();E(t,n+"move",this._onMouseMove,T),_(Q.document,n+"up",this._onMouseUp),_(Q.document,n+"move",this._onMouseMove,T)},_onTouchEnd:function(e){var t,n;0<e.touches.length||(this.__onMouseUp(e),this._resetTransformEventData(),this.mainTouchId=null,t=this._getEventPrefix(),E(Q.document,"touchend",this._onTouchEnd,T),E(Q.document,"touchmove",this._onMouseMove,T),(n=this)._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout(function(){_(n.upperCanvasEl,t+"down",n._onMouseDown),n._willAddMouseDown=0},400))},_onMouseUp:function(e){this.__onMouseUp(e),this._resetTransformEventData();var t=this.upperCanvasEl,n=this._getEventPrefix();this._isMainEvent(e)&&(E(Q.document,n+"up",this._onMouseUp),E(Q.document,n+"move",this._onMouseMove,T),_(t,n+"move",this._onMouseMove,T))},_onMouseMove:function(e){!this.allowTouchScrolling&&e.preventDefault&&e.preventDefault(),this.__onMouseMove(e)},_onResize:function(){this.calcOffset()},_shouldRender:function(e){var t=this._activeObject;return!!(!!t!=!!e||t&&e&&t!==e)||(t&&t.isEditing,!1)},__onMouseUp:function(e){var t,n,i,o,r,s=this._currentTransform,a=this._groupSelector,l=!1,c=!a||0===a.left&&0===a.top;if(this._cacheTransformEventData(e),t=this._target,this._handleEvent(e,"up:before"),_e(e,3))this.fireRightClick&&this._handleEvent(e,"up",3,c);else{if(_e(e,2))return this.fireMiddleClick&&this._handleEvent(e,"up",2,c),void this._resetTransformEventData();this.isDrawingMode&&this._isCurrentlyDrawing?this._onMouseUpInDrawingMode(e):this._isMainEvent(e)&&(s&&(this._finalizeCurrentTransform(e),l=s.actionPerformed),c||(n=t===this._activeObject,this._maybeGroupObjects(e),l=l||this._shouldRender(t)||!n&&t===this._activeObject),t&&(i=t._findTargetCorner(this.getPointer(e,!0),Q.util.isTouchEvent(e)),(r=(o=t.controls[i])&&o.getMouseUpHandler(e,t,o))&&r(e,t,o),t.isMoving=!1),this._setCursorFromEvent(e,t),this._handleEvent(e,"up",1,c),this._groupSelector=null,this._currentTransform=null,t&&(t.__corner=0),l?this.requestRenderAll():c||this.renderTop())}},_simpleEventHandler:function(e,t){var n=this.findTarget(t),i=this.targets,o={e:t,target:n,subTargets:i};if(this.fire(e,o),n&&n.fire(e,o),!i)return n;for(var r=0;r<i.length;r++)i[r].fire(e,o);return n},_handleEvent:function(e,t,n,i){var o=this._target,r=this.targets||[],s={e:e,target:o,subTargets:r,button:n||1,isClick:i||!1,pointer:this._pointer,absolutePointer:this._absolutePointer,transform:this._currentTransform};this.fire("mouse:"+t,s),o&&o.fire("mouse"+t,s);for(var a=0;a<r.length;a++)r[a].fire("mouse"+t,s)},_finalizeCurrentTransform:function(e){var t,n=this._currentTransform,i=n.target,o={e:e,target:i,transform:n};i._scaling&&(i._scaling=!1),i.setCoords(),(n.actionPerformed||this.stateful&&i.hasStateChanged())&&(n.actionPerformed&&(t=this._addEventOptions(o,n),this._fire(t,o)),this._fire("modified",o))},_addEventOptions:function(e,t){var n,i;switch(t.action){case"scaleX":n="scaled",i="x";break;case"scaleY":n="scaled",i="y";break;case"skewX":n="skewed",i="x";break;case"skewY":n="skewed",i="y";break;case"scale":n="scaled",i="equally";break;case"rotate":n="rotated";break;case"drag":n="moved"}return e.by=i,n},_onMouseDownInDrawingMode:function(e){this._isCurrentlyDrawing=!0,this.getActiveObject()&&this.discardActiveObject(e).requestRenderAll();var t=this.getPointer(e);this.freeDrawingBrush.onMouseDown(t,{e:e,pointer:t}),this._handleEvent(e,"down")},_onMouseMoveInDrawingMode:function(e){var t;this._isCurrentlyDrawing&&(t=this.getPointer(e),this.freeDrawingBrush.onMouseMove(t,{e:e,pointer:t})),this.setCursor(this.freeDrawingCursor),this._handleEvent(e,"move")},_onMouseUpInDrawingMode:function(e){var t=this.getPointer(e);this._isCurrentlyDrawing=this.freeDrawingBrush.onMouseUp({e:e,pointer:t}),this._handleEvent(e,"up")},__onMouseDown:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"down:before");var t,n,i,o,r,s,a,l=this._target;_e(e,3)?this.fireRightClick&&this._handleEvent(e,"down",3):_e(e,2)?this.fireMiddleClick&&this._handleEvent(e,"down",2):this.isDrawingMode?this._onMouseDownInDrawingMode(e):this._isMainEvent(e)&&(this._currentTransform||(t=this._pointer,this._previousPointer=t,n=this._shouldRender(l),i=this._shouldGroup(e,l),this._shouldClearSelection(e,l)?this.discardActiveObject(e):i&&(this._handleGrouping(e,l),l=this._activeObject),!this.selection||l&&(l.selectable||l.isEditing||l===this._activeObject)||(this._groupSelector={ex:t.x,ey:t.y,top:0,left:0}),l&&(o=l===this._activeObject,l.selectable&&this.setActiveObject(l,e),r=l._findTargetCorner(this.getPointer(e,!0),Q.util.isTouchEvent(e)),l.__corner=r,l!==this._activeObject||!r&&i||((a=(s=l.controls[r])&&s.getMouseDownHandler(e,l,s))&&a(e,l,s),this._setupCurrentTransform(e,l,o))),this._handleEvent(e,"down"),(n||i)&&this.requestRenderAll()))},_resetTransformEventData:function(){this._target=null,this._pointer=null,this._absolutePointer=null},_cacheTransformEventData:function(e){this._resetTransformEventData(),this._pointer=this.getPointer(e,!0),this._absolutePointer=this.restorePointerVpt(this._pointer),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(e)||null},_beforeTransform:function(e){var t=this._currentTransform;this.stateful&&t.target.saveState(),this.fire("before:transform",{e:e,transform:t})},__onMouseMove:function(e){var t,n,i;this._handleEvent(e,"move:before"),this._cacheTransformEventData(e),this.isDrawingMode?this._onMouseMoveInDrawingMode(e):this._isMainEvent(e)&&((i=this._groupSelector)?(n=this._pointer,i.left=n.x-i.ex,i.top=n.y-i.ey,this.renderTop()):this._currentTransform?this._transformObject(e):(t=this.findTarget(e)||null,this._setCursorFromEvent(e,t),this._fireOverOutEvents(t,e)),this._handleEvent(e,"move"),this._resetTransformEventData())},_fireOverOutEvents:function(e,t){var n=this._hoveredTarget,i=this._hoveredTargets,o=this.targets,r=Math.max(i.length,o.length);this.fireSyntheticInOutEvents(e,t,{oldTarget:n,evtOut:"mouseout",canvasEvtOut:"mouse:out",evtIn:"mouseover",canvasEvtIn:"mouse:over"});for(var s=0;s<r;s++)this.fireSyntheticInOutEvents(o[s],t,{oldTarget:i[s],evtOut:"mouseout",evtIn:"mouseover"});this._hoveredTarget=e,this._hoveredTargets=this.targets.concat()},_fireEnterLeaveEvents:function(e,t){var n=this._draggedoverTarget,i=this._hoveredTargets,o=this.targets,r=Math.max(i.length,o.length);this.fireSyntheticInOutEvents(e,t,{oldTarget:n,evtOut:"dragleave",evtIn:"dragenter"});for(var s=0;s<r;s++)this.fireSyntheticInOutEvents(o[s],t,{oldTarget:i[s],evtOut:"dragleave",evtIn:"dragenter"});this._draggedoverTarget=e},fireSyntheticInOutEvents:function(e,t,n){var i,o,r,s=n.oldTarget,a=s!==e,l=n.canvasEvtIn,c=n.canvasEvtOut;a&&(i={e:t,target:e,previousTarget:s},o={e:t,target:s,nextTarget:e}),r=e&&a,s&&a&&(c&&this.fire(c,o),s.fire(n.evtOut,o)),r&&(l&&this.fire(l,i),e.fire(n.evtIn,i))},__onMouseWheel:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"wheel"),this._resetTransformEventData()},_transformObject:function(e){var t=this.getPointer(e),n=this._currentTransform;n.reset=!1,n.target.isMoving=!0,n.shiftKey=e.shiftKey,n.altKey=e[this.centeredKey],this._performTransformAction(e,n,t),n.actionPerformed&&this.requestRenderAll()},_performTransformAction:function(e,t,n){var i=n.x,o=n.y,r=t.action,s=!1,a=t.actionHandler,l={target:t.target,e:e,transform:t,pointer:n};"drag"===r?(s=this._translateObject(i,o))&&(this._fire("moving",l),this.setCursor(l.target.moveCursor||this.moveCursor)):a&&(s=a(e,t,i,o))&&this._fire(r,l),t.actionPerformed=t.actionPerformed||s},_fire:Q.controlsUtils.fireEvent,_setCursorFromEvent:function(e,t){if(!t)return this.setCursor(this.defaultCursor),!1;var n=t.hoverCursor||this.hoverCursor,i=this._activeObject&&"activeSelection"===this._activeObject.type?this._activeObject:null,o=(!i||!i.contains(t))&&t._findTargetCorner(this.getPointer(e,!0));o?this.setCursor(this.getCornerCursor(o,t,e)):(t.subTargetCheck&&this.targets.concat().reverse().map(function(e){n=e.hoverCursor||n}),this.setCursor(n))},getCornerCursor:function(e,t,n){var i=t.controls[e];return i.cursorStyleHandler(n,i,t)}}),k=Math.min,O=Math.max,Q.util.object.extend(Q.Canvas.prototype,{_shouldGroup:function(e,t){var n=this._activeObject;return n&&this._isSelectionKeyPressed(e)&&t&&t.selectable&&this.selection&&(n!==t||"activeSelection"===n.type)&&!t.onSelect({e:e})},_handleGrouping:function(e,t){var n=this._activeObject;n.__corner||(t!==n||(t=this.findTarget(e,!0))&&t.selectable)&&(n&&"activeSelection"===n.type?this._updateActiveSelection(t,e):this._createActiveSelection(t,e))},_updateActiveSelection:function(e,t){var n=this._activeObject,i=n._objects.slice(0);n.contains(e)?(n.removeWithUpdate(e),this._hoveredTarget=e,this._hoveredTargets=this.targets.concat(),1===n.size()&&this._setActiveObject(n.item(0),t)):(n.addWithUpdate(e),this._hoveredTarget=n,this._hoveredTargets=this.targets.concat()),this._fireSelectionEvents(i,t)},_createActiveSelection:function(e,t){var n=this.getActiveObjects(),i=this._createGroup(e);this._hoveredTarget=i,this._setActiveObject(i,t),this._fireSelectionEvents(n,t)},_createGroup:function(e){var t=this._objects,n=t.indexOf(this._activeObject)<t.indexOf(e)?[this._activeObject,e]:[e,this._activeObject];return this._activeObject.isEditing&&this._activeObject.exitEditing(),new Q.ActiveSelection(n,{canvas:this})},_groupSelectedObjects:function(e){var t,n=this._collectObjects(e);1===n.length?this.setActiveObject(n[0],e):1<n.length&&(t=new Q.ActiveSelection(n.reverse(),{canvas:this}),this.setActiveObject(t,e))},_collectObjects:function(t){for(var e,n=[],i=this._groupSelector.ex,o=this._groupSelector.ey,r=i+this._groupSelector.left,s=o+this._groupSelector.top,a=new Q.Point(k(i,r),k(o,s)),l=new Q.Point(O(i,r),O(o,s)),c=!this.selectionFullyContained,u=i===r&&o===s,h=this._objects.length;h--&&!((e=this._objects[h])&&e.selectable&&e.visible&&(c&&e.intersectsWithRect(a,l)||e.isContainedWithinRect(a,l)||c&&e.containsPoint(a)||c&&e.containsPoint(l))&&(n.push(e),u)););return 1<n.length&&(n=n.filter(function(e){return!e.onSelect({e:t})})),n},_maybeGroupObjects:function(e){this.selection&&this._groupSelector&&this._groupSelectedObjects(e),this.setCursor(this.defaultCursor),this._groupSelector=null}}),Q.util.object.extend(Q.StaticCanvas.prototype,{toDataURL:function(e){var t=(e=e||{}).format||"png",n=e.quality||1,i=(e.multiplier||1)*(e.enableRetinaScaling?this.getRetinaScaling():1),o=this.toCanvasElement(i,e);return Q.util.toDataURL(o,t,n)},toCanvasElement:function(e,t){e=e||1;var n=((t=t||{}).width||this.width)*e,i=(t.height||this.height)*e,o=this.getZoom(),r=this.width,s=this.height,a=o*e,l=this.viewportTransform,c=(l[4]-(t.left||0))*e,u=(l[5]-(t.top||0))*e,h=this.interactive,d=[a,0,0,a,c,u],f=this.enableRetinaScaling,p=Q.util.createCanvasElement(),g=this.contextTop;return p.width=n,p.height=i,this.contextTop=null,this.enableRetinaScaling=!1,this.interactive=!1,this.viewportTransform=d,this.width=n,this.height=i,this.calcViewportBoundaries(),this.renderCanvas(p.getContext("2d"),this._objects),this.viewportTransform=l,this.width=r,this.height=s,this.calcViewportBoundaries(),this.interactive=h,this.enableRetinaScaling=f,this.contextTop=g,p}}),Q.util.object.extend(Q.StaticCanvas.prototype,{loadFromJSON:function(e,n,t){if(e){var i="string"==typeof e?JSON.parse(e):Q.util.object.clone(e),o=this,r=i.clipPath,s=this.renderOnAddRemove;return this.renderOnAddRemove=!1,delete i.clipPath,this._enlivenObjects(i.objects,function(t){o.clear(),o._setBgOverlay(i,function(){r?o._enlivenObjects([r],function(e){o.clipPath=e[0],o.__setupCanvas.call(o,i,t,s,n)}):o.__setupCanvas.call(o,i,t,s,n)})},t),this}},__setupCanvas:function(e,t,n,i){var o=this;t.forEach(function(e,t){o.insertAt(e,t)}),this.renderOnAddRemove=n,delete e.objects,delete e.backgroundImage,delete e.overlayImage,delete e.background,delete e.overlay,this._setOptions(e),this.renderAll(),i&&i()},_setBgOverlay:function(e,t){var n,i={backgroundColor:!1,overlayColor:!1,backgroundImage:!1,overlayImage:!1};e.backgroundImage||e.overlayImage||e.background||e.overlay?(n=function(){i.backgroundImage&&i.overlayImage&&i.backgroundColor&&i.overlayColor&&t&&t()},this.__setBgOverlay("backgroundImage",e.backgroundImage,i,n),this.__setBgOverlay("overlayImage",e.overlayImage,i,n),this.__setBgOverlay("backgroundColor",e.background,i,n),this.__setBgOverlay("overlayColor",e.overlay,i,n)):t&&t()},__setBgOverlay:function(t,e,n,i){var o=this;if(!e)return n[t]=!0,void(i&&i());"backgroundImage"===t||"overlayImage"===t?Q.util.enlivenObjects([e],function(e){o[t]=e[0],n[t]=!0,i&&i()}):this["set"+Q.util.string.capitalize(t,!0)](e,function(){n[t]=!0,i&&i()})},_enlivenObjects:function(e,t,n){e&&0!==e.length?Q.util.enlivenObjects(e,function(e){t&&t(e)},null,n):t&&t([])},_toDataURL:function(t,n){this.clone(function(e){n(e.toDataURL(t))})},_toDataURLWithMultiplier:function(t,n,i){this.clone(function(e){i(e.toDataURLWithMultiplier(t,n))})},clone:function(t,e){var n=JSON.stringify(this.toJSON(e));this.cloneWithoutData(function(e){e.loadFromJSON(n,function(){t&&t(e)})})},cloneWithoutData:function(e){var t=Q.util.createCanvasElement();t.width=this.width,t.height=this.height;var n=new Q.Canvas(t);this.backgroundImage?(n.setBackgroundImage(this.backgroundImage.src,function(){n.renderAll(),e&&e(n)}),n.backgroundImageOpacity=this.backgroundImageOpacity,n.backgroundImageStretch=this.backgroundImageStretch):e&&e(n)}}),function(){"use strict";var x=Pe.fabric||(Pe.fabric={}),e=x.util.object.extend,t=x.util.object.clone,i=x.util.toFixed,n=x.util.string.capitalize,a=x.util.degreesToRadians,o=x.StaticCanvas.supports("setLineDash"),r=!x.isLikelyNode;x.Object||(x.Object=x.util.createClass(x.CommonMethods,{type:"object",originX:"left",originY:"top",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,skewX:0,skewY:0,cornerSize:13,touchCornerSize:24,transparentCorners:!0,hoverCursor:null,moveCursor:null,padding:0,borderColor:"rgb(178,204,255)",borderDashArray:null,cornerColor:"rgb(178,204,255)",cornerStrokeColor:null,cornerStyle:"rect",cornerDashArray:null,centeredScaling:!1,centeredRotation:!0,fill:"rgb(0,0,0)",fillRule:"nonzero",globalCompositeOperation:"source-over",backgroundColor:"",selectionBackgroundColor:"",stroke:null,strokeWidth:1,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,shadow:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,minScaleLimit:0,selectable:!0,evented:!0,visible:!0,hasControls:!0,hasBorders:!0,perPixelTargetFind:!1,includeDefaultValues:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,excludeFromExport:!1,objectCaching:r,statefullCache:!1,noScaleCache:!0,strokeUniform:!1,dirty:!0,__corner:0,paintFirst:"fill",stateProperties:"top left width height scaleX scaleY flipX flipY originX originY transformMatrix stroke strokeWidth strokeDashArray strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit angle opacity fill globalCompositeOperation shadow visible backgroundColor skewX skewY fillRule paintFirst clipPath strokeUniform".split(" "),cacheProperties:"fill stroke strokeWidth strokeDashArray width height paintFirst strokeUniform strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit backgroundColor clipPath".split(" "),colorProperties:"fill stroke backgroundColor".split(" "),clipPath:void 0,inverted:!1,absolutePositioned:!1,initialize:function(e){e&&this.setOptions(e)},_createCacheCanvas:function(){this._cacheProperties={},this._cacheCanvas=x.util.createCanvasElement(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0},_limitCacheSize:function(e){var t=x.perfLimitSizeTotal,n=e.width,i=e.height,o=x.maxCacheSideLimit,r=x.minCacheSideLimit;if(n<=o&&i<=o&&n*i<=t)return n<r&&(e.width=r),i<r&&(e.height=r),e;var s=n/i,a=x.util.limitDimsByArea(s,t),l=x.util.capValue,c=l(r,a.x,o),u=l(r,a.y,o);return c<n&&(e.zoomX/=n/c,e.width=c,e.capped=!0),u<i&&(e.zoomY/=i/u,e.height=u,e.capped=!0),e},_getCacheCanvasDimensions:function(){var e=this.getTotalObjectScaling(),t=this._getTransformedDimensions(0,0),n=t.x*e.scaleX/this.scaleX,i=t.y*e.scaleY/this.scaleY;return{width:2+n,height:2+i,zoomX:e.scaleX,zoomY:e.scaleY,x:n,y:i}},_updateCacheCanvas:function(){var e=this.canvas;if(this.noScaleCache&&e&&e._currentTransform){var t=e._currentTransform.target,n=e._currentTransform.action;if(this===t&&n.slice&&"scale"===n.slice(0,5))return!1}var i,o,r,s,a,l=this._cacheCanvas,c=this._limitCacheSize(this._getCacheCanvasDimensions()),u=x.minCacheSideLimit,h=c.width,d=c.height,f=c.zoomX,p=c.zoomY,g=h!==this.cacheWidth||d!==this.cacheHeight,m=this.zoomX!==f||this.zoomY!==p,v=g||m,y=0,b=0,C=!1;return g&&(r=this._cacheCanvas.width,s=this._cacheCanvas.height,C=(a=r<h||s<d)||(h<.9*r||d<.9*s)&&u<r&&u<s,a&&!c.capped&&(u<h||u<d)&&(y=.1*h,b=.1*d)),v&&(C?(l.width=Math.ceil(h+y),l.height=Math.ceil(d+b)):(this._cacheContext.setTransform(1,0,0,1,0,0),this._cacheContext.clearRect(0,0,l.width,l.height)),i=c.x/2,o=c.y/2,this.cacheTranslationX=Math.round(l.width/2-i)+i,this.cacheTranslationY=Math.round(l.height/2-o)+o,this.cacheWidth=h,this.cacheHeight=d,this._cacheContext.translate(this.cacheTranslationX,this.cacheTranslationY),this._cacheContext.scale(f,p),this.zoomX=f,this.zoomY=p,!0)},setOptions:function(e){this._setOptions(e),this._initGradient(e.fill,"fill"),this._initGradient(e.stroke,"stroke"),this._initPattern(e.fill,"fill"),this._initPattern(e.stroke,"stroke")},transform:function(e){var t=this.group&&!this.group._transformDone||this.group&&this.canvas&&e===this.canvas.contextTop,n=this.calcTransformMatrix(!t);e.transform(n[0],n[1],n[2],n[3],n[4],n[5])},toObject:function(e){var t=x.Object.NUM_FRACTION_DIGITS,n={type:this.type,version:x.version,originX:this.originX,originY:this.originY,left:i(this.left,t),top:i(this.top,t),width:i(this.width,t),height:i(this.height,t),fill:this.fill&&this.fill.toObject?this.fill.toObject():this.fill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:i(this.strokeWidth,t),strokeDashArray:this.strokeDashArray?this.strokeDashArray.concat():this.strokeDashArray,strokeLineCap:this.strokeLineCap,strokeDashOffset:this.strokeDashOffset,strokeLineJoin:this.strokeLineJoin,strokeMiterLimit:i(this.strokeMiterLimit,t),scaleX:i(this.scaleX,t),scaleY:i(this.scaleY,t),angle:i(this.angle,t),flipX:this.flipX,flipY:this.flipY,opacity:i(this.opacity,t),shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow,visible:this.visible,backgroundColor:this.backgroundColor,fillRule:this.fillRule,paintFirst:this.paintFirst,globalCompositeOperation:this.globalCompositeOperation,skewX:i(this.skewX,t),skewY:i(this.skewY,t)};return this.clipPath&&(n.clipPath=this.clipPath.toObject(e),n.clipPath.inverted=this.clipPath.inverted,n.clipPath.absolutePositioned=this.clipPath.absolutePositioned),x.util.populateWithProperties(this,n,e),this.includeDefaultValues||(n=this._removeDefaultValues(n)),n},toDatalessObject:function(e){return this.toObject(e)},_removeDefaultValues:function(t){var n=x.util.getKlass(t.type).prototype;return n.stateProperties.forEach(function(e){"left"!==e&&"top"!==e&&(t[e]===n[e]&&delete t[e],"[object Array]"===Object.prototype.toString.call(t[e])&&"[object Array]"===Object.prototype.toString.call(n[e])&&0===t[e].length&&0===n[e].length&&delete t[e])}),t},toString:function(){return"#<fabric."+n(this.type)+">"},getObjectScaling:function(){var e=x.util.qrDecompose(this.calcTransformMatrix());return{scaleX:Math.abs(e.scaleX),scaleY:Math.abs(e.scaleY)}},getTotalObjectScaling:function(){var e,t,n=this.getObjectScaling(),i=n.scaleX,o=n.scaleY;return this.canvas&&(i*=(e=this.canvas.getZoom())*(t=this.canvas.getRetinaScaling()),o*=e*t),{scaleX:i,scaleY:o}},getObjectOpacity:function(){var e=this.opacity;return this.group&&(e*=this.group.getObjectOpacity()),e},_set:function(e,t){var n,i="scaleX"===e||"scaleY"===e,o=this[e]!==t;return i&&(t=this._constrainScale(t)),"scaleX"===e&&t<0?(this.flipX=!this.flipX,t*=-1):"scaleY"===e&&t<0?(this.flipY=!this.flipY,t*=-1):"shadow"!==e||!t||t instanceof x.Shadow?"dirty"===e&&this.group&&this.group.set("dirty",t):t=new x.Shadow(t),this[e]=t,o&&(n=this.group&&this.group.isOnACache(),-1<this.cacheProperties.indexOf(e)?(this.dirty=!0,n&&this.group.set("dirty",!0)):n&&-1<this.stateProperties.indexOf(e)&&this.group.set("dirty",!0)),this},setOnGroup:function(){},getViewportTransform:function(){return this.canvas&&this.canvas.viewportTransform?this.canvas.viewportTransform:x.iMatrix.concat()},isNotVisible:function(){return 0===this.opacity||!this.width&&!this.height&&0===this.strokeWidth||!this.visible},render:function(e){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(e.save(),this._setupCompositeOperation(e),this.drawSelectionBackground(e),this.transform(e),this._setOpacity(e),this._setShadow(e,this),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(e)):(this._removeCacheCanvas(),this.dirty=!1,this.drawObject(e),this.objectCaching&&this.statefullCache&&this.saveState({propertySet:"cacheProperties"})),e.restore())},renderCache:function(e){e=e||{},this._cacheCanvas||this._createCacheCanvas(),this.isCacheDirty()&&(this.statefullCache&&this.saveState({propertySet:"cacheProperties"}),this.drawObject(this._cacheContext,e.forClipping),this.dirty=!1)},_removeCacheCanvas:function(){this._cacheCanvas=null,this.cacheWidth=0,this.cacheHeight=0},hasStroke:function(){return this.stroke&&"transparent"!==this.stroke&&0!==this.strokeWidth},hasFill:function(){return this.fill&&"transparent"!==this.fill},needsItsOwnCache:function(){return!("stroke"!==this.paintFirst||!this.hasFill()||!this.hasStroke()||"object"!=typeof this.shadow)||!!this.clipPath},shouldCache:function(){return this.ownCaching=this.needsItsOwnCache()||this.objectCaching&&(!this.group||!this.group.isOnACache()),this.ownCaching},willDrawShadow:function(){return!!this.shadow&&(0!==this.shadow.offsetX||0!==this.shadow.offsetY)},drawClipPathOnCache:function(e){var t,n=this.clipPath;e.save(),n.inverted?e.globalCompositeOperation="destination-out":e.globalCompositeOperation="destination-in",n.absolutePositioned&&(t=x.util.invertTransform(this.calcTransformMatrix()),e.transform(t[0],t[1],t[2],t[3],t[4],t[5])),n.transform(e),e.scale(1/n.zoomX,1/n.zoomY),e.drawImage(n._cacheCanvas,-n.cacheTranslationX,-n.cacheTranslationY),e.restore()},drawObject:function(e,t){var n=this.fill,i=this.stroke;t?(this.fill="black",this.stroke="",this._setClippingProperties(e)):(this._renderBackground(e),this._setStrokeStyles(e,this),this._setFillStyles(e,this)),this._render(e),this._drawClipPath(e),this.fill=n,this.stroke=i},_drawClipPath:function(e){var t=this.clipPath;t&&(t.canvas=this.canvas,t.shouldCache(),t._transformDone=!0,t.renderCache({forClipping:!0}),this.drawClipPathOnCache(e))},drawCacheOnCanvas:function(e){e.scale(1/this.zoomX,1/this.zoomY),e.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)},isCacheDirty:function(e){return!(this.isNotVisible()||(!this._cacheCanvas||e||!this._updateCacheCanvas())&&(!(this.dirty||this.clipPath&&this.clipPath.absolutePositioned||this.statefullCache&&this.hasStateChanged("cacheProperties"))||(this._cacheCanvas&&!e&&(t=this.cacheWidth/this.zoomX,n=this.cacheHeight/this.zoomY,this._cacheContext.clearRect(-t/2,-n/2,t,n)),0)));var t,n},_renderBackground:function(e){var t;this.backgroundColor&&(t=this._getNonTransformedDimensions(),e.fillStyle=this.backgroundColor,e.fillRect(-t.x/2,-t.y/2,t.x,t.y),this._removeShadow(e))},_setOpacity:function(e){this.group&&!this.group._transformDone?e.globalAlpha=this.getObjectOpacity():e.globalAlpha*=this.opacity},_setStrokeStyles:function(e,t){t.stroke&&(e.lineWidth=t.strokeWidth,e.lineCap=t.strokeLineCap,e.lineDashOffset=t.strokeDashOffset,e.lineJoin=t.strokeLineJoin,e.miterLimit=t.strokeMiterLimit,e.strokeStyle=t.stroke.toLive?t.stroke.toLive(e,this):t.stroke)},_setFillStyles:function(e,t){t.fill&&(e.fillStyle=t.fill.toLive?t.fill.toLive(e,this):t.fill)},_setClippingProperties:function(e){e.globalAlpha=1,e.strokeStyle="transparent",e.fillStyle="#000000"},_setLineDash:function(e,t,n){t&&0!==t.length&&(1&t.length&&t.push.apply(t,t),o?e.setLineDash(t):n&&n(e))},_renderControls:function(e,t){var n=this.getViewportTransform(),i=this.calcTransformMatrix(),o=void 0!==(t=t||{}).hasBorders?t.hasBorders:this.hasBorders,r=void 0!==t.hasControls?t.hasControls:this.hasControls,i=x.util.multiplyTransformMatrices(n,i),s=x.util.qrDecompose(i);e.save(),e.translate(s.translateX,s.translateY),e.lineWidth=+this.borderScaleFactor,this.group||(e.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),t.forActiveSelection?(e.rotate(a(s.angle)),o&&this.drawBordersInGroup(e,s,t)):(e.rotate(a(this.angle)),o&&this.drawBorders(e,t)),r&&this.drawControls(e,t),e.restore()},_setShadow:function(e){var t,n,i,o,r;this.shadow&&(t=this.shadow,i=(n=this.canvas)&&n.viewportTransform[0]||1,o=n&&n.viewportTransform[3]||1,r=t.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),n&&n._isRetinaScaling()&&(i*=x.devicePixelRatio,o*=x.devicePixelRatio),e.shadowColor=t.color,e.shadowBlur=t.blur*x.browserShadowBlurConstant*(i+o)*(r.scaleX+r.scaleY)/4,e.shadowOffsetX=t.offsetX*i*r.scaleX,e.shadowOffsetY=t.offsetY*o*r.scaleY)},_removeShadow:function(e){this.shadow&&(e.shadowColor="",e.shadowBlur=e.shadowOffsetX=e.shadowOffsetY=0)},_applyPatternGradientTransform:function(e,t){if(!t||!t.toLive)return{offsetX:0,offsetY:0};var n=t.gradientTransform||t.patternTransform,i=-this.width/2+t.offsetX||0,o=-this.height/2+t.offsetY||0;return"percentage"===t.gradientUnits?e.transform(this.width,0,0,this.height,i,o):e.transform(1,0,0,1,i,o),n&&e.transform(n[0],n[1],n[2],n[3],n[4],n[5]),{offsetX:i,offsetY:o}},_renderPaintInOrder:function(e){"stroke"===this.paintFirst?(this._renderStroke(e),this._renderFill(e)):(this._renderFill(e),this._renderStroke(e))},_render:function(){},_renderFill:function(e){this.fill&&(e.save(),this._applyPatternGradientTransform(e,this.fill),"evenodd"===this.fillRule?e.fill("evenodd"):e.fill(),e.restore())},_renderStroke:function(e){var t;this.stroke&&0!==this.strokeWidth&&(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(e),e.save(),this.strokeUniform&&this.group?(t=this.getObjectScaling(),e.scale(1/t.scaleX,1/t.scaleY)):this.strokeUniform&&e.scale(1/this.scaleX,1/this.scaleY),this._setLineDash(e,this.strokeDashArray,this._renderDashedStroke),this.stroke.toLive&&"percentage"===this.stroke.gradientUnits?this._applyPatternForTransformedGradient(e,this.stroke):this._applyPatternGradientTransform(e,this.stroke),e.stroke(),e.restore())},_applyPatternForTransformedGradient:function(e,t){var n,i=this._limitCacheSize(this._getCacheCanvasDimensions()),o=x.util.createCanvasElement(),r=this.canvas.getRetinaScaling(),s=i.x/this.scaleX/r,a=i.y/this.scaleY/r;o.width=s,o.height=a,(n=o.getContext("2d")).beginPath(),n.moveTo(0,0),n.lineTo(s,0),n.lineTo(s,a),n.lineTo(0,a),n.closePath(),n.translate(s/2,a/2),n.scale(i.zoomX/this.scaleX/r,i.zoomY/this.scaleY/r),this._applyPatternGradientTransform(n,t),n.fillStyle=t.toLive(e),n.fill(),e.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),e.scale(r*this.scaleX/i.zoomX,r*this.scaleY/i.zoomY),e.strokeStyle=n.createPattern(o,"no-repeat")},_findCenterFromElement:function(){return{x:this.left+this.width/2,y:this.top+this.height/2}},_assignTransformMatrixProps:function(){var e;this.transformMatrix&&(e=x.util.qrDecompose(this.transformMatrix),this.flipX=!1,this.flipY=!1,this.set("scaleX",e.scaleX),this.set("scaleY",e.scaleY),this.angle=e.angle,this.skewX=e.skewX,this.skewY=0)},_removeTransformMatrix:function(e){var t=this._findCenterFromElement();this.transformMatrix&&(this._assignTransformMatrixProps(),t=x.util.transformPoint(t,this.transformMatrix)),this.transformMatrix=null,e&&(this.scaleX*=e.scaleX,this.scaleY*=e.scaleY,this.cropX=e.cropX,this.cropY=e.cropY,t.x+=e.offsetLeft,t.y+=e.offsetTop,this.width=e.width,this.height=e.height),this.setPositionByOrigin(t,"center","center")},clone:function(e,t){var n=this.toObject(t);this.constructor.fromObject?this.constructor.fromObject(n,e):x.Object._fromObject("Object",n,e)},cloneAsImage:function(e,t){var n=this.toCanvasElement(t);return e&&e(new x.Image(n)),this},toCanvasElement:function(e){e=e||{};var t=x.util,n=t.saveObjectTransform(this),i=this.group,o=this.shadow,r=Math.abs,s=(e.multiplier||1)*(e.enableRetinaScaling?x.devicePixelRatio:1);delete this.group,e.withoutTransform&&t.resetObjectTransform(this),e.withoutShadow&&(this.shadow=null);var a,l,c,u,h=x.util.createCanvasElement(),d=this.getBoundingRect(!0,!0),f=this.shadow,p={x:0,y:0};f&&(l=f.blur,a=f.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),p.x=2*Math.round(r(f.offsetX)+l)*r(a.scaleX),p.y=2*Math.round(r(f.offsetY)+l)*r(a.scaleY)),c=d.width+p.x,u=d.height+p.y,h.width=Math.ceil(c),h.height=Math.ceil(u);var g=new x.StaticCanvas(h,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1});"jpeg"===e.format&&(g.backgroundColor="#fff"),this.setPositionByOrigin(new x.Point(g.width/2,g.height/2),"center","center");var m=this.canvas;g.add(this);var v=g.toCanvasElement(s||1,e);return this.shadow=o,this.set("canvas",m),i&&(this.group=i),this.set(n).setCoords(),g._objects=[],g.dispose(),g=null,v},toDataURL:function(e){return e=e||{},x.util.toDataURL(this.toCanvasElement(e),e.format||"png",e.quality||1)},isType:function(e){return this.type===e},complexity:function(){return 1},toJSON:function(e){return this.toObject(e)},rotate:function(e){var t=("center"!==this.originX||"center"!==this.originY)&&this.centeredRotation;return t&&this._setOriginToCenter(),this.set("angle",e),t&&this._resetOrigin(),this},centerH:function(){return this.canvas&&this.canvas.centerObjectH(this),this},viewportCenterH:function(){return this.canvas&&this.canvas.viewportCenterObjectH(this),this},centerV:function(){return this.canvas&&this.canvas.centerObjectV(this),this},viewportCenterV:function(){return this.canvas&&this.canvas.viewportCenterObjectV(this),this},center:function(){return this.canvas&&this.canvas.centerObject(this),this},viewportCenter:function(){return this.canvas&&this.canvas.viewportCenterObject(this),this},getLocalPointer:function(e,t){t=t||this.canvas.getPointer(e);var n=new x.Point(t.x,t.y),i=this._getLeftTopCoords();return this.angle&&(n=x.util.rotatePoint(n,i,a(-this.angle))),{x:n.x-i.x,y:n.y-i.y}},_setupCompositeOperation:function(e){this.globalCompositeOperation&&(e.globalCompositeOperation=this.globalCompositeOperation)}}),x.util.createAccessors&&x.util.createAccessors(x.Object),e(x.Object.prototype,x.Observable),x.Object.NUM_FRACTION_DIGITS=2,x.Object._fromObject=function(e,n,i,o){var r=x[e];n=t(n,!0),x.util.enlivenPatterns([n.fill,n.stroke],function(e){void 0!==e[0]&&(n.fill=e[0]),void 0!==e[1]&&(n.stroke=e[1]),x.util.enlivenObjects([n.clipPath],function(e){n.clipPath=e[0];var t=o?new r(n[o],n):new r(n);i&&i(t)})})},x.Object.__uid=0)}(),A=Q.util.degreesToRadians,N={left:-.5,center:0,right:.5},F={top:-.5,center:0,bottom:.5},Q.util.object.extend(Q.Object.prototype,{translateToGivenOrigin:function(e,t,n,i,o){var r,s,a,l=e.x,c=e.y;return"string"==typeof t?t=N[t]:t-=.5,"string"==typeof i?i=N[i]:i-=.5,"string"==typeof n?n=F[n]:n-=.5,"string"==typeof o?o=F[o]:o-=.5,s=o-n,((r=i-t)||s)&&(a=this._getTransformedDimensions(),l=e.x+r*a.x,c=e.y+s*a.y),new Q.Point(l,c)},translateToCenterPoint:function(e,t,n){var i=this.translateToGivenOrigin(e,t,n,"center","center");return this.angle?Q.util.rotatePoint(i,e,A(this.angle)):i},translateToOriginPoint:function(e,t,n){var i=this.translateToGivenOrigin(e,"center","center",t,n);return this.angle?Q.util.rotatePoint(i,e,A(this.angle)):i},getCenterPoint:function(){var e=new Q.Point(this.left,this.top);return this.translateToCenterPoint(e,this.originX,this.originY)},getPointByOrigin:function(e,t){var n=this.getCenterPoint();return this.translateToOriginPoint(n,e,t)},toLocalPoint:function(e,t,n){var i=this.getCenterPoint(),o=void 0!==t&&void 0!==n?this.translateToGivenOrigin(i,"center","center",t,n):new Q.Point(this.left,this.top),r=new Q.Point(e.x,e.y);return this.angle&&(r=Q.util.rotatePoint(r,i,-A(this.angle))),r.subtractEquals(o)},setPositionByOrigin:function(e,t,n){var i=this.translateToCenterPoint(e,t,n),o=this.translateToOriginPoint(i,this.originX,this.originY);this.set("left",o.x),this.set("top",o.y)},adjustPosition:function(e){var t=A(this.angle),n=this.getScaledWidth(),i=Q.util.cos(t)*n,o=Q.util.sin(t)*n,r="string"==typeof this.originX?N[this.originX]:this.originX-.5,s="string"==typeof e?N[e]:e-.5;this.left+=i*(s-r),this.top+=o*(s-r),this.setCoords(),this.originX=e},_setOriginToCenter:function(){this._originalOriginX=this.originX,this._originalOriginY=this.originY;var e=this.getCenterPoint();this.originX="center",this.originY="center",this.left=e.x,this.top=e.y},_resetOrigin:function(){var e=this.translateToOriginPoint(this.getCenterPoint(),this._originalOriginX,this._originalOriginY);this.originX=this._originalOriginX,this.originY=this._originalOriginY,this.left=e.x,this.top=e.y,this._originalOriginX=null,this._originalOriginY=null},_getLeftTopCoords:function(){return this.translateToOriginPoint(this.getCenterPoint(),"left","top")}}),M=Q.util,R=M.degreesToRadians,D=M.multiplyTransformMatrices,I=M.transformPoint,M.object.extend(Q.Object.prototype,{oCoords:null,aCoords:null,lineCoords:null,ownMatrixCache:null,matrixCache:null,controls:{},_getCoords:function(e,t){return t?e?this.calcACoords():this.calcLineCoords():(this.aCoords&&this.lineCoords||this.setCoords(!0),e?this.aCoords:this.lineCoords)},getCoords:function(e,t){return n=this._getCoords(e,t),[new Q.Point(n.tl.x,n.tl.y),new Q.Point(n.tr.x,n.tr.y),new Q.Point(n.br.x,n.br.y),new Q.Point(n.bl.x,n.bl.y)];var n},intersectsWithRect:function(e,t,n,i){var o=this.getCoords(n,i);return"Intersection"===Q.Intersection.intersectPolygonRectangle(o,e,t).status},intersectsWithObject:function(e,t,n){return"Intersection"===Q.Intersection.intersectPolygonPolygon(this.getCoords(t,n),e.getCoords(t,n)).status||e.isContainedWithinObject(this,t,n)||this.isContainedWithinObject(e,t,n)},isContainedWithinObject:function(e,t,n){for(var i=this.getCoords(t,n),o=t?e.aCoords:e.lineCoords,r=0,s=e._getImageLines(o);r<4;r++)if(!e.containsPoint(i[r],s))return!1;return!0},isContainedWithinRect:function(e,t,n,i){var o=this.getBoundingRect(n,i);return o.left>=e.x&&o.left+o.width<=t.x&&o.top>=e.y&&o.top+o.height<=t.y},containsPoint:function(e,t,n,i){var o=this._getCoords(n,i),t=t||this._getImageLines(o),r=this._findCrossPoints(e,t);return 0!==r&&r%2==1},isOnScreen:function(e){if(!this.canvas)return!1;var t=this.canvas.vptCoords.tl,n=this.canvas.vptCoords.br;return!!this.getCoords(!0,e).some(function(e){return e.x<=n.x&&e.x>=t.x&&e.y<=n.y&&e.y>=t.y})||!!this.intersectsWithRect(t,n,!0,e)||this._containsCenterOfCanvas(t,n,e)},_containsCenterOfCanvas:function(e,t,n){var i={x:(e.x+t.x)/2,y:(e.y+t.y)/2};return!!this.containsPoint(i,null,!0,n)},isPartiallyOnScreen:function(e){if(!this.canvas)return!1;var t=this.canvas.vptCoords.tl,n=this.canvas.vptCoords.br;return!!this.intersectsWithRect(t,n,!0,e)||this.getCoords(!0,e).every(function(e){return(e.x>=n.x||e.x<=t.x)&&(e.y>=n.y||e.y<=t.y)})&&this._containsCenterOfCanvas(t,n,e)},_getImageLines:function(e){return{topline:{o:e.tl,d:e.tr},rightline:{o:e.tr,d:e.br},bottomline:{o:e.br,d:e.bl},leftline:{o:e.bl,d:e.tl}}},_findCrossPoints:function(e,t){var n,i,o=0;for(var r in t)if(!((i=t[r]).o.y<e.y&&i.d.y<e.y||i.o.y>=e.y&&i.d.y>=e.y||((i.o.x===i.d.x&&i.o.x>=e.x?i.o.x:(n=(i.d.y-i.o.y)/(i.d.x-i.o.x),-(e.y-0*e.x-(i.o.y-n*i.o.x))/(0-n)))>=e.x&&(o+=1),2!==o)))break;return o},getBoundingRect:function(e,t){var n=this.getCoords(e,t);return M.makeBoundingBoxFromPoints(n)},getScaledWidth:function(){return this._getTransformedDimensions().x},getScaledHeight:function(){return this._getTransformedDimensions().y},_constrainScale:function(e){return Math.abs(e)<this.minScaleLimit?e<0?-this.minScaleLimit:this.minScaleLimit:0===e?1e-4:e},scale:function(e){return this._set("scaleX",e),this._set("scaleY",e),this.setCoords()},scaleToWidth:function(e,t){var n=this.getBoundingRect(t).width/this.getScaledWidth();return this.scale(e/this.width/n)},scaleToHeight:function(e,t){var n=this.getBoundingRect(t).height/this.getScaledHeight();return this.scale(e/this.height/n)},calcCoords:function(e){return e?this.calcACoords():this.calcOCoords()},calcLineCoords:function(){var e=this.getViewportTransform(),t=this.padding,n=R(this.angle),i=M.cos(n)*t,o=M.sin(n)*t,r=i+o,s=i-o,a=this.calcACoords(),l={tl:I(a.tl,e),tr:I(a.tr,e),bl:I(a.bl,e),br:I(a.br,e)};return t&&(l.tl.x-=s,l.tl.y-=r,l.tr.x+=r,l.tr.y-=s,l.bl.x-=r,l.bl.y+=s,l.br.x+=s,l.br.y+=r),l},calcOCoords:function(){var e=this._calcRotateMatrix(),t=this._calcTranslateMatrix(),n=this.getViewportTransform(),i=D(n,t),o=D(i,e),o=D(o,[1/n[0],0,0,1/n[3],0,0]),r=this._calculateCurrentDimensions(),s={};return this.forEachControl(function(e,t,n){s[t]=e.positionHandler(r,o,n)}),s},calcACoords:function(){var e=this._calcRotateMatrix(),t=this._calcTranslateMatrix(),n=D(t,e),i=this._getTransformedDimensions(),o=i.x/2,r=i.y/2;return{tl:I({x:-o,y:-r},n),tr:I({x:o,y:-r},n),bl:I({x:-o,y:r},n),br:I({x:o,y:r},n)}},setCoords:function(e){return this.aCoords=this.calcACoords(),this.lineCoords=this.group?this.aCoords:this.calcLineCoords(),e||(this.oCoords=this.calcOCoords(),this._setCornerCoords&&this._setCornerCoords()),this},_calcRotateMatrix:function(){return M.calcRotateMatrix(this)},_calcTranslateMatrix:function(){var e=this.getCenterPoint();return[1,0,0,1,e.x,e.y]},transformMatrixKey:function(e){var t="";return!e&&this.group&&(t=this.group.transformMatrixKey(e)+"_"),t+this.top+"_"+this.left+"_"+this.scaleX+"_"+this.scaleY+"_"+this.skewX+"_"+this.skewY+"_"+this.angle+"_"+this.originX+"_"+this.originY+"_"+this.width+"_"+this.height+"_"+this.strokeWidth+this.flipX+this.flipY},calcTransformMatrix:function(e){var t=this.calcOwnMatrix();if(e||!this.group)return t;var n=this.transformMatrixKey(e),i=this.matrixCache||(this.matrixCache={});return i.key===n?i.value:(this.group&&(t=D(this.group.calcTransformMatrix(!1),t)),i.key=n,i.value=t)},calcOwnMatrix:function(){var e=this.transformMatrixKey(!0),t=this.ownMatrixCache||(this.ownMatrixCache={});if(t.key===e)return t.value;var n=this._calcTranslateMatrix(),i={angle:this.angle,translateX:n[4],translateY:n[5],scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY};return t.key=e,t.value=M.composeMatrix(i),t.value},_calcDimensionsTransformMatrix:function(e,t,n){return M.calcDimensionsMatrix({skewX:e,skewY:t,scaleX:this.scaleX*(n&&this.flipX?-1:1),scaleY:this.scaleY*(n&&this.flipY?-1:1)})},_getNonTransformedDimensions:function(){var e=this.strokeWidth;return{x:this.width+e,y:this.height+e}},_getTransformedDimensions:function(e,t){void 0===e&&(e=this.skewX),void 0===t&&(t=this.skewY);var n,i=this._getNonTransformedDimensions(),o=0===e&&0===t,r=this.strokeUniform?(n=this.width,this.height):(n=i.x,i.y);if(o)return this._finalizeDimensions(n*this.scaleX,r*this.scaleY);var s=M.sizeAfterTransform(n,r,{scaleX:this.scaleX,scaleY:this.scaleY,skewX:e,skewY:t});return this._finalizeDimensions(s.x,s.y)},_finalizeDimensions:function(e,t){return this.strokeUniform?{x:e+this.strokeWidth,y:t+this.strokeWidth}:{x:e,y:t}},_calculateCurrentDimensions:function(){var e=this.getViewportTransform(),t=this._getTransformedDimensions();return I(t,e,!0).scalarAdd(2*this.padding)}}),Q.util.object.extend(Q.Object.prototype,{sendToBack:function(){return this.group?Q.StaticCanvas.prototype.sendToBack.call(this.group,this):this.canvas&&this.canvas.sendToBack(this),this},bringToFront:function(){return this.group?Q.StaticCanvas.prototype.bringToFront.call(this.group,this):this.canvas&&this.canvas.bringToFront(this),this},sendBackwards:function(e){return this.group?Q.StaticCanvas.prototype.sendBackwards.call(this.group,this,e):this.canvas&&this.canvas.sendBackwards(this,e),this},bringForward:function(e){return this.group?Q.StaticCanvas.prototype.bringForward.call(this.group,this,e):this.canvas&&this.canvas.bringForward(this,e),this},moveTo:function(e){return this.group&&"activeSelection"!==this.group.type?Q.StaticCanvas.prototype.moveTo.call(this.group,this,e):this.canvas&&this.canvas.moveTo(this,e),this}}),L=Q.util.toFixed,Q.util.object.extend(Q.Object.prototype,{getSvgStyles:function(e){var t=this.fillRule?this.fillRule:"nonzero",n=this.strokeWidth?this.strokeWidth:"0",i=this.strokeDashArray?this.strokeDashArray.join(" "):"none",o=this.strokeDashOffset?this.strokeDashOffset:"0",r=this.strokeLineCap?this.strokeLineCap:"butt",s=this.strokeLineJoin?this.strokeLineJoin:"miter",a=this.strokeMiterLimit?this.strokeMiterLimit:"4",l=void 0!==this.opacity?this.opacity:"1",c=this.visible?"":" visibility: hidden;",u=e?"":this.getSvgFilter(),h=Ee("fill",this.fill);return[Ee("stroke",this.stroke),"stroke-width: ",n,"; ","stroke-dasharray: ",i,"; ","stroke-linecap: ",r,"; ","stroke-dashoffset: ",o,"; ","stroke-linejoin: ",s,"; ","stroke-miterlimit: ",a,"; ",h,"fill-rule: ",t,"; ","opacity: ",l,";",u,c].join("")},getSvgSpanStyles:function(e,t){var n=e.fontFamily?"font-family: "+(-1===e.fontFamily.indexOf("'")&&-1===e.fontFamily.indexOf('"')?"'"+e.fontFamily+"'":e.fontFamily)+"; ":"",i=e.strokeWidth?"stroke-width: "+e.strokeWidth+"; ":"",n=n,o=e.fontSize?"font-size: "+e.fontSize+"px; ":"",r=e.fontStyle?"font-style: "+e.fontStyle+"; ":"",s=e.fontWeight?"font-weight: "+e.fontWeight+"; ":"",a=e.fill?Ee("fill",e.fill):"",l=e.stroke?Ee("stroke",e.stroke):"",c=this.getSvgTextDecoration(e);return[l,i,n,o,r,s,c=c&&"text-decoration: "+c+"; ",a,e.deltaY?"baseline-shift: "+-e.deltaY+"; ":"",t?"white-space: pre; ":""].join("")},getSvgTextDecoration:function(t){return["overline","underline","line-through"].filter(function(e){return t[e.replace("-","")]}).join(" ")},getSvgFilter:function(){return this.shadow?"filter: url(#SVGID_"+this.shadow.id+");":""},getSvgCommons:function(){return[this.id?'id="'+this.id+'" ':"",this.clipPath?'clip-path="url(#'+this.clipPath.clipPathId+')" ':""].join("")},getSvgTransform:function(e,t){var n=e?this.calcTransformMatrix():this.calcOwnMatrix();return'transform="'+Q.util.matrixToSVG(n)+(t||"")+'" '},_setSVGBg:function(e){var t;this.backgroundColor&&(t=Q.Object.NUM_FRACTION_DIGITS,e.push("\t\t<rect ",this._getFillAttributes(this.backgroundColor),' x="',L(-this.width/2,t),'" y="',L(-this.height/2,t),'" width="',L(this.width,t),'" height="',L(this.height,t),'"></rect>\n'))},toSVG:function(e){return this._createBaseSVGMarkup(this._toSVG(e),{reviver:e})},toClipPathSVG:function(e){return"\t"+this._createBaseClipPathSVGMarkup(this._toSVG(e),{reviver:e})},_createBaseClipPathSVGMarkup:function(e,t){var n=(t=t||{}).reviver,i=t.additionalTransform||"",o=[this.getSvgTransform(!0,i),this.getSvgCommons()].join(""),r=e.indexOf("COMMON_PARTS");return e[r]=o,n?n(e.join("")):e.join("")},_createBaseSVGMarkup:function(e,t){var n,i,o=(t=t||{}).noStyle,r=t.reviver,s=o?"":'style="'+this.getSvgStyles()+'" ',a=t.withShadow?'style="'+this.getSvgFilter()+'" ':"",l=this.clipPath,c=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",u=l&&l.absolutePositioned,h=this.stroke,d=this.fill,f=this.shadow,p=[],g=e.indexOf("COMMON_PARTS"),m=t.additionalTransform;return l&&(l.clipPathId="CLIPPATH_"+Q.Object.__uid++,i='<clipPath id="'+l.clipPathId+'" >\n'+l.toClipPathSVG(r)+"</clipPath>\n"),u&&p.push("<g ",a,this.getSvgCommons()," >\n"),p.push("<g ",this.getSvgTransform(!1),u?"":a+this.getSvgCommons()," >\n"),n=[s,c,o?"":this.addPaintOrder()," ",m?'transform="'+m+'" ':""].join(""),e[g]=n,d&&d.toLive&&p.push(d.toSVG(this)),h&&h.toLive&&p.push(h.toSVG(this)),f&&p.push(f.toSVG(this)),l&&p.push(i),p.push(e.join("")),p.push("</g>\n"),u&&p.push("</g>\n"),r?r(p.join("")):p.join("")},addPaintOrder:function(){return"fill"!==this.paintFirst?' paint-order="'+this.paintFirst+'" ':""}}),B=Q.util.object.extend,j="stateProperties",Q.util.object.extend(Q.Object.prototype,{hasStateChanged:function(e){var t="_"+(e=e||j);return Object.keys(this[t]).length<this[e].length||!function e(t,n,i){if(t===n)return 1;if(Array.isArray(t)){if(!Array.isArray(n)||t.length!==n.length)return;for(var o=0,r=t.length;o<r;o++)if(!e(t[o],n[o]))return;return 1}if(t&&"object"==typeof t){var s,a=Object.keys(t);if(!n||"object"!=typeof n||!i&&a.length!==Object.keys(n).length)return;for(o=0,r=a.length;o<r;o++)if("canvas"!==(s=a[o])&&"group"!==s&&!e(t[s],n[s]))return;return 1}}(this[t],this,!0)},saveState:function(e){var t=e&&e.propertySet||j,n="_"+t;return this[n]?(Te(this,n,this[t]),e&&e.stateProperties&&Te(this,n,e.stateProperties),this):this.setupState(e)},setupState:function(e){var t=(e=e||{}).propertySet||j;return this["_"+(e.propertySet=t)]={},this.saveState(e),this}}),G=Q.util.degreesToRadians,Q.util.object.extend(Q.Object.prototype,{_findTargetCorner:function(e,t){if(!this.hasControls||this.group||!this.canvas||this.canvas._activeObject!==this)return!1;var n,i,o,r=e.x,s=e.y,a=Object.keys(this.oCoords),l=a.length-1;for(this.__corner=0;0<=l;l--)if(o=a[l],this.isControlVisible(o)&&(i=this._getImageLines(t?this.oCoords[o].touchCorner:this.oCoords[o].corner),0!==(n=this._findCrossPoints({x:r,y:s},i))&&n%2==1))return this.__corner=o;return!1},forEachControl:function(e){for(var t in this.controls)e(this.controls[t],t,this)},_setCornerCoords:function(){var e,t,n=this.oCoords,i=G(45-this.angle),o=Q.util.cos(i),r=Q.util.sin(i),s=.707106*this.cornerSize,a=.707106*this.touchCornerSize,l=s*o,c=s*r,u=a*o,h=a*r;for(var d in n)e=n[d].x,t=n[d].y,n[d].corner={tl:{x:e-c,y:t-l},tr:{x:e+l,y:t-c},bl:{x:e-l,y:t+c},br:{x:e+c,y:t+l}},n[d].touchCorner={tl:{x:e-h,y:t-u},tr:{x:e+u,y:t-h},bl:{x:e-u,y:t+h},br:{x:e+h,y:t+u}}},drawSelectionBackground:function(e){if(!this.selectionBackgroundColor||this.canvas&&!this.canvas.interactive||this.canvas&&this.canvas._activeObject!==this)return this;e.save();var t=this.getCenterPoint(),n=this._calculateCurrentDimensions(),i=this.canvas.viewportTransform;return e.translate(t.x,t.y),e.scale(1/i[0],1/i[3]),e.rotate(G(this.angle)),e.fillStyle=this.selectionBackgroundColor,e.fillRect(-n.x/2,-n.y/2,n.x,n.y),e.restore(),this},drawBorders:function(i,e){e=e||{};var t=this._calculateCurrentDimensions(),n=this.borderScaleFactor,o=t.x+n,r=t.y+n,s=void 0!==e.hasControls?e.hasControls:this.hasControls,a=!1;return i.save(),i.strokeStyle=e.borderColor||this.borderColor,this._setLineDash(i,e.borderDashArray||this.borderDashArray,null),i.strokeRect(-o/2,-r/2,o,r),s&&(i.beginPath(),this.forEachControl(function(e,t,n){e.withConnection&&e.getVisibility(n,t)&&(a=!0,i.moveTo(e.x*o,e.y*r),i.lineTo(e.x*o+e.offsetX,e.y*r+e.offsetY))}),a&&i.stroke()),i.restore(),this},drawBordersInGroup:function(e,t,n){n=n||{};var i=Q.util.sizeAfterTransform(this.width,this.height,t),o=this.strokeWidth,r=this.strokeUniform,s=this.borderScaleFactor,a=i.x+o*(r?this.canvas.getZoom():t.scaleX)+s,l=i.y+o*(r?this.canvas.getZoom():t.scaleY)+s;return e.save(),this._setLineDash(e,n.borderDashArray||this.borderDashArray,null),e.strokeStyle=n.borderColor||this.borderColor,e.strokeRect(-a/2,-l/2,a,l),e.restore(),this},drawControls:function(i,o){return o=o||{},i.save(),i.setTransform(this.canvas.getRetinaScaling(),0,0,this.canvas.getRetinaScaling(),0,0),i.strokeStyle=i.fillStyle=o.cornerColor||this.cornerColor,this.transparentCorners||(i.strokeStyle=o.cornerStrokeColor||this.cornerStrokeColor),this._setLineDash(i,o.cornerDashArray||this.cornerDashArray,null),this.setCoords(),this.forEachControl(function(e,t,n){e.getVisibility(n,t)&&e.render(i,n.oCoords[t].x,n.oCoords[t].y,o,n)}),i.restore(),this},isControlVisible:function(e){return this.controls[e]&&this.controls[e].getVisibility(this,e)},setControlVisible:function(e,t){return this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[e]=t,this},setControlsVisibility:function(e){for(var t in e=e||{})this.setControlVisible(t,e[t]);return this},onDeselect:function(){},onSelect:function(){}}),Q.util.object.extend(Q.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(t,e){function n(){}var i=(e=e||{}).onComplete||n,o=e.onChange||n,r=this;return Q.util.animate({startValue:t.left,endValue:this.getCenter().left,duration:this.FX_DURATION,onChange:function(e){t.set("left",e),r.requestRenderAll(),o()},onComplete:function(){t.setCoords(),i()}}),this},fxCenterObjectV:function(t,e){function n(){}var i=(e=e||{}).onComplete||n,o=e.onChange||n,r=this;return Q.util.animate({startValue:t.top,endValue:this.getCenter().top,duration:this.FX_DURATION,onChange:function(e){t.set("top",e),r.requestRenderAll(),o()},onComplete:function(){t.setCoords(),i()}}),this},fxRemove:function(t,e){function n(){}var i=(e=e||{}).onComplete||n,o=e.onChange||n,r=this;return Q.util.animate({startValue:t.opacity,endValue:0,duration:this.FX_DURATION,onChange:function(e){t.set("opacity",e),r.requestRenderAll(),o()},onComplete:function(){r.remove(t),i()}}),this}}),Q.util.object.extend(Q.Object.prototype,{animate:function(){if(arguments[0]&&"object"==typeof arguments[0]){var e,t,n=[];for(e in arguments[0])n.push(e);for(var i=0,o=n.length;i<o;i++)e=n[i],t=i!==o-1,this._animate(e,arguments[0][e],arguments[1],t)}else this._animate.apply(this,arguments);return this},_animate:function(i,e,o,r){var s,a=this;e=e.toString(),o=o?Q.util.object.clone(o):{},~i.indexOf(".")&&(s=i.split("."));var t=-1<a.colorProperties.indexOf(i)||s&&-1<a.colorProperties.indexOf(s[1]),n=s?this.get(s[0])[s[1]]:this.get(i);"from"in o||(o.from=n),t||(e=~e.indexOf("=")?n+parseFloat(e.replace("=","")):parseFloat(e));var l={startValue:o.from,endValue:e,byValue:o.by,easing:o.easing,duration:o.duration,abort:o.abort&&function(){return o.abort.call(a)},onChange:function(e,t,n){s?a[s[0]][s[1]]=e:a.set(i,e),r||o.onChange&&o.onChange(e,t,n)},onComplete:function(e,t,n){r||(a.setCoords(),o.onComplete&&o.onComplete(e,t,n))}};t?Q.util.animateColor(l.startValue,l.endValue,l.duration,l):Q.util.animate(l)}}),function(){"use strict";var r=Pe.fabric||(Pe.fabric={}),s=r.util.object.extend,i=r.util.object.clone,n={x1:1,x2:1,y1:1,y2:1},o=r.StaticCanvas.supports("setLineDash");function e(e,t){var n=e.origin,i=e.axis1,o=e.axis2,r=e.dimension,s=t.nearest,a=t.center,l=t.farthest;return function(){switch(this.get(n)){case s:return Math.min(this.get(i),this.get(o));case a:return Math.min(this.get(i),this.get(o))+.5*this.get(r);case l:return Math.max(this.get(i),this.get(o))}}}r.Line?r.warn("fabric.Line is already defined"):(r.Line=r.util.createClass(r.Object,{type:"line",x1:0,y1:0,x2:0,y2:0,cacheProperties:r.Object.prototype.cacheProperties.concat("x1","x2","y1","y2"),initialize:function(e,t){e=e||[0,0,0,0],this.callSuper("initialize",t),this.set("x1",e[0]),this.set("y1",e[1]),this.set("x2",e[2]),this.set("y2",e[3]),this._setWidthHeight(t)},_setWidthHeight:function(e){e=e||{},this.width=Math.abs(this.x2-this.x1),this.height=Math.abs(this.y2-this.y1),this.left="left"in e?e.left:this._getLeftToOriginX(),this.top="top"in e?e.top:this._getTopToOriginY()},_set:function(e,t){return this.callSuper("_set",e,t),void 0!==n[e]&&this._setWidthHeight(),this},_getLeftToOriginX:e({origin:"originX",axis1:"x1",axis2:"x2",dimension:"width"},{nearest:"left",center:"center",farthest:"right"}),_getTopToOriginY:e({origin:"originY",axis1:"y1",axis2:"y2",dimension:"height"},{nearest:"top",center:"center",farthest:"bottom"}),_render:function(e){var t;e.beginPath(),(!this.strokeDashArray||this.strokeDashArray&&o)&&(t=this.calcLinePoints(),e.moveTo(t.x1,t.y1),e.lineTo(t.x2,t.y2)),e.lineWidth=this.strokeWidth;var n=e.strokeStyle;e.strokeStyle=this.stroke||e.fillStyle,this.stroke&&this._renderStroke(e),e.strokeStyle=n},_renderDashedStroke:function(e){var t=this.calcLinePoints();e.beginPath(),r.util.drawDashedLine(e,t.x1,t.y1,t.x2,t.y2,this.strokeDashArray),e.closePath()},_findCenterFromElement:function(){return{x:(this.x1+this.x2)/2,y:(this.y1+this.y2)/2}},toObject:function(e){return s(this.callSuper("toObject",e),this.calcLinePoints())},_getNonTransformedDimensions:function(){var e=this.callSuper("_getNonTransformedDimensions");return"butt"===this.strokeLineCap&&(0===this.width&&(e.y-=this.strokeWidth),0===this.height&&(e.x-=this.strokeWidth)),e},calcLinePoints:function(){var e=this.x1<=this.x2?-1:1,t=this.y1<=this.y2?-1:1,n=e*this.width*.5,i=t*this.height*.5;return{x1:n,x2:e*this.width*-.5,y1:i,y2:t*this.height*-.5}},_toSVG:function(){var e=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="',e.x1,'" y1="',e.y1,'" x2="',e.x2,'" y2="',e.y2,'" />\n']}}),r.Line.ATTRIBUTE_NAMES=r.SHARED_ATTRIBUTES.concat("x1 y1 x2 y2".split(" ")),r.Line.fromElement=function(e,t,n){n=n||{};var i=r.parseAttributes(e,r.Line.ATTRIBUTE_NAMES),o=[i.x1||0,i.y1||0,i.x2||0,i.y2||0];t(new r.Line(o,s(i,n)))},r.Line.fromObject=function(e,t){var n=i(e,!0);n.points=[e.x1,e.y1,e.x2,e.y2],r.Object._fromObject("Line",n,function(e){delete e.points,t&&t(e)},"points")})}(),function(){"use strict";var s=Pe.fabric||(Pe.fabric={}),a=Math.PI;s.Circle?s.warn("fabric.Circle is already defined."):(s.Circle=s.util.createClass(s.Object,{type:"circle",radius:0,startAngle:0,endAngle:2*a,cacheProperties:s.Object.prototype.cacheProperties.concat("radius","startAngle","endAngle"),_set:function(e,t){return this.callSuper("_set",e,t),"radius"===e&&this.setRadius(t),this},toObject:function(e){return this.callSuper("toObject",["radius","startAngle","endAngle"].concat(e))},_toSVG:function(){var e,t,n,i,o,r=(this.endAngle-this.startAngle)%(2*a);return 0==r?["<circle ","COMMON_PARTS",'cx="0" cy="0" ','r="',this.radius,'" />\n']:(e=s.util.cos(this.startAngle)*this.radius,t=s.util.sin(this.startAngle)*this.radius,n=s.util.cos(this.endAngle)*this.radius,i=s.util.sin(this.endAngle)*this.radius,o=a<r?"1":"0",['<path d="M '+e+" "+t," A "+this.radius+" "+this.radius," 0 ",+o+" 1"," "+n+" "+i,'" ',"COMMON_PARTS"," />\n"])},_render:function(e){e.beginPath(),e.arc(0,0,this.radius,this.startAngle,this.endAngle,!1),this._renderPaintInOrder(e)},getRadiusX:function(){return this.get("radius")*this.get("scaleX")},getRadiusY:function(){return this.get("radius")*this.get("scaleY")},setRadius:function(e){return this.radius=e,this.set("width",2*e).set("height",2*e)}}),s.Circle.ATTRIBUTE_NAMES=s.SHARED_ATTRIBUTES.concat("cx cy r".split(" ")),s.Circle.fromElement=function(e,t){var n=s.parseAttributes(e,s.Circle.ATTRIBUTE_NAMES);if(!("radius"in n&&0<=n.radius))throw new Error("value of `r` attribute is required and can not be negative");n.left=(n.left||0)-n.radius,n.top=(n.top||0)-n.radius,t(new s.Circle(n))},s.Circle.fromObject=function(e,t){return s.Object._fromObject("Circle",e,t)})}(),function(){"use strict";var i=Pe.fabric||(Pe.fabric={});i.Triangle?i.warn("fabric.Triangle is already defined"):(i.Triangle=i.util.createClass(i.Object,{type:"triangle",width:100,height:100,_render:function(e){var t=this.width/2,n=this.height/2;e.beginPath(),e.moveTo(-t,n),e.lineTo(0,-n),e.lineTo(t,n),e.closePath(),this._renderPaintInOrder(e)},_renderDashedStroke:function(e){var t=this.width/2,n=this.height/2;e.beginPath(),i.util.drawDashedLine(e,-t,n,0,-n,this.strokeDashArray),i.util.drawDashedLine(e,0,-n,t,n,this.strokeDashArray),i.util.drawDashedLine(e,t,n,-t,n,this.strokeDashArray),e.closePath()},_toSVG:function(){var e=this.width/2,t=this.height/2;return["<polygon ","COMMON_PARTS",'points="',[-e+" "+t,"0 "+-t,e+" "+t].join(","),'" />']}}),i.Triangle.fromObject=function(e,t){return i.Object._fromObject("Triangle",e,t)})}(),function(){"use strict";var i=Pe.fabric||(Pe.fabric={}),t=2*Math.PI;i.Ellipse?i.warn("fabric.Ellipse is already defined."):(i.Ellipse=i.util.createClass(i.Object,{type:"ellipse",rx:0,ry:0,cacheProperties:i.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(e){this.callSuper("initialize",e),this.set("rx",e&&e.rx||0),this.set("ry",e&&e.ry||0)},_set:function(e,t){switch(this.callSuper("_set",e,t),e){case"rx":this.rx=t,this.set("width",2*t);break;case"ry":this.ry=t,this.set("height",2*t)}return this},getRx:function(){return this.get("rx")*this.get("scaleX")},getRy:function(){return this.get("ry")*this.get("scaleY")},toObject:function(e){return this.callSuper("toObject",["rx","ry"].concat(e))},_toSVG:function(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" ','rx="',this.rx,'" ry="',this.ry,'" />\n']},_render:function(e){e.beginPath(),e.save(),e.transform(1,0,0,this.ry/this.rx,0,0),e.arc(0,0,this.rx,0,t,!1),e.restore(),this._renderPaintInOrder(e)}}),i.Ellipse.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("cx cy rx ry".split(" ")),i.Ellipse.fromElement=function(e,t){var n=i.parseAttributes(e,i.Ellipse.ATTRIBUTE_NAMES);n.left=(n.left||0)-n.rx,n.top=(n.top||0)-n.ry,t(new i.Ellipse(n))},i.Ellipse.fromObject=function(e,t){return i.Object._fromObject("Ellipse",e,t)})}(),function(){"use strict";var r=Pe.fabric||(Pe.fabric={}),s=r.util.object.extend;r.Rect?r.warn("fabric.Rect is already defined"):(r.Rect=r.util.createClass(r.Object,{stateProperties:r.Object.prototype.stateProperties.concat("rx","ry"),type:"rect",rx:0,ry:0,cacheProperties:r.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(e){this.callSuper("initialize",e),this._initRxRy()},_initRxRy:function(){this.rx&&!this.ry?this.ry=this.rx:this.ry&&!this.rx&&(this.rx=this.ry)},_render:function(e){var t=this.rx?Math.min(this.rx,this.width/2):0,n=this.ry?Math.min(this.ry,this.height/2):0,i=this.width,o=this.height,r=-this.width/2,s=-this.height/2,a=0!==t||0!==n,l=.4477152502;e.beginPath(),e.moveTo(r+t,s),e.lineTo(r+i-t,s),a&&e.bezierCurveTo(r+i-l*t,s,r+i,s+l*n,r+i,s+n),e.lineTo(r+i,s+o-n),a&&e.bezierCurveTo(r+i,s+o-l*n,r+i-l*t,s+o,r+i-t,s+o),e.lineTo(r+t,s+o),a&&e.bezierCurveTo(r+l*t,s+o,r,s+o-l*n,r,s+o-n),e.lineTo(r,s+n),a&&e.bezierCurveTo(r,s+l*n,r+l*t,s,r+t,s),e.closePath(),this._renderPaintInOrder(e)},_renderDashedStroke:function(e){var t=-this.width/2,n=-this.height/2,i=this.width,o=this.height;e.beginPath(),r.util.drawDashedLine(e,t,n,t+i,n,this.strokeDashArray),r.util.drawDashedLine(e,t+i,n,t+i,n+o,this.strokeDashArray),r.util.drawDashedLine(e,t+i,n+o,t,n+o,this.strokeDashArray),r.util.drawDashedLine(e,t,n+o,t,n,this.strokeDashArray),e.closePath()},toObject:function(e){return this.callSuper("toObject",["rx","ry"].concat(e))},_toSVG:function(){return["<rect ","COMMON_PARTS",'x="',-this.width/2,'" y="',-this.height/2,'" rx="',this.rx,'" ry="',this.ry,'" width="',this.width,'" height="',this.height,'" />\n']}}),r.Rect.ATTRIBUTE_NAMES=r.SHARED_ATTRIBUTES.concat("x y rx ry width height".split(" ")),r.Rect.fromElement=function(e,t,n){if(!e)return t(null);n=n||{};var i=r.parseAttributes(e,r.Rect.ATTRIBUTE_NAMES);i.left=i.left||0,i.top=i.top||0,i.height=i.height||0,i.width=i.width||0;var o=new r.Rect(s(n?r.util.object.clone(n):{},i));o.visible=o.visible&&0<o.width&&0<o.height,t(o)},r.Rect.fromObject=function(e,t){return r.Object._fromObject("Rect",e,t)})}(),function(){"use strict";var s=Pe.fabric||(Pe.fabric={}),a=s.util.object.extend,i=s.util.array.min,o=s.util.array.max,l=s.util.toFixed;s.Polyline?s.warn("fabric.Polyline is already defined"):(s.Polyline=s.util.createClass(s.Object,{type:"polyline",points:null,cacheProperties:s.Object.prototype.cacheProperties.concat("points"),initialize:function(e,t){t=t||{},this.points=e||[],this.callSuper("initialize",t),this._setPositionDimensions(t)},_setPositionDimensions:function(e){var t,n=this._calcDimensions(e);this.width=n.width,this.height=n.height,e.fromSVG||(t=this.translateToGivenOrigin({x:n.left-this.strokeWidth/2,y:n.top-this.strokeWidth/2},"left","top",this.originX,this.originY)),void 0===e.left&&(this.left=e.fromSVG?n.left:t.x),void 0===e.top&&(this.top=e.fromSVG?n.top:t.y),this.pathOffset={x:n.left+this.width/2,y:n.top+this.height/2}},_calcDimensions:function(){var e=this.points,t=i(e,"x")||0,n=i(e,"y")||0;return{left:t,top:n,width:(o(e,"x")||0)-t,height:(o(e,"y")||0)-n}},toObject:function(e){return a(this.callSuper("toObject",e),{points:this.points.concat()})},_toSVG:function(){for(var e=[],t=this.pathOffset.x,n=this.pathOffset.y,i=s.Object.NUM_FRACTION_DIGITS,o=0,r=this.points.length;o<r;o++)e.push(l(this.points[o].x-t,i),",",l(this.points[o].y-n,i)," ");return["<"+this.type+" ","COMMON_PARTS",'points="',e.join(""),'" />\n']},commonRender:function(e){var t,n=this.points.length,i=this.pathOffset.x,o=this.pathOffset.y;if(!n||isNaN(this.points[n-1].y))return!1;e.beginPath(),e.moveTo(this.points[0].x-i,this.points[0].y-o);for(var r=0;r<n;r++)t=this.points[r],e.lineTo(t.x-i,t.y-o);return!0},_render:function(e){this.commonRender(e)&&this._renderPaintInOrder(e)},_renderDashedStroke:function(e){var t,n;e.beginPath();for(var i=0,o=this.points.length;i<o;i++)t=this.points[i],n=this.points[i+1]||t,s.util.drawDashedLine(e,t.x,t.y,n.x,n.y,this.strokeDashArray)},complexity:function(){return this.get("points").length}}),s.Polyline.ATTRIBUTE_NAMES=s.SHARED_ATTRIBUTES.concat(),s.Polyline.fromElementGenerator=function(r){return function(e,t,n){if(!e)return t(null);n=n||{};var i=s.parsePointsAttribute(e.getAttribute("points")),o=s.parseAttributes(e,s[r].ATTRIBUTE_NAMES);o.fromSVG=!0,t(new s[r](i,a(o,n)))}},s.Polyline.fromElement=s.Polyline.fromElementGenerator("Polyline"),s.Polyline.fromObject=function(e,t){return s.Object._fromObject("Polyline",e,t,"points")})}(),function(){"use strict";var n=Pe.fabric||(Pe.fabric={});n.Polygon?n.warn("fabric.Polygon is already defined"):(n.Polygon=n.util.createClass(n.Polyline,{type:"polygon",_render:function(e){this.commonRender(e)&&(e.closePath(),this._renderPaintInOrder(e))},_renderDashedStroke:function(e){this.callSuper("_renderDashedStroke",e),e.closePath()}}),n.Polygon.ATTRIBUTE_NAMES=n.SHARED_ATTRIBUTES.concat(),n.Polygon.fromElement=n.Polyline.fromElementGenerator("Polygon"),n.Polygon.fromObject=function(e,t){return n.Object._fromObject("Polygon",e,t,"points")})}(),function(){"use strict";var d=Pe.fabric||(Pe.fabric={}),f=d.util.array.min,p=d.util.array.max,o=d.util.object.extend,i=Object.prototype.toString,t=d.util.toFixed;d.Path?d.warn("fabric.Path is already defined"):(d.Path=d.util.createClass(d.Object,{type:"path",path:null,cacheProperties:d.Object.prototype.cacheProperties.concat("path","fillRule"),stateProperties:d.Object.prototype.stateProperties.concat("path"),initialize:function(e,t){t=t||{},this.callSuper("initialize",t),e=e||[];var n="[object Array]"===i.call(e);this.path=n?d.util.makePathSimpler(e):d.util.makePathSimpler(d.util.parsePath(e)),this.path&&d.Polyline.prototype._setPositionDimensions.call(this,t)},_renderPathCommands:function(e){var t,n=0,i=0,o=0,r=0,s=0,a=0,l=-this.pathOffset.x,c=-this.pathOffset.y;e.beginPath();for(var u=0,h=this.path.length;u<h;++u)switch((t=this.path[u])[0]){case"L":o=t[1],r=t[2],e.lineTo(o+l,r+c);break;case"M":n=o=t[1],i=r=t[2],e.moveTo(o+l,r+c);break;case"C":o=t[5],r=t[6],s=t[3],a=t[4],e.bezierCurveTo(t[1]+l,t[2]+c,s+l,a+c,o+l,r+c);break;case"Q":e.quadraticCurveTo(t[1]+l,t[2]+c,t[3]+l,t[4]+c),o=t[3],r=t[4],s=t[1],a=t[2];break;case"z":case"Z":o=n,r=i,e.closePath()}},_render:function(e){this._renderPathCommands(e),this._renderPaintInOrder(e)},toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(e){return o(this.callSuper("toObject",e),{path:this.path.map(function(e){return e.slice()})})},toDatalessObject:function(e){var t=this.toObject(["sourcePath"].concat(e));return t.sourcePath&&delete t.path,t},_toSVG:function(){return["<path ","COMMON_PARTS",'d="',this.path.map(function(e){return e.join(" ")}).join(" "),'" stroke-linecap="round" ',"/>\n"]},_getOffsetTransform:function(){var e=d.Object.NUM_FRACTION_DIGITS;return" translate("+t(-this.pathOffset.x,e)+", "+t(-this.pathOffset.y,e)+")"},toClipPathSVG:function(e){var t=this._getOffsetTransform();return"\t"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:e,additionalTransform:t})},toSVG:function(e){var t=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:e,additionalTransform:t})},complexity:function(){return this.path.length},_calcDimensions:function(){for(var e,t,n=[],i=[],o=0,r=0,s=0,a=0,l=0,c=this.path.length;l<c;++l){switch((e=this.path[l])[0]){case"L":s=e[1],a=e[2],t=[];break;case"M":o=s=e[1],r=a=e[2],t=[];break;case"C":t=d.util.getBoundsOfCurve(s,a,e[1],e[2],e[3],e[4],e[5],e[6]),s=e[5],a=e[6];break;case"Q":t=d.util.getBoundsOfCurve(s,a,e[1],e[2],e[1],e[2],e[3],e[4]),s=e[3],a=e[4];break;case"z":case"Z":s=o,a=r}t.forEach(function(e){n.push(e.x),i.push(e.y)}),n.push(s),i.push(a)}var u=f(n)||0,h=f(i)||0;return{left:u,top:h,width:(p(n)||0)-u,height:(p(i)||0)-h}}}),d.Path.fromObject=function(n,i){var e;"string"==typeof n.sourcePath?(e=n.sourcePath,d.loadSVGFromURL(e,function(e){var t=e[0];t.setOptions(n),i&&i(t)})):d.Object._fromObject("Path",n,i,"path")},d.Path.ATTRIBUTE_NAMES=d.SHARED_ATTRIBUTES.concat(["d"]),d.Path.fromElement=function(e,t,n){var i=d.parseAttributes(e,d.Path.ATTRIBUTE_NAMES);i.fromSVG=!0,t(new d.Path(i.d,o(i,n)))})}(),function(){"use strict";var c=Pe.fabric||(Pe.fabric={}),u=c.util.array.min,h=c.util.array.max;c.Group||(c.Group=c.util.createClass(c.Object,c.Collection,{type:"group",strokeWidth:0,subTargetCheck:!1,cacheProperties:[],useSetOnGroup:!1,initialize:function(e,t,n){t=t||{},this._objects=[],n&&this.callSuper("initialize",t),this._objects=e||[];for(var i,o=this._objects.length;o--;)this._objects[o].group=this;n?this._updateObjectsACoords():(i=t&&t.centerPoint,void 0!==t.originX&&(this.originX=t.originX),void 0!==t.originY&&(this.originY=t.originY),i||this._calcBounds(),this._updateObjectsCoords(i),delete t.centerPoint,this.callSuper("initialize",t)),this.setCoords()},_updateObjectsACoords:function(){for(var e=this._objects.length;e--;)this._objects[e].setCoords(!0)},_updateObjectsCoords:function(e){for(var e=e||this.getCenterPoint(),t=this._objects.length;t--;)this._updateObjectCoords(this._objects[t],e)},_updateObjectCoords:function(e,t){var n=e.left,i=e.top;e.set({left:n-t.x,top:i-t.y}),e.group=this,e.setCoords(!0)},toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},addWithUpdate:function(e){return this._restoreObjectsState(),c.util.resetObjectTransform(this),e&&(this._objects.push(e),e.group=this,e._set("canvas",this.canvas)),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},removeWithUpdate:function(e){return this._restoreObjectsState(),c.util.resetObjectTransform(this),this.remove(e),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},_onObjectAdded:function(e){this.dirty=!0,e.group=this,e._set("canvas",this.canvas)},_onObjectRemoved:function(e){this.dirty=!0,delete e.group},_set:function(e,t){var n=this._objects.length;if(this.useSetOnGroup)for(;n--;)this._objects[n].setOnGroup(e,t);if("canvas"===e)for(;n--;)this._objects[n]._set(e,t);c.Object.prototype._set.call(this,e,t)},toObject:function(i){var o=this.includeDefaultValues,e=this._objects.map(function(e){var t=e.includeDefaultValues;e.includeDefaultValues=o;var n=e.toObject(i);return e.includeDefaultValues=t,n}),t=c.Object.prototype.toObject.call(this,i);return t.objects=e,t},toDatalessObject:function(i){var o,e=this.sourcePath||(o=this.includeDefaultValues,this._objects.map(function(e){var t=e.includeDefaultValues;e.includeDefaultValues=o;var n=e.toDatalessObject(i);return e.includeDefaultValues=t,n})),t=c.Object.prototype.toDatalessObject.call(this,i);return t.objects=e,t},render:function(e){this._transformDone=!0,this.callSuper("render",e),this._transformDone=!1},shouldCache:function(){var e=c.Object.prototype.shouldCache.call(this);if(e)for(var t=0,n=this._objects.length;t<n;t++)if(this._objects[t].willDrawShadow())return this.ownCaching=!1;return e},willDrawShadow:function(){if(c.Object.prototype.willDrawShadow.call(this))return!0;for(var e=0,t=this._objects.length;e<t;e++)if(this._objects[e].willDrawShadow())return!0;return!1},isOnACache:function(){return this.ownCaching||this.group&&this.group.isOnACache()},drawObject:function(e){for(var t=0,n=this._objects.length;t<n;t++)this._objects[t].render(e);this._drawClipPath(e)},isCacheDirty:function(e){if(this.callSuper("isCacheDirty",e))return!0;if(!this.statefullCache)return!1;for(var t,n,i=0,o=this._objects.length;i<o;i++)if(this._objects[i].isCacheDirty(!0))return this._cacheCanvas&&(t=this.cacheWidth/this.zoomX,n=this.cacheHeight/this.zoomY,this._cacheContext.clearRect(-t/2,-n/2,t,n)),!0;return!1},_restoreObjectsState:function(){return this._objects.forEach(this._restoreObjectState,this),this},realizeTransform:function(e){var t=e.calcTransformMatrix(),n=c.util.qrDecompose(t),i=new c.Point(n.translateX,n.translateY);return e.flipX=!1,e.flipY=!1,e.set("scaleX",n.scaleX),e.set("scaleY",n.scaleY),e.skewX=n.skewX,e.skewY=n.skewY,e.angle=n.angle,e.setPositionByOrigin(i,"center","center"),e},_restoreObjectState:function(e){return this.realizeTransform(e),delete e.group,e.setCoords(),this},destroy:function(){return this._objects.forEach(function(e){e.set("dirty",!0)}),this._restoreObjectsState()},toActiveSelection:function(){if(this.canvas){var e=this._objects,t=this.canvas;this._objects=[];var n=this.toObject();delete n.objects;var i=new c.ActiveSelection([]);return i.set(n),i.type="activeSelection",t.remove(this),e.forEach(function(e){e.group=i,e.dirty=!0,t.add(e)}),i.canvas=t,i._objects=e,(t._activeObject=i).setCoords(),i}},ungroupOnCanvas:function(){return this._restoreObjectsState()},setObjectsCoords:function(){return this.forEachObject(function(e){e.setCoords(!0)}),this},_calcBounds:function(e){for(var t,n,i,o=[],r=[],s=["tr","br","bl","tl"],a=0,l=this._objects.length,c=s.length;a<l;++a)for((t=this._objects[a]).aCoords=t.calcACoords(),i=0;i<c;i++)n=s[i],o.push(t.aCoords[n].x),r.push(t.aCoords[n].y);this._getBounds(o,r,e)},_getBounds:function(e,t,n){var i=new c.Point(u(e),u(t)),o=new c.Point(h(e),h(t)),r=i.y||0,s=i.x||0,a=o.x-i.x||0,l=o.y-i.y||0;this.width=a,this.height=l,n||this.setPositionByOrigin({x:s,y:r},"left","top")},_toSVG:function(e){for(var t=["<g ","COMMON_PARTS"," >\n"],n=0,i=this._objects.length;n<i;n++)t.push("\t\t",this._objects[n].toSVG(e));return t.push("</g>\n"),t},getSvgStyles:function(){var e=void 0!==this.opacity&&1!==this.opacity?"opacity: "+this.opacity+";":"",t=this.visible?"":" visibility: hidden;";return[e,this.getSvgFilter(),t].join("")},toClipPathSVG:function(e){for(var t=[],n=0,i=this._objects.length;n<i;n++)t.push("\t",this._objects[n].toClipPathSVG(e));return this._createBaseClipPathSVGMarkup(t,{reviver:e})}}),c.Group.fromObject=function(i,o){var n=i.objects,r=c.util.object.clone(i,!0);delete r.objects,"string"!=typeof n?c.util.enlivenObjects(n,function(n){c.util.enlivenObjects([i.clipPath],function(e){var t=c.util.object.clone(i,!0);t.clipPath=e[0],delete t.objects,o&&o(new c.Group(n,t,!0))})}):c.loadSVGFromURL(n,function(e){var t=c.util.groupSVGElements(e,i,n);t.set(r),o&&o(t)})})}(),function(){"use strict";var o=Pe.fabric||(Pe.fabric={});o.ActiveSelection||(o.ActiveSelection=o.util.createClass(o.Group,{type:"activeSelection",initialize:function(e,t){t=t||{},this._objects=e||[];for(var n=this._objects.length;n--;)this._objects[n].group=this;t.originX&&(this.originX=t.originX),t.originY&&(this.originY=t.originY),this._calcBounds(),this._updateObjectsCoords(),o.Object.prototype.initialize.call(this,t),this.setCoords()},toGroup:function(){var e=this._objects.concat();this._objects=[];var t=o.Object.prototype.toObject.call(this),n=new o.Group([]);if(delete t.type,n.set(t),e.forEach(function(e){e.canvas.remove(e),e.group=n}),n._objects=e,!this.canvas)return n;var i=this.canvas;return i.add(n),(i._activeObject=n).setCoords(),n},onDeselect:function(){return this.destroy(),!1},toString:function(){return"#<fabric.ActiveSelection: ("+this.complexity()+")>"},shouldCache:function(){return!1},isOnACache:function(){return!1},_renderControls:function(e,t,n){e.save(),e.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,this.callSuper("_renderControls",e,t),void 0===(n=n||{}).hasControls&&(n.hasControls=!1),n.forActiveSelection=!0;for(var i=0,o=this._objects.length;i<o;i++)this._objects[i]._renderControls(e,n);e.restore()}}),o.ActiveSelection.fromObject=function(t,n){o.util.enlivenObjects(t.objects,function(e){delete t.objects,n&&n(new o.ActiveSelection(e,t,!0))})})}(),function(e){"use strict";var o=Q.util.object.extend;e.fabric||(e.fabric={}),e.fabric.Image?Q.warn("fabric.Image is already defined."):(Q.Image=Q.util.createClass(Q.Object,{type:"image",strokeWidth:0,srcFromAttribute:!1,_lastScaleX:1,_lastScaleY:1,_filterScalingX:1,_filterScalingY:1,minimumScaleTrigger:.5,stateProperties:Q.Object.prototype.stateProperties.concat("cropX","cropY"),cacheKey:"",cropX:0,cropY:0,imageSmoothing:!0,initialize:function(e,t){t=t||{},this.filters=[],this.cacheKey="texture"+Q.Object.__uid++,this.callSuper("initialize",t),this._initElement(e,t)},getElement:function(){return this._element||{}},setElement:function(e,t){return this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._element=e,this._originalElement=e,this._initConfig(t),0!==this.filters.length&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters(),this},removeTexture:function(e){var t=Q.filterBackend;t&&t.evictCachesForKey&&t.evictCachesForKey(e)},dispose:function(){this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._cacheContext=void 0,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach(function(e){Q.util.cleanUpJsdomNode(this[e]),this[e]=void 0}.bind(this))},getCrossOrigin:function(){return this._originalElement&&(this._originalElement.crossOrigin||null)},getOriginalSize:function(){var e=this.getElement();return{width:e.naturalWidth||e.width,height:e.naturalHeight||e.height}},_stroke:function(e){var t,n;this.stroke&&0!==this.strokeWidth&&(t=this.width/2,n=this.height/2,e.beginPath(),e.moveTo(-t,-n),e.lineTo(t,-n),e.lineTo(t,n),e.lineTo(-t,n),e.lineTo(-t,-n),e.closePath())},_renderDashedStroke:function(e){var t=-this.width/2,n=-this.height/2,i=this.width,o=this.height;e.save(),this._setStrokeStyles(e,this),e.beginPath(),Q.util.drawDashedLine(e,t,n,t+i,n,this.strokeDashArray),Q.util.drawDashedLine(e,t+i,n,t+i,n+o,this.strokeDashArray),Q.util.drawDashedLine(e,t+i,n+o,t,n+o,this.strokeDashArray),Q.util.drawDashedLine(e,t,n+o,t,n,this.strokeDashArray),e.closePath(),e.restore()},toObject:function(e){var t=[];this.filters.forEach(function(e){e&&t.push(e.toObject())});var n=o(this.callSuper("toObject",["cropX","cropY"].concat(e)),{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:t});return this.resizeFilter&&(n.resizeFilter=this.resizeFilter.toObject()),n},hasCrop:function(){return this.cropX||this.cropY||this.width<this._element.width||this.height<this._element.height},_toSVG:function(){var e,t,n,i=[],o=[],r=this._element,s=-this.width/2,a=-this.height/2,l="",c="";return r?(this.hasCrop()&&(t=Q.Object.__uid++,i.push('<clipPath id="imageCrop_'+t+'">\n','\t<rect x="'+s+'" y="'+a+'" width="'+this.width+'" height="'+this.height+'" />\n',"</clipPath>\n"),l=' clip-path="url(#imageCrop_'+t+')" '),this.imageSmoothing||(c='" image-rendering="optimizeSpeed'),o.push("\t<image ","COMMON_PARTS",'xlink:href="',this.getSvgSrc(!0),'" x="',s-this.cropX,'" y="',a-this.cropY,'" width="',r.width||r.naturalWidth,'" height="',r.height||r.height,c,'"',l,"></image>\n"),(this.stroke||this.strokeDashArray)&&(n=this.fill,this.fill=null,e=["\t<rect ",'x="',s,'" y="',a,'" width="',this.width,'" height="',this.height,'" style="',this.getSvgStyles(),'"/>\n'],this.fill=n),i="fill"!==this.paintFirst?i.concat(e,o):i.concat(o,e)):[]},getSrc:function(e){var t=e?this._element:this._originalElement;return t?t.toDataURL?t.toDataURL():this.srcFromAttribute?t.getAttribute("src"):t.src:this.src||""},setSrc:function(e,n,i){return Q.util.loadImage(e,function(e,t){this.setElement(e,i),this._setWidthHeight(),n&&n(this,t)},this,i&&i.crossOrigin),this},toString:function(){return'#<fabric.Image: { src: "'+this.getSrc()+'" }>'},applyResizeFilters:function(){var e=this.resizeFilter,t=this.minimumScaleTrigger,n=this.getTotalObjectScaling(),i=n.scaleX,o=n.scaleY,r=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!e||t<i&&t<o)return this._element=r,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=i,void(this._lastScaleY=o);Q.filterBackend||(Q.filterBackend=Q.initFilterBackend());var s=Q.util.createCanvasElement(),a=this._filteredEl?this.cacheKey+"_filtered":this.cacheKey,l=r.width,c=r.height;s.width=l,s.height=c,this._element=s,this._lastScaleX=e.scaleX=i,this._lastScaleY=e.scaleY=o,Q.filterBackend.applyFilters([e],r,l,c,this._element,a),this._filterScalingX=s.width/this._originalElement.width,this._filterScalingY=s.height/this._originalElement.height},applyFilters:function(e){if(e=(e=e||this.filters||[]).filter(function(e){return e&&!e.isNeutralState()}),this.set("dirty",!0),this.removeTexture(this.cacheKey+"_filtered"),0===e.length)return this._element=this._originalElement,this._filteredEl=null,this._filterScalingX=1,this._filterScalingY=1,this;var t,n=this._originalElement,i=n.naturalWidth||n.width,o=n.naturalHeight||n.height;return this._element===this._originalElement?((t=Q.util.createCanvasElement()).width=i,t.height=o,this._element=t,this._filteredEl=t):(this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,i,o),this._lastScaleX=1,this._lastScaleY=1),Q.filterBackend||(Q.filterBackend=Q.initFilterBackend()),Q.filterBackend.applyFilters(e,this._originalElement,i,o,this._element,this.cacheKey),this._originalElement.width===this._element.width&&this._originalElement.height===this._element.height||(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height),this},_render:function(e){Q.util.setImageSmoothing(e,this.imageSmoothing),!0!==this.isMoving&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(e),this._renderPaintInOrder(e)},drawCacheOnCanvas:function(e){Q.util.setImageSmoothing(e,this.imageSmoothing),Q.Object.prototype.drawCacheOnCanvas.call(this,e)},shouldCache:function(){return this.needsItsOwnCache()},_renderFill:function(e){var t,n,i,o,r,s,a,l,c,u,h,d,f,p,g,m,v,y,b=this._element;b&&(t=this._filterScalingX,n=this._filterScalingY,i=this.width,o=this.height,r=Math.min,a=(s=Math.max)(this.cropX,0),l=s(this.cropY,0),c=b.naturalWidth||b.width,u=b.naturalHeight||b.height,d=l*n,f=r(i*t,c-(h=a*t)),p=r(o*n,u-d),g=-i/2,m=-o/2,v=r(i,c/t-a),y=r(o,u/t-l),b&&e.drawImage(b,h,d,f,p,g,m,v,y))},_needsResize:function(){var e=this.getTotalObjectScaling();return e.scaleX!==this._lastScaleX||e.scaleY!==this._lastScaleY},_resetWidthHeight:function(){this.set(this.getOriginalSize())},_initElement:function(e,t){this.setElement(Q.util.getById(e),t),Q.util.addClass(this.getElement(),Q.Image.CSS_CANVAS)},_initConfig:function(e){e=e||{},this.setOptions(e),this._setWidthHeight(e)},_initFilters:function(e,t){e&&e.length?Q.util.enlivenObjects(e,function(e){t&&t(e)},"fabric.Image.filters"):t&&t()},_setWidthHeight:function(e){e=e||{};var t=this.getElement();this.width=e.width||t.naturalWidth||t.width||0,this.height=e.height||t.naturalHeight||t.height||0},parsePreserveAspectRatioAttribute:function(){var e,t=Q.util.parsePreserveAspectRatioAttribute(this.preserveAspectRatio||""),n=this._element.width,i=this._element.height,o=1,r=1,s=0,a=0,l=0,c=0,u=this.width,h=this.height,d={width:u,height:h};return!t||"none"===t.alignX&&"none"===t.alignY?(o=u/n,r=h/i):("meet"===t.meetOrSlice&&(e=(u-n*(o=r=Q.util.findScaleToFit(this._element,d)))/2,"Min"===t.alignX&&(s=-e),"Max"===t.alignX&&(s=e),e=(h-i*r)/2,"Min"===t.alignY&&(a=-e),"Max"===t.alignY&&(a=e)),"slice"===t.meetOrSlice&&(e=n-u/(o=r=Q.util.findScaleToCover(this._element,d)),"Mid"===t.alignX&&(l=e/2),"Max"===t.alignX&&(l=e),e=i-h/r,"Mid"===t.alignY&&(c=e/2),"Max"===t.alignY&&(c=e),n=u/o,i=h/r)),{width:n,height:i,scaleX:o,scaleY:r,offsetLeft:s,offsetTop:a,cropX:l,cropY:c}}}),Q.Image.CSS_CANVAS="canvas-img",Q.Image.prototype.getSvgSrc=Q.Image.prototype.getSrc,Q.Image.fromObject=function(e,i){var o=Q.util.object.clone(e);Q.util.loadImage(o.src,function(n,e){e?i&&i(null,!0):Q.Image.prototype._initFilters.call(o,o.filters,function(e){o.filters=e||[],Q.Image.prototype._initFilters.call(o,[o.resizeFilter],function(e){o.resizeFilter=e[0],Q.util.enlivenObjects([o.clipPath],function(e){o.clipPath=e[0];var t=new Q.Image(n,o);i(t,!1)})})})},null,o.crossOrigin)},Q.Image.fromURL=function(e,n,i){Q.util.loadImage(e,function(e,t){n&&n(new Q.Image(e,i),t)},null,i&&i.crossOrigin)},Q.Image.ATTRIBUTE_NAMES=Q.SHARED_ATTRIBUTES.concat("x y width height preserveAspectRatio xlink:href crossOrigin image-rendering".split(" ")),Q.Image.fromElement=function(e,t,n){var i=Q.parseAttributes(e,Q.Image.ATTRIBUTE_NAMES);Q.Image.fromURL(i["xlink:href"],t,o(n?Q.util.object.clone(n):{},i))})}(Pe),Q.util.object.extend(Q.Object.prototype,{_getAngleValueForStraighten:function(){var e=this.angle%360;return 0<e?90*Math.round((e-1)/90):90*Math.round(e/90)},straighten:function(){return this.rotate(this._getAngleValueForStraighten()),this},fxStraighten:function(e){function t(){}var n=(e=e||{}).onComplete||t,i=e.onChange||t,o=this;return Q.util.animate({startValue:this.get("angle"),endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:function(e){o.rotate(e),i()},onComplete:function(){o.setCoords(),n()}}),this}}),Q.util.object.extend(Q.StaticCanvas.prototype,{straightenObject:function(e){return e.straighten(),this.requestRenderAll(),this},fxStraightenObject:function(e){return e.fxStraighten({onChange:this.requestRenderAllBound}),this}}),function(){"use strict";Q.isWebglSupported=function(e){if(Q.isLikelyNode)return!1;e=e||Q.WebglFilterBackend.prototype.tileSize;var t,n,i,o=document.createElement("canvas"),r=o.getContext("webgl")||o.getContext("experimental-webgl"),s=!1;if(r){Q.maxTextureSize=r.getParameter(r.MAX_TEXTURE_SIZE),s=Q.maxTextureSize>=e;for(var a=["highp","mediump","lowp"],l=0;l<3;l++)if(0,n="precision "+a[l]+" float;\nvoid main(){}",i=(t=r).createShader(t.FRAGMENT_SHADER),t.shaderSource(i,n),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)){Q.webGlPrecision=a[l];break}}return this.isSupported=s},(Q.WebglFilterBackend=function(e){e&&e.tileSize&&(this.tileSize=e.tileSize),this.setupGLContext(this.tileSize,this.tileSize),this.captureGPUInfo()}).prototype={tileSize:2048,resources:{},setupGLContext:function(e,t){this.dispose(),this.createWebGLCanvas(e,t),this.aPosition=new Float32Array([0,0,0,1,1,0,1,1]),this.chooseFastestCopyGLTo2DMethod(e,t)},chooseFastestCopyGLTo2DMethod:function(e,t){var n,i=void 0!==window.performance;try{new ImageData(1,1),n=!0}catch(e){n=!1}var o="undefined"!=typeof ArrayBuffer,r="undefined"!=typeof Uint8ClampedArray;if(i&&n&&o&&r){var s=Q.util.createCanvasElement(),a=new ArrayBuffer(e*t*4);if(Q.forceGLPutImageData)return this.imageBuffer=a,void(this.copyGLTo2D=Oe);var l,c,u={imageBuffer:a,destinationWidth:e,destinationHeight:t,targetCanvas:s};s.width=e,s.height=t,l=window.performance.now(),ke.call(u,this.gl,u),c=window.performance.now()-l,l=window.performance.now(),Oe.call(u,this.gl,u),window.performance.now()-l<c?(this.imageBuffer=a,this.copyGLTo2D=Oe):this.copyGLTo2D=ke}},createWebGLCanvas:function(e,t){var n=Q.util.createCanvasElement();n.width=e,n.height=t;var i={alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1},o=n.getContext("webgl",i);(o=o||n.getContext("experimental-webgl",i))&&(o.clearColor(0,0,0,0),this.canvas=n,this.gl=o)},applyFilters:function(e,t,n,i,o,r){var s,a=this.gl;r&&(s=this.getCachedTexture(r,t));var l,c,u,h,d,f={originalWidth:t.width||t.originalWidth,originalHeight:t.height||t.originalHeight,sourceWidth:n,sourceHeight:i,destinationWidth:n,destinationHeight:i,context:a,sourceTexture:this.createTexture(a,n,i,!s&&t),targetTexture:this.createTexture(a,n,i),originalTexture:s||this.createTexture(a,n,i,!s&&t),passes:e.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:o},p=a.createFramebuffer();return a.bindFramebuffer(a.FRAMEBUFFER,p),e.forEach(function(e){e&&e.applyTo(f)}),c=(l=f.targetCanvas).width,u=l.height,d=f.destinationHeight,c===(h=f.destinationWidth)&&u===d||(l.width=h,l.height=d),this.copyGLTo2D(a,f),a.bindTexture(a.TEXTURE_2D,null),a.deleteTexture(f.sourceTexture),a.deleteTexture(f.targetTexture),a.deleteFramebuffer(p),o.getContext("2d").setTransform(1,0,0,1,0,0),f},dispose:function(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()},clearWebGLCaches:function(){this.programCache={},this.textureCache={}},createTexture:function(e,t,n,i){var o=e.createTexture();return e.bindTexture(e.TEXTURE_2D,o),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),i?e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i):e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,n,0,e.RGBA,e.UNSIGNED_BYTE,null),o},getCachedTexture:function(e,t){if(this.textureCache[e])return this.textureCache[e];var n=this.createTexture(this.gl,t.width,t.height,t);return this.textureCache[e]=n},evictCachesForKey:function(e){this.textureCache[e]&&(this.gl.deleteTexture(this.textureCache[e]),delete this.textureCache[e])},copyGLTo2D:ke,captureGPUInfo:function(){if(this.gpuInfo)return this.gpuInfo;var e=this.gl,t={renderer:"",vendor:""};if(!e)return t;var n,i,o=e.getExtension("WEBGL_debug_renderer_info");return o&&(n=e.getParameter(o.UNMASKED_RENDERER_WEBGL),i=e.getParameter(o.UNMASKED_VENDOR_WEBGL),n&&(t.renderer=n.toLowerCase()),i&&(t.vendor=i.toLowerCase())),this.gpuInfo=t}}}(),function(){"use strict";function e(){}(Q.Canvas2dFilterBackend=function(){}).prototype={evictCachesForKey:e,dispose:e,clearWebGLCaches:e,resources:{},applyFilters:function(e,t,n,i,o){var r=o.getContext("2d");r.drawImage(t,0,0,n,i);var s={sourceWidth:n,sourceHeight:i,imageData:r.getImageData(0,0,n,i),originalEl:t,originalImageData:r.getImageData(0,0,n,i),canvasEl:o,ctx:r,filterBackend:this};return e.forEach(function(e){e.applyTo(s)}),s.imageData.width===n&&s.imageData.height===i||(o.width=s.imageData.width,o.height=s.imageData.height),r.putImageData(s.imageData,0,0),s}}}(),Q.Image=Q.Image||{},Q.Image.filters=Q.Image.filters||{},Q.Image.filters.BaseFilter=Q.util.createClass({type:"BaseFilter",vertexSource:"attribute vec2 aPosition;\nvarying vec2 vTexCoord;\nvoid main() {\nvTexCoord = aPosition;\ngl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);\n}",fragmentSource:"precision highp float;\nvarying vec2 vTexCoord;\nuniform sampler2D uTexture;\nvoid main() {\ngl_FragColor = texture2D(uTexture, vTexCoord);\n}",initialize:function(e){e&&this.setOptions(e)},setOptions:function(e){for(var t in e)this[t]=e[t]},createProgram:function(e,t,n){t=t||this.fragmentSource,n=n||this.vertexSource,"highp"!==Q.webGlPrecision&&(t=t.replace(/precision highp float/g,"precision "+Q.webGlPrecision+" float"));var i=e.createShader(e.VERTEX_SHADER);if(e.shaderSource(i,n),e.compileShader(i),!e.getShaderParameter(i,e.COMPILE_STATUS))throw new Error("Vertex shader compile error for "+this.type+": "+e.getShaderInfoLog(i));var o=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(o,t),e.compileShader(o),!e.getShaderParameter(o,e.COMPILE_STATUS))throw new Error("Fragment shader compile error for "+this.type+": "+e.getShaderInfoLog(o));var r=e.createProgram();if(e.attachShader(r,i),e.attachShader(r,o),e.linkProgram(r),!e.getProgramParameter(r,e.LINK_STATUS))throw new Error('Shader link error for "${this.type}" '+e.getProgramInfoLog(r));var s=this.getAttributeLocations(e,r),a=this.getUniformLocations(e,r)||{};return a.uStepW=e.getUniformLocation(r,"uStepW"),a.uStepH=e.getUniformLocation(r,"uStepH"),{program:r,attributeLocations:s,uniformLocations:a}},getAttributeLocations:function(e,t){return{aPosition:e.getAttribLocation(t,"aPosition")}},getUniformLocations:function(){return{}},sendAttributeData:function(e,t,n){var i=t.aPosition,o=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,o),e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0),e.bufferData(e.ARRAY_BUFFER,n,e.STATIC_DRAW)},_setupFrameBuffer:function(e){var t,n,i=e.context;1<e.passes?(t=e.destinationWidth,n=e.destinationHeight,e.sourceWidth===t&&e.sourceHeight===n||(i.deleteTexture(e.targetTexture),e.targetTexture=e.filterBackend.createTexture(i,t,n)),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,e.targetTexture,0)):(i.bindFramebuffer(i.FRAMEBUFFER,null),i.finish())},_swapTextures:function(e){e.passes--,e.pass++;var t=e.targetTexture;e.targetTexture=e.sourceTexture,e.sourceTexture=t},isNeutralState:function(){var e=this.mainParameter,t=Q.Image.filters[this.type].prototype;if(e){if(Array.isArray(t[e])){for(var n=t[e].length;n--;)if(this[e][n]!==t[e][n])return!1;return!0}return t[e]===this[e]}return!1},applyTo:function(e){e.webgl?(this._setupFrameBuffer(e),this.applyToWebGL(e),this._swapTextures(e)):this.applyTo2d(e)},retrieveShader:function(e){return e.programCache.hasOwnProperty(this.type)||(e.programCache[this.type]=this.createProgram(e.context)),e.programCache[this.type]},applyToWebGL:function(e){var t=e.context,n=this.retrieveShader(e);0===e.pass&&e.originalTexture?t.bindTexture(t.TEXTURE_2D,e.originalTexture):t.bindTexture(t.TEXTURE_2D,e.sourceTexture),t.useProgram(n.program),this.sendAttributeData(t,n.attributeLocations,e.aPosition),t.uniform1f(n.uniformLocations.uStepW,1/e.sourceWidth),t.uniform1f(n.uniformLocations.uStepH,1/e.sourceHeight),this.sendUniformData(t,n.uniformLocations),t.viewport(0,0,e.destinationWidth,e.destinationHeight),t.drawArrays(t.TRIANGLE_STRIP,0,4)},bindAdditionalTexture:function(e,t,n){e.activeTexture(n),e.bindTexture(e.TEXTURE_2D,t),e.activeTexture(e.TEXTURE0)},unbindAdditionalTexture:function(e,t){e.activeTexture(t),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE0)},getMainParameter:function(){return this[this.mainParameter]},setMainParameter:function(e){this[this.mainParameter]=e},sendUniformData:function(){},createHelpLayer:function(e){var t;e.helpLayer||((t=document.createElement("canvas")).width=e.sourceWidth,t.height=e.sourceHeight,e.helpLayer=t)},toObject:function(){var e={type:this.type},t=this.mainParameter;return t&&(e[t]=this[t]),e},toJSON:function(){return this.toObject()}}),Q.Image.filters.BaseFilter.fromObject=function(e,t){var n=new Q.Image.filters[e.type](e);return t&&t(n),n},function(){"use strict";var e=Pe.fabric||(Pe.fabric={}),t=e.Image.filters,n=e.util.createClass;t.ColorMatrix=n(t.BaseFilter,{type:"ColorMatrix",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nuniform mat4 uColorMatrix;\nuniform vec4 uConstants;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor *= uColorMatrix;\ncolor += uConstants;\ngl_FragColor = color;\n}",matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mainParameter:"matrix",colorsOnly:!0,initialize:function(e){this.callSuper("initialize",e),this.matrix=this.matrix.slice(0)},applyTo2d:function(e){for(var t,n,i,o,r=e.imageData.data,s=r.length,a=this.matrix,l=this.colorsOnly,c=0;c<s;c+=4)t=r[c],n=r[c+1],i=r[c+2],l?(r[c]=t*a[0]+n*a[1]+i*a[2]+255*a[4],r[c+1]=t*a[5]+n*a[6]+i*a[7]+255*a[9],r[c+2]=t*a[10]+n*a[11]+i*a[12]+255*a[14]):(o=r[c+3],r[c]=t*a[0]+n*a[1]+i*a[2]+o*a[3]+255*a[4],r[c+1]=t*a[5]+n*a[6]+i*a[7]+o*a[8]+255*a[9],r[c+2]=t*a[10]+n*a[11]+i*a[12]+o*a[13]+255*a[14],r[c+3]=t*a[15]+n*a[16]+i*a[17]+o*a[18]+255*a[19])},getUniformLocations:function(e,t){return{uColorMatrix:e.getUniformLocation(t,"uColorMatrix"),uConstants:e.getUniformLocation(t,"uConstants")}},sendUniformData:function(e,t){var n=this.matrix,i=[n[0],n[1],n[2],n[3],n[5],n[6],n[7],n[8],n[10],n[11],n[12],n[13],n[15],n[16],n[17],n[18]],o=[n[4],n[9],n[14],n[19]];e.uniformMatrix4fv(t.uColorMatrix,!1,i),e.uniform4fv(t.uConstants,o)}}),e.Image.filters.ColorMatrix.fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var e=Pe.fabric||(Pe.fabric={}),t=e.Image.filters,n=e.util.createClass;t.Brightness=n(t.BaseFilter,{type:"Brightness",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uBrightness;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor.rgb += uBrightness;\ngl_FragColor = color;\n}",brightness:0,mainParameter:"brightness",applyTo2d:function(e){if(0!==this.brightness)for(var t=e.imageData.data,n=t.length,i=Math.round(255*this.brightness),o=0;o<n;o+=4)t[o]=t[o]+i,t[o+1]=t[o+1]+i,t[o+2]=t[o+2]+i},getUniformLocations:function(e,t){return{uBrightness:e.getUniformLocation(t,"uBrightness")}},sendUniformData:function(e,t){e.uniform1f(t.uBrightness,this.brightness)}}),e.Image.filters.Brightness.fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var e=Pe.fabric||(Pe.fabric={}),t=e.util.object.extend,n=e.Image.filters,i=e.util.createClass;n.Convolute=i(n.BaseFilter,{type:"Convolute",opaque:!1,matrix:[0,0,0,0,1,0,0,0,0],fragmentSource:{Convolute_3_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[9];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 3.0; h+=1.0) {\nfor (float w = 0.0; w < 3.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_3_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[9];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 3.0; h+=1.0) {\nfor (float w = 0.0; w < 3.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_5_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[25];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 5.0; h+=1.0) {\nfor (float w = 0.0; w < 5.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_5_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[25];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 5.0; h+=1.0) {\nfor (float w = 0.0; w < 5.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_7_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[49];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 7.0; h+=1.0) {\nfor (float w = 0.0; w < 7.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_7_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[49];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 7.0; h+=1.0) {\nfor (float w = 0.0; w < 7.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}",Convolute_9_1:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[81];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 0);\nfor (float h = 0.0; h < 9.0; h+=1.0) {\nfor (float w = 0.0; w < 9.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));\ncolor += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];\n}\n}\ngl_FragColor = color;\n}",Convolute_9_0:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uMatrix[81];\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = vec4(0, 0, 0, 1);\nfor (float h = 0.0; h < 9.0; h+=1.0) {\nfor (float w = 0.0; w < 9.0; w+=1.0) {\nvec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));\ncolor.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];\n}\n}\nfloat alpha = texture2D(uTexture, vTexCoord).a;\ngl_FragColor = color;\ngl_FragColor.a = alpha;\n}"},retrieveShader:function(e){var t=Math.sqrt(this.matrix.length),n=this.type+"_"+t+"_"+(this.opaque?1:0),i=this.fragmentSource[n];return e.programCache.hasOwnProperty(n)||(e.programCache[n]=this.createProgram(e.context,i)),e.programCache[n]},applyTo2d:function(e){for(var t,n,i,o,r,s,a,l,c,u,h,d,f=e.imageData,p=f.data,g=this.matrix,m=Math.round(Math.sqrt(g.length)),v=Math.floor(m/2),y=f.width,b=f.height,C=e.ctx.createImageData(y,b),x=C.data,w=this.opaque?1:0,S=0;S<b;S++)for(u=0;u<y;u++){for(r=4*(S*y+u),d=o=i=n=t=0;d<m;d++)for(h=0;h<m;h++)s=u+h-v,(a=S+d-v)<0||b<=a||s<0||y<=s||(l=4*(a*y+s),c=g[d*m+h],t+=p[l]*c,n+=p[1+l]*c,i+=p[2+l]*c,w||(o+=p[3+l]*c));x[r]=t,x[1+r]=n,x[2+r]=i,x[3+r]=w?p[3+r]:o}e.imageData=C},getUniformLocations:function(e,t){return{uMatrix:e.getUniformLocation(t,"uMatrix"),uOpaque:e.getUniformLocation(t,"uOpaque"),uHalfSize:e.getUniformLocation(t,"uHalfSize"),uSize:e.getUniformLocation(t,"uSize")}},sendUniformData:function(e,t){e.uniform1fv(t.uMatrix,this.matrix)},toObject:function(){return t(this.callSuper("toObject"),{opaque:this.opaque,matrix:this.matrix})}}),e.Image.filters.Convolute.fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var e=Pe.fabric||(Pe.fabric={}),t=e.Image.filters,n=e.util.createClass;t.Grayscale=n(t.BaseFilter,{type:"Grayscale",fragmentSource:{average:"precision highp float;\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat average = (color.r + color.b + color.g) / 3.0;\ngl_FragColor = vec4(average, average, average, color.a);\n}",lightness:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uMode;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 col = texture2D(uTexture, vTexCoord);\nfloat average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;\ngl_FragColor = vec4(average, average, average, col.a);\n}",luminosity:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uMode;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 col = texture2D(uTexture, vTexCoord);\nfloat average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;\ngl_FragColor = vec4(average, average, average, col.a);\n}"},mode:"average",mainParameter:"mode",applyTo2d:function(e){for(var t,n=e.imageData.data,i=n.length,o=this.mode,r=0;r<i;r+=4)"average"===o?t=(n[r]+n[r+1]+n[r+2])/3:"lightness"===o?t=(Math.min(n[r],n[r+1],n[r+2])+Math.max(n[r],n[r+1],n[r+2]))/2:"luminosity"===o&&(t=.21*n[r]+.72*n[r+1]+.07*n[r+2]),n[r]=t,n[r+1]=t,n[r+2]=t},retrieveShader:function(e){var t,n=this.type+"_"+this.mode;return e.programCache.hasOwnProperty(n)||(t=this.fragmentSource[this.mode],e.programCache[n]=this.createProgram(e.context,t)),e.programCache[n]},getUniformLocations:function(e,t){return{uMode:e.getUniformLocation(t,"uMode")}},sendUniformData:function(e,t){e.uniform1i(t.uMode,1)},isNeutralState:function(){return!1}}),e.Image.filters.Grayscale.fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var e=Pe.fabric||(Pe.fabric={}),t=e.Image.filters,n=e.util.createClass;t.Invert=n(t.BaseFilter,{type:"Invert",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform int uInvert;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nif (uInvert == 1) {\ngl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);\n} else {\ngl_FragColor = color;\n}\n}",invert:!0,mainParameter:"invert",applyTo2d:function(e){for(var t=e.imageData.data,n=t.length,i=0;i<n;i+=4)t[i]=255-t[i],t[i+1]=255-t[i+1],t[i+2]=255-t[i+2]},isNeutralState:function(){return!this.invert},getUniformLocations:function(e,t){return{uInvert:e.getUniformLocation(t,"uInvert")}},sendUniformData:function(e,t){e.uniform1i(t.uInvert,this.invert)}}),e.Image.filters.Invert.fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var e=Pe.fabric||(Pe.fabric={}),t=e.util.object.extend,n=e.Image.filters,i=e.util.createClass;n.Noise=i(n.BaseFilter,{type:"Noise",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uStepH;\nuniform float uNoise;\nuniform float uSeed;\nvarying vec2 vTexCoord;\nfloat rand(vec2 co, float seed, float vScale) {\nreturn fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);\n}\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ncolor.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;\ngl_FragColor = color;\n}",mainParameter:"noise",noise:0,applyTo2d:function(e){if(0!==this.noise)for(var t,n=e.imageData.data,i=n.length,o=this.noise,r=0,i=n.length;r<i;r+=4)t=(.5-Math.random())*o,n[r]+=t,n[r+1]+=t,n[r+2]+=t},getUniformLocations:function(e,t){return{uNoise:e.getUniformLocation(t,"uNoise"),uSeed:e.getUniformLocation(t,"uSeed")}},sendUniformData:function(e,t){e.uniform1f(t.uNoise,this.noise/255),e.uniform1f(t.uSeed,Math.random())},toObject:function(){return t(this.callSuper("toObject"),{noise:this.noise})}}),e.Image.filters.Noise.fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var e=Pe.fabric||(Pe.fabric={}),t=e.Image.filters,n=e.util.createClass;t.Pixelate=n(t.BaseFilter,{type:"Pixelate",blocksize:4,mainParameter:"blocksize",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uBlocksize;\nuniform float uStepW;\nuniform float uStepH;\nvarying vec2 vTexCoord;\nvoid main() {\nfloat blockW = uBlocksize * uStepW;\nfloat blockH = uBlocksize * uStepW;\nint posX = int(vTexCoord.x / blockW);\nint posY = int(vTexCoord.y / blockH);\nfloat fposX = float(posX);\nfloat fposY = float(posY);\nvec2 squareCoords = vec2(fposX * blockW, fposY * blockH);\nvec4 color = texture2D(uTexture, squareCoords);\ngl_FragColor = color;\n}",applyTo2d:function(e){for(var t,n,i,o,r,s,a,l,c,u,h=e.imageData,d=h.data,f=h.height,p=h.width,g=0;g<f;g+=this.blocksize)for(n=0;n<p;n+=this.blocksize)for(i=d[t=4*g*p+4*n],o=d[1+t],r=d[2+t],s=d[3+t],c=Math.min(g+this.blocksize,f),u=Math.min(n+this.blocksize,p),a=g;a<c;a++)for(l=n;l<u;l++)d[t=4*a*p+4*l]=i,d[1+t]=o,d[2+t]=r,d[3+t]=s},isNeutralState:function(){return 1===this.blocksize},getUniformLocations:function(e,t){return{uBlocksize:e.getUniformLocation(t,"uBlocksize"),uStepW:e.getUniformLocation(t,"uStepW"),uStepH:e.getUniformLocation(t,"uStepH")}},sendUniformData:function(e,t){e.uniform1f(t.uBlocksize,this.blocksize)}}),e.Image.filters.Pixelate.fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var u=Pe.fabric||(Pe.fabric={}),e=u.util.object.extend,t=u.Image.filters,n=u.util.createClass;t.RemoveColor=n(t.BaseFilter,{type:"RemoveColor",color:"#FFFFFF",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec4 uLow;\nuniform vec4 uHigh;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_FragColor = texture2D(uTexture, vTexCoord);\nif(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {\ngl_FragColor.a = 0.0;\n}\n}",distance:.02,useAlpha:!1,applyTo2d:function(e){for(var t,n,i,o=e.imageData.data,r=255*this.distance,s=new u.Color(this.color).getSource(),a=[s[0]-r,s[1]-r,s[2]-r],l=[s[0]+r,s[1]+r,s[2]+r],c=0;c<o.length;c+=4)t=o[c],n=o[c+1],i=o[c+2],a[0]<t&&a[1]<n&&a[2]<i&&t<l[0]&&n<l[1]&&i<l[2]&&(o[c+3]=0)},getUniformLocations:function(e,t){return{uLow:e.getUniformLocation(t,"uLow"),uHigh:e.getUniformLocation(t,"uHigh")}},sendUniformData:function(e,t){var n=new u.Color(this.color).getSource(),i=parseFloat(this.distance),o=[0+n[0]/255-i,0+n[1]/255-i,0+n[2]/255-i,1],r=[n[0]/255+i,n[1]/255+i,n[2]/255+i,1];e.uniform4fv(t.uLow,o),e.uniform4fv(t.uHigh,r)},toObject:function(){return e(this.callSuper("toObject"),{color:this.color,distance:this.distance})}}),u.Image.filters.RemoveColor.fromObject=u.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var e=Pe.fabric||(Pe.fabric={}),t=e.Image.filters,n=e.util.createClass,i={Brownie:[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0],Vintage:[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0],Kodachrome:[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0],Technicolor:[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0],Polaroid:[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],Sepia:[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0],BlackWhite:[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]};for(var o in i)t[o]=n(t.ColorMatrix,{type:o,matrix:i[o],mainParameter:!1,colorsOnly:!0}),e.Image.filters[o].fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var d=Pe.fabric,e=d.Image.filters,t=d.util.createClass;e.BlendColor=t(e.BaseFilter,{type:"BlendColor",color:"#F95C63",mode:"multiply",alpha:1,fragmentSource:{multiply:"gl_FragColor.rgb *= uColor.rgb;\n",screen:"gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);\n",add:"gl_FragColor.rgb += uColor.rgb;\n",diff:"gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);\n",subtract:"gl_FragColor.rgb -= uColor.rgb;\n",lighten:"gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);\n",darken:"gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);\n",exclusion:"gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);\n",overlay:"if (uColor.r < 0.5) {\ngl_FragColor.r *= 2.0 * uColor.r;\n} else {\ngl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);\n}\nif (uColor.g < 0.5) {\ngl_FragColor.g *= 2.0 * uColor.g;\n} else {\ngl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);\n}\nif (uColor.b < 0.5) {\ngl_FragColor.b *= 2.0 * uColor.b;\n} else {\ngl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);\n}\n",tint:"gl_FragColor.rgb *= (1.0 - uColor.a);\ngl_FragColor.rgb += uColor.rgb;\n"},buildSource:function(e){return"precision highp float;\nuniform sampler2D uTexture;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\ngl_FragColor = color;\nif (color.a > 0.0) {\n"+this.fragmentSource[e]+"}\n}"},retrieveShader:function(e){var t,n=this.type+"_"+this.mode;return e.programCache.hasOwnProperty(n)||(t=this.buildSource(this.mode),e.programCache[n]=this.createProgram(e.context,t)),e.programCache[n]},applyTo2d:function(e){for(var t,n,i,o=e.imageData.data,r=o.length,s=1-this.alpha,a=new d.Color(this.color).getSource(),l=a[0]*this.alpha,c=a[1]*this.alpha,u=a[2]*this.alpha,h=0;h<r;h+=4)switch(t=o[h],n=o[h+1],i=o[h+2],this.mode){case"multiply":o[h]=t*l/255,o[h+1]=n*c/255,o[h+2]=i*u/255;break;case"screen":o[h]=255-(255-t)*(255-l)/255,o[h+1]=255-(255-n)*(255-c)/255,o[h+2]=255-(255-i)*(255-u)/255;break;case"add":o[h]=t+l,o[h+1]=n+c,o[h+2]=i+u;break;case"diff":case"difference":o[h]=Math.abs(t-l),o[h+1]=Math.abs(n-c),o[h+2]=Math.abs(i-u);break;case"subtract":o[h]=t-l,o[h+1]=n-c,o[h+2]=i-u;break;case"darken":o[h]=Math.min(t,l),o[h+1]=Math.min(n,c),o[h+2]=Math.min(i,u);break;case"lighten":o[h]=Math.max(t,l),o[h+1]=Math.max(n,c),o[h+2]=Math.max(i,u);break;case"overlay":o[h]=l<128?2*t*l/255:255-2*(255-t)*(255-l)/255,o[h+1]=c<128?2*n*c/255:255-2*(255-n)*(255-c)/255,o[h+2]=u<128?2*i*u/255:255-2*(255-i)*(255-u)/255;break;case"exclusion":o[h]=l+t-2*l*t/255,o[h+1]=c+n-2*c*n/255,o[h+2]=u+i-2*u*i/255;break;case"tint":o[h]=l+t*s,o[h+1]=c+n*s,o[h+2]=u+i*s}},getUniformLocations:function(e,t){return{uColor:e.getUniformLocation(t,"uColor")}},sendUniformData:function(e,t){var n=new d.Color(this.color).getSource();n[0]=this.alpha*n[0]/255,n[1]=this.alpha*n[1]/255,n[2]=this.alpha*n[2]/255,n[3]=this.alpha,e.uniform4fv(t.uColor,n)},toObject:function(){return{type:this.type,color:this.color,mode:this.mode,alpha:this.alpha}}}),d.Image.filters.BlendColor.fromObject=d.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var C=Pe.fabric,e=C.Image.filters,t=C.util.createClass;e.BlendImage=t(e.BaseFilter,{type:"BlendImage",image:null,mode:"multiply",alpha:1,vertexSource:"attribute vec2 aPosition;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nuniform mat3 uTransformMatrix;\nvoid main() {\nvTexCoord = aPosition;\nvTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;\ngl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);\n}",fragmentSource:{multiply:"precision highp float;\nuniform sampler2D uTexture;\nuniform sampler2D uImage;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec4 color2 = texture2D(uImage, vTexCoord2);\ncolor.rgba *= color2.rgba;\ngl_FragColor = color;\n}",mask:"precision highp float;\nuniform sampler2D uTexture;\nuniform sampler2D uImage;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec4 color2 = texture2D(uImage, vTexCoord2);\ncolor.a = color2.a;\ngl_FragColor = color;\n}"},retrieveShader:function(e){var t=this.type+"_"+this.mode,n=this.fragmentSource[this.mode];return e.programCache.hasOwnProperty(t)||(e.programCache[t]=this.createProgram(e.context,n)),e.programCache[t]},applyToWebGL:function(e){var t=e.context,n=this.createTexture(e.filterBackend,this.image);this.bindAdditionalTexture(t,n,t.TEXTURE1),this.callSuper("applyToWebGL",e),this.unbindAdditionalTexture(t,t.TEXTURE1)},createTexture:function(e,t){return e.getCachedTexture(t.cacheKey,t._element)},calculateMatrix:function(){var e=this.image,t=e._element.width,n=e._element.height;return[1/e.scaleX,0,0,0,1/e.scaleY,0,-e.left/t,-e.top/n,1]},applyTo2d:function(e){var t,n,i,o,r,s,a,l,c,u,h,d=e.imageData,f=e.filterBackend.resources,p=d.data,g=p.length,m=d.width,v=d.height,y=this.image;f.blendImage||(f.blendImage=C.util.createCanvasElement()),u=(c=f.blendImage).getContext("2d"),c.width!==m||c.height!==v?(c.width=m,c.height=v):u.clearRect(0,0,m,v),u.setTransform(y.scaleX,0,0,y.scaleY,y.left,y.top),u.drawImage(y._element,0,0,m,v),h=u.getImageData(0,0,m,v).data;for(var b=0;b<g;b+=4)switch(r=p[b],s=p[b+1],a=p[b+2],l=p[b+3],t=h[b],n=h[b+1],i=h[b+2],o=h[b+3],this.mode){case"multiply":p[b]=r*t/255,p[b+1]=s*n/255,p[b+2]=a*i/255,p[b+3]=l*o/255;break;case"mask":p[b+3]=o}},getUniformLocations:function(e,t){return{uTransformMatrix:e.getUniformLocation(t,"uTransformMatrix"),uImage:e.getUniformLocation(t,"uImage")}},sendUniformData:function(e,t){var n=this.calculateMatrix();e.uniform1i(t.uImage,1),e.uniformMatrix3fv(t.uTransformMatrix,!1,n)},toObject:function(){return{type:this.type,image:this.image&&this.image.toObject(),mode:this.mode,alpha:this.alpha}}}),C.Image.filters.BlendImage.fromObject=function(n,i){C.Image.fromObject(n.image,function(e){var t=C.util.object.clone(n);t.image=e,i(new C.Image.filters.BlendImage(t))})}}(),function(){"use strict";var v=Pe.fabric||(Pe.fabric={}),N=Math.pow,F=Math.floor,M=Math.sqrt,R=Math.abs,c=Math.round,i=Math.sin,D=Math.ceil,e=v.Image.filters,t=v.util.createClass;e.Resize=t(e.BaseFilter,{type:"Resize",resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3,getUniformLocations:function(e,t){return{uDelta:e.getUniformLocation(t,"uDelta"),uTaps:e.getUniformLocation(t,"uTaps")}},sendUniformData:function(e,t){e.uniform2fv(t.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),e.uniform1fv(t.uTaps,this.taps)},retrieveShader:function(e){var t,n=this.getFilterWindow(),i=this.type+"_"+n;return e.programCache.hasOwnProperty(i)||(t=this.generateShader(n),e.programCache[i]=this.createProgram(e.context,t)),e.programCache[i]},getFilterWindow:function(){var e=this.tempScale;return Math.ceil(this.lanczosLobes/e)},getTaps:function(){for(var e=this.lanczosCreate(this.lanczosLobes),t=this.tempScale,n=this.getFilterWindow(),i=new Array(n),o=1;o<=n;o++)i[o-1]=e(o*t);return i},generateShader:function(e){for(var t=new Array(e),n=this.fragmentSourceTOP,i=1;i<=e;i++)t[i-1]=i+".0 * uDelta";return n+="uniform float uTaps["+e+"];\n",n+="void main() {\n",n+="  vec4 color = texture2D(uTexture, vTexCoord);\n",n+="  float sum = 1.0;\n",t.forEach(function(e,t){n+="  color += texture2D(uTexture, vTexCoord + "+e+") * uTaps["+t+"];\n",n+="  color += texture2D(uTexture, vTexCoord - "+e+") * uTaps["+t+"];\n",n+="  sum += 2.0 * uTaps["+t+"];\n"}),n+="  gl_FragColor = color / sum;\n",n+="}"},fragmentSourceTOP:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec2 uDelta;\nvarying vec2 vTexCoord;\n",applyTo:function(e){e.webgl?(e.passes++,this.width=e.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=e.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),e.destinationWidth=this.dW,this._setupFrameBuffer(e),this.applyToWebGL(e),this._swapTextures(e),e.sourceWidth=e.destinationWidth,this.height=e.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),e.destinationHeight=this.dH,this._setupFrameBuffer(e),this.applyToWebGL(e),this._swapTextures(e),e.sourceHeight=e.destinationHeight):this.applyTo2d(e)},isNeutralState:function(){return 1===this.scaleX&&1===this.scaleY},lanczosCreate:function(n){return function(e){if(n<=e||e<=-n)return 0;if(e<1.1920929e-7&&-1.1920929e-7<e)return 1;var t=(e*=Math.PI)/n;return i(e)/e*i(t)/t}},applyTo2d:function(e){var t=e.imageData,n=this.scaleX,i=this.scaleY;this.rcpScaleX=1/n,this.rcpScaleY=1/i;var o,r=t.width,s=t.height,a=c(r*n),l=c(s*i);"sliceHack"===this.resizeType?o=this.sliceByTwo(e,r,s,a,l):"hermite"===this.resizeType?o=this.hermiteFastResize(e,r,s,a,l):"bilinear"===this.resizeType?o=this.bilinearFiltering(e,r,s,a,l):"lanczos"===this.resizeType&&(o=this.lanczosResize(e,r,s,a,l)),e.imageData=o},sliceByTwo:function(e,t,n,i,o){var r,s,a=e.imageData,l=!1,c=!1,u=.5*t,h=.5*n,d=v.filterBackend.resources,f=0,p=0,g=t,m=0;for(d.sliceByTwo||(d.sliceByTwo=document.createElement("canvas")),((r=d.sliceByTwo).width<1.5*t||r.height<n)&&(r.width=1.5*t,r.height=n),(s=r.getContext("2d")).clearRect(0,0,1.5*t,n),s.putImageData(a,0,0),i=F(i),o=F(o);!l||!c;)n=h,i<F(.5*(t=u))?u=F(.5*u):(u=i,l=!0),o<F(.5*h)?h=F(.5*h):(h=o,c=!0),s.drawImage(r,f,p,t,n,g,m,u,h),f=g,p=m,m+=h;return s.getImageData(f,p,i,o)},lanczosResize:function(e,p,g,m,v){var y=e.imageData.data,b=e.ctx.createImageData(m,v),C=b.data,x=this.lanczosCreate(this.lanczosLobes),w=this.rcpScaleX,S=this.rcpScaleY,_=2/this.rcpScaleX,E=2/this.rcpScaleY,T=D(w*this.lanczosLobes/2),k=D(S*this.lanczosLobes/2),O={},A={},P={};return function e(t){var n,i,o,r,s,a,l,c,u,h,d;for(A.x=(t+.5)*w,P.x=F(A.x),n=0;n<v;n++){for(A.y=(n+.5)*S,P.y=F(A.y),u=c=l=a=s=0,i=P.x-T;i<=P.x+T;i++)if(!(i<0||p<=i)){h=F(1e3*R(i-A.x)),O[h]||(O[h]={});for(var f=P.y-k;f<=P.y+k;f++)f<0||g<=f||(d=F(1e3*R(f-A.y)),O[h][d]||(O[h][d]=x(M(N(h*_,2)+N(d*E,2))/1e3)),0<(o=O[h][d])&&(s+=o,a+=o*y[r=4*(f*p+i)],l+=o*y[r+1],c+=o*y[r+2],u+=o*y[r+3]))}C[r=4*(n*m+t)]=a/s,C[r+1]=l/s,C[r+2]=c/s,C[r+3]=u/s}return++t<m?e(t):b}(0)},bilinearFiltering:function(e,t,n,i,o){for(var r,s,a,l,c,u,h,d,f=0,p=this.rcpScaleX,g=this.rcpScaleY,m=4*(t-1),v=e.imageData.data,y=e.ctx.createImageData(i,o),b=y.data,C=0;C<o;C++)for(a=0;a<i;a++)for(l=p*a-(r=F(p*a)),c=g*C-(s=F(g*C)),d=4*(s*t+r),u=0;u<4;u++)h=v[d+u]*(1-l)*(1-c)+v[4+d+u]*l*(1-c)+v[d+m+u]*c*(1-l)+v[d+m+4+u]*l*c,b[f++]=h;return y},hermiteFastResize:function(e,t,n,i,o){for(var r=this.rcpScaleX,s=this.rcpScaleY,a=D(r/2),l=D(s/2),c=e.imageData.data,u=e.ctx.createImageData(i,o),h=u.data,d=0;d<o;d++)for(var f=0;f<i;f++){for(var p=4*(f+d*i),g=0,m=0,v=0,y=0,b=0,C=0,x=0,w=(d+.5)*s,S=F(d*s);S<(d+1)*s;S++)for(var _=R(w-(S+.5))/l,E=(f+.5)*r,T=_*_,k=F(f*r);k<(f+1)*r;k++){var O=R(E-(k+.5))/a,A=M(T+O*O);1<A&&A<-1||0<(g=2*A*A*A-3*A*A+1)&&(x+=g*c[3+(O=4*(k+S*t))],v+=g,c[3+O]<255&&(g=g*c[3+O]/250),y+=g*c[O],b+=g*c[1+O],C+=g*c[2+O],m+=g)}h[p]=y/m,h[1+p]=b/m,h[2+p]=C/m,h[3+p]=x/v}return u},toObject:function(){return{type:this.type,scaleX:this.scaleX,scaleY:this.scaleY,resizeType:this.resizeType,lanczosLobes:this.lanczosLobes}}}),v.Image.filters.Resize.fromObject=v.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var e=Pe.fabric||(Pe.fabric={}),t=e.Image.filters,n=e.util.createClass;t.Contrast=n(t.BaseFilter,{type:"Contrast",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uContrast;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));\ncolor.rgb = contrastF * (color.rgb - 0.5) + 0.5;\ngl_FragColor = color;\n}",contrast:0,mainParameter:"contrast",applyTo2d:function(e){if(0!==this.contrast)for(var t=e.imageData.data,n=t.length,i=Math.floor(255*this.contrast),o=259*(i+255)/(255*(259-i)),r=0;r<n;r+=4)t[r]=o*(t[r]-128)+128,t[r+1]=o*(t[r+1]-128)+128,t[r+2]=o*(t[r+2]-128)+128},getUniformLocations:function(e,t){return{uContrast:e.getUniformLocation(t,"uContrast")}},sendUniformData:function(e,t){e.uniform1f(t.uContrast,this.contrast)}}),e.Image.filters.Contrast.fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var e=Pe.fabric||(Pe.fabric={}),t=e.Image.filters,n=e.util.createClass;t.Saturation=n(t.BaseFilter,{type:"Saturation",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform float uSaturation;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nfloat rgMax = max(color.r, color.g);\nfloat rgbMax = max(rgMax, color.b);\ncolor.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;\ncolor.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;\ncolor.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;\ngl_FragColor = color;\n}",saturation:0,mainParameter:"saturation",applyTo2d:function(e){if(0!==this.saturation)for(var t,n=e.imageData.data,i=n.length,o=-this.saturation,r=0;r<i;r+=4)t=Math.max(n[r],n[r+1],n[r+2]),n[r]+=t!==n[r]?(t-n[r])*o:0,n[r+1]+=t!==n[r+1]?(t-n[r+1])*o:0,n[r+2]+=t!==n[r+2]?(t-n[r+2])*o:0},getUniformLocations:function(e,t){return{uSaturation:e.getUniformLocation(t,"uSaturation")}},sendUniformData:function(e,t){e.uniform1f(t.uSaturation,-this.saturation)}}),e.Image.filters.Saturation.fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var p=Pe.fabric||(Pe.fabric={}),e=p.Image.filters,t=p.util.createClass;e.Blur=t(e.BaseFilter,{type:"Blur",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec2 uDelta;\nvarying vec2 vTexCoord;\nconst float nSamples = 15.0;\nvec3 v3offset = vec3(12.9898, 78.233, 151.7182);\nfloat random(vec3 scale) {\nreturn fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);\n}\nvoid main() {\nvec4 color = vec4(0.0);\nfloat total = 0.0;\nfloat offset = random(v3offset);\nfor (float t = -nSamples; t <= nSamples; t++) {\nfloat percent = (t + offset - 0.5) / nSamples;\nfloat weight = 1.0 - abs(percent);\ncolor += texture2D(uTexture, vTexCoord + uDelta * percent) * weight;\ntotal += weight;\n}\ngl_FragColor = color / total;\n}",blur:0,mainParameter:"blur",applyTo:function(e){e.webgl?(this.aspectRatio=e.sourceWidth/e.sourceHeight,e.passes++,this._setupFrameBuffer(e),this.horizontal=!0,this.applyToWebGL(e),this._swapTextures(e),this._setupFrameBuffer(e),this.horizontal=!1,this.applyToWebGL(e),this._swapTextures(e)):this.applyTo2d(e)},applyTo2d:function(e){e.imageData=this.simpleBlur(e)},simpleBlur:function(e){var t,n,i=e.filterBackend.resources,o=e.imageData.width,r=e.imageData.height;i.blurLayer1||(i.blurLayer1=p.util.createCanvasElement(),i.blurLayer2=p.util.createCanvasElement()),t=i.blurLayer1,n=i.blurLayer2,t.width===o&&t.height===r||(n.width=t.width=o,n.height=t.height=r);var s,a,l,c,u=t.getContext("2d"),h=n.getContext("2d"),d=.06*this.blur*.5;for(u.putImageData(e.imageData,0,0),h.clearRect(0,0,o,r),c=-15;c<=15;c++)l=d*(a=c/15)*o+(s=(Math.random()-.5)/4),h.globalAlpha=1-Math.abs(a),h.drawImage(t,l,s),u.drawImage(n,0,0),h.globalAlpha=1,h.clearRect(0,0,n.width,n.height);for(c=-15;c<=15;c++)l=d*(a=c/15)*r+(s=(Math.random()-.5)/4),h.globalAlpha=1-Math.abs(a),h.drawImage(t,s,l),u.drawImage(n,0,0),h.globalAlpha=1,h.clearRect(0,0,n.width,n.height);e.ctx.drawImage(t,0,0);var f=e.ctx.getImageData(0,0,t.width,t.height);return u.globalAlpha=1,u.clearRect(0,0,t.width,t.height),f},getUniformLocations:function(e,t){return{delta:e.getUniformLocation(t,"uDelta")}},sendUniformData:function(e,t){var n=this.chooseRightDelta();e.uniform2fv(t.delta,n)},chooseRightDelta:function(){var e,t=1,n=[0,0];return this.horizontal?1<this.aspectRatio&&(t=1/this.aspectRatio):this.aspectRatio<1&&(t=this.aspectRatio),e=t*this.blur*.12,this.horizontal?n[0]=e:n[1]=e,n}}),e.Blur.fromObject=p.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var e=Pe.fabric||(Pe.fabric={}),t=e.Image.filters,n=e.util.createClass;t.Gamma=n(t.BaseFilter,{type:"Gamma",fragmentSource:"precision highp float;\nuniform sampler2D uTexture;\nuniform vec3 uGamma;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 color = texture2D(uTexture, vTexCoord);\nvec3 correction = (1.0 / uGamma);\ncolor.r = pow(color.r, correction.r);\ncolor.g = pow(color.g, correction.g);\ncolor.b = pow(color.b, correction.b);\ngl_FragColor = color;\ngl_FragColor.rgb *= color.a;\n}",gamma:[1,1,1],mainParameter:"gamma",initialize:function(e){this.gamma=[1,1,1],t.BaseFilter.prototype.initialize.call(this,e)},applyTo2d:function(e){var t,n=e.imageData.data,i=this.gamma,o=n.length,r=1/i[0],s=1/i[1],a=1/i[2];for(this.rVals||(this.rVals=new Uint8Array(256),this.gVals=new Uint8Array(256),this.bVals=new Uint8Array(256)),t=0,o=256;t<o;t++)this.rVals[t]=255*Math.pow(t/255,r),this.gVals[t]=255*Math.pow(t/255,s),this.bVals[t]=255*Math.pow(t/255,a);for(t=0,o=n.length;t<o;t+=4)n[t]=this.rVals[n[t]],n[t+1]=this.gVals[n[t+1]],n[t+2]=this.bVals[n[t+2]]},getUniformLocations:function(e,t){return{uGamma:e.getUniformLocation(t,"uGamma")}},sendUniformData:function(e,t){e.uniform3fv(t.uGamma,this.gamma)}}),e.Image.filters.Gamma.fromObject=e.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var o=Pe.fabric||(Pe.fabric={}),e=o.Image.filters,t=o.util.createClass;e.Composed=t(e.BaseFilter,{type:"Composed",subFilters:[],initialize:function(e){this.callSuper("initialize",e),this.subFilters=this.subFilters.slice(0)},applyTo:function(t){t.passes+=this.subFilters.length-1,this.subFilters.forEach(function(e){e.applyTo(t)})},toObject:function(){return o.util.object.extend(this.callSuper("toObject"),{subFilters:this.subFilters.map(function(e){return e.toObject()})})},isNeutralState:function(){return!this.subFilters.some(function(e){return!e.isNeutralState()})}}),o.Image.filters.Composed.fromObject=function(e,t){var n=(e.subFilters||[]).map(function(e){return new o.Image.filters[e.type](e)}),i=new o.Image.filters.Composed({subFilters:n});return t&&t(i),i}}(),function(){"use strict";var r=Pe.fabric||(Pe.fabric={}),t=r.Image.filters,e=r.util.createClass;t.HueRotation=e(t.ColorMatrix,{type:"HueRotation",rotation:0,mainParameter:"rotation",calculateMatrix:function(){var e=this.rotation*Math.PI,t=r.util.cos(e),n=r.util.sin(e),i=Math.sqrt(1/3)*n,o=1-t;this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],this.matrix[0]=t+o/3,this.matrix[1]=1/3*o-i,this.matrix[2]=1/3*o+i,this.matrix[5]=1/3*o+i,this.matrix[6]=t+1/3*o,this.matrix[7]=1/3*o-i,this.matrix[10]=1/3*o-i,this.matrix[11]=1/3*o+i,this.matrix[12]=t+1/3*o},isNeutralState:function(e){return this.calculateMatrix(),t.BaseFilter.prototype.isNeutralState.call(this,e)},applyTo:function(e){this.calculateMatrix(),t.BaseFilter.prototype.applyTo.call(this,e)}}),r.Image.filters.HueRotation.fromObject=r.Image.filters.BaseFilter.fromObject}(),function(){"use strict";var f=Pe.fabric||(Pe.fabric={}),p=f.util.object.clone;f.Text?f.warn("fabric.Text is already defined"):(f.Text=f.util.createClass(f.Object,{_dimensionAffectingProps:["fontSize","fontWeight","fontFamily","fontStyle","lineHeight","text","charSpacing","textAlign","styles"],_reNewline:/\r?\n/,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,type:"text",fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:"left",fontStyle:"normal",lineHeight:1.16,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},textBackgroundColor:"",stateProperties:f.Object.prototype.stateProperties.concat("fontFamily","fontWeight","fontSize","text","underline","overline","linethrough","textAlign","fontStyle","lineHeight","textBackgroundColor","charSpacing","styles"),cacheProperties:f.Object.prototype.cacheProperties.concat("fontFamily","fontWeight","fontSize","text","underline","overline","linethrough","textAlign","fontStyle","lineHeight","textBackgroundColor","charSpacing","styles"),stroke:null,shadow:null,_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.315,overline:-.88},_fontSizeMult:1.13,charSpacing:0,styles:null,_measuringContext:null,deltaY:0,_styleProperties:["stroke","strokeWidth","fill","fontFamily","fontSize","fontWeight","fontStyle","underline","overline","linethrough","deltaY","textBackgroundColor"],__charBounds:[],CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,initialize:function(e,t){this.styles=t&&t.styles||{},this.text=e,this.__skipDimension=!0,this.callSuper("initialize",t),this.__skipDimension=!1,this.initDimensions(),this.setCoords(),this.setupState({propertySet:"_dimensionAffectingProps"})},getMeasuringContext:function(){return f._measuringContext||(f._measuringContext=this.canvas&&this.canvas.contextCache||f.util.createCanvasElement().getContext("2d")),f._measuringContext},_splitText:function(){var e=this._splitTextIntoLines(this.text);return this.textLines=e.lines,this._textLines=e.graphemeLines,this._unwrappedTextLines=e._unwrappedLines,this._text=e.graphemeText,e},initDimensions:function(){this.__skipDimension||(this._splitText(),this._clearCache(),this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,-1!==this.textAlign.indexOf("justify")&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))},enlargeSpaces:function(){for(var e,t,n,i,o,r,s,a=0,l=this._textLines.length;a<l;a++)if(("justify"===this.textAlign||a!==l-1&&!this.isEndOfWrapping(a))&&(i=0,o=this._textLines[a],(t=this.getLineWidth(a))<this.width&&(s=this.textLines[a].match(this._reSpacesAndTabs)))){n=s.length,e=(this.width-t)/n;for(var c=0,u=o.length;c<=u;c++)r=this.__charBounds[a][c],this._reSpaceAndTab.test(o[c])?(r.width+=e,r.kernedWidth+=e,r.left+=i,i+=e):r.left+=i}},isEndOfWrapping:function(e){return e===this._textLines.length-1},missingNewlineOffset:function(){return 1},toString:function(){return"#<fabric.Text ("+this.complexity()+'): { "text": "'+this.text+'", "fontFamily": "'+this.fontFamily+'" }>'},_getCacheCanvasDimensions:function(){var e=this.callSuper("_getCacheCanvasDimensions"),t=this.fontSize;return e.width+=t*e.zoomX,e.height+=t*e.zoomY,e},_render:function(e){this._setTextStyles(e),this._renderTextLinesBackground(e),this._renderTextDecoration(e,"underline"),this._renderText(e),this._renderTextDecoration(e,"overline"),this._renderTextDecoration(e,"linethrough")},_renderText:function(e){"stroke"===this.paintFirst?(this._renderTextStroke(e),this._renderTextFill(e)):(this._renderTextFill(e),this._renderTextStroke(e))},_setTextStyles:function(e,t,n){e.textBaseline="alphabetic",e.font=this._getFontDeclaration(t,n)},calcTextWidth:function(){for(var e=this.getLineWidth(0),t=1,n=this._textLines.length;t<n;t++){var i=this.getLineWidth(t);e<i&&(e=i)}return e},_renderTextLine:function(e,t,n,i,o,r){this._renderChars(e,t,n,i,o,r)},_renderTextLinesBackground:function(e){if(this.textBackgroundColor||this.styleHas("textBackgroundColor")){for(var t,n,i,o,r,s,a=0,l=e.fillStyle,c=this._getLeftOffset(),u=this._getTopOffset(),h=0,d=0,f=0,p=this._textLines.length;f<p;f++)if(t=this.getHeightOfLine(f),this.textBackgroundColor||this.styleHas("textBackgroundColor",f)){i=this._textLines[f],n=this._getLineLeftOffset(f),h=d=0,o=this.getValueOfPropertyAt(f,0,"textBackgroundColor");for(var g=0,m=i.length;g<m;g++)r=this.__charBounds[f][g],(s=this.getValueOfPropertyAt(f,g,"textBackgroundColor"))!==o?((e.fillStyle=o)&&e.fillRect(c+n+h,u+a,d,t/this.lineHeight),h=r.left,d=r.width,o=s):d+=r.kernedWidth;s&&(e.fillStyle=s,e.fillRect(c+n+h,u+a,d,t/this.lineHeight)),a+=t}else a+=t;e.fillStyle=l,this._removeShadow(e)}},getFontCache:function(e){var t=e.fontFamily.toLowerCase();f.charWidthsCache[t]||(f.charWidthsCache[t]={});var n=f.charWidthsCache[t],i=e.fontStyle.toLowerCase()+"_"+(e.fontWeight+"").toLowerCase();return n[i]||(n[i]={}),n[i]},_applyCharStyles:function(e,t,n,i,o){this._setFillStyles(t,o),this._setStrokeStyles(t,o),t.font=this._getFontDeclaration(o)},_measureChar:function(e,t,n,i){var o,r,s,a,l,c=this.getFontCache(t),u=n+e,h=this._getFontDeclaration(t)===this._getFontDeclaration(i),d=t.fontSize/this.CACHE_FONT_SIZE;return n&&void 0!==c[n]&&(s=c[n]),void 0!==c[e]&&(a=o=c[e]),h&&void 0!==c[u]&&(a=(r=c[u])-s),void 0!==o&&void 0!==s&&void 0!==r||(l=this.getMeasuringContext(),this._setTextStyles(l,t,!0)),void 0===o&&(a=o=l.measureText(e).width,c[e]=o),void 0===s&&h&&n&&(s=l.measureText(n).width,c[n]=s),h&&void 0===r&&(r=l.measureText(u).width,a=(c[u]=r)-s),{width:o*d,kernedWidth:a*d}},getHeightOfChar:function(e,t){return this.getValueOfPropertyAt(e,t,"fontSize")},measureLine:function(e){var t=this._measureLine(e);return 0!==this.charSpacing&&(t.width-=this._getWidthOfCharSpacing()),t.width<0&&(t.width=0),t},_measureLine:function(e){var t,n,i,o,r=0,s=this._textLines[e],a=new Array(s.length);for(this.__charBounds[e]=a,t=0;t<s.length;t++)n=s[t],o=this._getGraphemeBox(n,e,t,i),r+=(a[t]=o).kernedWidth,i=n;return a[t]={left:o?o.left+o.width:0,width:0,kernedWidth:0,height:this.fontSize},{width:r,numOfSpaces:0}},_getGraphemeBox:function(e,t,n,i,o){var r,s=this.getCompleteStyleDeclaration(t,n),a=i?this.getCompleteStyleDeclaration(t,n-1):{},l=this._measureChar(e,s,i,a),c=l.kernedWidth,u=l.width;0!==this.charSpacing&&(u+=r=this._getWidthOfCharSpacing(),c+=r);var h,d={width:u,left:0,height:s.fontSize,kernedWidth:c,deltaY:s.deltaY};return 0<n&&!o&&(h=this.__charBounds[t][n-1],d.left=h.left+h.width+l.kernedWidth-l.width),d},getHeightOfLine:function(e){if(this.__lineHeights[e])return this.__lineHeights[e];for(var t=this._textLines[e],n=this.getHeightOfChar(e,0),i=1,o=t.length;i<o;i++)n=Math.max(this.getHeightOfChar(e,i),n);return this.__lineHeights[e]=n*this.lineHeight*this._fontSizeMult},calcTextHeight:function(){for(var e,t=0,n=0,i=this._textLines.length;n<i;n++)e=this.getHeightOfLine(n),t+=n===i-1?e/this.lineHeight:e;return t},_getLeftOffset:function(){return-this.width/2},_getTopOffset:function(){return-this.height/2},_renderTextCommon:function(e,t){e.save();for(var n=0,i=this._getLeftOffset(),o=this._getTopOffset(),r=this._applyPatternGradientTransform(e,"fillText"===t?this.fill:this.stroke),s=0,a=this._textLines.length;s<a;s++){var l=this.getHeightOfLine(s),c=l/this.lineHeight,u=this._getLineLeftOffset(s);this._renderTextLine(t,e,this._textLines[s],i+u-r.offsetX,o+n+c-r.offsetY,s),n+=l}e.restore()},_renderTextFill:function(e){(this.fill||this.styleHas("fill"))&&this._renderTextCommon(e,"fillText")},_renderTextStroke:function(e){(this.stroke&&0!==this.strokeWidth||!this.isEmptyStyles())&&(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(e),e.save(),this._setLineDash(e,this.strokeDashArray),e.beginPath(),this._renderTextCommon(e,"strokeText"),e.closePath(),e.restore())},_renderChars:function(e,t,n,i,o,r){var s,a,l,c,u=this.getHeightOfLine(r),h=-1!==this.textAlign.indexOf("justify"),d="",f=0,p=!h&&0===this.charSpacing&&this.isEmptyStyles(r);if(t.save(),o-=u*this._fontSizeFraction/this.lineHeight,p)return this._renderChar(e,t,r,0,n.join(""),i,o,u),void t.restore();for(var g=0,m=n.length-1;g<=m;g++)c=g===m||this.charSpacing,d+=n[g],l=this.__charBounds[r][g],0===f?(i+=l.kernedWidth-l.width,f+=l.width):f+=l.kernedWidth,h&&!c&&this._reSpaceAndTab.test(n[g])&&(c=!0),c||(s=s||this.getCompleteStyleDeclaration(r,g),a=this.getCompleteStyleDeclaration(r,g+1),c=this._hasStyleChanged(s,a)),c&&(this._renderChar(e,t,r,g,d,i,o,u),d="",s=a,i+=f,f=0);t.restore()},_renderChar:function(e,t,n,i,o,r,s){var a=this._getStyleDeclaration(n,i),l=this.getCompleteStyleDeclaration(n,i),c="fillText"===e&&l.fill,u="strokeText"===e&&l.stroke&&l.strokeWidth;(u||c)&&(a&&t.save(),this._applyCharStyles(e,t,n,i,l),a&&a.textBackgroundColor&&this._removeShadow(t),a&&a.deltaY&&(s+=a.deltaY),c&&t.fillText(o,r,s),u&&t.strokeText(o,r,s),a&&t.restore())},setSuperscript:function(e,t){return this._setScript(e,t,this.superscript)},setSubscript:function(e,t){return this._setScript(e,t,this.subscript)},_setScript:function(e,t,n){var i=this.get2DCursorLocation(e,!0),o=this.getValueOfPropertyAt(i.lineIndex,i.charIndex,"fontSize"),r=this.getValueOfPropertyAt(i.lineIndex,i.charIndex,"deltaY"),s={fontSize:o*n.size,deltaY:r+o*n.baseline};return this.setSelectionStyles(s,e,t),this},_hasStyleChanged:function(e,t){return e.fill!==t.fill||e.stroke!==t.stroke||e.strokeWidth!==t.strokeWidth||e.fontSize!==t.fontSize||e.fontFamily!==t.fontFamily||e.fontWeight!==t.fontWeight||e.fontStyle!==t.fontStyle||e.deltaY!==t.deltaY},_hasStyleChangedForSvg:function(e,t){return this._hasStyleChanged(e,t)||e.overline!==t.overline||e.underline!==t.underline||e.linethrough!==t.linethrough},_getLineLeftOffset:function(e){var t=this.getLineWidth(e);return"center"===this.textAlign?(this.width-t)/2:"right"===this.textAlign?this.width-t:"justify-center"===this.textAlign&&this.isEndOfWrapping(e)?(this.width-t)/2:"justify-right"===this.textAlign&&this.isEndOfWrapping(e)?this.width-t:0},_clearCache:function(){this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]},_shouldClearDimensionCache:function(){var e=this._forceClearCache;return(e=e||this.hasStateChanged("_dimensionAffectingProps"))&&(this.dirty=!0,this._forceClearCache=!1),e},getLineWidth:function(e){if(this.__lineWidths[e])return this.__lineWidths[e];var t=""===this._textLines[e]?0:this.measureLine(e).width;return this.__lineWidths[e]=t},_getWidthOfCharSpacing:function(){return 0!==this.charSpacing?this.fontSize*this.charSpacing/1e3:0},getValueOfPropertyAt:function(e,t,n){var i=this._getStyleDeclaration(e,t);return i&&void 0!==i[n]?i[n]:this[n]},_renderTextDecoration:function(e,t){if(this[t]||this.styleHas(t)){for(var n,i,o,r,s,a,l,c,u,h,d,f,p,g,m,v,y=this._getLeftOffset(),b=this._getTopOffset(),C=this._getWidthOfCharSpacing(),x=0,w=this._textLines.length;x<w;x++)if(n=this.getHeightOfLine(x),this[t]||this.styleHas(t,x)){l=this._textLines[x],g=n/this.lineHeight,r=this._getLineLeftOffset(x),d=h=0,c=this.getValueOfPropertyAt(x,0,t),v=this.getValueOfPropertyAt(x,0,"fill"),u=b+g*(1-this._fontSizeFraction),i=this.getHeightOfChar(x,0),s=this.getValueOfPropertyAt(x,0,"deltaY");for(var S=0,_=l.length;S<_;S++)f=this.__charBounds[x][S],p=this.getValueOfPropertyAt(x,S,t),m=this.getValueOfPropertyAt(x,S,"fill"),o=this.getHeightOfChar(x,S),a=this.getValueOfPropertyAt(x,S,"deltaY"),(p!==c||m!==v||o!==i||a!==s)&&0<d?(e.fillStyle=v,c&&v&&e.fillRect(y+r+h,u+this.offsets[t]*i+s,d,this.fontSize/15),h=f.left,d=f.width,c=p,v=m,i=o,s=a):d+=f.kernedWidth;e.fillStyle=m,p&&m&&e.fillRect(y+r+h,u+this.offsets[t]*i+s,d-C,this.fontSize/15),b+=n}else b+=n;this._removeShadow(e)}},_getFontDeclaration:function(e,t){var n=e||this,i=this.fontFamily,o=-1<f.Text.genericFonts.indexOf(i.toLowerCase()),r=void 0===i||-1<i.indexOf("'")||-1<i.indexOf(",")||-1<i.indexOf('"')||o?n.fontFamily:'"'+n.fontFamily+'"';return[f.isLikelyNode?n.fontWeight:n.fontStyle,f.isLikelyNode?n.fontStyle:n.fontWeight,t?this.CACHE_FONT_SIZE+"px":n.fontSize+"px",r].join(" ")},render:function(e){this.visible&&(this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._shouldClearDimensionCache()&&this.initDimensions(),this.callSuper("render",e)))},_splitTextIntoLines:function(e){for(var t=e.split(this._reNewline),n=new Array(t.length),i=["\n"],o=[],r=0;r<t.length;r++)n[r]=f.util.string.graphemeSplit(t[r]),o=o.concat(n[r],i);return o.pop(),{_unwrappedLines:n,lines:t,graphemeText:o,graphemeLines:n}},toObject:function(e){var t=["text","fontSize","fontWeight","fontFamily","fontStyle","lineHeight","underline","overline","linethrough","textAlign","textBackgroundColor","charSpacing"].concat(e),n=this.callSuper("toObject",t);return n.styles=p(this.styles,!0),n},set:function(e,t){this.callSuper("set",e,t);var n=!1;if("object"==typeof e)for(var i in e)n=n||-1!==this._dimensionAffectingProps.indexOf(i);else n=-1!==this._dimensionAffectingProps.indexOf(e);return n&&(this.initDimensions(),this.setCoords()),this},complexity:function(){return 1}}),f.Text.ATTRIBUTE_NAMES=f.SHARED_ATTRIBUTES.concat("x y dx dy font-family font-style font-weight font-size letter-spacing text-decoration text-anchor".split(" ")),f.Text.DEFAULT_SVG_FONT_SIZE=16,f.Text.fromElement=function(e,t,n){if(!e)return t(null);var i,o=f.parseAttributes(e,f.Text.ATTRIBUTE_NAMES),r=o.textAnchor||"left";(n=f.util.object.extend(n?p(n):{},o)).top=n.top||0,n.left=n.left||0,o.textDecoration&&(-1!==(i=o.textDecoration).indexOf("underline")&&(n.underline=!0),-1!==i.indexOf("overline")&&(n.overline=!0),-1!==i.indexOf("line-through")&&(n.linethrough=!0),delete n.textDecoration),"dx"in o&&(n.left+=o.dx),"dy"in o&&(n.top+=o.dy),"fontSize"in n||(n.fontSize=f.Text.DEFAULT_SVG_FONT_SIZE);var s="";"textContent"in e?s=e.textContent:"firstChild"in e&&null!==e.firstChild&&"data"in e.firstChild&&null!==e.firstChild.data&&(s=e.firstChild.data),s=s.replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," ");var a=n.strokeWidth;n.strokeWidth=0;var l=new f.Text(s,n),c=l.getScaledHeight()/l.height,u=((l.height+l.strokeWidth)*l.lineHeight-l.height)*c,h=l.getScaledHeight()+u,d=0;"center"===r&&(d=l.getScaledWidth()/2),"right"===r&&(d=l.getScaledWidth()),l.set({left:l.left-d,top:l.top-(h-l.fontSize*(.07+l._fontSizeFraction))/l.lineHeight,strokeWidth:void 0!==a?a:1}),t(l)},f.Text.fromObject=function(e,t){return f.Object._fromObject("Text",e,t,"text")},f.Text.genericFonts=["sans-serif","serif","cursive","fantasy","monospace"],f.util.createAccessors&&f.util.createAccessors(f.Text))}(),Q.util.object.extend(Q.Text.prototype,{isEmptyStyles:function(e){if(!this.styles)return!0;if(void 0!==e&&!this.styles[e])return!0;var t=void 0===e?this.styles:{line:this.styles[e]};for(var n in t)for(var i in t[n])for(var o in t[n][i])return!1;return!0},styleHas:function(e,t){if(!this.styles||!e||""===e)return!1;if(void 0!==t&&!this.styles[t])return!1;var n=void 0===t?this.styles:{0:this.styles[t]};for(var i in n)for(var o in n[i])if(void 0!==n[i][o][e])return!0;return!1},cleanStyle:function(e){if(!this.styles||!e||""===e)return!1;var t,n,i,o=this.styles,r=0,s=!0,a=0;for(var l in o){for(var c in t=0,o[l])r++,(i=o[l][c]).hasOwnProperty(e)?(n?i[e]!==n&&(s=!1):n=i[e],i[e]===this[e]&&delete i[e]):s=!1,0!==Object.keys(i).length?t++:delete o[l][c];0===t&&delete o[l]}for(var u=0;u<this._textLines.length;u++)a+=this._textLines[u].length;s&&r===a&&(this[e]=n,this.removeStyle(e))},removeStyle:function(e){if(this.styles&&e&&""!==e){var t,n,i,o=this.styles;for(n in o){for(i in t=o[n])delete t[i][e],0===Object.keys(t[i]).length&&delete t[i];0===Object.keys(t).length&&delete o[n]}}},_extendStyles:function(e,t){var n=this.get2DCursorLocation(e);this._getLineStyle(n.lineIndex)||this._setLineStyle(n.lineIndex),this._getStyleDeclaration(n.lineIndex,n.charIndex)||this._setStyleDeclaration(n.lineIndex,n.charIndex,{}),Q.util.object.extend(this._getStyleDeclaration(n.lineIndex,n.charIndex),t)},get2DCursorLocation:function(e,t){void 0===e&&(e=this.selectionStart);for(var n=t?this._unwrappedTextLines:this._textLines,i=n.length,o=0;o<i;o++){if(e<=n[o].length)return{lineIndex:o,charIndex:e};e-=n[o].length+this.missingNewlineOffset(o)}return{lineIndex:o-1,charIndex:n[o-1].length<e?n[o-1].length:e}},getSelectionStyles:function(e,t,n){void 0===e&&(e=this.selectionStart||0),void 0===t&&(t=this.selectionEnd||e);for(var i=[],o=e;o<t;o++)i.push(this.getStyleAtPosition(o,n));return i},getStyleAtPosition:function(e,t){var n=this.get2DCursorLocation(e);return(t?this.getCompleteStyleDeclaration(n.lineIndex,n.charIndex):this._getStyleDeclaration(n.lineIndex,n.charIndex))||{}},setSelectionStyles:function(e,t,n){void 0===t&&(t=this.selectionStart||0),void 0===n&&(n=this.selectionEnd||t);for(var i=t;i<n;i++)this._extendStyles(i,e);return this._forceClearCache=!0,this},_getStyleDeclaration:function(e,t){var n=this.styles&&this.styles[e];return n?n[t]:null},getCompleteStyleDeclaration:function(e,t){for(var n,i=this._getStyleDeclaration(e,t)||{},o={},r=0;r<this._styleProperties.length;r++)o[n=this._styleProperties[r]]=void 0===i[n]?this[n]:i[n];return o},_setStyleDeclaration:function(e,t,n){this.styles[e][t]=n},_deleteStyleDeclaration:function(e,t){delete this.styles[e][t]},_getLineStyle:function(e){return!!this.styles[e]},_setLineStyle:function(e){this.styles[e]={}},_deleteLineStyle:function(e){delete this.styles[e]}}),Q.IText=Q.util.createClass(Q.Text,Q.Observable,{type:"i-text",selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,_reSpace:/\s|\n/,_currentCursorOpacity:0,_selectionDirection:null,_abortCursorAnimation:!1,__widthOfSpace:[],inCompositionMode:!1,initialize:function(e,t){this.callSuper("initialize",e,t),this.initBehavior()},setSelectionStart:function(e){e=Math.max(e,0),this._updateAndFire("selectionStart",e)},setSelectionEnd:function(e){e=Math.min(e,this.text.length),this._updateAndFire("selectionEnd",e)},_updateAndFire:function(e,t){this[e]!==t&&(this._fireSelectionChanged(),this[e]=t),this._updateTextarea()},_fireSelectionChanged:function(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})},initDimensions:function(){this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this.callSuper("initDimensions")},render:function(e){this.clearContextTop(),this.callSuper("render",e),this.cursorOffsetCache={},this.renderCursorOrSelection()},_render:function(e){this.callSuper("_render",e)},clearContextTop:function(e){var t,n;this.isEditing&&this.canvas&&this.canvas.contextTop&&(t=this.canvas.contextTop,n=this.canvas.viewportTransform,t.save(),t.transform(n[0],n[1],n[2],n[3],n[4],n[5]),this.transform(t),this._clearTextArea(t),e||t.restore())},renderCursorOrSelection:function(){var e,t;this.isEditing&&this.canvas&&this.canvas.contextTop&&(e=this._getCursorBoundaries(),t=this.canvas.contextTop,this.clearContextTop(!0),this.selectionStart===this.selectionEnd?this.renderCursor(e,t):this.renderSelection(e,t),t.restore())},_clearTextArea:function(e){var t=this.width+4,n=this.height+4;e.clearRect(-t/2,-n/2,t,n)},_getCursorBoundaries:function(e){void 0===e&&(e=this.selectionStart);var t=this._getLeftOffset(),n=this._getTopOffset(),i=this._getCursorBoundariesOffsets(e);return{left:t,top:n,leftOffset:i.left,topOffset:i.top}},_getCursorBoundariesOffsets:function(e){if(this.cursorOffsetCache&&"top"in this.cursorOffsetCache)return this.cursorOffsetCache;for(var t,n,i=0,o=0,r=this.get2DCursorLocation(e),s=r.charIndex,a=r.lineIndex,l=0;l<a;l++)i+=this.getHeightOfLine(l);t=this._getLineLeftOffset(a);var c=this.__charBounds[a][s];return c&&(o=c.left),0!==this.charSpacing&&s===this._textLines[a].length&&(o-=this._getWidthOfCharSpacing()),n={top:i,left:t+(0<o?o:0)},this.cursorOffsetCache=n,this.cursorOffsetCache},renderCursor:function(e,t){var n=this.get2DCursorLocation(),i=n.lineIndex,o=0<n.charIndex?n.charIndex-1:0,r=this.getValueOfPropertyAt(i,o,"fontSize"),s=this.scaleX*this.canvas.getZoom(),a=this.cursorWidth/s,l=e.topOffset,c=this.getValueOfPropertyAt(i,o,"deltaY");l+=(1-this._fontSizeFraction)*this.getHeightOfLine(i)/this.lineHeight-r*(1-this._fontSizeFraction),this.inCompositionMode&&this.renderSelection(e,t),t.fillStyle=this.cursorColor||this.getValueOfPropertyAt(i,o,"fill"),t.globalAlpha=this.__isMousedown?1:this._currentCursorOpacity,t.fillRect(e.left+e.leftOffset-a/2,l+e.top+c,a,r)},renderSelection:function(e,t){for(var n=this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,i=this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd,o=-1!==this.textAlign.indexOf("justify"),r=this.get2DCursorLocation(n),s=this.get2DCursorLocation(i),a=r.lineIndex,l=s.lineIndex,c=r.charIndex<0?0:r.charIndex,u=s.charIndex<0?0:s.charIndex,h=a;h<=l;h++){var d,f,p=this._getLineLeftOffset(h)||0,g=this.getHeightOfLine(h),m=0,v=0;h===a&&(m=this.__charBounds[a][c].left),a<=h&&h<l?v=o&&!this.isEndOfWrapping(h)?this.width:this.getLineWidth(h)||5:h===l&&(v=0===u?this.__charBounds[l][u].left:(f=this._getWidthOfCharSpacing(),this.__charBounds[l][u-1].left+this.__charBounds[l][u-1].width-f)),d=g,(this.lineHeight<1||h===l&&1<this.lineHeight)&&(g/=this.lineHeight),this.inCompositionMode?(t.fillStyle=this.compositionColor||"black",t.fillRect(e.left+p+m,e.top+e.topOffset+g,v-m,1)):(t.fillStyle=this.selectionColor,t.fillRect(e.left+p+m,e.top+e.topOffset,v-m,g)),e.topOffset+=d}},getCurrentCharFontSize:function(){var e=this._getCurrentCharIndex();return this.getValueOfPropertyAt(e.l,e.c,"fontSize")},getCurrentCharColor:function(){var e=this._getCurrentCharIndex();return this.getValueOfPropertyAt(e.l,e.c,"fill")},_getCurrentCharIndex:function(){var e=this.get2DCursorLocation(this.selectionStart,!0),t=0<e.charIndex?e.charIndex-1:0;return{l:e.lineIndex,c:t}}}),Q.IText.fromObject=function(e,t){if(Ae(e),e.styles)for(var n in e.styles)for(var i in e.styles[n])Ae(e.styles[n][i]);Q.Object._fromObject("IText",e,t,"text")},H=Q.util.object.clone,Q.util.object.extend(Q.IText.prototype,{initBehavior:function(){this.initAddedHandler(),this.initRemovedHandler(),this.initCursorSelectionHandlers(),this.initDoubleClickSimulation(),this.mouseMoveHandler=this.mouseMoveHandler.bind(this)},onDeselect:function(){this.isEditing&&this.exitEditing(),this.selected=!1},initAddedHandler:function(){var t=this;this.on("added",function(){var e=t.canvas;e&&(e._hasITextHandlers||(e._hasITextHandlers=!0,t._initCanvasHandlers(e)),e._iTextInstances=e._iTextInstances||[],e._iTextInstances.push(t))})},initRemovedHandler:function(){var t=this;this.on("removed",function(){var e=t.canvas;e&&(e._iTextInstances=e._iTextInstances||[],Q.util.removeFromArray(e._iTextInstances,t),0===e._iTextInstances.length&&(e._hasITextHandlers=!1,t._removeCanvasHandlers(e)))})},_initCanvasHandlers:function(e){e._mouseUpITextHandler=function(){e._iTextInstances&&e._iTextInstances.forEach(function(e){e.__isMousedown=!1})},e.on("mouse:up",e._mouseUpITextHandler)},_removeCanvasHandlers:function(e){e.off("mouse:up",e._mouseUpITextHandler)},_tick:function(){this._currentTickState=this._animateCursor(this,1,this.cursorDuration,"_onTickComplete")},_animateCursor:function(e,t,n,i){var o={isAborted:!1,abort:function(){this.isAborted=!0}};return e.animate("_currentCursorOpacity",t,{duration:n,onComplete:function(){o.isAborted||e[i]()},onChange:function(){e.canvas&&e.selectionStart===e.selectionEnd&&e.renderCursorOrSelection()},abort:function(){return o.isAborted}}),o},_onTickComplete:function(){var e=this;this._cursorTimeout1&&clearTimeout(this._cursorTimeout1),this._cursorTimeout1=setTimeout(function(){e._currentTickCompleteState=e._animateCursor(e,0,this.cursorDuration/2,"_tick")},100)},initDelayedCursor:function(e){var t=this,n=e?0:this.cursorDelay;this.abortCursorAnimation(),this._currentCursorOpacity=1,this._cursorTimeout2=setTimeout(function(){t._tick()},n)},abortCursorAnimation:function(){var e=this._currentTickState||this._currentTickCompleteState,t=this.canvas;this._currentTickState&&this._currentTickState.abort(),this._currentTickCompleteState&&this._currentTickCompleteState.abort(),clearTimeout(this._cursorTimeout1),clearTimeout(this._cursorTimeout2),this._currentCursorOpacity=0,e&&t&&t.clearContext(t.contextTop||t.contextContainer)},selectAll:function(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this},getSelectedText:function(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")},findWordBoundaryLeft:function(e){var t=0,n=e-1;if(this._reSpace.test(this._text[n]))for(;this._reSpace.test(this._text[n]);)t++,n--;for(;/\S/.test(this._text[n])&&-1<n;)t++,n--;return e-t},findWordBoundaryRight:function(e){var t=0,n=e;if(this._reSpace.test(this._text[n]))for(;this._reSpace.test(this._text[n]);)t++,n++;for(;/\S/.test(this._text[n])&&n<this._text.length;)t++,n++;return e+t},findLineBoundaryLeft:function(e){for(var t=0,n=e-1;!/\n/.test(this._text[n])&&-1<n;)t++,n--;return e-t},findLineBoundaryRight:function(e){for(var t=0,n=e;!/\n/.test(this._text[n])&&n<this._text.length;)t++,n++;return e+t},searchWordBoundary:function(e,t){for(var n=this._text,i=this._reSpace.test(n[e])?e-1:e,o=n[i],r=Q.reNonWord;!r.test(o)&&0<i&&i<n.length;)o=n[i+=t];return r.test(o)&&(i+=1===t?0:1),i},selectWord:function(e){e=e||this.selectionStart;var t=this.searchWordBoundary(e,-1),n=this.searchWordBoundary(e,1);this.selectionStart=t,this.selectionEnd=n,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()},selectLine:function(e){e=e||this.selectionStart;var t=this.findLineBoundaryLeft(e),n=this.findLineBoundaryRight(e);return this.selectionStart=t,this.selectionEnd=n,this._fireSelectionChanged(),this._updateTextarea(),this},enterEditing:function(e){if(!this.isEditing&&this.editable)return this.canvas&&(this.canvas.calcOffset(),this.exitEditingOnOthers(this.canvas)),this.isEditing=!0,this.initHiddenTextarea(e),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick(),this.fire("editing:entered"),this._fireSelectionChanged(),this.canvas&&(this.canvas.fire("text:editing:entered",{target:this}),this.initMouseMoveHandler(),this.canvas.requestRenderAll()),this},exitEditingOnOthers:function(e){e._iTextInstances&&e._iTextInstances.forEach(function(e){e.selected=!1,e.isEditing&&e.exitEditing()})},initMouseMoveHandler:function(){this.canvas.on("mouse:move",this.mouseMoveHandler)},mouseMoveHandler:function(e){var t,n,i;this.__isMousedown&&this.isEditing&&(t=this.getSelectionStartFromPointer(e.e),n=this.selectionStart,i=this.selectionEnd,(t===this.__selectionStartOnMouseDown&&n!==i||n!==t&&i!==t)&&(t>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=t):(this.selectionStart=t,this.selectionEnd=this.__selectionStartOnMouseDown),this.selectionStart===n&&this.selectionEnd===i||(this.restartCursorIfNeeded(),this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection())))},_setEditingProps:function(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0},fromStringToGraphemeSelection:function(e,t,n){var i=n.slice(0,e),o=Q.util.string.graphemeSplit(i).length;if(e===t)return{selectionStart:o,selectionEnd:o};var r=n.slice(e,t);return{selectionStart:o,selectionEnd:o+Q.util.string.graphemeSplit(r).length}},fromGraphemeToStringSelection:function(e,t,n){var i=n.slice(0,e).join("").length;return e===t?{selectionStart:i,selectionEnd:i}:{selectionStart:i,selectionEnd:i+n.slice(e,t).join("").length}},_updateTextarea:function(){var e;this.cursorOffsetCache={},this.hiddenTextarea&&(this.inCompositionMode||(e=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text),this.hiddenTextarea.selectionStart=e.selectionStart,this.hiddenTextarea.selectionEnd=e.selectionEnd),this.updateTextareaPosition())},updateFromTextArea:function(){var e;this.hiddenTextarea&&(this.cursorOffsetCache={},this.text=this.hiddenTextarea.value,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),e=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value),this.selectionEnd=this.selectionStart=e.selectionEnd,this.inCompositionMode||(this.selectionStart=e.selectionStart),this.updateTextareaPosition())},updateTextareaPosition:function(){var e;this.selectionStart===this.selectionEnd&&(e=this._calcTextareaPosition(),this.hiddenTextarea.style.left=e.left,this.hiddenTextarea.style.top=e.top)},_calcTextareaPosition:function(){if(!this.canvas)return{x:1,y:1};var e=this.inCompositionMode?this.compositionStart:this.selectionStart,t=this._getCursorBoundaries(e),n=this.get2DCursorLocation(e),i=n.lineIndex,o=n.charIndex,r=this.getValueOfPropertyAt(i,o,"fontSize")*this.lineHeight,s=t.leftOffset,a=this.calcTransformMatrix(),l={x:t.left+s,y:t.top+t.topOffset+r},c=this.canvas.getRetinaScaling(),u=this.canvas.upperCanvasEl,h=u.width/c,d=u.height/c,f=h-r,p=d-r,g=u.clientWidth/h,m=u.clientHeight/d,l=Q.util.transformPoint(l,a);return(l=Q.util.transformPoint(l,this.canvas.viewportTransform)).x*=g,l.y*=m,l.x<0&&(l.x=0),l.x>f&&(l.x=f),l.y<0&&(l.y=0),l.y>p&&(l.y=p),l.x+=this.canvas._offset.left,l.y+=this.canvas._offset.top,{left:l.x+"px",top:l.y+"px",fontSize:r+"px",charHeight:r}},_saveEditingProps:function(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}},_restoreEditingProps:function(){this._savedProps&&(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor))},exitEditing:function(){var e=this._textBeforeEdit!==this.text,t=this.hiddenTextarea;return this.selected=!1,this.isEditing=!1,this.selectionEnd=this.selectionStart,t&&(t.blur&&t.blur(),t.parentNode&&t.parentNode.removeChild(t)),this.hiddenTextarea=null,this.abortCursorAnimation(),this._restoreEditingProps(),this._currentCursorOpacity=0,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this.fire("editing:exited"),e&&this.fire("modified"),this.canvas&&(this.canvas.off("mouse:move",this.mouseMoveHandler),this.canvas.fire("text:editing:exited",{target:this}),e&&this.canvas.fire("object:modified",{target:this})),this},_removeExtraneousStyles:function(){for(var e in this.styles)this._textLines[e]||delete this.styles[e]},removeStyleFromTo:function(e,t){var n,i=this.get2DCursorLocation(e,!0),o=this.get2DCursorLocation(t,!0),r=i.lineIndex,s=i.charIndex,a=o.lineIndex,l=o.charIndex;if(r!==a){if(this.styles[r])for(d=s;d<this._unwrappedTextLines[r].length;d++)delete this.styles[r][d];if(this.styles[a])for(d=l;d<this._unwrappedTextLines[a].length;d++)(n=this.styles[a][d])&&(this.styles[r]||(this.styles[r]={}),this.styles[r][s+d-l]=n);for(d=r+1;d<=a;d++)delete this.styles[d];this.shiftLineStyles(a,r-a)}else if(this.styles[r]){n=this.styles[r];for(var c,u,h=l-s,d=s;d<l;d++)delete n[d];for(u in this.styles[r])l<=(c=parseInt(u,10))&&(n[c-h]=n[u],delete n[u])}},shiftLineStyles:function(e,t){var n=H(this.styles);for(var i in this.styles){var o=parseInt(i,10);e<o&&(this.styles[o+t]=n[o],n[o-t]||delete this.styles[o])}},restartCursorIfNeeded:function(){this._currentTickState&&!this._currentTickState.isAborted&&this._currentTickCompleteState&&!this._currentTickCompleteState.isAborted||this.initDelayedCursor()},insertNewlineStyleObject:function(e,t,n,i){var o,r={},s=!1,a=this._unwrappedTextLines[e].length===t;for(var l in n=n||1,this.shiftLineStyles(e,n),this.styles[e]&&(o=this.styles[e][0===t?t:t-1]),this.styles[e]){var c=parseInt(l,10);t<=c&&(s=!0,r[c-t]=this.styles[e][l],a&&0===t||delete this.styles[e][l])}var u=!1;for(s&&!a&&(this.styles[e+n]=r,u=!0),u&&n--;0<n;)i&&i[n-1]?this.styles[e+n]={0:H(i[n-1])}:o?this.styles[e+n]={0:H(o)}:delete this.styles[e+n],n--;this._forceClearCache=!0},insertCharStyleObject:function(e,t,n,i){this.styles||(this.styles={});var o=this.styles[e],r=o?H(o):{};for(var s in n=n||1,r){var a=parseInt(s,10);t<=a&&(o[a+n]=r[a],r[a-n]||delete o[a])}if(this._forceClearCache=!0,i)for(;n--;)Object.keys(i[n]).length&&(this.styles[e]||(this.styles[e]={}),this.styles[e][t+n]=H(i[n]));else if(o)for(var l=o[t?t-1:1];l&&n--;)this.styles[e][t+n]=H(l)},insertNewStyleBlock:function(e,t,n){for(var i=this.get2DCursorLocation(t,!0),o=[0],r=0,s=0;s<e.length;s++)"\n"===e[s]?o[++r]=0:o[r]++;for(0<o[0]&&(this.insertCharStyleObject(i.lineIndex,i.charIndex,o[0],n),n=n&&n.slice(o[0]+1)),r&&this.insertNewlineStyleObject(i.lineIndex,i.charIndex+o[0],r),s=1;s<r;s++)0<o[s]?this.insertCharStyleObject(i.lineIndex+s,0,o[s],n):n&&(this.styles[i.lineIndex+s][0]=n[0]),n=n&&n.slice(o[s]+1);0<o[s]&&this.insertCharStyleObject(i.lineIndex+s,0,o[s],n)},setSelectionStartEndWithShift:function(e,t,n){n<=e?(t===e?this._selectionDirection="left":"right"===this._selectionDirection&&(this._selectionDirection="left",this.selectionEnd=e),this.selectionStart=n):e<n&&n<t?"right"===this._selectionDirection?this.selectionEnd=n:this.selectionStart=n:(t===e?this._selectionDirection="right":"left"===this._selectionDirection&&(this._selectionDirection="right",this.selectionStart=t),this.selectionEnd=n)},setSelectionInBoundaries:function(){var e=this.text.length;this.selectionStart>e?this.selectionStart=e:this.selectionStart<0&&(this.selectionStart=0),this.selectionEnd>e?this.selectionEnd=e:this.selectionEnd<0&&(this.selectionEnd=0)}}),Q.util.object.extend(Q.IText.prototype,{initDoubleClickSimulation:function(){this.__lastClickTime=+new Date,this.__lastLastClickTime=+new Date,this.__lastPointer={},this.on("mousedown",this.onMouseDown)},onMouseDown:function(e){var t;this.canvas&&(this.__newClickTime=+new Date,t=e.pointer,this.isTripleClick(t)&&(this.fire("tripleclick",e),this._stopEvent(e.e)),this.__lastLastClickTime=this.__lastClickTime,this.__lastClickTime=this.__newClickTime,this.__lastPointer=t,this.__lastIsEditing=this.isEditing,this.__lastSelected=this.selected)},isTripleClick:function(e){return this.__newClickTime-this.__lastClickTime<500&&this.__lastClickTime-this.__lastLastClickTime<500&&this.__lastPointer.x===e.x&&this.__lastPointer.y===e.y},_stopEvent:function(e){e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation()},initCursorSelectionHandlers:function(){this.initMousedownHandler(),this.initMouseupHandler(),this.initClicks()},doubleClickHandler:function(e){this.isEditing&&this.selectWord(this.getSelectionStartFromPointer(e.e))},tripleClickHandler:function(e){this.isEditing&&this.selectLine(this.getSelectionStartFromPointer(e.e))},initClicks:function(){this.on("mousedblclick",this.doubleClickHandler),this.on("tripleclick",this.tripleClickHandler)},_mouseDownHandler:function(e){!this.canvas||!this.editable||e.e.button&&1!==e.e.button||(this.__isMousedown=!0,this.selected&&(this.inCompositionMode=!1,this.setCursorByClick(e.e)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()))},_mouseDownHandlerBefore:function(e){!this.canvas||!this.editable||e.e.button&&1!==e.e.button||(this.selected=this===this.canvas._activeObject)},initMousedownHandler:function(){this.on("mousedown",this._mouseDownHandler),this.on("mousedown:before",this._mouseDownHandlerBefore)},initMouseupHandler:function(){this.on("mouseup",this.mouseUpHandler)},mouseUpHandler:function(e){if(this.__isMousedown=!1,!(!this.editable||this.group||e.transform&&e.transform.actionPerformed||e.e.button&&1!==e.e.button)){if(this.canvas){var t=this.canvas._activeObject;if(t&&t!==this)return}this.__lastSelected&&!this.__corner?(this.selected=!1,this.__lastSelected=!1,this.enterEditing(e.e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection()):this.selected=!0}},setCursorByClick:function(e){var t=this.getSelectionStartFromPointer(e),n=this.selectionStart,i=this.selectionEnd;e.shiftKey?this.setSelectionStartEndWithShift(n,i,t):(this.selectionStart=t,this.selectionEnd=t),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())},getSelectionStartFromPointer:function(e){for(var t=this.getLocalPointer(e),n=0,i=0,o=0,r=0,s=0,a=0,l=this._textLines.length;a<l&&o<=t.y;a++)o+=this.getHeightOfLine(a)*this.scaleY,0<(s=a)&&(r+=this._textLines[a-1].length+this.missingNewlineOffset(a-1));i=this._getLineLeftOffset(s)*this.scaleX;for(var c=0,u=this._textLines[s].length;c<u&&(n=i,(i+=this.__charBounds[s][c].kernedWidth*this.scaleX)<=t.x);c++)r++;return this._getNewSelectionStartFromOffset(t,n,i,r,u)},_getNewSelectionStartFromOffset:function(e,t,n,i,o){var r=e.x-t,s=n-e.x,a=i+(r<s||s<0?0:1);return this.flipX&&(a=o-a),a>this._text.length&&(a=this._text.length),a}}),Q.util.object.extend(Q.IText.prototype,{initHiddenTextarea:function(){this.hiddenTextarea=Q.document.createElement("textarea"),this.hiddenTextarea.setAttribute("autocapitalize","off"),this.hiddenTextarea.setAttribute("autocorrect","off"),this.hiddenTextarea.setAttribute("autocomplete","off"),this.hiddenTextarea.setAttribute("spellcheck","false"),this.hiddenTextarea.setAttribute("data-fabric-hiddentextarea",""),this.hiddenTextarea.setAttribute("wrap","off");var e=this._calcTextareaPosition();this.hiddenTextarea.style.cssText="position: absolute; top: "+e.top+"; left: "+e.left+"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; paddingï½°top: "+e.fontSize+";",Q.document.body.appendChild(this.hiddenTextarea),Q.util.addListener(this.hiddenTextarea,"keydown",this.onKeyDown.bind(this)),Q.util.addListener(this.hiddenTextarea,"keyup",this.onKeyUp.bind(this)),Q.util.addListener(this.hiddenTextarea,"input",this.onInput.bind(this)),Q.util.addListener(this.hiddenTextarea,"copy",this.copy.bind(this)),Q.util.addListener(this.hiddenTextarea,"cut",this.copy.bind(this)),Q.util.addListener(this.hiddenTextarea,"paste",this.paste.bind(this)),Q.util.addListener(this.hiddenTextarea,"compositionstart",this.onCompositionStart.bind(this)),Q.util.addListener(this.hiddenTextarea,"compositionupdate",this.onCompositionUpdate.bind(this)),Q.util.addListener(this.hiddenTextarea,"compositionend",this.onCompositionEnd.bind(this)),!this._clickHandlerInitialized&&this.canvas&&(Q.util.addListener(this.canvas.upperCanvasEl,"click",this.onClick.bind(this)),this._clickHandlerInitialized=!0)},keysMap:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorRight",36:"moveCursorLeft",37:"moveCursorLeft",38:"moveCursorUp",39:"moveCursorRight",40:"moveCursorDown"},ctrlKeysMapUp:{67:"copy",88:"cut"},ctrlKeysMapDown:{65:"selectAll"},onClick:function(){this.hiddenTextarea&&this.hiddenTextarea.focus()},onKeyDown:function(e){if(this.isEditing){if(e.keyCode in this.keysMap)this[this.keysMap[e.keyCode]](e);else{if(!(e.keyCode in this.ctrlKeysMapDown&&(e.ctrlKey||e.metaKey)))return;this[this.ctrlKeysMapDown[e.keyCode]](e)}e.stopImmediatePropagation(),e.preventDefault(),33<=e.keyCode&&e.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}},onKeyUp:function(e){!this.isEditing||this._copyDone||this.inCompositionMode?this._copyDone=!1:e.keyCode in this.ctrlKeysMapUp&&(e.ctrlKey||e.metaKey)&&(this[this.ctrlKeysMapUp[e.keyCode]](e),e.stopImmediatePropagation(),e.preventDefault(),this.canvas&&this.canvas.requestRenderAll())},onInput:function(e){var t=this.fromPaste;if(this.fromPaste=!1,e&&e.stopPropagation(),this.isEditing){var n,i,o,r,s,a=this._splitTextIntoLines(this.hiddenTextarea.value).graphemeText,l=this._text.length,c=a.length,u=c-l,h=this.selectionStart,d=this.selectionEnd,f=h!==d;if(""===this.hiddenTextarea.value)return this.styles={},this.updateFromTextArea(),this.fire("changed"),void(this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll()));var p=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value),g=h>p.selectionStart;f?(n=this._text.slice(h,d),u+=d-h):c<l&&(n=g?this._text.slice(d+u,d):this._text.slice(h,h-u)),i=a.slice(p.selectionEnd-u,p.selectionEnd),n&&n.length&&(i.length&&(o=this.getSelectionStyles(h,h+1,!1),o=i.map(function(){return o[0]})),s=f?(r=h,d):g?(r=d-n.length,d):(r=d)+n.length,this.removeStyleFromTo(r,s)),i.length&&(t&&i.join("")===Q.copiedText&&!Q.disableStyleCopyPaste&&(o=Q.copiedTextStyle),this.insertNewStyleBlock(i,h,o)),this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())}},onCompositionStart:function(){this.inCompositionMode=!0},onCompositionEnd:function(){this.inCompositionMode=!1},onCompositionUpdate:function(e){this.compositionStart=e.target.selectionStart,this.compositionEnd=e.target.selectionEnd,this.updateTextareaPosition()},copy:function(){this.selectionStart!==this.selectionEnd&&(Q.copiedText=this.getSelectedText(),Q.disableStyleCopyPaste?Q.copiedTextStyle=null:Q.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0)},paste:function(){this.fromPaste=!0},_getClipboardData:function(e){return e&&e.clipboardData||Q.window.clipboardData},_getWidthBeforeCursor:function(e,t){var n,i=this._getLineLeftOffset(e);return 0<t&&(i+=(n=this.__charBounds[e][t-1]).left+n.width),i},getDownCursorOffset:function(e,t){var n=this._getSelectionForOffset(e,t),i=this.get2DCursorLocation(n),o=i.lineIndex;if(o===this._textLines.length-1||e.metaKey||34===e.keyCode)return this._text.length-n;var r=i.charIndex,s=this._getWidthBeforeCursor(o,r),a=this._getIndexOnLine(o+1,s);return this._textLines[o].slice(r).length+a+1+this.missingNewlineOffset(o)},_getSelectionForOffset:function(e,t){return e.shiftKey&&this.selectionStart!==this.selectionEnd&&t?this.selectionEnd:this.selectionStart},getUpCursorOffset:function(e,t){var n=this._getSelectionForOffset(e,t),i=this.get2DCursorLocation(n),o=i.lineIndex;if(0===o||e.metaKey||33===e.keyCode)return-n;var r=i.charIndex,s=this._getWidthBeforeCursor(o,r),a=this._getIndexOnLine(o-1,s),l=this._textLines[o].slice(0,r),c=this.missingNewlineOffset(o-1);return-this._textLines[o-1].length+a-l.length+(1-c)},_getIndexOnLine:function(e,t){for(var n,i,o=this._textLines[e],r=this._getLineLeftOffset(e),s=0,a=0,l=o.length;a<l;a++)if(t<(r+=n=this.__charBounds[e][a].width)){i=!0;var c=r-n,u=r,h=Math.abs(c-t),s=Math.abs(u-t)<h?a:a-1;break}return i||(s=o.length-1),s},moveCursorDown:function(e){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",e)},moveCursorUp:function(e){0===this.selectionStart&&0===this.selectionEnd||this._moveCursorUpOrDown("Up",e)},_moveCursorUpOrDown:function(e,t){var n=this["get"+e+"CursorOffset"](t,"right"===this._selectionDirection);t.shiftKey?this.moveCursorWithShift(n):this.moveCursorWithoutShift(n),0!==n&&(this.setSelectionInBoundaries(),this.abortCursorAnimation(),this._currentCursorOpacity=1,this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorWithShift:function(e){var t="left"===this._selectionDirection?this.selectionStart+e:this.selectionEnd+e;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,t),0!==e},moveCursorWithoutShift:function(e){return e<0?(this.selectionStart+=e,this.selectionEnd=this.selectionStart):(this.selectionEnd+=e,this.selectionStart=this.selectionEnd),0!==e},moveCursorLeft:function(e){0===this.selectionStart&&0===this.selectionEnd||this._moveCursorLeftOrRight("Left",e)},_move:function(e,t,n){var i;if(e.altKey)i=this["findWordBoundary"+n](this[t]);else{if(!e.metaKey&&35!==e.keyCode&&36!==e.keyCode)return this[t]+="Left"===n?-1:1,!0;i=this["findLineBoundary"+n](this[t])}if(this[t]!==i)return this[t]=i,!0},_moveLeft:function(e,t){return this._move(e,t,"Left")},_moveRight:function(e,t){return this._move(e,t,"Right")},moveCursorLeftWithoutShift:function(e){var t=!0;return this._selectionDirection="left",this.selectionEnd===this.selectionStart&&0!==this.selectionStart&&(t=this._moveLeft(e,"selectionStart")),this.selectionEnd=this.selectionStart,t},moveCursorLeftWithShift:function(e){return"right"===this._selectionDirection&&this.selectionStart!==this.selectionEnd?this._moveLeft(e,"selectionEnd"):0!==this.selectionStart?(this._selectionDirection="left",this._moveLeft(e,"selectionStart")):void 0},moveCursorRight:function(e){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",e)},_moveCursorLeftOrRight:function(e,t){var n="moveCursor"+e+"With";this._currentCursorOpacity=1,t.shiftKey?n+="Shift":n+="outShift",this[n](t)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorRightWithShift:function(e){return"left"===this._selectionDirection&&this.selectionStart!==this.selectionEnd?this._moveRight(e,"selectionStart"):this.selectionEnd!==this._text.length?(this._selectionDirection="right",this._moveRight(e,"selectionEnd")):void 0},moveCursorRightWithoutShift:function(e){var t=!0;return this._selectionDirection="right",this.selectionStart===this.selectionEnd?(t=this._moveRight(e,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,t},removeChars:function(e,t){void 0===t&&(t=e+1),this.removeStyleFromTo(e,t),this._text.splice(e,t-e),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()},insertChars:function(e,t,n,i){void 0===i&&(i=n),n<i&&this.removeStyleFromTo(n,i);var o=Q.util.string.graphemeSplit(e);this.insertNewStyleBlock(o,n,t),this._text=[].concat(this._text.slice(0,n),o,this._text.slice(i)),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()}}),z=Q.util.toFixed,Y=/  +/g,Q.util.object.extend(Q.Text.prototype,{_toSVG:function(){var e=this._getSVGLeftTopOffsets(),t=this._getSVGTextAndBg(e.textTop,e.textLeft);return this._wrapSVGTextAndBg(t)},toSVG:function(e){return this._createBaseSVGMarkup(this._toSVG(),{reviver:e,noStyle:!0,withShadow:!0})},_getSVGLeftTopOffsets:function(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}},_wrapSVGTextAndBg:function(e){var t=this.getSvgTextDecoration(this);return[e.textBgRects.join(""),'\t\t<text xml:space="preserve" ',this.fontFamily?'font-family="'+this.fontFamily.replace(/"/g,"'")+'" ':"",this.fontSize?'font-size="'+this.fontSize+'" ':"",this.fontStyle?'font-style="'+this.fontStyle+'" ':"",this.fontWeight?'font-weight="'+this.fontWeight+'" ':"",t?'text-decoration="'+t+'" ':"",'style="',this.getSvgStyles(!0),'"',this.addPaintOrder()," >",e.textSpans.join(""),"</text>\n"]},_getSVGTextAndBg:function(e,t){var n,i=[],o=[],r=e;this._setSVGBg(o);for(var s=0,a=this._textLines.length;s<a;s++)n=this._getLineLeftOffset(s),(this.textBackgroundColor||this.styleHas("textBackgroundColor",s))&&this._setSVGTextLineBg(o,s,t+n,r),this._setSVGTextLineText(i,s,t+n,r),r+=this.getHeightOfLine(s);return{textSpans:i,textBgRects:o}},_createTextCharSpan:function(e,t,n,i){var o=e!==e.trim()||e.match(Y),r=this.getSvgSpanStyles(t,o),s=r?'style="'+r+'"':"",a=t.deltaY,l="",c=Q.Object.NUM_FRACTION_DIGITS;return a&&(l=' dy="'+z(a,c)+'" '),['<tspan x="',z(n,c),'" y="',z(i,c),'" ',l,s,">",Q.util.string.escapeXml(e),"</tspan>"].join("")},_setSVGTextLineText:function(e,t,n,i){var o,r,s,a,l,c=this.getHeightOfLine(t),u=-1!==this.textAlign.indexOf("justify"),h="",d=0,f=this._textLines[t];i+=c*(1-this._fontSizeFraction)/this.lineHeight;for(var p=0,g=f.length-1;p<=g;p++)l=p===g||this.charSpacing,h+=f[p],s=this.__charBounds[t][p],0===d?(n+=s.kernedWidth-s.width,d+=s.width):d+=s.kernedWidth,u&&!l&&this._reSpaceAndTab.test(f[p])&&(l=!0),l||(o=o||this.getCompleteStyleDeclaration(t,p),r=this.getCompleteStyleDeclaration(t,p+1),l=this._hasStyleChangedForSvg(o,r)),l&&(a=this._getStyleDeclaration(t,p)||{},e.push(this._createTextCharSpan(h,a,n,i)),h="",o=r,n+=d,d=0)},_pushTextBgRect:function(e,t,n,i,o,r){var s=Q.Object.NUM_FRACTION_DIGITS;e.push("\t\t<rect ",this._getFillAttributes(t),' x="',z(n,s),'" y="',z(i,s),'" width="',z(o,s),'" height="',z(r,s),'"></rect>\n')},_setSVGTextLineBg:function(e,t,n,i){for(var o,r,s=this._textLines[t],a=this.getHeightOfLine(t)/this.lineHeight,l=0,c=0,u=this.getValueOfPropertyAt(t,0,"textBackgroundColor"),h=0,d=s.length;h<d;h++)o=this.__charBounds[t][h],(r=this.getValueOfPropertyAt(t,h,"textBackgroundColor"))!==u?(u&&this._pushTextBgRect(e,u,n+c,i,l,a),c=o.left,l=o.width,u=r):l+=o.kernedWidth;r&&this._pushTextBgRect(e,r,n+c,i,l,a)},_getFillAttributes:function(e){var t=e&&"string"==typeof e?new Q.Color(e):"";return t&&t.getSource()&&1!==t.getAlpha()?'opacity="'+t.getAlpha()+'" fill="'+t.setAlpha(1).toRgb()+'"':'fill="'+e+'"'},_getSVGLineTopOffset:function(e){for(var t,n=0,i=0;i<e;i++)n+=this.getHeightOfLine(i);return t=this.getHeightOfLine(i),{lineTop:n,offset:(this._fontSizeMult-this._fontSizeFraction)*t/(this.lineHeight*this._fontSizeMult)}},getSvgStyles:function(e){return Q.Object.prototype.getSvgStyles.call(this,e)+" white-space: pre;"}}),function(){"use strict";var y=Pe.fabric||(Pe.fabric={});y.Textbox=y.util.createClass(y.IText,y.Observable,{type:"textbox",minWidth:20,dynamicMinWidth:2,__cachedLines:null,lockScalingFlip:!0,noScaleCache:!1,_dimensionAffectingProps:y.Text.prototype._dimensionAffectingProps.concat("width"),_wordJoiners:/[ \t\r]/,splitByGrapheme:!1,initDimensions:function(){this.__skipDimension||(this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),-1!==this.textAlign.indexOf("justify")&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))},_generateStyleMap:function(e){for(var t=0,n=0,i=0,o={},r=0;r<e.graphemeLines.length;r++)"\n"===e.graphemeText[i]&&0<r?(n=0,i++,t++):!this.splitByGrapheme&&this._reSpaceAndTab.test(e.graphemeText[i])&&0<r&&(n++,i++),o[r]={line:t,offset:n},i+=e.graphemeLines[r].length,n+=e.graphemeLines[r].length;return o},styleHas:function(e,t){var n;return!this._styleMap||this.isWrapping||(n=this._styleMap[t])&&(t=n.line),y.Text.prototype.styleHas.call(this,e,t)},isEmptyStyles:function(e){if(!this.styles)return!0;var t,n,i=0,o=!1,r=this._styleMap[e],s=this._styleMap[e+1];for(var a in r&&(e=r.line,i=r.offset),s&&(o=s.line===e,t=s.offset),n=void 0===e?this.styles:{line:this.styles[e]})for(var l in n[a])if(i<=l&&(!o||l<t))for(var c in n[a][l])return!1;return!0},_getStyleDeclaration:function(e,t){if(this._styleMap&&!this.isWrapping){var n=this._styleMap[e];if(!n)return null;e=n.line,t=n.offset+t}return this.callSuper("_getStyleDeclaration",e,t)},_setStyleDeclaration:function(e,t,n){var i=this._styleMap[e];e=i.line,t=i.offset+t,this.styles[e][t]=n},_deleteStyleDeclaration:function(e,t){var n=this._styleMap[e];e=n.line,t=n.offset+t,delete this.styles[e][t]},_getLineStyle:function(e){var t=this._styleMap[e];return!!this.styles[t.line]},_setLineStyle:function(e){var t=this._styleMap[e];this.styles[t.line]={}},_wrapText:function(e,t){var n,i=[];for(this.isWrapping=!0,n=0;n<e.length;n++)i=i.concat(this._wrapLine(e[n],n,t));return this.isWrapping=!1,i},_measureWord:function(e,t,n){var i,o=0;n=n||0;for(var r=0,s=e.length;r<s;r++)o+=this._getGraphemeBox(e[r],t,r+n,i,!0).kernedWidth,i=e[r];return o},_wrapLine:function(e,t,n,i){var o,r,s=0,a=this.splitByGrapheme,l=[],c=[],u=a?y.util.string.graphemeSplit(e):e.split(this._wordJoiners),h=0,d=a?"":" ",f=0,p=0,g=!0,m=this._getWidthOfCharSpacing(),i=i||0;0===u.length&&u.push([]),n-=i;for(var v=0;v<u.length;v++)o=a?u[v]:y.util.string.graphemeSplit(u[v]),r=this._measureWord(o,t,h),h+=o.length,n<=(s+=f+r-m)&&!g?(l.push(c),c=[],s=r,g=!0):s+=m,g||a||c.push(d),c=c.concat(o),f=a?0:this._measureWord([d],t,h),h++,g=!1,p<r&&(p=r);return v&&l.push(c),p+i>this.dynamicMinWidth&&(this.dynamicMinWidth=p-m+i),l},isEndOfWrapping:function(e){return!this._styleMap[e+1]||this._styleMap[e+1].line!==this._styleMap[e].line},missingNewlineOffset:function(e){return!this.splitByGrapheme||this.isEndOfWrapping(e)?1:0},_splitTextIntoLines:function(e){for(var t=y.Text.prototype._splitTextIntoLines.call(this,e),n=this._wrapText(t.lines,this.width),i=new Array(n.length),o=0;o<n.length;o++)i[o]=n[o].join("");return t.lines=i,t.graphemeLines=n,t},getMinWidth:function(){return Math.max(this.minWidth,this.dynamicMinWidth)},_removeExtraneousStyles:function(){var e={};for(var t in this._styleMap)this._textLines[t]&&(e[this._styleMap[t].line]=1);for(var t in this.styles)e[t]||delete this.styles[t]},toObject:function(e){return this.callSuper("toObject",["minWidth","splitByGrapheme"].concat(e))}}),y.Textbox.fromObject=function(e,t){return y.Object._fromObject("Textbox",e,t,"text")}}(),X=(W=Q.controlsUtils).scaleSkewCursorStyleHandler,V=W.scaleCursorStyleHandler,q=W.scalingEqually,K=W.scalingYOrSkewingX,J=W.scalingXOrSkewingY,$=W.scaleOrSkewActionName,(Z=Q.Object.prototype.controls).ml=new Q.Control({x:-.5,y:0,cursorStyleHandler:X,actionHandler:J,getActionName:$}),Z.mr=new Q.Control({x:.5,y:0,cursorStyleHandler:X,actionHandler:J,getActionName:$}),Z.mb=new Q.Control({x:0,y:.5,cursorStyleHandler:X,actionHandler:K,getActionName:$}),Z.mt=new Q.Control({x:0,y:-.5,cursorStyleHandler:X,actionHandler:K,getActionName:$}),Z.tl=new Q.Control({x:-.5,y:-.5,cursorStyleHandler:V,actionHandler:q}),Z.tr=new Q.Control({x:.5,y:-.5,cursorStyleHandler:V,actionHandler:q}),Z.bl=new Q.Control({x:-.5,y:.5,cursorStyleHandler:V,actionHandler:q}),Z.br=new Q.Control({x:.5,y:.5,cursorStyleHandler:V,actionHandler:q}),Z.mtr=new Q.Control({x:0,y:-.5,actionHandler:W.rotationWithSnapping,cursorStyleHandler:W.rotationStyleHandler,offsetY:-40,withConnection:!0,actionName:"rotate"}),Q.Textbox&&((U=Q.Textbox.prototype.controls={}).mtr=Z.mtr,U.tr=Z.tr,U.br=Z.br,U.tl=Z.tl,U.bl=Z.bl,U.mt=Z.mt,U.mb=Z.mb,U.mr=new Q.Control({x:.5,y:0,actionHandler:W.changeWidth,cursorStyleHandler:X,actionName:"resizing"}),U.ml=new Q.Control({x:-.5,y:0,actionHandler:W.changeWidth,cursorStyleHandler:X,actionName:"resizing"}))}).call(this,Ne(1).Buffer)},function(e,N,F){"use strict";(function(e){var s=F(3),r=F(4),a=F(5);function n(){return h.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function l(e,t){if(n()<t)throw new RangeError("Invalid typed array length");return h.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=h.prototype:(null===e&&(e=new h(t)),e.length=t),e}function h(e,t,n){if(!(h.TYPED_ARRAY_SUPPORT||this instanceof h))return new h(e,t,n);if("number"!=typeof e)return i(this,e,t,n);if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return o(this,e)}function i(e,t,n,i){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,n,i){if(t.byteLength,n<0||t.byteLength<n)throw new RangeError("'offset' is out of bounds");if(t.byteLength<n+(i||0))throw new RangeError("'length' is out of bounds");return t=void 0===n&&void 0===i?new Uint8Array(t):void 0===i?new Uint8Array(t,n):new Uint8Array(t,n,i),h.TYPED_ARRAY_SUPPORT?(e=t).__proto__=h.prototype:e=u(e,t),e}(e,t,n,i):"string"==typeof t?function(e,t,n){if("string"==typeof n&&""!==n||(n="utf8"),!h.isEncoding(n))throw new TypeError('"encoding" must be a valid string encoding');var i=0|f(t,n),o=(e=l(e,i)).write(t,n);return o!==i&&(e=e.slice(0,o)),e}(e,t,n):function(e,t){if(h.isBuffer(t)){var n=0|d(t.length);return 0===(e=l(e,n)).length||t.copy(e,0,0,n),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(i=t.length)!=i?l(e,0):u(e,t);if("Buffer"===t.type&&a(t.data))return u(e,t.data)}var i;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function c(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function o(e,t){if(c(t),e=l(e,t<0?0:0|d(t)),!h.TYPED_ARRAY_SUPPORT)for(var n=0;n<t;++n)e[n]=0;return e}function u(e,t){var n=t.length<0?0:0|d(t.length);e=l(e,n);for(var i=0;i<n;i+=1)e[i]=255&t[i];return e}function d(e){if(e>=n())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+n().toString(16)+" bytes");return 0|e}function f(e,t){if(h.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var n=e.length;if(0===n)return 0;for(var i=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":case void 0:return O(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return A(e).length;default:if(i)return O(e).length;t=(""+t).toLowerCase(),i=!0}}function t(e,o,r){var t,n,i=!1;if((void 0===o||o<0)&&(o=0),o>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(o>>>=0))return"";for(e=e||"utf8";;)switch(e){case"hex":return function(e,t,n){var i=e.length;(!t||t<0)&&(t=0),(!n||n<0||i<n)&&(n=i);for(var o,r="",s=t;s<n;++s)r+=(o=e[s])<16?"0"+o.toString(16):o.toString(16);return r}(this,o,r);case"utf8":case"utf-8":return y(this,o,r);case"ascii":return function(e,t,n){var i="";n=Math.min(e.length,n);for(var o=t;o<n;++o)i+=String.fromCharCode(127&e[o]);return i}(this,o,r);case"latin1":case"binary":return function(e,t,n){var i="";n=Math.min(e.length,n);for(var o=t;o<n;++o)i+=String.fromCharCode(e[o]);return i}(this,o,r);case"base64":return n=r,0===(t=o)&&n===this.length?s.fromByteArray(this):s.fromByteArray(this.slice(t,n));case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return function(e){for(var t=e.slice(o,r),n="",i=0;i<t.length;i+=2)n+=String.fromCharCode(t[i]+256*t[i+1]);return n}(this);default:if(i)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),i=!0}}function p(e,t,n){var i=e[t];e[t]=e[n],e[n]=i}function g(e,t,n,i,o){if(0===e.length)return-1;if("string"==typeof n?(i=n,n=0):2147483647<n?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,isNaN(n)&&(n=o?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(o)return-1;n=e.length-1}else if(n<0){if(!o)return-1;n=0}if("string"==typeof t&&(t=h.from(t,i)),h.isBuffer(t))return 0===t.length?-1:m(e,t,n,i,o);if("number"==typeof t)return t&=255,h.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?o?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):m(e,[t],n,i,o);throw new TypeError("val must be string, number or Buffer")}function m(e,t,n,i,o){var r=1,s=e.length,a=t.length;if(void 0!==i&&("ucs2"===(i=String(i).toLowerCase())||"ucs-2"===i||"utf16le"===i||"utf-16le"===i)){if(e.length<2||t.length<2)return-1;s/=r=2,a/=2,n/=2}function l(e,t){return 1===r?e[t]:e.readUInt16BE(t*r)}if(o)for(var c=-1,u=n;u<s;u++)if(l(e,u)===l(t,-1===c?0:u-c)){if(-1===c&&(c=u),u-c+1===a)return c*r}else-1!==c&&(u-=u-c),c=-1;else for(s<n+a&&(n=s-a),u=n;0<=u;u--){for(var h=!0,d=0;d<a;d++)if(l(e,u+d)!==l(t,d)){h=!1;break}if(h)return u}return-1}function v(e,t,n,i){return P(function(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,i)}function y(e,t,n){n=Math.min(e.length,n);for(var i=[],o=t;o<n;){var r,s,a,l,c=e[o],u=null,h=239<c?4:223<c?3:191<c?2:1;if(o+h<=n)switch(h){case 1:c<128&&(u=c);break;case 2:128==(192&(r=e[o+1]))&&127<(l=(31&c)<<6|63&r)&&(u=l);break;case 3:r=e[o+1],s=e[o+2],128==(192&r)&&128==(192&s)&&2047<(l=(15&c)<<12|(63&r)<<6|63&s)&&(l<55296||57343<l)&&(u=l);break;case 4:r=e[o+1],s=e[o+2],a=e[o+3],128==(192&r)&&128==(192&s)&&128==(192&a)&&65535<(l=(15&c)<<18|(63&r)<<12|(63&s)<<6|63&a)&&l<1114112&&(u=l)}null===u?(u=65533,h=1):65535<u&&(u-=65536,i.push(u>>>10&1023|55296),u=56320|1023&u),i.push(u),o+=h}return function(e){var t=e.length;if(t<=b)return String.fromCharCode.apply(String,e);for(var n="",i=0;i<t;)n+=String.fromCharCode.apply(String,e.slice(i,i+=b));return n}(i)}N.Buffer=h,N.SlowBuffer=function(e){return+e!=e&&(e=0),h.alloc(+e)},N.INSPECT_MAX_BYTES=50,h.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),N.kMaxLength=n(),h.poolSize=8192,h._augment=function(e){return e.__proto__=h.prototype,e},h.from=function(e,t,n){return i(null,e,t,n)},h.TYPED_ARRAY_SUPPORT&&(h.prototype.__proto__=Uint8Array.prototype,h.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&h[Symbol.species]===h&&Object.defineProperty(h,Symbol.species,{value:null,configurable:!0})),h.alloc=function(e,t,n){return i=null,r=t,s=n,c(o=e),o<=0||void 0===r?l(i,o):"string"==typeof s?l(i,o).fill(r,s):l(i,o).fill(r);var i,o,r,s},h.allocUnsafe=function(e){return o(null,e)},h.allocUnsafeSlow=function(e){return o(null,e)},h.isBuffer=function(e){return!(null==e||!e._isBuffer)},h.compare=function(e,t){if(!h.isBuffer(e)||!h.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var n=e.length,i=t.length,o=0,r=Math.min(n,i);o<r;++o)if(e[o]!==t[o]){n=e[o],i=t[o];break}return n<i?-1:i<n?1:0},h.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},h.concat=function(e,t){if(!a(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return h.alloc(0);if(void 0===t)for(o=t=0;o<e.length;++o)t+=e[o].length;for(var n=h.allocUnsafe(t),i=0,o=0;o<e.length;++o){var r=e[o];if(!h.isBuffer(r))throw new TypeError('"list" argument must be an Array of Buffers');r.copy(n,i),i+=r.length}return n},h.byteLength=f,h.prototype._isBuffer=!0,h.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)p(this,t,t+1);return this},h.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)p(this,t,t+3),p(this,t+1,t+2);return this},h.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)p(this,t,t+7),p(this,t+1,t+6),p(this,t+2,t+5),p(this,t+3,t+4);return this},h.prototype.toString=function(){var e=0|this.length;return 0==e?"":0===arguments.length?y(this,0,e):t.apply(this,arguments)},h.prototype.equals=function(e){if(!h.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===h.compare(this,e)},h.prototype.inspect=function(){var e="",t=N.INSPECT_MAX_BYTES;return 0<this.length&&(e=this.toString("hex",0,t).match(/.{2}/g).join(" "),this.length>t&&(e+=" ... ")),"<Buffer "+e+">"},h.prototype.compare=function(e,t,n,i,o){if(!h.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===i&&(i=0),void 0===o&&(o=this.length),t<0||n>e.length||i<0||o>this.length)throw new RangeError("out of range index");if(o<=i&&n<=t)return 0;if(o<=i)return-1;if(n<=t)return 1;if(this===e)return 0;for(var r=(o>>>=0)-(i>>>=0),s=(n>>>=0)-(t>>>=0),a=Math.min(r,s),l=this.slice(i,o),c=e.slice(t,n),u=0;u<a;++u)if(l[u]!==c[u]){r=l[u],s=c[u];break}return r<s?-1:s<r?1:0},h.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},h.prototype.indexOf=function(e,t,n){return g(this,e,t,n,!0)},h.prototype.lastIndexOf=function(e,t,n){return g(this,e,t,n,!1)},h.prototype.write=function(e,t,n,i){if(void 0===t)i="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)i=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(n)?(n|=0,void 0===i&&(i="utf8")):(i=n,n=void 0)}var o=this.length-t;if((void 0===n||o<n)&&(n=o),0<e.length&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");i=i||"utf8";for(var r,s,a,l,c,u,h,d=!1;;)switch(i){case"hex":return function(e,t,n,i){n=Number(n)||0;var o=e.length-n;(!i||o<(i=Number(i)))&&(i=o);var r=t.length;if(r%2!=0)throw new TypeError("Invalid hex string");r/2<i&&(i=r/2);for(var s=0;s<i;++s){var a=parseInt(t.substr(2*s,2),16);if(isNaN(a))return s;e[n+s]=a}return s}(this,e,t,n);case"utf8":case"utf-8":return a=t,l=n,P(O(e,this.length-a),this,a,l);case"ascii":return v(this,e,t,n);case"latin1":case"binary":return v(this,e,t,n);case"base64":return r=t,s=n,P(A(e),this,r,s);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return u=t,h=n,P(function(e,t){for(var n,i,o,r=[],s=0;s<e.length&&!((t-=2)<0);++s)i=(n=e.charCodeAt(s))>>8,o=n%256,r.push(o),r.push(i);return r}(e,(c=this).length-u),c,u,h);default:if(d)throw new TypeError("Unknown encoding: "+i);i=(""+i).toLowerCase(),d=!0}},h.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var b=4096;function C(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(n<e+t)throw new RangeError("Trying to access beyond buffer length")}function x(e,t,n,i,o,r){if(!h.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(o<t||t<r)throw new RangeError('"value" argument is out of bounds');if(n+i>e.length)throw new RangeError("Index out of range")}function w(e,t,n,i){t<0&&(t=65535+t+1);for(var o=0,r=Math.min(e.length-n,2);o<r;++o)e[n+o]=(t&255<<8*(i?o:1-o))>>>8*(i?o:1-o)}function S(e,t,n,i){t<0&&(t=4294967295+t+1);for(var o=0,r=Math.min(e.length-n,4);o<r;++o)e[n+o]=t>>>8*(i?o:3-o)&255}function _(e,t,n,i){if(n+i>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function E(e,t,n,i,o){return o||_(e,0,n,4),r.write(e,t,n,i,23,4),n+4}function T(e,t,n,i,o){return o||_(e,0,n,8),r.write(e,t,n,i,52,8),n+8}h.prototype.slice=function(e,t){var n=this.length;if((e=~~e)<0?(e+=n)<0&&(e=0):n<e&&(e=n),(t=void 0===t?n:~~t)<0?(t+=n)<0&&(t=0):n<t&&(t=n),t<e&&(t=e),h.TYPED_ARRAY_SUPPORT)(o=this.subarray(e,t)).__proto__=h.prototype;else for(var i=t-e,o=new h(i,void 0),r=0;r<i;++r)o[r]=this[r+e];return o},h.prototype.readUIntLE=function(e,t,n){e|=0,t|=0,n||C(e,t,this.length);for(var i=this[e],o=1,r=0;++r<t&&(o*=256);)i+=this[e+r]*o;return i},h.prototype.readUIntBE=function(e,t,n){e|=0,t|=0,n||C(e,t,this.length);for(var i=this[e+--t],o=1;0<t&&(o*=256);)i+=this[e+--t]*o;return i},h.prototype.readUInt8=function(e,t){return t||C(e,1,this.length),this[e]},h.prototype.readUInt16LE=function(e,t){return t||C(e,2,this.length),this[e]|this[e+1]<<8},h.prototype.readUInt16BE=function(e,t){return t||C(e,2,this.length),this[e]<<8|this[e+1]},h.prototype.readUInt32LE=function(e,t){return t||C(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},h.prototype.readUInt32BE=function(e,t){return t||C(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},h.prototype.readIntLE=function(e,t,n){e|=0,t|=0,n||C(e,t,this.length);for(var i=this[e],o=1,r=0;++r<t&&(o*=256);)i+=this[e+r]*o;return(o*=128)<=i&&(i-=Math.pow(2,8*t)),i},h.prototype.readIntBE=function(e,t,n){e|=0,t|=0,n||C(e,t,this.length);for(var i=t,o=1,r=this[e+--i];0<i&&(o*=256);)r+=this[e+--i]*o;return(o*=128)<=r&&(r-=Math.pow(2,8*t)),r},h.prototype.readInt8=function(e,t){return t||C(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},h.prototype.readInt16LE=function(e,t){t||C(e,2,this.length);var n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},h.prototype.readInt16BE=function(e,t){t||C(e,2,this.length);var n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},h.prototype.readInt32LE=function(e,t){return t||C(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},h.prototype.readInt32BE=function(e,t){return t||C(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},h.prototype.readFloatLE=function(e,t){return t||C(e,4,this.length),r.read(this,e,!0,23,4)},h.prototype.readFloatBE=function(e,t){return t||C(e,4,this.length),r.read(this,e,!1,23,4)},h.prototype.readDoubleLE=function(e,t){return t||C(e,8,this.length),r.read(this,e,!0,52,8)},h.prototype.readDoubleBE=function(e,t){return t||C(e,8,this.length),r.read(this,e,!1,52,8)},h.prototype.writeUIntLE=function(e,t,n,i){e=+e,t|=0,n|=0,i||x(this,e,t,n,Math.pow(2,8*n)-1,0);var o=1,r=0;for(this[t]=255&e;++r<n&&(o*=256);)this[t+r]=e/o&255;return t+n},h.prototype.writeUIntBE=function(e,t,n,i){e=+e,t|=0,n|=0,i||x(this,e,t,n,Math.pow(2,8*n)-1,0);var o=n-1,r=1;for(this[t+o]=255&e;0<=--o&&(r*=256);)this[t+o]=e/r&255;return t+n},h.prototype.writeUInt8=function(e,t,n){return e=+e,t|=0,n||x(this,e,t,1,255,0),h.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},h.prototype.writeUInt16LE=function(e,t,n){return e=+e,t|=0,n||x(this,e,t,2,65535,0),h.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):w(this,e,t,!0),t+2},h.prototype.writeUInt16BE=function(e,t,n){return e=+e,t|=0,n||x(this,e,t,2,65535,0),h.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):w(this,e,t,!1),t+2},h.prototype.writeUInt32LE=function(e,t,n){return e=+e,t|=0,n||x(this,e,t,4,4294967295,0),h.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):S(this,e,t,!0),t+4},h.prototype.writeUInt32BE=function(e,t,n){return e=+e,t|=0,n||x(this,e,t,4,4294967295,0),h.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):S(this,e,t,!1),t+4},h.prototype.writeIntLE=function(e,t,n,i){var o;e=+e,t|=0,i||x(this,e,t,n,(o=Math.pow(2,8*n-1))-1,-o);var r=0,s=1,a=0;for(this[t]=255&e;++r<n&&(s*=256);)e<0&&0===a&&0!==this[t+r-1]&&(a=1),this[t+r]=(e/s>>0)-a&255;return t+n},h.prototype.writeIntBE=function(e,t,n,i){var o;e=+e,t|=0,i||x(this,e,t,n,(o=Math.pow(2,8*n-1))-1,-o);var r=n-1,s=1,a=0;for(this[t+r]=255&e;0<=--r&&(s*=256);)e<0&&0===a&&0!==this[t+r+1]&&(a=1),this[t+r]=(e/s>>0)-a&255;return t+n},h.prototype.writeInt8=function(e,t,n){return e=+e,t|=0,n||x(this,e,t,1,127,-128),h.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},h.prototype.writeInt16LE=function(e,t,n){return e=+e,t|=0,n||x(this,e,t,2,32767,-32768),h.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):w(this,e,t,!0),t+2},h.prototype.writeInt16BE=function(e,t,n){return e=+e,t|=0,n||x(this,e,t,2,32767,-32768),h.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):w(this,e,t,!1),t+2},h.prototype.writeInt32LE=function(e,t,n){return e=+e,t|=0,n||x(this,e,t,4,2147483647,-2147483648),h.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):S(this,e,t,!0),t+4},h.prototype.writeInt32BE=function(e,t,n){return e=+e,t|=0,n||x(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),h.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):S(this,e,t,!1),t+4},h.prototype.writeFloatLE=function(e,t,n){return E(this,e,t,!0,n)},h.prototype.writeFloatBE=function(e,t,n){return E(this,e,t,!1,n)},h.prototype.writeDoubleLE=function(e,t,n){return T(this,e,t,!0,n)},h.prototype.writeDoubleBE=function(e,t,n){return T(this,e,t,!1,n)},h.prototype.copy=function(e,t,n,i){if(n=n||0,i||0===i||(i=this.length),t>=e.length&&(t=e.length),t=t||0,0<i&&i<n&&(i=n),i===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("sourceStart out of bounds");if(i<0)throw new RangeError("sourceEnd out of bounds");i>this.length&&(i=this.length),e.length-t<i-n&&(i=e.length-t+n);var o,r=i-n;if(this===e&&n<t&&t<i)for(o=r-1;0<=o;--o)e[o+t]=this[o+n];else if(r<1e3||!h.TYPED_ARRAY_SUPPORT)for(o=0;o<r;++o)e[o+t]=this[o+n];else Uint8Array.prototype.set.call(e,this.subarray(n,n+r),t);return r},h.prototype.fill=function(e,t,n,i){if("string"==typeof e){var o;if("string"==typeof t?(i=t,t=0,n=this.length):"string"==typeof n&&(i=n,n=this.length),1!==e.length||(o=e.charCodeAt(0))<256&&(e=o),void 0!==i&&"string"!=typeof i)throw new TypeError("encoding must be a string");if("string"==typeof i&&!h.isEncoding(i))throw new TypeError("Unknown encoding: "+i)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;if(t>>>=0,n=void 0===n?this.length:n>>>0,"number"==typeof(e=e||0))for(a=t;a<n;++a)this[a]=e;else for(var r=h.isBuffer(e)?e:O(new h(e,i).toString()),s=r.length,a=0;a<n-t;++a)this[a+t]=r[a%s];return this};var k=/[^+\/0-9A-Za-z-_]/g;function O(e,t){var n;t=t||1/0;for(var i=e.length,o=null,r=[],s=0;s<i;++s){if(55295<(n=e.charCodeAt(s))&&n<57344){if(!o){if(56319<n){-1<(t-=3)&&r.push(239,191,189);continue}if(s+1===i){-1<(t-=3)&&r.push(239,191,189);continue}o=n;continue}if(n<56320){-1<(t-=3)&&r.push(239,191,189),o=n;continue}n=65536+(o-55296<<10|n-56320)}else o&&-1<(t-=3)&&r.push(239,191,189);if(o=null,n<128){if(--t<0)break;r.push(n)}else if(n<2048){if((t-=2)<0)break;r.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;r.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;r.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return r}function A(e){return s.toByteArray(function(e){var t;if((e=((t=e).trim?t.trim():t.replace(/^\s+|\s+$/g,"")).replace(k,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function P(e,t,n,i){for(var o=0;o<i&&!(o+n>=t.length||o>=e.length);++o)t[o+n]=e[o];return o}}).call(this,F(2))},function(e,t){var n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";t.byteLength=function(e){var t=h(e),n=t[0],i=t[1];return 3*(n+i)/4-i},t.toByteArray=function(e){for(var t,n=h(e),i=n[0],o=n[1],r=new u(3*(i+o)/4-o),s=0,a=0<o?i-4:i,l=0;l<a;l+=4)t=c[e.charCodeAt(l)]<<18|c[e.charCodeAt(l+1)]<<12|c[e.charCodeAt(l+2)]<<6|c[e.charCodeAt(l+3)],r[s++]=t>>16&255,r[s++]=t>>8&255,r[s++]=255&t;return 2===o&&(t=c[e.charCodeAt(l)]<<2|c[e.charCodeAt(l+1)]>>4,r[s++]=255&t),1===o&&(t=c[e.charCodeAt(l)]<<10|c[e.charCodeAt(l+1)]<<4|c[e.charCodeAt(l+2)]>>2,r[s++]=t>>8&255,r[s++]=255&t),r},t.fromByteArray=function(e){for(var t,n=e.length,i=n%3,o=[],r=0,s=n-i;r<s;r+=16383)o.push(function(e,t){for(var n,i=[],o=r;o<t;o+=3)n=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]),i.push(a[n>>18&63]+a[n>>12&63]+a[n>>6&63]+a[63&n]);return i.join("")}(e,s<r+16383?s:r+16383));return 1==i?(t=e[n-1],o.push(a[t>>2]+a[t<<4&63]+"==")):2==i&&(t=(e[n-2]<<8)+e[n-1],o.push(a[t>>10]+a[t>>4&63]+a[t<<2&63]+"=")),o.join("")};for(var a=[],c=[],u="undefined"!=typeof Uint8Array?Uint8Array:Array,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=0,r=i.length;o<r;++o)a[o]=i[o],c[i.charCodeAt(o)]=o;function h(e){var t=e.length;if(0<t%4)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}c["-".charCodeAt(0)]=62,c["_".charCodeAt(0)]=63},function(e,t){t.read=function(e,t,n,i,o){var r,s,a=8*o-i-1,l=(1<<a)-1,c=l>>1,u=-7,h=n?o-1:0,d=n?-1:1,f=e[t+h];for(h+=d,r=f&(1<<-u)-1,f>>=-u,u+=a;0<u;r=256*r+e[t+h],h+=d,u-=8);for(s=r&(1<<-u)-1,r>>=-u,u+=i;0<u;s=256*s+e[t+h],h+=d,u-=8);if(0===r)r=1-c;else{if(r===l)return s?NaN:1/0*(f?-1:1);s+=Math.pow(2,i),r-=c}return(f?-1:1)*s*Math.pow(2,r-i)},t.write=function(e,t,n,i,o,r){var s,a,l,c=8*r-o-1,u=(1<<c)-1,h=u>>1,d=23===o?Math.pow(2,-24)-Math.pow(2,-77):0,f=i?0:r-1,p=i?1:-1,g=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=u):(s=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-s))<1&&(s--,l*=2),2<=(t+=1<=s+h?d/l:d*Math.pow(2,1-h))*l&&(s++,l/=2),u<=s+h?(a=0,s=u):1<=s+h?(a=(t*l-1)*Math.pow(2,o),s+=h):(a=t*Math.pow(2,h-1)*Math.pow(2,o),s=0));8<=o;e[n+f]=255&a,f+=p,a/=256,o-=8);for(s=s<<o|a,c+=o;0<c;e[n+f]=255&s,f+=p,s/=256,c-=8);e[n+f-p]|=128*g}},function(e,t){var n={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==n.call(e)}},function(e,t){},function(e,t){},function(e,t){},function(e,t,n){"use strict";function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}n.r(t),n.d(t,"default",function(){return Se});var o=(i(r.prototype,[{key:"Show",value:function(){null==this.loadingPanel&&this.InitLoadingPanel(),this.loadingPanel.style.display="flex";var e=this;setTimeout(function(){e.loadingPanelTimer=setInterval(function(){var n=!1,i=void 0;e.loadingPanelDots.forEach(function(e){null==i&&(i=e);var t=!1;"rgb(255, 145, 0)"==e.style.backgroundColor&&(n=t=!0),t?e.style.backgroundColor="rgb(255, 255, 255)":n&&(n=!1,e.style.backgroundColor="rgb(255, 145, 0)")}),n&&(n=!1,i.style.backgroundColor="rgb(255, 145, 0)")},300)},100)}},{key:"Hide",value:function(){clearInterval(this.loadingPanelTimer),null!=this.loadingPanel&&(this.loadingPanel.style.display="none")}},{key:"InitLoadingPanel",value:function(){this.loadingPanelDots=new Array;var e=document.createElement("div");e.style.position="fixed",e.style.display="none",e.style.backgroundColor="rgba(43, 48, 56, 1)",e.style.top="0px",e.style.left="0px",e.style.width="100vw",e.style.height="100vh",e.style.justifyContent="center",e.style.alignItems="center",e.style.zIndex=999999999;var t=document.createElement("div");t.style.position="absolute",t.style.width="100px",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center";var n=document.createElement("div");n.style.width="10px",n.style.height="10px",n.style.backgroundColor="rgb(255, 145, 0)",t.appendChild(n),this.loadingPanelDots.push(n);var i=document.createElement("div");i.style.width="10px",i.style.height="10px",i.style.marginLeft="10px",i.style.backgroundColor="rgb(255, 255, 255)",t.appendChild(i),this.loadingPanelDots.push(i);var o=document.createElement("div");o.style.width="10px",o.style.height="10px",o.style.marginLeft="10px",o.style.backgroundColor="rgb(255, 255, 255)",t.appendChild(o),this.loadingPanelDots.push(o);var r=document.createElement("div");r.style.width="10px",r.style.height="10px",r.style.marginLeft="10px",r.style.backgroundColor="rgb(255, 255, 255)",t.appendChild(r),this.loadingPanelDots.push(r),e.appendChild(t),this.loadingPanel=e,document.body.appendChild(this.loadingPanel)}}]),r);function r(){!function(e){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this)}function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var a=(s(l.prototype,[{key:"Start",value:function(){this.shown=!0}},{key:"Close",value:function(){this.shown&&(this.shown=!1)}},{key:"CreateToolsOptionsPnl",value:function(e){var n=this,t=document.createElement("div");t.setAttribute("class","cie-pnl-tool-option"),t.setAttribute("id","cie-btn-rotate-panel"),t.appendChild(e("","fa fa-undo",function(e){var t=n.currentAngle;n.rotatingAngle-=t,n.rotatingAngle<0&&(n.rotatingAngle=360+n.rotatingAngle),360<=n.currentAngle&&(n.currentAngle=360-(n.currentAngle-360)),n.Rotate(n.rotatingAngle)})),this.currentAngle=45,this.rotatingAngle=0;var i=document.createElement("input");return i.setAttribute("type","text"),i.setAttribute("min",0),i.setAttribute("max",360),i.setAttribute("step",1),i.setAttribute("value",this.currentAngle),i.setAttribute("autocomplete",!1),i.style.margin="10px 10px 20px 0px",i.style.backgroundColor="#2b3038",i.style.color="#9298a1",i.style.padding="6px",i.style.border="1px solid #9298a1",i.style.borderRadius="4px",i.style.width="22px",i.style.textAlign="center",i.oninput=function(){n.currentAngle=parseInt(this.value),360<n.currentAngle&&(n.currentAngle=360,this.value=n.currentAngle),n.currentAngle<0&&(n.currentAngle=0,this.value=n.currentAngle),360<n.currentAngle&&(n.currentAngle=360-(n.currentAngle-360))},t.appendChild(i),t.appendChild(e("","fa fa-repeat",function(e){var t=n.currentAngle;n.rotatingAngle+=t,n.rotatingAngle<0&&(n.rotatingAngle=360+n.rotatingAngle),360<=n.rotatingAngle&&(n.rotatingAngle=360-n.rotatingAngle),n.Rotate(n.rotatingAngle)})),t}},{key:"Rotate",value:function(e){this.editor.Rotate(e)}}]),l);function l(e){!function(e){if(!(e instanceof l))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e}function c(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var u=(c(h.prototype,[{key:"Start",value:function(){this.shown=!0}},{key:"Close",value:function(){this.shown&&(this.shown=!1)}},{key:"CreateToolsOptionsPnl",value:function(e){var t=this,n=document.createElement("div");return n.setAttribute("class","cie-pnl-tool-option"),n.setAttribute("id","cie-btn-flip-panel"),n.appendChild(e("Flip X","fa fa-arrows-h",function(e){t.Flip("horizontally")})),n.appendChild(e("Flip Y","fa fa-arrows-v",function(e){t.Flip("vertically")})),n}},{key:"Flip",value:function(e){this.editor.Flip(e)}}]),h);function h(e){!function(e){if(!(e instanceof h))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e}function d(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var f=(d(p.prototype,[{key:"OpenPickColorPanel",value:function(e){this.InitPanel();var t=e.srcElement.getBoundingClientRect();this.pickColorPanel.style.left=t.left-80+"px",this.pickColorPanel.style.top=t.top-150+"px",this.pickColorPanel.focus(),this.btn=e.srcElement}},{key:"HidePickColorPanel",value:function(){this.pickColorPanel.parentNode.removeChild(this.pickColorPanel)}},{key:"InitPanel",value:function(){var n=this,t=document.createElement("div");t.style.position="fixed",t.style.zIndex="99999",t.style.border="1px solid #9298a1",t.style.borderRadius="2px",t.style.backgroundColor="#2b3038",t.style.padding="4px 4px 0px 0px",t.style.left="10px",t.style.top="10px",t.setAttribute("tabindex","0");var e=[];e.push(["#dfb9b1","#eecdcd","#f8e5d0","#fdf2d0","#dce9d5","#d3dfe2","#ccdaf5","#d2e1f1","#d8d2e7","#e6d2db"]),e.push(["#d08270","#de9c9b","#f2cca2","#fbe5a3","#bcd5ac","#a9c3c8","#a9c2f0","#a6c4e5","#b2a8d2","#cea8bc"]),e.push(["#bd4b31","#d16d6a","#ecb476","#f9d978","#9dc284","#80a4ad","#779ee5","#7ba7d7","#8b7ebe","#b87f9e"]),e.push(["#982a15","#bb261a","#da944b","#eac251","#78a55a","#53808c","#4a79d1","#4f85c1","#6351a2","#9b5378"]),e.push(["#7a2817","#8c1a11","#a96324","#b89130","#48742c","#264e5b","#2657c5","#24538f","#312071","#6b2346"]);var i=document.createElement("div");i.style.display="flex",i.style.marginTop="2px",i.style.marginBottom="6px",["#000000","#434343","#666666","#999999","#b7b7b7","#cccccc","#d9d9d9","#efefef","#f3f3f3","#ffffff"].forEach(function(e){var t=n._getDomCell_colorPicker(e);i.appendChild(t)}),t.appendChild(i),e.forEach(function(e){(i=document.createElement("div")).style.display="flex",e.forEach(function(e){var t=n._getDomCell_colorPicker(e);i.appendChild(t)}),t.appendChild(i)}),t.addEventListener("blur",function(){null!=n.preventBlurEvent&&n.preventBlurEvent?n.preventBlurEvent=!1:this.parentNode.removeChild(this)}),document.body.appendChild(t),this.pickColorPanel=t}},{key:"_getDomCell_colorPicker",value:function(e){var t=this,n=e,i=document.createElement("div");return i.style.width="13px",i.style.height="13px",i.style.backgroundColor=n,i.style.margin="0px 0px 4px 4px ",t.currentColor==n?i.style.border="2px solid #30b7e8":i.style.border="2px solid "+n,i.style.borderRadius="2px",i.addEventListener("mouseover",function(){this.style.cursor="pointer",this.style.border="2px solid #30b7e8"}),i.addEventListener("mouseout",function(){t.currentColor==n?this.style.border="2px solid #30b7e8":this.style.border="2px solid "+n}),i.addEventListener("mousedown",function(e){t.preventBlurEvent=!0}),i.addEventListener("click",function(e){t.btn.style.color=n,t.currentColor=n,null!=t.onColorSelected&&t.onColorSelected(n),t.HidePickColorPanel()}),i}}]),p);function p(e,t){!function(e){if(!(e instanceof p))throw new TypeError("Cannot call a class as a function")}(this),this.onColorSelected=t,this.currentColor=e,this.pickColorPanel=void 0}function g(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var m=(g(v.prototype,[{key:"Start",value:function(){this.shown=!0}},{key:"Close",value:function(){this.shown&&(this.shown=!1)}},{key:"Reset",value:function(e,t){this.currentBrushColor=null==e||""==e?"#ffffff":e,this.currentFrameSize=t,this.iconDot.style.color=this.currentBrushColor,this.sizeInput.value=this.currentFrameSize}},{key:"ApplyFrame",value:function(){this.editor.Frame(this.currentBrushColor,this.currentFrameSize)}},{key:"CreateToolsOptionsPnl",value:function(e,t){var n=this,i=document.createElement("div");i.setAttribute("class","cie-pnl-tool-option"),i.setAttribute("id","cie-btn-frame-panel");var o=document.createElement("div");o.style.margin="10px 10px 20px 10px";var r=document.createElement("i");function s(e){n.colorPicker.OpenPickColorPanel(e)}r.setAttribute("class","fa fa-circle"),r.style.fontSize="30px",r.style.color=this.currentBrushColor,r.style.cursor="pointer",r.removeEventListener("click",s),r.addEventListener("click",s),this.iconDot=r,o.appendChild(r),i.appendChild(o),i.appendChild(t());var a=document.createElement("div");a.innerHTML="Frame size:",a.style.color="#9298a1",a.style.margin="10px 10px 20px 0px",a.style.fontSize="14px",a.style.fontFamily="Arial",i.appendChild(a);var l=document.createElement("input");return l.setAttribute("type","text"),l.setAttribute("min",0),l.setAttribute("max",100),l.setAttribute("step",1),l.setAttribute("value",this.currentFrameSize),l.setAttribute("autocomplete",!1),l.style.margin="10px 10px 20px 0px",l.style.backgroundColor="#2b3038",l.style.color="#9298a1",l.style.padding="6px",l.style.border="1px solid #9298a1",l.style.borderRadius="4px",l.style.width="22px",l.style.textAlign="center",l.oninput=function(){n.currentFrameSize=parseInt(this.value),999<n.currentFrameSize&&(n.currentFrameSize=999,this.value=n.currentFrameSize),n.currentFrameSize<0&&(n.currentFrameSize=1,this.value=n.currentFrameSize)},this.sizeInput=l,i.appendChild(l),i.appendChild(t()),i.appendChild(e("Apply","fa fa-check",function(e){n.ApplyFrame(!1)})),i}}]),v);function v(e){var t=this;!function(e){if(!(e instanceof v))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e,this.currentBrushColor="#ffffff",this.currentFrameSize=20,this.colorPicker=new f(this.currentBrushColor,function(e){t.currentBrushColor=e})}function y(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var b=(y(C.prototype,[{key:"Start",value:function(){this.shown=!0,this.ShowCroppingRectangle()}},{key:"Close",value:function(){this.shown&&(this.shown=!1,this.HideCroppingRectangle())}},{key:"Apply",value:function(){var n=this;this.HideCroppingRectangle(),this.editor.FreezeCanvasEditing(),setTimeout(function(){var e=getComputedStyle(n.panel),t={top:parseInt(e.top.replace("px",""))-window.scrollY,left:parseInt(e.left.replace("px",""))-window.scrollX,width:parseInt(e.width.replace("px","")),height:parseInt(e.height.replace("px",""))};n.editor.Crop(t).then(function(){n.ShowCroppingRectangle(),n.editor.ResumeCanvasEditing()},function(e){console.log(e)})},10)}},{key:"CreateToolsOptionsPnl",value:function(e){var t=this,n=document.createElement("div");return n.setAttribute("class","cie-pnl-tool-option"),n.setAttribute("id","cie-btn-crop-panel"),n.appendChild(e("Apply","fa fa-check",function(e){t.Apply(e)})),n}},{key:"InitPanel",value:function(){function e(e){n.MouseDown(e,this)}function t(e){n.MouseDownForMove(e,this)}var n=this;this.panel=document.createElement("div"),this.panel.setAttribute("class","comma-img-resizable"),this.panel.removeEventListener("mousedown",t),this.panel.addEventListener("mousedown",t),this.panel.style.cursor="move";var i=document.createElement("div");i.setAttribute("class","comma-img-resizers");var o=document.createElement("div");o.setAttribute("class","comma-img-resizer cir-top-left"),o.removeEventListener("mousedown",e),o.addEventListener("mousedown",e),i.appendChild(o);var r=document.createElement("div");r.setAttribute("class","comma-img-resizer cir-top-right"),r.removeEventListener("mousedown",e),r.addEventListener("mousedown",e),i.appendChild(r);var s=document.createElement("div");s.setAttribute("class","comma-img-resizer cir-bottom-left"),s.removeEventListener("mousedown",e),s.addEventListener("mousedown",e),i.appendChild(s);var a=document.createElement("div");a.setAttribute("class","comma-img-resizer cir-bottom-right"),a.removeEventListener("mousedown",e),a.addEventListener("mousedown",e),i.appendChild(a);var l=document.createElement("div");l.setAttribute("class","cir-opaque-panel"),this.leftOpaquePnl=l,i.appendChild(l);var c=document.createElement("div");c.setAttribute("class","cir-opaque-panel"),this.topOpaquePnl=c,i.appendChild(c);var u=document.createElement("div");u.setAttribute("class","cir-opaque-panel"),this.rightOpaquePnl=u,i.appendChild(u);var h=document.createElement("div");h.setAttribute("class","cir-opaque-panel"),this.bottomOpaquePnl=h,i.appendChild(h),this.panel.appendChild(i),document.body.appendChild(this.panel)}},{key:"ShowCroppingRectangle",value:function(){null==this.panel?this.InitPanel():this.panel.style.display="none";var i=this;setTimeout(function(){i.panel.style.display="block";var e=i.editor.GetBoundingClientRect(),t=parseInt(e.width/4),n=t/2;i.panel.style.top=e.top+window.scrollY+n+"px",i.panel.style.left=e.left+window.scrollX+n+"px",i.panel.style.width=e.width-t+"px",i.panel.style.height=e.height-t+"px",i.leftOpaquePnl.style.top=e.top+"px",i.leftOpaquePnl.style.left=e.left+"px",i.leftOpaquePnl.style.width=n+"px",i.leftOpaquePnl.style.height=e.height+"px",i.topOpaquePnl.style.top=e.top+"px",i.topOpaquePnl.style.left=e.left+n+"px",i.topOpaquePnl.style.width=e.width-n+"px",i.topOpaquePnl.style.height=n+"px",i.rightOpaquePnl.style.top=e.top+n+"px",i.rightOpaquePnl.style.left=e.left+e.width-n+"px",i.rightOpaquePnl.style.width=n+"px",i.rightOpaquePnl.style.height=e.height-n+"px",i.bottomOpaquePnl.style.top=e.top+e.height-n+"px",i.bottomOpaquePnl.style.left=e.left+n+"px",i.bottomOpaquePnl.style.width=e.width-t+"px",i.bottomOpaquePnl.style.height=n+"px"},200)}},{key:"HideCroppingRectangle",value:function(){null!=this.panel&&(this.panel.style.display="none")}},{key:"MouseDownForMove",value:function(e,t){var n=this;function i(e){n.StopMoving(e)}function o(e){n.Move(e,t)}this.px=e.pageX-window.scrollX,this.py=e.pageY-window.scrollY,this.f_move=o,window.removeEventListener("mousemove",o),window.addEventListener("mousemove",o),window.removeEventListener("mouseup",i),window.addEventListener("mouseup",i),e.preventDefault(),e.stopPropagation()}},{key:"StopMoving",value:function(){window.removeEventListener("mousemove",this.f_move),event.preventDefault(),event.stopPropagation()}},{key:"Move",value:function(){var e=this.editor.GetBoundingClientRect(),t=event.pageX-window.scrollX,n=event.pageY-window.scrollY,i=t-this.px,o=n-this.py,r=e.x,s=e.x+e.width,a=e.y,l=e.y+e.height,c=getComputedStyle(this.panel),u={};u.width=parseInt(c.width.replace("px","")),u.height=parseInt(c.height.replace("px","")),u.left=parseInt(c.left.replace("px","")),u.top=parseInt(c.top.replace("px",""));var h=u.width,d=u.height,f=u.left,p=(u.left,u.top),g=(u.top,f+i),m=p+o;g-window.scrollX<=r&&(g=f),g-window.scrollX+h>=s&&(g=f),m-window.scrollY<=a&&(m=p),m-window.scrollY+d>=l&&(m=p),this.panel.style.top=m+"px",this.panel.style.left=g+"px",this.leftOpaquePnl.style.width=g-e.x-window.scrollX+"px",this.topOpaquePnl.style.height=m-e.y-window.scrollY+"px",this.topOpaquePnl.style.left=g-window.scrollX+"px",this.topOpaquePnl.style.width=e.width-(g-e.x-window.scrollX)+"px",this.rightOpaquePnl.style.top=m-window.scrollY+"px",this.rightOpaquePnl.style.left=g-window.scrollX+h+"px",this.rightOpaquePnl.style.width=e.width-(g+h-e.x)+"px",this.rightOpaquePnl.style.height=e.height-(m-e.y-window.scrollY)+"px",this.bottomOpaquePnl.style.top=m+d-window.scrollY+"px",this.bottomOpaquePnl.style.left=g-window.scrollX+"px",this.bottomOpaquePnl.style.width=h+"px",this.bottomOpaquePnl.style.height=e.height-(m+d-e.y-window.scrollY)+"px",this.px=t,this.py=n,event.preventDefault(),event.stopPropagation()}},{key:"MouseDown",value:function(e,t){var n=this;function i(e){n.StopResize(e)}function o(e){n.Resize(e,t)}this.px=e.pageX-window.scrollX,this.py=e.pageY-window.scrollY,this.f_resize=o,window.removeEventListener("mousemove",o),window.addEventListener("mousemove",o),window.removeEventListener("mouseup",i),window.addEventListener("mouseup",i),e.preventDefault(),e.stopPropagation()}},{key:"Resize",value:function(e,t){var n=this.editor.GetBoundingClientRect(),i=e.pageX-window.scrollX,o=e.pageY-window.scrollY,r=i-this.px,s=o-this.py,a=n.x,l=n.x+n.width,c=n.y,u=n.y+n.height,h=getComputedStyle(this.panel),d=parseInt(h.width.replace("px","")),f=parseInt(h.height.replace("px","")),p=parseInt(h.left.replace("px","")),g=d+parseInt(h.left.replace("px","")),m=parseInt(h.top.replace("px","")),v=f+parseInt(h.top.replace("px","")),y=d,b=f,C=m,x=p;t.classList.contains("cir-bottom-right")?(y=g<l||r<0?d+r:l-parseInt(h.left.replace("px","")),b=v<u||s<0?f+s:u-parseInt(h.top.replace("px",""))):t.classList.contains("cir-top-right")?(y=g<l||r<0?d+r:l-parseInt(h.left.replace("px","")),C=c<m||0<s?(b=f-s,m+s):c):t.classList.contains("cir-top-left")?(x=a<p||0<r?(y=d-r,p+r):a,C=c<m||0<s?(b=f-s,m+s):c):t.classList.contains("cir-bottom-left")&&(x=a<p||0<r?(y=d-r,p+r):a,b=v<u||s<0?f+s:u-parseInt(h.top.replace("px",""))),y<20&&(y=20),b<20&&(b=20),this.panel.style.width=y+"px",this.panel.style.height=b+"px",this.panel.style.top=C+"px",this.panel.style.left=x+"px",this.leftOpaquePnl.style.width=x-n.x-window.scrollX+"px",this.topOpaquePnl.style.height=C-n.y-window.scrollY+"px",this.topOpaquePnl.style.left=x-window.scrollX+"px",this.topOpaquePnl.style.width=n.width-(x-n.x-window.scrollX)+"px",this.rightOpaquePnl.style.top=C-window.scrollY+"px",this.rightOpaquePnl.style.left=x-window.scrollX+d+"px",this.rightOpaquePnl.style.width=n.width-(x+d-n.x)+"px",this.rightOpaquePnl.style.height=n.height-(C-n.y-window.scrollY)+"px",this.bottomOpaquePnl.style.top=C+f-window.scrollY+"px",this.bottomOpaquePnl.style.left=x-window.scrollX+"px",this.bottomOpaquePnl.style.width=d+"px",this.bottomOpaquePnl.style.height=n.height-(C+f-n.y-window.scrollY)+"px",this.px=i,this.py=o,e.preventDefault(),e.stopPropagation()}},{key:"StopResize",value:function(e){window.removeEventListener("mousemove",this.f_resize),e.preventDefault(),e.stopPropagation()}}]),C);function C(e){!function(e){if(!(e instanceof C))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e,this.panel=void 0}function x(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var w=(x(S.prototype,[{key:"Start",value:function(){this.shown=!0,this.editor.StartDrawing(this.brush,this.currentBrushSize,this.currentBrushColor)}},{key:"Close",value:function(){this.shown&&(this.shown=!1,this.editor.StopDrawing())}},{key:"CreateToolsOptionsPnl",value:function(e,t){var n=this,i=document.createElement("div");i.setAttribute("class","cie-pnl-tool-option"),i.setAttribute("id","cie-btn-draw-panel"),i.appendChild(e("Free","fa fa-google-wallet",function(e){n.SetDrawType("free")},"cie-free-hand-btn")),i.appendChild(e("Straight","fa fa-minus",function(e){n.SetDrawType("straight")},"cie-straight-btn")),i.appendChild(t());var o=document.createElement("div");o.style.margin="10px 10px 20px 10px";var r=document.createElement("i");function s(e){n.colorPicker.OpenPickColorPanel(e)}r.setAttribute("class","fa fa-circle"),r.style.fontSize="30px",r.style.color=this.currentBrushColor,r.style.cursor="pointer",r.removeEventListener("click",s),r.addEventListener("click",s),this.iconColor=r,o.appendChild(r),i.appendChild(o),i.appendChild(t());var a=document.createElement("div");a.innerHTML="Brush size:",a.style.color="#9298a1",a.style.margin="10px 10px 20px 0px",a.style.fontSize="14px",a.style.fontFamily="Arial",i.appendChild(a);var l=document.createElement("input");return l.setAttribute("type","text"),l.setAttribute("min",0),l.setAttribute("max",100),l.setAttribute("step",1),l.setAttribute("value",this.currentBrushSize),l.setAttribute("autocomplete",!1),l.style.margin="10px 10px 20px 0px",l.style.backgroundColor="#2b3038",l.style.color="#9298a1",l.style.padding="6px",l.style.border="1px solid #9298a1",l.style.borderRadius="4px",l.style.width="22px",l.style.textAlign="center",l.oninput=function(){n.currentBrushSize=parseInt(this.value),999<n.currentBrushSize&&(n.currentBrushSize=999,this.value=n.currentBrushSize),n.currentBrushSize<0&&(n.currentBrushSize=1,this.value=n.currentBrushSize),n.SetDrawType(n.brush,n.currentBrushSize,n.currentBrushColor)},this.sizeInput=l,i.appendChild(l),setTimeout(function(){document.getElementById("cie-free-hand-btn").style.color="#ffffff"}),i}},{key:"SetDrawType",value:function(e){"free"==e?(document.getElementById("cie-free-hand-btn").style.color="#ffffff",document.getElementById("cie-straight-btn").style.color="#9298a1",this.brush="free"):"straight"==e&&(document.getElementById("cie-free-hand-btn").style.color="#9298a1",document.getElementById("cie-straight-btn").style.color="#ffffff",this.brush="straight"),this.editor.SetDrawingParameters(this.brush,this.currentBrushSize,this.currentBrushColor)}}]),S);function S(e){var t=this;!function(e){if(!(e instanceof S))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e,this.brush="free",this.currentBrushSize=10,this.currentBrushColor="#bb261a",this.colorPicker=new f(this.currentBrushColor,function(e){t.currentBrushColor=e,t.editor.SetDrawingParameters(t.brush,t.currentBrushSize,t.currentBrushColor)})}function _(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var E=(_(T.prototype,[{key:"Start",value:function(){this.shown=!0,this.editor.StartDrawing(this.shape,this.currentBrushSize,this.currentBrushColor)}},{key:"Close",value:function(){this.shown&&(this.shown=!1,this.editor.StopDrawing())}},{key:"CreateToolsOptionsPnl",value:function(e,t){var n=this,i=document.createElement("div");i.setAttribute("class","cie-pnl-tool-option"),i.setAttribute("id","cie-btn-shapes-panel"),i.appendChild(e("Rectangle","fa fa-square-o",function(e){n.SetShape("rectangle")},"cie-rectangle-shape")),i.appendChild(e("Circle","fa fa-circle-o",function(e){n.SetShape("circle")},"cie-circle-shape")),i.appendChild(e("Arrow","fa fa-arrow-right",function(e){n.SetShape("arrow")},"cie-arrow-shape")),i.appendChild(t());var o=document.createElement("div");o.style.margin="10px 10px 20px 10px";var r=document.createElement("i");function s(e){n.colorPicker.OpenPickColorPanel(e)}r.setAttribute("class","fa fa-circle"),r.setAttribute("id","cie-chosen-color-shapes"),r.style.fontSize="30px",r.style.color=this.currentBrushColor,r.style.cursor="pointer",r.removeEventListener("click",s),r.addEventListener("click",s),this.iconColor=r,o.appendChild(r),i.appendChild(o),i.appendChild(t());var a=document.createElement("div");a.innerHTML="Shape style:",a.style.color="#9298a1",a.style.margin="10px 10px 20px 0px",a.style.fontSize="14px",a.style.fontFamily="Arial",i.appendChild(a);var l=document.createElement("input");return l.setAttribute("type","text"),l.setAttribute("min",0),l.setAttribute("max",100),l.setAttribute("step",1),l.setAttribute("value",this.currentBrushSize),l.setAttribute("autocomplete",!1),l.style.margin="10px 10px 20px 0px",l.style.backgroundColor="#2b3038",l.style.color="#9298a1",l.style.padding="6px",l.style.border="1px solid #9298a1",l.style.borderRadius="4px",l.style.width="22px",l.style.textAlign="center",l.oninput=function(){n.currentBrushSize=parseInt(this.value),999<n.currentBrushSize&&(n.currentBrushSize=999,this.value=n.currentBrushSize),n.currentBrushSize<0&&(n.currentBrushSize=1,this.value=n.currentBrushSize),n.editor.SetDrawingParameters(n.shape,n.currentBrushSize,n.currentBrushColor)},this.sizeInput=l,i.appendChild(l),setTimeout(function(){document.getElementById("cie-rectangle-shape").style.color="#ffffff"}),i}},{key:"SetShape",value:function(e){this.shape=e,"rectangle"==this.shape?(document.getElementById("cie-rectangle-shape").style.color="#ffffff",document.getElementById("cie-circle-shape").style.color="#9298a1",document.getElementById("cie-arrow-shape").style.color="#9298a1"):"circle"==this.shape?(document.getElementById("cie-rectangle-shape").style.color="#9298a1",document.getElementById("cie-circle-shape").style.color="#ffffff",document.getElementById("cie-arrow-shape").style.color="#9298a1"):"arrow"==this.shape&&(document.getElementById("cie-rectangle-shape").style.color="#9298a1",document.getElementById("cie-circle-shape").style.color="#9298a1",document.getElementById("cie-arrow-shape").style.color="#ffffff"),this.editor.SetDrawingParameters(this.shape,this.currentBrushSize,this.currentBrushColor)}}]),T);function T(e){var t=this;!function(e){if(!(e instanceof T))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e,this.currentBrushColor="#bb261a",this.currentBrushSize=10,this.fillShape=!1,this.shape="rectangle",this.colorPicker=new f(this.currentBrushColor,function(e){t.currentBrushColor=e,t.editor.SetDrawingParameters(t.shape,t.currentBrushSize,t.currentBrushColor)})}function k(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var O=(k(A.prototype,[{key:"Start",value:function(){this.shown=!0,this.editor.SetTextParameters(this.currentBrushSize,this.currentBrushColor),this.editor.StartAddText()}},{key:"Close",value:function(){this.shown&&(this.shown=!1,this.editor.StopAddText())}},{key:"CreateToolsOptionsPnl",value:function(e,t){var n=this,i=document.createElement("div");i.setAttribute("class","cie-pnl-tool-option"),i.setAttribute("id","cie-btn-text-panel");var o=document.createElement("div");o.style.margin="10px 10px 20px 10px";var r=document.createElement("i");function s(e){n.colorPicker.OpenPickColorPanel(e)}r.setAttribute("class","fa fa-circle"),r.setAttribute("id","cie-chosen-color-text"),r.style.fontSize="30px",r.style.color=this.currentBrushColor,r.style.cursor="pointer",r.removeEventListener("click",s),r.addEventListener("click",s),o.appendChild(r),i.appendChild(o),i.appendChild(t());var a=document.createElement("div");a.innerHTML="Text size:",a.style.color="#9298a1",a.style.margin="10px 10px 20px 0px",a.style.fontSize="14px",a.style.fontFamily="Arial",i.appendChild(a);var l=document.createElement("input");return l.setAttribute("type","text"),l.setAttribute("min",0),l.setAttribute("max",100),l.setAttribute("step",1),l.setAttribute("value",this.currentBrushSize),l.setAttribute("autocomplete",!1),l.style.margin="10px 10px 20px 0px",l.style.backgroundColor="#2b3038",l.style.color="#9298a1",l.style.padding="6px",l.style.border="1px solid #9298a1",l.style.borderRadius="4px",l.style.width="22px",l.style.textAlign="center",l.oninput=function(){n.currentBrushSize=parseInt(this.value),999<n.currentBrushSize&&(n.currentBrushSize=999,this.value=n.currentBrushSize),n.currentBrushSize<0&&(n.currentBrushSize=1,this.value=n.currentBrushSize),n.editor.SetTextParameters(n.currentBrushSize,n.currentBrushColor)},i.appendChild(l),i}}]),A);function A(e){var t=this;!function(e){if(!(e instanceof A))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e,this.currentBrushColor="#bb261a",this.currentBrushSize=40,this.fillShape=!1,this.shape="rectangle",this.colorPicker=new f(this.currentBrushColor,function(e){t.currentBrushColor=e,t.editor.SetTextParameters(t.currentBrushSize,t.currentBrushColor)})}function P(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var N=(P(F.prototype,[{key:"Start",value:function(){this.shown=!0}},{key:"Close",value:function(){this.shown&&(this.shown=!1)}},{key:"SetFilters",value:function(n){null!=n&&Object.keys(n).forEach(function(e){var t=n[e];document.getElementById("pid-im-"+e).value=t})}},{key:"ResetToDefaults",value:function(){this.SetFilters(this.defaultFilters)}},{key:"ResetFilter",value:function(e){var t="red"!=e&&"green"!=e&&"blue"!=e?0:1;document.getElementById("pid-im-"+e).value=t,this.AdjustFilters(e,t)}},{key:"AdjustFilters",value:function(e,t){this.editor.ApplyFilter(e,t)}},{key:"CreateToolsOptionsPnl",value:function(){var t=this,e=document.createElement("div");e.setAttribute("class","cie-pnl-tool-option"),e.setAttribute("id","cie-btn-filters-panel");var n=document.createElement("div");n.style.margin="0px 10px 20px 10px",n.appendChild(this._createInputRange("brightness","Brightness",-1,1,.003921,this.defaultFilters.brightness,function(e){t.AdjustFilters("brightness",parseFloat(this.value))},function(e){t.ResetFilter("brightness")})),n.appendChild(this._createInputRange("contrast","Contrast",-1,1,.003921,this.defaultFilters.contrast,function(e){t.AdjustFilters("contrast",parseFloat(this.value))},function(e){t.ResetFilter("contrast")})),n.appendChild(this._createInputRange("blur","Blur",0,1,.01,this.defaultFilters.blur,function(e){t.AdjustFilters("blur",parseFloat(this.value))},function(e){t.ResetFilter("blur")})),e.appendChild(n);var i=document.createElement("div");i.style.margin="0px 10px 20px 10px",i.appendChild(this._createInputRange("hue","Hue",-1,1,.002,this.defaultFilters.hue,function(e){t.AdjustFilters("hue",parseFloat(this.value))},function(e){t.ResetFilter("hue")})),i.appendChild(this._createInputRange("saturate","Saturate",-1,1,.003921,this.defaultFilters.saturate,function(e){t.AdjustFilters("saturate",parseFloat(this.value))},function(e){t.ResetFilter("saturate")})),i.appendChild(this._createInputRange("noise","Noise",0,1e3,50,this.defaultFilters.noise,function(e){t.AdjustFilters("noise",parseFloat(this.value))},function(e){t.ResetFilter("noise")})),e.appendChild(i);var o=document.createElement("div");return o.style.margin="0px 10px 20px 10px",o.appendChild(this._createInputRange("red","Red",.2,2.2,.003921,this.defaultFilters.red,function(e){t.AdjustFilters("red",parseFloat(this.value))},function(e){t.ResetFilter("red")})),o.appendChild(this._createInputRange("green","Green",.2,2.2,.003921,this.defaultFilters.green,function(e){t.AdjustFilters("green",parseFloat(this.value))},function(e){t.ResetFilter("green")})),o.appendChild(this._createInputRange("blue","Blue",.2,2.2,.003921,this.defaultFilters.blue,function(e){t.AdjustFilters("blue",parseFloat(this.value))},function(e){t.ResetFilter("blue")})),e.appendChild(o),e}},{key:"_createInputRange",value:function(e,t,n,i,o,r,s,a){var l=document.createElement("div");l.setAttribute("class","cie-pnl-filters-param-container");var c=document.createElement("span");c.setAttribute("class","cie-pnl-filters-label"),c.textContent=t,l.appendChild(c);var u=document.createElement("input");u.setAttribute("class","cie-pnl-input-range"),u.id="pid-im-"+e,u.type="range",u.max=i,u.min=n,u.step=o,u.value=r,u.oninput=s,l.appendChild(u);var h=document.createElement("i");return h.setAttribute("class","fa fa-eraser cie-pnl-filters-erase-btn"),h.addEventListener("click",a),l.appendChild(h),l}}]),F);function F(e){!function(e){if(!(e instanceof F))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e,this.defaultFilters={brightness:0,contrast:0,blur:0,noise:0,hue:0,saturate:0,red:1,green:1,blue:1}}function M(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var R=(M(D.prototype,[{key:"Destroy",value:function(){this.HideLoadingPanel(),this.OffMenuButton(),this.panelFullScreen.style.display="none",this.panelFullScreen.removeEventListener("keydown",this.keyDownEvent),null!=this.loadingPanel.parentNode&&this.loadingPanel.parentNode.removeChild(this.loadingPanel),null!=this.panelFullScreen&&null!=this.panelFullScreen.parentNode&&this.panelFullScreen.parentNode.removeChild(this.panelFullScreen)}},{key:"InitPanel",value:function(){var e=this,t=document.createElement("div");t.setAttribute("class","comma-img-editor"),t.style.display="flex",t.tabIndex=9999;var n=document.createElement("div");n.setAttribute("class","ciec-close-btn");var i=document.createElement("i");function o(){e.editor.Hide()}i.setAttribute("class","fa fa-close"),n.appendChild(i),n.removeEventListener("click",o),n.addEventListener("click",o),t.appendChild(n);var r=document.createElement("div");r.setAttribute("class","comma-img-editor-container");var s=document.createElement("div");s.setAttribute("class","cie-pnl-preview");var a=document.createElement("div");a.setAttribute("class","cie-canvas-wrapper");var l=document.createElement("canvas");return a.appendChild(l),this.canvasWrapper=a,s.appendChild(a),r.appendChild(s),r.appendChild(this._createToolsOptionsPnl()),r.appendChild(this._createMenuPnl()),t.appendChild(r),document.body.appendChild(t),(this.panelFullScreen=t).focus(),t.addEventListener("keydown",this.keyDownEvent,!1),l}},{key:"_onKeyDown",value:function(e){var t=e.key;"Delete"===t?this.editor.DeleteSelectedObject():event.metaKey&&!event.shiftKey&&"z"==t?(this.editor.Undo(),event.preventDefault(),event.stopPropagation()):event.shiftKey&&event.metaKey&&"z"==t?(this.editor.Redo(),event.preventDefault(),event.stopPropagation()):event.ctrlKey&&!event.shiftKey&&"z"==t?(this.editor.Undo(),event.preventDefault(),event.stopPropagation()):event.ctrlKey&&event.shiftKey&&"z"==t&&(this.editor.Redo(),event.preventDefault(),event.stopPropagation())}},{key:"ShowLoadingPanel",value:function(){this.loadingPanel.Show()}},{key:"HideLoadingPanel",value:function(){this.loadingPanel.Hide()}},{key:"ClickMenuBtn",value:function(e,t){var n,i=this,o=t.getAttribute("id");"cie-btn-undo"==o?this.editor.Undo().then(function(e){i.RefreshCurrentPnl(e)}):"cie-btn-redo"==o?this.editor.Redo().then(function(e){i.RefreshCurrentPnl(e)}):"cie-btn-reset"==o?this.ResetToOrigin():"cie-btn-save"==o?this.editor.Save():(n=!0,null!=this.currentMenuBtn&&this.currentMenuBtn.id==t.id&&(n=!1,"cie-btn-crop"==this.currentMenuBtn.id?this.HideToolOptionPnl("crop"):"cie-btn-flip"==this.currentMenuBtn.id?this.HideToolOptionPnl("flip"):"cie-btn-rotate"==this.currentMenuBtn.id?this.HideToolOptionPnl("rotate"):"cie-btn-draw"==this.currentMenuBtn.id?this.HideToolOptionPnl("draw"):"cie-btn-shapes"==this.currentMenuBtn.id?this.HideToolOptionPnl("shapes"):"cie-btn-text"==this.currentMenuBtn.id?this.HideToolOptionPnl("text"):"cie-btn-filters"==this.currentMenuBtn.id?this.HideToolOptionPnl("filters"):"cie-btn-frame"==this.currentMenuBtn.id&&this.HideToolOptionPnl("frame")),this.OffMenuButton(),n&&(t.classList.contains("cie-pnl-menu-btn-selected")||(t.classList.add("cie-pnl-menu-btn-selected"),this.currentMenuBtn=t,"cie-btn-crop"==o?this.ShowToolOptionPnl("crop"):"cie-btn-flip"==o?this.ShowToolOptionPnl("flip"):"cie-btn-rotate"==o?this.ShowToolOptionPnl("rotate"):"cie-btn-draw"==o?this.ShowToolOptionPnl("draw"):"cie-btn-shapes"==o?this.ShowToolOptionPnl("shapes"):"cie-btn-text"==o?this.ShowToolOptionPnl("text"):"cie-btn-filters"==o?this.ShowToolOptionPnl("filters"):"cie-btn-frame"==o&&this.ShowToolOptionPnl("frame")))),e.preventDefault(),e.stopPropagation()}},{key:"ResetToOrigin",value:function(){this.editor.ResetToOriginalImage(),this.filtersManager.ResetToDefaults()}},{key:"RefreshCurrentPnl",value:function(e){null!=this.currentMenuBtn&&("cie-btn-crop"==this.currentMenuBtn.id?this.ShowToolOptionPnl("crop"):"cie-btn-flip"==this.currentMenuBtn.id||"cie-btn-rotate"==this.currentMenuBtn.id||"cie-btn-draw"==this.currentMenuBtn.id||"cie-btn-shapes"==this.currentMenuBtn.id||"cie-btn-text"==this.currentMenuBtn.id||("cie-btn-filters"==this.currentMenuBtn.id?this.filtersManager.SetFilters(e):"cie-btn-frame"==this.currentMenuBtn.id&&null!=e&&this.frameManager.Reset(e.color,e.width)))}},{key:"OffMenuButton",value:function(){var e;null!=this.currentMenuBtn&&(e=this.currentMenuBtn.id,document.getElementById(e+"-panel").style.display="none",this.currentMenuBtn.classList.remove("cie-pnl-menu-btn-selected"),this.currentMenuBtn=void 0,this.rotateManager.Close(),this.flipManager.Close(),this.frameManager.Close(),this.cropManager.Close(),this.drawManager.Close(),this.shapesManager.Close(),this.textManager.Close(),this.filtersManager.Close())}},{key:"HideToolOptionPnl",value:function(e){"crop"==e?this.cropManager.Close():"flip"==e?this.flipManager.Close():"rotate"==e?this.rotateManager.Close():"draw"==e?this.drawManager.Close():"shapes"==e?this.shapesManager.Close():"text"==e?this.textManager.Close():"filters"==e&&this.filtersManager.Close(),document.getElementById("cie-btn-"+e+"-panel").style.display="none",document.getElementById("cie-tool-option-panel").style.display="none"}},{key:"ShowToolOptionPnl",value:function(e){"crop"==e?this.cropManager.Start():"flip"==e?this.flipManager.Start():"rotate"==e?this.rotateManager.Start():"draw"==e?this.drawManager.Start():"shapes"==e?this.shapesManager.Start():"text"==e?this.textManager.Start():"filters"==e&&this.filtersManager.Start(),document.getElementById("cie-btn-"+e+"-panel").style.display="flex",document.getElementById("cie-tool-option-panel").style.display="flex"}},{key:"_createToolsOptionsPnl",value:function(){var e=document.createElement("div");return e.setAttribute("class","cie-pnl-tool-option"),e.setAttribute("id","cie-tool-option-panel"),e.appendChild(this.rotateManager.CreateToolsOptionsPnl(this._createToolsOptionButton,this._createToolsOptionDivider)),e.appendChild(this.flipManager.CreateToolsOptionsPnl(this._createToolsOptionButton,this._createToolsOptionDivider)),e.appendChild(this.frameManager.CreateToolsOptionsPnl(this._createToolsOptionButton,this._createToolsOptionDivider)),e.appendChild(this.cropManager.CreateToolsOptionsPnl(this._createToolsOptionButton,this._createToolsOptionDivider)),e.appendChild(this.drawManager.CreateToolsOptionsPnl(this._createToolsOptionButton,this._createToolsOptionDivider)),e.appendChild(this.shapesManager.CreateToolsOptionsPnl(this._createToolsOptionButton,this._createToolsOptionDivider)),e.appendChild(this.textManager.CreateToolsOptionsPnl(this._createToolsOptionButton,this._createToolsOptionDivider)),e.appendChild(this.filtersManager.CreateToolsOptionsPnl(this._createToolsOptionButton,this._createToolsOptionDivider)),e}},{key:"_createToolsOptionDivider",value:function(){var e=document.createElement("div");return e.setAttribute("class","cie-pnl-tool-option-btn-divider"),e}},{key:"_createToolsOptionButton",value:function(e,t,n,i){var o=document.createElement("div");o.setAttribute("class","cie-pnl-tool-option-btn"),null!=i&&o.setAttribute("id",i),o.removeEventListener("click",n),o.addEventListener("click",n);var r=document.createElement("i");r.setAttribute("class",t),r.style.fontSize="18px",o.appendChild(r);var s=document.createElement("span");return s.style.marginLeft="6px",s.innerHTML=e,o.appendChild(s),o}},{key:"_createMenuBtn",value:function(e,t,n,i){var o=document.createElement("div");o.setAttribute("class","cie-pnl-menu-btn"),o.setAttribute("id",e),o.setAttribute("title",n),o.removeEventListener("click",i),o.addEventListener("click",i);var r=document.createElement("i");return r.setAttribute("class",t),o.appendChild(r),o}},{key:"_createMenuDivider",value:function(){var e=document.createElement("div");return e.setAttribute("class","cie-pnl-menu-divider"),e}},{key:"_createMenuPnl",value:function(){function e(e){t.ClickMenuBtn(e,this)}var t=this,n=document.createElement("div");n.setAttribute("class","cie-pnl-menu"),n.appendChild(this._createMenuBtn("cie-btn-undo","fa fa-reply","Undo",e)),n.appendChild(this._createMenuBtn("cie-btn-redo","fa fa-share","Redo",e)),n.appendChild(this._createMenuBtn("cie-btn-reset","fa fa-trash","Reset to Original",e)),n.appendChild(this._createMenuDivider()),n.appendChild(this._createMenuBtn("cie-btn-frame","fa fa-square-o","Add Frame",e)),n.appendChild(this._createMenuBtn("cie-btn-crop","fa fa-crop","Crop",e)),n.appendChild(this._createMenuBtn("cie-btn-flip","fa fa-arrows-h","Flip",e)),n.appendChild(this._createMenuBtn("cie-btn-rotate","fa fa-refresh","Rotate",e)),n.appendChild(this._createMenuDivider()),n.appendChild(this._createMenuBtn("cie-btn-draw","fa fa-paint-brush","Free Paint",e)),n.appendChild(this._createMenuBtn("cie-btn-shapes","fa fa-star-o","Add Shapes",e)),n.appendChild(this._createMenuBtn("cie-btn-text","fa fa-font","Add Text",e)),n.appendChild(this._createMenuDivider()),n.appendChild(this._createMenuBtn("cie-btn-filters","fa fa-sliders","Add Filter",e)),n.appendChild(this._createMenuDivider());var i=document.createElement("div");i.setAttribute("class","cie-pnl-menu-btn-save"),i.setAttribute("id","cie-btn-save"),i.removeEventListener("click",e),i.addEventListener("click",e);var o=document.createElement("div");return o.style.fontFamily="Arial",o.innerHTML="Save",i.appendChild(o),n.appendChild(i),n}}]),D);function D(e){!function(e){if(!(e instanceof D))throw new TypeError("Cannot call a class as a function")}(this),this.editor=e,this.panelFullScreen=void 0,this.canvasWrapper=void 0,this.loadingPanel=void 0,this.currentMenuBtn=void 0,this.loadingPanel=new o,this.rotateManager=new a(this.editor),this.flipManager=new u(this.editor),this.frameManager=new m(this.editor),this.cropManager=new b(this.editor),this.drawManager=new w(this.editor),this.shapesManager=new E(this.editor),this.textManager=new O(this.editor),this.filtersManager=new N(this.editor),this.keyDownEvent=this._onKeyDown.bind(this)}function I(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var L=(I(B.prototype,[{key:"Clear",value:function(){this.history=new Array,this.deletedHistory=new Array}},{key:"Push",value:function(e){this.history.push(e),this.deletedHistory=new Array}},{key:"Undo",value:function(){var e=this.history.pop();return null!=e&&this.deletedHistory.push(e),e}},{key:"Redo",value:function(){var e=this.deletedHistory.pop();return null!=e&&this.history.push(e),e}}]),B);function B(){!function(e){if(!(e instanceof B))throw new TypeError("Cannot call a class as a function")}(this),this.history=new Array,this.deletedHistory=new Array}function j(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var G=(j(z.prototype,[{key:"GetNew",value:function(){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=!1,n="";!t;){for(var i=0;i<5;i++)n+=e.charAt(Math.floor(Math.random()*e.length));null==this.allKeys[n]&&(t=this.allKeys[n]=!0)}return n}},{key:"Release",value:function(e){delete this.allKeys[e]}},{key:"VerifyAndRegister",value:function(e){return this.allKeys[e]&&(e=this.GetNew()),this.allKeys[e]=!0,e}},{key:"Reset",value:function(){this.allKeys={}}}]),z),H=n(0);function z(e){!function(e){if(!(e instanceof z))throw new TypeError("Cannot call a class as a function")}(this),this.allKeys={},null!=e&&e.forEach(function(e){this.allKeys[e]=!0})}function Y(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var U,W,X=(W=[{key:"GetObjectConfiguration",value:function(){return{cornerStyle:"circle",cornerSize:18,cornerColor:"#fff",cornerStrokeColor:"#fff",transparentCorners:!1,lineWidth:3,borderColor:"#fff"}}}],Y((U=V).prototype,[{key:"Reset",value:function(){this.allObjects={},this.txtPrevious={}}},{key:"InitEvents",value:function(){var n=this;this.canvasManager.canvas.on({"selection:created":function(e){var t=e.target;n.selectedObject=t}})}},{key:"_addEvents",value:function(e){e.on({scaled:this._listeners.objectScaled}),e.on({rotated:this._listeners.objectRotated}),e.on({moved:this._listeners.objectMoved}),e.on({"editing:exited":this._listeners.objectEditingExited})}},{key:"Add",value:function(e,t){var n,i=1<arguments.length&&void 0!==t&&t;null==e.id&&(e.id=this.idManager.GetNew()),e.set(V.GetObjectConfiguration()),"i-text"==e.get("type").toLowerCase()&&(this.txtPrevious[e.id]=e.text),this.allObjects[e.id]=e,this._addEvents(e),i||(n={action:"added",idObject:e.id,json:e.toJSON(["id"])},this.canvasManager.PushToHistory("object",n))}},{key:"RemoveSelectedObject",value:function(){var e=this.canvasManager.canvas,t=e.getActiveObject(),n={action:"removed",idObject:t.id,json:t.toJSON(["id"])};e.remove(t),e.renderAll(),this.canvasManager.PushToHistory("object",n)}},{key:"ManageHistory",value:function(e,t){return"undo"==e?this._undo(t):this._redo(t)}},{key:"_undo",value:function(e){var t=this.allObjects[e.idObject];return"modified"==e.action?(t.set(e.previousState),t.setCoords(),this.canvasManager.canvas.renderAll()):"added"==e.action?(this.canvasManager.canvas.remove(t),this.canvasManager.canvas.renderAll()):"removed"==e.action?this._addObjFromHistory(e.idObject,e.json):"textModified"==e.action&&(t.text=e.prevText,t.setCoords(),this.canvasManager.canvas.renderAll()),Promise.resolve()}},{key:"_redo",value:function(e){var t=this.allObjects[e.idObject];return"modified"==e.action?(t.set(e.newState),t.setCoords(),this.canvasManager.canvas.renderAll()):"added"==e.action?this._addObjFromHistory(e.idObject,e.json):"removed"==e.action?(this.canvasManager.canvas.remove(t),this.canvasManager.canvas.renderAll()):"textModified"==e.action&&(t.text=e.newText,t.setCoords(),this.canvasManager.canvas.renderAll()),Promise.resolve()}},{key:"_addObjFromHistory",value:function(n,e){var i=this,o=this.canvasManager.canvas;H.fabric.util.enlivenObjects([e],function(e){var t=o.renderOnAddRemove;o.renderOnAddRemove=!1,e.forEach(function(e){e.id=n,i.allObjects[e.id]=e,i._addEvents(e),e.set(V.GetObjectConfiguration()),o.add(e)}),o.renderOnAddRemove=t,o.renderAll()})}},{key:"_onObjectScaled",value:function(e){this._pushChangesToHistory(e)}},{key:"_onObjectRotated",value:function(e){this._pushChangesToHistory(e)}},{key:"_onObjectMoved",value:function(e){this._pushChangesToHistory(e)}},{key:"_onObjectEditingExited",value:function(){var e,t,n=this.canvasManager.canvas.getActiveObject();"i-text"==n.get("type").toLowerCase()&&(e=this.txtPrevious[n.id],t={action:"textModified",newText:n.text,prevText:e,idObject:n.id},this.canvasManager.PushToHistory("object",t),this.txtPrevious[n.id]=n.text)}},{key:"_pushChangesToHistory",value:function(e){var t={action:"modified",previousState:{angle:e.transform.original.angle,top:e.transform.original.top,left:e.transform.original.left,scaleX:e.transform.original.scaleX,scaleY:e.transform.original.scaleY,originX:"left",originY:"top"},newState:{angle:e.target.angle,top:e.target.top,left:e.target.left,scaleX:e.target.scaleX,scaleY:e.target.scaleY,originX:"left",originY:"top"},idObject:e.target.id};this.canvasManager.PushToHistory("object",t)}}]),Y(U,W),V);function V(e){!function(e){if(!(e instanceof V))throw new TypeError("Cannot call a class as a function")}(this),this.canvasManager=e,this.selectedObject=void 0,this.allObjects={},this.idManager=new G,this.txtPrevious={},this._listeners={objectScaled:this._onObjectScaled.bind(this),objectRotated:this._onObjectRotated.bind(this),objectMoved:this._onObjectMoved.bind(this),objectEditingExited:this._onObjectEditingExited.bind(this)}}function q(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var K=(q(J.prototype,[{key:"Flip",value:function(e,t){var n,i=1<arguments.length&&void 0!==t&&t;"vertically"==e?this.flipY():this.flipX(),i||(n={direction:e},this.canvasManager.PushToHistory("flip",n))}},{key:"ManageHistory",value:function(e,t){return"undo"==e?this._undo(t):this._redo(t)}},{key:"_undo",value:function(e){return this.Flip(e.direction,!0),Promise.resolve()}},{key:"_redo",value:function(e){return this.Flip(e.direction,!0),Promise.resolve()}},{key:"setImageProperties",value:function(e,t){var n=this.canvasManager.canvasImg;n&&(n.set(e).setCoords(),t&&this.canvasManager.canvas.renderAll())}},{key:"setFlip",value:function(e){var t=this.canvasManager.canvasImg.flipX,n=this.canvasManager.canvasImg.flipY,i=t!==e.flipX,o=n!==e.flipY;return i||o?(this.setImageProperties(e,!0),this._invertAngle(i,o),this._flipObjects(i,o),Promise.resolve({flipX:e.flipX,flipY:e.flipY,angle:this.canvasManager.canvasImg.angle})):Promise.reject(rejectMessages.flip)}},{key:"_invertAngle",value:function(e,t){var n=this.canvasManager.canvasImg,i=n.angle;e&&(i*=-1),t&&(i*=-1),n.rotate(parseFloat(i)).setCoords()}},{key:"_flipObjects",value:function(e,t){var n=this.canvasManager.canvas;e&&n.forEachObject(function(e){e.set({angle:parseFloat(-1*e.angle),flipX:!e.flipX,left:n.width-e.left}).setCoords()}),t&&n.forEachObject(function(e){e.set({angle:parseFloat(-1*e.angle),flipY:!e.flipY,top:n.height-e.top}).setCoords()}),n.renderAll()}},{key:"flipX",value:function(){var e={flipX:this.canvasManager.canvasImg.flipX,flipY:this.canvasManager.canvasImg.flipY};return this.setFlip({flipX:!e.flipX,flipY:e.flipY})}},{key:"flipY",value:function(){var e={flipX:this.canvasManager.canvasImg.flipX,flipY:this.canvasManager.canvasImg.flipY};return this.setFlip({flipX:e.flipX,flipY:!e.flipY})}}]),J);function J(e){!function(e){if(!(e instanceof J))throw new TypeError("Cannot call a class as a function")}(this),this.canvasManager=e}function $(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Z(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var Q=(Z(ee.prototype,[{key:"Start",value:function(){"free"==this.type?(this._initFreeDrawing(),this._stopStraightLine()):(this._stopFreeDrawing(),this._initStraightLine())}},{key:"Stop",value:function(){this._stopFreeDrawing(),this._stopStraightLine()}},{key:"_initFreeDrawing",value:function(){this.canvasManager.canvas.isDrawingMode=!0,this.canvasManager.canvas.on({"path:created":this._listeners.pathCreated})}},{key:"_stopFreeDrawing",value:function(){this.canvasManager.canvas.isDrawingMode=!1,this.canvasManager.canvas.off({"path:created":this._listeners.pathCreated})}},{key:"_initStraightLine",value:function(){var e=this.canvasManager.canvas;e.defaultCursor="crosshair",e.selection=!1,e.forEachObject(function(e){e.set({evented:!1,selectable:!1})}),e.on({"mouse:down":this._listeners.mousedown})}},{key:"_stopStraightLine",value:function(){var e=this.canvasManager.canvas;e.defaultCursor="default",e.selection=!0,e.forEachObject(function(e){e.set({evented:!0,selectable:!0})}),e.off({"mouse:down":this._listeners.mousedown}),e.__eventListeners["mouse:down"]=[]}},{key:"SetDrawingParameters",value:function(e,t,n){this.brushSize=t,this.color=n;var i=this.canvasManager.canvas.freeDrawingBrush;i.width=t,i.color=n,this.type!=e&&(this.type=e,"free"==this.type?(this._initFreeDrawing(),this._stopStraightLine()):(this._stopFreeDrawing(),this._initStraightLine()))}},{key:"_onPathCreated",value:function(e){var t=e.path;t.set(X.GetObjectConfiguration()),this.canvasManager.AddObject(t)}},{key:"_onMouseDown",value:function(e){var t,n,i=this.canvasManager.canvas,o=i.getPointer(e.e),r=[o.x,o.y,o.x,o.y];this.startX=o.x,this.startY=o.y,"straight"==this.type?this._shape=new H.fabric.Line(r,{stroke:this.color,strokeWidth:this.brushSize,evented:!1,selectable:!1}):"rectangle"==this.type?this._shape=new H.fabric.Rect(($(t={stroke:this.color,strokeWidth:this.brushSize,evented:!1,left:o.x,top:o.y,width:0,height:0,fill:"transparent"},"evented",!1),$(t,"selectable",!1),t)):"circle"==this.type?this._shape=new H.fabric.Circle(($(n={stroke:this.color,strokeWidth:this.brushSize,evented:!1,left:o.x,top:o.y,radius:0,fill:"transparent"},"evented",!1),$(n,"selectable",!1),n)):"arrow"==this.type&&(this._shape=new H.fabric.Line(r,{stroke:this.color,strokeWidth:this.brushSize,evented:!1,selectable:!1})),i.add(this._shape),i.__eventListeners["mouse:move"]=[],i.__eventListeners["mouse:up"]=[],i.on({"mouse:move":this._listeners.mousemove,"mouse:up":this._listeners.mouseup})}},{key:"_onMouseMove",value:function(e){var t,n,i,o,r,s,a,l=this.canvasManager.canvas,c=l.getPointer(e.e);"straight"==this.type?this._shape.set({x2:c.x,y2:c.y}):"rectangle"==this.type?(t=this._shape.left,n=this._shape.top,i=c.x-this.startX,o=c.y-this.startY,i<0&&(t=c.x,i=Math.abs(i)),o<0&&(n=c.y,o=Math.abs(o)),this._shape.set({width:i,height:o,left:t,top:n})):"circle"==this.type?(r=this._shape.left,s=this._shape.top,(a=(c.x-this.startX)/2)<0&&(a=Math.abs(a),r=c.x,s=c.y),this._shape.set({radius:a,left:r,top:s})):"arrow"==this.type&&this._shape.set({x2:c.x,y2:c.y}),this._shape.setCoords(),l.renderAll()}},{key:"_onMouseUp",value:function(e){var t,n=this.canvasManager.canvas;"arrow"==this.type&&(t=n.getPointer(e.e),n.remove(this._shape),this._shape=this._drawArrow(this.startX,this.startY,t.x,t.y),n.add(this._shape),n.renderAll()),this._shape.set(X.GetObjectConfiguration()),this.canvasManager.AddObject(this._shape),n.off({"mouse:move":this._listeners.mousemove,"mouse:up":this._listeners.mouseup}),n.__eventListeners["mouse:move"]=[],n.__eventListeners["mouse:up"]=[]}},{key:"_drawArrow",value:function(e,t,n,i){var o=Math.atan2(i-t,n-e),r=this.brushSize/2;n-=r*Math.cos(o),i-=r*Math.sin(o);var s=[{x:e,y:t},{x:e-r/4*Math.cos(o-Math.PI/2),y:t-r/4*Math.sin(o-Math.PI/2)},{x:n-r/4*Math.cos(o-Math.PI/2),y:i-r/4*Math.sin(o-Math.PI/2)},{x:n-r*Math.cos(o-Math.PI/2),y:i-r*Math.sin(o-Math.PI/2)},{x:n+r*Math.cos(o),y:i+r*Math.sin(o)},{x:n-r*Math.cos(o+Math.PI/2),y:i-r*Math.sin(o+Math.PI/2)},{x:n-r/4*Math.cos(o+Math.PI/2),y:i-r/4*Math.sin(o+Math.PI/2)},{x:e-r/4*Math.cos(o+Math.PI/2),y:t-r/4*Math.sin(o+Math.PI/2)},{x:e,y:t}];return new H.fabric.Polyline(s,{fill:this.color,stroke:this.color,opacity:1,strokeWidth:this.brushSize,selectable:!1,evented:!1})}}]),ee);function ee(e){!function(e){if(!(e instanceof ee))throw new TypeError("Cannot call a class as a function")}(this),this.canvasManager=e,this.type="free",this.brushSize=10,this.color="#FFFFFF",this._listeners={mousedown:this._onMouseDown.bind(this),mousemove:this._onMouseMove.bind(this),mouseup:this._onMouseUp.bind(this),pathCreated:this._onPathCreated.bind(this)}}function te(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var ne=(te(ie.prototype,[{key:"Crop",value:function(e){var n=this,i=this.canvasManager.canvas,t=this.canvasManager.domCanvas.getBoundingClientRect(),o=i.width/t.width,r=i.height/t.height,s={top:r*(e.top-t.top),left:o*(e.left-t.left),width:o*e.width,height:r*e.height},a=(this.canvasManager.toDataURL({format:"png"}),this.canvasManager.toDataURL(s)),l={undoCanvasJson:JSON.stringify(i.toObject(["id"])),frameBorder:this.canvasManager.frameBorder,redoCanvasPng:a};return new Promise(function(e,t){i.clear(),i.setBackgroundImage(a,function(){n.canvasManager.frameBorder=0,n.canvasManager.canvasImg=i.backgroundImage,n.canvasManager.AdjustToScreen(),n.canvasManager.PushToHistory("crop",l),e()})})}},{key:"ManageHistory",value:function(e,t){return"undo"==e?this._undo(t):this._redo(t)}},{key:"_undo",value:function(n){var i=this,o=this.canvasManager.canvas;return o.clear(),new Promise(function(e,t){o.loadFromJSON(n.undoCanvasJson,function(){o.renderAll(),i.canvasManager.canvas.forEachObject(function(e){i.canvasManager.AddObject(e,!0)}),i.canvasManager.frameBorder=n.frameBorder,i.canvasManager.canvasImg=o.backgroundImage,i.canvasManager.AdjustToScreen(),e()})})}},{key:"_redo",value:function(n){var i=this,o=this.canvasManager.canvas;return new Promise(function(e,t){o.clear(),o.setBackgroundImage(n.redoCanvasPng,function(){i.canvasManager.canvasImg=o.backgroundImage,i.canvasManager.AdjustToScreen(),e()})})}}]),ie);function ie(e){!function(e){if(!(e instanceof ie))throw new TypeError("Cannot call a class as a function")}(this),this.canvasManager=e}function oe(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var re=(oe(se.prototype,[{key:"ManageHistory",value:function(e,t){return"undo"==e?this._undo(t):this._redo(t)}},{key:"_undo",value:function(e){return 666==e.prevValue?this._removeFilter(e.type):this.Apply(e.type,e.prevValue,!0),Promise.resolve(this.currentState)}},{key:"_redo",value:function(e){return this.Apply(e.type,e.newValue,!0),Promise.resolve(this.currentState)}},{key:"Apply",value:function(e,t,n){var i=2<arguments.length&&void 0!==n&&n;this.currentState[e]=t;var o,r=this.canvasManager.canvasImg,s=0;null==r.filters[this.filtersNames[e]]?(s=666,this._initFilter(r,e,t)):s=this._applyValue(r,e,t),r.applyFilters(),this.canvasManager.canvas.renderAll(),i||(o={type:e,prevValue:s,newValue:t},this.canvasManager.PushToHistory("filters",o))}},{key:"_removeFilter",value:function(e){var t,n,i=this.canvasManager.canvasImg;"red"==e||"green"==e||"blue"==e?(this.currentState[e]=1,n=(t=i.filters[this.filtersNames[e]]).gamma,"red"==e?n[0]=1:"green"==e?n[1]=1:"blue"==e&&(n[2]=1),t.gamma=n):(this.currentState[e]=0,i.filters.splice(this.filtersNames[e],1)),i.applyFilters(),this.canvasManager.canvas.renderAll()}},{key:"_initFilter",value:function(e,t,n){var i;"brightness"==t?e.filters[this.filtersNames[t]]=new this.f.Brightness({brightness:parseFloat(n)}):"contrast"==t?e.filters[this.filtersNames[t]]=new this.f.Contrast({contrast:parseFloat(n)}):"blur"==t?e.filters[this.filtersNames[t]]=new this.f.Blur({blur:parseFloat(n)}):"hue"==t?e.filters[this.filtersNames[t]]=new this.f.HueRotation({rotation:parseFloat(n)}):"saturate"==t?e.filters[this.filtersNames[t]]=new this.f.Saturation({saturation:parseFloat(n)}):"noise"==t?e.filters[this.filtersNames[t]]=new this.f.Noise({noise:parseFloat(n)}):"red"!=t&&"green"!=t&&"blue"!=t||(i=[],"red"==t?(i.push(n),i.push(1),i.push(1)):"green"==t?(i.push(1),i.push(n),i.push(1)):"blue"==t&&(i.push(1),i.push(1),i.push(n)),e.filters[this.filtersNames[t]]=new this.f.Gamma({gamma:i}))}},{key:"_applyValue",value:function(e,t,n){var i,o=0,r=e.filters[this.filtersNames[t]];return"brightness"==t?(o=r.brightness,r.brightness=parseFloat(n)):"contrast"==t?(o=r.contrast,r.contrast=parseFloat(n)):"blur"==t?(o=r.blur,r.blur=parseFloat(n)):"hue"==t?(o=r.rotation,r.rotation=parseFloat(n)):"saturate"==t?(o=r.saturation,r.saturation=parseFloat(n)):"noise"==t?(o=r.noise,r.noise=parseFloat(n)):"red"!=t&&"green"!=t&&"blue"!=t||(o=r.gamma,i=JSON.parse(JSON.stringify(o)),"red"==t?(o=o[0],i[0]=n):"green"==t?(o=o[1],i[1]=n):"blue"==t&&(o=o[2],i[2]=n),r.gamma=i),o}}]),se);function se(e){!function(e){if(!(e instanceof se))throw new TypeError("Cannot call a class as a function")}(this),this.canvasManager=e,H.fabric.textureSize=10016384,this.filterEngine=new H.fabric.Canvas2dFilterBackend,H.fabric.filterBackend=H.fabric.initFilterBackend(),H.fabric.filterBackend=this.filterEngine,this.f=H.fabric.Image.filters,this.filtersNames={brightness:0,contrast:1,blur:2,noise:3,hue:4,saturate:5,red:6,green:6,blue:6},this.currentState={brightness:0,contrast:0,blur:0,noise:0,hue:0,saturate:0,red:1,green:1,blue:1}}function ae(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var le=(ae(ce.prototype,[{key:"Frame",value:function(e,t,n){var i=2<arguments.length&&void 0!==n&&n,o=this.canvasManager.canvas,r=this.canvasManager.canvasImg,s={prevWidth:this.previousFrameSize,prevColor:o.backgroundColor,newWidth:t,newColor:e};i||(this.previousFrameSize=t);var a=this.canvasManager.domCanvas.getBoundingClientRect(),l=o.width/a.width*t;this.canvasManager.frameBorder=l;var c=r.getCenterPoint();r.top=l,r.left=l,o.renderAll();var u=r.getCenterPoint();this._adjustAllObjects(c,u,l),this.canvasManager.AdjustToScreen(),o.backgroundColor=e,o.renderAll(),i||this.canvasManager.PushToHistory("frame",s)}},{key:"_adjustAllObjects",value:function(e,t){var n=this.canvasManager.canvas,i=e.x-t.x,o=e.y-t.y;n.forEachObject(function(e){var t=e.getCenterPoint();e.set({left:t.x-i,top:t.y-o,originX:"center",originY:"center"}),e.setCoords()}),n.renderAll()}},{key:"ManageHistory",value:function(e,t){return"undo"==e?this._undo(t):this._redo(t)}},{key:"_undo",value:function(e){return this.Frame(e.prevColor,e.prevWidth,!0),Promise.resolve({color:e.prevColor,width:e.prevWidth})}},{key:"_redo",value:function(e){return this.Frame(e.newColor,e.newWidth,!0),Promise.resolve({color:e.newColor,width:e.newWidth})}}]),ce);function ce(e){!function(e){if(!(e instanceof ce))throw new TypeError("Cannot call a class as a function")}(this),this.canvasManager=e,this.previousFrameSize=0}function ue(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var he=(ue(de.prototype,[{key:"Rotate",value:function(e,t){var n=1<arguments.length&&void 0!==t&&t,i=this.canvasManager.canvasImg,o=i.angle%360;e%=360;var r=i.getCenterPoint();i.set({angle:e}).setCoords(),this.canvasManager.AdjustToScreen();var s,a=i.getCenterPoint();this._rotateAllObjects(r,a,e-o),n||(s={oldAngle:o,newAngle:e},this.canvasManager.PushToHistory("rotate",s))}},{key:"_rotateAllObjects",value:function(o,e,r){var t=this.canvasManager.canvas,s=o.x-e.x,a=o.y-e.y;t.forEachObject(function(e){var t=e.getCenterPoint(),n=H.fabric.util.degreesToRadians(r),i=H.fabric.util.rotatePoint(t,o,n);e.set({left:i.x-s,top:i.y-a,originX:"center",originY:"center",angle:(e.angle+r)%360}),e.setCoords()}),t.renderAll()}},{key:"ManageHistory",value:function(e,t){return"undo"==e?this._undo(t):this._redo(t)}},{key:"_undo",value:function(e){return this.Rotate(e.oldAngle,!0),Promise.resolve(e.oldAngle)}},{key:"_redo",value:function(e){return this.Rotate(e.newAngle,!0),Promise.resolve(e.newAngle)}}]),de);function de(e){!function(e){if(!(e instanceof de))throw new TypeError("Cannot call a class as a function")}(this),this.canvasManager=e}function fe(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var pe=(fe(ge.prototype,[{key:"Start",value:function(){var e=this.canvasManager.canvas;e.defaultCursor="crosshair",e.selection=!1,e.on({"mouse:down":this.mousedown})}},{key:"Stop",value:function(){var e=this.canvasManager.canvas;e.defaultCursor="default",e.selection=!0,e.off({"mouse:down":this.mousedown}),e.__eventListeners["mouse:down"]=[]}},{key:"SetTextParameters",value:function(e,t,n){var i=2<arguments.length&&void 0!==n?n:"Arial";this.fontSize=e,this.color=t,this.fontFamily=i}},{key:"AddText",value:function(e,t){var n=this.canvasManager.canvas,i=new H.fabric.IText("Click to edit",{left:e,top:t,fontSize:this.fontSize,fontFamily:this.fontFamily,stroke:this.color,fill:this.color});i.set(X.GetObjectConfiguration()),n.add(i),this.canvasManager.AddObject(i)}},{key:"_onMouseDown",value:function(e){var t;null==e.target&&(t=this.canvasManager.canvas.getPointer(e.e),this.AddText(t.x,t.y))}}]),ge);function ge(e){!function(e){if(!(e instanceof ge))throw new TypeError("Cannot call a class as a function")}(this),this.canvasManager=e,this.fontSize=40,this.color="#ffffff",this.fontFamily="Arial",this.mousedown=this._onMouseDown.bind(this)}function me(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var ve=(me(ye.prototype,[{key:"Reset",value:function(i){var o=this;this.canvasManager.imgSrc=i;var r=this.canvasManager.canvas,s={undoCanvasJson:JSON.stringify(r.toObject(["id"])),frameBorder:this.canvasManager.frameBorder};return r.clear(),new Promise(function(e,t){var n=new Image;n.onload=function(){o.canvasManager.frameBorder=0,o.canvasManager.canvasImg=new H.fabric.Image(n),r.setBackgroundImage(o.canvasManager.canvasImg),o.canvasManager.AdjustToScreen(),s.redoCanvasPng=r.toDataURL({format:"png"}),o.canvasManager.PushToHistory("reset",s),o.canvasManager.canvas.renderAll(),e()},n.src=i})}},{key:"ManageHistory",value:function(e,t){return"undo"==e?this._undo(t):this._redo(t)}},{key:"_undo",value:function(n){var i=this,o=this.canvasManager.canvas;return o.clear(),new Promise(function(e,t){o.loadFromJSON(n.undoCanvasJson,function(){o.renderAll(),i.canvasManager.canvas.forEachObject(function(e){i.canvasManager.AddObject(e,!0)}),i.canvasManager.frameBorder=n.frameBorder,i.canvasManager.canvasImg=o.backgroundImage,i.canvasManager.AdjustToScreen(),e()})})}},{key:"_redo",value:function(n){var i=this,o=this.canvasManager.canvas;return new Promise(function(e,t){o.clear(),o.setBackgroundImage(n.redoCanvasPng,function(){i.canvasManager.canvasImg=o.backgroundImage,i.canvasManager.AdjustToScreen(),e()})})}}]),ye);function ye(e){!function(e){if(!(e instanceof ye))throw new TypeError("Cannot call a class as a function")}(this),this.canvasManager=e}function be(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var Ce=(be(xe.prototype,[{key:"InitCanvas",value:function(){var i=this;return new Promise(function(e,t){var n=new Image;n.onload=function(){i.canvas=new H.fabric.Canvas(i.domCanvas,{enableRetinaScaling:!1,width:n.width,height:n.height}),i.canvasImg=new H.fabric.Image(n),i.canvas.setBackgroundImage(i.canvasImg),i.canvas.requestRenderAll(),i.AdjustToScreen(),i.objectsManager.InitEvents(),e()},n.src=i.imgSrc})}},{key:"toDataURL",value:function(e){return this.canvas.toDataURL(e)}},{key:"GetBoundingClientRect",value:function(){return this.domCanvas.getBoundingClientRect()}},{key:"_adjustDimensions",value:function(e,t){var n=this.maxWindowWidth/e,i=this.maxWindowHeight/t,o=Math.min(e,this.maxWindowWidth),r=Math.min(t,this.maxWindowHeight);return n<1&&n<i?(o=e*n,r=t*n):i<1&&i<n&&(o=e*i,r=t*i),{width:Math.floor(o),height:Math.floor(r)}}},{key:"AdjustToScreen",value:function(){var e=this.canvasImg.scale(1),t=e.getBoundingRect(),n=t.width,i=t.height;n+=this.frameBorder,i+=this.frameBorder;var o=this._adjustDimensions(n,i);this.setCanvasDimension_CSS({"max-width":o.width+"px","max-height":o.height+"px"}),this.setCanvasDimension_Backstore({width:n,height:i}),this.canvas.centerObject(e)}},{key:"setCanvasDimension_CSS",value:function(e){this.canvas.setDimensions(e,{cssOnly:!0})}},{key:"setCanvasDimension_Backstore",value:function(e){this.canvas.setDimensions(e,{backstoreOnly:!0})}},{key:"AddObject",value:function(e,t){var n=1<arguments.length&&void 0!==t&&t;this.objectsManager.Add(e,n)}},{key:"DeleteSelectedObject",value:function(){this.objectsManager.RemoveSelectedObject()}},{key:"ResetToImage",value:function(e){this.resetManager.Reset(e)}},{key:"FreezeCanvasEditing",value:function(){this.domCanvas.style.opacity=.4}},{key:"ResumeCanvasEditing",value:function(){this.domCanvas.style.opacity=1}},{key:"Rotate",value:function(e){return this.rotateManager.Rotate(e)}},{key:"Flip",value:function(e){return this.flipManager.Flip(e)}},{key:"Frame",value:function(e,t){return this.frameManager.Frame(e,t)}},{key:"Crop",value:function(e){return this.cropManager.Crop(e)}},{key:"Undo",value:function(){var e=this.historyManager.Undo();return this._manageHistory("undo",e)}},{key:"Redo",value:function(){var e=this.historyManager.Redo();return this._manageHistory("redo",e)}},{key:"_manageHistory",value:function(e,t){var n=void 0;return null!=t?"crop"==t.action?n=this.cropManager.ManageHistory(e,t.params):"frame"==t.action?n=this.frameManager.ManageHistory(e,t.params):"flip"==t.action?n=this.flipManager.ManageHistory(e,t.params):"rotate"==t.action?n=this.rotateManager.ManageHistory(e,t.params):"object"==t.action?n=this.objectsManager.ManageHistory(e,t.params):"filters"==t.action?n=this.filtersManager.ManageHistory(e,t.params):"reset"==t.action&&(n=this.resetManager.ManageHistory(e,t.params)):n=Promise.resolve(),n}},{key:"PushToHistory",value:function(e,t){var n={action:e,params:t};this.historyManager.Push(n)}},{key:"StartDrawing",value:function(e,t,n){this.SetDrawingParameters(e,t,n),this.drawManager.Start()}},{key:"SetDrawingParameters",value:function(e,t,n){this.drawManager.SetDrawingParameters(e,t,n)}},{key:"StopDrawing",value:function(){this.drawManager.Stop()}},{key:"SetTextParameters",value:function(e,t){this.textManager.SetTextParameters(e,t)}},{key:"StartAddText",value:function(){this.textManager.Start()}},{key:"StopAddText",value:function(){this.textManager.Stop()}},{key:"ApplyFilter",value:function(e,t){this.filtersManager.Apply(e,t)}}]),xe);function xe(e,t){var n=this;!function(e){if(!(e instanceof xe))throw new TypeError("Cannot call a class as a function")}(this),this.domCanvas=e,this.imgSrc=t,this.canvasImg=void 0,this.canvas=void 0,this.maxWPerc=.6,this.maxHPerc=.6,this.maxWindowWidth=parseInt(this.maxWPerc*window.innerWidth),this.maxWindowHeight=parseInt(this.maxHPerc*window.innerHeight),this.frameBorder=0,window.onresize=function(){n.maxWindowWidth=parseInt(n.maxWPerc*window.innerWidth),n.maxWindowHeight=parseInt(n.maxHPerc*window.innerHeight),n.AdjustToScreen()},this.historyManager=new L,this.objectsManager=new X(this),this.flipManager=new K(this),this.drawManager=new Q(this),this.cropManager=new ne(this),this.filtersManager=new re(this),this.frameManager=new le(this),this.rotateManager=new he(this),this.textManager=new pe(this),this.resetManager=new ve(this)}function we(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var Se=(we(_e.prototype,[{key:"Init",value:function(){var t=this;this.interfaceManager.ShowLoadingPanel();var e=this.interfaceManager.InitPanel();this.canvas=new Ce(e,this.imgSrc),this.canvas.InitCanvas().then(function(e){t.interfaceManager.HideLoadingPanel()},function(e){console.log(e)})}},{key:"Save",value:function(){this.interfaceManager.ShowLoadingPanel(),null!=this.SaveEditedImage&&this.SaveEditedImage(this.canvas.toDataURL({format:"png"})),this.Hide()}},{key:"ResetToOriginalImage",value:function(){this.canvas.ResetToImage(this.originSrc)}},{key:"DeleteSelectedObject",value:function(){this.canvas.DeleteSelectedObject()}},{key:"GetBoundingClientRect",value:function(){return this.canvas.GetBoundingClientRect()}},{key:"Hide",value:function(){this.shown=!1,this.interfaceManager.Destroy()}},{key:"FreezeCanvasEditing",value:function(){return this.canvas.FreezeCanvasEditing()}},{key:"ResumeCanvasEditing",value:function(){return this.canvas.ResumeCanvasEditing()}},{key:"Undo",value:function(){return this.canvas.Undo()}},{key:"Redo",value:function(){return this.canvas.Redo()}},{key:"Rotate",value:function(e){return this.canvas.Rotate(e)}},{key:"Flip",value:function(e){return this.canvas.Flip(e)}},{key:"Frame",value:function(e,t){return this.canvas.Frame(e,t)}},{key:"Crop",value:function(e){return this.canvas.Crop(e)}},{key:"StartDrawing",value:function(e,t,n){this.canvas.StartDrawing(e,t,n)}},{key:"SetDrawingParameters",value:function(e,t,n){this.canvas.SetDrawingParameters(e,t,n)}},{key:"StopDrawing",value:function(){this.canvas.StopDrawing()}},{key:"StartAddText",value:function(){this.canvas.StartAddText()}},{key:"SetTextParameters",value:function(e,t){this.canvas.SetTextParameters(e,t)}},{key:"StopAddText",value:function(){this.canvas.StopAddText()}},{key:"ApplyFilter",value:function(e,t){this.canvas.ApplyFilter(e,t)}}]),_e);function _e(e,t,n){!function(e){if(!(e instanceof _e))throw new TypeError("Cannot call a class as a function")}(this),this.imgSrc=e,this.originSrc=t,this.SaveEditedImage=n,this.interfaceManager=new R(this),this.Init()}}],o.c=r,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=9))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t);var O=n(0);function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var i=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(k,O.Plugin);var e,t,i,o,r=(i=k,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t,n=u(i);return!(t=o?(e=u(this).constructor,Reflect.construct(n,arguments,e)):n.apply(this,arguments))||"object"!==s(t)&&"function"!=typeof t?c(this):t});function k(e){var t;!function(e){if(!(e instanceof k))throw new TypeError("Cannot call a class as a function")}(this);var n,i=(t=r.call(this,e)).rootNode.domElement;return null==t.contextmenuFunction&&(n=c(t),t.contextmenuFunction=function(e){n.EditStartingNumber(),e.preventDefault(),e.stopPropagation()}),i.removeEventListener("contextmenu",t.contextmenuFunction),i.addEventListener("contextmenu",t.contextmenuFunction),t}return t=[{key:"CreateNew",value:function(i,e){"ordered"==e&&(e="numbered");var t="numbered",n=!1;null!=e&&("string"==typeof e?t=e:(t=e.type,n=e.isTab));var o,r,s,a="padding-left:40px;",l=i.GetStyleAtCurrentCursorPosition();null!=l.nodeStyle&&(null!=l.nodeStyle.fontColor&&(o=l.nodeStyle.fontColor,a=a+"color: "+o.on+";"),null!=l.nodeStyle.fontFamily&&(r=l.nodeStyle.fontFamily,a=a+"font-family: "+r.on+";"),null!=l.nodeStyle.fontSize&&(s=l.nodeStyle.fontSize,a=a+"font-size: "+s.on+";"));var c,u,h,d,f=i.GetSelectedLines(),p=!1,g=!1,m="";if(0<f.length&&(c=[],u=[],h=[],f.forEach(function(e){"ul"==e.tagName.toLowerCase()||"ol"==e.tagName.toLowerCase()?(m=e.tagName.toLowerCase(),p=!0,u.push(e)):"li"!=e.tagName.toLowerCase()||n?h.push(e):(p=g=!0,c.push(e))}),p?g?(f=[],d=c[0].parent,f.push(d),p=!(g=!1),m=d.tagName.toLowerCase()):f=u:f=h),!p){var v=i.GetCursorPosition(),y="ul";"numbered"==t&&(y="ol");var b=O.BlockNode.CreateNew(i,y);b.SetAttributes([{name:"style",value:a}]);var C,x,w=void 0,S=[];return f.forEach(function(e){w=e.parent;var t=O.BlockNode.CreateNew(i,"li");e.children.forEach(function(e){t.Append(e)}),b.Append(t),S.push(e.id)}),null!=w&&(C=w.children,w.children=[],x=!0,C.forEach(function(e){S.indexOf(e.id)<0?w.Append(e):(x&&(w.Append(b),x=!1),i.DeleteNode(e,!0))})),i.GetNodeById(v.idStartNode).SetFocus(v.startOffset),new k(b)}var _=void 0;if("numbered"==t&&"ol"==m||"bulleted"==t&&"ul"==m){var E={},T=[];f.forEach(function(t){"ol"!=t.tagName.toLowerCase()&&"ul"!=t.tagName.toLowerCase()||(T.push(t),E[t.id]=[],t.children.forEach(function(e){"li"==e.tagName.toLowerCase()&&(e.ChangeTagName("div"),E[t.id].push(e))}))}),T.forEach(function(e){var t,n;null!=e&&(t=e.parent,E[(n=e).id].forEach(function(e){t.AppendAfter(n,e),_=n=e}),i.RemovePluginInstance(e.id),i.DeleteNode(e,!1,!1))}),null!=_&&_.GetFirstTextNode().SetFocus()}else if(f.forEach(function(e){"ul"==(_=e).tagName.toLowerCase()?e.ChangeTagName("ol"):e.ChangeTagName("ul"),e.SetAttributes([{name:"style",value:a}])}),null!=_)return new k(_)}},{key:"GetName",value:function(){return"lists"}},{key:"GetTagToParseOnPaste",value:function(){return["ul","ol"]}},{key:"CreateNewFromPastedNode",value:function(i,e){var t="ul";"ol"==e.tagName.toLowerCase()&&(t="ol");var n="margin-left:40px;list-style-position: inside;",o=i.GetStyleAtCurrentCursorPosition();null!=o.nodeStyle&&(null!=o.nodeStyle.fontColor&&(n=n+"color: "+o.nodeStyle.fontColor.on+";"),null!=o.nodeStyle.fontFamily&&(n=n+"font-family: "+o.nodeStyle.fontFamily.on+";"));var r=O.BlockNode.CreateNew(i,t);r.SetAttributes([{name:"style",value:n}]);var s=[].slice.call(e.getElementsByTagName("li"));return null!=s&&s.forEach(function(e){var t=O.BlockNode.CreateNew(i,"li"),n=O.TextNode.CreateNew(i,"span",e.textContent.toString(),i.GetDefaultNodeStyle().Copy());t.Append(n),r.Append(t)}),new k(r)}}],a((e=k).prototype,[{key:"EditStartingNumber",value:function(){var n,i,e,t,o,r;"ol"==this.rootNode.tagName.toLowerCase()&&(n=this,(i=document.createElement("div")).style.backgroundColor="rgba(0,0,0,0.2)",i.style.width="100%",i.style.height="100%",i.style.position="absolute",i.style.left="0px",i.style.top="0px",i.style.overflow="auto",i.style.zIndex="999",i.style.display="flex",i.style.justifyContent="center",i.style.alignItems="center",(e=document.createElement("div")).style.backgroundColor="#282d36",e.style.borderRadius="10px",e.style.color="#ffffff",e.style.width="200px",e.style.height="100px",e.style.display="flex",e.style.justifyContent="start",e.style.alignItems="center",(t=document.createElement("div")).textContent="Start from:",t.style.fontSize="16px",t.style.padding="0px 10px 0px 20px",e.appendChild(t),o=document.createElement("div"),(r=document.createElement("input")).style.border="none",r.style.width="50px",r.style.padding="4px",r.style.borderRadius="4px",r.style.outline="none",o.appendChild(r),r.addEventListener("blur",function(){try{i.parentNode.removeChild(i)}catch(e){}}),r.addEventListener("keyup",function(e){var t=e.key;if("Enter"==t){""!=r.value&&n.rootNode.AddAttribute("start",r.value);try{i.parentNode.removeChild(i)}catch(e){}}else if("Esc"==t||"Escape"==t)try{i.parentNode.removeChild(i)}catch(e){}}),e.appendChild(o),i.appendChild(e),document.body.appendChild(i),r.focus())}},{key:"ManageDeleteTop",value:function(e){var t;null==e.parent.previous&&(t=e.parent,e.parent.parent.InsertEmptyBlockNodeBefore().Merge(e.parent,!0).SetFocus(),this.rootNode.document.DeleteNode(t),0==this.rootNode.children.length&&this.rootNode.document.DeleteNode(this.rootNode))}},{key:"ManageEnter",value:function(e){var t,n,i,o,r=!1;return null!=e&&null==e.parent.next&&(t=e.parent,n=!0,t.children.forEach(function(e){""!=e.text&&n&&(n=!1)}),n&&(r=!0,o="div",null!=(i=e.parent).parent.parent&&null!=i.parent.parent.GetPluginType()&&"lists"==i.parent.parent.GetPluginType()&&(o="li"),e.parent.parent.InsertEmptyBlockNodeAfter(o).Merge(e.parent,!0).SetFocus(),1==this.rootNode.children.length?this.rootNode.document.DeleteNode(this.rootNode):this.rootNode.document.DeleteNode(i))),r}},{key:"_getLastTextNode",value:function(e){var t=this,n=void 0;return e.children.forEach(function(e){e.isTextNode()&&(n=e),null!=e.children&&0<e.children.length&&(n=t._getLastTextNode(e))}),n}},{key:"_GetLastItem",value:function(){var t=this,n=void 0;return this.rootNode.children.forEach(function(e){n=t._getLastTextNode(e)}),n}},{key:"_getFirstTextNode",value:function(e){var t=this,n=void 0;return e.children.forEach(function(e){null==n&&e.isTextNode()&&(n=e),null==n&&null!=e.children&&0<e.children.length&&(n=t._getFirstTextNode(e))}),n}},{key:"_GetFirstItem",value:function(){var t=this,n=void 0;return this.rootNode.children.forEach(function(e){null==n&&(n=t._getFirstTextNode(e))}),n}},{key:"ManageDeleteFromBottom",value:function(){var e,t,n=this.rootNode.document.selectionManager.GetCurrent().startNode.parent;return n.isBlockNode()&&(e=this._GetLastItem(),t=e.parent,n.children.forEach(function(e){t.Append(e)}),this.rootNode.document.DeleteNode(n),e.SetCarretAtTheEnd()),!0}},{key:"ManageTab",value:function(e){var t={type:"numbered",isTab:!0};return"ul"==this.rootNode.tagName&&(t.type="bulleted"),e.InsertPluginAtSection("lists",t),!0}},{key:"ManageCancelFromTop",value:function(){var e,t,n=this.rootNode.document.selectionManager.GetCurrent().startNode.parent;return n.isBlockNode()&&((t=(e=this._GetFirstItem()).parent).children.forEach(function(e){n.Append(e)}),this.rootNode.document.DeleteNode(t),e.SetFocus()),!0}},{key:"ManageCancelFrombottom",value:function(e){var t,n;return null!=this.rootNode.next&&(!(t=this.rootNode.next).isBlockNode()||null!=t.GetPluginType()&&""!=t.GetPluginType()||(n=e.parent,t.children.forEach(function(e){n.Append(e)}),this.rootNode.document.DeleteNode(t),e.SetCarretAtTheEnd())),!0}},{key:"Fire",value:function(e,t,n){var i=!1;switch(e){case O.PluginActions.DELETE_TOP:i=this.ManageDeleteTop(t);break;case O.PluginActions.DELETE_FROM_BOTTOM:i=this.ManageDeleteFromBottom(t);break;case O.PluginActions.CANCEL_FROM_TOP:i=this.ManageCancelFromTop();break;case O.PluginActions.CANCEL_FROM_BOTTOM:i=this.ManageCancelFrombottom(t);break;case O.PluginActions.ENTER:i=this.ManageEnter(t);break;case O.PluginActions.TAB:i=this.ManageTab(n);break;case O.PluginActions.CLICK:break;default:return}return i}}]),a(e,t),k}();t.default=i}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t),n.d(t,"default",function(){return b});var p=n(0);function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}var r=(o(c,[{key:"draw",value:function(){this.build()}},{key:"build",value:function(){var e=this.context.createLinearGradient(0,0,this.width,0);e.addColorStop(0,"rgb(255, 0, 0)"),e.addColorStop(.15,"rgb(255, 0, 255)"),e.addColorStop(.33,"rgb(0, 0, 255)"),e.addColorStop(.49,"rgb(0, 255, 255)"),e.addColorStop(.67,"rgb(0, 255, 0)"),e.addColorStop(.84,"rgb(255, 255, 0)"),e.addColorStop(1,"rgb(255, 0, 0)"),this.context.fillStyle=e,this.context.fillRect(0,0,this.width,this.height),(e=this.context.createLinearGradient(0,0,0,this.height)).addColorStop(0,"rgba(255, 255, 255, 1)"),e.addColorStop(.5,"rgba(255, 255, 255, 0)"),e.addColorStop(.5,"rgba(0, 0, 0, 0)"),e.addColorStop(1,"rgba(0, 0, 0, 1)"),this.context.fillStyle=e,this.context.fillRect(0,0,this.width,this.height),this.context.beginPath(),this.context.arc(this.pickerCircle.x,this.pickerCircle.y,this.pickerCircle.width,0,2*Math.PI),this.context.strokeStyle="#ffffff",this.context.stroke(),this.context.closePath()}},{key:"listenForEvents",value:function(){var o=this;this.canvas.addEventListener("mousemove",function(e){var t=o.canvas.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top;o.pickerCircle.x=n,o.pickerCircle.y=i,o.previewbox.style.backgroundColor=o.getPickedColor(),o.draw()}),this.canvas.addEventListener("click",function(){return o.SelectColor()})}},{key:"getPickedColor",value:function(){var e=this.context.getImageData(this.pickerCircle.x,this.pickerCircle.y,1,1);return"#"+this.fullColorHex(e.data[0],e.data[1],e.data[2])}},{key:"SelectColor",value:function(){try{this.panel.parentNode.removeChild(this.panel)}catch(e){}this.onChangeCallback(this.getPickedColor())}},{key:"rgbToHex",value:function(e){var t=Number(e).toString(16);return t.length<2&&(t="0"+t),t}},{key:"fullColorHex",value:function(e,t,n){return this.rgbToHex(e)+this.rgbToHex(t)+this.rgbToHex(n)}}]),c),s=(o(l,[{key:"_parseSelectedColor",value:function(e){var t,n=e;return null!=e&&-1<e.toLowerCase().indexOf("rgb")&&(t=(e=e.toLowerCase()).split("(")[1].split(")")[0].split(","),n="#"+this._rgbToHex(t[0].split(" ").join(""))+this._rgbToHex(t[1].split(" ").join(""))+this._rgbToHex(t[2].split(" ").join(""))),n}},{key:"_rgbToHex",value:function(e){var t=Number(e).toString(16);return t.length<2&&(t="0"+t),t}},{key:"_showColorPalette",value:function(){var n=this,i=document.createElement("div");i.style.position="absolute",i.style.zIndex="99999",i.style.border="1px solid #e1e1e1",i.style.borderRadius="2px",i.style.backgroundColor="#f9f9f9",i.style.padding="4px 4px 0px 0px",i.style.outline="none",i.setAttribute("tabindex","123");var e=this.event.srcElement.getBoundingClientRect();i.style.left=e.left+parseInt(this.addToLeft)+"px",i.style.top=parseInt(this.addToTop)+ +window.scrollY+e.height+e.top+"px";var t=[];t.push(["#dfb9b1","#eecdcd","#f8e5d0","#fdf2d0","#dce9d5","#d3dfe2","#ccdaf5","#d2e1f1","#d8d2e7","#e6d2db"]),t.push(["#d08270","#de9c9b","#f2cca2","#fbe5a3","#bcd5ac","#a9c3c8","#a9c2f0","#a6c4e5","#b2a8d2","#cea8bc"]),t.push(["#bd4b31","#d16d6a","#ecb476","#ffefa1","#9dc284","#80a4ad","#779ee5","#7ba7d7","#8b7ebe","#b87f9e"]),t.push(["#982a15","#bb261a","#da944b","#eac251","#78a55a","#53808c","#4a79d1","#4f85c1","#6351a2","#9b5378"]),t.push(["#7a2817","#8c1a11","#a96324","#b89130","#48742c","#264e5b","#2657c5","#24538f","#312071","#6b2346"]);var o=document.createElement("div");o.style.display="flex",o.style.marginTop="2px",o.style.marginBottom="6px",["#000000","#39434d","#666666","#999999","#b7b7b7","#cccccc","#d9d9d9","#efefef","#ffffff","TRANSPARENT"].forEach(function(e){var t=n._getDomCell_colorPicker(e,i);o.appendChild(t)}),i.appendChild(o),t.forEach(function(e){(o=document.createElement("div")).style.display="flex",e.forEach(function(e){var t=n._getDomCell_colorPicker(e,i);o.appendChild(t)}),i.appendChild(o)});var r,s=document.createElement("div");s.style.display="flex",s.style.justifyContent="center",s.style.alignItems="center",s.style.cursor="pointer",s.style.fontFamily="Arial",s.style.padding="2px 4px 2px 4px",s.style.fontSize="14px",s.style.color="#999999",s.textContent="Custom",s.addEventListener("mouseover",function(){this.style.color="#30b7e8"}),s.addEventListener("mouseout",function(){this.style.color="#999999"}),s.addEventListener("click",function(){n.pnl.style.display="none",n.ShowCustomPanel()}),i.appendChild(s),0<this.usedCustomColors.length?((r=document.createElement("div")).style.display="flex",r.style.marginTop="2px",r.style.marginBottom="0px",this.usedCustomColors.forEach(function(e){var t=n._getDomCell_colorPicker(e,i);r.appendChild(t)}),i.appendChild(r)):s.style.padding="2px 4px 4px 4px",i.addEventListener("blur",function(){n.keepOnAfterSelection||this.parentNode.removeChild(this)}),document.body.appendChild(i),i.focus(),this.pnl=i}},{key:"_getDomCell_colorPicker",value:function(e){var t,n=this,i=e,o=this.selectedColor,r=void 0;return"TRANSPARENT"==e?((r=document.createElement("canvas")).width=13,r.height=13,r.style.border="2px solid #ffffff",r.style.margin="0px 0px 4px 4px ",r.style.borderRadius="2px",(t=r.getContext("2d")).fillStyle="#ffffff",t.fillRect(0,0,r.width,r.height),t.strokeStyle="#FF0000",t.lineWidth=2,t.beginPath(),t.moveTo(0,13),t.lineTo(13,0),t.stroke()):((r=document.createElement("div")).style.width="13px",r.style.height="13px",r.style.backgroundColor=i,r.style.margin="0px 0px 4px 4px ",r.style.borderRadius="2px",r.style.border=o==i?"2px solid #30b7e8":"2px solid "+i),r.addEventListener("mouseover",function(){this.style.cursor="pointer",this.style.border="2px solid #30b7e8"}),r.addEventListener("mouseout",function(){this.style.border=i!=o?"TRANSPARENT"==i?"2px solid #ffffff":"2px solid "+i:"2px solid #30b7e8"}),r.addEventListener("click",function(){if(n.callBack(i),!n.keepOnAfterSelection)try{n.pnl.parentNode.removeChild(n.pnl)}catch(e){}}),this.preserveFocus&&r.addEventListener("mousedown",function(e){e.preventDefault()}),r}},{key:"ShowCustomPanel",value:function(){var t=this;new r(this.pnl.style.left,this.pnl.style.top,function(e){t.usedCustomColors.indexOf(e)<0&&(t.usedCustomColors.push(e),10<t.usedCustomColors.length&&t.usedCustomColors.shift(),localStorage.setItem("usedCustomColors",JSON.stringify(t.usedCustomColors))),t.callBack(e),null===t.pnl.parentNode||t.pnl.parentNode.removeChild(t.pnl)})}}]),l);function l(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,o=4<arguments.length&&void 0!==arguments[4]?arguments[4]:void 0,r=5<arguments.length&&void 0!==arguments[5]&&arguments[5],s=6<arguments.length&&void 0!==arguments[6]&&arguments[6];a(this,l),this.event=e,this.callBack=t,this.preserveFocus=s,this.keepOnAfterSelection=r,this.addToLeft=n,this.addToTop=i,this.selectedColor=this._parseSelectedColor(o),this.usedCustomColors=[],"undefined"!=typeof Storage&&(this.usedCustomColors=JSON.parse(localStorage.getItem("usedCustomColors")),null==this.usedCustomColors&&(this.usedCustomColors=[])),this._showColorPalette()}function c(e,t,n){a(this,c),this.onChangeCallback=n;var i=document.createElement("div");i.style.position="absolute",i.style.zIndex="99999",i.style.border="1px solid #e1e1e1",i.style.borderRadius="2px",i.style.backgroundColor="#f9f9f9",i.style.padding="4px",i.style.left=e,i.style.top=t,i.style.outline="none",i.setAttribute("tabindex","3333"),i.addEventListener("blur",function(){this.parentNode.removeChild(this)}),this.canvas=document.createElement("canvas"),this.width=200,this.height=140,this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.style.cursor="pointer",this.context=this.canvas.getContext("2d"),this.pickerCircle={x:10,y:10,width:7,height:7},this.draw(),i.appendChild(this.canvas),this.previewbox=document.createElement("div"),this.previewbox.style.width="200px",this.previewbox.style.height="14px",this.previewbox.style.backgroundColor="rgba(0,0,0,0)",i.appendChild(this.previewbox),this.listenForEvents(),document.body.appendChild(i),i.focus(),this.panel=i}function u(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var h=(u(d.prototype,[{key:"Init",value:function(){var e=this,t=document.createElement("div");t.style.backgroundColor="#ffffff",t.style.width="180px",t.style.height="264px",t.style.borderRadius="2px",t.style.boxShadow="2px 2px 5px #e3e3e3",t.style.position="fixed";var n=this.event.clientX+4,i=this.event.clientY-60;i<0&&(i=1),i+264>window.innerHeight&&(i=window.innerHeight-266),t.style.left=n+"px",t.style.top=i+"px",t.style.overflow="auto",t.style.zIndex="999";var o=document.createElement("input");o.style.opacity=0,o.style.position="absolute",o.style.width="0px",o.style.height="0px",this.keepAlive=!1,o.addEventListener("blur",function(){e.exitingRightBorder||(e._removeRequestNumberPanel(),setTimeout(function(){e.keepAlive||e.destroy()},200))}),this.inputForFocus=o,t.appendChild(o);var r="";1<this.table.selectedNodes.length&&(r="s"),t=this._addMenuEntry(t,"addRowAbove","Insert Row(s) Above",!0),t=this._addMenuEntry(t,"addRowBelow","Insert Row(s) Below",!0),t=this._addMenuSpace(t),t=this._addMenuEntry(t,"addColLeft","Insert Column(s) Before",!0),t=this._addMenuEntry(t,"addColRight","Insert Column(s) After",!0),t=this._addMenuSpace(t),t=this._addMenuEntry(t,"delRow","Delete Row"+r),t=this._addMenuEntry(t,"delCol","Delete Column"+r),t=this._addMenuSpace(t),t=this._addMenuEntry(t,"cellBgColor","Background Color"),t=this._addMenuEntry(t,"borderColor","Border Color"),t=this._addMenuSpace(t),t=this._addMenuEntry(t,"distributeRows","Distribute Rows"),t=this._addMenuEntry(t,"distributeCols","Distribute Columns"),document.body.appendChild(t),o.focus(),this.panel=t}},{key:"refreshFocus",value:function(){this.inputForFocus.focus()}},{key:"_addMenuEntry",value:function(e,t,n,i){var o=3<arguments.length&&void 0!==i&&i,r=this,s=document.createElement("div");return s.style.padding="6px 10px 6px 10px",s.style.fontFamily="Arial",s.style.fontSize="12px",s.style.margin="0px",s.style.cursor="pointer",s.style.backgroundColor="#ffffff",s.style.color="#828282",s.innerText=n,o?(s.addEventListener("mouseover",function(e){r.refreshFocus(),r._removeRequestNumberPanel(),this.style.backgroundColor="#FF9100",this.style.color="#ffffff",r._showRequestNumber(this,t),r.exitingRightBorder=!1}),s.addEventListener("mousemove",function(e){var t=this.getBoundingClientRect(),n=t.width,i=t.width-4;e.offsetX>=i&&e.offsetX<=n&&(r.exitingRightBorder=!0)})):(s.addEventListener("mouseover",function(e){r.exitingRightBorder=!1,this.style.backgroundColor="#FF9100",this.style.color="#ffffff"}),s.addEventListener("click",function(e){r.PerformAction(t)})),s.addEventListener("mouseout",function(e){r.exitingRightBorder||r._removeRequestNumberPanel(),this.style.backgroundColor="#ffffff",this.style.color="#828282"}),e.appendChild(s),e}},{key:"_addMenuSpace",value:function(e){var t=document.createElement("div");return t.style.height="1px",t.style.backgroundColor="#e3e3e3",e.appendChild(t),e}},{key:"_showRequestNumber",value:function(e,t){var n=this,i="Rows:";-1<t.indexOf("Col")&&(i="Cols:");var o=e.getBoundingClientRect(),r=document.createElement("div");r.style.backgroundColor="#ffffff",r.style.height=o.height+"px",r.style.borderRadius="0px 2px 2px 0px",r.style.boxShadow="2px 2px 5px #e3e3e3",r.style.display="flex",r.style.alignItems="center",r.style.zIndex="9999",r.style.fontFamily="Arial",r.style.fontSize="12px",r.style.color="#828282",r.style.position="fixed",r.style.top=o.top+"px",r.style.left=o.left+o.width+"px";var s=document.createElement("div");s.style.padding="0px 4px 0px 4px",s.textContent=i,r.appendChild(s);var a=document.createElement("input");a.style.display="block",a.style.width="40px",a.style.outline="none",a.style.border="1px solid #e1e1e1",a.style.borderRadius="3px",a.style.color="#828282",a.style.fontFamily="Arial",a.style.fontSize="12px",a.value=1,a.addEventListener("click",function(e){this.select()}),r.appendChild(a);var l=document.createElement("div");l.style.padding="0px 4px 0px 4px",l.style.cursor="pointer",l.style.fontWeight="bold",l.style.color="#30b7e8",l.textContent="add",l.addEventListener("click",function(e){n.PerformAction(t,a.value),n._removeRequestNumberPanel(),n.destroy()}),l.addEventListener("mouseover",function(e){this.style.color="#FF9100"}),l.addEventListener("mouseout",function(e){this.style.color="#30b7e8"}),r.appendChild(l),document.body.appendChild(r),this.additionalPnl=r}},{key:"_removeRequestNumberPanel",value:function(){null!=this.additionalPnl&&null!=this.additionalPnl.parentNode&&this.additionalPnl.parentNode.removeChild(this.additionalPnl)}},{key:"destroy",value:function(){this._removeRequestNumberPanel(),null!=this.panel.parentNode&&this.panel.parentNode.removeChild(this.panel)}},{key:"PerformAction",value:function(e,t){if(0<this.table.selectedNodes.length){var n=this.table.selectedNodes.length-1;switch(e){case"addRowAbove":if(0<t){for(;0<t;)this.AddRow("above",this.table.selectedNodes[0].parent),t--;this.table.rootNode.document.PushToHistory()}break;case"addRowBelow":if(0<t){for(;0<t;)this.AddRow("below",this.table.selectedNodes[n].parent),t--;this.table.rootNode.document.PushToHistory()}break;case"addColLeft":if(0<t){for(;0<t;)this.AddColumn("left",this.table.selectedNodes[0]),t--;this.table.rootNode.document.PushToHistory()}break;case"addColRight":if(0<t){for(;0<t;)this.AddColumn("right",this.table.selectedNodes[n]),t--;this.table.rootNode.document.PushToHistory()}break;case"delRow":this.DeleteRows(),this.table.rootNode.document.PushToHistory();break;case"delCol":this.DeleteColumns(),this.table.rootNode.document.PushToHistory();break;case"cellBgColor":this.ShowPicColorPanel();break;case"borderColor":this.ShowPicBorderColorPanel();break;case"distributeRows":this.DistributeRows(),this.table.rootNode.document.PushToHistory();break;case"distributeCols":this.DistributeCols(),this.table.rootNode.document.PushToHistory();break;case"fitToScreen":this.FitToScreen(),this.table.rootNode.document.PushToHistory();break;case"mergeCells":this.MergeCells(),this.table.rootNode.document.PushToHistory();break;default:return}}}},{key:"MergeCells",value:function(){var i=this,o=[],r=!0,s=void 0,a=void 0,n=this.table.rootNode.document,l=void 0,c=1,u=1;this.table.selectedNodes.forEach(function(e){var t=e.GetAttribute("colspan"),n=e.GetAttribute("rowspan");null!=t&&""!=t&&(c=c+t-1),null!=n&&""!=n&&(u=u+n-1),r?(l=e,s=i.table.GetCoordinatesPerNode(e.id),r=!1):(o.push(e.id),a=i.table.GetCoordinatesPerNode(e.id))});var e=a.col-s.col+c,t=a.row-s.row+u;1<e&&(l.RemoveAttribute("colspan"),l.AddAttribute("colspan",e)),1<t&&(l.RemoveAttribute("rowspan"),l.AddAttribute("rowspan",t)),this.table.rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){var t=[];e.children.forEach(function(e){o.indexOf(e.id)<0?t.push(e):n.DeleteNode(e)}),0<t.length||n.DeleteNode(e)})}),this.table.Init()}},{key:"ShowPicBorderColorPanel",value:function(){this.HideButKeepAlive();var t=this;new s(this.event,function(e){t.ChangBorderColor(e)},-20,6)}},{key:"ChangBorderColor",value:function(t){this.table.selectedNodes.forEach(function(e){e.domElement.style.border="1px double "+t}),this.table.rootNode.document.PushToHistory()}},{key:"DistributeRows",value:function(){this.table.rootNode.document;var i=this.table.rootNode.domElement.getBoundingClientRect().height;this.table.rootNode.children.forEach(function(e){var t,n;"tbody"==e.tagName.toLowerCase()&&(t=e.children.length,n=i/t,e.children.forEach(function(e){e.children.forEach(function(e){e.domElement.style.height=n+"px"})}))})}},{key:"DistributeCols",value:function(){this.table.rootNode.document;var o=this.table.rootNode.domElement.getBoundingClientRect().width;this.table.rootNode.children.forEach(function(e){var n,i;"tbody"==e.tagName.toLowerCase()&&(n=!0,i=void 0,e.children.forEach(function(e){var t;n&&(n=!1,t=e.children.length,i=o/t),e.children.forEach(function(e){e.domElement.style.width=i+"px"})}))})}},{key:"FitToScreen",value:function(){this.table.rootNode.domElement.style.width="100%"}},{key:"HideButKeepAlive",value:function(){this.keepAlive=!0,this.panel.style.display="none"}},{key:"ShowPicColorPanel",value:function(){this.HideButKeepAlive();var t=this;new s(this.event,function(e){t.ChangCellBgColor(e)},-20,6)}},{key:"ChangCellBgColor",value:function(t){this.table.selectedNodes.forEach(function(e){e.domElement.style.backgroundColor=t}),this.table.rootNode.document.PushToHistory()}},{key:"DeleteRows",value:function(){var i=[];this.table.selectedNodes.forEach(function(e){i.indexOf(e.parent.id)<0&&i.push(e.parent.id)});var o=this.table.rootNode.document;this.table.rootNode.children.forEach(function(t){var n;"tbody"==t.tagName.toLowerCase()&&(n=[],t.children.forEach(function(e){i.indexOf(e.id)<0?n.push(e):o.DeleteNode(e)}),t.children=[],n.forEach(function(e){t.Append(e)}))}),this.table.Init()}},{key:"DeleteColumns",value:function(){var n=[];this.table.selectedNodes.forEach(function(e){n.push(e.id)});var i=[];this.table.rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){var t=0;e.children.forEach(function(e){n.indexOf(e.id)<0||n.indexOf(t)<0&&i.push(parseInt(t)),t++})})});var o=this.table.rootNode.document;this.table.rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){var t=0;e.children.forEach(function(e){i.indexOf(t)<0||o.DeleteNode(e),t++})})}),this.table.Init()}},{key:"AddRow",value:function(i,o){var r=b.AddRow(o.document,this.table.numberOfColumns,o.GetFirstTextNode().nodeStyle).tr;this.table.rootNode.children.forEach(function(t){var n;"tbody"==t.tagName.toLowerCase()&&(n=[],t.children.forEach(function(e){e.id==o.id?"above"==i?(n.push(r),n.push(e)):"below"==i&&(n.push(e),n.push(r)):n.push(e)}),t.children=[],n.forEach(function(e){t.Append(e)}))}),this.table.Init()}},{key:"AddColumn",value:function(i,r){var s=r.GetFirstTextNode().nodeStyle,a=void 0,l=!1;this.table.rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(t){var n=0;t.children.forEach(function(e){e.id==r.id&&("left"==i?a=parseInt(n):"right"==i&&(a=parseInt(n+1)),a==t.children.length&&(l=!0)),n++})})}),this.table.rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(i){var o=0;i.children.forEach(function(e){var t,n=!1;(a==o||l&&o==i.children.length-1)&&(n=!0),n&&(t=b.AddCell(r.document,s).td,i.Append(t,a)),o++})})}),this.table.Init()}}]),d);function d(e,t,n){!function(e){if(!(e instanceof d))throw new TypeError("Cannot call a class as a function")}(this),this.table=e,this.td=t,this.event=n,this.additionalPnl=void 0,this.inputForFocus=void 0,this.Init()}function g(e){return(g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function f(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function m(e,t,n){return t&&f(e.prototype,t),n&&f(e,n),e}function v(e,t){return(v=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function y(e){return(y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var b=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&v(e,t)}(f,p.Plugin);var o,r,n=(o=f,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t,n=y(o),i=this;return!(t=r?(e=y(this).constructor,Reflect.construct(n,arguments,e)):n.apply(this,arguments))||"object"!==g(t)&&"function"!=typeof t?function(){if(void 0!==i)return i;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function f(e){var t;return function(e){if(!(e instanceof f))throw new TypeError("Cannot call a class as a function")}(this),(t=n.call(this,e)).isMouseDown=!1,t.isMouseOnRightBorder=!1,t.isMouseOnBottomBorder=!1,t.currentColResizing=void 0,t.currentRowResizing=void 0,t.startNode=void 0,t.endNode=void 0,t.selectedNodes=[],t.numberOfRows=0,t.numberOfColumns=0,t.cellsResized=!1,t.readOnly=t.rootNode.document.readOnly,t.InitializeDomElements(),t}return m(f,null,[{key:"GetName",value:function(){return"table"}}]),m(f,[{key:"InitializeDomElements",value:function(e){var t;null==this.rootNode.parent?(t=this,null==e?e=0:e++,e<50?setTimeout(function(){t.InitializeDomElements(e)},100):console.log("#345-23")):this.readOnly||this.Init()}},{key:"Init",value:function(){var t=this;function e(e){t.isMouseDown&&(t.isMouseOnRightBorder?t.ResizeColumn(e):t.isMouseOnBottomBorder&&t.ResizeRow(e))}this.coordinatesPerNode=new Array,this.nodePerCoordinates=new Array;var n=0,i=0;function o(e){0==e.button&&(t.isMouseDown=!1)}this.rootNode.parent.domElement.removeEventListener("mousemove",e),this.rootNode.parent.domElement.addEventListener("mousemove",e),this.rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){i=0,e.children.forEach(function(e){t.InitCell(e.domElement,n,i),null==t.coordinatesPerNode[n]&&(t.coordinatesPerNode[n]=new Array),t.coordinatesPerNode[n][i]=e,t.nodePerCoordinates[e.id]={col:i,row:n},i++}),n++})}),this.numberOfRows=n,this.numberOfColumns=i,document.body.removeEventListener("mouseup",o),document.body.addEventListener("mouseup",o)}},{key:"InitCell",value:function(e,p,g){function t(e){0==m.selectedNodes.length?m.SelectCell(p,g,!0):1==m.selectedNodes.length&&m.SelectCell(p,g,!1),m.OpenSettingsPanel(this,e),e.preventDefault(),e.stopPropagation()}function n(e){var t,n,i,o,r,s,a,l,c,u,h,d,f;0==e.button&&(m.isMouseDown?m.isMouseOnRightBorder||m.isMouseOnBottomBorder||(n=(t=m.startNode.domElement.getBoundingClientRect()).height,i=t.width,o=t.top,r=t.left,s=e.pageY+window.scrollY,a=e.pageX+window.scrollX,o<s&&s<o+n&&r<a&&a<r+i||(window.getSelection&&document.createRange?(l=window.getSelection()).empty?l.empty():l.removeAllRanges&&l.removeAllRanges():document.selection&&(l=document.selection.createRange()).empty(),m.SelectOnDrag(p,g),e.preventDefault())):(u=(c=this.getBoundingClientRect()).width,h=c.width-6,e.offsetX>=h&&e.offsetX<=u?(m.isMouseOnRightBorder=!0,m.currentColResizing=g,this.style.cursor="col-resize"):(m.isMouseOnRightBorder=!1,m.currentColResizing=void 0,this.style.cursor="auto"),m.isMouseOnRightBorder||(d=c.height,f=c.height-6,e.offsetY>=f&&e.offsetY<=d?(m.isMouseOnBottomBorder=!0,m.currentRowResizing=p,this.style.cursor="row-resize"):(m.isMouseOnBottomBorder=!1,m.currentRowResizing=void 0,this.style.cursor="auto"))))}function i(e){0==e.button&&(m.cellsResized&&(m.cellsResized=!1,m.PushToHistory()),m.isMouseDown=!1,m.endNode=m.GetNodeFromDom(this),m.endNode.row=p,m.endNode.col=g)}var m=this;e.removeEventListener("contextmenu",t),e.addEventListener("contextmenu",t),e.removeEventListener("mousedown",t),e.addEventListener("mousedown",function(e){m.prevX=e.pageX+window.scrollX,m.prevY=e.pageY+window.scrollY,0==e.button&&(m.DeselectAll(),m.isMouseDown=!0,m.startNode=m.GetNodeFromDom(this),m.startNode.row=p,m.startNode.col=g,m.endNode=void 0,m.SelectCell(p,g,!1))}),e.removeEventListener("mousemove",n),e.addEventListener("mousemove",n),e.removeEventListener("mouseup",i),e.addEventListener("mouseup",i)}},{key:"PushToHistory",value:function(){this.rootNode.document.PushToHistory()}},{key:"GetCoordinatesPerNode",value:function(e){return this.nodePerCoordinates[e]}},{key:"GetNodePerCoordinates",value:function(e,t){return this.coordinatesPerNode[e][t]}},{key:"GetTableDimensions",value:function(){var e={cols:0,rows:0},t=0,n=0;return this.rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){0==t&&e.children.forEach(function(e){t++}),n++})}),e.cols=t,e.rows=n,e}},{key:"ResizeRow",value:function(o){var e,t,r,s,a;null!=this.currentRowResizing&&(window.getSelection&&document.createRange?(e=window.getSelection()).empty?e.empty():e.removeAllRanges&&e.removeAllRanges():document.selection&&(e=document.selection.createRange()).empty(),s=!(t=0),a=0,(r=this).rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&(t=0,e.children.forEach(function(e){t==r.currentRowResizing&&e.children.forEach(function(e){var t,n,i;s&&(t=e.domElement.getBoundingClientRect(),i=(n=o.pageY)-r.prevY,a=t.height+i,r.prevY=n,s=!1),e.domElement.style.height=a+"px",r.cellsResized=!0}),t++}))}))}},{key:"ResizeColumn",value:function(r){var e,s,a,l,c,u,h;null!=this.currentColResizing&&(window.getSelection&&document.createRange?(e=window.getSelection()).empty?e.empty():e.removeAllRanges&&e.removeAllRanges():document.selection&&(e=document.selection.createRange()).empty(),u=c=s=0,h=!(l=!0),(a=this).rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){s=0,e.children.forEach(function(e){var t,n,i,o;s==a.currentColResizing&&(l&&(t=e.domElement.getBoundingClientRect(),i=(n=r.pageX+window.scrollX)-a.prevX,c=t.width+i,a.prevX=n,null!=e.next&&(h=!0,o=e.next.domElement.getBoundingClientRect(),u=o.width-i),l=!1),e.domElement.style.width=c+"px",h&&null!=e.next&&(e.next.domElement.style.width=u+"px"),a.cellsResized=!0),s++})})}))}},{key:"SelectCell",value:function(t,n,e){null!=e&&0!=e||this.DeselectAll();var i=0,o=0,r=this;this.rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){o=0,e.children.forEach(function(e){i==t&&o==n&&(e.domElement.className="commaTableCellSelected",r.selectedNodes.push(e)),o++}),i++})})}},{key:"DeselectAll",value:function(){this.selectedNodes=[],null!=this.rootNode&&this.rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){e.children.forEach(function(e){e.domElement.className="commaTableCell"})})})}},{key:"SelectOnDrag",value:function(t,n){var i,o,r,s,a,l,e=0,c=null==this.endNode?(e=this.startNode.row,this.startNode.col):(e=this.endNode.row,this.endNode.col);e==t&&c==n||(this.DeselectAll(),i=this.startNode.row,o=this.startNode.col,r=i<=t&&o<=n?"right":t<=i&&o<n?"topRight":i<=t&&n<=o?"bottomLeft":"left",a=s=0,(l=this).rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){a=0,e.children.forEach(function(e){"right"==r?i<=s&&s<=t&&o<=a&&a<=n&&l.SelectCell(s,a,!0):"left"==r?t<=s&&s<=i&&n<=a&&a<=o&&l.SelectCell(s,a,!0):"topRight"==r?s<=i&&t<=s&&o<=a&&a<=n&&l.SelectCell(s,a,!0):"bottomLeft"==r&&i<=s&&s<=t&&a<=o&&n<=a&&l.SelectCell(s,a,!0),a++}),s++})}))}},{key:"OpenSettingsPanel",value:function(e,t){this.CloseSettingsPanel(),this.cellSettingsPanel=new h(this,e,t)}},{key:"CloseSettingsPanel",value:function(){null!=this.cellSettingsPanel&&this.cellSettingsPanel.destroy()}},{key:"GetNodeFromDom",value:function(e){var t=e.getAttribute("cm-id");return this.rootNode.document.GetNodeById(t)}},{key:"ApplyStyleOnSelectedLines",value:function(t,n){this.selectedNodes.forEach(function(e){e.children.forEach(function(e){e.isBlockNode()&&e.ToggleStyle(t,n,!0)})})}},{key:"_applyToTextNodes",value:function(e,t,n){var i;e.isTextNode()&&e.ToggleStyle(t,n,!0),null!=e.children&&(i=this,e.children.forEach(function(e){i._applyToTextNodes(e,t,n)}))}},{key:"ApplyStyleOnSelectedCells",value:function(t,n){var i=this;this.selectedNodes.forEach(function(e){i._applyToTextNodes(e,t,n)})}},{key:"DeleteContentOfSelectedCells",value:function(e){var t=0<arguments.length&&void 0!==e&&e,n=this.rootNode.document,i=void 0;this.selectedNodes.forEach(function(e){var t;e.children[0].children.forEach(function(e){t=e.nodeStyle.Copy(),n.DeleteNode(e,!1,!0,t)}),i=e.GetFirstTextNode()}),t&&null!=i&&i.SetFocus()}},{key:"_fintTDContainer",value:function(e){return null!=e.parent?"td"==e.parent.tagName?e.parent:this._fintTDContainer(e.parent):void 0}},{key:"MoveToNextCell",value:function(){var e,t=this.rootNode.document.GetNodeAtCursor();!t.isTextNode()||null!=(e=this._fintTDContainer(t))&&(null!=e.next?e.next.GetFirstTextNode().SetFocus():null!=e.parent&&(null!=e.parent.next?e.parent.next.children[0].GetFirstTextNode().SetFocus():null!=this.rootNode.next&&this.rootNode.next.GetFirstTextNode().SetFocus()))}},{key:"SelectAll",value:function(){this.DeselectAll();var t=0,n=0,i=this;this.rootNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){n=0,e.children.forEach(function(e){i.SelectCell(t,n,!0),n++}),t++})})}},{key:"AddSelectedCellsToClipboard",value:function(e){var t=0<arguments.length&&void 0!==e&&e,n=this.rootNode.document,i=p.BlockNode.CreateNew(n,"table");i.SetAttributes([{name:"class",value:"commaTable"}]),i.SetPluginType(this.rootNode.GetPluginType());var o=p.BlockNode.CreateNew(n,"tbody"),r=this,s=void 0,a=void 0;this.selectedNodes.forEach(function(e){var t=r.GetCoordinatesPerNode(e.id);a!=t.row&&(null!=s&&o.Append(s),a=t.row,s=p.BlockNode.CreateNew(n,"tr")),s.Append(e.Copy())}),null!=s&&o.Append(s),i.Append(o),t&&this.DeleteContentOfSelectedCells(),this.rootNode.document.ForceClipboardContent(i.domElement)}},{key:"PasteCells",value:function(e){var t,n,i,o,r,s=!1,a=this,l=(new DOMParser).parseFromString(e,"text/html").body.firstElementChild;return null==l||null!=(t=[].slice.call(l.getElementsByTagName("tr")))&&0<t.length&&(s=!0,n=this.selectedNodes[0],i=this.GetCoordinatesPerNode(n.id),o=this.GetTableDimensions(),r=i.row,t.forEach(function(e){var n=i.col;[].slice.call(e.getElementsByTagName("td")).forEach(function(e){var t;r<o.rows&&n<o.cols&&null!=(t=a.GetNodePerCoordinates(r,n))&&t.GetFirstTextNode().ForceTextContent(e.textContent.toString()),n++}),r++})),s&&this.PushToHistory(),s}},{key:"Fire",value:function(e,t,n,i){var o=JSON.parse(JSON.stringify(e));e==p.PluginActions.NEW_CHAR_ADDED&&"Backspace"==i.key&&1<this.selectedNodes.length&&(o=p.PluginActions.DELETE);var r=!1;switch(o){case p.PluginActions.LOST_FOCUS:this.CloseSettingsPanel(),this.DeselectAll();break;case p.PluginActions.BEFORE_PASTE:var s=i.clipboardData.getData("text/html");null!=s&&""!=s||(s=i.clipboardData.getData("text")),r=this.PasteCells(s);break;case p.PluginActions.BEFORE_COPY:var a,l=!0;1==this.selectedNodes.length&&(this.rootNode.document.selectionManager.IsCollapsed()?l=!0:(a=this.selectedNodes[0].domElement.textContent,null!=window.getSelection()&&(l=window.getSelection().toString()==a))),l&&(this.AddSelectedCellsToClipboard(),r=!0);break;case p.PluginActions.BEFORE_CUT:var c,u=!0;1==this.selectedNodes.length&&(this.rootNode.document.selectionManager.IsCollapsed()?u=!0:(c=this.selectedNodes[0].domElement.textContent,null!=window.getSelection()&&(u=window.getSelection().toString()==c))),u&&(this.AddSelectedCellsToClipboard(!0),r=!0);break;case p.PluginActions.SELECT_ALL:1==this.selectedNodes.length&&this.selectedNodes[0].SelectWholeTextContent(),r=!0;break;case p.PluginActions.APPLY_STYLE_ON_LINE:null==t&&this.ApplyStyleOnSelectedLines(i.styleName,i.value);break;case p.PluginActions.APPLY_STYLE_ON_TEXT:null==t&&this.ApplyStyleOnSelectedCells(i.styleName,i.value);break;case p.PluginActions.DELETE:this.DeleteContentOfSelectedCells(!0),r=!0;break;case p.PluginActions.CANCEL_FROM_TOP:r=!0;break;case p.PluginActions.DELETE_FROM_BOTTOM:this.rootNode.document.DeleteNode(this.rootNode),n.DeletePluginInstance(this),r=!1;break;case p.PluginActions.TAB:this.MoveToNextCell(),r=!0;break;default:return this.CloseSettingsPanel(),r}return r}}],[{key:"AddRow",value:function(e,t,n){null==n&&(n=new p.NodeStyle);for(var i=p.BlockNode.CreateNew(e,"tr"),o=0,r=void 0;o<t;){var s=f.AddCell(e,n);null==r&&(r=s.nodeForFocus),i.Append(s.td),o++}return{tr:i,nodeForFocus:r}}},{key:"AddCell",value:function(e,t){var n=p.BlockNode.CreateNew(e,"td");n.SetAttributes([{name:"class",value:"commaTableCell"}]);var i=p.BlockNode.CreateNew(e,"div"),o=p.TextNode.CreateNew(e,"span","",t.Copy());return i.Append(o),n.Append(i),{td:n,nodeForFocus:o}}},{key:"CreateNew",value:function(e,t){var n=e.GetStyleAtCurrentCursorPosition(),i=new p.NodeStyle(e,n.nodeStyle),o=e.GetNodeAtCursor().GetBlockContainer().InsertEmptyBlockNodeAfter("table");o.SetAttributes([{name:"class",value:"commaTable"}]);for(var r=p.BlockNode.CreateNew(e,"tbody"),s=t.rows,a=void 0,l=0;l<s;){var c=f.AddRow(e,t.cols,i);null==a&&(a=c.nodeForFocus),r.Append(c.tr),l++}o.Append(r);var u=o.InsertEmptyBlockNodeAfter("div"),h=p.TextNode.CreateNew(e,"span","",i.Copy());u.Append(h);var d=new f(o);return setTimeout(function(){a.SetFocus(),d.SelectCell(0,0)},100),d}},{key:"GetTagToParseOnPaste",value:function(){return["table"]}},{key:"CreateNewFromPastedNode",value:function(o,e){var t=p.BlockNode.CreateNew(o,"table");t.SetAttributes([{name:"class",value:"commaTable"}]);var n,r=p.BlockNode.CreateNew(o,"tbody");return null==e||null!=(n=[].slice.call(e.getElementsByTagName("tr")))&&n.forEach(function(e){var t=[].slice.call(e.getElementsByTagName("td"));0==t.length&&(t=[].slice.call(e.getElementsByTagName("th")));var n=f.AddRow(o,t.length,o.GetDefaultNodeStyle().Copy()).tr,i=0;t.forEach(function(e){n.children[i].GetFirstTextNode().ForceTextContent(e.textContent.toString()),i++}),r.Append(n)}),t.Append(r),new f(t)}}]),f}()}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t);var l=n(0);function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function c(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var o=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(a,l.Plugin);var o,r,t=(o=a,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t,n=h(o),i=this;return!(t=r?(e=h(this).constructor,Reflect.construct(n,arguments,e)):n.apply(this,arguments))||"object"!==s(t)&&"function"!=typeof t?function(){if(void 0!==i)return i;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function a(e){return function(e){if(!(e instanceof a))throw new TypeError("Cannot call a class as a function")}(this),t.call(this,e)}return c(a,null,[{key:"GetName",value:function(){return"horizontalRule"}}]),c(a,null,[{key:"CreateNew",value:function(e){var t=e.GetStyleAtCurrentCursorPosition();e.DeleteSelection();var n=e.GetNodeAtCursor().GetBlockContainer(),i=n.InsertEmptyBlockNodeAfter(n.tagName),o=l.TextNode.CreateNew(e,"span","",new l.NodeStyle(e,t.nodeStyle));i.Append(o),i.ToggleStyle("horizontalRule",void 0,!0);var r=new a(i),s=i.InsertEmptyBlockNodeAfter(n.tagName),o=l.TextNode.CreateNew(e,"span","",new l.NodeStyle(e,t.nodeStyle));return s.Append(o),s=s.InsertEmptyBlockNodeAfter(s.tagName),o=l.TextNode.CreateNew(e,"span","",new l.NodeStyle(e,t.nodeStyle)),s.Append(o),o.SetFocus(),r}}]),a}();t.default=o}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t),n.d(t,"default",function(){return o});var v=n(0);function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var o=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(s,v.Plugin);var o,r,n=(o=s,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t,n=u(o),i=this;return!(t=r?(e=u(this).constructor,Reflect.construct(n,arguments,e)):n.apply(this,arguments))||"object"!==a(t)&&"function"!=typeof t?function(){if(void 0!==i)return i;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function s(e){var t;return function(e){if(!(e instanceof s))throw new TypeError("Cannot call a class as a function")}(this),(t=n.call(this,e)).readOnly=t.rootNode.document.readOnly,t.InitializeDomElements(),t}return l(s,null,[{key:"GetName",value:function(){return"tasks"}}]),l(s,[{key:"InitializeDomElements",value:function(e){var t;null==this.rootNode.parent?(t=this,null==e?e=0:e++,e<50?setTimeout(function(){t.InitializeDomElements(e)},100):console.log("#345-23")):this.readOnly||this.Init()}},{key:"Init",value:function(){0==this.rootNode.children.length&&this.rootNode.document.DeleteNode(this.rootNode)}},{key:"ManageEnter",value:function(e,t){var n,i,o,r,s,a=!1;return""==e.text&&(a=this.isLineEmpty(e)),null==e.next&&a?(n=!1,i=[],null==e.previous.previous.previous?n=!0:(i.push(e.previous.previous.previous.id),e.previous.previous.previous.Delete()),i.push(e.previous.previous.id),e.previous.previous.Delete(),i.push(e.previous.id),e.previous.Delete(),i.push(e.id),e.Delete(),this.DeleteNodes(i),o=void 0,null==this.rootNode.next?(r=this.rootNode.InsertEmptyBlockNodeAfter("div"),s=v.TextNode.CreateNew(this.rootNode.document,"span","",e.nodeStyle.Copy()),r.Append(s),o=s):this.rootNode.next.children.forEach(function(e){null==o&&e.isTextNode()&&(o=e)}),n&&(this.rootNode.Delete(!0),t.DeletePluginInstance(this)),o.SetFocus()):this.rootNode.document.InsertPluginAtSection("tasks"),!0}},{key:"GetWholeLine",value:function(t){var n=[],i=!1,o=!1;return this.rootNode.children.forEach(function(e){"br"==e.tagName&&(o?i=!0:n=[]),i||n.push(e),e.id==t.id&&(o=!0)}),n}},{key:"isLineEmpty",value:function(t){var n=!1,i=!0;return this.rootNode.children.forEach(function(e){"br"==e.tagName?n||(i=!0):e.isTextNode()&&(""==e.text||n||(i=!1),e.id==t.id&&(n=!0))}),i}},{key:"DeleteNodes",value:function(t){var n=[];this.rootNode.children.forEach(function(e){t.indexOf(e.id)<0?n.push(e):null!=e.previous&&(e.previous.next=void 0)}),this.rootNode.children=n}},{key:"DeleteTask_onBackspace",value:function(e,t){var n,i,o,r,s,a,l,c,u,h,d,f,p,g,m;null!=e.previous.previous?(n=[],i=e.previous.previous.previous,n.push(e.previous.previous.id),e.previous.previous.Delete(),n.push(e.previous.id),e.previous.Delete(),n.push(e.id),e.Delete(),e.next.isTextNode()&&""==e.next.text&&(n.push(e.next.id),e.next.Delete()),this.DeleteNodes(n),i.SetFocusAtTheEnd()):(o=!1,r=[],this.isLineEmpty(e.next)?(s=this.GetWholeLine(e.next),a=[],l=void 0,s.forEach(function(e){l=e.next,a.push(e.id),e.Delete()}),null==l?o=!0:"br"==l.tagName&&(a.push(l.id),l.Delete()),this.DeleteNodes(a)):(c=this.GetWholeLine(e.next),h=!(u=[]),d=void 0,c.forEach(function(e){d=e.next,h?r.push(e):("i"==e.tagName&&(h=!0),u.push(e.id),e.Delete())}),null==d?o=!0:"br"==d.tagName&&(u.push(d.id),d.Delete()),this.DeleteNodes(u)),m=void 0,m=null!=this.rootNode.previous?(f=this,r.forEach(function(e){f.rootNode.previous.Append(e)}),this.rootNode.previous.GetLastTextNode()):(p=this.rootNode.InsertEmptyBlockNodeBefore("div"),g=v.TextNode.CreateNew(p.document,"span","",e.nodeStyle.Copy()),p.Append(g),g),o&&(this.rootNode.Delete(!0),t.DeletePluginInstance(this)),m.SetFocusAtTheEnd())}},{key:"DeleteTask_onCancel",value:function(t){var n=[],i=!1,o=void 0;this.rootNode.children.forEach(function(e){e.id==t.id?(i=!0,n.push(e.id),e.Delete()):i&&(n.push(e.id),e.Delete(),"i"==e.tagName&&(i=!1,o=e.next))}),this.DeleteNodes(n),o.SetFocus()}},{key:"ToggleCheck",value:function(e){var t;"i"==e.tagName&&((t=e.domElement).classList.contains("fa-square-o")?(t.classList.remove("fa-square-o"),t.classList.add("fa-check-square-o")):(t.classList.remove("fa-check-square-o"),t.classList.add("fa-square-o")),this.rootNode.document.RestoreCursorPositionBeforeClick(),this.rootNode.document.PushToHistory())}},{key:"VerifyHtml",value:function(){var t=!1;this.rootNode.children.map(function(e){"i"==e.tagName&&(t=!0)}),t||this.rootNode.document.RemovePluginInstance(this.id)}},{key:"_getLastTextNode",value:function(e){var t=this,n=void 0;return e.children.forEach(function(e){e.isTextNode()&&(n=e),null!=e.children&&0<e.children.length&&(n=t._getLastTextNode(e))}),n}},{key:"_GetLastItem",value:function(){var t=this,n=void 0;return this.rootNode.children.forEach(function(e){n=t._getLastTextNode(e)}),n}},{key:"Fire",value:function(e,t,n){var i=!1;switch(e){case v.PluginActions.NODE_UNREGISTERED:this.VerifyHtml();break;case v.PluginActions.DELETE:var o=this;setTimeout(function(){var t=[];o.rootNode.children.forEach(function(e){null==document.querySelector('[cm-id="'+e.id+'"]')&&(t.push(e.id),e.Delete())}),o.DeleteNodes(t)});break;case v.PluginActions.NODE_DELETE:this.DeleteNodes([t.id]);break;case v.PluginActions.DELETE_TOP:i=!0;break;case v.PluginActions.DELETE_FROM_BOTTOM:i=!1;break;case v.PluginActions.CANCEL_FROM_TOP:case v.PluginActions.CANCEL_FROM_BOTTOM:i=!0;break;case v.PluginActions.ENTER:i=this.ManageEnter(t,n);break;case v.PluginActions.DELETE_BEFORE_INLINE:this.DeleteTask_onBackspace(t,n),i=!0;break;case v.PluginActions.CANCEL_BEFORE_INLINE:this.DeleteTask_onCancel(t,n),i=!0;break;case v.PluginActions.CLICK:this.ToggleCheck(t);break;default:return}return i}}],[{key:"CreateNew",value:function(e){var t=e.GetStyleAtCurrentCursorPosition(),n=new v.NodeStyle(e,t.nodeStyle),i=e.GetNodeAtCursor().GetBlockContainer().InsertEmptyBlockNodeAfter("div"),o=v.InlineNode.CreateNew(e,"i","",void 0,[{name:"class",value:"fa fa-square-o commaTask"},{name:"contentEditable",value:!1}]);i.Append(o);var r=new s(i);return o.next.ApplyNodeStyle(n.Copy()),setTimeout(function(){o.next.SetFocus()}),r}}]),s}()}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t),n.d(t,"default",function(){return o});var p=n(0);function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var o=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(f,p.Plugin);var o,r,t=(o=f,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t,n=c(o),i=this;return!(t=r?(e=c(this).constructor,Reflect.construct(n,arguments,e)):n.apply(this,arguments))||"object"!==s(t)&&"function"!=typeof t?function(){if(void 0!==i)return i;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function f(e){return function(e){if(!(e instanceof f))throw new TypeError("Cannot call a class as a function")}(this),t.call(this,e)}return a(f,null,[{key:"GetName",value:function(){return"multiColumns"}}]),a(f,[{key:"Fire",value:function(e,t,n){var i=!1;switch(e){case p.PluginActions.CANCEL_FROM_TOP:i=!0;break;case p.PluginActions.DELETE_FROM_BOTTOM:this.rootNode.document.DeleteNode(this.rootNode),n.DeletePluginInstance(this),i=!1;break;default:return}return i}}],[{key:"AddRow",value:function(e,t,n){null==n&&(n=new p.NodeStyle);for(var i=p.BlockNode.CreateNew(e,"tr"),o=0,r=void 0;o<t;){var s=f.AddCell(e,n);null==r&&(r=s.nodeForFocus),i.Append(s.td),o++}return{tr:i,nodeForFocus:r}}},{key:"AddCell",value:function(e,t){var n=p.BlockNode.CreateNew(e,"td");n.SetAttributes([{name:"class",value:"commaParagraphColumn"}]);var i=p.BlockNode.CreateNew(e,"div"),o=p.TextNode.CreateNew(e,"span","",t.Copy());return i.Append(o),n.Append(i),{td:n,nodeForFocus:o}}},{key:"CreateNew",value:function(e,t){var n=e.GetStyleAtCurrentCursorPosition(),i=new p.NodeStyle(e,n.nodeStyle),o=e.GetNodeAtCursor().GetBlockContainer().InsertEmptyBlockNodeAfter("table");o.SetAttributes([{name:"class",value:"commaColumnsContainer"}]);var r=p.BlockNode.CreateNew(e,"tbody"),s=2;null!=t.cols&&0<t.cols&&(s=t.cols);for(var a=void 0,l=0;l<1;){var c=f.AddRow(e,s,i);null==a&&(a=c.nodeForFocus),r.Append(c.tr),l++}o.Append(r);var u=o.InsertEmptyBlockNodeAfter("div"),h=p.TextNode.CreateNew(e,"span","",i.Copy());u.Append(h);var d=new f(o);return setTimeout(function(){a.SetFocus()},20),d}}]),f}()}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(module,exports,__webpack_require__){var aTb;window,aTb=function(__WEBPACK_EXTERNAL_MODULE__0__){return d=[function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE__0__},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function r(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}n.d(t,"a",function(){return a});var p=(r(u,[{key:"_replaceAll",value:function(e,t,n){return e.replace(new RegExp(t,"g"),n)}},{key:"patternToString",value:function(e){var t="";return"YYYY"==e?t=this.date.getFullYear():"YY"==e?t=this.date.getFullYear().toString().substring(2):"MMMM"==e?t=this.months[this.date.getMonth()]:"MMM"==e?t=this.monthsShort[this.date.getMonth()]:"MM"==e?t=(t=parseInt(this.date.getMonth())+1)<10?"0"+t:t.toString():"M"==e?t=parseInt(this.date.getMonth())+1:"DD"==e?t=(t=this.date.getDate())<10?"0"+t:t.toString():"D"==e?t=this.date.getDate():"EE"==e?t=this.daysOfTheWeek[this.date.getDay()]:"E"==e&&(t=this.daysOfTheWeekShort[this.date.getDay()]),t}},{key:"toString",value:function(t){var n=this,i=0;this.patterns.forEach(function(e){-1<t.indexOf(e)&&(t=n._replaceAll(t,e,"#"+i+"#")),i++});var o="";return t.split("#").forEach(function(e){var t;""!=e&&(t=parseInt(e),isNaN(t)?o+=e:o+=n.patternToString(n.patterns[t]))}),o}}],[{key:"fromString",value:function(e,t,n){var i,o,r,s,a=1<arguments.length&&void 0!==t&&t,l=2<arguments.length&&void 0!==n?n:"en",c=e.split(" ")[0].split("/");return c.length<2&&(c=e.split(" ")[0].split("-")),c.length<2?void 0:(i=parseInt(c[0]),o=parseInt(c[1]),r=parseInt(c[2]),"en"==l||"??"==l&&(i=parseInt(c[1]),o=parseInt(c[0]),r=parseInt(c[2])),a&&(s=new Date,isNaN(i)&&(i=s.getMonth()+1),isNaN(o)&&(o=s.getDate()),isNaN(r)&&(r=s.getFullYear())),isNaN(i)||isNaN(o)||isNaN(r)?void 0:(r<100&&(r=2e3+r),new u(new Date(i+"/"+o+"/"+r))))}}]),u),s=(r(l,[{key:"Destroy",value:function(){this.panel.parentNode.removeChild(this.panel)}},{key:"VerifyAnPrepareFormat",value:function(){var e=!1;return null!=this.format&&""!=this.format&&("text"==this.format.type?e=!0:"number"==this.format.type?null==this.format.params.precision||""==this.format.params.precision?e=!(this.errorBox.textContent="Decimal places cannot be empty"):a.isNumber(this.format.params.precision)?(e=!0,delete this.format.params.dateFormat):e=!(this.errorBox.textContent="Decimal places must be a number"):"date"==this.format.type&&(e=null!=this.format.params.dateFormat&&""!=this.format.params.dateFormat||!(this.errorBox.textContent="Select date format"),delete this.format.params.precision)),e}},{key:"Apply",value:function(){var t,n,i=this;this.VerifyAnPrepareFormat()&&(t=JSON.stringify(this.format),n=void 0,this.spreadsheet.selectedNodes.forEach(function(e){n=e,"text"==i.format.type?(e.children.forEach(function(e){e.isBlockNode()&&e.ToggleStyle("align","left",!0)}),e.domElement.removeAttribute("cell-format")):(e.children.forEach(function(e){e.isBlockNode()&&e.ToggleStyle("align","right",!0)}),e.domElement.setAttribute("cell-format",t)),a.Format(e)}),null!=n&&n.GetFirstTextNode().SetFocus(),this.panel.parentNode.removeChild(this.panel))}},{key:"_initNavPanel",value:function(){var n=this,e=document.createElement("div");function t(e){e.style.color="#FF9100"}function i(e,t){t==n.format.type?e.style.color="#666666":e.style.color="#ffffff"}function o(e,t){t!=n.format.type&&("number"==n.format.type?(n.numberNavBtn.style.color="#ffffff",n.numberNavBtn.style.backgroundColor="#666666"):"date"==n.format.type?(n.dateNavBtn.style.color="#ffffff",n.dateNavBtn.style.backgroundColor="#666666"):"text"==n.format.type&&(n.textNavBtn.style.color="#ffffff",n.textNavBtn.style.backgroundColor="#666666"),n.format.type=t,e.style.color="#666666",e.style.backgroundColor="#ffffff","number"==n.format.type?(n.numbersOptionsPnl.style.display="block",n.dateOptionsPnl.style.display="none",n.textOptionsPnl.style.display="none"):"date"==n.format.type?(n.numbersOptionsPnl.style.display="none",n.dateOptionsPnl.style.display="block",n.textOptionsPnl.style.display="none"):"text"==n.format.type&&(n.numbersOptionsPnl.style.display="none",n.dateOptionsPnl.style.display="none",n.textOptionsPnl.style.display="block"))}e.style="width:90px;height:300px;background-color:#666666;box-sizing:border-box;padding:20px 0px 10px 10px;";var r="color:#ffffff;font-size:14px;cursor:pointer;margin-bottom:2px;background-color:#666666;padding:6px;border-radius: 6px 0px 0px 6px;",s=document.createElement("div");s.style=r,s.textContent="Number",s.addEventListener("mouseover",function(){t(this)}),s.addEventListener("mouseout",function(){i(this,"number")}),s.addEventListener("click",function(){o(this,"number")}),this.numberNavBtn=s,e.appendChild(s);var a=document.createElement("div");a.style=r,a.textContent="Date",a.addEventListener("mouseover",function(){t(this)}),a.addEventListener("mouseout",function(){i(this,"date")}),a.addEventListener("click",function(){o(this,"date")}),this.dateNavBtn=a,e.appendChild(a);var l=document.createElement("div");return l.style=r,l.textContent="Text",l.addEventListener("mouseover",function(){t(this)}),l.addEventListener("mouseout",function(){i(this,"text")}),l.addEventListener("click",function(){o(this,"text")}),this.textNavBtn=l,e.appendChild(l),"number"==this.format.type?(this.numberNavBtn.style.color="#666666",this.numberNavBtn.style.backgroundColor="#ffffff"):"date"==this.format.type?(this.dateNavBtn.style.color="#666666",this.dateNavBtn.style.backgroundColor="#ffffff"):"text"==this.format.type&&(this.textNavBtn.style.color="#666666",this.textNavBtn.style.backgroundColor="#ffffff"),e}},{key:"_initOptionsPanel",value:function(){var n=this,e=document.createElement("div");e.style="height:230px;overflow:auto;box-sizing:border-box;";var t="display:none;overflow:auto;padding:10px 20px 20px 20px;",i=document.createElement("div");i.style=t;var o=document.createElement("div");o.style="display:flex;justify-content:flex-start;align-items:center;";var r=document.createElement("div");r.style="font-size:14px;color:#39434d;margin-right:10px;",r.textContent="Decimal places: ",o.appendChild(r);var s=document.createElement("input");s.style="display: block;padding:4px;font-size:14px;color:#39434d;border:1px solid #e3e3e3;border-radius:4px;width:30px;",s.value=this.format.params.precision,s.addEventListener("keyup",function(){n.format.params.precision=s.value}),o.appendChild(s),i.appendChild(o),this.numbersOptionsPnl=i,e.appendChild(i);var a=document.createElement("div");a.style=t;var l=document.createElement("div");l.style="font-size:14px;color:#39434d;margin-bottom:4px;",l.textContent="Date Format:",a.appendChild(l);var c=document.createElement("select");c.size="5",c.style="display: block;padding:6px;font-size:12px;color:#39434d;border:1px solid #e3e3e3;border-radius:4px;width:200px;",this.availableDateFormats.forEach(function(e){var t=document.createElement("option");n.format.params.dateFormat==e.format&&t.setAttribute("selected",""),t.value=e.format,t.textContent=e.label,c.appendChild(t)}),c.addEventListener("change",function(){n.format.params.dateFormat=n.availableDateFormats[c.selectedIndex].format}),a.appendChild(c),this.dateOptionsPnl=a,e.appendChild(a);var u=document.createElement("div");u.style=t;var h=document.createElement("div");return h.style="font-size:14px;color:#39434d;",h.textContent="Text format cells are treated as text even when a number is in the cell. The cell is displayed exactly as entered.",u.appendChild(h),this.textOptionsPnl=u,e.appendChild(u),"number"==this.format.type?this.numbersOptionsPnl.style.display="block":"date"==this.format.type?this.dateOptionsPnl.style.display="block":"text"==this.format.type&&(this.textOptionsPnl.style.display="block"),e}},{key:"Show",value:function(){var e=this,t=document.createElement("div");t.style="z-index: 99999999999;position:fixed;display:flex;background-color:rgba(33, 33, 33, 0.5);top:0px;left:0px;width:100vw;height:100vh;justify-content:center;align-items:center;";var n=document.createElement("div");n.style="font-family:Arial;width:500px;height:300px;display:flex;justify-content:center;align-items:center;border-radius:6px;overflow:hidden;",n.appendChild(this._initNavPanel());var i=document.createElement("div");i.style="height:300px;background-color:#ffffff;flex:1;box-sizing:border-box;";var o=document.createElement("div");o.style="display:flex;justify-content:center;align-items:center;padding:6px;";var r=document.createElement("div");r.style="flex:1",o.appendChild(r);var s=document.createElement("i");s.style="color:#666666;font-size:20px;cursor:pointer",s.setAttribute("class","fa fa-times"),s.addEventListener("mouseover",function(){s.style.color="#FF9100"}),s.addEventListener("mouseout",function(){s.style.color="#666666"}),s.addEventListener("click",function(){e.Destroy()}),o.appendChild(s),i.appendChild(o),i.appendChild(this._initOptionsPanel());var a=document.createElement("div");a.style="display:flex;justify-content:center;align-items:center;padding:6px;";var l=document.createElement("div");l.style="flex:1;font-size:12px;color:#f04f4f;",l.textContent="",this.errorBox=l,a.appendChild(l);var c=document.createElement("div");c.style="color:#ffffff;font-size:14px;cursor:pointer;background-color: #30b7e8;padding:4px 8px 4px 8px;border-radius:4px;",c.textContent="Apply",c.addEventListener("mouseover",function(){c.style.backgroundColor="#FF9100"}),c.addEventListener("mouseout",function(){c.style.backgroundColor="#30b7e8"}),c.addEventListener("click",function(){e.Apply()}),a.appendChild(c),i.appendChild(a),n.appendChild(i),t.appendChild(n),document.body.appendChild(t),this.panel=t}}]),l),a=(r(g,null,[{key:"isNumber",value:function(e){var t=e;return"-"==e[0]&&(t=e.replace("-","")),"."!=e[e.length-1]&&/^[0-9.]*$/.test(t)}},{key:"Format",value:function(e,t){var n,i,o,r,s,a,l,c,u,h,d=1<arguments.length&&void 0!==t&&t,f=e.domElement.getAttribute("cell-format");d&&((n=e.document.GetCursorPosition()).startOffset,n.endOffset),null!=f&&""!=f&&("number"==(f=JSON.parse(f)).type?null==(i=f.params.precision)||""==i||""!=(r=(o=e.GetFirstTextNode()).domElement.textContent.replace(/[\u200B-\u200D\uFEFF]/g,""))&&(i=parseInt(i),s="",g.isNumber(r)&&(s=Number.parseFloat(r).toFixed(i)),r.toString()!=s.toString()&&(o.ForceTextContent(s.toString()),d&&o.SelectText(void 0,void 0))):"date"!=f.type||null!=(a=f.params.dateFormat)&&""!=a&&(""==(c=(l=e.GetFirstTextNode()).domElement.textContent.replace(/[\u200B-\u200D\uFEFF]/g,""))||null!=(u=p.fromString(c,!0))&&(h=u.toString(a),c.toString()!=h.toString()&&(l.ForceTextContent(h.toString()),d&&l.SelectText(void 0,void 0)))))}},{key:"OpenFormatDialog",value:function(e){new s(e)}}]),g);function g(){i(this,g)}function l(e){i(this,l),this.spreadsheet=e,this.availableDateFormats=[{format:"D-MMM",label:"1-Dec"},{format:"D-MMM-YYYY",label:"1-Dec-2019"},{format:"D-MMM-YY",label:"1-Dec-19"},{format:"MM/DD/YYYY",label:"12/01/2019"},{format:"MM/DD/YY",label:"12/01/19"},{format:"MM-DD-YYYY",label:"12-01-2019"},{format:"MM-DD-YY",label:"12-01-19"},{format:"MMM D, YYYY",label:"Dec 1, 2019"},{format:"MMM D, YY",label:"Dec 1, 19"},{format:"MMMM D, YYYY",label:"December 1, 2019"},{format:"D MMMM, YYYY",label:"1 December, 2019"},{format:"D MMMM, YYYY",label:"1 December 2019"},{format:"EE, MMMM D, YY",label:"Sunday, December 1, 19"},{format:"E, MMMM D, YY",label:"Sun, December 1, 19"}],this.format={type:"number"};var t,n={precision:2,dateFormat:""};0<this.spreadsheet.selectedNodes.length&&null!=(t=this.spreadsheet.selectedNodes[0].domElement.getAttribute("cell-format"))&&""!=t&&(this.format=JSON.parse(t),"number"==this.format.type?n.precision=this.format.params.precision:"date"==this.format.type?n.dateFormat=this.format.params.dateFormat:this.format.type),this.format.params=n,this.Show()}function u(e){i(this,u),this.date=e,this.patterns=["YYYY","YY","MMMM","MMM","MM","M","DD","D","EE","E"],this.months=["January","February","March","April","May","June","July","August","September","October","November","December"],this.monthsShort=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sept","Oct","Nov","Dec"],this.daysOfTheWeek=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],this.daysOfTheWeekShort=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",function(){return FunctionsManager});var _CellFormatter__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(1);function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}var CommaMath=(_createClass(xVb,null,[{key:"isFunction",value:function(e){return!(["sum","sin","cos","round","pow","sqrt","abs","ceil","floor","min","max","exp","ln","log","avg","count","stdev","concatenate","len"].indexOf(e.toLowerCase())<0)}},{key:"getFunctionType",value:function(e){return"concatenate"==e?"string":"number"}},{key:"getFunctionName",value:function(e){var t="";return"sum"==(e=e.toLowerCase())?t="sum":"sin"==e?t="sin":"cos"==e?t="cos":"round"==e?t="round":"pow"==e?t="pow":"sqrt"==e?t="sqrt":"abs"==e?t="abs":"ceil"==e?t="ceil":"floor"==e?t="floor":"min"==e?t="min":"max"==e?t="max":"exp"==e?t="exp":"ln"==e?t="ln":"log"==e?t="log":"avg"==e?t="avg":"count"==e?t="count":"stdev"==e||"stdev"==e?t="stDev":"concatenate"==e?t="concatenate":"len"==e&&(t="len"),t}},{key:"isNumber",value:function(e){var t=e;return"-"==e[0]&&(t=e.replace("-","")),/^[0-9.]*$/.test(t)}},{key:"concatenate",value:function(e){var t="";return e.forEach(function(e){null!=e&&(t+=e)}),t}},{key:"len",value:function(e){return null==e&&(e=""),xVb.isNumber(e)&&(e=e.toString()),e.length}},{key:"stDev",value:function(e){var t=e;if(!Array.isArray(e)){t=[];for(var n=0;n<arguments.length;n++){var i=arguments[n];null!=i&&t.push(parseFloat(i))}}var o=xVb.avg(t),r=t.map(function(e){var t=parseFloat(e)-o;return t*t}),s=xVb.avg(r);return Math.sqrt(s)}},{key:"count",value:function(e){var t=e;return Array.isArray(e)||(t=arguments),t.length}},{key:"sum",value:function(e){var t=e;Array.isArray(e)||(t=arguments);for(var n=0,i=0;i<t.length;i++){var o=t[i];null!=o&&(n+=parseFloat(o))}return n}},{key:"avg",value:function(e){var t=e;Array.isArray(e)||(t=arguments);for(var n=0,i=0;i<t.length;i++){var o=t[i];null!=o&&(n+=parseFloat(o))}return n/t.length}},{key:"sin",value:function(e){return Math.sin(parseFloat(e))}},{key:"cos",value:function(e){return Math.cos(parseFloat(e))}},{key:"atan",value:function(e){return Math.atan(parseFloat(e))}},{key:"round",value:function(e,t){return e=parseFloat(e),t=parseFloat(t),Number(Math.round(e+"e"+t)+"e-"+t)}},{key:"pow",value:function(e,t){return Math.pow(parseFloat(e),parseFloat(t))}},{key:"floor",value:function(e){return Math.floor(parseFloat(e))}},{key:"ceil",value:function(e){return Math.ceil(parseFloat(e))}},{key:"sqrt",value:function(e){return Math.sqrt(parseFloat(e))}},{key:"abs",value:function(e){return Math.abs(parseFloat(e))}},{key:"min",value:function(e){var t=e;return Array.isArray(e)||(t=arguments),Math.min.apply(Math,_toConsumableArray(t))}},{key:"max",value:function(e){return Math.max.apply(Math,_toConsumableArray(e))}},{key:"exp",value:function(e){return Math.exp(parseFloat(e))}},{key:"ln",value:function(e){return Math.log(parseFloat(e))}},{key:"log",value:function(e){return Math.log10(parseFloat(e))}},{key:"_CreateEntryInfoPanel",value:function(t,n,e,i,o){var r=document.createElement("div");r.setAttribute("class","cscfe_info_pnl_entry");var s=document.createElement("div");s.setAttribute("class","cscfe_info_pnl_entry_label"),s.textContent=e,r.appendChild(s);var a=document.createElement("div");return a.setAttribute("class","cscfe_info_pnl_entry_description"),a.innerHTML=o,r.appendChild(a),r.addEventListener("click",function(e){n.SetCommaMathFunction(i),t.style.display="none"}),r}},{key:"GetInfoPanel",value:function(e){var t=document.createElement("div");t.setAttribute("class","cscfe_info_pnl_container");var n=document.createElement("div");n.setAttribute("class","cscfe_info_pnl");var i=document.createElement("div");i.setAttribute("class","cscfe_info_pnl_header");var o=document.createElement("div");o.setAttribute("class","cscfe_info_pnl_header_title"),o.textContent="Available Functions",i.appendChild(o);var r=document.createElement("i");r.setAttribute("class","fa fa-times cscfe_info_pnl_closeBtn"),r.addEventListener("click",function(e){t.style.display="none"}),i.appendChild(r),n.appendChild(i);var s=document.createElement("div");s.style.display="flex";var a=document.createElement("div");a.appendChild(xVb._CreateEntryInfoPanel(t,e,"Sum","SUM()","Adds all the numbers in a range of cells.<br>Syntax: SUM(number1, number2,...) or SUM(D1:D5)")),a.appendChild(xVb._CreateEntryInfoPanel(t,e,"Round","ROUND()","Rounds a number to a specific number of digits.<br>Syntax: ROUND(number, numOfDigits) or ROUND(A1,B2)")),a.appendChild(xVb._CreateEntryInfoPanel(t,e,"Pow","POW()","Returns the result of a number (base) raised to a power (exponent).<br>Syntax: POW(base, exponent) or POW(A1,B2)")),a.appendChild(xVb._CreateEntryInfoPanel(t,e,"Sqrt","SQRT()","Returns the square root of a number.<br>Syntax: SQRT(number) or SQRT(A1)")),a.appendChild(xVb._CreateEntryInfoPanel(t,e,"Abs","ABS()","Returns the absolute value of a number.<br>Syntax: ABS(number) or ABS(A1)")),a.appendChild(xVb._CreateEntryInfoPanel(t,e,"Ceil","CEIL()","Rounds a number up to the next largest whole number or integer.<br>Syntax: CEIL(number) or CEIL(A1)")),a.appendChild(xVb._CreateEntryInfoPanel(t,e,"Floor","FLOOR()","Returns the largest integer less than or equal to a given number.<br>Syntax: FLOOR(number) or FLOOR(A1)")),s.appendChild(a);var l=document.createElement("div");l.appendChild(xVb._CreateEntryInfoPanel(t,e,"Min","MIN()","Returns the lowest-valued number passed into it.<br>Syntax: MIN(number1, number2,...) or MIN(D1:D5)")),l.appendChild(xVb._CreateEntryInfoPanel(t,e,"Max","MAX()","Returns the largest number passed into it.<br>Syntax: MAX(number1, number2,...) or MAX(D1:D5)")),l.appendChild(xVb._CreateEntryInfoPanel(t,e,"Exp","EXP()","Returns <code>e<sup>x</sup></code>, where x is the argument, and e is Euler's number.<br>Syntax: EXP(number1) or EXP(D1)")),l.appendChild(xVb._CreateEntryInfoPanel(t,e,"Ln","LN()","Returns the natural logarithm (base e) of a number.<br>Syntax: LN(number1) or LN(D1)")),l.appendChild(xVb._CreateEntryInfoPanel(t,e,"Log","LOG()","Returns the natural logarithm (base 10) of a number.<br>Syntax: LOG(number1) or LOG(D1)")),l.appendChild(xVb._CreateEntryInfoPanel(t,e,"Avg","AVG()","Returns the average (arythmetic mean) of its arguments.<br>Syntax: AVG(number1, number2,...) or AVG(D1:D5)")),l.appendChild(xVb._CreateEntryInfoPanel(t,e,"Standard Deviation","STDEV()","Returns the standard deviation of its arguments.<br>Syntax: STDEV(number1, number2,...) or STDEV(D1:D5)")),s.appendChild(l);var c=document.createElement("div");return c.appendChild(xVb._CreateEntryInfoPanel(t,e,"Count","COUNT(","Returns the number of its arguments.<br>Syntax: COUNT(number1, number2,...) or COUNT(D1:D5)")),c.appendChild(xVb._CreateEntryInfoPanel(t,e,"Sin","SIN()","Returns the sine of a number.<br>Syntax: SIN(number) or SIN(D1)")),c.appendChild(xVb._CreateEntryInfoPanel(t,e,"Cos","COS()","Returns the cosine of a number.<br>Syntax: COS(number) or COS(D1)")),c.appendChild(xVb._CreateEntryInfoPanel(t,e,"Atan","ATAN()","Returns the arctangent (in radians) of a number.<br>Syntax: ATAN(number) or ATAN(D1)")),c.appendChild(xVb._CreateEntryInfoPanel(t,e,"Concatenate","CONCATENATE()","Returns a string that concatenates all the strings passed as arguments.<br>Syntax: CONCATENATE(string1, string2, ....) or CONCATENATE(D1:D5)")),c.appendChild(xVb._CreateEntryInfoPanel(t,e,"Len","LEN()","Returns the number of characters in a string.<br>Syntax: LEN(string) or LEN(D1)")),s.appendChild(c),n.appendChild(s),t.appendChild(n),document.body.appendChild(t),t}}]),xVb),FunctionsManager=function(){function FunctionsManager(e){_classCallCheck(this,FunctionsManager),this.spreadsheet=e,this.input=void 0,this.currentTd=void 0,this.currentFunction=[],this.classesToHighlightCells=["cscfe_highlight_cell_one","cscfe_highlight_cell_two","cscfe_highlight_cell_three","cscfe_highlight_cell_four","cscfe_highlight_cell_five","cscfe_highlight_cell_six"],this.useHighlightClass=-1,this.precision=5,this.cellAffects={},this.labelInitialized=!1,this.inputInitialized=!1}return _createClass(FunctionsManager,[{key:"Reset",value:function(){this.cellAffects={},this.useHighlightClass=-1,this.precision=5,this.currentTd=void 0,this.currentFunction=[]}},{key:"SetPrecision",value:function(e){null==e&&(e=5),this.precision=parseInt(e)}},{key:"_round",value:function(e){return Number(Math.round(e+"e"+this.precision)+"e-"+this.precision)}},{key:"SetFxLabelNode",value:function(e){var t;this.labelInitialized||(this.labelInitialized=!0,this.fxLabel=e,null==(t=this).f_click&&(this.f_click=function(e){null==t.fxInfoPanel&&(t.fxInfoPanel=CommaMath.GetInfoPanel(t)),t.fxInfoPanel.style.display="flex"}),this.fxLabel.domElement.removeEventListener("click",this.f_click),this.fxLabel.domElement.addEventListener("click",this.f_click))}},{key:"SetInputNode",value:function(e){var t;this.inputInitialized||(this.inputInitialized=!0,this.input=e,null==(t=this).f_keyup&&(this.f_keyup=function(e){t.FunctionEdited(e)}),this.input.domElement.removeEventListener("keyup",this.f_keyup),this.input.domElement.addEventListener("keyup",this.f_keyup),null==this.f_mousedown&&(this.f_mousedown=function(e){t.spreadsheet.StartFunctionEditing()}),this.input.domElement.removeEventListener("mousedown",this.f_mousedown),this.input.domElement.addEventListener("mousedown",this.f_mousedown))}},{key:"GetCurrentCell",value:function(){return this.currentTd}},{key:"GetIdCurrentCell",value:function(){var e=void 0;return null!=this.currentTd&&(e=this.currentTd.id),e}},{key:"SetEditingCell",value:function(e){this.HideInputError(),this.currentTd=e,this.currentFunction=JSON.parse(e.domElement.getAttribute("cell-function")),this.originalFunction=this.currentFunction,this.input.domElement.value=this.FunctionJsonToString(),this.currentCellCoordinates=this.spreadsheet.GetCoordinatesPerNode(this.currentTd.id),this.HighlightAllRanges()}},{key:"StartEditingCell",value:function(e){this.HideInputError(),""==this.input.domElement.value?(this.input.domElement.value="=",this.currentFunction=this.StringToFunctionJson(this.input.domElement.value)):this.currentFunction=JSON.parse(e.domElement.getAttribute("cell-function")),this.input.domElement.focus(),this.currentTd=e,this.originalFunction=this.currentFunction,this.currentCellCoordinates=this.spreadsheet.GetCoordinatesPerNode(this.currentTd.id),this.HighlightAllRanges()}},{key:"StopEditingCell",value:function(){null!=this.input&&(this.input.domElement.value=""),this.currentTd=void 0}},{key:"FunctionEdited",value:function(e){var t=e.key;"Esc"==t||"Escape"==t?(this.input.domElement.value="",this.spreadsheet.StopFunctionEditing(!0)):"Enter"==t?(this.currentTd.domElement.setAttribute("cell-function",JSON.stringify(this.currentFunction)),this.TrackCell(this.currentTd,this.currentCellCoordinates.row,this.currentCellCoordinates.col),this.spreadsheet.StopFunctionEditing(!0)):(this.DehighlightAllRanges(),this.currentFunction=this.StringToFunctionJson(this.input.domElement.value,this.currentCellCoordinates),this.HighlightAllRanges(),this.EvalFunctionPerNode(this.currentTd,this.currentCellCoordinates,this.currentFunction))}},{key:"EvalFunctionPerNode",value:function EvalFunctionPerNode(tdCell,currentCellCoordinates,currentFunction){var skipPushToHistory=3<arguments.length&&void 0!==arguments[3]&&arguments[3];if(this.noCircularReference(currentCellCoordinates))this.showCircularError||(this.ShowInputError(),this.showCircularError=!0,alert("Formula cannot be calculated: cell references in the formula refer to the formula's result, creating a circular reference."));else{this.showCircularError=!1;var tn=tdCell.GetFirstTextNode(),nv=void 0;try{nv=eval(this.GetStringForEval(tdCell,currentCellCoordinates,currentFunction)),this.HideInputError()}catch(e){this.ShowInputError()}null==nv&&(nv=""),tn.ForceTextContent(nv.toString()),_CellFormatter__WEBPACK_IMPORTED_MODULE_0__.a.Format(tdCell),this.CellValueChanged(tdCell,skipPushToHistory)}}},{key:"HideInputError",value:function(){this.input.domElement.classList.remove("functionWithErrors")}},{key:"ShowInputError",value:function(){this.input.domElement.classList.add("functionWithErrors")}},{key:"_insertBeforeCursor",value:function(e,t){e.setRangeText?e.setRangeText(t):(e.focus(),document.execCommand("insertText",!1,t))}},{key:"_insertAtCursor",value:function(e,t){var n,i;document.selection?(e.focus(),sel=document.selection.createRange(),sel.text=t):e.selectionStart||"0"==e.selectionStart?(n=e.selectionStart,i=e.selectionEnd,e.value=e.value.substring(0,n)+t+e.value.substring(i,e.value.length)):e.value+=t}},{key:"_moveCursorBackOne",value:function(){var e,t,n=this.input.domElement;null!=n&&((e=n.selectionStart-1)<0&&(e=0),n.setSelectionRange?(n.focus(),n.setSelectionRange(e,e)):n.createTextRange&&((t=n.createTextRange()).collapse(!0),t.moveEnd("character",e),t.moveStart("character",e),t.select()))}},{key:"SetCommaMathFunction",value:function(e){null==this.currentTd&&1==this.spreadsheet.selectedNodes.length&&this.spreadsheet.StartFunctionEditing(this.spreadsheet.selectedNodes[0]),this._insertAtCursor(this.input.domElement,e),this._moveCursorBackOne(),this.currentFunction=this.StringToFunctionJson(this.input.domElement.value,this.currentCellCoordinates)}},{key:"noCircularReference",value:function(e,t){var n,i,o=1<arguments.length&&void 0!==t?t:void 0,r=!1;return null==o&&(o=e.row+"#"+e.col),null!=this.cellAffects&&null!=this.cellAffects[e.row]&&null!=this.cellAffects[e.row][e.col]&&(-1<(n=this.cellAffects[e.row][e.col]).indexOf(o)?r=!0:(i=this,n.forEach(function(e){var t,n;r||(n={row:(t=e.split("#"))[0],col:t[1]},r=i.noCircularReference(n,o))}))),r}},{key:"GetRangeValue",value:function(e,t){var n,i,o=e.r1c1,r=o.isColAbsolute?o.col:t.col+parseInt(o.col),s=o.isRowAbsolute?parseInt(o.row)-1:t.row+parseInt(o.row)-1;return"range"==o.type?(0,n=o.toCell.isColAbsolute?parseInt(o.toCell.col):t.col+parseInt(o.toCell.col),i=o.toCell.isRowAbsolute?parseInt(o.toCell.row)-1:t.row+parseInt(o.toCell.row)-1,this.spreadsheet.GetValues(s,r,i,n)):this.spreadsheet.GetValue(s,r)}},{key:"_prepareValue",value:function(e,t){return e&&"string"==typeof t&&(""==(t=t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""))?t=0:t.match(/[a-zA-Z]/i)&&(t='"'+t+'"')),t}},{key:"GetStringForEval",value:function(e,i,t){var o=this,r="";null==t&&(t=[]);var s=!0,a=!1,l="";return t.forEach(function(e){var t,n;"space"!=e.type&&("function"==e.type?(l=e.value.toLowerCase(),"string"==CommaMath.getFunctionType(e.value.toLowerCase())&&(a=!(s=!1))):"range"==e.type?s&&""==l&&(t=o.GetRangeValue(e,i),Array.isArray(t)?t.forEach(function(e){"string"==typeof o._prepareValue(s,e)&&(s=!1)}):"string"==typeof o._prepareValue(s,t)&&(s=!1)):"value"==e.type?""!=e.value&&(n=parseFloat(e.value),CommaMath.isNumber(n)||(s=!1)):"operator"==e.type&&")"==e.value&&(l=""))}),t.forEach(function(e){var t,n;"space"!=e.type&&("function"==e.type?r=r+"CommaMath."+CommaMath.getFunctionName(e.value):"range"==e.type?(t=o.GetRangeValue(e,i),Array.isArray(t)?(n=[],t.forEach(function(e){n.push(o._prepareValue(s,e))}),r+=JSON.stringify(n)):r+=o._prepareValue(s,t)):"value"==e.type?r+=o._prepareValue(s,e.value):r+=e.value)}),s&&""!=r?r="this._round("+r+")":a||(r="'"+r+"'"),r}},{key:"FunctionJsonToString",value:function(){var t="";return null!=this.currentFunction&&this.currentFunction.forEach(function(e){t+=e.value}),t}},{key:"GetFunctionFromDomNode",value:function(e){return e.getAttribute("cell-function")}},{key:"CopyFunctionToNode",value:function(e,t){var a,l,c,n;null!=e&&""!=e&&(a=this.spreadsheet.GetCoordinatesPerNode(t.id),l=this.spreadsheet.GetNumberOfColumns(),c=this.spreadsheet.GetNumberOfRows(),(n=JSON.parse(e)).forEach(function(e){var t,n,i,o,r,s;"range"==e.type&&(s="",s=(t=e.r1c1).isColAbsolute?"$"+FunctionsManager.toColumnName(t.col):(n=a.col+parseInt(t.col),l<n&&(t.col=l-a.col,n=a.col+parseInt(t.col)),FunctionsManager.toColumnName(n)),t.isRowAbsolute?s+="$"+t.row:(i=a.row+parseInt(t.row),c<i&&(t.row=c-a.row,i=a.row+parseInt(t.row)),s+=i),"range"==t.type&&(t.toCell.isColAbsolute?s+=":$"+FunctionsManager.toColumnName(t.toCell.col):(o=a.col+parseInt(t.toCell.col),l<o&&(t.toCell.col=l-a.col,o=a.col+parseInt(t.toCell.col)),s+=":"+FunctionsManager.toColumnName(o)),t.toCell.isRowAbsolute?s+="$"+t.toCell.row:(r=a.row+parseInt(t.toCell.row),c<r&&(t.toCell.row=c-a.row,r=a.row+parseInt(t.toCell.row)),s+=r)),e.value=s)}),t.domElement.setAttribute("cell-function",JSON.stringify(n)),this.TrackCell(t,a.row,a.col),this.EvalFunctionPerNode(t,a,n))}},{key:"StringToFunctionJson",value:function(e,t){for(var n=[],i="",o="",r=!1,s=0;s<e.length;s++){var a=e[s],l=parseInt(a);" "!=a&&"="!=a?CommaMath.isNumber(l)?r?o+=a:i+=a:"+"==a||"-"==a||"*"==a||"/"==a||"("==a||")"==a||"%"==a||","==a||"."==a?(""!=i?(n.push({type:"value",value:i}),i=""):""!=o&&(CommaMath.isFunction(o.toLowerCase())?n.push({type:"function",value:o}):n.push({type:"range",value:o}),o=""),n.push({type:"operator",value:a}),r=!1):"$"==a||":"==a?(o+=a,r=!0):a.match(/[a-zA-Z]/i)&&(o+=a.toUpperCase(),r=!0):n.push({type:"space",value:a})}""!=i?n.push({type:"value",value:i}):""!=o&&n.push({type:"range",value:o});var c=this;return n.forEach(function(e){"range"==e.type&&(e.r1c1=c.stringToR1C1(e.value,t))}),n}},{key:"stringToR1C1",value:function(e,t){for(var n,i,o,r=void 0,s=!1,a="",l="",c=!1,u=!1,h=0;h<e.length;h++){var d,f=e[h],p=parseInt(f);CommaMath.isNumber(p)?(l+=f,s=s&&!(u=!0)):":"==f?(d=c?this.colNameToNumber(a):this.colNameToNumber(a)-t.col,r={type:"single",isColAbsolute:c,isRowAbsolute:u,row:u?parseInt(l):parseInt(l)-t.row,col:d},l=a="",u=c=s=!1):"$"==f?s=!0:f.match(/[a-zA-Z]/i)&&(a+=f,s=s&&!(c=!0))}return null!=r?(0,n=c?this.colNameToNumber(a):this.colNameToNumber(a)-t.col,i=u?parseInt(l):parseInt(l)-t.row,r.type="range",r.toCell={isColAbsolute:c,isRowAbsolute:u,row:i,col:n}):(o=c?this.colNameToNumber(a):this.colNameToNumber(a)-t.col,r={type:"single",isColAbsolute:c,isRowAbsolute:u,row:u?parseInt(l):parseInt(l)-t.row,col:o}),r}},{key:"GetNextHighlightColor",value:function(){return this.useHighlightClass++,this.useHighlightClass>this.classesToHighlightCells.length-1&&(this.useHighlightClass=0),this.classesToHighlightCells[this.useHighlightClass]}},{key:"StartSelectingCells",value:function(){return this.currentRange={},this.GetNextHighlightColor()}},{key:"DehighlightAllRanges",value:function(){var t;null!=this.currentFunction&&(t=this).currentFunction.forEach(function(e){"range"==e.type&&t.ToggleRange(!1,e,t.currentCellCoordinates)})}},{key:"HighlightAllRanges",value:function(){var t;this.useHighlightClass=0,null!=this.currentFunction&&(t=this).currentFunction.forEach(function(e){"range"==e.type&&t.ToggleRange(!0,e,t.currentCellCoordinates)})}},{key:"ToggleRange",value:function(e,t,n,i){var o,r=t.r1c1,s=0,a=0,l=void 0,c=void 0,u=!1;null!=i&&(u=!0,a=(o=i.r1c1).isColAbsolute?o.col:n.col+parseInt(o.col),s=o.isRowAbsolute?parseInt(o.row)-1:n.row+parseInt(o.row)-1,"range"==o.type&&(c=o.toCell.isColAbsolute?parseInt(o.toCell.col):n.col+parseInt(o.toCell.col),l=o.toCell.isRowAbsolute?parseInt(o.toCell.row)-1:n.row+parseInt(o.toCell.row)-1));var h,d,f=r.isColAbsolute?r.col:n.col+parseInt(r.col),p=r.isRowAbsolute?parseInt(r.row)-1:n.row+parseInt(r.row)-1;"range"==r.type?(h=r.toCell.isColAbsolute?parseInt(r.toCell.col):n.col+parseInt(r.toCell.col),d=r.toCell.isRowAbsolute?parseInt(r.toCell.row)-1:n.row+parseInt(r.toCell.row)-1,CommaMath.isNumber(p)&&CommaMath.isNumber(d)&&(e?this.spreadsheet.SelectRangeForFunctionEditing(p,f,d,h,this.GetNextHighlightColor()):this.spreadsheet.DeselectRangeForFunctionEditing(p,f,d,h,u,s,a,l,c))):CommaMath.isNumber(p)&&(e?this.spreadsheet.SelectRangeForFunctionEditing(p,f,void 0,void 0,this.GetNextHighlightColor()):this.spreadsheet.DeselectRangeForFunctionEditing(p,f,void 0,void 0,u,s,a,l,c))}},{key:"ClearCurrentRange",value:function(){this.currentRange={}}},{key:"AddCell",value:function(e,t){null==this.currentRange[e]&&(this.currentRange[e]=new Array),this.currentRange[e][t]=!0}},{key:"colNameToNumber",value:function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZ",n=0,i=0,o=e.length-1;i<e.length;i+=1,--o)n+=Math.pow(t.length,o)*(t.indexOf(e[i])+1);return n}},{key:"addRangeToCurrentFunction",value:function(e){var t={type:"range",value:e,r1c1:this.stringToR1C1(e,this.currentCellCoordinates)};null==this.currentFunction&&(this.currentFunction=[]);var n,i=this.currentFunction[this.currentFunction.length-1];null!=i&&"range"==i.type&&(n=this.currentFunction.pop(),this.ToggleRange(!1,n,this.currentCellCoordinates,t)),this.currentFunction.push(t)}},{key:"DoneSelectingCells",value:function(){var e="",t=!0,n="";for(var i in this.currentRange)if(this.currentRange.hasOwnProperty(i))for(var o in this.currentRange[i])this.currentRange[i].hasOwnProperty(o)&&(t?(t=!1,e=FunctionsManager.toColumnName(o)+(parseInt(i)+1)):n=FunctionsManager.toColumnName(o)+(parseInt(i)+1));""!=n&&(n=":"+n);var r,s,a=this.currentFunction[this.currentFunction.length-1];null!=a&&"range"==a.type&&(r=this.currentFunction.pop(),s=this.input.domElement.value.lastIndexOf(r.value),this.input.domElement.value=this.input.domElement.value.substring(0,s),this.ToggleRange(!1,r,this.currentCellCoordinates)),this._insertAtCursor(this.input.domElement,e+n),this.DehighlightAllRanges(),this.currentFunction=this.StringToFunctionJson(this.input.domElement.value,this.currentCellCoordinates),this.HighlightAllRanges(),this.EvalFunctionPerNode(this.currentTd,this.currentCellCoordinates,this.currentFunction)}},{key:"RecalculateAll",value:function(){var i=this;this.spreadsheet.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){e.children.forEach(function(e){var t=i.spreadsheet.GetCoordinatesPerNode(e.id),n=JSON.parse(e.domElement.getAttribute("cell-function"));null!=n&&i.EvalFunctionPerNode(e,t,n,!0)})})})}},{key:"CellValueChanged",value:function(e,t){var n=this.spreadsheet.GetCoordinatesPerNode(e.id),i=n.row,o=n.col,r=this.GetAffectedCells(i,o),s=this;r.forEach(function(e){e.row=parseInt(e.row),e.col=parseInt(e.col);var t=s.spreadsheet.GetNodePerCoordinates(e.row,e.col),n=JSON.parse(t.domElement.getAttribute("cell-function"));null!=n&&s.EvalFunctionPerNode(t,e,n)})}},{key:"GetAffectedCells",value:function(e,t){var n=[];return null!=this.cellAffects&&null!=this.cellAffects[e]&&null!=this.cellAffects[e][t]&&this.cellAffects[e][t].forEach(function(e){var t=e.split("#");n.push({row:t[0],col:t[1]})}),n}},{key:"TrackCell",value:function(e,l,c){var t,u;null!=e.domElement.getAttribute("cell-function")&&(t=JSON.parse(e.domElement.getAttribute("cell-function")),null==(u=this).cellAffects&&(u.cellAffects={}),Object.keys(u.cellAffects).forEach(function(n){var e=u.cellAffects[n];Object.keys(e).forEach(function(e){var t;-1<u.cellAffects[n][e].indexOf(l+"#"+c)&&(t=[],u.cellAffects[n][e].forEach(function(e){e!=l+"#"+c&&t.push(e)}),u.cellAffects[n][e]=t)})}),t.forEach(function(e){if("range"==e.type){var t,n,i=e.r1c1,o=i.isColAbsolute?i.col:c+parseInt(i.col),r=i.isRowAbsolute?parseInt(i.row)-1:l+parseInt(i.row)-1;if("range"==i.type){n=i.toCell.isColAbsolute?parseInt(i.toCell.col):c+parseInt(i.toCell.col),t=i.toCell.isRowAbsolute?parseInt(i.toCell.row)-1:l+parseInt(i.toCell.row)-1;for(var s=r;s<=t;){for(var a=o;a<=n;)null==u.cellAffects[s]&&(u.cellAffects[s]={},u.cellAffects[s][a]=[]),null==u.cellAffects[s][a]&&(u.cellAffects[s][a]=[]),u.cellAffects[s][a].indexOf(l+"#"+c)<0&&u.cellAffects[s][a].push(l+"#"+c),a++;s++}}else null==u.cellAffects[r]&&(u.cellAffects[r]={},u.cellAffects[r][o]=[]),null==u.cellAffects[r][o]&&(u.cellAffects[r][o]=[]),u.cellAffects[r][o].indexOf(l+"#"+c)<0&&u.cellAffects[r][o].push(l+"#"+c)}}))}}],[{key:"toColumnName",value:function(e){for(var t="",n=1,i=26;0<=(e-=n);n=i,i*=26)t=String.fromCharCode(parseInt(e%i/n)+65)+t;return t}},{key:"RemoveFunction",value:function(e){e.domElement.removeAttribute("cell-function")}},{key:"AdjustAllRowsOnInsert",value:function(e,t,a){var l,c,n=JSON.parse(e.domElement.getAttribute("cell-function"));null!=n&&(l=t.GetCoordinatesPerNode(e.id),c=l.row,l.row>=a&&(c=l.row+1),n.forEach(function(e){var t,n,i,o,r,s;"range"==e.type&&((t=e.r1c1).row=parseInt(t.row),t.col=parseInt(t.col),i="",i=t.isColAbsolute?"$"+FunctionsManager.toColumnName(t.col):(n=l.col+t.col,FunctionsManager.toColumnName(n)),t.isRowAbsolute?i+="$"+t.row:(o=l.row+t.row-1,l.row>=a&&o<a?t.row=t.row-1:l.row<a&&a<=o&&(t.row=t.row+1),i+=c+t.row),"range"==t.type&&(t.toCell.isColAbsolute?i+=":$"+FunctionsManager.toColumnName(t.toCell.col):(r=l.col+parseInt(t.toCell.col),i+=":"+FunctionsManager.toColumnName(r)),t.toCell.isRowAbsolute?i+="$"+t.toCell.row:(s=l.row+t.toCell.row-1,l.row>=a&&s<a?t.toCell.row=t.toCell.row-1:l.row<a&&a<=s&&(t.toCell.row=t.toCell.row+1),i+=c+t.toCell.row)),e.value=i)}),e.domElement.setAttribute("cell-function",JSON.stringify(n)))}},{key:"AdjustAllRowsOnDelete",value:function(e,t,n){var c,i=JSON.parse(e.domElement.getAttribute("cell-function"));null!=i&&(c=t.GetCoordinatesPerNode(e.id),n.forEach(function(a){var l;a!=c.row&&(l=c.row,c.row>a&&(l=c.row-1),i.forEach(function(e){var t,n,i,o,r,s;"range"==e.type&&((t=e.r1c1).row=parseInt(t.row),t.col=parseInt(t.col),i="",i=t.isColAbsolute?"$"+FunctionsManager.toColumnName(t.col):(n=c.col+t.col,FunctionsManager.toColumnName(n)),t.isRowAbsolute?i+="$"+t.row:(o=c.row+t.row-1,c.row>=a&&o<a?t.row=t.row+1:c.row<a&&a<=o&&(t.row=t.row-1),i+=l+t.row),"range"==t.type&&(t.toCell.isColAbsolute?i+=":$"+FunctionsManager.toColumnName(t.toCell.col):(r=c.col+parseInt(t.toCell.col),i+=":"+FunctionsManager.toColumnName(r)),t.toCell.isRowAbsolute?i+="$"+t.toCell.row:(s=c.row+t.toCell.row-1,c.row>=a&&s<a?t.toCell.row=t.toCell.row+1:c.row<a&&a<=s&&(t.toCell.row=t.toCell.row-1),i+=l+t.toCell.row)),e.value=i)}),c.row=l)}),e.domElement.setAttribute("cell-function",JSON.stringify(i)))}},{key:"AdjustAllColsOnInsert",value:function(e,t,r){var s,a,n=JSON.parse(e.domElement.getAttribute("cell-function"));null!=n&&(s=t.GetCoordinatesPerNode(e.id),a=s.col,s.col>=r&&(a=s.col+1),n.forEach(function(e){var t,n,i,o;"range"==e.type&&((t=e.r1c1).row=parseInt(t.row),t.col=parseInt(t.col),n="",t.isColAbsolute?n="$"+FunctionsManager.toColumnName(t.col):(i=s.col+t.col,s.col>=r&&i<r?t.col=t.col-1:s.col<r&&r<=i&&(t.col=t.col+1),n+=FunctionsManager.toColumnName(a+t.col)),t.isRowAbsolute?n+="$"+t.row:n+=s.row+parseInt(t.row),"range"==t.type&&(t.toCell.isColAbsolute?n+=":$"+FunctionsManager.toColumnName(t.toCell.col):(o=s.col+t.toCell.col,s.col>=r&&o<r?t.toCell.col=t.toCell.col-1:s.col<r&&r<=o&&(t.toCell.col=t.toCell.col+1),n+=":"+FunctionsManager.toColumnName(a+t.toCell.col)),t.toCell.isRowAbsolute?n+="$"+t.toCell.row:n+=s.row+parseInt(t.toCell.row)),e.value=n)}),e.domElement.setAttribute("cell-function",JSON.stringify(n)))}},{key:"AdjustAllColsOnDelete",value:function(e,t,n){var a,i=JSON.parse(e.domElement.getAttribute("cell-function"));null!=i&&(a=t.GetCoordinatesPerNode(e.id),n.forEach(function(r){var s;r!=a.col&&(s=a.col,a.col>r&&(s=a.col-1),i.forEach(function(e){var t,n,i,o;"range"==e.type&&((t=e.r1c1).row=parseInt(t.row),t.col=parseInt(t.col),n="",t.isColAbsolute?n="$"+FunctionsManager.toColumnName(t.col):(i=a.col+t.col,a.col>=r&&i<r?t.col=t.col+1:a.col<r&&r<=i&&(t.col=t.col-1),n+=FunctionsManager.toColumnName(s+t.col)),t.isRowAbsolute?n+="$"+t.row:n+=a.row+t.row,"range"==t.type&&(t.toCell.isColAbsolute?n+=":$"+FunctionsManager.toColumnName(t.toCell.col):(o=a.col+t.toCell.col,a.col>=r&&o<r?t.toCell.col=t.toCell.col+1:a.col<r&&r<=o&&(t.toCell.col=t.toCell.col-1),n+=":"+FunctionsManager.toColumnName(s+t.toCell.col)),t.toCell.isRowAbsolute?n+="$"+t.toCell.row:n+=a.row+parseInt(t.toCell.row)),e.value=n)}),a.col=s)}),e.domElement.setAttribute("cell-function",JSON.stringify(i)))}}]),FunctionsManager}();function xVb(){_classCallCheck(this,xVb)}},function(e,t,n){"use strict";n.r(t);var y=n(0);function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}var r=(o(u,[{key:"draw",value:function(){this.build()}},{key:"build",value:function(){var e=this.context.createLinearGradient(0,0,this.width,0);e.addColorStop(0,"rgb(255, 0, 0)"),e.addColorStop(.15,"rgb(255, 0, 255)"),e.addColorStop(.33,"rgb(0, 0, 255)"),e.addColorStop(.49,"rgb(0, 255, 255)"),e.addColorStop(.67,"rgb(0, 255, 0)"),e.addColorStop(.84,"rgb(255, 255, 0)"),e.addColorStop(1,"rgb(255, 0, 0)"),this.context.fillStyle=e,this.context.fillRect(0,0,this.width,this.height),(e=this.context.createLinearGradient(0,0,0,this.height)).addColorStop(0,"rgba(255, 255, 255, 1)"),e.addColorStop(.5,"rgba(255, 255, 255, 0)"),e.addColorStop(.5,"rgba(0, 0, 0, 0)"),e.addColorStop(1,"rgba(0, 0, 0, 1)"),this.context.fillStyle=e,this.context.fillRect(0,0,this.width,this.height),this.context.beginPath(),this.context.arc(this.pickerCircle.x,this.pickerCircle.y,this.pickerCircle.width,0,2*Math.PI),this.context.strokeStyle="#ffffff",this.context.stroke(),this.context.closePath()}},{key:"listenForEvents",value:function(){var o=this;this.canvas.addEventListener("mousemove",function(e){var t=o.canvas.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top;o.pickerCircle.x=n,o.pickerCircle.y=i,o.previewbox.style.backgroundColor=o.getPickedColor(),o.draw()}),this.canvas.addEventListener("click",function(){return o.SelectColor()})}},{key:"getPickedColor",value:function(){var e=this.context.getImageData(this.pickerCircle.x,this.pickerCircle.y,1,1);return"#"+this.fullColorHex(e.data[0],e.data[1],e.data[2])}},{key:"SelectColor",value:function(){try{this.panel.parentNode.removeChild(this.panel)}catch(e){}this.onChangeCallback(this.getPickedColor())}},{key:"rgbToHex",value:function(e){var t=Number(e).toString(16);return t.length<2&&(t="0"+t),t}},{key:"fullColorHex",value:function(e,t,n){return this.rgbToHex(e)+this.rgbToHex(t)+this.rgbToHex(n)}}]),u),s=(o(l,[{key:"_parseSelectedColor",value:function(e){var t,n=e;return null!=e&&-1<e.toLowerCase().indexOf("rgb")&&(t=(e=e.toLowerCase()).split("(")[1].split(")")[0].split(","),n="#"+this._rgbToHex(t[0].split(" ").join(""))+this._rgbToHex(t[1].split(" ").join(""))+this._rgbToHex(t[2].split(" ").join(""))),n}},{key:"_rgbToHex",value:function(e){var t=Number(e).toString(16);return t.length<2&&(t="0"+t),t}},{key:"_showColorPalette",value:function(){var n=this,i=document.createElement("div");i.style.position="absolute",i.style.zIndex="99999",i.style.border="1px solid #e1e1e1",i.style.borderRadius="2px",i.style.backgroundColor="#f9f9f9",i.style.padding="4px 4px 0px 0px",i.style.outline="none",i.setAttribute("tabindex","123");var e=this.event.srcElement.getBoundingClientRect();i.style.left=e.left+parseInt(this.addToLeft)+"px",i.style.top=parseInt(this.addToTop)+window.scrollY+e.height+e.top+"px";var t=[];t.push(["#dfb9b1","#eecdcd","#f8e5d0","#fdf2d0","#dce9d5","#d3dfe2","#ccdaf5","#d2e1f1","#d8d2e7","#e6d2db"]),t.push(["#d08270","#de9c9b","#f2cca2","#fbe5a3","#bcd5ac","#a9c3c8","#a9c2f0","#a6c4e5","#b2a8d2","#cea8bc"]),t.push(["#bd4b31","#d16d6a","#ecb476","#ffefa1","#9dc284","#80a4ad","#779ee5","#7ba7d7","#8b7ebe","#b87f9e"]),t.push(["#982a15","#bb261a","#da944b","#eac251","#78a55a","#53808c","#4a79d1","#4f85c1","#6351a2","#9b5378"]),t.push(["#7a2817","#8c1a11","#a96324","#b89130","#48742c","#264e5b","#2657c5","#24538f","#312071","#6b2346"]);var o=document.createElement("div");o.style.display="flex",o.style.marginTop="2px",o.style.marginBottom="6px",["#000000","#39434d","#666666","#999999","#b7b7b7","#cccccc","#d9d9d9","#efefef","#ffffff","TRANSPARENT"].forEach(function(e){var t=n._getDomCell_colorPicker(e,i);o.appendChild(t)}),i.appendChild(o),t.forEach(function(e){(o=document.createElement("div")).style.display="flex",e.forEach(function(e){var t=n._getDomCell_colorPicker(e,i);o.appendChild(t)}),i.appendChild(o)});var r,s=document.createElement("div");s.style.display="flex",s.style.justifyContent="center",s.style.alignItems="center",s.style.cursor="pointer",s.style.fontFamily="Arial",s.style.padding="2px 4px 2px 4px",s.style.fontSize="14px",s.style.color="#999999",s.textContent="Custom",s.addEventListener("mouseover",function(){this.style.color="#30b7e8"}),s.addEventListener("mouseout",function(){this.style.color="#999999"}),s.addEventListener("click",function(){n.pnl.style.display="none",n.ShowCustomPanel()}),i.appendChild(s),0<this.usedCustomColors.length?((r=document.createElement("div")).style.display="flex",r.style.marginTop="2px",r.style.marginBottom="0px",this.usedCustomColors.forEach(function(e){var t=n._getDomCell_colorPicker(e,i);r.appendChild(t)}),i.appendChild(r)):s.style.padding="2px 4px 4px 4px",i.addEventListener("blur",function(){n.keepOnAfterSelection||this.parentNode.removeChild(this)}),document.body.appendChild(i),i.focus(),this.pnl=i}},{key:"_getDomCell_colorPicker",value:function(e){var t,n=this,i=e,o=this.selectedColor,r=void 0;return"TRANSPARENT"==e?((r=document.createElement("canvas")).width=13,r.height=13,r.style.border="2px solid #ffffff",r.style.margin="0px 0px 4px 4px ",r.style.borderRadius="2px",(t=r.getContext("2d")).fillStyle="#ffffff",t.fillRect(0,0,r.width,r.height),t.strokeStyle="#FF0000",t.lineWidth=2,t.beginPath(),t.moveTo(0,13),t.lineTo(13,0),t.stroke()):((r=document.createElement("div")).style.width="13px",r.style.height="13px",r.style.backgroundColor=i,r.style.margin="0px 0px 4px 4px ",r.style.borderRadius="2px",r.style.border=o==i?"2px solid #30b7e8":"2px solid "+i),r.addEventListener("mouseover",function(){this.style.cursor="pointer",this.style.border="2px solid #30b7e8"}),r.addEventListener("mouseout",function(){this.style.border=i!=o?"TRANSPARENT"==i?"2px solid #ffffff":"2px solid "+i:"2px solid #30b7e8"}),r.addEventListener("click",function(){if(n.callBack(i),!n.keepOnAfterSelection)try{n.pnl.parentNode.removeChild(n.pnl)}catch(e){}}),this.preserveFocus&&r.addEventListener("mousedown",function(e){e.preventDefault()}),r}},{key:"ShowCustomPanel",value:function(){var t=this;new r(this.pnl.style.left,this.pnl.style.top,function(e){t.usedCustomColors.indexOf(e)<0&&(t.usedCustomColors.push(e),10<t.usedCustomColors.length&&t.usedCustomColors.shift(),localStorage.setItem("usedCustomColors",JSON.stringify(t.usedCustomColors))),t.callBack(e),null===t.pnl.parentNode||t.pnl.parentNode.removeChild(t.pnl)})}}]),l),c=n(2),b=n(1);function l(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,o=4<arguments.length&&void 0!==arguments[4]?arguments[4]:void 0,r=5<arguments.length&&void 0!==arguments[5]&&arguments[5],s=6<arguments.length&&void 0!==arguments[6]&&arguments[6];a(this,l),this.event=e,this.callBack=t,this.preserveFocus=s,this.keepOnAfterSelection=r,this.addToLeft=n,this.addToTop=i,this.selectedColor=this._parseSelectedColor(o),this.usedCustomColors=[],"undefined"!=typeof Storage&&(this.usedCustomColors=JSON.parse(localStorage.getItem("usedCustomColors")),null==this.usedCustomColors&&(this.usedCustomColors=[])),this._showColorPalette()}function u(e,t,n){a(this,u),this.onChangeCallback=n;var i=document.createElement("div");i.style.position="absolute",i.style.zIndex="99999",i.style.border="1px solid #e1e1e1",i.style.borderRadius="2px",i.style.backgroundColor="#f9f9f9",i.style.padding="4px",i.style.left=e,i.style.top=t,i.style.outline="none",i.setAttribute("tabindex","3333"),i.addEventListener("blur",function(){this.parentNode.removeChild(this)}),this.canvas=document.createElement("canvas"),this.width=200,this.height=140,this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.style.cursor="pointer",this.context=this.canvas.getContext("2d"),this.pickerCircle={x:10,y:10,width:7,height:7},this.draw(),i.appendChild(this.canvas),this.previewbox=document.createElement("div"),this.previewbox.style.width="200px",this.previewbox.style.height="14px",this.previewbox.style.backgroundColor="rgba(0,0,0,0)",i.appendChild(this.previewbox),this.listenForEvents(),document.body.appendChild(i),i.focus(),this.panel=i}function h(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var d=(h(f.prototype,[{key:"Init",value:function(){var e=this,t=document.createElement("div");t.style.backgroundColor="#ffffff",t.style.width="180px",t.style.height="291px",t.style.borderRadius="2px",t.style.boxShadow="2px 2px 5px #e3e3e3",t.style.position="fixed";var n=this.event.clientX+4,i=this.event.clientY-60;i<0&&(i=1),i+291>window.innerHeight&&(i=window.innerHeight-295),t.style.left=n+"px",t.style.top=i+"px",t.style.overflow="hidden",t.style.zIndex="999";var o=document.createElement("input");o.style.opacity=0,o.style.position="absolute",o.style.width="0px",o.style.height="0px",this.keepAlive=!1,o.addEventListener("blur",function(){e.exitingRightBorder||(e._removeRequestNumberPanel(),setTimeout(function(){e.keepAlive||e.destroy()},200))}),this.inputForFocus=o,t.appendChild(o);var r="";1<this.spreadsheet.selectedNodes.length&&(r="s"),t=this._addMenuEntry(t,"addRowAbove","Insert Row(s) Above",!0),t=this._addMenuEntry(t,"addRowBelow","Insert Row(s) Below",!0),t=this._addMenuSpace(t),t=this._addMenuEntry(t,"addColLeft","Insert Column(s) Before",!0),t=this._addMenuEntry(t,"addColRight","Insert Column(s) After",!0),t=this._addMenuSpace(t),t=this._addMenuEntry(t,"delRow","Delete Row"+r),t=this._addMenuEntry(t,"delCol","Delete Column"+r),t=this._addMenuSpace(t),t=this._addMenuEntry(t,"cellBgColor","Background Color"),t=this._addMenuEntry(t,"borderColor","Border Color"),t=this._addMenuSpace(t),t=this._addMenuEntry(t,"distributeRows","Distribute Rows"),t=this._addMenuEntry(t,"distributeCols","Distribute Columns"),t=this._addMenuSpace(t),t=this._addMenuEntry(t,"formatCells","Format Cells"),document.body.appendChild(t),o.focus(),this.panel=t}},{key:"refreshFocus",value:function(){this.inputForFocus.focus()}},{key:"_addMenuEntry",value:function(e,t,n,i){var o=3<arguments.length&&void 0!==i&&i,r=this,s=document.createElement("div");return s.style.padding="6px 10px 6px 10px",s.style.fontFamily="Arial",s.style.fontSize="12px",s.style.margin="0px",s.style.cursor="pointer",s.style.backgroundColor="#ffffff",s.style.color="#828282",s.innerText=n,o?(s.addEventListener("mouseover",function(e){r.refreshFocus(),r._removeRequestNumberPanel(),this.style.backgroundColor="#FF9100",this.style.color="#ffffff",r._showRequestNumber(this,t),r.exitingRightBorder=!1}),s.addEventListener("mousemove",function(e){var t=this.getBoundingClientRect(),n=t.width,i=t.width-2;e.offsetX>=i&&e.offsetX<=n&&(r.exitingRightBorder=!0)})):(s.addEventListener("mouseover",function(e){r.exitingRightBorder=!1,this.style.backgroundColor="#FF9100",this.style.color="#ffffff"}),s.addEventListener("click",function(e){r.PerformAction(t)})),s.addEventListener("mouseout",function(e){r.exitingRightBorder||r._removeRequestNumberPanel(),this.style.backgroundColor="#ffffff",this.style.color="#828282"}),e.appendChild(s),e}},{key:"_addMenuSpace",value:function(e){var t=document.createElement("div");return t.style.height="1px",t.style.backgroundColor="#e3e3e3",e.appendChild(t),e}},{key:"_showRequestNumber",value:function(e,t){var n=this,i="Rows:";-1<t.indexOf("Col")&&(i="Cols:");var o=e.getBoundingClientRect(),r=document.createElement("div");r.style.backgroundColor="#ffffff",r.style.height=o.height+"px",r.style.borderRadius="0px 2px 2px 0px",r.style.boxShadow="2px 2px 5px #e3e3e3",r.style.display="flex",r.style.alignItems="center",r.style.zIndex="9999",r.style.fontFamily="Arial",r.style.fontSize="12px",r.style.color="#828282",r.style.position="fixed",r.style.top=o.top+"px",r.style.left=o.left+o.width+"px";var s=document.createElement("div");s.style.padding="0px 4px 0px 4px",s.textContent=i,r.appendChild(s);var a=document.createElement("input");a.style.display="block",a.style.width="40px",a.style.outline="none",a.style.border="1px solid #e1e1e1",a.style.borderRadius="3px",a.style.color="#828282",a.style.fontFamily="Arial",a.style.fontSize="12px",a.value=1,a.addEventListener("click",function(e){this.select()}),r.appendChild(a);var l=document.createElement("div");l.style.padding="0px 4px 0px 4px",l.style.cursor="pointer",l.style.fontWeight="bold",l.style.color="#30b7e8",l.textContent="add",l.addEventListener("click",function(e){n.PerformAction(t,a.value),n._removeRequestNumberPanel(),n.destroy()}),l.addEventListener("mouseover",function(e){this.style.color="#FF9100"}),l.addEventListener("mouseout",function(e){this.style.color="#30b7e8"}),r.appendChild(l),document.body.appendChild(r),this.additionalPnl=r}},{key:"_removeRequestNumberPanel",value:function(){null!=this.additionalPnl&&null!=this.additionalPnl.parentNode&&this.additionalPnl.parentNode.removeChild(this.additionalPnl)}},{key:"destroy",value:function(){this._removeRequestNumberPanel(),null!=this.panel.parentNode&&this.panel.parentNode.removeChild(this.panel)}},{key:"PerformAction",value:function(e,t){if(0<this.spreadsheet.selectedNodes.length){var n=this.spreadsheet.selectedNodes.length-1;switch(e){case"addRowAbove":if(0<t){for(;0<t;)this.AddRow("above",this.spreadsheet.selectedNodes[0]),t--;this.spreadsheet.PushToHistory()}break;case"addRowBelow":if(0<t){for(;0<t;)this.AddRow("below",this.spreadsheet.selectedNodes[n]),t--;this.spreadsheet.PushToHistory()}this.spreadsheet.PushToHistory();break;case"addColLeft":if(0<t){for(;0<t;)this.AddColumn("left",this.spreadsheet.selectedNodes[0]),t--;this.spreadsheet.PushToHistory()}this.spreadsheet.PushToHistory();break;case"addColRight":if(0<t){for(;0<t;)this.AddColumn("right",this.spreadsheet.selectedNodes[n]),t--;this.spreadsheet.PushToHistory()}this.spreadsheet.PushToHistory();break;case"delRow":this.DeleteRows(),this.spreadsheet.PushToHistory();break;case"delCol":this.DeleteColumns(),this.spreadsheet.PushToHistory();break;case"cellBgColor":this.ShowPicColorPanel();break;case"borderColor":this.ShowPicBorderColorPanel();break;case"distributeRows":this.DistributeRows(),this.spreadsheet.PushToHistory();break;case"distributeCols":this.DistributeCols(),this.spreadsheet.PushToHistory();break;case"fitToScreen":this.FitToScreen(),this.spreadsheet.PushToHistory();break;case"formatCells":this.OpenFormatCells(),this.spreadsheet.PushToHistory();break;default:return}}}},{key:"HideButKeepAlive",value:function(){this.keepAlive=!0,this.panel.style.display="none"}},{key:"ShowPicColorPanel",value:function(){this.HideButKeepAlive();var t=this;new s(this.event,function(e){t.ChangCellBgColor(e)},-20,6)}},{key:"ChangCellBgColor",value:function(t){this.spreadsheet.selectedNodes.forEach(function(e){e.domElement.style.backgroundColor=t}),this.spreadsheet.PushToHistory()}},{key:"ShowPicBorderColorPanel",value:function(){this.HideButKeepAlive();var t=this;new s(this.event,function(e){t.ChangBorderColor(e)},-20,6)}},{key:"ChangBorderColor",value:function(t){this.spreadsheet.selectedNodes.forEach(function(e){e.domElement.style.border="1px double "+t}),this.spreadsheet.PushToHistory()}},{key:"DistributeRows",value:function(){this.spreadsheet.rootNode.document;var i=this.spreadsheet.tableNode.domElement.getBoundingClientRect().height;this.spreadsheet.tableNode.children.forEach(function(e){var t,n;"tbody"==e.tagName.toLowerCase()&&(t=e.children.length,n=i/t,e.children.forEach(function(e){e.children.forEach(function(e){e.domElement.style.height=n+"px"})}))})}},{key:"DistributeCols",value:function(){this.spreadsheet.rootNode.document;var r=this.spreadsheet.tableNode.domElement.getBoundingClientRect().width;this.spreadsheet.tableNode.children.forEach(function(e){var i,o;"tbody"==e.tagName.toLowerCase()&&(i=!0,o=void 0,e.children.forEach(function(e){var t;i&&(i=!1,t=e.children.length-1,o=r/t);var n=!0;e.children.forEach(function(e){n?n=!1:e.domElement.style.width=o+"px"})}))})}},{key:"AddRow",value:function(e,t){var r=this;this.spreadsheet.DeselectAll(),this.spreadsheet.StopFunctionEditing();var n=this.spreadsheet.GetCoordinatesPerNode(t.id),s=n.row,i=n.row;"above"==e?i=n.row+1:"below"==e&&(s+=1);var a=A.AddRow(s,t.document,this.spreadsheet.GetNumberOfColumns()).tr,o=this.spreadsheet.GetNumberOfRows();s==o?this.spreadsheet.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.Append(a)}):this.spreadsheet.tableNode.children.forEach(function(t){var n,i,o;"tbody"==t.tagName.toLowerCase()&&(i=0,o=!(n=[]),t.children.forEach(function(e){e.children.forEach(function(e){c.a.AdjustAllRowsOnInsert(e,r.spreadsheet,s)}),i==s?(o=!0,n.push(a),i+=2):i++,o&&e.children[0].UpdateTextContent(i),n.push(e)}),t.children=[],n.forEach(function(e){t.Append(e)}))}),this.spreadsheet.Init(),t.GetFirstTextNode().SetFocus(),this.spreadsheet.SelectCell(i,n.col),this.spreadsheet.ShowAutofillHandle()}},{key:"DeleteRows",value:function(){var r=this;this.spreadsheet.StopFunctionEditing();var s=[],a=[];this.spreadsheet.selectedNodes.forEach(function(e){var t;s.indexOf(e.parent.id)<0&&(s.push(e.parent.id),t=r.spreadsheet.GetCoordinatesPerNode(e.id),a.push(t.row))});var e=this.spreadsheet.GetCoordinatesPerNode(this.spreadsheet.selectedNodes[0].id);this.spreadsheet.DeselectAll();var l=this.spreadsheet.rootNode.document;this.spreadsheet.tableNode.children.forEach(function(t){var n,i,o;"tbody"==t.tagName.toLowerCase()&&(i=0,o=!(n=[]),t.children.forEach(function(e){e.children.forEach(function(e){c.a.AdjustAllRowsOnDelete(e,r.spreadsheet,a)}),s.indexOf(e.id)<0?(i++,o&&e.children[0].UpdateTextContent(i),n.push(e)):(l.DeleteNode(e),o=!0)}),t.children=[],n.forEach(function(e){t.Append(e)}))}),this.spreadsheet.Init(),this.spreadsheet.functionsManager.RecalculateAll();try{var t=this.spreadsheet.GetNodePerCoordinates(e.row,e.col);this.spreadsheet.SelectCell(e.row,e.col),t.GetFirstTextNode().SetFocus()}catch(e){}}},{key:"AddColumn",value:function(e,r){var o=this;this.spreadsheet.DeselectAll(),this.spreadsheet.StopFunctionEditing();var t=this.spreadsheet.GetCoordinatesPerNode(r.id),s=parseInt(t.col);"left"==e||"right"==e&&(s=parseInt(t.col+1));var n=this.spreadsheet.GetNumberOfColumns();this.spreadsheet.tableNode.children.forEach(function(e){"thead"==e.tagName.toLowerCase()?s==n?e.children.forEach(function(e){e.Append(A.AddCellColumn(r.document,s))}):e.children.forEach(function(t){var n=[],i=0,o=!1;t.children.forEach(function(e){i==s&&(o=!0,n.push(A.AddCellColumn(r.document,s))),i++,o&&e.UpdateTextContent(A.toColumnName(i)),n.push(e)}),t.children=[],n.forEach(function(e){t.Append(e)})}):"tbody"==e.tagName.toLowerCase()&&(s==n?e.children.forEach(function(e){e.Append(A.AddNormalCell(r.document))}):e.children.forEach(function(t){var n=[],i=0;t.children.forEach(function(e){c.a.AdjustAllColsOnInsert(e,o.spreadsheet,s),i==s&&n.push(A.AddNormalCell(r.document)),i++,n.push(e)}),t.children=[],n.forEach(function(e){t.Append(e)})}))}),this.spreadsheet.Init(),r.GetFirstTextNode().SetFocus(),t=this.spreadsheet.GetCoordinatesPerNode(r.id),this.spreadsheet.SelectCell(t.row,t.col),this.spreadsheet.ShowAutofillHandle()}},{key:"DeleteColumns",value:function(){var o=this;this.spreadsheet.StopFunctionEditing();var s=[];this.spreadsheet.selectedNodes.forEach(function(e){var t=o.spreadsheet.GetCoordinatesPerNode(e.id);s.indexOf(t.col)<0&&s.push(t.col)});var e=this.spreadsheet.GetCoordinatesPerNode(this.spreadsheet.selectedNodes[0].id);this.spreadsheet.DeselectAll();var a=this.spreadsheet.rootNode.document;this.spreadsheet.tableNode.children.forEach(function(e){"thead"==e.tagName.toLowerCase()?e.children.forEach(function(t){var n=[],i=0,o=!1,r=0;t.children.forEach(function(e){-1<s.indexOf(i)?(a.DeleteNode(e),o=!0):(o&&e.UpdateTextContent(A.toColumnName(r)),n.push(e),r++),i++}),t.children=[],n.forEach(function(e){t.Append(e)})}):"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(t){var n=[],i=0;t.children.forEach(function(e){c.a.AdjustAllColsOnDelete(e,o.spreadsheet,s),-1<s.indexOf(i)?a.DeleteNode(e):n.push(e),i++}),t.children=[],n.forEach(function(e){t.Append(e)})})}),this.spreadsheet.Init(),this.spreadsheet.functionsManager.RecalculateAll();try{var t=this.spreadsheet.GetNodePerCoordinates(e.row,e.col);this.spreadsheet.SelectCell(e.row,e.col),t.GetFirstTextNode().SetFocus()}catch(e){}}},{key:"OpenFormatCells",value:function(){b.a.OpenFormatDialog(this.spreadsheet)}}]),f);function f(e,t,n){!function(e){if(!(e instanceof f))throw new TypeError("Cannot call a class as a function")}(this),this.spreadsheet=e,this.td=t,this.event=n,this.additionalPnl=void 0,this.inputForFocus=void 0,this.Init()}function p(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var g=(p(m.prototype,[{key:"SetPrecision",value:function(e){null==e&&(e=4),this.precision=parseInt(e)}},{key:"_round",value:function(e){return Number(Math.round(e+"e"+this.precision)+"e-"+this.precision)}},{key:"_isNumber",value:function(e){var t=e;return"-"==e[0]&&(t=e.replace("-","")),/^[0-9.]*$/.test(t)}},{key:"LineFitter",value:function(e,t,n){for(var i=2<arguments.length&&void 0!==n?n:"after",o=0,r=0,s=0,a=0,l=0,c=0;c<e.length;c++){var u=e[c];o++,r+=c,s+=c*c,a+=c*u,l+=u}var h=o*s-r*r,d=(s*l-r*a)/h,f=(o*a-r*l)/h,p=new Array;if("after"==i)for(var g=e.length,m=g+t;g<m;)p.push(this._round(d+g*f)),g++;else for(var v=-1,y=v-t;y<v;)p.push(this._round(d+v*f)),v--;return p}},{key:"_debugPrintSet",value:function(e){console.log("----------------------"),e.forEach(function(e){var t="",n="";e.originals.forEach(function(e){t+=e.id+" "}),e.toFill.forEach(function(e){n+=e.id+" "}),console.log("originals: "+t),console.log("toFill: "+n),console.log("")}),console.log("----------------------")}},{key:"PerformAutofill",value:function(){var n,i,o,r,u=this,e=this.spreadsheet.selectedNodes,s=this.spreadsheet.originalNodesForAutofill,h=this.spreadsheet.autofillSelectionDirection,a=[];-1<h.indexOf("row-right")||-1<h.indexOf("row-left")?(n=void 0,i=new Array,o=new Array,e.forEach(function(e){var t=u.spreadsheet.GetCoordinatesPerNode(e.id);null==n&&(n=t.row),n!=t.row&&(n=t.row,a.push({originals:i,toFill:o}),i=new Array,o=new Array),s.indexOf(e.id)<0?o.push(e):i.push(e)}),a.push({originals:i,toFill:o})):(-1<h.indexOf("col-up")||-1<h.indexOf("col-down"))&&(r={},e.forEach(function(e){var t=u.spreadsheet.GetCoordinatesPerNode(e.id);null==r[t.col]&&(r[t.col]={originals:new Array,toFill:new Array}),s.indexOf(e.id)<0?r[t.col].toFill.push(e):r[t.col].originals.push(e)}),Object.keys(r).forEach(function(e){a.push(r[e])})),a.forEach(function(e){var i,t,n,o,r,s=!1,a=!1,l=[],c=[];e.originals.forEach(function(e){var t,n=e.domElement.getAttribute("cell-function"),i=e.domElement.getAttribute("cell-format");c.push(i),null!=n?(a=!0,l.push(n)):(t=e.domElement.textContent,u._isNumber(t)?l.push(parseFloat(t)):(s=!0,l.push(t)))}),1!=l.length||a||(s=!0),s||a?(-1<h.indexOf("row-right")||-1<h.indexOf("col-down")||(-1<h.indexOf("row-left")||-1<h.indexOf("col-up"))&&(e.toFill=e.toFill.reverse(),l=l.reverse()),i=0,e.toFill.forEach(function(e){var t=l[i];null==t&&(t=l[i=0]);var n=c[i];null!=n&&""!=n&&e.domElement.setAttribute("cell-format",n),a?u.spreadsheet.functionsManager.CopyFunctionToNode(t,e):(e.GetFirstTextNode().ForceTextContent(t),b.a.Format(e),u.spreadsheet.functionsManager.CellValueChanged(e)),i++})):(t=e.toFill.length,n="",-1<h.indexOf("row-right")||-1<h.indexOf("col-down")?n="after":(-1<h.indexOf("row-left")||-1<h.indexOf("col-up"))&&(n="before",e.toFill=e.toFill.reverse()),o=u.LineFitter(l,t,n),r=0,e.toFill.forEach(function(e){var t=o[r],n=c[r];null!=n&&""!=n&&e.domElement.setAttribute("cell-format",n),e.GetFirstTextNode().ForceTextContent(t.toString()),b.a.Format(e),u.spreadsheet.functionsManager.CellValueChanged(e),r++}))})}}]),m);function m(e,t){!function(e){if(!(e instanceof m))throw new TypeError("Cannot call a class as a function")}(this),this.spreadsheet=e,this.SetPrecision(t)}function v(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var C=(v(x.prototype,[{key:"DownloadCsv",value:function(){var e=this.spreadsheet.Export(),i="";e.forEach(function(e){var t="",n=!0;e.forEach(function(e){n?(t=e,n=!1):t+=',"'+e.replace(/"/g,'""')+'"'}),i+=t+"\r\n"});var t=encodeURI("data:text/csv;charset=utf-8,"+i),n=document.createElement("a");n.setAttribute("href",t),n.setAttribute("download","myData.csv"),document.body.appendChild(n),n.click(),document.body.removeChild(n)}},{key:"UploadCsv",value:function(){var i=this;this.input=document.createElement("input"),this.input.type="file",document.body.appendChild(this.input),this.input.addEventListener("change",function(e){var t,n;this.files&&this.files[0]&&(t=this.files[0],(n=new FileReader).addEventListener("load",function(e){var t=e.target.result;i.ImportCsv(t)}),n.readAsBinaryString(t)),i.RemoveInput()}),this.input.click()}},{key:"RemoveInput",value:function(){document.body.removeChild(this.input)}},{key:"ImportCsv",value:function(e){for(var t=this._guessLineEndings(e),n=this._guessDelimiter(e,t),i=[],o=e.split(t),r=0;r<o.length;r++){var s=o[r];"#"!==s.substr(0,1)&&i.push(s.split(n))}this.spreadsheet.Import(i)}},{key:"_guessLineEndings",value:function(e,t){var n=1<arguments.length&&void 0!==t?t:'"';e=e.substr(0,1048576);var i=new RegExp(this._escapeRegExp(n)+"([^]*?)"+this._escapeRegExp(n),"gm"),o=(e=e.replace(i,"")).split("\r"),r=e.split("\n"),s=1<r.length&&r[0].length<o[0].length;if(1===o.length||s)return"\n";for(var a=0,l=0;l<o.length;l++)"\n"===o[l][0]&&a++;return a>=o.length/2?"\r\n":"\r"}},{key:"_escapeRegExp",value:function(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}},{key:"_testEmptyLine",value:function(e){return 1===e.length&&0===e[0].length}},{key:"_guessDelimiter",value:function(e,t){for(var n,i,o,r=[",","\t","|",";",String.fromCharCode(30),String.fromCharCode(31)],s=0;s<r.length;s++){for(var a,l=r[s],c=0,u=0,h=0,d=void 0,f=e.split(t),p=0;p<f.length;p++)this._testEmptyLine(f[p])?h++:(u+=a=f[p].length,void 0!==d?0<a&&(c+=Math.abs(a-d),d=a):d=a);0<f.length&&(u/=f.length-h),(void 0===i||c<=i)&&(void 0===o||o<u)&&1.99<u&&(i=c,n=l,o=u)}return n}}]),x);function x(e){!function(e){if(!(e instanceof x))throw new TypeError("Cannot call a class as a function")}(this),this.spreadsheet=e}function w(e){return(w="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function S(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _(e,t,n){return t&&S(e.prototype,t),n&&S(e,n),e}function E(e,t){return(E=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function T(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function k(e){return(k=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var O=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&E(e,t)}(m,y.Plugin);var i,o,n=(i=m,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t,n=k(i);return!(t=o?(e=k(this).constructor,Reflect.construct(n,arguments,e)):n.apply(this,arguments))||"object"!==w(t)&&"function"!=typeof t?T(this):t});function m(e){var t;return function(e){if(!(e instanceof m))throw new TypeError("Cannot call a class as a function")}(this),(t=n.call(this,e,!0)).isMouseDown=!1,t.isMouseOnRightBorder=!1,t.isMouseOnBottomBorder=!1,t.currentColResizing=void 0,t.currentRowResizing=void 0,t.startNode=void 0,t.endNode=void 0,t.selectedNodes=[],t.allSelectedRows=new Array,t.allSelectedCols=new Array,t.minSelectedRow=0,t.minSelectedCol=0,t.numberOfRows=0,t.numberOfColumns=0,t.tableNode=void 0,t.autofillHandle=void 0,t.isMovingAutofillHandle=!1,t.originalNodesForAutofill=new Array,t.autofillSelectionDirection="",t.prevPageX=void 0,t.prevPageY=void 0,t.coordinatesPerNode=new Array,t.nodePerCoordinates=new Array,t.autofillManager=new g(T(t)),t.functionsManager=new c.a(T(t)),t.csvManager=new C(T(t)),t.editingFunction=!1,t.readOnly=t.rootNode.document.readOnly,t.InitializeDomElements(),t}return _(m,null,[{key:"GetName",value:function(){return"spreadsheet"}}]),_(m,[{key:"PluginDidMount",value:function(){this.readOnly?this.InitReadOnly():this.Init()}},{key:"InitReadOnly",value:function(){this.HideAutofillHandle(),this.fxInput=this.rootNode.children[0].children[1],null!=this.fxInput&&(this.fxInput.domElement.style.opacity="0.2",this.fxInput.domElement.readOnly=!0)}},{key:"Init",value:function(){"table"==this.rootNode.tagName&&this.TransformTableInSpreadsheet();var n=this;this.HideAutofillHandle(),this.coordinatesPerNode=new Array,this.nodePerCoordinates=new Array,this.coordinatesPerNodeHeader=new Array,this.nodeHeaderPerCoordinates=new Array,this.functionsManager.Reset(),this.fxLabel=this.rootNode.children[0].children[0],this.fxInput=this.rootNode.children[0].children[1];var e=this.rootNode.children[0].children[2].domElement,t=this.rootNode.children[0].children[3].domElement;function i(e){n.isMouseDown&&(n.isMouseOnRightBorder?n.ResizeColumn(e):n.isMouseOnBottomBorder&&n.ResizeRow(e))}this._prepareUploadDownloadButtons(t,e),this.functionsManager.SetInputNode(this.fxInput),this.functionsManager.SetFxLabelNode(this.fxLabel);var o=0,r=0;this.rootNode.parent.domElement.removeEventListener("mousemove",i),this.rootNode.parent.domElement.addEventListener("mousemove",i),this.rootNode.children.forEach(function(e){var t;"table"==e.tagName.toLowerCase()&&(n.tableNode=e,t=n.tableNode.domElement.getAttribute("cm-sh-precision"),n.autofillManager.SetPrecision(t),n.functionsManager.SetPrecision(t),n.tableNode.children.forEach(function(e){"thead"==e.tagName.toLowerCase()?e.children.forEach(function(e){r=0,e.children.forEach(function(e){0<r&&(n.coordinatesPerNodeHeader[r]=e,n.nodeHeaderPerCoordinates[e.id]=r,n.InitHeaderCell(e.id,e.domElement,r)),r++})}):"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){r=0,e.children.forEach(function(e){n.functionsManager.TrackCell(e,o,r),n.InitCell(e.id,e.domElement,o,r),null==n.coordinatesPerNode[o]&&(n.coordinatesPerNode[o]=new Array),n.coordinatesPerNode[o][r]=e,n.nodePerCoordinates[e.id]={col:r,row:o},r++}),o++})}))}),this.numberOfRows=o,this.numberOfColumns=r,this.cellsResized=!1}},{key:"InitHeaderCell",value:function(e,t){var u=this;null==this.mousedownHeaderFunction&&(this.mousedownHeaderFunction=function(e){var t=u.nodeHeaderPerCoordinates[u.GetNodeFromDom(this).id];u.prevX=e.pageX+window.scrollX,u.prevY=e.pageY+window.scrollY,0==e.button&&(u.isMouseDownHeader=!0,u.startColNode=u.coordinatesPerNodeHeader[t],u.startCol=t,u.endCol=void 0,u.SelectCol(t))}),null==this.mousemoveHeaderFunction&&(this.mousemoveHeaderFunction=function(e){var t,n,i,o,r,s,a,l,c=u.nodeHeaderPerCoordinates[u.GetNodeFromDom(this).id];0==e.button&&u.isMouseDownHeader&&(n=(t=u.startColNode.domElement.getBoundingClientRect()).height,i=t.width,o=t.top,r=t.left,s=e.pageY+window.scrollY,a=e.pageX+window.scrollX,o<s&&s<o+n&&r<a&&a<r+i||(window.getSelection&&document.createRange?(l=window.getSelection()).empty?l.empty():l.removeAllRanges&&l.removeAllRanges():document.selection&&(l=document.selection.createRange()).empty(),u.SelectColOnDrag(c),e.preventDefault()))}),null==this.mouseupHeaderFunction&&(this.mouseupHeaderFunction=function(e){var t=u.nodeHeaderPerCoordinates[u.GetNodeFromDom(this).id];0==e.button&&(u.isMouseDownHeader=!1,u.endNode=u.GetNodeFromDom(this),u.endCol=t,u.ShowAutofillHandle())}),t.removeEventListener("mousedown",this.mousedownHeaderFunction),t.addEventListener("mousedown",this.mousedownHeaderFunction),t.removeEventListener("mousemove",this.mousemoveHeaderFunction),t.addEventListener("mousemove",this.mousemoveHeaderFunction),t.removeEventListener("mouseup",this.mouseupHeaderFunction),t.addEventListener("mouseup",this.mouseupHeaderFunction)}},{key:"InitCell",value:function(e,t){var v=this;null==this.contextmenuFunction&&(this.contextmenuFunction=function(e){var t=v.GetCoordinatesPerNode(v.GetNodeFromDom(this).id);0==v.selectedNodes.length?v.SelectCell(t.row,t.col,!0):1==v.selectedNodes.length&&v.SelectCell(t.row,t.col,!1),v.OpenSettingsPanel(this,e),e.preventDefault(),e.stopPropagation()}),v.clicks=0,v.useArrowsForText=!0,null==this.mousedownFunction&&(this.mousedownFunction=function(e){v.clicks++,1===v.clicks?v.singleClickTimer=setTimeout(function(){v.clicks=0,v.useArrowsForText=!0},300):2===v.clicks&&(clearTimeout(v.singleClickTimer),v.clicks=0,v.useArrowsForText=!1);var t=v.GetCoordinatesPerNode(v.GetNodeFromDom(this).id);v.prevX=e.pageX+window.scrollX,v.prevY=e.pageY+window.scrollY,v.editingFunction&&v.functionsManager.GetIdCurrentCell()==v.GetNodeFromDom(this).id&&v.StopFunctionEditing(),v.editingFunction?(v.isMouseDown=!0,v.startNode=v.GetNodeFromDom(this),v.startNode.row=t.row,v.startNode.col=t.col,v.endNode=void 0,v.SelectCellForFunctionEditing(t.row,t.col,!0)):0==e.button&&(v.isMouseDown=!0,v.startNode=v.GetNodeFromDom(this),v.startNode.row=t.row,v.startNode.col=t.col,v.endNode=void 0,0==t.col?(v.selectingRow=!0,v.SelectRow(t.row)):v.SelectCell(t.row,t.col))}),null==this.mousemoveFunction&&(this.mousemoveFunction=function(e){var t,n,i,o,r,s,a,l,c,u,h,d,f,p,g,m=v.GetCoordinatesPerNode(v.GetNodeFromDom(this).id);v.editingFunction?v.isMouseDown&&(o=(t=v.startNode.domElement.getBoundingClientRect()).height,r=t.width,s=t.top,a=t.left,l=e.pageY+window.scrollY,c=e.pageX+window.scrollX,s<l&&l<s+o&&a<c&&c<a+r||(window.getSelection&&document.createRange?(u=window.getSelection()).empty?u.empty():u.removeAllRanges&&u.removeAllRanges():document.selection&&(u=document.selection.createRange()).empty(),v.userSelectedOnDrag=!0,v.SelectOnDragForFunctionEditing(m.row,m.col),e.preventDefault())):v.isMovingAutofillHandle?(o=(n=v.startNode.domElement.getBoundingClientRect()).height,r=n.width,s=n.top,a=n.left,l=e.pageY+window.scrollY,c=e.pageX+window.scrollX,s<l&&l<s+o&&a<c&&c<a+r||(window.getSelection&&document.createRange?(u=window.getSelection()).empty?u.empty():u.removeAllRanges&&u.removeAllRanges():document.selection&&(u=document.selection.createRange()).empty(),v.userSelectedOnDrag=!0,v.SelectForAutofill(e,m.row,m.col),e.preventDefault()),e.preventDefault()):0==e.button&&(v.isMouseDown?v.isMouseOnRightBorder||v.isMouseOnBottomBorder||(o=(i=v.startNode.domElement.getBoundingClientRect()).height,r=i.width,s=i.top,a=i.left,l=e.pageY+window.scrollY,c=e.pageX+window.scrollX,s<l&&l<s+o&&a<c&&c<a+r||(window.getSelection&&document.createRange?(u=window.getSelection()).empty?u.empty():u.removeAllRanges&&u.removeAllRanges():document.selection&&(u=document.selection.createRange()).empty(),v.userSelectedOnDrag=!0,v.selectingRow?v.SelectRowOnDrag(m.row):v.SelectOnDrag(m.row,m.col),e.preventDefault())):(d=(h=this.getBoundingClientRect()).width,f=h.width-4,e.offsetX>=f&&e.offsetX<=d?(v.isMouseOnRightBorder=!0,v.currentColResizing=m.col,this.style.cursor="col-resize"):(v.isMouseOnRightBorder=!1,v.currentColResizing=void 0,this.style.cursor="auto"),v.isMouseOnRightBorder||(p=h.height,g=h.height-4,e.offsetY>=g&&e.offsetY<=p?(v.isMouseOnBottomBorder=!0,v.currentRowResizing=m.row,this.style.cursor="row-resize"):(v.isMouseOnBottomBorder=!1,v.currentRowResizing=void 0,this.style.cursor="auto"))))}),null==this.mouseupFunction&&(this.mouseupFunction=function(e){v.cellsResized&&(v.cellsResized=!1,v.PushToHistory());var t=v.GetCoordinatesPerNode(v.GetNodeFromDom(this).id);v.selectingRow=!1,v.editingFunction?(v.functionsManager.DoneSelectingCells(),v.fxInput.domElement.focus()):1==v.selectedNodes.length&&v.functionsManager.SetEditingCell(v.selectedNodes[0]),v.isMovingAutofillHandle?(document.body.style.caretColor="auto",v.rootNode.document.RestoreCursorPositionBeforeClick(),v.isMovingAutofillHandle=!1,v.ShowAutofillHandle(),v.autofillManager.PerformAutofill(),v.PushToHistory()):0==e.button&&(v.isMouseDown=!1,v.endNode=v.GetNodeFromDom(this),v.endNode.row=t.row,v.endNode.col=t.col,v.userSelectedOnDrag&&(v.userSelectedOnDrag=!1),v.ShowAutofillHandle())}),t.removeEventListener("contextmenu",this.contextmenuFunction),t.addEventListener("contextmenu",this.contextmenuFunction),t.removeEventListener("mousedown",this.mousedownFunction),t.addEventListener("mousedown",this.mousedownFunction),t.removeEventListener("mousemove",this.mousemoveFunction),t.addEventListener("mousemove",this.mousemoveFunction),t.removeEventListener("mouseup",this.mouseupFunction),t.addEventListener("mouseup",this.mouseupFunction)}},{key:"_prepareUploadDownloadButtons",value:function(e,t){var n=this;null==this.uploadCsvFnc&&(this.uploadCsvFnc=function(e){n.csvManager.UploadCsv()}),null==this.downloaCsvFnc&&(this.downloaCsvFnc=function(e){n.csvManager.DownloadCsv()}),e.removeEventListener("click",this.uploadCsvFnc),e.addEventListener("click",this.uploadCsvFnc),t.removeEventListener("click",this.downloaCsvFnc),t.addEventListener("click",this.downloaCsvFnc)}},{key:"PushToHistory",value:function(){this.rootNode.document.PushToHistory()}},{key:"GetCoordinatesPerNode",value:function(e){return this.nodePerCoordinates[e]}},{key:"GetNodePerCoordinates",value:function(e,t){return this.coordinatesPerNode[e][t]}},{key:"GetNumberOfColumns",value:function(){return this.coordinatesPerNode[0].length}},{key:"GetNumberOfRows",value:function(){return this.coordinatesPerNode.length}},{key:"GetValue",value:function(e,t){var n=(n=this.GetNodePerCoordinates(e,t).domElement.textContent).replace("Â ",""),i=parseFloat(n);return isNaN(i)?n:i}},{key:"GetValues",value:function(e,t,n,i){var o=[];i+=1;for(var r=0;r<=this.coordinatesPerNode.length;r++)if(e<=r&&r<=n)for(var s,a,l=0;l<=this.coordinatesPerNode[r].length;l++)t<=l&&l<i&&(s=this.GetNodePerCoordinates(r,l).domElement.textContent.replace("Â ",""),a=parseFloat(s),isNaN(a)?o.push(s):o.push(a));return o}},{key:"HideAutofillHandle",value:function(){null!=this.autofillHandle&&null!=this.autofillHandle.parentNode&&this.autofillHandle.parentNode.removeChild(this.autofillHandle),this.autofillHandle=void 0}},{key:"ShowAutofillHandle",value:function(){var e,t,n,i;0<this.selectedNodes.length&&!this.editingFunction&&(null==this.startNode&&(this.startNode=this.selectedNodes[0]),this.autofillHandle=document.createElement("div"),this.autofillHandle.setAttribute("class","csTableAutofillHandle"),this.autofillHandle.setAttribute("contentEditable","false"),e=this.selectedNodes.length-1,t=this.selectedNodes[e].domElement.getBoundingClientRect(),n=this.rootNode.domElement.getBoundingClientRect(),this.autofillHandle.style.top=t.top-n.top+t.height-3+"px",this.autofillHandle.style.left=t.left+t.width-n.left-3+"px",(i=this).autofillHandle.addEventListener("mousedown",function(e){document.body.style.caretColor="transparent",i.prevPageX=e.pageX,i.prevPageY=e.pageY,i.rootNode.document.SaveCursorPositonBeforeClick(),i.isMovingAutofillHandle=!0,i.allSelectedRows=new Array,i.allSelectedCols=new Array,i.minSelectedRow=void 0,i.minSelectedCol=void 0,i.originalNodesForAutofill=new Array,i.selectedNodes.forEach(function(e){i.originalNodesForAutofill.push(e.id);var t=i.GetCoordinatesPerNode(e.id);i.allSelectedRows.indexOf(t.row)<0&&(i.allSelectedRows.push(t.row),(null==i.minSelectedRow||i.minSelectedRow>t.row)&&(i.minSelectedRow=t.row)),i.allSelectedCols.indexOf(t.col)<0&&(i.allSelectedCols.push(t.col),(null==i.minSelectedCol||i.minSelectedCol>t.col)&&(i.minSelectedCol=t.col))})}),this.autofillHandle.addEventListener("mouseup",function(e){document.body.style.caretColor="auto",i.isMovingAutofillHandle=!1,i.rootNode.document.RestoreCursorPositionBeforeClick()}),this.rootNode.domElement.appendChild(this.autofillHandle))}},{key:"ResizeRow",value:function(o){var e,t,r,s,a;null!=this.currentRowResizing&&(window.getSelection&&document.createRange?(e=window.getSelection()).empty?e.empty():e.removeAllRanges&&e.removeAllRanges():document.selection&&(e=document.selection.createRange()).empty(),s=!(t=0),a=0,(r=this).tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&(t=0,e.children.forEach(function(e){t==r.currentRowResizing&&e.children.forEach(function(e){var t,n,i;s&&(t=e.domElement.getBoundingClientRect(),i=(n=o.pageY)-r.prevY,a=t.height+i,r.prevY=n,s=!1),e.domElement.style.height=a+"px",r.cellsResized=!0}),t++}))}))}},{key:"ResizeColumn",value:function(r){var e,s,a,l,c,u,h;null!=this.currentColResizing&&(window.getSelection&&document.createRange?(e=window.getSelection()).empty?e.empty():e.removeAllRanges&&e.removeAllRanges():document.selection&&(e=document.selection.createRange()).empty(),u=c=s=0,h=!(l=!0),(a=this).tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){s=0,e.children.forEach(function(e){var t,n,i,o;s==a.currentColResizing&&(l&&(t=e.domElement.getBoundingClientRect(),i=(n=r.pageX)-a.prevX,c=t.width+i,a.prevX=n,null!=e.next&&(h=!0,o=e.next.domElement.getBoundingClientRect(),u=o.width-i),l=!1),e.domElement.style.width=c+"px",h&&null!=e.next&&(e.next.domElement.style.width=u+"px"),a.cellsResized=!0),s++})})}))}},{key:"SelectRowOnDrag",value:function(t){var n,i,o,r,s;(null==this.endNode?this.startNode.row:this.endNode.row)!=t&&(this.DeselectAll(),n="up",(i=this.startNode.row)<=t&&(n="down"),r=o=0,(s=this).tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){r=0,e.children.forEach(function(e){"down"==n?i<=o&&o<=t&&s.SelectCell(o,r,!0):"up"==n&&t<=o&&o<=i&&s.SelectCell(o,r,!0),r++}),o++})}))}},{key:"SelectColOnDrag",value:function(t){var n,i,o,r,s;(null==this.endCol?this.startCol:this.endCol)!=t&&(this.DeselectAll(),n="left",(i=this.startCol)<=t&&(n="right"),r=o=0,(s=this).tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){r=0,e.children.forEach(function(e){"right"==n?i<=r&&r<=t&&s.SelectCell(o,r,!0):"left"==n&&t<=r&&r<=i&&s.SelectCell(o,r,!0),r++}),o++})}))}},{key:"SelectRow",value:function(t,e){null!=e&&0!=e||this.DeselectAll();var n=0,i=this;this.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){e.children.forEach(function(e){n==t&&e.domElement.className.indexOf("commaSpreadsheetCellCounter")<0&&(e.domElement.className="commaSpreadsheetCellSelected",i.selectedNodes.push(e))}),n++})})}},{key:"SelectCol",value:function(t,e){null!=e&&0!=e||this.DeselectAll();var n=0,i=this;this.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){n=0,e.children.forEach(function(e){n==t&&e.domElement.className.indexOf("commaSpreadsheetCellCounter")<0&&(e.domElement.className="commaSpreadsheetCellSelected",i.selectedNodes.push(e)),n++})})})}},{key:"SelectCell",value:function(t,n,e,i){var o=3<arguments.length&&void 0!==i&&i;null!=e&&0!=e||this.DeselectAll();var r=0,s=0,a=this;this.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){s=0,e.children.forEach(function(e){r==t&&s==n&&e.domElement.className.indexOf("commaSpreadsheetCellCounter")<0&&(e.domElement.className=o?"commaSpreadsheetCellAutofillSelected":"commaSpreadsheetCellSelected",a.selectedNodes.push(e)),s++}),r++})})}},{key:"DeselectAll",value:function(){this.StopFunctionEditing(),this.HideAutofillHandle(),this.selectedNodes=[],null!=this.tableNode&&this.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){e.children.forEach(function(e){e.domElement.className.indexOf("commaSpreadsheetCellCounter")<0&&(e.domElement.className="commaSpreadsheetCell")})})})}},{key:"SelectOnDrag",value:function(t,n){var i,o,r,s,a,l,e=0,c=null==this.endNode?(e=this.startNode.row,this.startNode.col):(e=this.endNode.row,this.endNode.col);e==t&&c==n||(this.DeselectAll(),i=this.startNode.row,o=this.startNode.col,r=i<=t&&o<=n?"right":t<=i&&o<n?"topRight":i<=t&&n<=o?"bottomLeft":"left",a=s=0,(l=this).tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){a=0,e.children.forEach(function(e){"right"==r?i<=s&&s<=t&&o<=a&&a<=n&&l.SelectCell(s,a,!0):"left"==r?t<=s&&s<=i&&n<=a&&a<=o&&l.SelectCell(s,a,!0):"topRight"==r?s<=i&&t<=s&&o<=a&&a<=n&&l.SelectCell(s,a,!0):"bottomLeft"==r&&i<=s&&s<=t&&a<=o&&n<=a&&l.SelectCell(s,a,!0),a++}),s++})}))}},{key:"SelectForAutofill",value:function(e,t,n){this.DeselectAll();var i=e.pageX,o=e.pageY,r=i-this.prevPageX,s=o-this.prevPageY,a=Math.abs(r)<Math.abs(s)?0<s?"col-down":"col-up":0<r?"row-right":"row-left";this.autofillSelectionDirection=a;var l=0,c=0,u=this;this.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){l=0,e.children.forEach(function(e){"row-left"==a?-1<u.allSelectedRows.indexOf(c)&&(-1<u.allSelectedCols.indexOf(l)||l<=u.minSelectedCol&&n<=l)&&u.SelectCell(c,l,!0,!0):"row-right"==a?-1<u.allSelectedRows.indexOf(c)&&(-1<u.allSelectedCols.indexOf(l)||l>=u.minSelectedCol&&l<=n)&&u.SelectCell(c,l,!0,!0):"col-down"==a?-1<u.allSelectedCols.indexOf(l)&&(-1<u.allSelectedRows.indexOf(c)||c>=u.minSelectedRow&&c<=t)&&u.SelectCell(c,l,!0,!0):"col-up"==a&&-1<u.allSelectedCols.indexOf(l)&&(-1<u.allSelectedRows.indexOf(c)||c<=u.minSelectedRow&&t<=c)&&u.SelectCell(c,l,!0,!0),l++}),c++})})}},{key:"SelectOnDragForFunctionEditing",value:function(t,n){this.DeselectAllForFunctionEditing(),this.functionsManager.ClearCurrentRange();var i,o,r,s,a,l,e=0,c=null==this.endNode?(e=this.startNode.row,this.startNode.col):(e=this.endNode.row,this.endNode.col);e==t&&c==n||(i=this.startNode.row,o=this.startNode.col,r=i<=t&&o<=n?"right":t<=i&&o<n?"topRight":i<=t&&n<=o?"bottomLeft":"left",a=s=0,(l=this).tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){a=0,e.children.forEach(function(e){"right"==r?i<=s&&s<=t&&o<=a&&a<=n&&l.SelectCellForFunctionEditing(s,a):"left"==r?t<=s&&s<=i&&n<=a&&a<=o&&l.SelectCellForFunctionEditing(s,a):"topRight"==r?s<=i&&t<=s&&o<=a&&a<=n&&l.SelectCellForFunctionEditing(s,a):"bottomLeft"==r&&i<=s&&s<=t&&a<=o&&n<=a&&l.SelectCellForFunctionEditing(s,a),a++}),s++})}))}},{key:"SelectCellForFunctionEditing",value:function(t,n,e){var i=0,o=0,r=this;2<arguments.length&&void 0!==e&&e&&(this.useHighlightClass=this.functionsManager.StartSelectingCells());var s=this.functionsManager.GetCurrentCell(),a=this.GetCoordinatesPerNode(s.id);a.row==t&&a.col==n||this.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){o=0,e.children.forEach(function(e){i==t&&o==n&&e.domElement.className.indexOf("commaSpreadsheetCellCounter")<0&&(e.domElement.className=r.useHighlightClass,r.functionsManager.AddCell(t,n)),o++}),i++})})}},{key:"DeselectAllForFunctionEditing",value:function(){null!=this.tableNode&&this.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){e.children.forEach(function(e){e.domElement.className.indexOf("commaSpreadsheetCellCounter")<0&&-1<e.domElement.className.indexOf("cscfe_highlight_cell")&&(e.domElement.className="commaSpreadsheetCell")})})})}},{key:"SelectRangeForFunctionEditing",value:function(e,t,n,i,o){if(null==n){var r=this.GetNodePerCoordinates(e,t);r.domElement.className.indexOf("commaSpreadsheetCellCounter")<0&&(r.domElement.className=o)}else{i+=1;for(var s=0;s<=this.coordinatesPerNode.length;s++)if(e<=s&&s<=n)for(var a,l=0;l<=this.coordinatesPerNode[s].length;l++)t<=l&&l<i&&(a=this.GetNodePerCoordinates(s,l)).domElement.className.indexOf("commaSpreadsheetCellCounter")<0&&(a.domElement.className=o)}}},{key:"DeselectRangeForFunctionEditing",value:function(e,t,n,i,o,r,s,a,l){if(null==n){var c;o&&e==r&&t==s||(c=this.GetNodePerCoordinates(e,t)).domElement.className.indexOf("commaSpreadsheetCellCounter")<0&&-1<c.domElement.className.indexOf("cscfe_highlight_cell")&&(c.domElement.className="commaSpreadsheetCell")}else{i+=1;for(var u=0;u<=this.coordinatesPerNode.length;u++)if(e<=u&&u<=n)for(var h,d=0;d<=this.coordinatesPerNode[u].length;d++)t<=d&&d<i&&(o&&r<=u&&u<=a&&s<=d&&d<l||(h=this.GetNodePerCoordinates(u,d)).domElement.className.indexOf("commaSpreadsheetCellCounter")<0&&-1<h.domElement.className.indexOf("cscfe_highlight_cell")&&(h.domElement.className="commaSpreadsheetCell"))}}},{key:"StartFunctionEditing",value:function(e){this.editingFunction||(null==e&&(e=this.rootNode.document.GetNodeAtCursor().parent.parent),this.editingFunction=!0,this.fxLabel.domElement.style.color="#FFC15E",this.functionsManager.StartEditingCell(e))}},{key:"StopFunctionEditing",value:function(e){0<arguments.length&&void 0!==e&&e&&this.functionsManager.GetCurrentCell().GetFirstTextNode().SetFocus(),null!=this.fxLabel&&(this.fxLabel.domElement.style.color="#FFFFFF"),this.editingFunction=!1,this.functionsManager.StopEditingCell(),this.DeselectAllForFunctionEditing()}},{key:"OpenSettingsPanel",value:function(e,t){this.CloseSettingsPanel(),this.cellSettingsPanel=new d(this,e,t)}},{key:"CloseSettingsPanel",value:function(){null!=this.cellSettingsPanel&&this.cellSettingsPanel.destroy()}},{key:"GetNodeFromDom",value:function(e){var t=e.getAttribute("cm-id");return this.rootNode.document.GetNodeById(t)}},{key:"ApplyStyleOnSelectedLines",value:function(t,n){this.selectedNodes.forEach(function(e){e.children.forEach(function(e){e.isBlockNode()&&e.ToggleStyle(t,n,!0)})})}},{key:"_applyToTextNodes",value:function(e,t,n){var i;e.isTextNode()&&e.ToggleStyle(t,n,!0),null!=e.children&&(i=this,e.children.forEach(function(e){i._applyToTextNodes(e,t,n)}))}},{key:"ApplyStyleOnSelectedCells",value:function(t,n){var i=this;this.selectedNodes.forEach(function(e){i._applyToTextNodes(e,t,n)})}},{key:"DeleteContentOfSelectedCells",value:function(e){var t=0<arguments.length&&void 0!==e&&e,n=this.rootNode.document,i=void 0;this.selectedNodes.forEach(function(e){var t;c.a.RemoveFunction(e),e.children[0].children.forEach(function(e){t=e.nodeStyle.Copy(),n.DeleteNode(e,!1,!0,t)}),i=e.GetFirstTextNode()}),t&&null!=i&&i.SetFocus()}},{key:"_fintTDContainer",value:function(e){return null!=e.parent?"td"==e.parent.tagName?e.parent:this._fintTDContainer(e.parent):void 0}},{key:"MoveToNextCell",value:function(){var e,t=this.rootNode.document.GetNodeAtCursor();null!=t&&t.isTextNode()&&(e=this._fintTDContainer(t),this.MoveCellFocus("RIGHT",e))}},{key:"MoveAndSelectCellFocus",value:function(){}},{key:"MoveCellFocus",value:function(e,t){var n,i=this.GetCoordinatesPerNode(t.id),o=void 0,r=void 0,s=void 0;"RIGHT"==e?(r=i.col+1,s=i.row,null==(o=this.GetNodePerCoordinates(s,r))&&((s+=r=1)>=this.GetNumberOfRows()&&(--s,r=this.GetNumberOfColumns()-1),o=this.GetNodePerCoordinates(s,r))):"LEFT"==e?(r=i.col-1,s=i.row,r<1&&(r=this.GetNumberOfColumns()-1,--s<0&&(s=0,r=1)),o=this.GetNodePerCoordinates(s,r)):"DOWN"==e?(r=i.col,(s=i.row+1)>=this.GetNumberOfRows()&&--s,o=this.GetNodePerCoordinates(s,r)):"UP"==e&&(r=i.col,(s=i.row-1)<0&&(s=0),o=this.GetNodePerCoordinates(s,r)),null!=o&&((n=o.GetFirstTextNode()).SelectText(0,n.text.toString().length),this.SelectCell(s,r),this.functionsManager.SetEditingCell(this.selectedNodes[0]),this.ShowAutofillHandle())}},{key:"SelectAll",value:function(){this.DeselectAll();var t=0,n=0,i=this;this.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){n=0,e.children.forEach(function(e){i.SelectCell(t,n,!0),n++}),t++})})}},{key:"AddSelectedCellsToClipboard",value:function(e){var t=0<arguments.length&&void 0!==e&&e,n=this.rootNode.document,i=y.BlockNode.CreateNew(n,"table");i.SetAttributes([{name:"class",value:"commaSpreadsheetTable"}]),i.SetPluginType(this.rootNode.GetPluginType());var o=y.BlockNode.CreateNew(n,"tbody"),r=this,s=void 0,a=void 0;this.selectedNodes.forEach(function(e){var t=r.GetCoordinatesPerNode(e.id);a!=t.row&&(null!=s&&o.Append(s),a=t.row,s=y.BlockNode.CreateNew(n,"tr")),s.Append(e.Copy())}),null!=s&&o.Append(s),i.Append(o),t&&this.DeleteContentOfSelectedCells(),this.rootNode.document.ForceClipboardContent(i.domElement)}},{key:"PasteCells",value:function(e){var t,n,i,r,o=!1,s=this,a=(new DOMParser).parseFromString(e,"text/html").body.firstElementChild;return null==a||null!=(t=[].slice.call(a.getElementsByTagName("tr")))&&0<t.length&&(o=!0,n=this.selectedNodes[0],i=this.GetCoordinatesPerNode(n.id),r=i.row,t.forEach(function(e){var o=i.col;[].slice.call(e.getElementsByTagName("td")).forEach(function(e){var t,n,i;o<s.GetNumberOfColumns()&&r<s.GetNumberOfRows()&&null!=(t=s.GetNodePerCoordinates(r,o))&&(n=t.GetFirstTextNode(),null==(i=s.functionsManager.GetFunctionFromDomNode(e))||""==i?(n.ForceTextContent(e.textContent.toString()),b.a.Format(t)):s.functionsManager.CopyFunctionToNode(i,t)),o++}),r++})),o&&(this.functionsManager.RecalculateAll(),this.PushToHistory()),o}},{key:"Fire",value:function(e,t,n,i){var o=JSON.parse(JSON.stringify(e));e==y.PluginActions.NEW_CHAR_ADDED&&"Backspace"==i.key&&1<this.selectedNodes.length&&(o=y.PluginActions.DELETE);var r,s,a,l,c,u=!1,h=this,d=void 0;switch(o){case y.PluginActions.LOST_FOCUS:this.CloseSettingsPanel(),this.DeselectAll(),this.StopFunctionEditing();break;case y.PluginActions.BEFORE_PASTE:var f=i.clipboardData.getData("text/html");null!=f&&""!=f||(f=i.clipboardData.getData("text")),u=this.PasteCells(f);break;case y.PluginActions.BEFORE_COPY:var p,g=!0;1==this.selectedNodes.length&&(this.rootNode.document.selectionManager.IsCollapsed()?g=!0:(p=this.selectedNodes[0].domElement.textContent,null!=window.getSelection()&&(g=window.getSelection().toString()==p))),g&&(this.AddSelectedCellsToClipboard(),u=!0);break;case y.PluginActions.BEFORE_CUT:var m,v=!0;1==this.selectedNodes.length&&(this.rootNode.document.selectionManager.IsCollapsed()?v=!0:(m=this.selectedNodes[0].domElement.textContent,null!=window.getSelection()&&(v=window.getSelection().toString()==m))),v&&(this.AddSelectedCellsToClipboard(!0),u=!0);break;case y.PluginActions.SELECT_ALL:1==this.selectedNodes.length&&this.selectedNodes[0].SelectWholeTextContent(),u=!0;break;case y.PluginActions.SHIFT_DOWN:case y.PluginActions.SHIFT_UP:break;case y.PluginActions.ARROW_UP:null!=t&&null!=t.parent&&("td"==t.parent.tagName?d=t.parent:null!=t.parent.parent&&"td"==t.parent.parent.tagName&&(d=t.parent.parent)),null!=d&&(h.MoveCellFocus("UP",d),u=!0);break;case y.PluginActions.ARROW_DOWN:null!=t&&null!=t.parent&&("td"==t.parent.tagName?d=t.parent:null!=t.parent.parent&&"td"==t.parent.parent.tagName&&(d=t.parent.parent)),null!=d&&(h.MoveCellFocus("DOWN",d),u=!0);break;case y.PluginActions.ARROW_LEFT:null!=t&&null!=t.parent&&("td"==t.parent.tagName?d=t.parent:null!=t.parent.parent&&"td"==t.parent.parent.tagName&&(d=t.parent.parent)),null!=d&&(r=!0,h.useArrowsForText&&(r=!1,null!=(s=d.domElement.textContent.replace(/[\u200B-\u200D\uFEFF]/g,""))&&""!=s&&0!=d.document.GetCursorPosition().startOffset||(r=!0)),r&&(h.MoveCellFocus("LEFT",d),u=!0));break;case y.PluginActions.ARROW_RIGHT:null!=t&&null!=t.parent&&("td"==t.parent.tagName?d=t.parent:null!=t.parent.parent&&"td"==t.parent.parent.tagName&&(d=t.parent.parent)),null!=d&&(a=!0,h.useArrowsForText&&(a=!1,null!=(l=d.domElement.textContent.replace(/[\u200B-\u200D\uFEFF]/g,""))&&""!=l&&d.document.GetCursorPosition().startOffset!=l.length||(a=!0)),a&&(h.MoveCellFocus("RIGHT",d),u=!0));break;case y.PluginActions.SHIFT_ARROW_UP:case y.PluginActions.SHIFT_ARROW_DOWN:case y.PluginActions.SHIFT_ARROW_LEFT:case y.PluginActions.SHIFT_ARROW_RIGHT:break;case y.PluginActions.ENTER:u=!0,null!=t&&null!=t.parent&&("td"==t.parent.tagName?d=t.parent:null!=t.parent.parent&&"td"==t.parent.parent.tagName&&(d=t.parent.parent)),null!=d&&h.MoveCellFocus("DOWN",d);break;case y.PluginActions.NEW_CHAR_ADDED:null!=t&&null!=t.parent&&null!=t.parent.parent&&"td"==t.parent.parent.tagName&&("="==t.parent.parent.domElement.textContent?(t.ForceTextContent(""),this.StartFunctionEditing(t.parent.parent)):(c=t.parent.parent,null==h.prevTimeoutOnTyping&&(h.prevTimeoutOnTyping={}),null!=h.prevTimeoutOnTyping[c.id]&&clearTimeout(h.prevTimeoutOnTyping[c.id]),h.prevTimeoutOnTyping[c.id]=setTimeout(function(){b.a.Format(c),h.functionsManager.CellValueChanged(c)},2e3)));break;case y.PluginActions.APPLY_STYLE_ON_LINE:null==t&&this.ApplyStyleOnSelectedLines(i.styleName,i.value);break;case y.PluginActions.APPLY_STYLE_ON_TEXT:null==t&&this.ApplyStyleOnSelectedCells(i.styleName,i.value);break;case y.PluginActions.DELETE:this.editingFunction||(this.DeleteContentOfSelectedCells(!0),u=!0);break;case y.PluginActions.CANCEL_FROM_TOP:u=!0;break;case y.PluginActions.DELETE_FROM_BOTTOM:this.rootNode.document.DeleteNode(this.rootNode),n.DeletePluginInstance(this),u=!1;break;case y.PluginActions.TAB:this.MoveToNextCell(),u=!0;break;default:return void this.CloseSettingsPanel()}return u}},{key:"AddRows",value:function(e){for(var n=this,i=0;i<e;)!function(){var t=m.AddRow(n.GetNumberOfRows()+i,n.rootNode.document,n.GetNumberOfColumns()).tr;n.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.Append(t)}),i++}();this.Init()}},{key:"AddColumns",value:function(e){for(var n=this,i=this.rootNode.document,o=0;o<e;)!function(){var t=n.GetNumberOfColumns()+o;n.tableNode.children.forEach(function(e){"thead"==e.tagName.toLowerCase()?e.children.forEach(function(e){e.Append(m.AddCellColumn(i,t))}):"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){e.Append(m.AddNormalCell(i))})}),o++}();this.Init()}},{key:"TransformTableInSpreadsheet",value:function(){var e=this.rootNode,t=this,n=this.id,i=this.rootNode.GetPluginType(),o=e.document,r=e.InsertEmptyBlockNodeBefore("div");r.SetAttributes([{name:"class",value:"spreadsheetContainer"}]),r.SetPluginType(i),r.Append(m.CreateHeader(o));var s=y.BlockNode.CreateNew(o,"table",void 0,[{name:"class",value:"commaSpreadsheetTable"}]),a=0,l=[];e.children.forEach(function(e){"tbody"==e.tagName?e.children.forEach(function(e){0==a&&(a=e.children.length),l.push(e)}):"tr"==e.tagName&&(0==a&&(a=e.children.length),l.push(e))});var c=y.BlockNode.CreateNew(o,"thead"),u=m.AddColsCounterRow(o,a+1);c.Append(u),s.Append(c);var h=y.BlockNode.CreateNew(o,"tbody"),d=void 0,f=1;l.forEach(function(e){var t=y.BlockNode.CreateNew(o,"td",void 0,[],!0,f);t.SetAttributes([{name:"class",value:"commaSpreadsheetCellCounter csRowCounterCell"}]),t.SetAttributes([{name:"contentEditable",value:!1}]),null==d&&(d=e.children[0].GetFirstTextNode()),e.Append(t,0),h.Append(e),f++}),s.Append(h),r.Append(s),o.DeleteNode(e);var p=r.InsertEmptyBlockNodeAfter("div"),g=y.TextNode.CreateNew(o,"span","");g.ToggleStyle("fontColor","#475666"),p.Append(g),this.rootNode=r,this.id=r.id,o.ChangePluginInstanceId(n,r.id),setTimeout(function(){d.SetFocus(),t.SelectCell(0,1),t.ShowAutofillHandle()},100)}},{key:"Import",value:function(e){var t,o,n,r,i,s,a,l,c;0<e.length&&(o=(t=this).rootNode.document,n=e[0].length,r=void 0,i=y.BlockNode.CreateNew(o,"table",void 0,[{name:"class",value:"commaSpreadsheetTable"}]),s=y.BlockNode.CreateNew(o,"thead"),a=m.AddColsCounterRow(o,n+1),s.Append(a),i.Append(s),l=y.BlockNode.CreateNew(o,"tbody"),c=1,e.forEach(function(e){var n=y.BlockNode.CreateNew(o,"tr"),i=0;e.forEach(function(e){var t=void 0;0==i?t=m.AddCell(o,!0,!1,c):(t=m.AddCell(o)).td.GetFirstTextNode().ForceTextContent(e),null==r&&(r=t.nodeForFocus),n.Append(t.td),i++}),l.Append(n),c++}),i.Append(l),o.DeleteNode(this.tableNode),this.rootNode.Append(i),this.Init(),setTimeout(function(){r.SetFocus(),t.SelectCell(0,1),t.ShowAutofillHandle()},100))}},{key:"Export",value:function(){var i=[];return this.tableNode.children.forEach(function(e){"tbody"==e.tagName.toLowerCase()&&e.children.forEach(function(e){var t=[],n=!0;e.children.forEach(function(e){n?n=!1:t.push(e.domElement.textContent.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""))}),i.push(t)})}),i}}],[{key:"toColumnName",value:function(e){for(var t="",n=1,i=26;0<=(e-=n);n=i,i*=26)t=String.fromCharCode(parseInt(e%i/n)+65)+t;return t}},{key:"AddRow",value:function(e,t,n){for(var i=y.BlockNode.CreateNew(t,"tr"),o=0,r=void 0;o<n;){var s=0==o?m.AddCell(t,!0,!1,e):m.AddCell(t);null==r&&(r=s.nodeForFocus),i.Append(s.td),o++}return{tr:i,nodeForFocus:r}}},{key:"AddColsCounterRow",value:function(e,t){for(var n=y.BlockNode.CreateNew(e,"tr"),i=0;i<t;){var o=0==i?m.AddCell(e,!1,!0,"",!0):m.AddCell(e,!1,!0,m.toColumnName(i));n.Append(o.td),i++}return n}},{key:"AddCellColumn",value:function(e,t){return m.AddCell(e,!1,!0,m.toColumnName(t)).td}},{key:"AddNormalCell",value:function(e){return m.AddCell(e,!1,!1,"",!0).td}},{key:"AddCell",value:function(e,t,n,i,o){var r=1<arguments.length&&void 0!==t&&t,s=2<arguments.length&&void 0!==n&&n,a=3<arguments.length&&void 0!==i?i:0,l=4<arguments.length&&void 0!==o&&o,c=void 0,c=s?y.BlockNode.CreateNew(e,"th",void 0,[],!0,a):r?(a+=1,y.BlockNode.CreateNew(e,"td",void 0,[],!0,a)):y.BlockNode.CreateNew(e,"td");r||s?(c.SetAttributes([{name:"class",value:"commaSpreadsheetCellCounter"}]),(r||l)&&c.SetAttributes([{name:"class",value:"commaSpreadsheetCellCounter csRowCounterCell"}])):c.SetAttributes([{name:"class",value:"commaSpreadsheetCell"}]);var u,h,d=void 0;return r||s?c.SetAttributes([{name:"contentEditable",value:!1}]):(u=y.BlockNode.CreateNew(e,"div"),h=e.GetDefaultNodeStyle(),(d=y.TextNode.CreateNew(e,"span","",h)).ToggleStyle("fontColor","#475666"),u.Append(d),c.Append(u)),{td:c,nodeForFocus:d}}},{key:"CreateHeader",value:function(e){var t=y.BlockNode.CreateNew(e,"div",void 0,[{name:"class",value:"functContainer"},{name:"contentEditable",value:!1}]),n=y.BlockNode.CreateNew(e,"div",void 0,[{name:"class",value:"functBoxFxLabel"}],!0,"f(x)");t.Append(n);var i=y.BlockNode.CreateNew(e,"input",void 0,[{name:"class",value:"functInputBox"}]);t.Append(i);var o=y.BlockNode.CreateNew(e,"i",void 0,[{name:"class",value:"fa fa-download cscfe_functBtn"},{name:"title",value:"Export as CSV"}]);t.Append(o);var r=y.BlockNode.CreateNew(e,"i",void 0,[{name:"class",value:"fa fa-upload cscfe_functBtn"},{name:"title",value:"Import CSV"}]);return t.Append(r),t}},{key:"CreateNew",value:function(e,t){t.cols=JSON.parse(t.cols)+1,e.GetStyleAtCurrentCursorPosition();var n=e.GetDefaultNodeStyle(),i=e.GetNodeAtCursor().GetBlockContainer().InsertEmptyBlockNodeAfter("div");i.SetAttributes([{name:"class",value:"spreadsheetContainer"}]),i.Append(m.CreateHeader(e));var o=y.BlockNode.CreateNew(e,"table",void 0,[{name:"class",value:"commaSpreadsheetTable"}]),r=y.BlockNode.CreateNew(e,"thead"),s=m.AddColsCounterRow(e,t.cols);r.Append(s),o.Append(r);for(var a=y.BlockNode.CreateNew(e,"tbody"),l=t.rows,c=void 0,u=0;u<l;){var h=m.AddRow(u,e,t.cols);null==c&&(c=h.nodeForFocus),a.Append(h.tr),u++}o.Append(a),i.Append(o);var d=i.InsertEmptyBlockNodeAfter("div"),f=y.TextNode.CreateNew(e,"span","",n.Copy());f.ToggleStyle("fontColor","#475666"),d.Append(f);var p=new m(i);return setTimeout(function(){c.SetFocus(),p.SelectCell(0,1),p.ShowAutofillHandle()},100),p}}]),m}(),A=t.default=O}],e={},f.m=d,f.c=e,f.d=function(e,t,n){f.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},f.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},f.t=function(t,e){if(1&e&&(t=f(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(f.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)f.d(n,i,function(e){return t[e]}.bind(null,i));return n},f.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return f.d(t,"a",t),t},f.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},f.p="/",f(f.s=3);function f(t){if(e[t])return e[t].exports;var n=e[t]={i:t,l:!1,exports:{}};return d[t].call(n.exports,n,n.exports,f),n.l=!0,n.exports}var d,e},module.exports=aTb(__webpack_require__(0))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t);var u=n(0);function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function d(e){return(d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var o=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(c,u.Plugin);var i,o,r=(i=c,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t,n=d(i);return!(t=o?(e=d(this).constructor,Reflect.construct(n,arguments,e)):n.apply(this,arguments))||"object"!==s(t)&&"function"!=typeof t?h(this):t});function c(e){var t;!function(e){if(!(e instanceof c))throw new TypeError("Cannot call a class as a function")}(this);var n=h(t=r.call(this,e));return t.endResizing=function(e){n.EndResizing(e)},t.resizing=function(e){n.resizingRunning=!0,n.Resize(e)},t.readOnly=t.rootNode.document.readOnly,t.InitializeDomElements(),t}return a(c,null,[{key:"GetName",value:function(){return"stickyNote"}}]),a(c,[{key:"InitializeDomElements",value:function(e){var t;null==this.rootNode.parent?(t=this,null==e?e=0:e++,e<50?setTimeout(function(){t.InitializeDomElements(e)},100):console.log("#345-23")):this.readOnly||this.Init()}},{key:"Init",value:function(){var e,t;null==this.rootNode.next&&(e=this.rootNode.InsertEmptyBlockNodeAfter("div"),t=u.TextNode.CreateNew(this.rootNode.document,"span","",this.rootNode.document.GetDefaultNodeStyle().Copy()),e.Append(t));var n=this;this.rootNode.domElement.addEventListener("mousemove",function(e){n.ShowPointerOnRightBorder(e,this)}),this.rootNode.domElement.addEventListener("mousedown",function(e){n.ShowPointerOnRightBorder(e,this)&&n.StartResizing(e)})}},{key:"ShowPointerOnRightBorder",value:function(e,t){var n=!1,i=e,o=t.getBoundingClientRect(),r=o.left+o.width;return t.style.cursor="auto",i.pageX<r&&i.pageX>r-10&&(t.style.cursor="col-resize",n=!0),n}},{key:"Resize",value:function(e){var t=e.pageX+window.scrollX-this.prevX;this.prevX=e.pageX+window.scrollX;var n=this.rootNode.domElement.getBoundingClientRect().width+t;this.rootNode.domElement.style.width=n+"px"}},{key:"StartResizing",value:function(e){this.resizingRunning=!0,this.prevX=e.pageX+window.scrollX,document.body.addEventListener("mouseup",this.endResizing),document.body.addEventListener("mousemove",this.resizing)}},{key:"EndResizing",value:function(e){var t,n,i;null!=e&&(t=this.rootNode.domElement.getBoundingClientRect(),n=window.innerWidth,i=parseInt(100*t.width/n)+"vw",this.rootNode.ToggleStyle("width",i,!0,!0)),this.resizingRunning=!1,document.body.removeEventListener("mousemove",this.resizing),document.body.removeEventListener("mouseup",this.endResizing)}},{key:"Fire",value:function(e,t,n){var i=!1;switch(e){case u.PluginActions.LOST_FOCUS:case u.PluginActions.CLICK:this.resizingRunning&&this.EndResizing();break;case u.PluginActions.DELETE_FROM_BOTTOM:this.rootNode.document.DeleteNode(this.rootNode),n.DeletePluginInstance(this),i=!1;break;default:return}return i}}],[{key:"CreateNew",value:function(e,t){var n="#ffefa1",i=void 0;null!=t?(t.type="inline",null!=t.bgColor&&(n=t.bgColor),null!=t.textColor&&(i=t.textColor)):t={type:"inline"};var o,r=new u.NodeStyle(e,e.GetStyleAtCurrentCursorPosition().nodeStyle).Copy(),s=void 0;"floating"==t.type?(o=e.GetFloatingContainer(),(s=u.BlockNode.CreateNew(e,"div")).SetAttributes([{name:"class",value:"commaStickyNoteFloating"},{name:"contentEditable",value:!0}]),o.Append(s)):(s=e.GetNodeAtCursor().GetBlockContainer().InsertEmptyBlockNodeAfter("div")).SetAttributes([{name:"class",value:"commaStickyNote"}]),s.ToggleStyle("backgroundColor",n,!0,!0);var a=u.BlockNode.CreateNew(e,"div"),l=u.TextNode.CreateNew(e,"span","",r.Copy());return a.Append(l),s.Append(a),setTimeout(function(){l.SetFocus(),null!=i&&e.ToggleStyleOnSelection("fontColor",i)},50),new c(s)}}]),c}();t.default=o}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t);var a=n(0);function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var l=(i(o.prototype,[{key:"InitPanel",value:function(){function e(e){t.MouseDown(e,this)}var t=this;this.panel=document.createElement("div"),this.panel.setAttribute("class","comma-img-resizable");var n=document.createElement("div");n.setAttribute("class","comma-img-resizers");var i=document.createElement("div");i.setAttribute("class","comma-img-resizer cir-top-left"),i.removeEventListener("mousedown",e),i.addEventListener("mousedown",e),n.appendChild(i);var o=document.createElement("div");o.setAttribute("class","comma-img-resizer cir-top-right"),o.removeEventListener("mousedown",e),o.addEventListener("mousedown",e),n.appendChild(o);var r=document.createElement("div");r.setAttribute("class","comma-img-resizer cir-bottom-left"),r.removeEventListener("mousedown",e),r.addEventListener("mousedown",e),n.appendChild(r);var s,a,l,c,u=document.createElement("div");function h(){t.Hide()}u.setAttribute("class","comma-img-resizer cir-bottom-right"),u.removeEventListener("mousedown",e),u.addEventListener("mousedown",e),n.appendChild(u),this.showEditingBtn&&((s=document.createElement("i")).setAttribute("class","comma-image-edit-btn fa fa-edit"),a=function(e){t.OpenEditingPanel(e)},s.removeEventListener("mousedown",a),s.addEventListener("mousedown",a),n.appendChild(s)),this.showMagnifyBtn&&((l=document.createElement("i")).setAttribute("class","comma-image-edit-btn fa fa-search-plus"),l.style.marginLeft="6px",c=function(e){t.MagnifyImage(e)},l.removeEventListener("mousedown",c),l.addEventListener("mousedown",c),n.appendChild(l)),this.panel.removeEventListener("mousedown",h),this.panel.addEventListener("mousedown",h),this.panel.appendChild(n),document.body.appendChild(this.panel)}},{key:"Show",value:function(){this.shown=!0,this.panel.style.display="block",this.RenderPanel()}},{key:"RenderPanel",value:function(){var e=this.img.getBoundingClientRect();this.panel.style.top=e.top+window.scrollY+"px",this.panel.style.left=e.left+window.scrollX+"px",this.panel.style.width=e.width+"px",this.panel.style.height=e.height+"px"}},{key:"Hide",value:function(){this.shown=!1,this.panel.style.display="none"}},{key:"MouseDown",value:function(e,t){var n=this;function i(e){n.StopResize(e)}function o(e){n.Resize(e,t)}this.px=e.pageX,this.f_resize=o,window.removeEventListener("mousemove",o),window.addEventListener("mousemove",o),window.removeEventListener("mouseup",i),window.addEventListener("mouseup",i),e.preventDefault(),e.stopPropagation()}},{key:"Resize",value:function(e,t){var n=e.pageX,i=n-this.px;this.img.style.height="auto";var o=parseInt(getComputedStyle(this.img).width.replace("px",""));t.classList.contains("cir-bottom-right")||t.classList.contains("cir-top-right")?o+=i:o-=i,this.img.style.width=o+"px",this.panel.style.width=o+"px",this.panel.style.height=getComputedStyle(this.img).height,this.px=n,this.RenderPanel(),e.preventDefault(),e.stopPropagation()}},{key:"StopResize",value:function(e){window.removeEventListener("mousemove",this.f_resize),this.imgPluginInstance.PushToHistory(),e.preventDefault(),e.stopPropagation()}},{key:"OpenEditingPanel",value:function(e){this.imgPluginInstance.OpenEditingPanel(),e.preventDefault(),e.stopPropagation()}},{key:"MagnifyImage",value:function(e){this.imgPluginInstance.MagnifyImage(),e.preventDefault(),e.stopPropagation()}}]),o);function o(e,t){var n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],i=!(3<arguments.length&&void 0!==arguments[3])||arguments[3];!function(e){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}(this),this.img=e,this.imgPluginInstance=t,this.panel=void 0,this.shown=!1,this.showEditingBtn=n,this.showMagnifyBtn=i,this.InitPanel()}function c(e){return(c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function u(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}function h(e,t){return(h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function d(e){return(d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var s=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&h(e,t)}(s,a.Plugin);var o,r,n=(o=s,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t,n=d(o),i=this;return!(t=r?(e=d(this).constructor,Reflect.construct(n,arguments,e)):n.apply(this,arguments))||"object"!==c(t)&&"function"!=typeof t?function(){if(void 0!==i)return i;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function s(e){var t;return function(e){if(!(e instanceof s))throw new TypeError("Cannot call a class as a function")}(this),(t=n.call(this,e)).readOnly=t.rootNode.document.readOnly,t.InitializeDomElements(),t}return u(s,null,[{key:"GetName",value:function(){return"video"}}]),u(s,[{key:"InitializeDomElements",value:function(e){var t;null==this.rootNode.parent?(t=this,null==e?e=0:e++,e<50?setTimeout(function(){t.InitializeDomElements(e)},100):console.log("#545-27")):this.readOnly||this.Init()}},{key:"PushToHistory",value:function(){this.rootNode.document.PushToHistory()}},{key:"Init",value:function(){var e=this;function t(){}function n(){}function i(){e.resizeManager.Show()}this.resizeManager=new l(this.rootNode.domElement,this,!1,!1),this.rootNode.domElement.removeEventListener("mousemove",t),this.rootNode.domElement.addEventListener("mousemove",t),this.rootNode.domElement.removeEventListener("mouseout",n),this.rootNode.domElement.addEventListener("mouseout",n),this.rootNode.domElement.removeEventListener("click",i),this.rootNode.domElement.addEventListener("click",i)}},{key:"Fire",value:function(e){return e===a.PluginActions.LOST_FOCUS&&this.resizeManager.Hide(),!1}}],[{key:"CreateNew",value:function(e,t){e.DeleteSelection();var n=t.link,i=t.mimeType;"video/quicktime"==i&&(i="video/mp4");var o=a.InlineNode.CreateNew(e,"video","",void 0,[{name:"class",value:"commaVideo"},{name:"controls",value:""}]);e.InsertNodeAtCursor(o);var r=a.TextNode.CreateNew(e,"source","",void 0,[{name:"src",value:n},{name:"type",value:i}]);return o.Append(r),new s(o)}},{key:"GetTagToParseOnPaste",value:function(){return["video"]}},{key:"CreateNewFromPastedNode",value:function(e,t){var n=t.getAttribute("src"),i=t.getAttribute("type");"video/quicktime"==i&&(i="video/mp4");var o=a.InlineNode.CreateNew(e,"video","",void 0,[{name:"class",value:"commaVideo"},{name:"controls",value:""}]),r=a.TextNode.CreateNew(e,"source","",void 0,[{name:"src",value:n},{name:"type",value:i}]);return o.Append(r),new s(o)}}]),s}();t.default=s}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t),n.d(t,"CommaMentionsFactory",function(){return r}),n.d(t,"CommaMention",function(){return a});var l=n(0);function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function c(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var a=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(a,l.Plugin);var o,r,n=(o=a,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t,n=h(o),i=this;return!(t=r?(e=h(this).constructor,Reflect.construct(n,arguments,e)):n.apply(this,arguments))||"object"!==s(t)&&"function"!=typeof t?function(){if(void 0!==i)return i;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function a(e){var t;return function(e){if(!(e instanceof a))throw new TypeError("Cannot call a class as a function")}(this),(t=n.call(this,e)).options=t.rootNode.document.GetPluginOptions("mentions"),t.InitializeDomElements(),t}return c(a,null,[{key:"GetName",value:function(){return"mentions"}}]),c(a,[{key:"InitializeDomElements",value:function(e){var t;null==this.rootNode.parent?(t=this,null==e?e=0:e++,e<50?setTimeout(function(){t.InitializeDomElements(e)},100):console.log("#555-23")):this.Init()}},{key:"Init",value:function(){var e,t=this,n=this.rootNode.domElement,i=n.getAttribute("cm-ment-entry");this.entry=void 0,null==i||""==i?(this.entry=JSON.parse(n.getAttribute("cm-ment-params")),e=n.getAttribute("cm-ment-type"),this.entry.mentionType=e):null!=i&&""!=i&&(this.entry=JSON.parse(l.Base64.decode(i))),n.addEventListener("click",function(){t.Click()}),n.addEventListener("mouseover",function(){t.MouseOver()}),n.addEventListener("mouseout",function(){t.MouseOut()})}},{key:"Click",value:function(){null!=this.options&&null!=this.options.externalFunctions&&null!=this.options.externalFunctions.OnClick&&this.options.externalFunctions.OnClick(this.entry,this.rootNode)}},{key:"MouseOver",value:function(){null!=this.options&&null!=this.options.externalFunctions&&null!=this.options.externalFunctions.OnMouseOver&&this.options.externalFunctions.OnMouseOver(this.entry,this.rootNode)}},{key:"MouseOut",value:function(){null!=this.options&&null!=this.options.externalFunctions&&null!=this.options.externalFunctions.OnMouseOut&&this.options.externalFunctions.OnMouseOut(this.entry,this.rootNode)}},{key:"OnMentionDeleted",value:function(){null!=this.options&&null!=this.options.externalFunctions&&null!=this.options.externalFunctions.OnMentionDeleted&&this.options.externalFunctions.OnMentionDeleted(this.entry,this.rootNode)}},{key:"Fire",value:function(e){return e===l.PluginActions.NODE_UNREGISTERED&&this.OnMentionDeleted(),!1}}],[{key:"CreateNew",value:function(e,t){e.DeleteSelection();var n=e.GetStyleAtCurrentCursorPosition();null!=n.nodeStyle&&null!=n.nodeStyle.fontSize&&n.nodeStyle.fontSize.on;var i=t,o=l.Base64.encode(JSON.stringify(i)),r=l.InlineNode.CreateNew(e,"span","",void 0,[{name:"cm-ment-entry",value:o},{name:"contenteditable",value:!1}]);if(e.InsertNodeAtCursor(r),!e.GetPluginOptions("mentions").externalFunctions.FormatMention(i,r)){var s=new a(r);return setTimeout(function(){null!=r.next&&r.next.isTextNode()&&r.next.SetFocus()},200),s}r.Delete(!0)}}]),a}();function d(e){return(d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function f(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function g(e){return(g=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var r=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(i,l.Plugin);var o,r,n=(o=i,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t,n=g(o),i=this;return!(t=r?(e=g(this).constructor,Reflect.construct(n,arguments,e)):n.apply(this,arguments))||"object"!==d(t)&&"function"!=typeof t?function(){if(void 0!==i)return i;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function i(e){var t;return function(e){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}(this),(t=n.call(this,e)).options=t.rootNode.document.GetPluginOptions("mentionsFactory"),t.verifyAt=!1,t.searchResults=[],t.searchBoxes=[],t.arrowPosition=-1,t.highlightOnMouse=!1,t.searchingMention=!1,t.preserveTextHasBeenCalculated=!1,t.preserveTextAfterAt="",t}return f(i,null,[{key:"GetName",value:function(){return"mentionsFactory"}}]),f(i,[{key:"Destroy",value:function(){if(null!=this.searchPnl)try{this.searchPnl.parentNode.removeChild(this.searchPnl)}catch(e){}this.rootNode.document.RemovePluginInstance(this.rootNode.id)}},{key:"Search",value:function(e){var t=this;""!=e&&null!=this.options.externalFunctions.Search?(this._startSearching(),this.options.externalFunctions.Search(e).then(function(e){null!=(t.searchResults=e).hits&&(t.searchResults=e.hits),t._stopSearching()},function(e){console.log("Searching for mentions error",e)})):this._stopSearching()}},{key:"_startSearching",value:function(){this.searchingMention||(this.searchingMention=!0,this.UpdatePnl())}},{key:"_stopSearching",value:function(){this.searchingMention=!1,this.UpdatePnl()}},{key:"UpdatePnl",value:function(){for(var e=this.searchPnl;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(this.GenerateResultsPnl())}},{key:"Start",value:function(){var e,t=this.rootNode.document.GetSelectionBoundingClientRect(),n=t.left+"px",i=300+t.left+16;i>window.innerWidth&&(e=i-window.innerWidth,n=t.left-e+"px");var o=document.createElement("div");o.style.position="absolute",o.style.zIndex="99999",o.style.border="1px solid #cccccc",o.style.borderRadius="4px",o.style.backgroundColor="#ffffff",o.style.left=n,o.style.top=window.scrollY+2+t.height+t.top+"px",o.style.width="300px",o.style.minHeight="40px",o.style.maxHeight="160px",o.style.overflow="auto",(this.searchPnl=o).appendChild(this.GenerateResultsPnl()),document.body.appendChild(o)}},{key:"GenerateResultsPnl",value:function(){var e,t,n,i,o,r,s,a=this,l=document.createElement("div");return 0==this.searchResults.length?(1==this.options.showAbove&&((e=this.rootNode.document.GetSelectionBoundingClientRect().top-48)<0&&(e=0),this.searchPnl.style.top=window.scrollY+e+"px"),l.style.display="flex",l.style.justifyContent="center",l.style.alignItems="center",l.style.margin="10px",(t=document.createElement("div")).style.flex="1",t.style.fontSize="12px",t.style.fontFamily="Verdana",t.style.color="#aaaaaa",this.searchingMention?t.textContent="Searching...":t.textContent="Keep typing to search...",l.appendChild(t),(n=document.createElement("div")).style.color="#aaaaaa",i=document.createElement("i"),this.searchingMention?(n.style.paddingTop="1px",n.style.fontSize="18px",i.setAttribute("class","fa fa-circle-o-notch fa-spin")):(n.style.fontSize="20px",i.setAttribute("class","fa fa-times"),n.style.cursor="pointer",n.addEventListener("mouseover",function(e){this.style.color="#30b7e8"}),n.addEventListener("mouseout",function(e){this.style.color="#aaaaaa"}),n.addEventListener("mousedown",function(e){a.Destroy(),e.preventDefault(),e.stopPropagation()})),n.appendChild(i),l.appendChild(n)):(1==this.options.showAbove&&(r=(o=this.rootNode.document.GetSelectionBoundingClientRect()).top-168,2==this.searchResults.length?r=o.top-108:1==this.searchResults.length&&(r=o.top-58),r<0&&(r=0),this.searchPnl.style.top=window.scrollY+r+"px"),this.searchBoxes=[],this.arrowPosition=-1,this.highlightOnMouse=!1,l.style.opacity="0",s=0,this.searchResults.forEach(function(e){l.appendChild(a.GenerateResultItemPnl(s,e)),s++}),null!=this.prevTimeout&&clearTimeout(this.prevTimeout),this.prevTimeout=setTimeout(function(){l.style.opacity="1"},50)),l}},{key:"GenerateResultItemPnl",value:function(e,t){var n=this,i=this.options.externalFunctions.FormatEntry(t);return null!=i?(i.setAttribute("cm-entry-id",e),i.style.cursor="pointer",i.style.padding="4px 0px 4px 0px",i.setAttribute("tabindex","123"+e),i.addEventListener("mousemove",function(e){n.highlightOnMouse=!0}),i.addEventListener("mouseover",function(e){n.highlightOnMouse&&(i.style.backgroundColor="#ededed")}),i.addEventListener("mouseout",function(e){i.style.backgroundColor="#ffffff"}),i.addEventListener("mousedown",function(e){n.AddMentions(t)})):console.log("Panel undefined - cannot list item",t),this.searchBoxes.push(i),i}},{key:"ManagerArrowUp",value:function(){this.arrowPosition--,this.arrowPosition<0&&(this.arrowPosition=0),this.HighlightEntry()}},{key:"ManagerArrowDown",value:function(){this.arrowPosition++,this.arrowPosition>=this.searchBoxes.length&&(this.arrowPosition=this.searchBoxes.length-1),this.HighlightEntry()}},{key:"HighlightEntry",value:function(){var e;this.searchBoxes.forEach(function(e){e.style.backgroundColor="#ffffff"}),-1<this.arrowPosition&&this.arrowPosition<this.searchBoxes.length&&((e=this.searchBoxes[this.arrowPosition]).style.backgroundColor="#ededed",e.scrollIntoView(!1))}},{key:"AddMentionFromKeyboard",value:function(){var e,t,n;-1==this.arrowPosition&&(this.arrowPosition=0),-1<this.arrowPosition&&this.arrowPosition<this.searchBoxes.length&&(e=this.searchBoxes[this.arrowPosition],t=parseInt(e.getAttribute("cm-entry-id")),null!=(n=this.searchResults[t])&&this.AddMentions(n))}},{key:"AddMentions",value:function(e){var t=this.rootNode.text.indexOf("@"),n=this.rootNode.text.length-this.preserveTextAfterAt.length,i={idStartNode:this.rootNode.id,idEndNode:this.rootNode.id,startOffset:t,endOffset:n};this.rootNode.document.SetCursorPosition(i),this.rootNode.document.DeleteSelection(i),this.rootNode.document.InsertPluginAtSection(a.GetName(),e),this.Destroy()}},{key:"CalculateTextToPreserver",value:function(){this.preserveTextHasBeenCalculated=!0;var e=this.rootNode.text.indexOf("@")+1;this.preserveTextAfterAt=this.rootNode.text.substring(e)}},{key:"Fire",value:function(e){var t=!1;switch(this.preserveTextHasBeenCalculated||this.CalculateTextToPreserver(),e){case l.PluginActions.LOST_FOCUS:this.Destroy();break;case l.PluginActions.ARROW_UP:t=!0,this.ManagerArrowUp();break;case l.PluginActions.ARROW_DOWN:t=!0,this.ManagerArrowDown();break;case l.PluginActions.DELETE:case l.PluginActions.DELETE_TOP:case l.PluginActions.DELETE_FROM_BOTTOM:case l.PluginActions.CANCEL_FROM_TOP:case l.PluginActions.CANCEL_FROM_BOTTOM:case l.PluginActions.DELETE_BEFORE_INLINE:case l.PluginActions.CANCEL_BEFORE_INLINE:case l.PluginActions.NODE_UNREGISTERED:-1==this.rootNode.text.indexOf("@")?this.Destroy():this.verifyAt=!0;break;case l.PluginActions.ENTER:case l.PluginActions.TAB:t=!0,this.AddMentionFromKeyboard();break;case l.PluginActions.ESC:this.Destroy(),t=!0;break;case l.PluginActions.NEW_CHAR_ADDED:var n,i,o,r=event.key;"Tab"!=r&&"Meta"!=r&&"Shift"!=r&&"Alt"!=r&&"Control"!=r&&"Down"!=r&&"ArrowDown"!=r&&"Up"!=r&&"ArrowUp"!=r&&"Left"!=r&&"ArrowLeft"!=r&&"Right"!=r&&"ArrowRight"!=r&&"CapsLock"!=r&&"Enter"!=r&&"Esc"!=r&&"Escape"!=r&&("Backspace"==r&&(this.verifyAt=!0),n=!0,this.verifyAt&&(this.verifyAt=!1,-1==this.rootNode.text.indexOf("@")&&(this.Destroy(),n=!1)),n&&(i=this.rootNode.text.indexOf("@")+1,o=this.rootNode.text.substring(i),0<this.preserveTextAfterAt.length&&(o=o.slice(0,-1*this.preserveTextAfterAt.length)),this.Search(o)));break;default:return}return t}}],[{key:"CreateNew",value:function(e){var t=new i(e.GetNodeAtCursor());return t.Start(),t}}]),i}()}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t);var r=n(0);function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var s=(i(o.prototype,[{key:"InitPanel",value:function(){function e(e){t.MouseDown(e,this)}var t=this;this.panel=document.createElement("div"),this.panel.setAttribute("class","comma-img-resizable");var n=document.createElement("div");n.setAttribute("class","comma-img-resizers");var i,o=document.createElement("div");o.setAttribute("class","comma-img-resizer cir-top-left"),o.removeEventListener("mousedown",e),o.addEventListener("mousedown",e),n.appendChild(o),(o=document.createElement("div")).setAttribute("class","comma-img-resizer cir-top-right"),o.removeEventListener("mousedown",e),o.addEventListener("mousedown",e),n.appendChild(o),(o=document.createElement("div")).setAttribute("class","comma-img-resizer cir-bottom-left"),o.removeEventListener("mousedown",e),o.addEventListener("mousedown",e),n.appendChild(o),(o=document.createElement("div")).setAttribute("class","comma-img-resizer cir-bottom-right"),o.removeEventListener("mousedown",e),o.addEventListener("mousedown",e),n.appendChild(o),this.showEditingBtn&&((i=document.createElement("i")).setAttribute("class","comma-image-edit-btn fa fa-edit"),o=function(e){t.OpenEditingPanel(e)},i.removeEventListener("mousedown",o),i.addEventListener("mousedown",o),n.appendChild(i)),this.showMagnifyBtn&&((r=document.createElement("i")).setAttribute("class","comma-image-edit-btn fa fa-search-plus"),r.style.marginLeft="6px",i=function(e){t.MagnifyImage(e)},r.removeEventListener("mousedown",i),r.addEventListener("mousedown",i),n.appendChild(r));var r=function(){t.Hide()};this.panel.removeEventListener("mousedown",r),this.panel.addEventListener("mousedown",r),this.panel.appendChild(n),document.body.appendChild(this.panel)}},{key:"Show",value:function(){this.shown=!0,this.panel.style.display="block",this.RenderPanel()}},{key:"RenderPanel",value:function(){var e=this.img.getBoundingClientRect();this.panel.style.top=e.top+window.scrollY+"px",this.panel.style.left=e.left+window.scrollX+"px",this.panel.style.width=e.width+"px",this.panel.style.height=e.height+"px"}},{key:"Hide",value:function(){this.shown=!1,this.panel.style.display="none"}},{key:"MouseDown",value:function(e,t){var n=this;function i(e){n.StopResize(e)}function o(e){n.Resize(e,t)}this.px=e.pageX,this.f_resize=o,window.removeEventListener("mousemove",o),window.addEventListener("mousemove",o),window.removeEventListener("mouseup",i),window.addEventListener("mouseup",i),e.preventDefault(),e.stopPropagation()}},{key:"Resize",value:function(e,t){var n=e.pageX,i=n-this.px,o=parseInt(getComputedStyle(this.img).width.replace("px",""));t.classList.contains("cir-bottom-right")||t.classList.contains("cir-top-right")?o+=i:o-=i;var r=parseInt(getComputedStyle(this.img).height.replace("px",""));t.classList.contains("cir-bottom-right")||t.classList.contains("cir-top-right")?r+=i:r-=i,this.img.style.width=o+"px",this.img.style.height=r+"px",this.panel.style.width=o+"px",this.panel.style.height=getComputedStyle(this.img).height,this.px=n,this.RenderPanel(),e.preventDefault(),e.stopPropagation()}},{key:"StopResize",value:function(e){window.removeEventListener("mousemove",this.f_resize),this.imgPluginInstance.PushToHistory(),e.preventDefault(),e.stopPropagation()}},{key:"OpenEditingPanel",value:function(e){this.imgPluginInstance.OpenEditingPanel(),e.preventDefault(),e.stopPropagation()}},{key:"MagnifyImage",value:function(e){this.imgPluginInstance.MagnifyImage(),e.preventDefault(),e.stopPropagation()}}]),o);function o(e,t){var n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],i=!(3<arguments.length&&void 0!==arguments[3])||arguments[3];!function(e){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}(this),this.img=e,this.imgPluginInstance=t,this.panel=void 0,this.shown=!1,this.showEditingBtn=n,this.showMagnifyBtn=i,this.InitPanel()}function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function l(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function c(e,t,n){return t&&l(e.prototype,t),n&&l(e,n),e}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}n=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(o,r.Plugin);var n,i,t=(n=o,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e=h(n),t=i?(t=h(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments),e=this;return!t||"object"!==a(t)&&"function"!=typeof t?function(){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function o(e){return function(e){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}(this),(e=t.call(this,e)).readOnly=e.rootNode.document.readOnly,e}return c(o,null,[{key:"GetName",value:function(){return"youtube"}}]),c(o,[{key:"PushToHistory",value:function(){this.rootNode.document.PushToHistory()}},{key:"PluginDidMount",value:function(){var e,t=this;this.rootNode.domElement.style.display="inline-block",this.rootNode.domElement.style.position="relative",this.rootNode.domElement.firstChild.style.pointerEvents="none",this.rootNode.domElement.firstChild.position="absolute",this.rootNode.domElement.firstChild.top=0,this.rootNode.domElement.firstChild.left=0,this.rootNode.domElement.firstChild.width="100%",this.rootNode.domElement.firstChild.height="100%",this.readOnly||(this.resizeManager=new s(this.rootNode.domElement,this,!1,!1),e=function(){t.resizeManager.Show(),t.rootNode.domElement.firstChild.style.pointerEvents="auto"},this.rootNode.domElement.removeEventListener("click",e),this.rootNode.domElement.addEventListener("click",e))}},{key:"Fire",value:function(e){return e==r.PluginActions.LOST_FOCUS&&null!=this.resizeManager&&(this.resizeManager.Hide(),null!=this.rootNode.domElement.firstChild&&(this.rootNode.domElement.firstChild.style.pointerEvents="none")),!1}}],[{key:"getVideoId",value:function(e){return(e=e.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/))&&11===e[2].length?e[2]:null}},{key:"CreateNew",value:function(e,t){e.DeleteSelection(),e.GetNodeAtCursor();var n="https://www.youtube.com/embed/"+o.getVideoId(t.link);return(t=r.InlineNode.CreateNew(e,"span","")).domElement.style.display="inline-block",e.InsertNodeAtCursor(t),n=r.TextNode.CreateNew(e,"iframe","",void 0,[{name:"class",value:"commaYouTubeVideo"},{name:"src",value:n},{name:"allowfullscreen",value:""}]),t.Append(n),n=new o(t),t.domElement.style.width="426px",t.domElement.style.height="240px",n}}]),o}(),t.default=n}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return i[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r;window,e.exports=(r={},o.m=i=[function(e,t,n){},function(e,t,n){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}n.r(t),n.d(t,"default",function(){return _}),n(0);var r=(o(c,[{key:"draw",value:function(){this.build()}},{key:"build",value:function(){var e=this.context.createLinearGradient(0,0,this.width,0);e.addColorStop(0,"rgb(255, 0, 0)"),e.addColorStop(.15,"rgb(255, 0, 255)"),e.addColorStop(.33,"rgb(0, 0, 255)"),e.addColorStop(.49,"rgb(0, 255, 255)"),e.addColorStop(.67,"rgb(0, 255, 0)"),e.addColorStop(.84,"rgb(255, 255, 0)"),e.addColorStop(1,"rgb(255, 0, 0)"),this.context.fillStyle=e,this.context.fillRect(0,0,this.width,this.height),(e=this.context.createLinearGradient(0,0,0,this.height)).addColorStop(0,"rgba(255, 255, 255, 1)"),e.addColorStop(.5,"rgba(255, 255, 255, 0)"),e.addColorStop(.5,"rgba(0, 0, 0, 0)"),e.addColorStop(1,"rgba(0, 0, 0, 1)"),this.context.fillStyle=e,this.context.fillRect(0,0,this.width,this.height),this.context.beginPath(),this.context.arc(this.pickerCircle.x,this.pickerCircle.y,this.pickerCircle.width,0,2*Math.PI),this.context.strokeStyle="#ffffff",this.context.stroke(),this.context.closePath()}},{key:"listenForEvents",value:function(){var o=this;this.canvas.addEventListener("mousemove",function(e){var t=o.canvas.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top;o.pickerCircle.x=n,o.pickerCircle.y=i,o.previewbox.style.backgroundColor=o.getPickedColor(),o.draw()}),this.canvas.addEventListener("click",function(){return o.SelectColor()})}},{key:"getPickedColor",value:function(){var e=this.context.getImageData(this.pickerCircle.x,this.pickerCircle.y,1,1);return"#"+this.fullColorHex(e.data[0],e.data[1],e.data[2])}},{key:"SelectColor",value:function(){try{this.panel.parentNode.removeChild(this.panel)}catch(e){}this.onChangeCallback(this.getPickedColor())}},{key:"rgbToHex",value:function(e){var t=Number(e).toString(16);return t.length<2&&(t="0"+t),t}},{key:"fullColorHex",value:function(e,t,n){return this.rgbToHex(e)+this.rgbToHex(t)+this.rgbToHex(n)}}]),c),s=(o(l,[{key:"_parseSelectedColor",value:function(e){var t,n=e;return null!=e&&-1<e.toLowerCase().indexOf("rgb")&&(t=(e=e.toLowerCase()).split("(")[1].split(")")[0].split(","),n="#"+this._rgbToHex(t[0].split(" ").join(""))+this._rgbToHex(t[1].split(" ").join(""))+this._rgbToHex(t[2].split(" ").join(""))),n}},{key:"_rgbToHex",value:function(e){var t=Number(e).toString(16);return t.length<2&&(t="0"+t),t}},{key:"_showColorPalette",value:function(){var n=this,i=document.createElement("div");i.style.position="absolute",i.style.zIndex="99999",i.style.border="1px solid #e1e1e1",i.style.borderRadius="2px",i.style.backgroundColor="#f9f9f9",i.style.padding="4px 4px 0px 0px",i.style.outline="none",i.setAttribute("tabindex","123");var e=this.event.srcElement.getBoundingClientRect();i.style.left=e.left+parseInt(this.addToLeft)+"px",i.style.top=parseInt(this.addToTop)+window.scrollY+e.height+e.top+"px";var t=[];t.push(["#dfb9b1","#eecdcd","#f8e5d0","#fdf2d0","#dce9d5","#d3dfe2","#ccdaf5","#d2e1f1","#d8d2e7","#e6d2db"]),t.push(["#d08270","#de9c9b","#f2cca2","#fbe5a3","#bcd5ac","#a9c3c8","#a9c2f0","#a6c4e5","#b2a8d2","#cea8bc"]),t.push(["#bd4b31","#d16d6a","#ecb476","#ffefa1","#9dc284","#80a4ad","#779ee5","#7ba7d7","#8b7ebe","#b87f9e"]),t.push(["#982a15","#bb261a","#da944b","#eac251","#78a55a","#53808c","#4a79d1","#4f85c1","#6351a2","#9b5378"]),t.push(["#7a2817","#8c1a11","#a96324","#b89130","#48742c","#264e5b","#2657c5","#24538f","#312071","#6b2346"]);var o=document.createElement("div");o.style.display="flex",o.style.marginTop="2px",o.style.marginBottom="6px",["#000000","#39434d","#666666","#999999","#b7b7b7","#cccccc","#d9d9d9","#efefef","#ffffff","TRANSPARENT"].forEach(function(e){var t=n._getDomCell_colorPicker(e,i);o.appendChild(t)}),i.appendChild(o),t.forEach(function(e){(o=document.createElement("div")).style.display="flex",e.forEach(function(e){var t=n._getDomCell_colorPicker(e,i);o.appendChild(t)}),i.appendChild(o)});var r,s=document.createElement("div");s.style.display="flex",s.style.justifyContent="center",s.style.alignItems="center",s.style.cursor="pointer",s.style.fontFamily="Arial",s.style.padding="2px 4px 2px 4px",s.style.fontSize="14px",s.style.color="#999999",s.textContent="Custom",s.addEventListener("mouseover",function(){this.style.color="#30b7e8"}),s.addEventListener("mouseout",function(){this.style.color="#999999"}),s.addEventListener("click",function(){n.pnl.style.display="none",n.ShowCustomPanel()}),i.appendChild(s),0<this.usedCustomColors.length?((r=document.createElement("div")).style.display="flex",r.style.marginTop="2px",r.style.marginBottom="0px",this.usedCustomColors.forEach(function(e){var t=n._getDomCell_colorPicker(e,i);r.appendChild(t)}),i.appendChild(r)):s.style.padding="2px 4px 4px 4px",i.addEventListener("blur",function(){n.keepOnAfterSelection||this.parentNode.removeChild(this)}),document.body.appendChild(i),i.focus(),this.pnl=i}},{key:"_getDomCell_colorPicker",value:function(e){var t,n=this,i=e,o=this.selectedColor,r=void 0;return"TRANSPARENT"==e?((r=document.createElement("canvas")).width=13,r.height=13,r.style.border="2px solid #ffffff",r.style.margin="0px 0px 4px 4px ",r.style.borderRadius="2px",(t=r.getContext("2d")).fillStyle="#ffffff",t.fillRect(0,0,r.width,r.height),t.strokeStyle="#FF0000",t.lineWidth=2,t.beginPath(),t.moveTo(0,13),t.lineTo(13,0),t.stroke()):((r=document.createElement("div")).style.width="13px",r.style.height="13px",r.style.backgroundColor=i,r.style.margin="0px 0px 4px 4px ",r.style.borderRadius="2px",r.style.border=o==i?"2px solid #30b7e8":"2px solid "+i),r.addEventListener("mouseover",function(){this.style.cursor="pointer",this.style.border="2px solid #30b7e8"}),r.addEventListener("mouseout",function(){this.style.border=i!=o?"TRANSPARENT"==i?"2px solid #ffffff":"2px solid "+i:"2px solid #30b7e8"}),r.addEventListener("click",function(){if(n.callBack(i),!n.keepOnAfterSelection)try{n.pnl.parentNode.removeChild(n.pnl)}catch(e){}}),this.preserveFocus&&r.addEventListener("mousedown",function(e){e.preventDefault()}),r}},{key:"ShowCustomPanel",value:function(){var t=this;new r(this.pnl.style.left,this.pnl.style.top,function(e){t.usedCustomColors.indexOf(e)<0&&(t.usedCustomColors.push(e),10<t.usedCustomColors.length&&t.usedCustomColors.shift(),localStorage.setItem("usedCustomColors",JSON.stringify(t.usedCustomColors))),t.callBack(e),null===t.pnl.parentNode||t.pnl.parentNode.removeChild(t.pnl)})}}]),l);function l(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,o=4<arguments.length&&void 0!==arguments[4]?arguments[4]:void 0,r=5<arguments.length&&void 0!==arguments[5]&&arguments[5],s=6<arguments.length&&void 0!==arguments[6]&&arguments[6];a(this,l),this.event=e,this.callBack=t,this.preserveFocus=s,this.keepOnAfterSelection=r,this.addToLeft=n,this.addToTop=i,this.selectedColor=this._parseSelectedColor(o),this.usedCustomColors=[],"undefined"!=typeof Storage&&(this.usedCustomColors=JSON.parse(localStorage.getItem("usedCustomColors")),null==this.usedCustomColors&&(this.usedCustomColors=[])),this._showColorPalette()}function c(e,t,n){a(this,c),this.onChangeCallback=n;var i=document.createElement("div");i.style.position="absolute",i.style.zIndex="99999",i.style.border="1px solid #e1e1e1",i.style.borderRadius="2px",i.style.backgroundColor="#f9f9f9",i.style.padding="4px",i.style.left=e,i.style.top=t,i.style.outline="none",i.setAttribute("tabindex","3333"),i.addEventListener("blur",function(){this.parentNode.removeChild(this)}),this.canvas=document.createElement("canvas"),this.width=200,this.height=140,this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.style.cursor="pointer",this.context=this.canvas.getContext("2d"),this.pickerCircle={x:10,y:10,width:7,height:7},this.draw(),i.appendChild(this.canvas),this.previewbox=document.createElement("div"),this.previewbox.style.width="200px",this.previewbox.style.height="14px",this.previewbox.style.backgroundColor="rgba(0,0,0,0)",i.appendChild(this.previewbox),this.listenForEvents(),document.body.appendChild(i),i.focus(),this.panel=i}function u(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var h=(u(d.prototype,[{key:"KeepFocusOnEditor",value:function(e){this.toolbar.KeepFocusOnEditor(e)}},{key:"InsertPlugin",value:function(e,t){this.toolbar.InsertPlugin(e,t)}},{key:"Init",value:function(e,t){var n=this;this.tableType=t,this.addTablePnl=void 0,this.addTablePnlCurrentRow=void 0,this.addTablePnlCurrentCol=void 0,this.addTablePnlMinDimension=5,this.moPrevCol=0,this.moPrevRow=0;var i=document.createElement("div");i.style.position="absolute",i.style.zIndex="99999",i.style.border="1px solid #e1e1e1",i.style.borderRadius="2px",i.style.backgroundColor="#f9f9f9",i.style.padding="2px",i.style.display="block",i.style.outline="none",i.setAttribute("tabindex","0");var o=e.srcElement.getBoundingClientRect();i.style.left=o.left+window.scrollX-50+"px",i.style.top=6+o.height+o.top+ +window.scrollY+"px";for(var r=document.createElement("div"),s=0;s<this.addTablePnlMinDimension;){var a=document.createElement("div");a.setAttribute("trow",s),a.style.display="flex";for(var l=0;l<this.addTablePnlMinDimension;)this._addCellToTableRow(a),l++;r.appendChild(a),s++}i.addEventListener("blur",function(){n.addTablePnl=void 0,i.parentNode.removeChild(i)}),i.appendChild(r);var c=document.createElement("div");c.style.padding="4px 4px 2px 4px",c.style.textAlign="center",c.style.fontSize="12px",c.style.color="#7f8082";var u=document.createElement("span");u.innerText="0",c.appendChild(u),this.addTablePnlCurrentCol=u;var h=document.createElement("span");h.appendChild(document.createTextNode(" x ")),c.appendChild(h);var d=document.createElement("span");d.innerText="0",c.appendChild(d),this.addTablePnlCurrentRow=d,i.appendChild(c),document.body.appendChild(i),i.focus(),this.addTablePnl=r}},{key:"_addCellToTableRow",value:function(e){var o=this,t=document.createElement("div");t.style.margin="1px",t.style.border="1px solid #c1c1c1",t.style.borderRadius="2px",t.style.backgroundColor="#ffffff",t.style.cursor="pointer",t.style.width="12px",t.style.height="12px",t.setAttribute("tcol",e.childNodes.length),t.setAttribute("trow",e.getAttribute("trow")),t.addEventListener("mousedown",function(e){o.KeepFocusOnEditor(e)}),t.addEventListener("click",function(){var e=parseInt(this.getAttribute("tcol"))+1,t=parseInt(this.getAttribute("trow"))+1;o.InsertPlugin(o.tableType,{rows:t,cols:e})}),t.addEventListener("mouseover",function(e){var t=parseInt(this.getAttribute("tcol")),n=parseInt(this.getAttribute("trow"));o._highlightTableCells(n,t);var i=o.addTablePnlMinDimension-1;i<=t&&t>o.moPrevCol?o._tableColManager("add"):i-1<=t&&t<o.moPrevCol&&o._tableColManager("remove"),i<=n&&n>o.moPrevRow?o._tableRowManager("add"):i-1<=n&&n<o.moPrevRow&&o._tableRowManager("remove"),o.moPrevCol=t,o.moPrevRow=n}),e.appendChild(t)}},{key:"_tableColManager",value:function(t){var n=this;this.addTablePnl.childNodes.forEach(function(e){"add"==t?n._addCellToTableRow(e):e.removeChild(e.lastChild)})}},{key:"_tableRowManager",value:function(e){if("add"==e){var t=this.addTablePnl.childNodes.length,n=document.createElement("div");n.setAttribute("trow",t),n.style.display="flex";for(var i=this.addTablePnl.firstChild.childNodes.length,o=0;o<i;)this._addCellToTableRow(n),o++;this.addTablePnl.appendChild(n)}else this.addTablePnl.removeChild(this.addTablePnl.lastChild)}},{key:"_highlightTableCells",value:function(i,o){this._updateLabelsTableDimenstion(i,o);var r=0;this.addTablePnl.childNodes.forEach(function(e){var t=!1;r<=i&&(t=!0);var n=0;e.childNodes.forEach(function(e){e.style.border=t&&n<=o?"1px solid #30b7e8":"1px solid #c1c1c1",n++}),r++})}},{key:"_updateLabelsTableDimenstion",value:function(e,t){null!=this.addTablePnlCurrentRow&&(this.addTablePnlCurrentRow.innerText=parseInt(e)+1),null!=this.addTablePnlCurrentCol&&(this.addTablePnlCurrentCol.innerText=parseInt(t)+1)}}]),d);function d(e,t,n){!function(e){if(!(e instanceof d))throw new TypeError("Cannot call a class as a function")}(this),this.toolbar=e,this.Init(t,n)}function f(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var p=(f(g.prototype,[{key:"KeepFocusOnEditor",value:function(e){this.toolbar.KeepFocusOnEditor(e)}},{key:"StoreCursorPosition",value:function(){this.toolbar.StoreCursorPosition()}},{key:"RestoreCursorPosition",value:function(){this.toolbar.RestoreCursorPosition()}},{key:"InsertPlugin",value:function(e,t){this.toolbar.InsertPlugin(e,t)}},{key:"Render",value:function(e){var n=this;n.StoreCursorPosition();var t=document.getSelection(),i=!!t.isCollapsed,o=document.createElement("div");o.style.position="absolute",o.style.zIndex="99999",o.style.border="1px solid #e1e1e1",o.style.borderRadius="2px",o.style.backgroundColor="#f9f9f9",o.style.padding="6px",o.style.overflow="hidden",o.style.outline="none";var r=e.srcElement.getBoundingClientRect();o.style.left=r.left-100+"px",o.style.top=6+r.height+r.top+window.scrollY+"px";var s,a,l=void 0;i&&((s=document.createElement("div")).style.display="flex",s.style.alignItems="center",s.style.marginBottom="4px",(a=document.createElement("div")).style.fontSize="14px",a.style.width="30px",a.style.color="#7f8082",a.innerText="Text ",s.appendChild(a),(l=document.createElement("input")).style.border="1px solid #e1e1e1",l.style.borderRadius="2px",l.style.fontSize="12px",l.style.color="#57595e",l.style.padding="4px",l.style.outline="none",l.addEventListener("keydown",function(e){"Esc"!=e.key&&"Escape"!=e.key||(n.RestoreCursorPosition(),o.parentNode.removeChild(o))}),l.addEventListener("focus",function(e){n.isFocusOnLabel=!0,n.isFocusOnUrl=!1}),l.addEventListener("blur",function(e){n.isFocusOnLabel=!1,setTimeout(function(){n.isFocusOnUrl||null!=o.parentNode&&(n.RestoreCursorPosition(),o.parentNode.removeChild(o))},200)}),s.appendChild(l),o.appendChild(s));var c=document.createElement("div");c.style.display="flex",c.style.alignItems="center",c.style.marginBottom="4px";var u=document.createElement("div");u.style.fontSize="14px",u.style.width="30px",u.style.color="#7f8082",u.innerText="Link ",c.appendChild(u);var h=document.createElement("input");h.style.border="1px solid #e1e1e1",h.style.borderRadius="2px",h.style.fontSize="12px",h.style.color="#57595e",h.style.padding="4px",h.style.outline="none",h.addEventListener("keydown",function(e){"Esc"!=e.key&&"Escape"!=e.key||(n.RestoreCursorPosition(),o.parentNode.removeChild(o))}),h.addEventListener("focus",function(e){n.isFocusOnLabel=!1,n.isFocusOnUrl=!0}),h.addEventListener("blur",function(e){n.isFocusOnUrl=!1,setTimeout(function(){n.isFocusOnLabel||null!=o.parentNode&&(n.RestoreCursorPosition(),o.parentNode.removeChild(o))},200)}),c.appendChild(h),o.appendChild(c);var d=document.createElement("div");d.style.display="flex",d.style.justifyContent="flex-end";var f=document.createElement("div");f.style.fontSize="14px",f.style.color="#7f8082",f.style.textAlign="center",f.style.cursor="pointer",f.style.padding="4px",f.style.border="1px solid #f9f9f9",f.innerText="Apply",f.addEventListener("mouseover",function(e){this.style.color="#FF9100"}),f.addEventListener("mouseout",function(e){this.style.color="#7f8082"}),f.addEventListener("click",function(e){var t={};t.url=h.value,t.label="",i&&(t.label=l.value),n.RestoreCursorPosition(),n.InsertPlugin("link",t)}),d.appendChild(f),o.appendChild(d),document.body.appendChild(o),h.focus()}}]),g);function g(e,t){!function(e){if(!(e instanceof g))throw new TypeError("Cannot call a class as a function")}(this),this.toolbar=e,this.Render(t)}function m(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var v=(m(y.prototype,[{key:"KeepFocusOnEditor",value:function(e){this.toolbar.KeepFocusOnEditor(e)}},{key:"StoreCursorPosition",value:function(){this.toolbar.StoreCursorPosition()}},{key:"RestoreCursorPosition",value:function(){this.toolbar.RestoreCursorPosition()}},{key:"InsertPlugin",value:function(e,t){this.toolbar.InsertPlugin(e,t)}},{key:"Render",value:function(e){var n=this;n.StoreCursorPosition();var t=document.createElement("div");t.style.position="absolute",t.style.zIndex="99999",t.style.border="1px solid #e1e1e1",t.style.borderRadius="2px",t.style.backgroundColor="#f9f9f9",t.style.padding="6px",t.style.overflow="hidden",t.style.outline="none";var i=e.srcElement.getBoundingClientRect();t.style.left=window.scrollX+i.left-100+"px",t.style.top=6+window.scrollY+i.height+i.top+"px";var o=document.createElement("div");o.style.display="flex",o.style.alignItems="center",o.style.marginBottom="4px";var r=document.createElement("div");r.style.fontSize="14px",r.style.width="114px",r.style.color="#7f8082",r.innerText="Split document in ",o.appendChild(r);var s=document.createElement("input");s.style.border="1px solid #e1e1e1",s.style.borderRadius="2px",s.style.fontSize="12px",s.style.color="#57595e",s.style.padding="4px",s.style.width="20px",s.style.outline="none",s.value=2,s.addEventListener("keydown",function(e){"Esc"!=e.key&&"Escape"!=e.key||(n.RestoreCursorPosition(),t.parentNode.removeChild(t))}),s.addEventListener("focus",function(e){n.isFocusOnLabel=!1,n.isFocusOnUrl=!0}),s.addEventListener("blur",function(e){n.isFocusOnUrl=!1,setTimeout(function(){n.isFocusOnLabel||null!=t.parentNode&&(n.RestoreCursorPosition(),t.parentNode.removeChild(t))},200)}),o.appendChild(s);var a=document.createElement("div");a.style.fontSize="14px",a.style.width="60px",a.style.color="#7f8082",a.innerHTML="&nbsp;columns",o.appendChild(a),t.appendChild(o);var l=document.createElement("div");l.style.display="flex",l.style.justifyContent="flex-end";var c=document.createElement("div");c.style.fontSize="14px",c.style.color="#7f8082",c.style.textAlign="center",c.style.cursor="pointer",c.style.padding="8px 4px 4px 4px",c.style.border="1px solid #f9f9f9",c.innerText="Apply",c.addEventListener("mouseover",function(e){this.style.color="#FF9100"}),c.addEventListener("mouseout",function(e){this.style.color="#7f8082"}),c.addEventListener("click",function(e){var t={};t.cols=parseInt(s.value),n.RestoreCursorPosition(),n.InsertPlugin("multiColumns",t)}),l.appendChild(c),t.appendChild(l),document.body.appendChild(t),s.focus()}}]),y);function y(e,t){!function(e){if(!(e instanceof y))throw new TypeError("Cannot call a class as a function")}(this),this.toolbar=e,this.Render(t)}function b(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var C=(b(x.prototype,[{key:"StoreCursorPosition",value:function(){this.toolbar.StoreCursorPosition()}},{key:"RestoreCursorPosition",value:function(){this.toolbar.RestoreCursorPosition()}},{key:"Destroy",value:function(){try{this.pnl.parentNode.removeChild(this.pnl)}catch(e){}}},{key:"Render",value:function(){var n=this;this.StoreCursorPosition();var i=document.createElement("div");i.style.position="absolute",i.style.zIndex="99999999",i.style.border="1px solid #e1e1e1",i.style.borderRadius="2px",i.style.backgroundColor="#f9f9f9",i.style.padding="0px",i.style.overflow="auto",i.style.outline="none",i.style.display="block",i.setAttribute("tabindex","123");var e=this.btn.getBoundingClientRect();i.style.left=window.scrollX+e.left+"px",i.style.top=window.scrollY+e.height+e.top+"px",i.style.maxHeight="120px",i.addEventListener("blur",function(e){i.parentNode.removeChild(i),n.RestoreCursorPosition()}),this.values.forEach(function(e){var t=document.createElement("div");t.classList.add("cm-toolbar-select-label"),e.value==n.currentValue&&t.classList.add("cm-toolbar-select-label-selected"),t.textContent=e.label,t.addEventListener("click",function(){n.RestoreCursorPosition(),n.onClick(e.value)}),i.appendChild(t)}),document.body.appendChild(i),i.focus(),this.pnl=i}}]),x);function x(e,t,n,i,o){!function(e){if(!(e instanceof x))throw new TypeError("Cannot call a class as a function")}(this),this.toolbar=e,this.btn=t,this.values=n,this.currentValue=i,this.onClick=o,this.Render()}function w(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var S=["separator","outline","bold","italic","underlined","strike","fontSize","fontFamily","fontColor","backgroundColor","align-left","align-center","align-right","align-justify","indent","dedent","numbered-list","list","horizontal-rule","table","spreadsheet","superscript","subscript","links","tasks","multi-columns","stickynotes","fileUpload","code"],_=(w(E.prototype,[{key:"Render",value:function(){var n=this,i=document.getElementById(this.idContainer);i.classList.add("cm-toolbar-container"),null!=this.options.style&&"small"==this.options.style&&(i.style.padding="2px 0px",i.style.margin="0px"),i.innerHTML="&nbsp;";var e=["outline","separator","bold","italic","underlined","strike","separator","fontSize","fontFamily","separator","fontColor","backgroundColor","separator","align-left","align-center","align-right","align-justify","separator","indent","dedent","separator","numbered-list","list","separator","horizontal-rule","table","spreadsheet","superscript","subscript","links","tasks","multi-columns","stickynotes","fileUpload","code"],t=this.options.buttons;"all"==t?t=e:"mini"==t?t=["bold","italic","underlined","strike","separator","fontSize","fontFamily","fontColor","separator","numbered-list","list","separator","table","spreadsheet","separator","links","tasks","stickynotes"]:null!=t&&""!=t||(t=e),t.forEach(function(e){var t;"string"==typeof e?"separator"==e?((t=document.createElement("div")).classList.add("cm-toolbar-separator"),i.appendChild(t)):"outline"==e?(i.appendChild(n.CreateButton(e)),i.appendChild(n.CreateNewOutlineButton())):"fontSize"==e?i.appendChild(n.CreateFontSizeButton()):"fontFamily"==e?i.appendChild(n.CreateFontFamilyButton()):i.appendChild(n.CreateButton(e)):i.appendChild(n.AddCustomButton(e))})}},{key:"GenerateNewButtonId",value:function(e){null==this.allMenuButtons&&(this.allMenuButtons={});var t="cmTooolBtn"+Object.keys(this.allMenuButtons).length+1;return this.allMenuButtons[e]=t}},{key:"CreateButton",value:function(e){var t=this,n=document.createElement("div");n.classList.add("cm-toolbar-button"),n.setAttribute("id",this.GenerateNewButtonId(e));var i=e,o=document.createElement("i");o.classList.add("fa");var r=void 0;return"outline"==i?(n.title="Table Of Contents",o.classList.add("fa-bars"),r=function(){t.CallPluginStaticMethod("outline","OpenNavigationPanel")}):"bold"==i?(n.title="Bold",o.classList.add("fa-bold"),r=function(){t.ToggleStyleOnSelection("bold")}):"italic"==i?(n.title="Italic",o.classList.add("fa-italic"),r=function(){t.ToggleStyleOnSelection("italic")}):"underlined"==i?(n.title="Underlined",o.classList.add("fa-underline"),r=function(){t.ToggleStyleOnSelection("underlined")}):"strike"==i?(n.title="Strikethrough",o.classList.add("fa-strikethrough"),r=function(){t.ToggleStyleOnSelection("strike")}):"fontColor"==i?(n.title="Font Color",o.classList.add("fa-tint"),r=function(e){t.OpenPickFontColorPanel(e)}):"backgroundColor"==i?(n.title="Background Color",o.classList.add("fa-paint-brush"),r=function(e){t.OpenPickBgColorPanel(e)}):"align-left"==i?(n.title="Align Left",o.classList.add("fa-align-left"),r=function(){t.ToggleStyleOnLine("align","left")}):"align-center"==i?(n.title="Align Center",o.classList.add("fa-align-center"),r=function(){t.ToggleStyleOnLine("align","center")}):"align-right"==i?(n.title="Align Right",o.classList.add("fa-align-right"),r=function(){t.ToggleStyleOnLine("align","right")}):"align-justify"==i?(n.title="Align Justify",o.classList.add("fa-align-justify"),r=function(){t.ToggleStyleOnLine("align","justify")}):"indent"==i?(n.title="Indent",o.classList.add("fa-indent"),r=function(){t.ToggleStyleOnLine("indent","add")}):"dedent"==i?(n.title="Dedent",o.classList.add("fa-dedent"),r=function(){t.ToggleStyleOnLine("indent","subtract")}):"numbered-list"==i?(n.title="Numbered List",o.classList.add("fa-list-ol"),r=function(){t.InsertPlugin("lists","numbered")}):"list"==i?(n.title="List",o.classList.add("fa-list-ul"),r=function(){t.InsertPlugin("lists","bulleted")}):"horizontal-rule"==i?(n.title="Horizontal Rule",o.classList.add("fa-minus"),r=function(){t.InsertPlugin("horizontalRule")}):"table"==i?(n.title="Table",o.classList.add("fa-table"),r=function(e){t.OpenAddTable(e,"table")}):"spreadsheet"==i?(n.title="Spreadsheet",o.classList.add("fa-file-excel-o"),r=function(e){t.OpenAddTable(e,"spreadsheet")}):"superscript"==i?(n.title="Superscript",o.classList.add("fa-superscript"),r=function(){console.log("superscript"),t.ToggleStyleOnSelection("superscript")}):"subscript"==i?(n.title="Subscript",o.classList.add("fa-subscript"),r=function(){t.ToggleStyleOnSelection("subscript")}):"links"==i?(n.title="Link",o.classList.add("fa-link"),r=function(e){t.OpenAddLink(e)}):"tasks"==i?(n.title="Tasks",o.classList.add("fa-check-square"),r=function(){t.InsertPlugin("tasks")}):"multi-columns"==i?(n.title="Multi columns document",o.classList.add("fa-columns"),r=function(e){t.OpenPickNumberOfColumns(e)}):"stickynotes"==i?(n.title="Stickynote",o.classList.add("fa-sticky-note"),r=function(e){t.OpenPickStickyNoteBgColorPanel(e)}):"fileUpload"==i?(n.title="Upload File",o.classList.add("fa-upload"),r=function(){t.OpenFileUpload()}):"code"==i&&(n.title="Code",o.classList.add("fa-code"),r=function(){t.InsertPlugin("code")}),n.addEventListener("mousedown",this.KeepFocusOnEditor),n.addEventListener("click",r),n.appendChild(o),n}},{key:"AddCustomButton",value:function(e){null==this.customBtnCounter&&(this.customBtnCounter=0),this.customBtnCounter++;var t=document.createElement("div");t.classList.add("cm-toolbar-button"),t.setAttribute("id",this.GenerateNewButtonId("custom"+this.customBtnCounter)),t.title=e.title;var n=document.createElement("i");return n.classList.add("fa"),t.addEventListener("mousedown",this.KeepFocusOnEditor),t.addEventListener("click",e.onClick),n.classList.add(e.faIcon),t.appendChild(n),t}},{key:"CreateFontSizeButton",value:function(){var t=this,e=document.createElement("div");e.classList.add("cm-toolbar-button"),e.classList.add("cm-toolbar-label-button"),e.setAttribute("id",this.GenerateNewButtonId("fontSize")),e.title="Font Size";var n=document.createElement("div");n.style.marginRight="4px",n.textContent="12px",e.appendChild(n);var i=document.createElement("i");return i.classList.add("fa"),i.classList.add("fa-caret-down"),e.appendChild(i),e.addEventListener("mousedown",this.KeepFocusOnEditor),e.addEventListener("click",function(e){t.OpenFontSizePanel(e)}),this.fontSizeButton=e}},{key:"OpenFileUpload",value:function(){var o=document.createElement("input");o.type="file",o.style.display="none";var r=this.options.onUploadFiles;o.addEventListener("change",function(){for(var e=this.files,t=[],n=0,i=e.length;n<i;n++)t.push(e[n]);null!=r&&r(t),o.parentElement.removeChild(o)}),document.body.appendChild(o),o.click()}},{key:"CreateFontFamilyButton",value:function(){var t=this,e=document.createElement("div");e.classList.add("cm-toolbar-button"),e.classList.add("cm-toolbar-label-button"),e.setAttribute("id",this.GenerateNewButtonId("fontFamily")),e.title="Font Family";var n=document.createElement("div");n.style.marginRight="4px",n.style.whiteSpace="nowrap",n.style.width="56px",n.style.overflow="hidden",n.textContent="Verdana",e.appendChild(n);var i=document.createElement("i");return i.classList.add("fa"),i.classList.add("fa-caret-down"),e.appendChild(i),e.addEventListener("mousedown",this.KeepFocusOnEditor),e.addEventListener("click",function(e){t.OpenFontFamilyPanel(e)}),this.fontFamilyButton=e}},{key:"CreateNewOutlineButton",value:function(){var t=this,e=document.createElement("div");e.classList.add("cm-toolbar-button"),e.classList.add("cm-toolbar-label-button"),e.setAttribute("id",this.GenerateNewButtonId("outlineSelect")),e.title="Table of Contents";var n=document.createElement("div");n.style.marginRight="4px",n.style.whiteSpace="nowrap",n.style.width="70px",n.style.overflow="hidden",n.textContent="Normal",e.appendChild(n);var i=document.createElement("i");return i.style.display="block",i.classList.add("fa"),i.classList.add("fa-caret-down"),e.appendChild(i),e.addEventListener("mousedown",this.KeepFocusOnEditor),e.addEventListener("click",function(e){t.OpenOutlinePanel(e)}),this.outlineButton=e}},{key:"CalculateCurrentStyle",value:function(s){var a=this;this.currentStyle=s,S.forEach(function(e){var t,n,i,o,r=a.allMenuButtons[e];null!=r&&""!=r&&((t=document.getElementById(r)).className=t.className.replace(" cm-toolbar-button-selected",""),"fontColor"==e||"backgroundColor"==e?null!=a.options.defaultStyle&&("fontColor"==e?(n=a.allMenuButtons[e],o=document.getElementById(n),null!=a.options.defaultStyle.fontColor?o.firstChild.style.color=a.options.defaultStyle.fontColor:o.firstChild.style.color="#39434d"):"backgroundColor"==e&&(i=a.allMenuButtons[e],o=document.getElementById(i),null!=a.options.defaultStyle.backgroundColor?o.firstChild.style.color=a.options.defaultStyle.backgroundColor:o.firstChild.style.color="#5e626b")):"outline"==e&&(a.outlineButton.firstChild.textContent="Normal"))}),null!=s&&(null!=s.nodeStyle&&Object.keys(s.nodeStyle).forEach(function(e){var t,n,i,o,r=s.nodeStyle[e];"style"==r.applyAs?r.isToggle?null!=(t=a.allMenuButtons[e])&&""!=t&&null!=(o=document.getElementById(t))&&(o.className=o.className+" cm-toolbar-button-selected"):null!=(n=a.allMenuButtons[e])&&""!=n&&null!=(o=document.getElementById(n))&&("fontColor"==e||"backgroundColor"==e?o.firstChild.style.color=r.on:"fontFamily"==e?a.fontFamilyButton.firstChild.textContent=r.on.replace(/'/g,""):"fontSize"==e&&(a.fontSizeButton.firstChild.textContent=r.on)):"class"==r.applyAs&&(!r.isToggle||null!=(i=a.allMenuButtons[e])&&""!=i&&null!=(o=document.getElementById(i))&&(o.className=o.className+" cm-toolbar-button-selected"),"headerone"==e.toLowerCase()?a.outlineButton.firstChild.textContent="Header 1":"headertwo"==e.toLowerCase()?a.outlineButton.firstChild.textContent="Header 2":"headerthree"==e.toLowerCase()?a.outlineButton.firstChild.textContent="Header 3":a.outlineButton.firstChild.textContent="Normal")}),null!=s.lineStyle&&Object.keys(s.lineStyle).forEach(function(e){var t,n,i=s.lineStyle[e];"style"==i.applyAs&&i.isToggle&&(null==(t=a.allMenuButtons[e+"-"+i.on])||""==t||null!=(n=document.getElementById(t))&&(n.className=n.className+" cm-toolbar-button-selected"))}))}},{key:"KeepFocusOnEditor",value:function(e){null!=this.currentOpenSelect&&this.currentOpenSelect.Destroy(),e.preventDefault()}},{key:"StoreCursorPosition",value:function(){this.commaInstance.StoreCursorPosition()}},{key:"RestoreCursorPosition",value:function(){this.commaInstance.RestoreCursorPosition()}},{key:"InsertPlugin",value:function(e,t){this.commaInstance.InsertPluginAtSection(e,t)}},{key:"CallPluginStaticMethod",value:function(e,t,n){this.commaInstance.CallPluginStaticMethod(e,t,n)}},{key:"ToggleStyleOnSelection",value:function(e,t){this.commaInstance.ToggleStyleOnSelection(e,t)}},{key:"ToggleStyleOnLine",value:function(e,t){this.commaInstance.ToggleStyleOnLine(e,t)}},{key:"OpenPickFontColorPanel",value:function(e){this.ShowColorPalette("fontColor",e)}},{key:"OpenPickBgColorPanel",value:function(e){this.ShowColorPalette("backgroundColor",e)}},{key:"OpenPickStickyNoteBgColorPanel",value:function(e){this.ShowColorPalette("stickyNote",e)}},{key:"OpenPickNumberOfColumns",value:function(e){new v(this,e)}},{key:"ShowColorPalette",value:function(e,t){var n=this;this.changeColorAction=e;var i="";"fontColor"==this.changeColorAction?null!=this.currentStyle.nodeStyle&&null!=this.currentStyle.nodeStyle.fontColor&&(i=this.currentStyle.nodeStyle.fontColor.on):"backgroundColor"==e&&null!=this.currentStyle.nodeStyle&&null!=this.currentStyle.nodeStyle.backgroundColor&&(i=this.currentStyle.nodeStyle.backgroundColor.on),this.StoreCursorPosition(),new s(t,function(e){n.ChangeColor(e)},-80,6,i)}},{key:"ChangeColor",value:function(e){this.RestoreCursorPosition(),"fontColor"==this.changeColorAction?this.ToggleStyleOnSelection("fontColor",e):"backgroundColor"==this.changeColorAction?this.ToggleStyleOnSelection("backgroundColor",e):"stickyNote"==this.changeColorAction&&this.InsertPlugin("stickynote",{bgColor:e})}},{key:"OpenAddTable",value:function(e,t){new h(this,e,t)}},{key:"OpenAddLink",value:function(e){new p(this,e)}},{key:"OpenFontSizePanel",value:function(){var t=this,e=[{label:"10px",value:"10px"},{label:"12px",value:"12px"},{label:"14px",value:"14px"},{label:"16px",value:"16px"},{label:"18px",value:"18px"},{label:"20px",value:"20px"},{label:"22px",value:"22px"},{label:"26px",value:"26px"},{label:"30px",value:"30px"},{label:"36px",value:"36px"},{label:"50px",value:"50px"},{label:"80px",value:"80px"}];null!=this.options.fontSizes&&0<this.options.fontSizes.length&&(e=this.options.fontSizes),null!=this.currentOpenSelect&&this.currentOpenSelect.Destroy();var n="";null!=this.currentStyle&&null!=this.currentStyle.nodeStyle&&null!=this.currentStyle.nodeStyle.fontSize&&null!=this.currentStyle.nodeStyle.fontSize.on&&(n=this.currentStyle.nodeStyle.fontSize.on),this.currentOpenSelect=new C(this,this.fontSizeButton,e,n,function(e){t.ToggleStyleOnSelection("fontSize",e)})}},{key:"OpenFontFamilyPanel",value:function(){var t=this,e=[{label:"Times New Roman",value:"'Times New Roman'"},{label:"Georgia",value:"Georgia"},{label:"Palatino",value:"Palatino"},{label:"Arial Black",value:"'Arial Black'"},{label:"Comic Sans MS",value:"Comic Sans MS"},{label:"Lucida Sans Unicode",value:"'Lucida Sans Unicode'"},{label:"Tahoma",value:"Tahoma"},{label:"Trebuchet MS",value:"'Trebuchet MS'"},{label:"Verdana",value:"Verdana"},{label:"Courier New",value:"'Courier New'"},{label:"Lucida Console",value:"'Lucida Console'"}];null!=this.options.fontFamilies&&0<this.options.fontFamilies.length&&(e=this.options.fontFamilies);var n="";null!=this.currentStyle&&null!=this.currentStyle.nodeStyle&&null!=this.currentStyle.nodeStyle.fontFamily&&null!=this.currentStyle.nodeStyle.fontFamily.on&&(n=this.currentStyle.nodeStyle.fontFamily.on),null!=this.currentOpenSelect&&this.currentOpenSelect.Destroy(),this.currentOpenSelect=new C(this,this.fontFamilyButton,e,n,function(e){t.ToggleStyleOnSelection("fontFamily",e)})}},{key:"OpenOutlinePanel",value:function(){var t=this;null!=this.currentStyle&&null!=this.currentStyle.nodeStyle&&null!=this.currentStyle.nodeStyle.outline&&null!=this.currentStyle.nodeStyle.outline.on&&(currentFont=this.currentStyle.nodeStyle.outline.on),null!=this.currentOpenSelect&&this.currentOpenSelect.Destroy(),this.currentOpenSelect=new C(this,this.outlineButton,[{label:"Heading 1",value:"h1"},{label:"Heading 2",value:"h2"},{label:"Heading 3",value:"h3"},{label:"Normal",value:"normal"}],"",function(e){t.InsertPlugin("outline",e)})}}]),E);function E(e,t,n){!function(e){if(!(e instanceof E))throw new TypeError("Cannot call a class as a function")}(this),this.commaInstance=e,this.idContainer=t,this.options=n,this.options.defaultStyle=this.commaInstance.GetStyleAtCarret(),this.currentStyle=void 0,this.Render(),this.CalculateCurrentStyle(this.commaInstance.GetStyleAtCarret())}}],o.c=r,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){function o(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return i[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r;window,e.exports=(r={},o.m=i=[function(e,t,n){"use strict";function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}n.r(t),n.d(t,"default",function(){return o});var o=(i(r.prototype,[{key:"Init",value:function(){var t=this,e=this.GetMainPnl();null!=e&&(e.addEventListener("dragenter",function(e){t.ShowDropPanel(),e.preventDefault()}),e.addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation()}))}},{key:"GetMainPnl",value:function(){return"string"==typeof this.idEditor?document.getElementById(this.idEditor):this.idEditor}},{key:"ShowDropPanel",value:function(){var e,t,n,i,o=this;this.showingDropPanl||(this.showingDropPanl=!0,null!=(e=this.GetMainPnl())&&((t=document.createElement("div")).style.backgroundColor="rgba(156, 156, 156,0.4)",t.style.position="absolute",t.style.display="flex",t.style.justifyContentsplay="center",t.style.alignItems="stretch",t.style.zIndex=99999,n=e.getBoundingClientRect(),t.style.width=n.width+"px",t.style.height=n.height+"px",t.style.left=window.scrollX+n.left+"px",t.style.top=window.scrollY+n.top+"px",(i=document.createElement("div")).style.border="2px dotted rgba(156, 156, 156, 0.8)",i.style.borderRadius="10px",i.style.margin="30px",i.style.flex=1,i.style.pointerEvents="none",t.appendChild(i),t.addEventListener("dragover",function(e){e.preventDefault(),e.stopPropagation()}),t.addEventListener("dragleave",function(e){o.HideDropPanel()}),t.addEventListener("drop",function(e){o.HideDropPanel(),o.ManageDrop(e),e.preventDefault(),e.stopPropagation()}),this.overPnl=t,document.body.appendChild(this.overPnl)))}},{key:"HideDropPanel",value:function(){this.showingDropPanl=!1,null!=this.overPnl&&(this.overPnl.parentElement.removeChild(this.overPnl),this.overPnl=void 0)}},{key:"ManageDrop",value:function(e){var t=[];if(e.dataTransfer.items)for(var n,i=0;i<e.dataTransfer.items.length;i++)"file"===e.dataTransfer.items[i].kind&&(n=e.dataTransfer.items[i].getAsFile(),t.push(n));else for(i=0;i<e.dataTransfer.files.length;i++)t.push(e.dataTransfer.files[i]);null!=this.onFilesDrop?this.onFilesDrop(t):console.log("CommaJS: please specify a function to handle file(s) drop")}}]),r);function r(e,t){!function(e){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this),this.idEditor=e,this.showingDropPanl=!1,this.onFilesDrop=t,null!=this.onFilesDrop&&this.Init()}}],o.c=r,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=0))},function(e,t,n){function o(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var i,r,s;window,e.exports=(i=n(0),s={},o.m=r=[function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t);var s=n(0);function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}n=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(r,s.Plugin);var n,i,o=(n=r,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}(),function(){var e=u(n),t=i?(t=u(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments),e=this;return!t||"object"!==a(t)&&"function"!=typeof t?function(){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}():t});function r(e){var t;return function(e){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this),(t=o.call(this,e)).preContainer=e.children[0].children[0],t.preContainer.domElement.style.margin="0px",t}return l(r,null,[{key:"GetName",value:function(){return"code"}}]),l(r,[{key:"Fire",value:function(e,t,n,i){var o=!1;switch(e){case s.PluginActions.CANCEL_FROM_TOP:o=!0;break;case s.PluginActions.DELETE_FROM_BOTTOM:this.rootNode.document.DeleteNode(this.rootNode),n.DeletePluginInstance(this),o=!1;break;case s.PluginActions.BEFORE_PASTE:var r=i.clipboardData.getData("text/plain");this.preContainer.ForceInsertString(r),o=!0;break;case s.PluginActions.ENTER:this.preContainer.ForceInsertString("\n"),o=!0;break;case s.PluginActions.TAB:this.preContainer.ForceInsertString("    "),o=!0;break;case s.PluginActions.APPLY_STYLE_ON_LINE:case s.PluginActions.APPLY_STYLE_ON_TEXT:o=!0;break;case s.PluginActions.SELECT_ALL:e=document.createRange(),n=window.getSelection(),null!=(i=this.preContainer.domElement).firstChild&&(r=this.preContainer.text.length,e.setStart(i.firstChild,0),e.setEnd(i.firstChild,r),n.removeAllRanges(),n.addRange(e)),o=!0;break;default:return}return o}}],[{key:"CreateNew",value:function(e){e.DeleteSelection();var t=e.GetCurrentStyle(),n=e.GetNodeAtCursor().GetBlockContainer().InsertEmptyBlockNodeAfter("div");n.SetAttributes([{name:"class",value:"commaCodeContainer"}]);var i=s.BlockNode.CreateNew(e,"div"),o=s.TextNode.CreateNew(e,"pre","");return o.ToggleStyle("fontFamily","monospace",!0),o.ToggleStyle("fontSize","14px",!0),i.Append(o),n.Append(i),i=n.InsertEmptyBlockNodeAfter("div"),t=s.TextNode.CreateNew(e,"span"," ",t),i.Append(t),setTimeout(function(){o.SetFocus()},50),new r(n)}}]),r}(),t.default=n}],o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=1))},function(e,t,n){"use strict";n.r(t),n.d(t,"default",function(){return H});var o=n(0),r=n.n(o),i=n(5),s=n.n(i),a=n(6),l=n.n(a),c=n(7),u=n.n(c),h=n(1),d=n.n(h),f=n(8),p=n.n(f),g=n(9),m=n.n(g),v=n(10),y=n.n(v),b=n(3),C=n.n(b),x=n(11),w=n.n(x),S=n(12),_=n.n(S),E=n(2),T=n.n(E),k=n(4),O=n.n(k),A=n(13),P=n(15),N=n.n(P),F=n(16),M=n.n(F),R=n(14),D=n.n(R),I=n(17),L=n.n(I);function B(t,e){var n,i=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)),i}function j(o){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?B(Object(r),!0).forEach(function(e){var t,n,i;t=o,i=r[n=e],n in t?Object.defineProperty(t,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[n]=i}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(r)):B(Object(r)).forEach(function(e){Object.defineProperty(o,e,Object.getOwnPropertyDescriptor(r,e))})}return o}function G(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var H=function(){function i(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:void 0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:void 0;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),this.CalculateOptions(t),this.idEditorContainer="ed"+e,this.editorContainer=document.createElement("div"),this.editorContainer.id=this.idEditorContainer,this.editorContainer.setAttribute("style","padding: 20px"),this.mainContainer=document.getElementById(e),this.options.readOnly||(this.idToolbarContainer="tb"+e,this.toolbarContainer=document.createElement("div"),this.toolbarContainer.id=this.idToolbarContainer,this.mainContainer.appendChild(this.toolbarContainer)),this.mainContainer.appendChild(this.editorContainer),this.options.allowFilesDrop=!1,this.commaEditor=new r.a(this.idEditorContainer,this.options),this.options.readOnly||(null==n&&(n={defaultStyle:this.options.defaultStyle,buttons:this.options.buttons,onUploadFiles:this.options.onUploadFiles,fontFamilies:this.options.fontFamilies,fontSizes:this.options.fontSizes}),null==n.onUploadFiles&&null!=this.options.onUploadFiles&&(n.onUploadFiles=this.options.onUploadFiles,this.options.allowFilesDrop=!0),null==n.defaultStyle&&null!=this.options.defaultStyle&&(n.defaultStyle=this.options.defaultStyle),this.toolbar=new N.a(this.commaEditor,this.idToolbarContainer,n)),this.options.allowFilesDrop&&new M.a(this.idEditorContainer,this.options.onUploadFiles)}var e,t,n;return e=i,n=[{key:"GetPluginImageName",value:function(){return T.a.GetName()}},{key:"GetPluginVideoName",value:function(){return _.a.GetName()}},{key:"GetPluginListsName",value:function(){return s.a.GetName()}},{key:"GetPluginTableName",value:function(){return l.a.GetName()}},{key:"GetPluginHorizontalRuleName",value:function(){return u.a.GetName()}},{key:"GetPluginLinkName",value:function(){return d.a.GetName()}},{key:"GetPluginTasksName",value:function(){return p.a.GetName()}},{key:"GetPluginMultiColumnsName",value:function(){return m.a.GetName()}},{key:"GetPluginSpreadsheetName",value:function(){return y.a.GetName()}},{key:"GetPluginTableOfContentsName",value:function(){return C.a.GetName()}},{key:"GetPluginOutlineName",value:function(){return C.a.GetName()}},{key:"GetPluginStickyNoteName",value:function(){return w.a.GetName()}},{key:"GetPluginYouTubeName",value:function(){return D.a.GetName()}}],(t=[{key:"CalculateOptions",value:function(e){var t=this;this.options={buttons:"all",readOnly:!1,content:void 0,styles:void 0,defaultStyle:{fontSize:"14px",fontFamily:"Verdana",fontColor:"#39434d"},defaultLineStyle:{align:"left"},catchUserInput:{characters:["enter"],onCharacterEntered:function(){return!1}},shortcuts:[{shortcut:"Ctrl+w",action:"insertText",params:{text:"E"}},{shortcut:"Ctrl+q",action:"insertPlugin",params:{pluginName:"table",pluginParams:{rows:2,cols:2}}},{shortcut:"Ctrl+q",action:"function",params:function(){console.log("asd")}}],autocorrect:[{string:"\\mu",replaceWith:"Î¼"}],onChange:function(){},onSelectinChange:function(){},styleMonitoring:function(e){t.CalculateCurrentStyle(e)},onStyleChanged:function(){}};var n=void 0;null!=e&&(n=e.plugins,this.options=j(j({},this.options),e)),this.options.plugins=[{pClass:s.a},{pClass:l.a},{pClass:u.a},{pClass:p.a},{pClass:m.a},{pClass:y.a},{pClass:C.a},{pClass:w.a},{pClass:_.a},{pClass:D.a},{pClass:L.a}],null!=n?(null!=n.links?this.options.plugins.push({pClass:d.a,options:n.links}):this.options.plugins.push({pClass:d.a}),null!=n.images?this.options.plugins.push({pClass:T.a,options:{externalFunctions:n.images,imageEditor:O.a}}):this.options.plugins.push({pClass:T.a,imageEditor:O.a}),null!=n.mentions&&(null!=n.mentions.factory.charForFire&&""!=n.mentions.factory.charForFire||(n.mentions.factory.charForFire="@"),this.options.plugins.push({pClass:A.CommaMentionsFactory,options:{fireOnChar:!0,charForFire:n.mentions.factory.charForFire,fireCreateNew:!0,fireStaticFunction:"",externalFunctions:n.mentions.factory,showAbove:n.mentions.factory.showAbove}}),this.options.plugins.push({pClass:A.CommaMention,options:{externalFunctions:n.mentions.mention}}))):(this.options.plugins.push({pClass:d.a}),this.options.plugins.push({pClass:T.a,imageEditor:O.a}))}},{key:"CalculateCurrentStyle",value:function(e){null!=this.toolbar&&this.toolbar.CalculateCurrentStyle(e)}},{key:"Debug",value:function(e){this.commaEditor.Debug(e)}},{key:"isContentEmpty",value:function(){return this.commaEditor.isContentEmpty()}},{key:"Undo",value:function(){return this.commaEditor.Undo()}},{key:"Redo",value:function(){return this.commaEditor.Redo()}},{key:"Focus",value:function(){return this.commaEditor.Focus()}},{key:"FocusAtTheEnd",value:function(){return this.commaEditor.FocusAtTheEnd()}},{key:"GetContent",value:function(){return this.commaEditor.GetContent()}},{key:"SetContent",value:function(e){this.commaEditor.SetContent(e)}},{key:"SetUserSettings",value:function(e){this.commaEditor.SetUserSettings(e)}},{key:"ToggleStyleOnSelection",value:function(e,t){return this.commaEditor.ToggleStyleOnSelection(e,t)}},{key:"ToggleStyleOnLine",value:function(e,t){return this.commaEditor.ToggleStyleOnLine(e,t)}},{key:"StoreCursorPosition",value:function(){return this.commaEditor.StoreCursorPosition()}},{key:"RestoreCursorPosition",value:function(){return this.commaEditor.RestoreCursorPosition()}},{key:"InsertPluginAtSection",value:function(e,t){return this.commaEditor.InsertPluginAtSection(e,t)}},{key:"CallPluginStaticMethod",value:function(e,t,n){return this.commaEditor.CallPluginStaticMethod(e,t,n)}},{key:"IsolateSelectedText",value:function(){return this.commaEditor.IsolateSelectedText()}},{key:"CreateTextNode",value:function(e,t,n,i){return o.TextNode.CreateNew(this.commaEditor.document,e,t,n,i)}},{key:"CreateInlineNode",value:function(e,t,n,i){return InlineNode.CreateNew(this.commaEditor.document,e,t,n,i)}},{key:"CreateBlockNode",value:function(e,t,n,i,o){var r=3<arguments.length&&void 0!==i&&i,s=4<arguments.length&&void 0!==o?o:"";return BlockNode.CreateNew(this.commaEditor.document,e,t,n,r,s)}}])&&G(e.prototype,t),n&&G(e,n),i}()}],h={},i.m=g,i.c=h,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)i.d(n,o,function(e){return t[e]}.bind(null,o));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",i(i.s=18).default;function i(e){if(h[e])return h[e].exports;var t=h[e]={i:e,l:!1,exports:{}};return g[e].call(t.exports,t,t.exports,i),t.l=!0,t.exports}var g,h});